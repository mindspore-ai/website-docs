<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>添加案例</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      	.layui-form-item .layui-input-inline {
      	  	width: calc(100% - 200px);
			position: relative;
      	}
	  	.tipInfo{
			color:#999;
			font-size: 12px;
			margin-left:10px;
	  	}
		.tip-info-keytechnology {
			color:#999;
			margin-left: 120px;
			position: relative;
			top:-10px;
		}
		.tip-info {
			color:#999;
			margin-left:12px;
			position: relative;
			top: -40px;
		}
		.word {
			position: absolute;
			right: 10px;
			bottom: 10px;
			color: #aaa;
			font-size: 12px;
		}
    </style>
</head>

<body>
    <div class="weadmin-body">
      	<form class="layui-form" lay-filter="casesForm">
      	  	<div class="layui-form-item">
          		<label for="categoryId" class="layui-form-label">
          		  	<span class="we-red">*</span>案例种类
          		</label>
          		<div class="layui-input-inline">
					<input type="text"  lay-verify="required" name="categoryId" value="" id="categoryId" style="display: none;" />
          		</div>
      	  	</div>
      	  	<div class="layui-form-item">
          		<label for="title" class="layui-form-label">
          		  	<span class="we-red">*</span>案例标题
          		</label>
          		<div class="layui-input-inline">
          			<input
          				type="text"
          				id="title"
          				name="title"
          				lay-verify="required"
          				autocomplete="off"
						class="layui-input"
						placeholder="请输入案例标题"
						maxlength="16"
						oninput="wordLeg1(this);"
						onpropertychange="if(value.length > 16) value=vatextarea"
          			/>
					<div class="word">
						<span class="text_count_1">0</span>&nbsp;/&nbsp;
						<span class="num_count_1" id="numCount_1">16</span>
					</div>
          		</div>
      	  	</div>
      	  	<div class="layui-form-item">
          		<label for="introduction" class="layui-form-label">
          		  	<span class="we-red">*</span>案例简介
          		</label>
          		<div class="layui-input-inline">
          			<textarea
          				name="introduction"
          				lay-verify="required"
						class="layui-textarea"
						placeholder="请输入案例简介"
						maxlength="150"
						oninput="wordLeg2(this);"
						onpropertychange="if(value.length > 150) value=vatextarea"
          			></textarea>
					<div class="word">
						<span class="text_count_2">0</span>&nbsp;/&nbsp;
						<span class="num_count_2" id="numCount_2">150</span>
					</div>
          		</div>
      	  	</div>
      	  	<div class="layui-form-item">
          		<label for="casesLink" class="layui-form-label">
					案例链接
          		</label>
          		<div class="layui-input-inline">
          		  	<input
          		  		type="text"
          		  		id="casesLink"
          		  		name="casesLink"
          		  		lay-verify=""
          		  		autocomplete="off"
						class="layui-input"
						placeholder="请输入案例链接"
          			/>
          		</div>
      	  	</div>
      	  	<div class="layui-form-item">
          		<label for="technology" class="layui-form-label">
          		  	<span class="we-red">*</span>关键技术
          		</label>
          		<div class="layui-input-inline">
          		  	<input
          		  		type="text"
          		  		id="technology"
          		  		name="technology"
          		  		lay-verify="required"
          		  		autocomplete="off"
						class="layui-input"
						placeholder="请输入关键技术"
						maxlength="15"
						oninput="wordLeg3(this);"
						onpropertychange="if(value.length > 15) value=vatextarea"
          			/>
					<div class="word">
						<span class="text_count_3">0</span>&nbsp;/&nbsp;
						<span class="num_count_3" id="numCount_3">15</span>
					</div>
          		</div>
      	  	</div>
			<div class="tip-info-keytechnology">关键技术之间用英文逗号"," 分割</div>
			<div class="layui-form-item">
				<label for="sequenceNo" class="layui-form-label">
				  	案例顺序
				</label>
				<div class="layui-input-inline">
				  	<input
				  		type="text"
				  		id="sequenceNo"
				  		name="sequenceNo"
				  		lay-verify="sequenceNo"
				  		autocomplete="off"
				  		class="layui-input"
				  		placeholder="请输入案例顺序"
					/>
				</div>
			</div>
			<div class="layui-form-item" id="logoImg">
				<label for="coverImageValue" class="layui-form-label">
				  	<span class="we-red">*</span>案例logo
				</label>
				<div class="layui-input-inline">
				  	<input
						type="hidden"
						id="coverImageValue"
						lay-verify="required"
						name="logoImg"
						value=""
				  	/>
				  	<div
						class="layui-upload-drag"
						id="logoImg"
						style="height: 50px;"
				  	>
						<i class="layui-icon layui-upload-icon"></i>
						<p class="layui-upload-text">
						  	上传logo
						</p>
						<div class="layui-hide" id="uploadCoverImageView">
						  	<img
								src=""
								alt="上传成功后渲染"
								style="height: 50px; max-width: 320px;"
						  	/>
						</div>
				  	</div>
					<span class="tip-info">支持png/jpg格式，图片高度50px，宽度不超过320px</span>
				</div>
			</div>
      	  	<br />
      	  	<div class="layui-form-item">
      	  	  	<label class="layui-form-label"></label>
      	  	  	<button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
      	  	  	<button class="layui-btn" id="casesAddCancel">取消</button>
      	  	</div>
      	</form>
      	<input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      	String.prototype.hashCode = function () {
      	  	var hash = 0;
      	  	var  i;
      	  	var  chr;
      	  	if (this.length === 0) return hash;
      	  	for (i = 0; i < this.length; i++) {
      	  	  	chr = this.charCodeAt(i);
      	  	  	hash = (hash << 5) - hash + chr;
      	  	  	hash |= 0; // Convert to 32bit integer
      	  	}
      	  	return hash;
      	};
      	window.onload = function () {
      	  	layui.config({
      	    	base: '../../static/',
      	  	}).extend({
				cascader: 'cascader/cascader'
			});
    		layui.use(['form', 'jquery', 'upload', 'layer', 'cascader', 'element'], function () {
        		var form = layui.form;
        		var $ = layui.jquery;
				var	 upload = layui.upload;
				var	 layer = layui.layer;
				var	 cascader = layui.cascader;
				var	 element = layui.element;

        		//自定义验证规则
				form.verify({
					sequenceNo:[
						/(^$)|^[1-9](\d*)$/,
						'课程顺序必须为正整数'
					]
				});

				// 文本框限制字数
				window.wordLeg1 = function(obj) {
					let currleg = $(obj).val().length;
					let length = $(obj).attr('maxlength');
					if(currleg <= length) {
						$('.text_count_1').text(currleg);
					}
				}
				window.wordLeg2 = function(obj) {
					let currleg = $(obj).val().length;
					let length = $(obj).attr('maxlength');
					if(currleg <= length) {
						$('.text_count_2').text(currleg);
					}
				}
				window.wordLeg3 = function(obj) {
					let currleg = $(obj).val().length;
					let length = $(obj).attr('maxlength');
					if(currleg <= length) {
						$('.text_count_3').text(currleg);
					}
				}

				// 案例分类
				let categoryIdInit = [];
        		layui.$.ajax({
            		type: 'get',
            		url: '/source/casescategory/dropdown',
            		success: function (res) {
            		    let categoryIdTree = [];
            		    try {
            		       	if(res.obj) {
                     			res.obj.forEach((first_item, first_index) => {
									categoryIdTree.push({
                     			 	  	id: first_item.id,
                     			 	  	cases_name: first_item.name,
                     			 	  	fid: '0',
                     			 	  	children: []
                     			 	})
                 				  	if(first_item.child) {
                 				  	  	first_item.child.forEach((secend_item, secend_index) => {
											categoryIdTree[first_index].children.push({
                 				  	      	id: secend_item.id,
                 				  	      	cases_name: secend_item.name,
                 				  	      	fid: first_item.id,
                 				  	      	children: []
                 				  	    })
                 				  	    if(secend_item.child) {
                 				  	      	secend_item.child.forEach((three_item, three_index) => {
												categoryIdTree[first_index].children[secend_index].children.push({
                 				  	      	    id: three_item.id,
                 				  	      	    cases_name: three_item.name,
                 				  	      	    fid: secend_item.id,
                 				  	      	  })
                 				  	      	})
                 				  	    }
                 				  	  })
                 				  	}
                 				});
							}
							categoryIdInit = categoryIdTree;
							// 案例分类回填
							let initData = document.getElementById('pData').value;
            				if (initData) {
			  					let initDataJson = JSON.parse(initData);
								let categoryIdEdit = '';
								categoryIdInit.forEach((item, index) => {
									if(initDataJson.categoryId == item.id ){
										categoryIdEdit = item.id + '';
									}
									if(item.children) {
										item.children.forEach((secend_item, secend_index) => {
											if(initDataJson.categoryId == secend_item.id) {
												categoryIdEdit = item.id + ',' + secend_item.id;
											} 
											if(secend_item.children) {
												secend_item.children.forEach((three_item, three_index) => {
													if(initDataJson.categoryId == three_item.id) {
														categoryIdEdit = item.id + ',' + secend_item.id + ',' + three_item.id;
													}
												})
											}
										})
									}
								})
								form.val('casesForm', {
									categoryId: categoryIdEdit
			  					});
							}
							categoryIdTree = JSON.stringify(categoryIdInit)
							// 课程分类
							var categoryIdInstance = cascader.render({
								elem: $('input[name=categoryId]')[0],
								options: JSON.parse(categoryIdTree),
            				    multiple: false, // 支持多选
            				    showAllLevels: true,
            				    props: {
            				      	label: 'cases_name',
            				      	value: 'id',
            				      	children: 'children'
            				    },
		    				    placeholder:'请选择'
							}); 
            		    } catch (error) {
							console.log(error)
						}
            		},
            		error: function (err) {
            		    console.log(err);
            		}
				});
	
            	//编辑时有初始化
            	let initData = document.getElementById('pData').value;
            	if (initData) {
				  	let initDataJson = JSON.parse(initData);
					let logoImg = initDataJson.logoImg.startsWith('http://') ||
							  initDataJson.logoImg.startsWith('https://') ||
							  initDataJson.logoImg.startsWith('/')
               				? initDataJson.logoImg
               				: initDataJson.logoImg.startsWith("1")
               				? 'http://' + initDataJson.logoImg
							: 'https://' + initDataJson.logoImg;
					layui
                		.$('#uploadCoverImageView')
                		.removeClass('layui-hide')
                		.find('img')
						.attr('src', logoImg);
						$('.layui-upload-text, .layui-upload-icon').css({
              	 			display: 'none',
              	 		});
					form.val('casesForm', {
						categoryId: initDataJson.categoryId,
						title: initDataJson.title,
						introduction: initDataJson.introduction,
						casesLink: initDataJson.casesLink,
						technology: initDataJson.technology,
						sequenceNo: initDataJson.sequenceNo ? initDataJson.sequenceNo : 999,
						logoImg: initDataJson.logoImg
				  	})
				  	form.render();
            	}

            	//监听提交
            	form.on('submit(add)', function (data) {
				  	let formdata = new FormData();
				  	let videoUrlStr = '';
            	  	for (const key in data.field) {
						if(key === 'categoryId') {
							let newCasesCategory = data.field[key]
							let newArr = newCasesCategory.split(',');
							formdata.append(key, newArr[newArr.length - 1]);
							formdata.append('typeId', newArr[0]);
						} else if(key === 'sequenceNo'){
							if(data.field[key] == '' || data.field[key] == 999 || data.field[key] == null) {
								formdata.append(key, 999);
							} else {
								formdata.append(key, data.field[key]);
							}
						} else if(key === 'uploadFile') {
								
					  	} else {
							formdata.append(key, data.field[key]);
					  	}
					}

              		if (initData && JSON.parse(initData).id) {
              		  	//是否有id
              		  	formdata.append('id', JSON.parse(initData).id);
              		}

              		layui.$.ajax({
              		 	type: 'post',
              		 	url: initData && JSON.parse(initData).id
              		     	? '/source/cases/update'
              		     	: '/source/cases/add',
              		 	processData: false,
              		 	contentType: false,
              		 	data: formdata,
              		 	success: function (res) {
              		 	  	if (res.status === 200) {
              		 	  	  	layer.alert(
              		 	  	    "保存成功",
              		 	  	    {
              		 	  	      	icon: 6,
              		 	  	    },
              		 	  	    function () {
									window.parent.postMessage(
										{ messageType: 'reloadTable' },
										location.origin
									);
									var index = parent.layer.getFrameIndex(window.name);
									parent.layer.close(index);
              		 	  	    }
              		 	  	  );
              		 	  	}
             		 	 },
             		  	error: function (err) {
             		    	console.log(err);
             		  	},
             		});
             		return false;
            	});

				//文件上传
            	//拖拽上传
            	upload.render({
            	  	elem: '#logoImg',
            	 	url: '/source/cases/image/uploadFile', //改成您自己的上传接口
            	  	field: 'uploadFile',
            	  	done: function (res) {
            	  	 	layer.msg('上传成功');
            	  	 	let url =
            	  	 	  res.url.startsWith('/') ||
            	  	 	  res.url.startsWith('https://') ||
            	  	 	  res.url.startsWith('http://')
            	  	 	    ? res.url
            	  	 	    : res.url.startsWith('1')
            	  	 	    ? 'http://' + res.url
            	  	 	    : 'https://' + res.url;
            	  	 	layui
            	  	 	  .$('#uploadCoverImageView')
            	  	 	  .removeClass('layui-hide')
            	  	 	  .find('img')
            	  	 	  .attr('src', url);
            	  	 	$('.layui-upload-text, .layui-upload-icon').css({
            	  	 	  	display: 'none',
            	  	 	});
            	  	 	$('#coverImageValue')[0].value = res.url;
            	  	}
            	});


            	layui.$('#casesAddCancel').on('click', function () {
            	  	var index = parent.layer.getFrameIndex(window.name);
            	  	parent.layer.close(index);
				});
          	} 
        );
      };
    </script>
</body>
</html>
