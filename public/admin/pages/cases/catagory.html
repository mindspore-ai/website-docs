<!DOCTYPE html>
<html>
  	<head>
  	  	<meta charset="UTF-8" />
  	  	<title>案例种类编辑</title>
  	  	<link rel="stylesheet" href="../../layui/css/layui.css" />
  	  	<link rel="stylesheet" href="../../static/weadmin.css" />
  	  	<style>
  	  	  	.actionBox{
  	  	  	  	display: inline-block;
  	  	  	  	margin-left:50px;
  	  	  	  	position: relative;
  	  	  	  	vertical-align: middle;
  	  	  	}
  	  	  	.actionClass{
  	  	  	  	color: #379BE6;
  	  	  	  	cursor: pointer;
  	  	  	  	display: inline-block;
  	  	  	  	margin: 0 5px;
  	  	  	}
  	  	</style>
  	</head>

  	<body>
  	  	<div class="weadmin-body cases-catagory">
  	  	  	<div class="layui-btn-container">
  	  	  	  	<button class="layui-btn layui-btn-sm" id="catalogAdd" type="button" lay-event="add">新增一级</button>
  	  	  	</div>
  	  	  	<div id="catalogTree" class="demo-tree-more"></div>
  	  	</div>
  	  	<script src="../../layui/layui.js"></script>
  	  	<script>
  	  		window.onload = function () {
  	  	    	layui.config({
  	  	    	  	base: "../../static/",
  	  	    	});
  	  	    	layui.use(["jquery", "weadmin",'tree', 'util'], function () {
  	  	    	  	var $ = layui.jquery;
					var weadmin = layui.weadmin;
					var util = layui.util;
					var tree = layui.tree;
				
  	        	  	let treeList = [];

            		// 请求树列表数据
            		function getDataList(){
              			layui.$.ajax({
              			    type: "get",
              			    url: "/source/casescategory/dropdown",
              			    success: function (res) {
              			    	let dropdownList = [];
              			    	try {
              			    	 	if(res.obj) {
                     					res.obj.forEach((first_item, first_index) => {
                     					 	dropdownList.push({
                     					 	  	id: first_item.id,
                     					 	  	title: first_item.name,
                     					 	  	level: 1,
												sequenceNo: first_item.sequenceNo,
                     					 	  	field: 'name' + first_index,
                     					 	  	children:[]
                     					 	})
                     					 	if(first_item.child) {
                     					 	  	first_item.child.forEach((secend_item, secend_index) => {
                     					 	    	dropdownList[first_index].children.push({
                     					 	    	  	id: secend_item.id,
                     					 	    	  	title: secend_item.name,
                     					 	    	  	level: 2,
														sequenceNo: secend_item.sequenceNo,
                     					 	    	  	superId: first_item.id,
                     					 	    	  	field: '',
                     					 	    	  	children:[]
                     					 	    	})
                     					 	    	if(secend_item.child) {
                     					 	    	  	secend_item.child.forEach((three_item, three_index) => {
                     					 	    	  	  	dropdownList[first_index].children[secend_index].children.push({
                     					 	    	  	  	  	id: three_item.id,
                     					 	    	  	  	  	title: three_item.name,
                     					 	    	  	  	  	level: 3,
																sequenceNo: three_item.sequenceNo,
                     					 	    	  	  	  	field: '',
                     					 	    	  	  	  	superId: secend_item.id
                     					 	    	  	  	})
                     					 	    	  	})
                     					 	    	}
                     							})
                     						}
                     					});
                   					}
              			    		treeList = dropdownList;
              			    		treeInstance.reload({
              			    		  	data: dropdownList,
              			    		});
              			    		let str = `
              						    <div class="actionBox">
              						      <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
              						      <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
              						      <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
              						    </div>
              						`
									let str2 = `
              						    <div class="actionBox">
              						      <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
              						      <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
              						    </div>
              						`
              						$('.layui-tree>div>.layui-tree-entry').append(str);
              						$('.layui-tree>div>div>div>.layui-tree-entry').append(str);
              						$('.layui-tree>div>div>div>div>div>.layui-tree-entry').append(str2);
              			    	} catch (error) {}
              			  	},
              			    error: function (err) {
              			      	console.log(err);
              			    },
              			});
            		}
            		getDataList();
					
           			let treeInstance = tree.render({
            		  	elem: '#catalogTree',
            		  	data: [],
            		  	showCheckbox: false , //是否显示复选框
            		  	isJump: false ,//是否允许点击节点时弹出新窗口跳转
            		  	showLine: false,  //是否开启连接线
            		  	id: 'demoId1',
            		  	click: function(obj){
            		  	  	var data = obj.data;  //获取当前点击的节点数据
            		  	}
            		})

					let str = `
              		    <div class="actionBox">
              		      <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
              		      <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
              		      <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
              		    </div>
              		`
					let str2 = `
              		    <div class="actionBox">
              		      <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
              		      <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
              		    </div>
              		`
              		$('.layui-tree>div>.layui-tree-entry').append(str);
              		$('.layui-tree>div>div>div>.layui-tree-entry').append(str);
              		$('.layui-tree>div>div>div>div>div>.layui-tree-entry').append(str2);
					
            		// 新增一级目录
            		$("#catalogAdd").on("click", function() {
            		 	WeAdminEdit("新增一级", "./level.html");
            		})

            		//  新增树节点
            		$('#catalogTree').on('click','.catalog-add',function(event) {
            		  	let myAddId =  $(this).parent().parent().parent().attr('data-id');
            		  	treeList.forEach((item_1,index_1) => {
            		  	  	if(myAddId == item_1.id) {
								item_1.type = 'add';
            		  	  	  	WeAdminEdit("新增二级", "./level.html", JSON.stringify(item_1));
            		  	  	} else {
            		  	  	  	item_1.children.forEach((item_2, index_2) => {
            		  	  	  	  	if(myAddId == item_2.id) {
										item_2.type = 'add';
            		  	  	  	  	  	WeAdminEdit("新增三级", "./level.html", JSON.stringify(item_2));
            		  	  	  	  	}
            		  	  	  	})
            		  	  	}
            		  	})
            		})

            		// 编辑树节点
            		$('#catalogTree').on('click','.catalog-edit',function(event) {
            		  	let myEditId =  $(this).parent().parent().parent().attr('data-id');
            		  	treeList.forEach((item_1,index_1) => {
            		  	  	if(myEditId == item_1.id) {
								item_1.type = 'update';
            		  	  	  	WeAdminEdit("编辑一级", "./level.html", JSON.stringify(item_1));
            		  	  	} else {
            		  	  	  	item_1.children.forEach((item_2, index_2) => {
            		  	  	  	  	if(myEditId == item_2.id) {
										item_2.type = 'update';
            		  	  	  	  	  	WeAdminEdit("编辑二级", "./level.html",JSON.stringify(item_2));
            		  	  	  	  	} else {
            		  	  	  	  	  	item_2.children.forEach((item_3,index_3) => {
            		  	  	  	  	  	  	if(myEditId == item_3.id) {
												item_3.type = 'update';
            		  	  	  	  	  	    	WeAdminEdit("编辑三级", "./level.html",JSON.stringify(item_3));
            		  	  	  	  	  	  	}
            		  	  	  	  	  	})
            		  	  	  	  	}
            		  	  	  	})
            		  	  	}
            		  	})
            		})

             		//  删除树节点
            		$('#catalogTree').on('click','.catalog-delete',function(event) {
            		  	let myDeleteId =  $(this).parent().parent().parent().attr('data-id');
            		  	let index = layer.confirm(
            		      	"您确定要删除" + $(this).parent().prev().text() +"吗？",
            		      	{ btn: ["确定", "取消"] },
            		      	function () {
            		      	    $.ajax({
            		      	      	type: "get",
            		      	      	url: "/source/casescategory/delete/?id=" + myDeleteId,
            		      	      	success: function (response) {
            		      	      	  	if (response.status === 200) {
            		      	      	  	  	let index = layer.alert(
            		      	      	  	  	 	"删除成功",
            		      	      	  	  	 	{ icon: 6 },
            		      	      	  	  	 	function () {
            		      	      	  	  	 	  	layer.close(index);
            		      	      	  	  	 	  	getDataList();
            		      	      	  	  	 	}
            		      	      	  	  	);
            		      	      	  	} else {
            		      	      	  	  	layer.alert(response.msg + ',' + response.obj, { icon: 5 });
            		      	      	  	}
            		      	      	},
            		      	      	error: function (err) {
            		      	      	  	layer.alert("删除失败:" + err, { icon: 5 });
            		      	      	}
            		      	    });
            		      	},
            		      	function () {
            		      	    layer.close(index);
            		      	}
            		    );
            		});

            		window.addEventListener("message", receiveMessage, false);
            		function receiveMessage(event) {
            		  	switch (event.data.messageType) {
            		  	  	case "reloadTable":
            		  	  	  	getDataList();
            		  	  	  	break;
            		  	  	default:
            		  	  	  	break;
            		  	}
            		}

            	});
      		};
    	</script>
  	</body>
</html>
