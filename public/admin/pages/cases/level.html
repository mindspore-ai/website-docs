<!DOCTYPE html>
<html>
  	<head>
  	  	<meta charset="UTF-8" />
  	  	<title>新增案例种类</title>
  	  	<link rel="stylesheet" href="../../layui/css/layui.css" />
  	  	<link rel="stylesheet" href="../../static/weadmin.css" />
  	  	<style>
  	  	  	.layui-form-item .layui-input-inline {
  	  	  	  	width: calc(100% - 200px);
  	  	  	}
  	  	</style>
  	</head>

  	<body>
    	<div class="weadmin-body">
    	  	<form class="layui-form" lay-filter="catalogForm">
    	  	  	<div class="layui-form-item">
         			<label for="catalog" class="layui-form-label">
         			  	<span class="we-red">*</span>名称
         			</label>
         			<div class="layui-input-inline">
         			  	<input
         			  	  	type="text"
         			  	  	id="catalog"
         			  	  	name="catalog"
         			  	  	required=""
         			  	  	lay-verify="required"
         			  	  	autocomplete="off"
         			  	  	class="layui-input"
         			  	/>
         			</div>
    	  	  	</div>
    	  	  	<div class="layui-form-item">
         			<label for="sequenceNo" class="layui-form-label">
         			  	顺序
         			</label>
         			<div class="layui-input-inline">
         			  	<input
         			  		type="text"
         			  		id="sequenceNo"
         			  		name="sequenceNo"
         			  		lay-verify="sequenceNo"
         			  		autocomplete="off"
         			  		class="layui-input"
         			  		placeholder="请输入顺序"
         			  	/>
         			</div>
    	  	  	</div>
    	  	  	<br />
    	  	  	<div class="layui-form-item">
    	  	  	  	<label class="layui-form-label"></label>
    	  	  	  	<button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
    	  	  	  	<button class="layui-btn" id="catalogAddCancel">取消</button>
    	  	  	</div>
    	  	</form>
    	  	<input style="display: none;" type="text" id="pData" value="" />
    	</div>
    	<script src="../../layui/layui.js"></script>
    	<script src="../../static/tools.js"></script>
		<script>
    		String.prototype.hashCode = function () {
    		  	var hash = 0, i, chr;
    		  	if (this.length === 0) return hash;
    		  	for (i = 0; i < this.length; i++) {
    		  	  	chr = this.charCodeAt(i);
    		  	  	hash = (hash << 5) - hash + chr;
    		  	  	hash |= 0; 
    		  	}
    		  	return hash;
			};
		  
    		window.onload = function () {
    		    layui.config({
    		      	base: '../../static/',
    		    });
    		    layui.use(['form', 'weadmin', 'jquery', 'layer'], function () {
    		    	var form = layui.form;
					var weadmin = layui.weadmin;
    		        var $ = layui.jquery;
					var layer = layui.layer;

    		    	//自定义验证规则
    		    	form.verify({
    		        	sequenceNo:[
							/(^$)|^[1-9](\d*)$/,
							'顺序必须为正整数'
    		        	]
    		      	});
				  
    		        // 编辑时回填初始化数据
    		        let initData = document.getElementById("pData").value;
    		        if(initData) {
    		            let initDataJson = JSON.parse(initData); 
						if(initDataJson.type === 'update') {
							form.val('catalogForm', {
								catalog: initDataJson.title,
								sequenceNo: initDataJson.sequenceNo ? initDataJson.sequenceNo : 999
							});
						}
    		        }

            		//监听提交
            		form.on('submit(add)', function (data) {
            		  	let formdata = new FormData();
            		  	for (const key in data.field) {
							if(key === 'sequenceNo') {
            		      		if(data.field[key] == '' || data.field[key] == null) {
							        formdata.append(key, 999);
							    } else {
							        formdata.append(key, data.field[key]);
							    }
							} else {
								formdata.append(key, data.field[key]);
							}
            		    }
						if(initData) {
    		            	let initDataJson = JSON.parse(initData); 
							if(initDataJson.type === 'add') {
								formdata.append('level', initDataJson.level + 1);
								formdata.append('superId', initDataJson.id);
							} else if(initDataJson.type === 'update') {
								formdata.append('id', initDataJson.id);
								formdata.append('level', initDataJson.level);
								if(initDataJson.superId) {
									formdata.append('superId', initDataJson.superId);
								}
							}
						} else {
							formdata.append('level', 1);
						}
					
            		  	layui.$.ajax({
            		   		type: 'post',
            		   		url: '/source/casescategory/add',
            		   		processData: false,
            		   		contentType: false,
            		   		data: formdata,
            		   		success: function (res) {
            		   		  	if (res.status === 200) {
            		   		  	  	layer.alert(
            		   		  	  	  	'保存成功',
            		   		  	  	  	{
            		   		  	  	  	  icon: 6,
            		   		  	  	  	},
            		   		  	  	  	function () {
            		   		  	  	  	  	window.parent.postMessage(
            		   		  	  	  	  	  	{ messageType: 'reloadTable' },
            		   		  	  	  	  	  	location.origin
            		   		  	  	  	  	);
            		   		  	  	  	  	var index = parent.layer.getFrameIndex(window.name);
            		   		  	  	  	  	parent.layer.close(index);
            		   		  	  	  	}
            		   		  	  	);
            		   		  	}
            		   		},
            		    	error: function (err) {
            		    	  	console.log(err);
            		    	}
            		  	});
            		  	return false;
            		});

            		layui.$('#catalogAddCancel').on('click', function () {
            		  	var index = parent.layer.getFrameIndex(window.name);
            		  	parent.layer.close(index);
            		});
          		});
    		};
    	</script>
	</body>
</html>
