<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>新增一级目录</title>
  <link rel="stylesheet" href="../../layui/css/layui.css" />
  <link rel="stylesheet" href="../../static/weadmin.css" />
  <style>
    .layui-upload-drag {
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .layui-form-item .layui-input-inline {
      width: calc(100% - 200px);
    }
  </style>
</head>

<body>
  <div class="weadmin-body">
    <form class="layui-form" lay-filter="catalogForm">
      <div class="layui-form-item">
        <label for="catalog" class="layui-form-label">
          <span class="we-red">*</span>目录名称
        </label>
        <div class="layui-input-inline">
          <input type="text" id="catalog" name="catalog" required="" lay-verify="required" autocomplete="off"
            class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label for="description" class="layui-form-label">
          <span class="we-red">*</span>目录概述
        </label>
        <div class="layui-input-inline">
          <input type="text" id="description" name="description" required="" lay-verify="required" autocomplete="off"
            class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label for="sequenceNo" class="layui-form-label">
          顺序
        </label>
        <div class="layui-input-inline">
          <input type="text" id="sequenceNo" name="sequenceNo" lay-verify="sequenceNo" autocomplete="off"
            class="layui-input" placeholder="请输入顺序" />
        </div>
      </div>
      <div class="layui-form-item" id="coverImg">
        <label for="coverImageValue" class="layui-form-label">
          <span class="we-red">*</span>课程封面
        </label>
        <div class="layui-input-inline">
          <input type="hidden" id="coverImageValue" lay-verify="required" name="coverImg" value="" />
          <div class="layui-upload-drag" id="coverImg" style="width: 120px; height: 120px;">
            <i class="layui-icon layui-upload-icon"></i>
            <p class="layui-upload-text"> 请使用长宽尺寸为120px*120px的图片</p>
            <div class="layui-hide" id="uploadCoverImageView">
              <img src="" alt="上传成功后渲染" style="width: 120px; height: 120px;" />
            </div>
          </div>
        </div>
      </div>
      <br />
      <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
        <button class="layui-btn" id="catalogAddCancel">取消</button>
      </div>
    </form>
    <input style="display: none;" type="text" id="pData" value="" />
  </div>
  <script src="../../layui/layui.js"></script>
  <script src="../../static/tools.js"></script>
  <script>
    String.prototype.hashCode = function () {
      var hash = 0, i, chr;
      if (this.length === 0) return hash;
      for (i = 0; i < this.length; i++) {
        chr = this.charCodeAt(i);
        hash = (hash << 5) - hash + chr;
        hash |= 0;
      }
      return hash;
    };

    window.onload = function () {
      layui.config({
        base: "../../static/",
      });
      layui.use(["form", "weadmin", "jquery", "upload", "layer"], function () {
        var form = layui.form,
          weadmin = layui.weadmin,
          $ = layui.jquery,
          upload = layui.upload,
          layer = layui.layer;
        // 获得传参数
        let initData = document.getElementById("pData").value;
        let initDataJson = JSON.parse(initData);
        //自定义验证规则
        form.verify({
          sequenceNo: [
            /(^$)|^[1-9](\d*)$/,
            '顺序必须为正整数'
          ]
        });
        // 编辑时回填初始化数据
        if (initDataJson.type && initDataJson.type == 'edit') {
          // 根据ID查询描述
          layui.$.ajax({
            type: "get",
            url:"/source/coursecategory/info?id=" + initDataJson.id,
            processData: false,
            contentType: false,
            success: function (res) {
              if (res.status === 200) {
                if (res.obj.coverImg) {
                  let coverImage =
                    res.obj.coverImg.startsWith("http://") ||
                      res.obj.coverImg.startsWith("https://") ||
                      res.obj.coverImg.startsWith("/")
                      ? res.obj.coverImg
                      : res.obj.coverImg.startsWith("1")
                        ? "http://" + res.obj.coverImg
                        : "https://" + res.obj.coverImg;

                  layui.$("#uploadCoverImageView")
                    .removeClass("layui-hide")
                    .find("img")
                    .attr("src", coverImage);
                }
                $(".layui-upload-text, .layui-upload-icon").css({
                  display: "none",
                });

                form.val("catalogForm", {
                  catalog: res.obj.catalog,
                  description: res.obj.description,
                  coverImg: res.obj.coverImg,
                  sequenceNo: res.obj.sequenceNo ? res.obj.sequenceNo : 999
                });
              }
            },
            error: function (err) {
              console.log(err);
            }
          })
        }

        //监听提交
        form.on("submit(add)", function (data) {
          
          let formdata = new FormData();
          for (const key in data.field) {
            if (key === 'uploadFile') {

            } else if (key === 'sequenceNo') {
              if (data.field[key] == '' || data.field[key] == null) {
                formdata.append(key, 999);
              } else {
                formdata.append(key, data.field[key]);
              }
            } else {
              formdata.append(key, data.field[key]);
            }
          }
          if (initDataJson.type && initDataJson.type == 'edit') {
            formdata.append('level', initDataJson.level);
            formdata.append('id', initDataJson.id);
          } else {
            formdata.append('level', 1);
          }
          formdata.append('lang', initDataJson.lang);
          layui.$.ajax({
            type: "post",
            url: "/source/coursecategory/add",
            processData: false,
            contentType: false,
            data: formdata,
            success: function (res) {
              if (res.status === 200) {
                layer.alert(
                  "保存成功",
                  {
                    icon: 6,
                  },
                  function () {
                    window.parent.postMessage(
                      { messageType: "reloadTable" },
                      location.origin
                    );
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                  }
                );
              }
            },
            error: function (err) {
              console.log(err);
            },
          });
          return false;
        });

        //文件上传
        //拖拽上传
        upload.render({
          elem: "#coverImg",
          url: "/source/coursecategory/cover/uploadFile", //改成您自己的上传接口
          field: "uploadFile",
          done: function (res) {
            layer.msg("上传成功");
            let url =
              res.url.startsWith("/") ||
                res.url.startsWith("https://") ||
                res.url.startsWith("http://")
                ? res.url
                : res.url.startsWith("1")
                  ? "http://" + res.url
                  : "https://" + res.url;
            layui
              .$("#uploadCoverImageView")
              .removeClass("layui-hide")
              .find("img")
              .attr("src", url);
            $(".layui-upload-text, .layui-upload-icon").css({
              display: "none",
            });
            $("#coverImageValue")[0].value = res.url;
          }
        });

        layui.$("#catalogAddCancel").on("click", function () {
          var index = parent.layer.getFrameIndex(window.name);
          parent.layer.close(index);
        });

      }
      );
    };
  </script>
</body>

</html>