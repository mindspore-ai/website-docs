<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>新增一级目录</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
	  }
	  .w-e-toolbar .w-e-menu{
        z-index:801 !important;
      }
      .w-e-text-container {
        z-index:800 !important;
	  }
	  .layui-form-label {
		  width: 90px;
	  }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="catalogForm">
        <div class="layui-form-item">
          <label for="catalog" class="layui-form-label">
            <span class="we-red">*</span>系列目录名称
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="catalog"
              name="catalog"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
		</div>
		<div class="layui-form-item">
			<label for="teamId" class="layui-form-label">
				系列课程团队
			</label>
			<div class="layui-input-inline">
				  <div id="teamId" name="teamId" value=""></div>
			</div>
		</div>
        <div class="layui-form-item">
          <label for="courseDescription" class="layui-form-label">
            <span class="we-red">*</span>系列课程简介
          </label>
          <div class="layui-input-inline">
            <div id="editor" lay-verify="editor"></div>
          </div>
        </div>
		<div class="layui-form-item">
			<label for="sequenceNo" class="layui-form-label">
			  顺序
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="sequenceNo"
			  name="sequenceNo"
			  lay-verify="sequenceNo"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入顺序"
			  />
			</div>
		 </div>
        <div class="layui-form-item" id="coverImg">
          <label for="coverImageValue" class="layui-form-label">
            <span class="we-red">*</span>系列封面
          </label>
          <div class="layui-input-inline">
            <input
              type="hidden"
              id="coverImageValue"
              lay-verify="required"
              name="coverImg"
              value=""
            />
            <div
              class="layui-upload-drag"
              id="coverImg"
              style="width: 360px; height: 180px;"
            >
              <i class="layui-icon layui-upload-icon"></i>
              <p class="layui-upload-text">
                请使用长宽尺寸为360px*180px的图片
              </p>
              <div class="layui-hide" id="uploadCoverImageView">
                <img
                  src=""
                  alt="上传成功后渲染"
                  style="width: 360px; height: 180px;"
                />
              </div>
            </div>
          </div>
        </div>
        <br />
        <div class="layui-form-item">
		  <label class="layui-form-label"></label>
		  <button class="layui-btn" id="coursePreview">预览</button>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="catalogAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
	<script src="../../layui/layui.js"></script>
	<script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; 
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        }).extend({
			xmSelect:'xm-select'
		});
        layui.use(
          ["form", "weadmin", "jquery", "layer", "upload", "xmSelect"],
          function () {
            var form = layui.form,
              weadmin = layui.weadmin,
              $ = layui.jquery,
			  layer = layui.layer,
			  upload = layui.upload,
			  xmSelect = layui.xmSelect;

			let initData = document.getElementById("pData").value;
            let initDataJson = JSON.parse(initData); 

            //自定义验证规则
			form.verify({
				sequenceNo:[
				    /(^$)|^[1-9](\d*)$/,
				    '顺序必须为正整数'
            	]
			});
			
			// 课程团队
			let teacherData = [];
			var courseTeamInstance ;
    		layui.$.ajax({
    			type: 'get',
    		 	url: "/source/courseinstructor/search",
    			success: function (res) {
					let teacherArr = [];
					if(res.obj) {
						res.obj.forEach((item, index) => {
							teacherArr.push({
								name: item.name,
								value: item.id
							})
						})
					}
					teacherData = teacherArr;
					
            		if(initDataJson.type&&initDataJson.type=='edit') {
						layui.$.ajax({
                		  	type: "get",
                		    url: "/source/coursecategory/info?id=" + initDataJson.id,
                		  	processData: false,
                		  	contentType: false,
                		  	success: function (res) {
                		  	  	if (res.status === 200) {
									// 系列课程团队重新渲染
									if(res.obj.teamId && res.obj.teamId != "") {
										let teamStr = res.obj.teamId.split(',');
										let initValueArr = [];
										teamStr.forEach((item, index) => {
											initValueArr.push(Number(item));
										})
										courseTeamInstance = xmSelect.render({
											el: '#teamId', 
											initValue: initValueArr,
											filterable: true,
											data: teacherData
										})
									} else {
										courseTeamInstance = xmSelect.render({
											el: '#teamId',
											filterable: true,
											data: teacherData
										})
									}
								}
							}
						})
					} else {
						courseTeamInstance = xmSelect.render({
							el: '#teamId', 
							filterable: true,
							data: teacherData
						})
					}
    			},
    			error: function (err) {
    			  	console.log(err)
    		  	}
			})
	

            // 编辑时回填初始化数据
            if(initDataJson.type&&initDataJson.type=='edit') {
				// 根据ID查询描述
				layui.$.ajax({
                  	type: "get",
                 	url: "/source/coursecategory/info?id=" + initDataJson.id,
                  	processData: false,
                  	contentType: false,
                  	success: function (res) {
                  	  	if (res.status === 200) {
							let coverImage =
								res.obj.coverImg.startsWith("http://") ||
								res.obj.coverImg.startsWith("https://") ||
								res.obj.coverImg.startsWith("/")
               					? res.obj.coverImg
               					: res.obj.coverImg.startsWith("1")
               					? "http://" + res.obj.coverImg
								: "https://" + res.obj.coverImg;
								layui
                			.$("#uploadCoverImageView")
                			.removeClass("layui-hide")
                			.find("img")
							.attr("src", coverImage);
							$(".layui-upload-text, .layui-upload-icon").css({
              	 	  			display: "none",
              	 			});
							// 富文本框回填
							if(initDataJson.lang==='zh'){
								var initCourseTxt = '&lt;h3&gt;课程关键词&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;课程目标&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;课程描述&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'
							}else{
								var initCourseTxt = '&lt;h3&gt;Course keywords&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;Course objectives&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;Course description&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'
							}
							if(res.obj.courseDescription == null || (res.obj.courseDescription.indexOf('课程关键词') == -1&&!res.obj.courseDescription.includes('Course keywords'))) {
								res.obj.courseDescription = initCourseTxt;
							}
							editor && editor.txt.html(htmlDecode(res.obj.courseDescription));
              				form.val("catalogForm", {
								catalog: res.obj.catalog,
								teamId: res.obj.teamId,
						  		select: res.obj.teamId,
								coverImg: res.obj.coverImg,
								courseDescription:res.obj.courseDescription,
								sequenceNo: res.obj.sequenceNo ? res.obj.sequenceNo : 999
							});
						}
               		},
                  	error: function (err) {
                  	  	console.log(err);
                  	},
              })
			}

            //监听提交
            form.on("submit(add)", function (data) {
              	let formdata = new FormData();
              	for (const key in data.field) {
					if(key === 'select'){
						formdata.append('teamId', data.field[key]);
					} else if (key === 'uploadFile') {

					} else if(key === 'sequenceNo') {
                  		if(data.field[key] == '' || data.field[key] == null) {
							formdata.append(key, 999);
						} else {
							formdata.append(key, data.field[key]);
						}
					} else {
						formdata.append(key, data.field[key]);
					}
			  	}
			  	if(initDataJson.type&&initDataJson.type=='edit') {
              	  formdata.append('id', initDataJson.id);
              	  formdata.append('level', initDataJson.level);
              	  formdata.append('superId', initDataJson.superId);
				} else {
              	  formdata.append('level', 3);
              	  formdata.append('superId',  initDataJson.id);
				}
				formdata.append('lang',  initDataJson.lang);
				formdata.set(
                	"courseDescription",
                	htmlEncode(
                	  editor.txt.html().replace(/<a/g, '<a target="_blank"')
                	)
			  	);
			  
              	layui.$.ajax({
                	type: "post",
               		url: "/source/coursecategory/add",
                	processData: false,
                	contentType: false,
                	data: formdata,
                	success: function (res) {
                	  	if (res.status === 200) {
                	  	  	layer.alert(
                	  	  	  	"保存成功",
                	  	  	  	{ icon: 6 },
                	  	  	  	function () {
                	  	  	  	  	window.parent.postMessage(
                	  	  	  	  	  { messageType: "reloadTable" },
                	  	  	  	  	  location.origin
                	  	  	  	  	);
                	  	  	  	  	var index = parent.layer.getFrameIndex(window.name);
                	  	  	  	  	parent.layer.close(index);
                	  	  	  	}
                	  	  	);
                	  	}
                	},
                	error: function (err) {
                	  	console.log(err);
                	},
              	});
              	return false;
			});
			
			layui.$("#coursePreview").on("click", function () {
              let formValues = form.val("courseForm");
              sessionStorage.setItem(
                "previewData",
                JSON.stringify({
                  ...formValues,
                  newsDetail: htmlDecode(editor.txt.html()),
                })
              );
              let ref = window.open("./preview.html");
			});

			//文件上传
            //拖拽上传
            upload.render({
              	elem: "#coverImg",
             	url: "/source/coursecategory/cover/uploadFile", //改成您自己的上传接口
              	field: "uploadFile",
              	done: function (res) {
              	 	layer.msg("上传成功");
              	 	let url =
              	 	  res.url.startsWith("/") ||
              	 	  res.url.startsWith("https://") ||
              	 	  res.url.startsWith("http://")
              	 	    ? res.url
              	 	    : res.url.startsWith("1")
              	 	    ? "http://" + res.url
              	 	    : "https://" + res.url;
              	 	layui
              	 	  .$("#uploadCoverImageView")
              	 	  .removeClass("layui-hide")
              	 	  .find("img")
              	 	  .attr("src", url);
              	 	$(".layui-upload-text, .layui-upload-icon").css({
              	 	  	display: "none",
              	 	});
              	 	$("#coverImageValue")[0].value = res.url;
              	}
            });

            layui.$("#catalogAddCancel").on("click", function () {
              	var index = parent.layer.getFrameIndex(window.name);
              	parent.layer.close(index);
			});
			
			var E = window.wangEditor;
            var editor = new E("#editor");
			// 配置服务器端地址(上传图片部分)
           	editor.config.uploadImgServer = "/source/course/image/uploadFile";
            editor.config.uploadFileName = "uploadFile";
            editor.config.uploadImgHooks = {
              success: function (xhr, editor, result) {
               // console.log(result, 11);
              },
              fail: function (xhr, editor, result) {
               // console.log(result, 22);
              },
              customInsert: function (insertImg, result, editor) {
                let url =
                  result.url.startsWith("/") ||
                  result.url.startsWith("https://") ||
                  result.url.startsWith("http://")
                    ? result.url
                    : result.url.startsWith("1")
                    ? "http://" + result.url
                    : "https://" + result.url;
                insertImg(url);
              },
            };
            editor.config.uploadImgMaxSize = 10 * 1024 * 1024;
            editor.create();
			if (initDataJson.lang === 'zh') {
				  var initCourseTxt = '&lt;h3&gt;课程关键词&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;课程目标&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;课程描述&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'
			  } else {
				  var initCourseTxt = '&lt;h3&gt;Course keywords&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;Course objectives&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h3&gt;Course description&lt;/h3&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'
			  }
			editor.txt.html('');
			editor && editor.txt.html(htmlDecode(initCourseTxt));
          }
        );
      };
    </script>
  </body>
</html>
