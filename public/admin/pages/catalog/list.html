<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>课程类目管理</title>
  <link rel="stylesheet" href="../../layui/css/layui.css" />
  <link rel="stylesheet" href="../../static/weadmin.css" />
  <style>
    .actionBox {
      display: inline-block;
      margin-left: 50px;
      position: relative;
      vertical-align: middle;
    }

    .actionClass {
      color: #379BE6;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
    }
  </style>
</head>

<body>
  <div class="weadmin-body">
    

    <div class="layui-tab layui-tab-brief" lay-filter="langTab">
      <ul class="layui-tab-title">
          <li class="layui-this">中文课程类目管理</li>
          <li>英文课程类目管理</li>
      </ul>
      <div class="layui-tab-content">
          <div class="layui-tab-item layui-show">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-sm" id="catalogAdd" type="button" lay-event="add">新增一级目录</button>
            </div>
            <div id="catalogTree" class="demo-tree-more"></div>
            <div id="hotRemandTree" class="demo-tree-more"></div>
          </div>
          <div class="layui-tab-item">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-sm" id="catalogAddEn" type="button" lay-event="add">新增一级目录</button>
            </div>
            <div id="catalogTreeEn" class="demo-tree-more"></div>
            <div id="hotRemandTreeEn" class="demo-tree-more"></div>
          </div>
      </div>
    </div>


  </div>
  <script src="../../layui/layui.js"></script>
  <script>
    window.onload = function () {
      layui.config({
        base: "../../static/",
      });
      layui.use(["jquery", "weadmin", 'tree', 'util','element'], function () {
        var $ = layui.jquery,
          weadmin = layui.weadmin,
          util = layui.util;
        tree = layui.tree;
        var element = layui.element;
        let treeList = [];
        let props={};

        // 切换tab
					let lang = 'zh';
					element.on('tab(langTab)', function(data) {
						if(data.index === 0) {
              lang = 'zh';
							getDataList(lang);
              getHotDataList(lang)
						} else if(data.index === 1) {
              lang = 'en';
							getDataList(lang);
              getHotDataList(lang)
						}
					})

        // 请求树列表数据
        function getDataList(lang) {
          layui.$.ajax({
            type: "get",
            url: lang=="zh"?"/source/coursecategory/dropdown?lang=zh":"/source/coursecategory/dropdown?lang=en",
            success: function (res) {
              let dropdownList = [];
              try {
                if (res.obj) {
                  res.obj.forEach((first_item, first_index) => {
                    dropdownList.push({
                      id: first_item.id,
                      title: first_item.name,
                      level: 1,
                      field: 'name' + first_index,
                      children: []
                    })
                    if (first_item.child) {
                      first_item.child.forEach((secend_item, secend_index) => {
                        dropdownList[first_index].children.push({
                          id: secend_item.id,
                          title: secend_item.name,
                          level: 2,
                          superId: first_item.id,
                          field: '',
                          children: []
                        })
                        if (secend_item.child) {
                          secend_item.child.forEach((three_item, three_index) => {
                            dropdownList[first_index].children[secend_index].children.push({
                              id: three_item.id,
                              title: three_item.name,
                              level: 3,
                              field: '',
                              superId: secend_item.id
                            })
                          })
                        }
                      })
                    }
                  });
                }
                treeList = dropdownList;
                if(lang=='zh'){
                  treeInstance.reload({
                    data: dropdownList,
                  });
                }else{
                  treeInstanceEn.reload({
                    data: dropdownList,
                  });
                }                
                let str = `
                      <div class="actionBox">
                        <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
                        <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
                        <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
                      </div>
                    `
                if(lang=='zh'){
                  $('#catalogTree .layui-tree-entry').append(str);
                }else{
                  $('#catalogTreeEn .layui-tree-entry').append(str);
                }
                
              } catch (error) { }
            },
            error: function (err) {
              console.log(err);
            },
          });
        }
        getDataList(lang);

        let treeInstance = tree.render({
          elem: '#catalogTree',
          data: [],
          showCheckbox: false, //是否显示复选框
          isJump: false,//是否允许点击节点时弹出新窗口跳转
          showLine: false,  //是否开启连接线
          id: 'demoId1',
          click: function (obj) {
            var data = obj.data;  //获取当前点击的节点数据
          }
        })

        let treeInstanceEn=tree.render({
          elem: '#catalogTreeEn',
          data: [],
          showCheckbox: false, //是否显示复选框
          isJump: false,//是否允许点击节点时弹出新窗口跳转
          showLine: false,  //是否开启连接线
          id: 'demoId1',
          click: function (obj) {
            var data = obj.data;  //获取当前点击的节点数据
          }
        })

        // 新增一级目录
        $("#catalogAdd,#catalogAddEn").on("click", function () {
          props={
            lang:lang,
            type:"add"
          }
          WeAdminEdit("新增一级目录", "./level1.html",JSON.stringify(props));
        })

        //  新增树节点
        $('#catalogTree,#catalogTreeEn').on('click', '.catalog-add', function (event) {
          let myAddId = $(this).parent().parent().parent().attr('data-id');
          treeList.forEach((item_1, index_1) => {
              props={
                type:"add"
              }
            if (myAddId == item_1.id) {
              Object.assign(props,item_1,{lang:lang})
              WeAdminEdit("新增二级目录", "./level2.html", JSON.stringify(props));
            } else {
              item_1.children.forEach((item_2, index_2) => {
                if (myAddId == item_2.id) {
                  Object.assign(props,item_2,{lang:lang})
                  WeAdminEdit("新增三级目录", "./level3.html", JSON.stringify(props));
                } else {
                  item_2.children.forEach((item_3, index_3) => {
                    if (myAddId == item_3.id) {
                      layer.alert("三级目录不能再新增目录", { icon: 5 });
                    }
                  })
                }
              })
            }
          })
        })

        // 编辑树节点
        $('#catalogTree,#catalogTreeEn').on('click', '.catalog-edit', function (event) {
          let myEditId = $(this).parent().parent().parent().attr('data-id');
          treeList.forEach((item_1, index_1) => {
            props={
                type:"edit"
              }
            if (myEditId == item_1.id) {
              Object.assign(props,item_1,{lang:lang})
              WeAdminEdit("编辑一级目录", "./level1.html", JSON.stringify(props));
            } else {
              item_1.children.forEach((item_2, index_2) => {
                if (myEditId == item_2.id) {
                  Object.assign(props,item_2,{lang:lang})
                  WeAdminEdit("编辑二级目录", "./level2.html", JSON.stringify(props));
                } else {
                  item_2.children.forEach((item_3, index_3) => {
                    if (myEditId == item_3.id) {
                      Object.assign(props,item_3,{lang:lang})
                      WeAdminEdit("编辑三级目录", "./level3.html", JSON.stringify(props));
                    }
                  })
                }
              })
            }
          })
        })

        //  删除树节点
        $('#catalogTree,#catalogTreeEn').on('click', '.catalog-delete', function (event) {
          let myDeleteId = $(this).parent().parent().parent().attr('data-id');
          let index = layer.confirm(
            "您确定要删除" + $(this).parent().prev().text() + "目录吗？",
            {
              btn: ["确定", "取消"],
            },
            function () {
              $.ajax({
                type: "get",
                url: lang=="zh"?"/source/coursecategory/delete/?id=" + myDeleteId:"/source/coursecategory/delete/?id=" + myDeleteId,
                success: function (response) {
                  if (response.status === 200) {
                    let index = layer.alert(
                      "删除成功",
                      { icon: 6 },
                      function () {
                        layer.close(index);
                        getDataList(lang);
                      }
                    );
                  } else {
                    layer.alert(response.msg, { icon: 5 });
                  }
                },
                error: function (err) {
                  layer.alert("删除失败:" + err, { icon: 5 });
                }
              });
            },
            function () {
              layer.close(index);
            }
          );
        })

        window.addEventListener("message", receiveMessage, false);
        function receiveMessage(event) {
          switch (event.data.messageType) {
            case "reloadTable":
              getDataList(lang);
              getHotDataList(lang);
              break;
            default:
              break;
          }
        }
        // 添加热门推荐
        // 定义热门推荐数据存储在hotTreeList中
        let hotTreeList = [
          {
            title: '热门推荐',//一级菜单
            id: 'hot',
            children: [
            ]
          }]
        // 获取热门推荐list数据,数据向hotTreeList.children中存储
        function getHotDataList(lang) {
          layui.$.ajax({
            type: "get",
            url: lang=="zh"?"/course/coursepopular/list?lang=zh":"/course/coursepopular/list?lang=en",
            success: function (res) {
              try {
                hotTreeList[0].children = []
                if (res.obj && Array.isArray(res.obj)) {
                  res.obj.forEach(item => {
                    hotTreeList[0].children.push({
                      id: item.id,
                      title: item.name,
                      image: item.image,
                      link: item.link,
                      sequence: item.sequence,
                      lang: item.lang
                    })
                  })
                }
                if(lang=='zh'){
                  hotTree.reload({
                    data: hotTreeList,
                  });
                }else{
                  hotTreeEn.reload({
                    data: hotTreeList,
                  });
                }
                addButton()
              } catch (error) { }
            },
            error: function (err) {
              console.log(err);
            },
          });
        }
        getHotDataList(lang)

        let hotTree = tree.render({
          elem: '#hotRemandTree',
          data: hotTreeList,
          showCheckbox: false, //是否显示复选框
          isJump: false,//是否允许点击节点时弹出新窗口跳转
          showLine: false,  //是否开启连接线
          id: 'demoId2',
          click: function (obj) {
            var data = obj.data;  //获取当前点击的节点数据
          }
        })
        let hotTreeEn = tree.render({
          elem: '#hotRemandTreeEn',
          data: hotTreeList,
          showCheckbox: false, //是否显示复选框
          isJump: false,//是否允许点击节点时弹出新窗口跳转
          showLine: false,  //是否开启连接线
          id: 'demoId2',
          click: function (obj) {
            var data = obj.data;  //获取当前点击的节点数据
          }
        })

        //添加按钮 
        function addButton() {
          let str1 = `
                          <div class="actionBox">
                            <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
                          </div>
                        `
          $("#hotRemandTree>.layui-tree>.layui-tree-set>.layui-tree-entry,#hotRemandTreeEn>.layui-tree>.layui-tree-set>.layui-tree-entry").append(str1);
          let str = `
                          <div class="actionBox">
                            <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
                            <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
                          </div>
                        `
          $("#hotRemandTree .layui-tree-lineExtend .layui-tree-entry,#hotRemandTreeEn .layui-tree-lineExtend .layui-tree-entry").append(str)
        }
        // 新增热门推荐
        $("#hotRemandTree,#hotRemandTreeEn").on("click", '.catalog-add', function () {
          props={
            lang:lang,
            type:"add"
          }
          WeAdminEdit("新增热门推荐", "./popular.html",JSON.stringify(props));
        })
        // 编辑
        $('#hotRemandTree,#hotRemandTreeEn').on('click', '.catalog-edit', function (event) {
          let myEditId = $(this).parent().parent().parent().attr('data-id');
          if (hotTreeList.length > 0 && hotTreeList[0]?.children) {
            hotTreeList[0].children.forEach(item => {
              if (item.id == myEditId) {
                props={
                  lang:lang,
                  type:"edit"
                }
                Object.assign(props,item)
                WeAdminEdit("编辑热门推荐", "./popular.html", JSON.stringify(props));
              }
            })
          }
        })
        // 删除
        $('#hotRemandTree,#hotRemandTreeEn').on('click', '.catalog-delete', function (event) {
          let myDeleteId = $(this).parent().parent().parent().attr('data-id');
          let index = layer.confirm(
            "您确定要删除" + $(this).parent().prev().text() + "目录吗？",
            {
              btn: ["确定", "取消"],
            },
            function () {
              $.ajax({
                type: "get",
                url: "/source/coursepopular/delete?id=" +myDeleteId,
                success: function (response) {
                  if (response.status === 200) {
                    let index = layer.alert(
                      "删除成功",
                      { icon: 6 },
                      function () {
                        layer.close(index);
                        getHotDataList(lang);
                      }
                    );
                  } else {
                    layer.alert(response.msg, { icon: 5 });
                  }
                },
                error: function (err) {
                  layer.alert("删除失败:" + err, { icon: 5 });
                }
              });
            },
            function () {
              layer.close(index);
            }
          );
        })
      });
    };
  </script>
</body>

</html>