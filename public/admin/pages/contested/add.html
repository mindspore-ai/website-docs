<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>课程管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>

      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
	  .layui-form-label{
		  width: 120px;
	  }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="contestedForm">
        <div class="layui-form-item">
			<label for="contestedTitle" class="layui-form-label">
				<span class="we-red">*</span>竞赛标题
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="contestedTitle"
			  name="contestedTitle"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入竞赛标题"
				/>
			</div>
		</div>
        <div class="layui-form-item">
          <label for="contestedDesc" class="layui-form-label">
            <span class="we-red">*</span>竞赛介绍
          </label>
          <div class="layui-input-inline">
			<textarea name="desc" placeholder="请输入竞赛介绍" class="layui-textarea" id="contestedDesc" lay-verify="required"></textarea>
          </div>
        </div>
        <div class="layui-form-item">
          <label for="form" class="layui-form-label">
			竞赛状态
          </label>
          <div class="layui-input-inline">
            <input type="radio" name="status" value="1" title="进行中"  lay-filter='form' disabled/>
            <input type="radio" name="status" value="2" title="已结束" lay-filter='form' disabled/>
            <input type="radio" name="status" value="3" title="未开始" lay-filter='form' disabled/>
          </div>
		</div>
		<div class="layui-form-item">
			<label for="sequenceNo" class="layui-form-label">
				<span class="we-red">*</span>奖金
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="bonus"
			  name="bonus"
			  lay-verify="bonus"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入奖金"
				/>
			</div>
		</div>
		<div class="layui-form-item">
			<label for="organizer" class="layui-form-label">
				<span class="we-red">*</span>举办方
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="organizer"
			  name="organizer"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入举办方"
				/>
			</div>
		</div>

		<div class="layui-form-item">
			<label for="beginTime" class="layui-form-label">
				<span class="we-red">*</span>开始日期
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="beginTime"
			  name="beginTime"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="yyyy-MM-dd"
			  readonly
				/>
			</div>
		</div>

		<div class="layui-form-item">
			<label for="endTime" class="layui-form-label">
				<span class="we-red">*</span>截止日期
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="endTime"
			  name="endTime"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="yyyy-MM-dd"
				/>
			</div>
		</div>

		<div class="layui-form-item">
			<label for="contestedEndTime" class="layui-form-label">
				<span class="we-red">*</span>初赛截止日期
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="contestedEndTime"
			  name="contestedEndTime"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="yyyy-MM-dd"
				/>
			</div>
		</div>

		<div class="layui-form-item">
			<label for="link" class="layui-form-label">
				<span class="we-red">*</span>大赛链接
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="link"
			  name="link"
			  lay-verify="required"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入大赛链接地址"
				/>
			</div>
		</div>
		
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
		  <button class="layui-btn" id="previews">预览</button>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn layui-btn-primary" id="courseAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script> 
      window.onload = function () {
        layui.config({
          base: "../../static/",
        }).extend({
			cascader: 'cascader/cascader'
		});
    layui.use([
			  	"form", 
				"weadmin", 
				"jquery", 
				"table",
				"laydate",
		  		"upload", 
				"layer", 
				"element"
		], function () {
        var form = layui.form,
        weadmin = layui.weadmin,
        $ = layui.jquery,
			  table = layui.table,
			  laydate = layui.laydate,
			  upload = layui.upload,
			  layer = layui.layer,
			  element = layui.element;
		laydate.render({
			elem: '#beginTime' //指定元素
		});
		laydate.render({
			elem: '#endTime' //指定元素
		});
		laydate.render({
			elem: '#contestedEndTime' //指定元素
		});
				
		// 回填测试数据
		let beginTime=undefined,  //时间戳
			endTime=undefined;
		let nowStamp=new Date(new Date().toLocaleDateString()).getTime()
		// 初始化传值
		let initData = document.getElementById("pData").value;
		let props = JSON.parse(initData);
		let competitionStatusTextObj={
          "IN_PROGRESS":"1",
          "HAS_ENDED":"2",
          "NOT_STARTED":"3",
        }
		// 如果是编辑，则需要回填数据
		if (props.type === 'edit'&&props?.data) {
			form.val("contestedForm", {
				beginTime: props.data.startDay||'',
				bonus: props.data.prize||'',
				contestedEndTime: props.data.preliminaryEndDay||'',
				contestedTitle:props.data.title||'',
				desc: props.data.introduce||'',
				endTime: props.data.endDay||'',
				link: props.data.link||'',
				organizer: props.data.organizer||'',
				// status: competitionStatusTextObj[props.data.competitionStatus]||''
			});
			beginTime=new Date(props.data.startDay).getTime()-28800000
			endTime=new Date(props.data.endDay).getTime()-28800000
			if(beginTime>nowStamp){
				form.val("contestedForm", {
					status: 3
				})
			}
			if(endTime<nowStamp){
				form.val("contestedForm", {
					status: 2
				})
			}
			if(beginTime<nowStamp&&endTime>nowStamp){
				form.val("contestedForm", {
					status: 1
				})
			}
			if(beginTime===nowStamp||endTime===nowStamp){
				form.val("contestedForm", {
					status: 1
				})
			}
		}
        //自定义验证规则
		form.verify({
			// bonus:[
			// 	// /(^$)|^[1-9](\d*)$/,
			// 	// '奖金必须为正整数'
			// ]
		});
		// 监听开始时间变化
		$("#beginTime").on("blur",function(e){
			setTimeout(()=>{
				let time=e.target.value
				console.log("time",time)
				beginTime=new Date(time).getTime()-28800000
				let nowStamp=new Date(new Date().toLocaleDateString()).getTime()
				if(endTime&&beginTime>endTime){
					layer.msg('开始时间大于结束时间');
					form.val("contestedForm", {
						beginTime: ''
					});
					return
				}
				if(endTime&&endTime>nowStamp&&beginTime<nowStamp){  //开始时间小于现在时间，结束时间大于现在时间，正在进行中
					form.val("contestedForm", {
						status: 1
					});
				}
				if(beginTime>nowStamp){  //开始时间大于现在时间，还没开始
					form.val("contestedForm", {
						status: 3
					});
				}
				if(beginTime===nowStamp){
					form.val("contestedForm", {
						status: 1
					});
				}
			},500)
			
		})
		// 监听结束时间变化
		$("#endTime").on("blur",function(e){
			setTimeout(()=>{
				let time=e.target.value
				console.log("time",time)
				endTime=new Date(time).getTime()-28800000
				let nowStamp=new Date(new Date().toLocaleDateString()).getTime()
				if(beginTime&&beginTime>endTime){
					layer.msg('结束时间小于开始时间');
					form.val("contestedForm", {
						endTime: ''
					});
					return
				}
				if(beginTime&&endTime>nowStamp&&beginTime<nowStamp){  //开始时间小于现在时间，结束时间大于现在时间，正在进行中
					form.val("contestedForm", {
						status: 1
					});
				}
				if(beginTime&&endTime<nowStamp){  //结束时间小于现在时间，比赛结束了
					form.val("contestedForm", {
						status: 2
					});
				}
				if(endTime===nowStamp){
					form.val("contestedForm", {
						status: 1
					});
				}
			},500)
			
		})
		
            //监听提交
            form.on("submit(add)", function (data) {
			  let formdata = new FormData();
			  if(props.type === 'edit'&&props?.data){
					formdata.append('id',props.data.id)
				}
			  formdata.append('endDay',data.field.endTime)
			  formdata.append('introduce',data.field.desc)
			  formdata.append('lang','zh')
			  formdata.append('link',data.field.link)
			  formdata.append('organizer',data.field.organizer)
			  formdata.append('preliminaryEndDay',data.field.contestedEndTime)
			  formdata.append('prize',data.field.bonus)
			  formdata.append('startDay',data.field.beginTime)
			  formdata.append('title',data.field.contestedTitle)
			  let url='/source/competition/save'
              layui.$.ajax({
                type: "post",
                url:url,               
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      "保存成功",
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            layui.$("#courseAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
			});

			layui.$("#previews").on("click", function () {
              let formValues = form.val("contestedForm");
              sessionStorage.setItem(
                "previewData",
                JSON.stringify({
                  ...formValues,
                })
              );
              window.open("./preview.html");
			  return false
            });
          
          } 
        );
	};
    </script>
  </body>
</html>
