<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>竞赛管理</title>
  <link rel="stylesheet" href="../../layui/css/layui.css" />
  <link rel="stylesheet" href="../../static/weadmin.css" />
  <style>
    .actionBox {
      display: inline-block;
      margin-left: 50px;
      position: relative;
      vertical-align: middle;
    }

    .actionClass {
      color: #379BE6;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
    }
    .search-box {
      display: flex;
    }

    .buttom-group {
      margin-left: 20px;
    }
    .layui-inline {
      width: 400px;
    }
  </style>
</head>

<body>
  <div class="weadmin-body">


    <div class="layui-tab layui-tab-brief" lay-filter="langTab">
      <ul class="layui-tab-title">
        <li class="layui-this">竞赛管理</li>
        <li>热门竞赛推荐管理</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <div class="search-box">
            <form class="layui-form" lay-filter="paperForm">
              <div class="layui-inline ">
                <input class="layui-input" name="searchId" id="search" autocomplete="off" placeholder="输入竞赛标题进行搜索">
              </div>
            </form>
            <div class="buttom-group">
              <button class="layui-btn name-search">搜索</button>
              <button class="layui-btn name-reset layui-btn-primary">重置</button>
            </div>
          </div>
          <table class="layui-hide" id="courseTable" lay-filter="courseTable"></table>
          <script type="text/html" id="toolbar">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-sm layui-btn-warm" lay-event="mutiDelete">批量删除</button>
                    <button class="layui-btn layui-btn-sm layui-btn-warm" lay-event="mutiOnshelf">批量发布</button>
                    <button class="layui-btn layui-btn-sm" lay-event="add">添加竞赛</button>
                </div>
          </script>
          <script type="text/html" id="barDemo">
                <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="onshelf">发布</a>
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
          </script>
        </div>
        <div class="layui-tab-item">
          <div id="hotRemandTree" class="demo-tree-more"></div>
        </div>
      </div>
    </div>


  </div>
  <script src="../../layui/layui.js"></script>
  <script>
    window.onload = function () {
      layui.config({
        base: "../../static/",
      });
      layui.use(["jquery", "weadmin", 'tree', 'element', "form","table"], function () {
        var $ = layui.jquery,
          weadmin = layui.weadmin,
        tree = layui.tree;
        var element = layui.element;
        let treeList = [];
        let props = {};
        let lang = "zh"
        let tab = 'contested'
        let table = layui.table;
        // 切换tab
        element.on('tab(langTab)', function (data) {
          if (data.index === 0) {
            tab = 'contested';

          } else if (data.index === 1) {
            tab = 'hot';
            getHotDataList(lang)
          }
        })

        let competitionStatusTextObj={
          "IN_PROGRESS":"进行中",
          "HAS_ENDED":"已结束",
          "NOT_STARTED":"未开始"
        }

        let tableInstance = table.render({
          elem: "#courseTable",
          url: "/competition/list",
		  method: 'post',
          request: {
            pageName: "pageCurrent",
            limitName: "limit"
          },
          where: {
            "lang":lang,
            "title":'',
            "publishStatus":''
          },
          parseData: function (res) {
            if (res.data) {
              let transformData = res.data.map((newsRow, index) => {
                newsRow.statusText = newsRow.publishStatus === "PUBLISHED" ? "已发布" : "未发布";
                newsRow.contestedTime=newsRow.startDay+"-"+newsRow.endDay;
                newsRow.competitionStatusText=competitionStatusTextObj[newsRow.competitionStatus]
                return newsRow;
              });
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.total, //解析数据长度
                data: transformData, //解析数据列表
              };
            } else {
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: 0, //解析数据长度
                data: [], //解析数据列表
              };
            }
          },
          toolbar: "#toolbar",
          title: "竞赛管理表",
          cols: [
            [
              { type: "checkbox", fixed: "left" },
              { field: "id", title: "ID", fixed: "left",width: 50 },
              { field: "title", title: "竞赛标题" ,width: 250},
              { field: "introduce", title: "竞赛介绍",width: 250},
              { field: "prize", title: "竞赛奖金" },
              { field: "organizer", title: "举办方" },
              { field: "contestedTime", title: "赛期",width: 200 },
              { field: "preliminaryEndDay", title: "初赛截止日期",width: 120 },
              {
                field: "statusText",
                sort: true,
                title: "发布状态",
                templet: function (d) {
                  if (d.publishStatus === 'PUBLISHED') {
                    return d.statusText;
                  } else {
                    return (
                      '<span style="color: red;">' + d.statusText + "</span>"
                    );
                  }
                },
              },
              {
                field: "competitionStatusText",
                sort: true,
                title: "竞赛状态"
              },
              {
                fixed: "right",
                width: 160,
                title: "操作",
                toolbar: "#barDemo",
              },
            ],
          ],
          page: true,
        });

        //工具栏事件
        table.on("toolbar(courseTable)", function (obj) {
          let checkStatus = table.checkStatus(obj.config.id);
          let data = checkStatus.data;
          switch (obj.event) {
            case "mutiDelete":
              if (data.length > 0) {
                let index = layer.confirm(
                  "您确定要删除已选的竞赛吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    let ids = data.map((rowData, index) => {
                      return rowData.id;
                    });
                    $.ajax({
                      type: "get",
                      url: "/source/competition/delete?ids=" + ids,
                      success: function (response) {
                        if (response.status === 200) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        } else {
                          layer.alert(response.msg + ":" + response.obj, { icon: 5 })
                        }
                      },
                      error: function (err) {
                        layer.alert("删除失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
              } else {
                layer.alert("请选择您要删除的竞赛", { icon: 5 });
              }
              break;
            case "mutiOnshelf":
            if (data.length > 0) {
                let index = layer.confirm(
                  "您确定要发布已选的竞赛吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    let ids = data.map((rowData, index) => {
                      return rowData.id;
                    });
                    $.ajax({
                      type: "get",
                      url: "/source/competition/batchPublish?ids=" + ids,
                      success: function (response) {
                        if (response.status === 200) {
                          let index = layer.alert(
                            "发布成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        } else {
                          layer.alert(response.msg + ":" + response.obj, { icon: 5 })
                        }
                      },
                      error: function (err) {
                        layer.alert("发布失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
              } else {
                layer.alert("请选择您要删除的竞赛", { icon: 5 });
              }
              break;
            case "mutiUnshelf":
              break;
            case "add":
              let props={
                lang:lang,
                type:"add"
              }
              WeAdminEdit("竞赛添加", "./add.html",JSON.stringify(props));
              break;
            default:
              break;
          }
        });

        //监听行单击事件
        table.on("tool(courseTable)", function (obj) {
          switch (obj.event) {
            case "edit":
            let props={
                lang:lang,
                data:obj.data,
                type:"edit"
              }
              WeAdminEdit("竞赛编辑", "./add.html", JSON.stringify(props));
              break;
            case "onshelf":
              if (obj.data.status === '1') {
                layer.alert("该竞赛已经发布过啦！！", { icon: 5 });
                return;
              }
              let index = layer.confirm(
                "您确定要发布该竞赛吗？",
                {
                  btn: ["确定", "取消"], //按钮
                },
                function () {
                  $.ajax({
                    type: "get",
                    url: "/source/competition/publish?id=" + [obj.data.id],
                    success: function (response) {
                      let index = layer.alert(
                        "发布成功",
                        { icon: 6 },
                        function () {
                          layer.close(index);
                          tableInstance.reload();
                        }
                      );
                    },
                    error: function (err) {
                      layer.alert("发布失败:" + err, { icon: 5 });
                    },
                  });
                },
                function () {
                  layer.close(index);
                }
              );
              break;
            case "unshelf":
              break;
            case "del":
              let index1 = layer.confirm(
                "您确定要删除这条竞赛吗？",
                {
                  btn: ["确定", "取消"], //按钮
                },
                function () {
                  $.ajax({
                    type: "get",
                    url: "/source/competition/delete?ids=" + [obj.data.id],
                    success: function (response) {
                      let index = layer.alert(
                        "删除成功",
                        { icon: 6 },
                        function () {
                          layer.close(index);
                          tableInstance.reload();
                        }
                      );
                    },
                    error: function (err) {
                      console.log("删除失败");
                    },
                  });
                },
                function () {
                  layer.close(index1);
                }
              );
              break;
            default:
              break;
          }
        });

        window.addEventListener("message", receiveMessage, false);
        function receiveMessage(event) {
          switch (event.data.messageType) {
            case "reloadTable":
              tableInstance.reload();
              getHotDataList(lang);
              break;
            default:
              break;
          }
        }

          // 搜索
          $('.name-search').on("click", function (e) {
          let title = $('#search')[0].value;
          if ( title == '') {
            return
          } 
          tableInstance.reload({
            where: {
              "lang":lang,
              "title":title,
              "publishStatus":''
            },
            page: {
              curr: 1
            }
          });
        });

        // 重置
        $('.name-reset').on("click", function (e) {
          $('#search')[0].value=''
          tableInstance.reload({
            where: {
              "lang":lang,
              "title":'',
              "publishStatus":''
            },
            page: {
              curr: 1
            }
          });
        });

        // 添加热门推荐
        // 定义热门推荐数据存储在hotTreeList中
        let hotTreeList = [
          {
            title: '热门推荐',//一级菜单
            id: 'hot',
            children: [
            ]
          }]
        // 获取热门推荐list数据,数据向hotTreeList.children中存储
        function getHotDataList(lang) {
          layui.$.ajax({
            type: "get",
            url: lang == "zh" ? "/competitionpopular/list?lang=zh" : "/competitionpopular/list?lang=en",
            success: function (res) {
              try {
                hotTreeList[0].children = []
                if (res.obj && Array.isArray(res.obj)) {
                  res.obj.forEach(item => {
                    hotTreeList[0].children.push({
                      id: item.id,
                      title: item.name,
                      image: item.image,
                      link: item.link,
                      sequence: item.sequence,
                      lang: item.lang
                    })
                  })
                }
                if (lang == 'zh') {
                  hotTree.reload({
                    data: hotTreeList,
                  });
                } else {
                  hotTreeEn.reload({
                    data: hotTreeList,
                  });
                }
                addButton()
              } catch (error) { }
            },
            error: function (err) {
              console.log(err);
            },
          });
        }
        getHotDataList(lang)

        let hotTree = tree.render({
          elem: '#hotRemandTree',
          data: hotTreeList,
          showCheckbox: false, //是否显示复选框
          isJump: false,//是否允许点击节点时弹出新窗口跳转
          showLine: false,  //是否开启连接线
          id: 'demoId2',
          click: function (obj) {
            var data = obj.data;  //获取当前点击的节点数据
          }
        })


        //添加按钮 
        function addButton() {
          let str1 = `
                          <div class="actionBox">
                            <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
                          </div>
                        `
          $("#hotRemandTree>.layui-tree>.layui-tree-set>.layui-tree-entry,#hotRemandTreeEn>.layui-tree>.layui-tree-set>.layui-tree-entry").append(str1);
          let str = `
                          <div class="actionBox">
                            <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
                            <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
                          </div>
                        `
          $("#hotRemandTree .layui-tree-lineExtend .layui-tree-entry,#hotRemandTreeEn .layui-tree-lineExtend .layui-tree-entry").append(str)
        }
        // 新增热门推荐
        $("#hotRemandTree,#hotRemandTreeEn").on("click", '.catalog-add', function () {
          props = {
            lang: lang,
            type: "add"
          }
          WeAdminEdit("新增热门推荐", "./popular.html", JSON.stringify(props));
        })
        // 编辑
        $('#hotRemandTree,#hotRemandTreeEn').on('click', '.catalog-edit', function (event) {
          let myEditId = $(this).parent().parent().parent().attr('data-id');
          if (hotTreeList.length > 0 && hotTreeList[0]?.children) {
            hotTreeList[0].children.forEach(item => {
              if (item.id == myEditId) {
                props = {
                  lang: lang,
                  type: "edit"
                }
                Object.assign(props, item)
                WeAdminEdit("编辑热门推荐", "./popular.html", JSON.stringify(props));
              }
            })
          }
        })
        // 删除
        $('#hotRemandTree,#hotRemandTreeEn').on('click', '.catalog-delete', function (event) {
          let myDeleteId = $(this).parent().parent().parent().attr('data-id');
          let index = layer.confirm(
            "您确定要删除" + $(this).parent().prev().text() + "目录吗？",
            {
              btn: ["确定", "取消"],
            },
            function () {
              $.ajax({
                type: "get",
                url: "/source/competitionpopular/delete?id=" + myDeleteId,
                success: function (response) {
                  if (response.status === 200) {
                    let index = layer.alert(
                      "删除成功",
                      { icon: 6 },
                      function () {
                        layer.close(index);
                        getHotDataList(lang);
                      }
                    );
                  } else {
                    layer.alert(response.msg, { icon: 5 });
                  }
                },
                error: function (err) {
                  layer.alert("删除失败:" + err, { icon: 5 });
                }
              });
            },
            function () {
              layer.close(index);
            }
          );
        })
      });
    };
  </script>
</body>

</html>