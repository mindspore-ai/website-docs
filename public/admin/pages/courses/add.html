<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>课程管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
     
	  .tipInfo{
		  color:#999;
		  font-size: 12px;
		  margin-left:10px;
	  }
	  .formDocument {
		  display: none;
	  }
	  .formLink{
		  display: none;
	  }
	  .videoType2, .videoType3{
		  display: none;
	  }
	  .formVideoContent{
		  border:1px solid #e6e6e6;
	  }
	  .videoTypeTop{
		  padding: 20px;
	  }
	  .videoType1, .videoType2, .videoType3{
		  border-top:1px solid #e6e6e6;
		  padding: 20px;
	  }
	  .formDocumentContent{
		border:1px solid #e6e6e6;
		padding: 20px;
	  }
	  .formLinkContent{
		border:1px solid #e6e6e6;
		padding: 20px;
	  }
	  .status {
		margin-top: 20px;
		display: none;
	  }
	  .status .type_icon {
		  margin-right: 5px;
	  }
	  .status .action_icon{
		margin-left: 10px;
		cursor: pointer;
	  }
	  .status_edit {
		margin-top: 20px;
		display: none;
	  }
	  .status_edit .document_cancel{
		margin-left: 10px;
		cursor: pointer;
	  }
	  .status_edit .video_cancel{
		margin-left: 10px;
		cursor: pointer;
	  }
	  .status .layui-progress{
		margin-top: 10px;
		width: 150px;
	  }
	  .playMinClass{
		  display: inline-block;
		  padding-top:10px;
	  }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="courseForm">
        <div class="layui-form-item">
          <label for="categoryId" class="layui-form-label">
            <span class="we-red">*</span>课程分类
          </label>
          <div class="layui-input-inline">
			    <input type="text"  lay-verify="required" name="categoryId" value="" id="categoryId" style="display: none;" />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="title" class="layui-form-label">
            <span class="we-red">*</span>课程标题
          </label>
          <div class="layui-input-inline">
            <input
            type="text"
            id="title"
            name="title"
            lay-verify="required"
            autocomplete="off"
			class="layui-input"
			placeholder="请输入课程标题"
          />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="label" class="layui-form-label">
            课程标签
          </label>
          <div class="layui-input-inline">
            <select name="label"  lay-search lay-filter='label'>
              <option value="无">无</option>
              <option value="NEW">NEW</option>
              <option value="HOT">HOT</option>
            </select> 
          </div>
        </div>
        <div class="layui-form-item">
          <label for="form" class="layui-form-label">
            <span class="we-red">*</span>课程形式
          </label>
          <div class="layui-input-inline">
            <input type="radio" name="form" value="1" title="视频" checked="" lay-filter='form'/>
            <input type="radio" name="form" value="2" title="文档" lay-filter='form'/>
            <input type="radio" name="form" value="3" title="链接" lay-filter='form'/>
          </div>
		</div>
		<div class="layui-form-item">
			<label for="sequenceNo" class="layui-form-label">
			  课程顺序
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="sequenceNo"
			  name="sequenceNo"
			  lay-verify="sequenceNo"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入课程顺序"
				/>
			</div>
		</div>
		<div class="layui-form-item formVideo">
			<label for="playMin" class="layui-form-label">
			  <span class="we-red">*</span>视频时长
			</label>
			<div class="layui-input-inline">
			  <input
			  type="text"
			  id="playMin"
			  name="playMin"
			  lay-verify="required|playMin"
			  autocomplete="off"
			  class="layui-input"
			  placeholder="请输入视频时长"
				/>
				<span class="tipInfo playMinClass">时长单位：分钟，例如：10min，输入10</span>
			</div>
		</div>
        <div class="layui-form-item formVideo">
          <label for="videoType" class="layui-form-label">
            <span class="we-red">*</span>课程视频
          </label>
          <div class="layui-input-inline formVideoContent">
			  <div class="videoTypeTop">
				<input type="radio" name="videoType" value="1" title="上传视频文件" checked="" lay-filter='videoType' />
				<input type="radio" name="videoType" value="2" title="上传OBS桶链接" lay-filter='videoType'/>
				<input type="radio" name="videoType" value="3" title="上传B站视频链接" lay-filter='videoType'/>
			  </div>
			<div class="videoType1">
				<input
					type="hidden"
					id="videoUrl"
					lay-verify="required"
					name="videoUrl"
					value="" />
				<button type="button" class="layui-btn" id="coursevideo">
					<i class="layui-icon">&#xe67c;</i>上传视频
				</button>
				<span class="tipInfo">支持MP4格式</span>
				<div class="status"></div>
				<div class="status_edit"></div>
			</div>
			<div class="videoType2">
				<input
            		type="text"
            		id="OBSvideoUrl"
					name="OBSvideoUrl"
					lay-verify=""
					autocomplete="off"
					class="layui-input" 
					placeholder="请输入OBS桶链接"/>
			</div>
			<div class="videoType3">
				<input
            		type="text"
            		id="BvideoUrl"
					name="BvideoUrl"
					lay-verify=""
            		autocomplete="off"
					class="layui-input"
					placeholder="请输入B站视频链接" />
			</div>
          </div>
        </div>
        <div class="layui-form-item formVideo formVideoDocument" >
          <label for="type" class="layui-form-label">
            课程课件
          </label>
          <div class="layui-input-inline">
			<input
				type="hidden"
				lay-verify=""
				id="document1"
				name="document1"
				value="" />
            <button type="button" class="layui-btn" id="courseware">
				<i class="layui-icon">&#xe67c;</i>上传课件
			</button>
			<span class="tipInfo">支持PDF格式</span>
			<div class="status"></div>
			<div class="status_edit"></div>
          </div>
        </div>
        <div class="layui-form-item formDocument" lay-filter="coursedocument">
          <label for="document" class="layui-form-label">
            <span class="we-red">*</span>课程文档
          </label>
          <div class="layui-input-inline formDocumentContent" >
			<input
				type="hidden"
				lay-verify=""
				id="document2"
				name="document2"
				value="" />
            <button type="button" class="layui-btn" id="coursedocument">
				<i class="layui-icon">&#xe67c;</i>上传文档
			</button>
			<div class="status"></div>
			<div class="status_edit"></div>
          </div>
        </div>
        <div class="layui-form-item formLink">
          <label for="courselink" class="layui-form-label">
            <span class="we-red">*</span>课程链接
          </label>
          <div class="layui-input-inline formLinkContent">
            <input
				type="text"
				lay-verify=""
            	id="courselink"
            	name="courselink"
            	autocomplete="off"
				class="layui-input"
				placeholder="请输入课程链接"
          	/>
          </div>
        </div>
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="courseAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        }).extend({
			cascader: 'cascader/cascader'
		});
    layui.use([
			  	"form", 
				"weadmin", 
				"jquery", 
				"table",
				"laydate",
		  		"upload", 
				"layer", 
		  		"cascader", 
				"element"
		], function () {
        var form = layui.form,
        weadmin = layui.weadmin,
        $ = layui.jquery,
			  table = layui.table,
			  laydate = layui.laydate,
			  upload = layui.upload,
			  layer = layui.layer,
			  cascader = layui.cascader,
			  element = layui.element;
		
		// 初始化传值
		let initData = document.getElementById("pData").value;
		let props = JSON.parse(initData);
        //自定义验证规则
		form.verify({
			sequenceNo:[
				/(^$)|^[1-9](\d*)$/,
				'课程顺序必须为正整数'
			],
			playMin:[
				/^[1-9](\d*)$/,
				'视频时长必须为正整数'
			]
		});

		// 课程分类
		let categoryIdInit = [];
        layui.$.ajax({
            type: "get",
            url: "/source/coursecategory/dropdown?lang="+props.lang,
            success: function (res) {
                let categoryIdTree = [];
                try {
                   	if(res.obj) {
                     res.obj.forEach((first_item, first_index) => {
						categoryIdTree.push({
                        id: first_item.id,
                        course_name: first_item.name,
                        fid: '0',
                        children:[]
                      })
                      if(first_item.child) {
                        first_item.child.forEach((secend_item, secend_index) => {
							categoryIdTree[first_index].children.push({
                            id: secend_item.id,
                            course_name: secend_item.name,
                            fid: first_item.id,
                            children:[]
                          })
                          if(secend_item.child) {
                            secend_item.child.forEach((three_item, three_index) => {
								categoryIdTree[first_index].children[secend_index].children.push({
                                id: three_item.id,
                                course_name: three_item.name,
                                fid: secend_item.id,
                              })
                            })
                          }
                        })
                      }
                     });
					}
					categoryIdInit = categoryIdTree;

					// 课程分类回填
					// let initData = document.getElementById("pData").value;
            		if (props.type=="edit") {
			  			let initDataJson = props.data;
						let categoryIdEdit = '';
						categoryIdInit.forEach((item, index) => {
							if(initDataJson.categoryId == item.id ){
								categoryIdEdit = item.id + '';
							}
							if(item.children) {
								item.children.forEach((secend_item, secend_index) => {
								if(initDataJson.categoryId == secend_item.id) {
										categoryIdEdit = item.id + ',' + secend_item.id;
								} 
								if(secend_item.children) {
									secend_item.children.forEach((three_item, three_index) => {
										if(initDataJson.categoryId == three_item.id) {
											categoryIdEdit = item.id + ',' + secend_item.id + ',' + three_item.id;
										}
									})
								}
							})
							}
						})
						form.val("courseForm", {
							categoryId: categoryIdEdit
			  			});
					}
			 
					categoryIdTree = JSON.stringify(categoryIdInit)
					// 课程分类
					var categoryIdInstance = cascader.render({
						elem: $('input[name=categoryId]')[0],
						options: JSON.parse(categoryIdTree),
            		    multiple: false, // 支持多选
            		    showAllLevels: true,
            		    props: {
            		      label: 'course_name',
            		      value: 'id',
            		      children: 'children'
            		    },
		    		    placeholder:'请选择'
					}); 
                  	} catch (error) {
						  console.log(error)
					}
                },
            error: function (err) {
                  console.log(err);
            },
		});
		
		// 课程形式监听
		form.on('radio(form)', function(data) {
			if(data.value == 1) {
				$('.formVideo').css('display','block');
				$('.formDocument').css('display','none');
				$('.formLink').css('display','none');
				// 验证
				$('#playMin').attr('lay-verify','required|playMin');
				$('#document2').attr('lay-verify','');
				$('#courselink').attr('lay-verify','');
			} else if(data.value == 2) {
				form.verify({})
				$('.formVideo').css('display','none');
				$('.formDocument').css('display','block');
				$('.formLink').css('display','none');
				// 验证
				$('#playMin').attr('lay-verify','');
				$('#document2').attr('lay-verify','required');
				$('#courselink').attr('lay-verify','');
				$('#videoUrl').attr('lay-verify','');
				$('#OBSvideoUrl').attr('lay-verify','');
				$('#BvideoUrl').attr('lay-verify','');
			} else if(data.value == 3) {
				$('.formVideo').css('display','none');
				$('.formDocument').css('display','none');
				$('.formLink').css('display','block');
				// 验证
				$('#playMin').attr('lay-verify','');
				$('#document2').attr('lay-verify','');
				$('#courselink').attr('lay-verify','required');
				$('#videoUrl').attr('lay-verify','');
				$('#OBSvideoUrl').attr('lay-verify','');
				$('#BvideoUrl').attr('lay-verify','');
			}
			form.render();
		})

		// 监听课程视频的方式
		form.on('radio(videoType)', function(data) {
			if(data.value == 1) {
				$('.videoType1').css('display', 'block');
				$('.videoType2').css('display', 'none');
				$('.videoType3').css('display', 'none');
				// 验证
				$('#videoUrl').attr('lay-verify','required');
				$('#OBSvideoUrl').attr('lay-verify','');
				$('#BvideoUrl').attr('lay-verify','');
			} else if( data.value == 2) {
				$('.videoType1').css('display', 'none');
				$('.videoType2').css('display', 'block');
				$('.videoType3').css('display', 'none');
				// 验证
				$('#videoUrl').attr('lay-verify','');
				$('#OBSvideoUrl').attr('lay-verify','required');
				$('#BvideoUrl').attr('lay-verify','');
			} else if(data.value == 3) {
				$('.videoType1').css('display', 'none');
				$('.videoType2').css('display', 'none');
				$('.videoType3').css('display', 'block');
				// 验证
				$('#videoUrl').attr('lay-verify','');
				$('#OBSvideoUrl').attr('lay-verify','');
				$('#BvideoUrl').attr('lay-verify','required');
			}
			form.render();
		})
			
		// 上传视频
		var coursevideoInstance = upload.render({
  				elem: '#coursevideo', 
  				url: '/source/course/video/uploadFile' ,
				accept:'video',
				acceptMime: 'video/*', // 桌面可以选择的文件类型
				ext: 'mp4',// 允许的文件后缀
				field: "uploadFile",
				choose: function(obj){
					obj.preview(function(index,file,result) {
						let status_html = `
							<div>
								<img src="../../images/icon_video.png" class="type_icon"> 
								<span>${file.name}</span>
								<div class="layui-progress" lay-showpercent="true" lay-filter="progress">
									<div class="layui-progress-bar layui-bg-green" lay-percent="10%" ></div>
								</div>
							</div>
						`
						$('.videoType1 .status').html(status_html);
						$('.videoType1 .status').css('display','block');
					})
					element.progress('progress', '30%');
				},
				progress: function(n, elem) {
					var percent = n + '%' //获取进度百分比
    				element.progress('progress', percent);
				},
  				done: function(res){ //上传完毕回调
					layer.msg("上传成功");
					let status_html = `
						<div>
							<img src="../../images/icon_video.png" class="type_icon"> 
							<span>${res.trueName}</span>
							<img src="../../images/icon_selected.png" class="action_icon">
						</div>
					`
					$('.videoType1 .status').html(status_html);
					// hover时候显示删除按钮
					$('videoType1 .action_icon').hover(function() {
						$('videoType1 .action_icon').attr({
							src:"../../images/icon_unselected.png"
						})
					},function() {
						$('videoType1 .action_icon').attr({
							src:"../../images/icon_selected.png"
						})
					})
				
					$("#videoUrl")[0].value = res.url
					
					// 删除上传
					$('.action_icon').click( function() {
						$('.videoType1 .status').html('');
						$('.videoType1 .status').css('display','none');
						$("#videoUrl")[0].value = '';
					})
					
				},
				error: function(err){
  				  console.log(err);
  				}
			});

		// 视频模式--上传课件
		var coursewareInstance = upload.render({
  				elem: '#courseware', 
  				url: '/source/course/document/uploadFile',
				accept:'file',
				acceptMime:'.pdf',
				exts: 'pdf',
				field: "uploadFile",
				choose: function(obj){
					obj.preview(function(index,file,result) {
						let status_html = `
							<div>
								<img src="../../images/icon_text.png" class="type_icon"> 
								<span>${file.name}</span>
								<div class="layui-progress" lay-showpercent="true" lay-filter="progress">
									<div class="layui-progress-bar layui-bg-green" lay-percent="10%" ></div>
								</div>
							</div>
						`
						$('.formVideoDocument .status').html(status_html);
						$('.formVideoDocument .status').css('display','block');
					})
					element.progress('progress', '30%');
				},
				progress: function(n, elem) {
					var percent = n + '%' 
    				element.progress('progress', percent); 
				},
  				done: function(res) { //上传完毕回调
					layer.msg("上传成功");
					let documentArr = [{
							"name": res.trueName,
							"url": res.url,
							"size": res.size
						}]
					$("#document1")[0].value = JSON.stringify(documentArr);

					let status_html = `
						<div>
							<img src="../../images/icon_text.png" class="type_icon"> 
							<span>${res.trueName}</span>
							<img src="../../images/icon_selected.png" class="action_icon">
						</div>
					`
					$('.formVideoDocument .status').html(status_html);
					// hover时候显示删除按钮
					$('.formVideoDocument .action_icon').hover(function() {
						$('.formVideoDocument .action_icon').attr({
							src:"../../images/icon_unselected.png"
						})
					},function() {
						$('.formVideoDocument .action_icon').attr({
							src:"../../images/icon_selected.png"
						})
					})
					
					// 删除上传
					$('.formVideoDocument .action_icon').click( function() {
						$('.formVideoDocument .status').html('');
						$('.formVideoDocument .status').css('display','none');
						$("#document1")[0].value = '';
					})
				},
				error: function(err){
  				  console.log(err);
  				}
			});

		// 文档模式--上传课件
		var coursedocumentInstance = upload.render({
  				elem: '#coursedocument', 
  				url: '/source/course/document/uploadFile',
				accept:'file',
				acceptMime:'.pdf',
				exts: 'pdf',
				field: "uploadFile",
				choose: function(obj){
					obj.preview(function(index,file,result) {
						let status_html = `
							<div>
								<img src="../../images/icon_text.png" class="type_icon"> 
								<span>${file.name}</span>
								<div class="layui-progress" lay-showpercent="true" lay-filter="progress">
									<div class="layui-progress-bar layui-bg-green" lay-percent="10%" ></div>
								</div>
							</div>
						`
						$('.formDocument .status').html(status_html);
						$('.formDocument .status').css('display','block');
					})
					element.progress('progress', '30%');
				},
				progress: function(n, elem) {
					var percent = n + '%' //获取进度百分比
    				element.progress('progress', percent);
				},
  				done: function(res){ //上传完毕回调
					layer.msg("上传成功");
					let status_html = `
						<div>
							<img src="../../images/icon_text.png" class="type_icon"> 
							<span>${res.trueName}</span>
							<img src="../../images/icon_selected.png" class="action_icon">
						</div>
					`
					$('.formDocument .status').html(status_html);
					// hover时候显示删除按钮
					$('.formDocument .action_icon').hover(function() {
						$('.formDocument .action_icon').attr({
							src:"../../images/icon_unselected.png"
						})
					},function() {
						$('.formDocument .action_icon').attr({
							src:"../../images/icon_selected.png"
						})
					})
					
					let documentArr = [{
						"name": res.trueName,
						"url": res.url,
						"size": res.size
					}]
					$("#document2")[0].value = JSON.stringify(documentArr);
					
					// 删除上传
					$('.formDocument .action_icon').click( function() {
						$('.formDocument .status').html('');
						$('.formDocument .status').css('display','none');
						$("#document1")[0].value = '';
					})
				},
				error: function(err){
  				  console.log(err);
  				}
			});

            //编辑时有初始化
            // let initData = document.getElementById("pData").value;
            if (props.type=="edit") {
			  let initDataJson = props.data;
			if(initDataJson.form == 1) {
				if(initDataJson.videoType == 2) {
					$('.videoType1').css('display', 'none');
					$('.videoType2').css('display', 'block');
					form.val("courseForm", {
						OBSvideoUrl: initDataJson.videoUrl
					})
					$('#OBSvideoUrl').attr('lay-verify','required');
					$('#videoUrl').attr('lay-verify','');
				} else if(initDataJson.videoType == 3) {
					$('.videoType1').css('display', 'none');
					$('.videoType3').css('display', 'block');
					form.val("courseForm", {
						BvideoUrl: initDataJson.videoUrl
					})
					$('#BvideoUrl').attr('lay-verify','required');
					$('#videoUrl').attr('lay-verify','');
				} else {
					form.val("courseForm", {
						videoUrl: initDataJson.videoUrl
					})
					$('#videoUrl').attr('lay-verify','required');
				}
				$('#playMin').attr('lay-verify','required|playMin');
			} else if(initDataJson.form == 2) {
				$('.formVideo').css('display','none');
				$('.formDocument').css('display','block');
				$('#document2').attr('lay-verify','required');
				$('#playMin').attr('lay-verify','');
				$('#videoUrl').attr('lay-verify','');
			} else if(initDataJson.form == 3) {
				$('.formVideo').css('display','none');
				$('.formLink').css('display','block');
				form.val("courseForm", {
					courselink: initDataJson.videoUrl
				})
				$('#courselink').attr('lay-verify','required');
				$('#playMin').attr('lay-verify','');
				$('#videoUrl').attr('lay-verify','');
			}
			form.render();

			  form.val("courseForm", {
				title:initDataJson.title,
				label: initDataJson.label,
				description: initDataJson.description,
                form: initDataJson.form,
                sequenceNo: initDataJson.sequenceNo ? initDataJson.sequenceNo : 999,
				videoType: initDataJson.videoType
			  })

              $(".layui-upload-text, .layui-upload-icon").css({
                display: "none",
              });
              layui.$.ajax({
                type: "get",
            	url: "/source/course/info?id=" + initDataJson.id,
                success: function (res) {
                  try {
					  if(initDataJson.form == 1) {
						form.val("courseForm", {
						  document1: res.obj.document,
						  document2: null
					  	}) 
						if(res.obj.document) {
							let documentName = JSON.parse(res.obj.document)[0].name;
							let document_html = `
								<div>
									<span>${documentName}</span>
									<img src="../../images/icon_unselected.png" class="document_cancel"/>
								</div>
							`
							$('.formVideoDocument .status_edit').html(document_html);
							$('.formVideoDocument .status_edit').css('display','block');
						}
						// videoType =1  回填视频 
						if(res.obj.videoType === 1) {
							let videoUrl =
								res.obj.videoUrl.startsWith("http://") ||
								res.obj.videoUrl.startsWith("https://") ||
								res.obj.videoUrl.startsWith("/")
               					? res.obj.videoUrl
               					: res.obj.videoUrl.startsWith("1")
               					? "http://" + res.obj.videoUrl
								: "https://" + res.obj.videoUrl;
							let video_html = `
								<div>
									<span>${videoUrl}</span>
									<img src="../../images/icon_unselected.png" class="video_cancel"/>
								</div>
							`
							$('.videoType1 .status_edit').html(video_html);
							$('.videoType1 .status_edit').css('display','block');
						}

					  } else if(initDataJson.form == 2) {
						form.val("courseForm", {
						  document1: null,
						  document2:res.obj.document
					  	}) 
						let documentName = JSON.parse(res.obj.document)[0].name;
						let document_html = `
							<div>
								<span>${documentName}</span>
								<img src="../../images/icon_unselected.png" class="document_cancel"/>
							</div>
						`
						$('.formDocument .status_edit').html(document_html);
						console.log(documentName, $('.formDocument .status_edit').html(document_html))
						$('.formDocument .status_edit').css('display','block');
					  }
					  form.val("courseForm", {
						  playMin: res.obj.playMin
					  })
                  } catch (error) {}
                },
                error: function (err) {
                  console.log(err);
                },
			  });
			  form.render();
            }

			// 文档取消重新提交
			$(document).on('click', '.document_cancel', function(e){
				$('.formVideoDocument .status_edit').html('');
				$('.formDocument .status_edit').html('');
				form.val("courseForm", {
					document1: null,
					document2: null
				}) 
				$('.formVideoDocument .status_edit').css('display','none');
				$('.formDocument .status_edit').css('display','none');
				form.render();
			})
			// 视频取消重新提交
			$(document).on('click', '.video_cancel', function(e){
				$('.videoType1 .status_edit').html('');
				form.val("courseForm", {
					videoUrl: null
				}) 
				$('.videoType1 .status_edit').css('display','none');
				form.render();
			})

            //监听提交
            form.on("submit(add)", function (data) {
			  let formdata = new FormData();
			  let videoUrlStr = '';
              for (const key in data.field) {
				  if(key === 'categoryId') {
					let newCourseCategory = data.field[key]
					let newArr = newCourseCategory.split(',');
					formdata.append(key, newArr[newArr.length - 1]);
				  } else if(key === 'videoUrl' || 
				  		key === 'OBSvideoUrl' || 
				  		key === 'BvideoUrl' || 
				  		key === "courselink" || 
				  		key === "document1" || 
				  		key === "document2" || 
				  		key === "videoType" || 
				  		key === 'uploadFile'){ 
						// 这些key值不上传
				  } else if(key === 'label'){
					if(data.field[key] == '无') {
						formdata.append(key, null);
					} else {
						formdata.append(key, data.field[key]);
					}
				  } else if(key === 'sequenceNo'){
					if(data.field[key] == '' || data.field[key] == 999 || data.field[key] == null) {
						formdata.append(key, 999);
					} else {
						formdata.append(key, data.field[key]);
					}
				  } else {
					formdata.append(key, data.field[key]);
				  }
			  }

			if(data.field['form'] == 1) {
				formdata.append('document', data.field['document1'] );
				formdata.append('videoType', Number(data.field.videoType) );
				if(data.field['videoType'] == 1){
					formdata.append('videoUrl', data.field['videoUrl'] );
				} else if (data.field['videoType'] == 2){
					formdata.append('videoUrl', data.field['OBSvideoUrl'] );
				} else if (data.field['videoType'] == 3){
					 // B站的视频网址打开的是网页模式，需要复制B站分享的嵌入代码,并前拼接https,后拼接&high_quality=1
					 if(data.field['BvideoUrl'].indexOf('iframe') !== -1){
                  		let srcStr = data.field['BvideoUrl'];
                  		let newLink =  srcStr.match(/\/\/[^"'\s]*/);
                  		data.field['BvideoUrl'] = 'https:' + newLink[0] + '&high_quality=1'
        			}
					formdata.append('videoUrl', data.field['BvideoUrl'] );
				}
			} else if(data.field['form']  == 2) {
				formdata.append('videoUrl', null );
				formdata.append('videoType',0 );
				formdata.append('document', data.field['document2'] );
			} else if(data.field['form']  == 3) {
				formdata.append('videoType',0 );
				formdata.append('videoUrl', data.field['courselink'] );
			}
              
			  formdata.set(
                "form",
                Number(data.field.form)
              );
			  formdata.set(
                "playMin",
                Number(data.field.playMin)
              );
			  let url=""
			  if(props.type=="edit"){
				formdata.append("id", props.data.id);
				url="/source/course/update"
			  }else{
				url="/source/course/add"
				
			  }
			  formdata.append("lang",props.lang)

              layui.$.ajax({
                type: "post",
                url:url,               
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      "保存成功",
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            layui.$("#courseAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
			});

          
          } 
        );
      };
    </script>
  </body>
</html>
