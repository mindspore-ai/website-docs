<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>课程管理</title>
  <link rel="stylesheet" href="../../layui/css/layui.css" />
  <link rel="stylesheet" href="../../static/weadmin.css" />
  <style>
    .labelClass {
      color: #fff;
      display: inline-block;
      padding: 0 5px;
      line-height: 22px;
      height: 22px;
      border-radius: 5px;
      font-size: 12px;
    }

    .newClass {
      background: #009688;
    }

    .hotClass {
      background: #FFB800;
    }

    .layui-inline {
      width: 400px;
    }

    .categoryId {
      width: 400px;
    }

    .search-box {
      display: flex;
    }

    .buttom-group {
      margin-left: 20px;
    }
  </style>
</head>

<body>
  <div class="weadmin-body">
    <div class="search-box">
      <form class="layui-form" lay-filter="paperForm">
        <div class="layui-input-inline">
          <input type="radio" name="lang" value="zh" title="中文" checked="" lay-filter='lang' />
          <input type="radio" name="lang" value="en" title="英语" lay-filter='lang' />
        </div>

        <div class="layui-inline categoryId">
          <input type="text" value="" name="categoryId" id="categoryId" style="display: none;" />
        </div>

        <div class="layui-inline ">
          <input class="layui-input" name="searchId" id="search" autocomplete="off" placeholder="输入课程名称进行搜索">
        </div>
      </form>
      <div class="buttom-group">
        <button class="layui-btn name-search">搜索</button>
        <button class="layui-btn name-reset">重置</button>
      </div>


    </div>

    <table class="layui-hide" id="courseTable" lay-filter="courseTable"></table>

    <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm layui-btn-warm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加课程</button>
            <button class="layui-btn layui-btn-sm layui-btn-warm" lay-event="mutiOnshelf">批量上架</button>
            <button class="layui-btn layui-btn-sm" lay-event="mutiUnshelf">批量下架</button>
        </div>
      </script>
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="onshelf">上架</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="unshelf">下架</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
  </div>
  <script src="../../layui/layui.js"></script>
  <script>
    window.onload = function () {
      layui.config({
        base: "../../static/",
      }).extend({
        cascader: 'cascader/cascader'
      });
      layui.use(["jquery", "weadmin", "table", "cascader", "form"], function () {
        var $ = layui.jquery,
          weadmin = layui.weadmin,
          table = layui.table;
        cascader = layui.cascader;
        let form = layui.form,
          lang = "zh",  //默认中文
          categoryIdTree = [];

        // 监听语言切换，更换课程系列和来源数据
        form.on('radio(lang)', function (data) {
          lang = data.value
          getListData()
          tableInstance.reload({
            where: {
              "name": "",
              "categoryId": 0,
              "lang":lang
            },
            page: {
              curr: 1
            }
          });
        });
        // 课程系列
        let categoryIdInit = [];
        let cascaderInstance;
        // 课程分类
        getListData()
        // 请求课程系列数据
        function getListData() {
          layui.$.ajax({
            type: "get",
            url:"/source/coursecategory/dropdown?lang="+lang,
            success: function (res) {
              categoryIdTree = [];
              try {
                if (res.obj) {
                  res.obj.forEach((first_item, first_index) => {
                    categoryIdTree.push({
                      id: first_item.id,
                      course_name: first_item.name,
                      fid: '0',
                      children: []
                    })
                    if (first_item.child) {
                      first_item.child.forEach((secend_item, secend_index) => {
                        categoryIdTree[first_index].children.push({
                          id: secend_item.id,
                          course_name: secend_item.name,
                          fid: first_item.id,
                          children: []
                        })
                        if (secend_item.child) {
                          secend_item.child.forEach((three_item, three_index) => {
                            categoryIdTree[first_index].children[secend_index].children.push({
                              id: three_item.id,
                              course_name: three_item.name,
                              fid: secend_item.id,
                            })
                          })
                        }
                      })
                    }
                  });
                }
                categoryIdInit = categoryIdTree;
                categoryIdTree = JSON.stringify(categoryIdInit)
                // 课程分类
                let html_str = `
                    <input type="text"  lay-verify="required" name="categoryId" value="" id="categoryId" style="display: none;" />
                  `
                $('.categoryId').html(html_str);
                cascader.render({
                  elem: $('input[name=categoryId]')[0],
                  options: JSON.parse(categoryIdTree),
                  multiple: false, // 支持多选
                  showAllLevels: true,
                  props: {
                    label: 'course_name',
                    value: 'id',
                    children: 'children'
                  },
                  placeholder: '请选择课程系列'
                });
              } catch (error) {
                console.log(error)
              }
            },
            error: function (err) {
              console.log(err);
            },
          });
        }


        // 搜索
        $('.name-search').on("click", function (e) {
          let nameValue = $('#search')[0].value;
          let categoryId = $('#categoryId')[0].value;
          if (categoryId == null || categoryId == '') {
            categoryId = 0;
          } else {
            categoryId = categoryId.split(',').pop();
          }
          tableInstance.reload({
            where: {
              "name": nameValue,
              "categoryId": categoryId,
              "lang":lang
            },
            page: {
              curr: 1
            }
          });
        });

        // 重置
        $('.name-reset').on("click", function (e) {
          $('#search')[0].value = "";
          let html_str = `
              <input type="text"  lay-verify="required" name="categoryId" value="" id="categoryId" style="display: none;" />
            `
          $('.categoryId').html(html_str);
          let categoryIdTree = JSON.stringify(categoryIdInit)
          cascader.render({
            elem: $('input[name=categoryId]')[0],
            options: JSON.parse(categoryIdTree),
            multiple: false, // 支持多选
            showAllLevels: true,
            props: {
              label: 'course_name',
              value: 'id',
              children: 'children'
            },
            placeholder: '请选择课程系列'
          });
          tableInstance.reload({
            where: {
              "name": "",
              "categoryId": 0,
              "lang":lang
            },
            page: {
              curr: 1
            }
          });
        });

        let tableInstance = table.render({
          elem: "#courseTable",
          url: "/source/course/list",
          request: {
            pageName: "pageCurrent",
            limitName: "limit",
          },
          where: {
            "name": '',
            "categoryId": 0,
            "lang":lang
          },
          parseData: function (res) {
            if (res.records) {
              let transformData = res.records.map((newsRow, index) => {
                newsRow.statusText = newsRow.status === '1' ? "已上架" : "未上架";
                return newsRow;
              });
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.totalNum.totalNum, //解析数据长度
                data: transformData, //解析数据列表
              };
            } else {
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: 0, //解析数据长度
                data: [], //解析数据列表
              };
            }
          },
          toolbar: "#toolbar",
          title: "课程管理表",
          cols: [
            [
              { type: "checkbox", fixed: "left" },
              { field: "id", title: "课程ID", fixed: "left" },
              { field: "title", title: "课程名称" },
              { field: "releaseDate", title: "上架时间" },
              { field: "updateTime", title: "最近修改时间" },
              { field: "sequenceNo", title: "顺序" },
              {
                field: "statusText",
                sort: true,
                title: "状态",
                templet: function (d) {
                  if (d.status === '1') {
                    return d.statusText;
                  } else {
                    return (
                      '<span style="color: red;">' + d.statusText + "</span>"
                    );
                  }
                },
              },
              {
                field: "label",
                sort: true,
                title: "标签",
                templet: function (d) {
                  if (d.label === 'NEW') {
                    return (
                      '<span class="newClass labelClass">' + d.label + "</span>"
                    );
                  } else if (d.label === 'HOT') {
                    return (
                      '<span class="hotClass labelClass">' + d.label + "</span>"
                    );
                  } else {
                    return (
                      '<span style="color: #999;">' + '暂无标签' + "</span>"
                    );
                  }
                },
              },
              {
                fixed: "right",
                width: 250,
                title: "操作",
                toolbar: "#barDemo",
              },
            ],
          ],
          page: true,
        });

        //工具栏事件
        table.on("toolbar(courseTable)", function (obj) {
          let checkStatus = table.checkStatus(obj.config.id);
          let data = checkStatus.data;
          switch (obj.event) {
            case "mutiDelete":
              if (data.length > 0) {
                let index = layer.confirm(
                  "您确定要删除已选的课程吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    let ids = data.map((rowData, index) => {
                      return rowData.id;
                    });
                    $.ajax({
                      type: "get",
                      url: "/source/course/delete?ids=" + ids,
                      success: function (response) {
                        if (response.status === 200) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        } else {
                          layer.alert(response.msg + ":" + response.obj, { icon: 5 })
                        }
                      },
                      error: function (err) {
                        layer.alert("删除失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
              } else {
                layer.alert("请选择您要删除的课程", { icon: 5 });
              }
              break;
            case "mutiOnshelf":
              if (data.length > 0) {
                let index = layer.confirm(
                  "您确定要上架已选的课程吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    let ids = data.map((rowData, index) => {
                      return rowData.id;
                    });
                    $.ajax({
                      type: "get",
                      url: "/source/course/release?ids=" + ids,
                      success: function (response) {
                        let index = layer.alert(
                          "上架成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("上架失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
              } else {
                layer.alert("请选择您要上架的课程", { icon: 5 });
              }
              break;
            case "mutiUnshelf":
              if (data.length > 0) {
                let index = layer.confirm(
                  "您确定要下架已选的课程吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    let ids = data.map((rowData, index) => {
                      return rowData.id;
                    });
                    $.ajax({
                      type: "get",
                      url: "/source/course/unshelf?ids=" + ids,
                      success: function (response) {
                        let index = layer.alert(
                          "下架成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("下架失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
              } else {
                layer.alert("请选择您要下架的课程", { icon: 5 });
              }
              break;
            case "add":
              let props={
                lang:lang,
                type:"add"
              }
              WeAdminEdit("课程添加", "./add.html",JSON.stringify(props));
              break;
            default:
              break;
          }
        });

        //监听行单击事件
        table.on("tool(courseTable)", function (obj) {
          switch (obj.event) {
            case "edit":
            let props={
                lang:lang,
                data:obj.data,
                type:"edit"
              }
              WeAdminEdit("课程编辑", "./add.html", JSON.stringify(props));
              break;
            case "onshelf":
              if (obj.data.status === '1') {
                layer.alert("该条课程已经上架过啦！！", { icon: 5 });
                return;
              }
              let index = layer.confirm(
                "您确定要上架这条课程吗？",
                {
                  btn: ["确定", "取消"], //按钮
                },
                function () {
                  $.ajax({
                    type: "get",
                    url: "/source/course/release?ids=" + [obj.data.id],
                    success: function (response) {
                      let index = layer.alert(
                        "上架成功",
                        { icon: 6 },
                        function () {
                          layer.close(index);
                          tableInstance.reload();
                        }
                      );
                    },
                    error: function (err) {
                      layer.alert("上架失败:" + err, { icon: 5 });
                    },
                  });
                },
                function () {
                  layer.close(index);
                }
              );
              break;
            case "unshelf":
              if (obj.data.status === '0') {
                layer.alert("该条课程已经下架过啦！！", { icon: 5 });
                return;
              }
              let index2 = layer.confirm(
                "您确定要下架这条课程吗？",
                {
                  btn: ["确定", "取消"], //按钮
                },
                function () {
                  $.ajax({
                    type: "get",
                    url: "/source/course/unshelf?ids=" + [obj.data.id],
                    success: function (response) {
                      let index = layer.alert(
                        "下架成功",
                        { icon: 6 },
                        function () {
                          layer.close(index);
                          tableInstance.reload();
                        }
                      );
                    },
                    error: function (err) {
                      layer.alert("下架失败:" + err, { icon: 5 });
                    },
                  });
                },
                function () {
                  layer.close(index2);
                }
              );
              break;
            case "del":
              let index1 = layer.confirm(
                "您确定要删除这条课程吗？",
                {
                  btn: ["确定", "取消"], //按钮
                },
                function () {
                  $.ajax({
                    type: "get",
                    url: "/source/course/delete?ids=" + [obj.data.id],
                    success: function (response) {
                      let index = layer.alert(
                        "删除成功",
                        { icon: 6 },
                        function () {
                          layer.close(index);
                          tableInstance.reload();
                        }
                      );
                    },
                    error: function (err) {
                      console.log("删除失败");
                    },
                  });
                },
                function () {
                  layer.close(index1);
                }
              );
              break;
            default:
              break;
          }
        });

        window.addEventListener("message", receiveMessage, false);
        function receiveMessage(event) {
          switch (event.data.messageType) {
            case "reloadTable":
              tableInstance.reload();
              break;
            default:
              break;
          }
        }
      });
    };
  </script>
</body>

</html>