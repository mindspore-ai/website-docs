<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>邮件管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="newsForm">
        <div class="layui-form-item">
          <label for="title" class="layui-form-label">
            <span class="we-red">*</span>邮件标题
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="title"
              name="title"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="url" class="layui-form-label">
            <span class="we-red">*</span>邮件地址
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="url"
              name="url"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="newsTime" class="layui-form-label">
            <span class="we-red">*</span>邮件时间
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              name="newsTime"
              id="newsTime"
              lay-verify="date"
              placeholder="yyyy-MM-dd"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <div class="layui-form-item">
          <label for="content" class="layui-form-label">
            <span class="we-red">*</span>邮件内容
          </label>
          <div class="layui-input-inline">
            <textarea
              id="content"
              name="content"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-textarea"
              rows="5"
            ></textarea>
          </div>
        </div>
        <div class="layui-form-item">
          <label for="language" class="layui-form-label">
            <span class="we-red">*</span>新闻语言
          </label>
          <div class="layui-input-block">
            <input
              type="radio"
              name="language"
              value="zh"
              title="中文"
              checked=""
            />
            <input type="radio" name="language" value="en" title="英语" />
          </div>
        </div>
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="newsAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(
          ["form", "weadmin", "jquery", "laydate", "layer"],
          function () {
            var form = layui.form,
              weadmin = layui.weadmin,
              $ = layui.jquery,
              laydate = layui.laydate;
            layer = layui.layer;

            laydate.render({
              elem: "#newsTime",
            });

            //自定义验证规则
            form.verify({});

            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if (initData) {
              let initDataJson = JSON.parse(initData);
              let newsTime =
                initDataJson.language === "zh"
                  ? initDataJson.newsTime
                      .replace(/[年月]/g, "-")
                      .replace(/[日]/, "")
                  : initDataJson.newsTime;

              form.val("newsForm", {
                title: initDataJson.title,
                content: initDataJson.content,
                newsTime: newsTime,
                url: initDataJson.url,
              });
            }

            //监听提交
            form.on("submit(add)", function (data) {
              let formdata = new FormData();
              let fetchUrl;
              let successText;
              for (const key in data.field) {
                formdata.append(key, data.field[key]);
              }

              if (initData && JSON.parse(initData).id) {
                //编辑
                fetchUrl = "/source/updateInfo";
                formdata.append("id", JSON.parse(initData).id);
                successText = "编辑成功";
              } else {
                //新增
                fetchUrl = "/source/saveInfo";
                successText = "保存成功";
              }

              $.ajax({
                type: "post",
                url: fetchUrl,
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      successText,
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            $("#newsAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
            });
          }
        );
      };
    </script>
  </body>
</html>
