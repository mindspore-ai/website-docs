<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>邮件管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
  </head>

  <body>
    <div class="weadmin-body">
      <table class="layui-hide" id="table" lay-filter="table"></table>

      <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加邮件</button>
        </div>
      </script>
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="send">发送</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
    </div>
    <script src="../../layui/layui.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["jquery", "weadmin", "table"], function () {
          var $ = layui.jquery,
            weadmin = layui.weadmin,
            table = layui.table;

          let tableInstance = table.render({
            elem: "#table",
            url: "/source/selectInfo",
            request: {
              pageName: "pageCurrent",
              limitName: "limit",
            },
            toolbar: "#toolbar",
            title: "邮件表",
            parseData: function (res) {
              let transformData = res.obj.records.map((newsRow, index) => {
                newsRow.statusText = newsRow.status === 1 ? "已发送" : "未发送";
                return newsRow;
              });

              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.obj.totalNum.totalNum, //解析数据长度
                data: transformData, //解析数据列表
              };
            },
            cols: [
              [
                { type: "checkbox", fixed: "left" },
                {
                  field: "id",
                  title: "ID",
                  fixed: "left",
                },
                { field: "title", title: "邮件标题" },
                { field: "content", title: "邮件内容" },
                { field: "language", title: "语言" },
                { field: "newsTime", title: "邮件时间" },
                { field: "url", title: "邮件地址" },
                {
                  field: "statusText",
                  title: "状态",
                  templet: function (d) {
                    if (d.status === 1) {
                      return d.statusText;
                    } else {
                      return (
                        '<span style="color: red;">' + d.statusText + "</span>"
                      );
                    }
                  },
                },
                {
                  fixed: "right",
                  title: "操作",
                  toolbar: "#barDemo",
                },
              ],
            ],
            page: true,
          });

          //工具栏事件
          table.on("toolbar(table)", function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let data = checkStatus.data;
            switch (obj.event) {
              case "mutiDelete":
                if (data.length > 0) {
                  let index = layer.confirm(
                    "您确定要删除已选的邮件吗？",
                    {
                      btn: ["确定", "取消"], //按钮
                    },
                    function () {
                      let ids = data.map((rowData, index) => {
                        return rowData.id;
                      });
                      $.ajax({
                        type: "get",
                        url: "/source/deleteInfo?ids=" + ids,
                        success: function (response) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        },
                        error: function (err) {
                          layer.alert("删除失败:" + err, { icon: 5 });
                        },
                      });
                    },
                    function () {
                      layer.close(index);
                    }
                  );
                } else {
                  layer.alert("请选择您要删除的邮件", { icon: 5 });
                }
                break;
              case "add":
                WeAdminShow("邮件添加", "./add.html");
                break;
              default:
                break;
            }
          });

          //监听行单击事件
          table.on("tool(table)", function (obj) {
            switch (obj.event) {
              case "edit":
                WeAdminEdit("邮件编辑", "./add.html", JSON.stringify(obj.data));
                break;
              case "send":
                WeAdminEdit(
                  "邮件发送",
                  "./send.html",
                  JSON.stringify(obj.data)
                );
                break;
              case "del":
                let index1 = layer.confirm(
                  "您确定要删除这条邮件吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/deleteInfo?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "删除成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        console.log("删除失败");
                      },
                    });
                  },
                  function () {
                    layer.close(index1);
                  }
                );
                break;
              default:
                break;
            }
          });

          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
            switch (event.data.messageType) {
              case "reloadTable":
                tableInstance.reload();
                break;
              default:
                break;
            }
          }
        });
      };
    </script>
  </body>
</html>
