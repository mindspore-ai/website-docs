<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>邮件管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
      .progress-text {
        color: #000;
        font-size: 20px;
        line-height: 1.5;
        white-space: nowrap;
        overflow: hidden;
        text-align: center;
      }
      .progress-wraper {
        width: 200px;
        height: 250px;
        position: relative;
        background-color: #fff;
        border-radius: 5px;
      }
      .progress-mask {
        position: fixed;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="sendForm">
        <div class="layui-form-item">
          <label for="subject" class="layui-form-label">
            <span class="we-red">*</span>邮件主题
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="subject"
              name="subject"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="email" class="layui-form-label">
            同步发送
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="email"
              name="email"
              autocomplete="off"
              placeholder="请输入需要同步发送的邮箱地址,多个邮箱地址以英文逗号分隔"
              class="layui-input"
            />
          </div>
        </div>
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" id="preview">
            预览
          </button>
          <button class="layui-btn" lay-filter="send" lay-submit="">
            发送
          </button>
          <button class="layui-btn" lay-filter="sendAll" lay-submit="">
            全员发送
          </button>
          <button class="layui-btn" id="cancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>

    <div class="progress-mask" style="display: none;">
      <div class="progress-wraper">
        <canvas id="progress" width="200" height="200"></canvas>
        <div class="progress-text">推送中...</div>
      </div>
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/progress.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["form", "weadmin", "jquery", "layer"], function () {
          var form = layui.form,
            weadmin = layui.weadmin,
            $ = layui.jquery,
            layer = layui.layer;

          //自定义验证规则
          form.verify({});

          //编辑时有初始化
          let initData = document.getElementById("pData").value;
          if (initData) {
            let initDataJson = JSON.parse(initData);
            console.log(initDataJson);
          }

          //监听提交
          form.on("submit(send)", function (data) {
            $(".progress-mask").css({ display: "flex" });
            var p1 = new Progress({
              el: "progress", //canvas元素id
              percent: 0, //绘制角度
              lineWidth: 25, //线宽
              lineBgColor: "#1e637c", //底圆颜色
              lineColor: "#009688", //动态圆颜色
              textColor: "#000", //文本颜色
              fontSize: 22, //字体大小
              circleRadius: 60, //圆半径
            });
            layui.$.ajax({
              type: "post",
              url: "/source/pushInfo",
              processData: false,
              contentType: "application/json",
              data: JSON.stringify({
                ...data.field,
                ids: [JSON.parse(initData).id],
              }),
              success: function (res) {
                if (res.status === 200) {
                  fetchProgress(
                    1000,
                    (percent) => {
                      if (percent == 100) {
                        p1.set(percent, 100);
                        setTimeout(() => {
                          $(".progress-mask").css({ display: "none" });
                        }, 1000);
                      } else {
                        p1.set(percent, 1000);
                      }
                    },
                    () => {
                      layer.alert(
                        "发送完成",
                        {
                          icon: 6,
                        },
                        function () {
                          window.parent.postMessage(
                            { messageType: "reloadTable" },
                            location.origin
                          );
                          var index = parent.layer.getFrameIndex(window.name);
                          parent.layer.close(index);
                        }
                      );
                    }
                  );
                  function fetchProgress(interval, notify, done) {
                    let timer = setInterval(() => {
                      $.ajax({
                        type: "get",
                        url: "/source/pushInfoTask?taskId=" + res.obj,
                        success: function (response) {
                          let compete = response.obj.complete;
                          let total = response.obj.total;
                          if (!compete && !total) {
                            clearInterval(timer);
                            notify(100);
                            done();
                          } else {
                            notify((compete / total) * 100);
                          }
                        },
                        error: function (err) {
                          console.log(err);
                        },
                      });
                    }, interval);
                  }
                }
              },
              error: function (err) {
                console.log(err);
              },
            });
            return false;
          });

          form.on("submit(sendAll)", function (data) {
            $(".progress-mask").css({ display: "flex" });
            var p1 = new Progress({
              el: "progress", //canvas元素id
              percent: 0, //绘制角度
              lineWidth: 25, //线宽
              lineBgColor: "#1e637c", //底圆颜色
              lineColor: "#009688", //动态圆颜色
              textColor: "#000", //文本颜色
              fontSize: 22, //字体大小
              circleRadius: 60, //圆半径
            });
            layui.$.ajax({
              type: "post",
              url: "/source/send2all",
              processData: false,
              contentType: "application/json",
              data: JSON.stringify({
                ...data.field,
                ids: [JSON.parse(initData).id],
              }),
              success: function (res) {
                if (res.status === 200) {
                  fetchProgress(
                    1000,
                    (percent) => {
                      if (percent == 100) {
                        p1.set(percent, 100);
                        setTimeout(() => {
                          $(".progress-mask").css({ display: "none" });
                        }, 1000);
                      } else {
                        p1.set(percent, 1000);
                      }
                    },
                    () => {
                      layer.alert(
                        "发送完成",
                        {
                          icon: 6,
                        },
                        function () {
                          window.parent.postMessage(
                            { messageType: "reloadTable" },
                            location.origin
                          );
                          var index = parent.layer.getFrameIndex(window.name);
                          parent.layer.close(index);
                        }
                      );
                    }
                  );
                  function fetchProgress(interval, notify, done) {
                    let timer = setInterval(() => {
                      $.ajax({
                        type: "get",
                        url: "/source/pushInfoTask?taskId=" + res.obj,
                        success: function (response) {
                          let compete = response.obj.complete;
                          let total = response.obj.total;
                          if (!compete && !total) {
                            clearInterval(timer);
                            notify(100);
                            done();
                          } else {
                            notify((compete / total) * 100);
                          }
                        },
                        error: function (err) {
                          console.log(err);
                        },
                      });
                    }, interval);
                  }
                }
              },
              error: function (err) {
                console.log(err);
              },
            });
            return false;
          });

          layui.$("#cancel").on("click", function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
          });

          layui.$("#preview").on("click", function () {
            sessionStorage.setItem("idpush", JSON.parse(initData).id);
            let formVal = form.val("sendForm");
            if (formVal.subject === "") {
              alert("主题不能为空");
              return false;
            }
            window.open("./preview.html");
            return false
          });
        });
      };
    </script>
  </body>
</html>
