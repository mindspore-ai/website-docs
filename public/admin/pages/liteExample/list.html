<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>端侧示例</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
  </head>

  <body>
    <div class="weadmin-body">
      <table class="layui-hide" id="liteExampleTable" lay-filter="liteExampleTable"></table>

      <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加示例</button>
        </div>
      </script>
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="publish">发布</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
    </div>
    <script src="../../layui/layui.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["jquery", "weadmin", "table"], function () {
          var $ = layui.jquery,
            weadmin = layui.weadmin,
            table = layui.table;

          let tableInstance = table.render({
            elem: "#liteExampleTable",
            url: "/source/example/list",
            request: {
              pageName: "pageCurrent",
              limitName: "limit",
            },
            parseData: function (res) {
              let transformData = res.records.map((newsRow, index) => {
                newsRow.statusText = newsRow.status === '1' ? "已发布" : "未发布";
                return newsRow;
              });
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.totalNum.totalNum, //解析数据长度
                data: transformData, //解析数据列表
              };
            },
            toolbar: "#toolbar",
            title: "资讯表",
            cols: [
              [
                { type: "checkbox", fixed: "left" },
                { field: "id", title: "ID" },
                { field: "title", title: "示例标题" },
                { field: "introduce", title: "示例介绍" },
                { field: "androidUrl", title: "在Android示例链接" },
                { field: "iosUrl", title: "在iOS示例链接" },
                { field: "lotUrl", title: "在loT示例链接" },
                { field: "updateTime", title: "发布时间" },
                { field: "lang", title: "示例语言" },
                { field: "sequenceNo", title: "顺序" },
                {
                  field: "statusText",
                  title: "状态",
                  templet: function (d) {
                    if (d.status === '1') {
                      return d.statusText;
                    } else {
                      return (
                        '<span style="color: red;">' + d.statusText + "</span>"
                      );
                    }
                  },
                },
                {
                  fixed: "right",
                  title: "操作",
                  toolbar: "#barDemo",
                  width:250
                },
              ],
            ],
            page: true,
          });

          //工具栏事件
          table.on("toolbar(liteExampleTable)", function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let data = checkStatus.data;
            switch (obj.event) {
              case "mutiDelete":
                if (data.length > 0) {
                  let index = layer.confirm(
                    "您确定要删除已选的示例吗？",
                    {
                      btn: ["确定", "取消"], //按钮
                    },
                    function () {
                      let ids = data.map((rowData, index) => {
                        return rowData.id;
                      });
                      $.ajax({
                        type: "get",
                        url: "/source/example/delete?ids=" + ids,
                        success: function (response) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        },
                        error: function (err) {
                          layer.alert("删除失败:" + err, { icon: 5 });
                        },
                      });
                    },
                    function () {
                      layer.close(index);
                    }
                  );
                } else {
                  layer.alert("请选择您要删除的是咧", { icon: 5 });
                }
                break;
              case "add":
                WeAdminShow("Lite示例添加", "./add.html");
                break;
              default:
                break;
            }
          });

          //监听行单击事件
          table.on("tool(liteExampleTable)", function (obj) {
            switch (obj.event) {
              case "edit":
                WeAdminEdit("示例编辑", "./add.html", JSON.stringify(obj.data));
                break;
              case "publish":
                if (obj.data.status === 1) {
                  layer.alert("该条示例已经发布过啦！！", { icon: 5 });
                  return;
                }
                let index = layer.confirm(
                  "您确定要发布这条示例吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/example/release?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "发布成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("发布失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
                break;
              case "del":
                let index1 = layer.confirm(
                  "您确定要删除这条示例吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/example/delete?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "删除成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        console.log("删除失败");
                      },
                    });
                  },
                  function () {
                    layer.close(index1);
                  }
                );
                break;
              default:
                break;
            }
          });

          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
            switch (event.data.messageType) {
              case "reloadTable":
                tableInstance.reload();
                break;
              default:
                break;
            }
          }
        });
      };
    </script>
  </body>
</html>
