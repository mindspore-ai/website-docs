<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Lite模型-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
    	.layui-upload-drag {
    	  	padding: 0;
    	  	display: flex;
    	  	flex-direction: column;
    	  	justify-content: center;
    	  	align-items: center;
    	}
    	.layui-form-item .layui-input-inline {
    	  	width: calc(100% - 200px);
    	}
    </style>
</head>

<body>
    <div class="weadmin-body">
      	<form class="layui-form" lay-filter="liteModelForm">
        	<div class="layui-form-item">
				<label for="title" class="layui-form-label">
					<span class="we-red">*</span>模型标题
				</label>
				<div class="layui-input-inline">
					<input type="text"
						id="title"
						name="title"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					/>
				</div>
        	</div>
        	<div class="layui-form-item">
				<label for="introduce" class="layui-form-label">
					<span class="we-red">*</span>模型介绍
				</label>
				<div class="layui-input-inline">
					<input type="text"
						id="introduce"
						name="introduce"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					/>
				</div>
        	</div>
        	<div class="layui-form-item">
				<label for="link" class="layui-form-label">
					<span class="we-red">*</span>模型链接
				</label>
				<div class="layui-input-inline">
					<input type="text"
						id="link"
						name="link"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					/>
				</div>
        	</div>
			<div class="layui-form-item">
				<label for="releaseDate" class="layui-form-label">
				  <span class="we-red">*</span>发布时间
				</label>
				<div class="layui-input-inline">
				  <input
					type="text"
					name="releaseDate"
					id="releaseDate"
					lay-verify="date"
					placeholder="yyyy-MM-dd"
					autocomplete="off"
					class="layui-input"
				  />
				</div>
			</div>
			<div class="layui-form-item">
				<label for="lang" class="layui-form-label">
				  <span class="we-red">*</span>模型语言
				</label>
				<div class="layui-input-block">
				  <input type="radio" name="lang" value="zh" title="中文" checked="" />
				  <input type="radio" name="lang" value="en" title="英语" />
				</div>
			</div>
			<div class="layui-form-item">
				<label for="sequenceNo" class="layui-form-label">
				  模型顺序
				</label>
				<div class="layui-input-inline">
				  <input
				  type="text"
				  id="sequenceNo"
				  name="sequenceNo"
				  lay-verify="sequenceNo"
				  autocomplete="off"
				  class="layui-input"
				  placeholder="请输入模型顺序"
					/>
				</div>
			</div>
			<div class="layui-form-item" id="icon">
				<label for="iconImageValue" class="layui-form-label">
					  <span class="we-red">*</span>模型icon
				</label>
				<div class="layui-input-inline">
					  <input
						type="hidden"
						id="iconImageValue"
						lay-verify="required"
						name="icon"
						value=""
					  />
					  <div class="layui-upload-drag" id="icon" style="width: 110px; height: 110px;">
							<i class="layui-icon layui-upload-icon"></i>
							<p class="layui-upload-text">请使用长宽尺寸为30px*30px的图片</p>
							<div class="layui-hide" id="uploadIconImageView">
						  <img 
							  src=""
									alt="上传成功后渲染"
									style="width: 30px; height: 30px;"
								  />
							</div>
					  </div>
				</div>
		  </div>
        	<br />
        	<div class="layui-form-item">
        	  	<label class="layui-form-label"></label>
        	  	<button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
        	  	<button class="layui-btn" id="modeledAddCancel">取消</button>
        	</div>
      	</form>
      	<input style="display: none;" type="text" id="pData" value="" />
	</div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; 
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["form", "weadmin", "jquery", "laydate", "upload", "layer"], function () {
            var form = layui.form,
            weadmin = layui.weadmin,
            $ = layui.jquery,
            upload = layui.upload,
			laydate = layui.laydate;
            layer = layui.layer;

			laydate.render({
              elem: "#releaseDate",
            });

            //自定义验证规则
            form.verify({
				sequenceNo:[
					/(^$)|^[1-9](\d*)$/,
					'模型顺序必须为正整数'
				]
			});
            
            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if (initData) {
              	let initDataJson = JSON.parse(initData);
				// 编辑内层数据
				if(initDataJson.icon) {
					let iconImg =
              	    initDataJson.icon.startsWith("http://") ||
              	    initDataJson.icon.startsWith("https://") ||
              	    initDataJson.icon.startsWith("/")
              	    ? initDataJson.icon
              	    : initDataJson.icon.startsWith("1")
              	    ? "http://" + initDataJson.icon
              	    : "https://" + initDataJson.icon;
               		layui
               		.$("#uploadIconImageView")
               		.removeClass("layui-hide")
               		.find("img")
               		.attr("src", iconImg);
				}
              
                form.val("liteModelForm", {
                  	id: initDataJson.id,
                  	title: initDataJson.title,
                  	icon: initDataJson.icon,
                  	introduce: initDataJson.introduce,
                  	link: initDataJson.link,
                  	lang: initDataJson.lang,
					  sequenceNo: initDataJson.sequenceNo ? initDataJson.sequenceNo : 999,
					releaseDate: initDataJson.releaseDate
                });
                $(".layui-upload-text, .layui-upload-icon").css({
                  	display: "none",
                });
            }

            //监听提交
            form.on("submit(add)", function (data) {
              	let formdata = new FormData();
              	for (const key in data.field) {
					if( key === 'sequenceNo' ){
						if(data.field[key] == '' || data.field[key] == 999 || data.field[key] == null) {
							formdata.append(key, 999);
						} else {
							formdata.append(key, data.field[key]);
						}
					} else {
						formdata.append(key, data.field[key]);
					}
              	}
              	if (initData && JSON.parse(initData).id) {
              	  	//是否有id
              	  	formdata.append("id", JSON.parse(initData).id);
              	}

              	layui.$.ajax({
                	type: "post",
                	url:  "/source/modeled/add",
                	processData: false,
                	contentType: false,
                	data: formdata,
                	success: function (res) {
                	  	if (res.status === 200) {
                	  	  	layer.alert(
                	  	  	  	"保存成功",
                	  	  	  	{ icon: 6 },
                	  	  	  	function () {
                	  	  	  	  	window.parent.postMessage(
                	  	  	  	  	  	{ messageType: "reloadTable" },
                	  	  	  	  	  	location.origin
                	  	  	  	  	);
                	  	  	  	  	var index = parent.layer.getFrameIndex(window.name);
                	  	  	  	  	parent.layer.close(index);
                	  	  	  	}
                	  	  	);
                	  	}
                	},
                	error: function (err) {
                	  	console.log(err);
                	},
              });
              return false;
            });

            layui.$("#modeledAddCancel").on("click", function () {
              	var index = parent.layer.getFrameIndex(window.name);
              	parent.layer.close(index);
            });

            //文件上传
            //拖拽上传
            upload.render({
              	elem: "#icon",
             	url: "/source/modeled/icon/uploadFile", //改成您自己的上传接口
              	field: "uploadFile",
              	done: function (res) {
              	  	layer.msg("上传成功");
              	  	let url =
              	  	  res.url.startsWith("/") ||
              	  	  res.url.startsWith("https://") ||
              	  	  res.url.startsWith("http://")
              	  	    ? res.url
              	  	    : res.url.startsWith("1")
              	  	    ? "http://" + res.url
              	  	    : "https://" + res.url;
              	  	layui
              	  	  .$("#uploadIconImageView")
              	  	  .removeClass("layui-hide")
              	  	  .find("img")
              	  	  .attr("src", url);
              	  	$(".layui-upload-text, .layui-upload-icon").css({
              	  	  	display: "none",
              	  	});
              	  	$("#iconImageValue")[0].value = url;
              	}
            });
          }
        );
      };
    </script>
  </body>
</html>
