<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>资讯管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
      .category {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="newsForm">
        <div class="layui-form-item">
          <label for="newsTitle" class="layui-form-label">
            <span class="we-red">*</span>资讯标题
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="newsTitle"
              name="newsTitle"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="newsContent" class="layui-form-label">
            <span class="we-red">*</span>资讯摘要
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="newsContent"
              name="newsContent"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="newsDetail" class="layui-form-label">
            <span class="we-red">*</span>资讯正文
          </label>
          <div class="layui-input-inline">
            <div id="editor" lay-verify="editor"></div>
          </div>
        </div>
        <div class="layui-form-item">
          <label for="newsTime" class="layui-form-label">
            <span class="we-red">*</span>资讯时间
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              name="newsTime"
              id="newsTime"
              lay-verify="date"
              placeholder="yyyy-MM-dd"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="tag" class="layui-form-label">
            <span class="we-red">*</span>资讯语言
          </label>
          <div class="layui-input-block">
            <input type="radio" name="tag" value="zh" title="中文" checked="" lay-filter="tag"  />
            <input type="radio" name="tag" value="en" title="英语" lay-filter="tag" />
          </div>
        </div>
        <div class="layui-form-item type-box">
          <label for="type" class="layui-form-label">
            <span class="we-red">*</span>资讯分类
          </label>
          <div class="layui-input-block">
            <input type="radio" name="type" value="1" title="版本发布" checked="" lay-filter="type" />
            <input type="radio" name="type" value="2" title="技术博客" lay-filter="type" />
            <input type="radio" name="type" value="4" title="每日新闻" lay-filter="type" />
            <input type="radio" name="type" value="3" title="活动公告" lay-filter="type" />
          </div>
        </div>
        <div class="layui-form-item category" >
         
        </div>
        <div class="layui-form-item">
          <label for="newsImageValue" class="layui-form-label">
            <span class="we-red">*</span>资讯封面
          </label>

          <div class="layui-input-inline">
            <input
              type="hidden"
              id="newsImageValue"
              lay-verify="required"
              name="newsImage"
              value=""
            />
            <div
              class="layui-upload-drag"
              id="newsImage"
              style="width: 378px; height: 136px;"
            >
              <i class="layui-icon layui-upload-icon"></i>
              <p class="layui-upload-text">
                请使用长宽尺寸为378px*136px的图片封面
              </p>
              <div class="layui-hide" id="uploadNewsImageView">
                <img
                  src=""
                  alt="上传成功后渲染"
                  style="width: 378px; height: 136px;"
                />
              </div>
            </div>
          </div>
        </div>
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" id="newsImagePreview">
            预览
          </button>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="newsAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(
          ["form", "weadmin", "jquery", "laydate", "upload", "layer"],
          function () {
            var form = layui.form,
              weadmin = layui.weadmin,
              $ = layui.jquery,
              upload = layui.upload,
              laydate = layui.laydate;
            layer = layui.layer;

            laydate.render({
              elem: "#newsTime",
            });

            //自定义验证规则
            form.verify({});

            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if (initData) {
              let initDataJson = JSON.parse(initData);
              let newsImage =
                initDataJson.newsImage.startsWith("http://") ||
                initDataJson.newsImage.startsWith("https://") ||
                initDataJson.newsImage.startsWith("/")
                  ? initDataJson.newsImage
                  : initDataJson.newsImage.startsWith("1")
                  ? "http://" + initDataJson.newsImage
                  : "https://" + initDataJson.newsImage;
              let newsTime =
                initDataJson.tag === "zh"
                  ? initDataJson.newsTime
                      .replace(/[年月]/g, "-")
                      .replace(/[日]/, "")
                  : initDataJson.newsTime;
              layui
                .$("#uploadNewsImageView")
                .removeClass("layui-hide")
                .find("img")
                .attr("src", newsImage);
              form.val("newsForm", {
                newsTitle: initDataJson.newsTitle,
                newsContent: initDataJson.newsContent,
                newsTime: newsTime,
                newsImage: initDataJson.newsImage,
                tag: initDataJson.tag,
                type: initDataJson.type,
              });
              // if(initDataJson.tag === 'en') {
              //   $('.type-box').css('display', 'none');
              // }
              // $("#newsImageValue")[0].value = initDataJson.newsImage;
              $(".layui-upload-text, .layui-upload-icon").css({
                display: "none",
              });
              layui.$.ajax({
                type: "get",
                url: "/source/selectNewsdesc?id=" + initDataJson.id,
                success: function (res) {
                  try {
                    editor &&
                      editor.txt.html(htmlDecode(res.obj.newsDetail || ""));
                    if(res.obj.type == 2) {
                      let html_str = `
                        <label for="category" class="layui-form-label">
                          博客分类
                        </label>
                        <div class="layui-input-inline">
                          <input
                            type="text"
                            name="category"
                            id="category"
                            lay-verify=""
                            placeholder="请输入博客分类名称"
                            autocomplete="off"
                            class="layui-input"
                          />
                        </div> 
                        `
                        $('.category').html(html_str);
                        form.val("newsForm", {
                          category: res.obj.category ? res.obj.category : '',
                        });
                        $('.category').css('display','block')
                    }
                    form.val("newsForm", {
                      tag: res.obj.tag,
                      type: res.obj.type,
                    });
                  } catch (error) {}
                },
                error: function (err) {
                  console.log(err);
                },
              });
            }

            // 监听语言，英文不需要分类
            form.on('radio(tag)', function(data) {
              // if(data.value === 'en') {
              //   $('.type-box').css('display', 'none');
              // } else {
              //   $('.type-box').css('display', 'block');
              // }
            })
             // 资讯分类是博客的时候，显示博客分类
             form.on('radio(type)', function(data) {
              if(data.value == 2) {
                let html_str = `
                <label for="category" class="layui-form-label">
                  博客分类
                </label>
                <div class="layui-input-inline">
                  <input
                    type="text"
                    name="category"
                    id="category"
                    lay-verify=""
                    placeholder="请输入博客分类名称"
                    autocomplete="off"
                    class="layui-input"
                  />
                </div> 
                `
                $('.category').html(html_str);
                $('.category').css('display','block')
              } else {
                $('.category').html('');
                $('.category').css('display','none')
              }
            })

            //监听提交
            form.on("submit(add)", function (data) {
              let formdata = new FormData();
              formdata.append("numRandom", Math.ceil(Math.random() * 100000));
              for (const key in data.field) {
                // if(data.field["tag"] !== "zh") {
                //   data.field["type"] = -1;
                // }
                formdata.append(key, data.field[key]);
              }

              formdata.set(
                "newsTime",
                data.field["tag"] === "zh"
                  ? new Date(data.field["newsTime"]).format("yyyy年MM月dd日")
                  : data.field["newsTime"]
              );

              formdata.set(
                "newsDetail",
                htmlEncode(
                  editor.txt.html().replace(/<a/g, '<a target="_blank"')
                )
              );

              formdata.set(
                "type",
                Number(data.field.type)
              );

              if (initData && JSON.parse(initData).id) {
                //是否有id
                formdata.append("id", JSON.parse(initData).id);
              }

              layui.$.ajax({
                type: "post",
                url:
                  initData && JSON.parse(initData).id
                    ? "/source/updateNews"
                    : "/source/insertNews",
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      "保存成功",
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            layui.$("#newsImagePreview").on("click", function () {
              let formValues = form.val("newsForm");
              sessionStorage.setItem(
                "previewData",
                JSON.stringify({
                  ...formValues,
                  newsDetail: htmlDecode(editor.txt.html()),
                })
              );
              let ref = window.open("./preview.html");
            });
            layui.$("#newsAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
            });

            //文件上传
            //拖拽上传
            upload.render({
              elem: "#newsImage",
              url: "/source/uploadFile", //改成您自己的上传接口
              field: "uploadFile",
              done: function (res) {
                layer.msg("上传成功");
                let url =
                  res.url.startsWith("/") ||
                  res.url.startsWith("https://") ||
                  res.url.startsWith("http://")
                    ? res.url
                    : res.url.startsWith("1")
                    ? "http://" + res.url
                    : "https://" + res.url;
                layui
                  .$("#uploadNewsImageView")
                  .removeClass("layui-hide")
                  .find("img")
                  .attr("src", url);
                $(".layui-upload-text, .layui-upload-icon").css({
                  display: "none",
                });
                $("#newsImageValue")[0].value = res.url;
              },
            });

            var E = window.wangEditor;
            var editor = new E("#editor");
            // 配置服务器端地址(上传图片部分)
            editor.config.uploadImgServer = "/source/uploadFile?tag=zh";
            editor.config.uploadFileName = "uploadFile";
            editor.config.uploadImgHooks = {
              success: function (xhr, editor, result) {
                console.log(result, 11);
              },
              fail: function (xhr, editor, result) {
                console.log(result, 22);
              },
              customInsert: function (insertImg, result, editor) {
                let url =
                  result.url.startsWith("/") ||
                  result.url.startsWith("https://") ||
                  result.url.startsWith("http://")
                    ? result.url
                    : result.url.startsWith("1")
                    ? "http://" + result.url
                    : "https://" + result.url;
                insertImg(url);
              },
            };
            editor.config.uploadImgMaxSize = 10 * 1024 * 1024;
            editor.create();
            editor.txt.html("");
          }
        );
      };
    </script>
  </body>
</html>
