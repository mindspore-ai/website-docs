<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>资讯管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .search-box{
        display: flex;
      }
      .layui-inline {
        width: 400px;
      }
      .search-box {
        display: flex;
      }
      .buttom-group {
        margin-left: 20px;
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <div class="search-box">
        <form class="layui-form" lay-filter="paperForm">
          <div class="layui-input-inline">
            <input type="radio" name="lang" value="zh" title="中文" checked="" lay-filter='lang' />
            <input type="radio" name="lang" value="en" title="英语" lay-filter='lang' />
          </div>
          <div class="layui-inline">
            <select name="city" lay-verify="" id="type">
              <option value="0">全部</option>
              <option value="1">版本发布</option>
              <option value="2">技术博客</option>
              <option value="4">每日新闻</option>
              <option value="3">活动公告</option>
            </select>
          </div>
          <div class="layui-inline">
            <input class="layui-input" name="searchId" id="search" autocomplete="off" placeholder="输入标题关键词进行搜索">
          </div>  
        </form>
        <div class="buttom-group">
          <button class="layui-btn name-search">搜索</button>
          <button class="layui-btn name-reset">重置</button>
        </div>
      </div>   
      <table class="layui-hide" id="newsTable" lay-filter="newsTable"></table>

      <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加资讯</button>
        </div>
      </script>
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="publish">发布</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
    </div>
    <script src="../../layui/layui.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["jquery", "weadmin", "table","form"], function () {
          var $ = layui.jquery,
            weadmin = layui.weadmin,
            table = layui.table;
          let form=layui.form
          let tableInstance = table.render({
            elem: "#newsTable",
            url: "/source/selectNews",
            request: {
              pageName: "pageCurrent",
              limitName: "limit",
            },
            where: {
            },
            parseData: function (res) {
              if(res.totalNum==null){
                return {
                code: 0, //解析接口状态
                msg: "没有搜索到数据", //解析提示文本
                count: 0 //解析数据长度
                }
              }
              let transformData = res.records.map((newsRow, index) => {
                newsRow.statusText = newsRow.status === 1 ? "已发布" : "未发布";
                return newsRow;
              });
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.totalNum.totalNum, //解析数据长度
                data: transformData, //解析数据列表
              };
            },
            toolbar: "#toolbar",
            title: "资讯表",
            cols: [
              [
                { type: "checkbox", fixed: "left" },
                {
                  field: "id",
                  title: "ID",
                  fixed: "left",
                },
                { field: "newsTitle", title: "资讯标题" },
                { field: "newsContent", title: "资讯摘要" },
                { field: "tag", title: "语言" },
                { field: "newsTime", title: "资讯时间" },
                {
                  field: "statusText",
                  title: "状态",
                  templet: function (d) {
                    if (d.status === 1) {
                      return d.statusText;
                    } else {
                      return (
                        '<span style="color: red;">' + d.statusText + "</span>"
                      );
                    }
                  },
                },
                {
                  fixed: "right",
                  title: "操作",
                  toolbar: "#barDemo",
                },
              ],
            ],
            page: true,
          });

          //工具栏事件
          table.on("toolbar(newsTable)", function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let data = checkStatus.data;
            switch (obj.event) {
              case "mutiDelete":
                if (data.length > 0) {
                  let index = layer.confirm(
                    "您确定要删除已选的资讯吗？",
                    {
                      btn: ["确定", "取消"], //按钮
                    },
                    function () {
                      let ids = data.map((rowData, index) => {
                        return rowData.id;
                      });
                      $.ajax({
                        type: "get",
                        url: "/source/deleteNews?ids=" + ids,
                        success: function (response) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        },
                        error: function (err) {
                          layer.alert("删除失败:" + err, { icon: 5 });
                        },
                      });
                    },
                    function () {
                      layer.close(index);
                    }
                  );
                } else {
                  layer.alert("请选择您要删除的资讯", { icon: 5 });
                }
                break;
              case "add":
                WeAdminShow("资讯添加", "./add.html");
                break;
              default:
                break;
            }
          });

          //监听行单击事件
          table.on("tool(newsTable)", function (obj) {
            switch (obj.event) {
              case "edit":
                WeAdminEdit("资讯编辑", "./add.html", JSON.stringify(obj.data));
                break;
              case "publish":
                if (obj.data.status === 1) {
                  layer.alert("该条资讯已经发布过啦！！", { icon: 5 });
                  return;
                }
                let index = layer.confirm(
                  "您确定要发布这条资讯吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/releaseNews?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "发布成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("发布失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
                break;
              case "del":
                let index1 = layer.confirm(
                  "您确定要删除这条资讯吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/deleteNews?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "删除成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        console.log("删除失败");
                      },
                    });
                  },
                  function () {
                    layer.close(index1);
                  }
                );
                break;
              default:
                break;
            }
          });

          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
            switch (event.data.messageType) {
              case "reloadTable":
                tableInstance.reload();
                break;
              default:
                break;
            }
          }
        // let lang = $('.layui-input-inline input[name="lang"]:checked').val();
          let lang = 'zh';

			// 监听语言切换，更换领域和来源数据
			form.on('radio(lang)', function(data) {
				lang = data.value;
				
			});
          // 搜索
        $('.name-search').on("click", function (e) {
          let newsTitle = $('#search')[0].value;
          let type = $('#type')[0].value;
          if (type === 0 && newTitle == '') {
            return
          } 
          tableInstance.reload({
            where: {
              "type": type,
              "newsTitle": newsTitle,
              'tag': lang
            },
            page: {
              curr: 1
            }
          });
        });

        // 重置
        $('.name-reset').on("click", function (e) {
          $('#search')[0].value=''
          $('#type')[0].value=0
          form.render()
          tableInstance.reload({
            where: {
              "type": 0,
              "newsTitle": '',
            },
            page: {
              curr: 1
            }
          });
        });

        });
      };
    </script>
  </body>
</html>
