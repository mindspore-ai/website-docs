<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>论文管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="newsForm">
        <div class="layui-form-item">
          <label for="lang" class="layui-form-label">
            <span class="we-red">*</span>页面语言
          </label>
          <div class="layui-input-block">
            <input type="radio" name="lang" value="zh" title="中文" checked="" lay-filter='lang' />
            <input type="radio" name="lang" value="en" title="英语" lay-filter='lang' />
          </div>
        </div>     
        <div class="layui-form-item">
          <label for="mindspore" class="layui-form-label">
            <span class="we-red">*</span>MindSpore首发
          </label>
          <div class="layui-input-block">
            <input type="radio" name="mindspore" value="1" title="是" checked="" />
            <input type="radio" name="mindspore" value="0" title="否" />
          </div>
        </div>   
        <div class="layui-form-item">
          <label for="title" class="layui-form-label">
            <span class="we-red">*</span>论文标题
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="title"
              name="title"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="summary" class="layui-form-label">
            <span class="we-red">*</span>论文摘要
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="summary"
              name="summary"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="domain" class="layui-form-label">
            <span class="we-red">*</span>领域
          </label>
          <div class="layui-input-inline">
            <select name="domain" lay-verify="required" id="domain">
				<option value="">请选择领域</option>
			</select>
          </div>
        </div> 
        <div class="layui-form-item">
          <label for="sources" class="layui-form-label" >
            <span class="we-red">*</span>来源
          </label>
          <div class="layui-input-inline">
            <select name="sources" lay-verify="required" id="source">
				      <option value="">请选择来源</option>
			      </select>
          </div>
        </div> 
        <div class="layui-form-item">
          <label for="publishedBy" class="layui-form-label">
            <span class="we-red">*</span>发表单位
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="publishedBy"
              name="publishedBy"
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div> 
        <div class="layui-form-item">
          <label for="postedOn" class="layui-form-label">
            <span class="we-red">*</span>发表时间
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              name="postedOn"
              id="postedOn"
              lay-verify="date"
              placeholder="yyyy-MM-dd"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="link" class="layui-form-label">
            <span class="we-red">*</span>论文链接
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="link"
              name="link"
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="codeLink" class="layui-form-label">
            代码链接
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="codeLink"
              name="codeLink"
              lay-verify=""
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
                
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" id="newsImagePreview">
            预览
          </button>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="newsAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(
          ["form", "weadmin", "jquery", "laydate", "upload", "layer"],
          function () {
            var form = layui.form,
              weadmin = layui.weadmin,
              $ = layui.jquery,
              upload = layui.upload,
              laydate = layui.laydate;
            layer = layui.layer;

            laydate.render({
              elem: "#postedOn",
            });

            //自定义验证规则
            form.verify({});

            function getCatagoryList(lang) {
        		layui.$.ajax({
            		type: 'get',
            		url: '/DissertationCategory/list?lang=' + lang,
            		success: function (res) {
            		    try {
            			    if(res.obj) {
								if(res.obj.domain.length > 0) {
									let domainHtml = '<option value="">请选择领域</option>';
									res.obj.domain.forEach((item, index) => {
										domainHtml = domainHtml + `	<option value="${item.id}">${item.title}</option>`
									})
									$('#domain').html(domainHtml);
								}
								if(res.obj.source.length > 0) {
									res.obj.source.forEach((item, index) => {
										let sourceHtml = '<option value="">请选择来源</option>';
										res.obj.source.forEach((item, index) => {
											sourceHtml = sourceHtml + `	<option value="${item.id}">${item.title}</option>`
										})
										$('#source').html(sourceHtml);
									})
								}
								let initData = document.getElementById("pData").value;
            					if (initData) {
									let initDataJson = JSON.parse(initData);
									form.val("newsForm", {
              						  	domain: initDataJson.domain,
              						  	sources: initDataJson.sources
              						});
								}
								form.render();
							}
            			} catch (error) {
							console.log(error)
						}
            		},
            		error: function (err) {
            		    console.log(err);
            		},
				});
			}
			let lang = 'zh';

			// 监听语言切换，更换领域和来源数据
			form.on('radio(lang)', function(data) {
				lang = data.value;
				getCatagoryList(data.value);
				setTimeout(function(){
					form.val("newsForm", {
              			domain: '',
              			sources: ''
              		});
				}, 200)
			});

            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if (initData) {
              	let initDataJson = JSON.parse(initData);              
              	let lang = initDataJson.lang === "zh"
              	    ? initDataJson.lang
              	        .replace(/[年月]/g, "-")
              	        .replace(/[日]/, "")
              	    : initDataJson.lang;
				getCatagoryList(initDataJson.lang);
				form.val("newsForm", {
              	  	title: initDataJson.title,
              	  	summary: initDataJson.summary,
              	  	publishedBy: initDataJson.publishedBy,
              	  	lang: lang,
					mindspore: initDataJson.mindspore,
              	  	postedOn: initDataJson.postedOn,
              	  	link: initDataJson.link,
              	  	codeLink: initDataJson.codeLink,
              	});
            } else {
				getCatagoryList(lang); // 新增
			}

            //监听提交
            form.on("submit(add)", function (data) {
              let formdata = new FormData();
              formdata.append("numRandom", Math.ceil(Math.random() * 100000));
              for (const key in data.field) {
                formdata.append(key, data.field[key]);
              }
              formdata.set(
                "postedOn",
                data.field["lang"] === "zh"
                  ? new Date(data.field["postedOn"]).format("yyyy年MM月dd日")
                  : data.field["postedOn"]
              );              

              if (initData && JSON.parse(initData).id) {
                //是否有id
                formdata.append("id", JSON.parse(initData).id);
              }

              layui.$.ajax({
                type: "post",
                url:
                  initData && JSON.parse(initData).id
                    ? "/source/dissertation/update"
                    : "/source/dissertation/add",
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      "保存成功",
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            layui.$("#newsImagePreview").on("click", function () {
              let formValues = form.val("newsForm");
              sessionStorage.setItem(
                "previewData",
                JSON.stringify(formValues)
              );
              let ref = window.open("./preview.html");
            });
            layui.$("#newsAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
            }); 
          }
        );
      };
    </script>
  </body>
</html>
