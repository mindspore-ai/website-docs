<!DOCTYPE html>
<html>
  	<head>
  	  	<meta charset="UTF-8" />
  	  	<title>论文类目管理</title>
  	  	<link rel="stylesheet" href="../../layui/css/layui.css" />
  	  	<link rel="stylesheet" href="../../static/weadmin.css" />
  	  	<style>
  	  	  	.actionBox{
  	  	  	  	display: inline-block;
  	  	  	  	margin-left:50px;
  	  	  	  	position: relative;
  	  	  	  	vertical-align: middle;
  	  	  	}
  	  	  	.actionClass{
  	  	  	  	color: #379BE6;
  	  	  	  	cursor: pointer;
  	  	  	  	display: inline-block;
  	  	  	  	margin: 0 5px;
  	  	  	}
  	  	</style>
  	</head>

  	<body>
  	  	<div class="weadmin-body cases-catagory">
			<div class="layui-tab layui-tab-brief" lay-filter="langTab">
				<ul class="layui-tab-title">
				  	<li class="layui-this">中文论文类目管理</li>
				  	<li>英文论文类目管理</li>
				</ul>
				<div class="layui-tab-content">
				  	<div class="layui-tab-item layui-show">
						<div id="catalogTreeZh" class="demo-tree-more"></div>
				  	</div>
				  	<div class="layui-tab-item">
						<div id="catalogTreeEn" class="demo-tree-more"></div>
				  	</div>
				</div>
			</div>
  	  	</div>
  	  	<script src="../../layui/layui.js"></script>
  	  	<script>
  	  		window.onload = function () {
  	  	    	layui.config({
  	  	    	  	base: "../../static/",
  	  	    	});
  	  	    	layui.use(["jquery", "weadmin",'tree', 'util', 'element'], function () {
  	  	    	  	var $ = layui.jquery;
					var weadmin = layui.weadmin;
					var util = layui.util;
					var tree = layui.tree;
					var element = layui.element;
				
  	        	  	let treeList = [];

            		// 请求树列表数据
            		function getDataList(lang){
						let str1 = '';
						let str2 = '';
						let dropdownList = [
							{id: 'domain', title: '领域', level: 1, field: 'domain', children:[]},
							{id: 'source', title: '来源', level: 1, field: 'source', children:[]},
							{id: 'popular', title: '热门推荐', level: 1, field: 'popular', children:[]}
						];
              			layui.$.ajax({
              			    type: "get",
              			    url: "/DissertationCategory/list?lang=" + lang,
              			    success: function (res) {
              			    	try {
              			    	 	if(res.obj) {
										if(res.obj.domain.length > 0) {
											res.obj.domain.forEach((item, index) => {
												dropdownList[0].children.push({
													id: item.id,
                           							title: item.title,
                           							level: 2,
                           							superId: item.type,
													type: item.type,
                           							field: '',
													lang: item.lang,
													sequence: item.sequence
												})
											})
										}
										if(res.obj.source.length > 0) {
											res.obj.source.forEach((item, index) => {
												dropdownList[1].children.push({
													id: item.id,
                           							title: item.title,
                           							level: 2,
                           							superId: item.type,
													type: item.type,
                           							field: '',
													lang: item.lang,
													sequence: item.sequence
												})
											})
										}
										if(res.obj.popular.length > 0) {
											res.obj.popular.forEach((item, index) => {
												dropdownList[2].children.push({
													id: item.id,
                           							title: item.title,
                           							level: 2,
                           							superId: item.type,
													type: item.type,
                           							field: '',
													link: item.link,
													image: item.image,
													lang: item.lang,
													sequence: item.sequence
												})
											})
										}
                   					}
              			    		treeList = dropdownList;
									if(lang === 'zh') {
										treeInstanceZh.reload({
              			    		  		data: dropdownList,
              			    			});
									} else if(lang === 'en') {
										treeInstanceEn.reload({
              			    		  		data: dropdownList,
              			    			});
									}
									str1 = `
              						    <div class="actionBox">
              						      <span class="actionClass catalog-add" lay-event="catalog-add">新增</span>
              						    </div>
              						`
									str2 = `
              						    <div class="actionBox">
              						      <span class="actionClass catalog-edit" lay-event="catalog-edit">编辑</span>
              						      <span class="actionClass catalog-delete" lay-event="catalog-delete">删除</span>
              							</div>
              						`
              						$('.layui-tree>div>.layui-tree-entry').append(str1);
              						$('.layui-tree>div>div>div>.layui-tree-entry').append(str2);
              			    	} catch (error) {}
              			  	},
              			    error: function (err) {
              			      	console.log(err);
              			    },
              			});
            		}
            		
					// 切换tab
					let lang = 'zh';
					getDataList('zh');
					element.on('tab(langTab)', function(data) {
						if(data.index === 0) {
							getDataList('zh');
							lang = 'zh';
						} else if(data.index === 1) {
							getDataList('en');
							lang = 'en';
						}
					})
					

           			let treeInstanceZh = tree.render({
            		  	elem: '#catalogTreeZh',
            		  	data: [],
            		  	showCheckbox: false , //是否显示复选框
            		  	isJump: false ,//是否允许点击节点时弹出新窗口跳转
            		  	showLine: false,  //是否开启连接线
            		  	id: 'demoId1',
            		  	click: function(obj){
            		  	  	var data = obj.data;  //获取当前点击的节点数据
            		  	}
            		})
           			let treeInstanceEn = tree.render({
            		  	elem: '#catalogTreeEn',
            		  	data: [],
            		  	showCheckbox: false , //是否显示复选框
            		  	isJump: false ,//是否允许点击节点时弹出新窗口跳转
            		  	showLine: false,  //是否开启连接线
            		  	id: 'demoId2',
            		  	click: function(obj){
            		  	  	var data = obj.data;  //获取当前点击的节点数据
            		  	}
            		})

            		//  新增树节点
					function addNode(addId){
						let item = {
							  'type': addId,
							  'lang': lang
						}
						if(addId === 'domain') {
							WeAdminEdit("新增领域", "./domain.html", JSON.stringify(item));
						} else if(addId === 'source') {
							WeAdminEdit("新增来源", "./domain.html", JSON.stringify(item));
						} else if(addId === 'popular') {
							WeAdminEdit("新增热门推荐", "./popular.html", JSON.stringify(item));
						}
					}
            		$('#catalogTreeZh').on('click','.catalog-add',function(event) {
            		  	let myAddId =  $(this).parent().parent().parent().attr('data-id');
						addNode(myAddId);
            		})
            		$('#catalogTreeEn').on('click','.catalog-add',function(event) {
            		  	let myAddId =  $(this).parent().parent().parent().attr('data-id');
						addNode(myAddId);
            		})

            		// 编辑树节点
					function editNode(editId) {
						treeList.forEach((item, index) => {
							if(item.children.length > 0) {
								item.children.forEach((inner_item, inner_index) => {
									if(inner_item.id == editId) {
										if(item.id === 'domain') {
											WeAdminEdit("编辑领域", "./domain.html", JSON.stringify(inner_item));
										} else if(item.id === 'source') {
											WeAdminEdit("编辑来源", "./domain.html", JSON.stringify(inner_item));
										} else if(item.id === 'popular') {
											WeAdminEdit("编辑热门推荐", "./popular.html", JSON.stringify(inner_item));
										}
									}
								}) 
							}
            		  	})
					}
            		$('#catalogTreeZh').on('click','.catalog-edit',function(event) {
            		  	let myEditId =  $(this).parent().parent().parent().attr('data-id');
            		  	editNode(myEditId);
            		})
            		$('#catalogTreeEn').on('click','.catalog-edit',function(event) {
            		  	let myEditId =  $(this).parent().parent().parent().attr('data-id');
            		  	editNode(myEditId);
            		})

             		//  删除树节点
					function deleteNode(deleteId) {
						let index = layer.confirm(
            		      	"您确定要删除" + $(this).parent().prev().text() +"吗？",
            		      	{ btn: ["确定", "取消"] },
            		      	function () {
            		      	    $.ajax({
            		      	      	type: "get",
            		      	      	url: "/source/DissertationCategory/delete?id=" + deleteId,
            		      	      	success: function (response) {
            		      	      	  	if (response.status === 200) {
            		      	      	  	  	let index = layer.alert(
            		      	      	  	  	 	"删除成功",
            		      	      	  	  	 	{ icon: 6 },
            		      	      	  	  	 	function () {
            		      	      	  	  	 	  	layer.close(index);
            		      	      	  	  	 	  	getDataList(lang);
            		      	      	  	  	 	}
            		      	      	  	  	);
            		      	      	  	} else {
            		      	      	  	  	layer.alert(response.msg, { icon: 5 });
            		      	      	  	}
            		      	      	},
            		      	      	error: function (err) {
            		      	      	  	layer.alert("删除失败:" + err, { icon: 5 });
            		      	      	}
            		      	    });
            		      	},
            		      	function () {
            		      	    layer.close(index);
            		      	}
            		    );
					}
            		$('#catalogTreeZh').on('click','.catalog-delete',function(event) {
            		  	let myDeleteId =  $(this).parent().parent().parent().attr('data-id');
            		  	deleteNode(myDeleteId);
            		});
            		$('#catalogTreeEn').on('click','.catalog-delete',function(event) {
            		  	let myDeleteId =  $(this).parent().parent().parent().attr('data-id');
            		  	deleteNode(myDeleteId);
            		});

            		window.addEventListener("message", receiveMessage, false);
            		function receiveMessage(event) {
            		  	switch (event.data.messageType) {
            		  	  	case "reloadTable":
            		  	  	  	getDataList(lang);
            		  	  	  	break;
            		  	  	default:
            		  	  	  	break;
            		  	}
            		}

            	});
      		};
    	</script>
  	</body>
</html>
