<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>论文管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
		.search-box {
			display: flex;
			justify-content: left;
		}
    .search-box .layui-form {
      display: flex;
			justify-content: left;
    }
    .search-box .mindspore {
      width: 250px;
    }
    .search-box .name-search {
      margin-left: 10px;
    }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
     	<div class="search-box">
			<form class="layui-form" lay-filter="paperForm">
				<div class="layui-form-item">
          			<div class="layui-input-inline">
          			  	<input type="radio" name="lang" value="zh" title="中文" checked="" lay-filter='lang' />
          			  	<input type="radio" name="lang" value="en" title="英语" lay-filter='lang' />
          			</div>
					<div class="layui-input-inline mindspore">
						<select name="mindspore" id="mindspore">
							<option value="">请选择是否MindSpore首发</option>
							<option value="1">是</option>
							<option value="0">否</option>
						</select>
					</div>
					<div class="layui-input-inline">
						<select name="domain" lay-verify="required" id="domain">
							<option value="">请选择领域</option>
						</select>
					</div>
					<div class="layui-input-inline">
						<select name="sources" lay-verify="required" id="source">
							<option value="">请选择来源</option>
						</select>
					</div>
				</div>
			</form>
			<button class="layui-btn name-search">搜索</button>
			<button class="layui-btn name-reset">重置</button>
		
     	</div>

     	<table class="layui-hide" id="papersTable" lay-filter="papersTable"></table>

      <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm layui-btn-warm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加论文</button>
        </div>
      </script>
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="publish">发布</a>
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="unpublish">下线</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
    </div>
    <script src="../../layui/layui.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        }).extend({
			cascader: 'cascader/cascader'
		});
        layui.use(["jquery", "weadmin", "table", "form", "cascader"], function () {
          var $ = layui.jquery,
            weadmin = layui.weadmin,
            table = layui.table,
            form = layui.form,
			cascader = layui.cascader;

			// 论文类型
			let categoryIdInit = [];
			function getCatagoryList(lang) {
        		layui.$.ajax({
            		type: 'get',
            		url: '/DissertationCategory/list?lang=' + lang,
            		success: function (res) {
            		    try {
            			    if(res.obj) {
								if(res.obj.domain.length > 0) {
									let domainHtml = '<option value="">请选择领域</option>';
									res.obj.domain.forEach((item, index) => {
										domainHtml = domainHtml + `	<option value="${item.id}">${item.title}</option>`
									})
									$('#domain').html(domainHtml);
								}
								if(res.obj.source.length > 0) {
									res.obj.source.forEach((item, index) => {
										let sourceHtml = '<option value="">请选择来源</option>';
										res.obj.source.forEach((item, index) => {
											sourceHtml = sourceHtml + `	<option value="${item.id}">${item.title}</option>`
										})
										$('#source').html(sourceHtml);
									})
								}
								form.render();
							}
            			} catch (error) {
							console.log(error)
						}
            		},
            		error: function (err) {
            		    console.log(err);
            		},
				});
			}
			let lang = 'zh';
			getCatagoryList(lang);

			// 监听语言切换，更换领域和来源数据
			form.on('radio(lang)', function(data) {
				lang = data.value;
				getCatagoryList(data.value);
				$('#domain')[0].value = '';
				$('#source')[0].value = '';
			});

			// 搜索
			$('.name-search').on("click", function (e) {
            	let mindsporeValue = $('#mindspore')[0].value;
            	let domainId = $('#domain')[0].value;
            	let sourceId = $('#source')[0].value;
            	tableInstance.reload({
            	    where: {
						'domain': domainId == '' ? null : Number(domainId),
          		  		'sources': sourceId == '' ? null :  Number(sourceId),
						'mindspore': mindsporeValue == '' ? null : Number(mindsporeValue),
						'lang': lang
            	    },
            	    page: {
            	      	curr:1
            	    }
            	});
          	});

          	// 重置
          	$('.name-reset').on('click', function (e) {
				$('#mindspore')[0].value = '';
				$('#domain')[0].value = '';
            	$('#source')[0].value = '';
				form.val("paperForm", {
              		lang: 'zh'
              	});
				lang = 'zh';
          	  	form.render()
          	  	tableInstance.reload({
          	  	    where: {
						'domain': null,
          	  			'sources': null,
						'mindspore': null,
						'lang': lang
          	  	    },
          	  	    page: {
          	  	      	curr: 1
          	  	    }
          	  	});
          	});
			  

          let tableInstance = table.render({
            elem: "#papersTable",
            url: "/source/dissertation/list",
			method: 'post',
			contentType: 'application/json',
            request: {
              	pageName: "page",
              	limitName: "pageSize",
            },
			where: {
          	  	'domain': null,
          	  	'sources': null,
				'mindspore': null,
				'lang': lang
          	},
            parseData: function (res) {
              	let transformData = res.records ? res.records.map((newsRow, index) => {
              	  	newsRow.statusText = newsRow.status === 1 ? "已发布" : "未发布";
              	  	newsRow.mindsporeText = newsRow.mindspore === 1 ? "是" : "否";
              	  	return newsRow;
              	}) : null;
              	return {
              	  	code: 0, //解析接口状态
              	  	msg: "", //解析提示文本
              	  	count: res.totalNum ? res.totalNum.totalNum : 0, //解析数据长度
              	  	data: transformData, //解析数据列表
              	};
            },
            toolbar: "#toolbar",
            title: "论文表",
            cols: [[
                { type: "checkbox", fixed: "left" },
                {
                  field: "id",
                  title: "ID",
                  fixed: "left",
                },
                { field: "title", title: "论文标题" },
                { field: "summary", title: "论文摘要" },
                { field: "mindsporeText", title: "是否MindSpore首发" },
                { field: "domainName", title: "领域" },
                { field: "publishedBy", title: "发布单位" },
                { field: "postedOn", title: "发布时间" },
                {
                  field: "statusText",
                  title: "状态",
                  templet: function (d) {
                    if (d.status === 1) {
                      	return d.statusText;
                    } else {
                      	return (
                        	'<span style="color: red;">' + d.statusText + "</span>"
                      	);
                    }
                  },
                },
                {
                  	fixed: "right",
                  	width: 280,
                  	title: "操作",
                  	toolbar: "#barDemo",
                },
            ]],
			page: true
          });

          //工具栏事件
          table.on("toolbar(papersTable)", function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let data = checkStatus.data;
            switch (obj.event) {
              case "mutiDelete":
                if (data.length > 0) {
                  let index = layer.confirm(
                    "您确定要删除已选的论文吗？",
                    {
                      btn: ["确定", "取消"], //按钮
                    },
                    function () {
                      let ids = data.map((rowData, index) => {
                        return rowData.id;
                      });
                      $.ajax({
                        type: "get",
                        url: "/source/dissertation/delete?ids=" + ids,
                        success: function (response) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        },
                        error: function (err) {
                          layer.alert("删除失败:" + err, { icon: 5 });
                        },
                      });
                    },
                    function () {
                      layer.close(index);
                    }
                  );
                } else {
                  layer.alert("请选择您要删除的论文", { icon: 5 });
                }
                break;
              case "add":
               WeAdminShow("论文添加", "./add.html");
                break;
              default:
                break;
            }
          });

          //监听行单击事件
          table.on("tool(papersTable)", function (obj) {
            switch (obj.event) {
              case "edit":
                WeAdminEdit("论文编辑", "./add.html", JSON.stringify(obj.data));
                break;
              case "publish":
                if (obj.data.status === 1) {
                  	layer.alert("该条论文已经发布过啦！！", { icon: 5 });
                  	return;
                }
                let index = layer.confirm(
                  "您确定要发布这条论文吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/dissertation/release/" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "发布成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("发布失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index);
                  }
                );
                break;
              case "unpublish":
                if (obj.data.status === 0) {
                  layer.alert("该条论文已经下线过啦！！", { icon: 5 });
                  return;
                }
                let index2 = layer.confirm(
                  "您确定要下线这条论文吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/dissertation/unrelease/" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "下线成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        layer.alert("下线失败:" + err, { icon: 5 });
                      },
                    });
                  },
                  function () {
                    layer.close(index2);
                  }
                );
                break;
                case "del":
                let index1 = layer.confirm(
                  "您确定要删除这条论文吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/dissertation/delete?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "删除成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        console.log("删除失败");
                      },
                    });
                  },
                  function () {
                    layer.close(index1);
                  }
                );
                break;
              default:
                break;
            }
          });

          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
            switch (event.data.messageType) {
              case "reloadTable":
          	  	tableInstance.reload();
                break;
              default:
                break;
            }
          }
        });
      };
    </script>
  </body>
</html>
