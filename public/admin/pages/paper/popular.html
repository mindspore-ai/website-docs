<!DOCTYPE html>
<html>
  	<head>
  	  	<meta charset="UTF-8" />
  	  	<title>热门推荐</title>
  	  	<link rel="stylesheet" href="../../layui/css/layui.css" />
  	  	<link rel="stylesheet" href="../../static/weadmin.css" />
  	  	<style>
			.layui-upload-drag {
     			padding: 0;
     			display: flex;
     			flex-direction: column;
     			justify-content: center;
     			align-items: center;
     		}
  	  	  	.layui-form-item .layui-input-inline {
  	  	  	  	width: calc(100% - 200px);
  	  	  	}
			.layui-form-label{
				width: 90px;
			}
  	  	</style>
  	</head>

  	<body>
    	<div class="weadmin-body">
    	  	<form class="layui-form" lay-filter="catalogForm">
				<div class="layui-form-item">
					<label for="title" class="layui-form-label">
					  <span class="we-red">*</span>热门推荐名称
					</label>
					<div class="layui-input-inline">
					  <input
						type="text"
						id="title"
						name="title"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					  />
					</div>
				</div> 
				<div class="layui-form-item">
					<label for="link" class="layui-form-label">
					  <span class="we-red">*</span>热门推荐链接
					</label>
					<div class="layui-input-inline">
					  <input
						type="text"
						id="link"
						name="link"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					  />
					</div>
				</div> 
				<div class="layui-form-item" id="image">
					<label for="coverImageValue" class="layui-form-label">
						  <span class="we-red">*</span>热门推荐图片
					</label>
					<div class="layui-input-inline">
						  <input
							type="hidden"
							id="coverImageValue"
							lay-verify="required"
							name="image"
							value=""
						  />
						  <div
							class="layui-upload-drag"
							id="image"
							style="width: 630px; height: 270px;"
						  >
							<i class="layui-icon layui-upload-icon"></i>
							<p class="layui-upload-text">
								请上传长宽尺寸为：630px*270px的热门推荐图片
							</p>
							<div class="layui-hide" id="uploadCoverImageView">
								  <img
									src=""
									alt="上传成功后渲染"
									style="width: 630px; height: 270px;"
								  />
							</div>
						  </div>
					</div>
				</div>
    	  	  	<br />
    	  	  	<div class="layui-form-item">
    	  	  	  	<label class="layui-form-label"></label>
    	  	  	  	<button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
    	  	  	  	<button class="layui-btn" id="AddCancel">取消</button>
    	  	  	</div>
    	  	</form>
    	  	<input style="display: none;" type="text" id="pData" value="" />
    	</div>
    	<script src="../../layui/layui.js"></script>
    	<script src="../../static/tools.js"></script>
		<script>
    		String.prototype.hashCode = function () {
    		  	var hash = 0, i, chr;
    		  	if (this.length === 0) return hash;
    		  	for (i = 0; i < this.length; i++) {
    		  	  	chr = this.charCodeAt(i);
    		  	  	hash = (hash << 5) - hash + chr;
    		  	  	hash |= 0; 
    		  	}
    		  	return hash;
			};
		  
    		window.onload = function () {
    		    layui.config({
    		      	base: '../../static/',
    		    });
    		    layui.use(['form', 'weadmin', 'jquery', 'layer', 'upload'], function () {
    		    	var form = layui.form;
					var weadmin = layui.weadmin;
    		        var $ = layui.jquery;
					var layer = layui.layer;
					var upload = layui.upload;

    		    	//自定义验证规则
    		    	form.verify({
    		        	sequenceNo:[
							/(^$)|^[1-9](\d*)$/,
							'顺序必须为正整数'
    		        	]
    		      	});
				  
    		        // 编辑时回填初始化数据
    		        let initData = document.getElementById("pData").value;
    		        if(initData) {
    		            let initDataJson = JSON.parse(initData);
						if(initDataJson.id) {
							// 图片回填
							let coverImage =
								initDataJson.image.startsWith("http://") ||
								initDataJson.image.startsWith("https://") ||
								initDataJson.image.startsWith("/")
               					? initDataJson.image
               					: initDataJson.image.startsWith("1")
               					? "http://" + initDataJson.image
								: "https://" + initDataJson.image;
								layui
                			.$("#uploadCoverImageView")
                			.removeClass("layui-hide")
                			.find("img")
							.attr("src", coverImage);
							$(".layui-upload-text, .layui-upload-icon").css({
              	 	  			display: "none",
              	 			});

							form.val("catalogForm", {
                    		  	title: initDataJson.title,
                    		  	link: initDataJson.link,
                    		  	image: initDataJson.image,
                    		  	sequence: initDataJson.sequence ? initDataJson.sequence : 999,
                    		});
						}
    		        }

            		//监听提交
            		form.on('submit(add)', function (data) {
            		  	let formdata = new FormData();
            		  	for (const key in data.field) {
							if(key === 'sequence') {
            		      		if(data.field[key] == '' || data.field[key] == null) {
							        formdata.append(key, 999);
							    } else {
							        formdata.append(key, data.field[key]);
							    }
							} else if(key === 'uploadFile'){

							} else {
								formdata.append(key, data.field[key]);
							}
            		    }
						let initDataJson = JSON.parse(initData);
						formdata.append('lang', initDataJson.lang);
						formdata.append('type', initDataJson.type);
						if(initDataJson.id) {
							formdata.append('id', initDataJson.id);
						}
					
            		  	layui.$.ajax({
            		   		type: 'post',
            		   		url: initDataJson.id 
							   	? '/source/DissertationCategory/update'
								: '/source/DissertationCategory/add',
            		   		processData: false,
            		   		contentType: false,
            		   		data: formdata,
            		   		success: function (res) {
            		   		  	if (res.status === 200) {
            		   		  	  	layer.alert(
            		   		  	  	  	'保存成功',
            		   		  	  	  	{
            		   		  	  	  	  icon: 6,
            		   		  	  	  	},
            		   		  	  	  	function () {
            		   		  	  	  	  	window.parent.postMessage(
            		   		  	  	  	  	  	{ messageType: 'reloadTable' },
            		   		  	  	  	  	  	location.origin
            		   		  	  	  	  	);
            		   		  	  	  	  	var index = parent.layer.getFrameIndex(window.name);
            		   		  	  	  	  	parent.layer.close(index);
            		   		  	  	  	}
            		   		  	  	);
            		   		  	}
            		   		},
            		    	error: function (err) {
            		    	  	console.log(err);
            		    	}
            		  	});
            		  	return false;
            		});


					//文件上传
            		//拖拽上传
					upload.render({
           			  	elem: "#image",
           			 	url: "/source/DissertationCategory/uploadFile", //改成您自己的上传接口
           			  	field: "uploadFile",
           			  	done: function (res) {
           			  	 	layer.msg("上传成功");
           			  	 	let url =
           			  	 	  res.url.startsWith("/") ||
           			  	 	  res.url.startsWith("https://") ||
           			  	 	  res.url.startsWith("http://")
           			  	 	    ? res.url
           			  	 	    : res.url.startsWith("1")
           			  	 	    ? "http://" + res.url
           			  	 	    : "https://" + res.url;
           			  	 	layui
           			  	 	  .$("#uploadCoverImageView")
           			  	 	  .removeClass("layui-hide")
           			  	 	  .find("img")
           			  	 	  .attr("src", url);
           			  	 	$(".layui-upload-text, .layui-upload-icon").css({
           			  	 	  	display: "none",
           			  	 	});
           			  	 	$("#coverImageValue")[0].value = res.url;
           			  	}
           			});


            		layui.$('#AddCancel').on('click', function () {
            		  	var index = parent.layer.getFrameIndex(window.name);
            		  	parent.layer.close(index);
            		});
          		});
    		};
    	</script>
	</body>
</html>
