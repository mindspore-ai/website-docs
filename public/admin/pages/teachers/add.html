<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>师资管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
    	.layui-upload-drag {
    	  	padding: 0;
    	  	display: flex;
    	  	flex-direction: column;
    	  	justify-content: center;
    	  	align-items: center;
    	}
    	.layui-form-item .layui-input-inline {
    	  	width: calc(100% - 200px);
    	}
    </style>
</head>

<body>
    <div class="weadmin-body">
      	<form class="layui-form" lay-filter="teachersForm">
        	<div class="layui-form-item">
				<label for="name" class="layui-form-label">
					<span class="we-red">*</span>讲师姓名
				</label>
				<div class="layui-input-inline">
					<input type="text"
						id="name"
						name="name"
						required=""
						lay-verify="required"
						autocomplete="off"
						class="layui-input"
					/>
				</div>
        	</div>
        	<div class="layui-form-item">
        	  	<label for="title" class="layui-form-label">
        	  	  	<span class="we-red">*</span>讲师职称
        	  	</label>
        	  	<div class="layui-input-inline">
        	  	  	<input type="text"
        	  	   		id="title"
        	  	   		name="title"
        	  	   		required=""
        	  	   		lay-verify="required"
        	  	   		autocomplete="off"
						class="layui-input" 
					/>
        	  	</div>
        	</div>
        	<div class="layui-form-item" id="avatarImg">
        	  	<label for="teachersImageValue" class="layui-form-label">
        	  	  	<span class="we-red">*</span>上传头像
        	  	</label>
        	  	<div class="layui-input-inline">
        	  	  	<input
        	  	  	  type="hidden"
        	  	  	  id="teachersImageValue"
        	  	  	  lay-verify="required"
        	  	  	  name="avatarImg"
        	  	  	  value=""
        	  	  	/>
        	  	  	<div class="layui-upload-drag" id="avatarImg" style="width: 110px; height: 110px;">
        	  	  	  	<i class="layui-icon layui-upload-icon"></i>
        	  	  	  	<p class="layui-upload-text">请使用长宽尺寸为110px*110px的图片</p>
        	  	  	  	<div class="layui-hide" id="uploadTeachersImageView">
							<img 
								src=""
        	  	  	  	    	alt="上传成功后渲染"
        	  	  	  	    	style="width: 110px; height: 110px;"
        	  	  	  	  	/>
        	  	  	  	</div>
        	  	  	</div>
        	  	</div>
        	</div>
        	<br />
        	<div class="layui-form-item">
        	  	<label class="layui-form-label"></label>
        	  	<button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
        	  	<button class="layui-btn" id="teachersAddCancel">取消</button>
        	</div>
      	</form>
      	<input style="display: none;" type="text" id="pData" value="" />
	</div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; 
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["form", "weadmin", "jquery", "upload", "layer"], function () {
            var form = layui.form,
            weadmin = layui.weadmin,
            $ = layui.jquery,
            upload = layui.upload,
            layer = layui.layer;

            //自定义验证规则
            form.verify({});
            
            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if (initData) {
              	let initDataJson = JSON.parse(initData);
				// 编辑内层数据
				if(initDataJson.avatarImg) {
					let avatarImg =
              	    initDataJson.avatarImg.startsWith("http://") ||
              	    initDataJson.avatarImg.startsWith("https://") ||
              	    initDataJson.avatarImg.startsWith("/")
              	    ? initDataJson.avatarImg
              	    : initDataJson.avatarImg.startsWith("1")
              	    ? "http://" + initDataJson.avatarImg
              	    : "https://" + initDataJson.avatarImg;
               		layui
               		.$("#uploadTeachersImageView")
               		.removeClass("layui-hide")
               		.find("img")
               		.attr("src", avatarImg);
				}
              
                form.val("teachersForm", {
                  	id: initDataJson.id,
                  	name: initDataJson.name,
                  	title: initDataJson.title,
                  	avatarImg: initDataJson.avatarImg
                });
                $(".layui-upload-text, .layui-upload-icon").css({
                  	display: "none",
                });
              
              	layui.$.ajax({
                	type: "get",
                	url: "/source/latestvideo/getById?id=" + initDataJson.id,
                	success: function (res) {
                	  	try {
                	  	  	form.val("teachersForm", {
                	  	  	  	avatarImg: res.obj.avatarImg
                	  	  	});
                	  	} catch (error) {}
                	},
                	error: function (err) {
                	  	console.log(err);
                	},
              	});
            }

            //监听提交
            form.on("submit(add)", function (data) {
              	let formdata = new FormData();
              	for (const key in data.field) {
              	  	formdata.append(key, data.field[key]);
              	}
              	if (initData && JSON.parse(initData).id) {
              	  	//是否有id
              	  	formdata.append("id", JSON.parse(initData).id);
              	}

              	layui.$.ajax({
                	type: "post",
                	url:  "/source/courseinstructor/add",
                	processData: false,
                	contentType: false,
                	data: formdata,
                	success: function (res) {
                	  	if (res.status === 200) {
                	  	  	layer.alert(
                	  	  	  	"保存成功",
                	  	  	  	{ icon: 6 },
                	  	  	  	function () {
                	  	  	  	  	window.parent.postMessage(
                	  	  	  	  	  	{ messageType: "reloadTable" },
                	  	  	  	  	  	location.origin
                	  	  	  	  	);
                	  	  	  	  	var index = parent.layer.getFrameIndex(window.name);
                	  	  	  	  	parent.layer.close(index);
                	  	  	  	}
                	  	  	);
                	  	}
                	},
                	error: function (err) {
                	  	console.log(err);
                	},
              });
              return false;
            });

            layui.$("#teachersAddCancel").on("click", function () {
              	var index = parent.layer.getFrameIndex(window.name);
              	parent.layer.close(index);
            });

            //文件上传
            //拖拽上传
            upload.render({
              	elem: "#avatarImg",
             	url: "/source/courseinstructor/avatar/uploadFile", //改成您自己的上传接口
              	field: "uploadFile",
              	done: function (res) {
              	  	layer.msg("上传成功");
              	  	let url =
              	  	  res.url.startsWith("/") ||
              	  	  res.url.startsWith("https://") ||
              	  	  res.url.startsWith("http://")
              	  	    ? res.url
              	  	    : res.url.startsWith("1")
              	  	    ? "http://" + res.url
              	  	    : "https://" + res.url;
              	  	layui
              	  	  .$("#uploadTeachersImageView")
              	  	  .removeClass("layui-hide")
              	  	  .find("img")
              	  	  .attr("src", url);
              	  	$(".layui-upload-text, .layui-upload-icon").css({
              	  	  	display: "none",
              	  	});
              	  	$("#teachersImageValue")[0].value = res.url;
              	}
            });
          }
        );
      };
    </script>
  </body>
</html>
