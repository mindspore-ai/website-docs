<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>师资管理</title>
	<link rel="stylesheet" href="../../layui/css/layui.css" />
	<link rel="stylesheet" href="../../static/weadmin.css" />
	<style>
		.layui-inline {
			width:500px;
		}
	</style>
</head>
<body>
<div class="weadmin-body">
    <div class="search-box">
      	<div class="layui-inline">
        	<input class="layui-input" name="searchId" id="search" autocomplete="off" placeholder="请输入讲师姓名进行搜索">
      	</div>
      	<button class="layui-btn name-search">搜索</button>
    </div>
	
    <table class="layui-hide" id="teachersTable" lay-filter="teachersTable"></table>
    <script type="text/html" id="toolbar">
      	<div class="layui-btn-container">
          	<button class="layui-btn layui-btn-sm" lay-event="add">新增师资</button>
      	</div>
    </script>
    <script type="text/html" id="barDemo">
      	<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
      	<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>
</div>
<script src="../../layui/layui.js"></script>
<script>
    window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["jquery", "weadmin", "table", "form"], function () {
          	var $ = layui.jquery;
            weadmin = layui.weadmin;
            table = layui.table;
            form = layui.form;

        	// 搜索
        	$('.name-search').on("click", function (e) {
        	    let nameValue = $('#search')[0].value;
        	    tableInstance.reload({
        	        where: {
        	          	"name": nameValue
        	        },
        	        page: {
        	          	curr:1
        	        }
        	      });
        	}) 

          	let tableInstance = table.render({
           		elem: "#teachersTable",
           		method: 'get',
           		url: "/source/courseinstructor/list",
           		where: {
           		  	"name": ''
           		},
           		request: {
           		  	pageName: "pageCurrent",
           		  	limitName: "limit"
           		},
            	parseData: function (res) {
            	  	let transformData = res.records.map((newsRow, index) => {
            	  	  	return newsRow;
            	  	});
            	  	return {
            	  	  	code: 0, 
            	  	  	msg: "", 
            	  	  	count: res.totalNum.totalNum,
            	  	  	data: transformData,
            	  	};
            	},
            	toolbar: "#toolbar",
            	title: "师资管理表",
           		cols: [[
           		    { type: "checkbox", fixed: "left" },
           		    { field: "id", title: "讲师ID", fixed: "left" },
           		    { field: "name", title: "讲师姓名" },
           		    { field: "title", title: "讲师职称" },
           		    { field: "course", title: "系列名称" },
           		    { fixed: "right", width: 200, title: "操作", toolbar: "#barDemo" },
           		]],
            	page: true
          	});

          	//工具栏事件
          	table.on("toolbar(teachersTable)", function (obj) {
          	  	let checkStatus = table.checkStatus(obj.config.id);
          	  	let data = checkStatus.data;
          	  	switch (obj.event) {
          	  	  	case "add":
          	  	  	  	WeAdminShow("师资添加", "./add.html");
          	  	  	  	break;
          	  	  	default:
          	  	  	  	break;
          	  	}
          	});

         

          	//监听行单击事件
          	table.on("tool(teachersTable)", function (obj) {
          	  switch (obj.event) {
          	    case "edit":
          	      	WeAdminEdit("师资编辑", "./add.html", JSON.stringify(obj.data));
          	      	break;
          	    case "del":
                	let index1 = layer.confirm(
                	  "您确定要删除这条师资吗？",
                	  {
                	    btn: ["确定", "取消"], //按钮
                	  },
                	  function () {
                	    $.ajax({
                	      type: "get",
                	      url: "/source/courseinstructor/delete/?id=" + [obj.data.id],
                	      success: function (response) {
							  if(response.status === 200) {
								let index = layer.alert(
                	         		"删除成功",
                	         		{ icon: 6 },
                	         		function () {
                	         		  layer.close(index);
                	         		  tableInstance.reload();
                	         		}
                	        	);
							  } else {
								layer.alert(response.msg + ":" + response.obj, { icon: 5 });
							  }
                	        
                	      },
                	      error: function (err) {
							layer.alert("删除失败:" + err, { icon: 5 });
                	      },
                	    });
                	  },
                	  function () {
                	    layer.close(index1);
                	  }
                	);
                	break;
          	    default:
          	      	break;
          	  }
          	});

         	window.addEventListener("message", receiveMessage, false);
         		function receiveMessage(event) {
         		  	switch (event.data.messageType) {
         		    	case "reloadTable":
         		    	  	tableInstance.reload();
         		    	  	break;
         		    	default:
         		    	  	break;
         		  	}
         		}
        	});
      };
    </script>
</body>
</html>
