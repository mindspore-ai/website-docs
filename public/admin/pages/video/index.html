<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>视频</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <style>
      .form-item {
        margin-left: 40px;
        font-size: 16px;
        color: #1a1c33;
        display: flex;
        align-items: center;
      }
      .form-container {
        display: flex;
      }
      .form-item-1_2 {
        width: 50%;
      }
      .form-item-1_3 {
        width: 30%;
      }
      .flex_1 {
        flex: 1;
      }
    </style>
  </head>

  <body>
    <!-- <br />
    <div class="form-container">
      <div class="form-item form-item-1_3">
        <button type="button" class="layui-btn subscribe-file-export">
          EXCEL导出
        </button>
      </div>
    </div> -->
    <table class="layui-hide" id="videoTable" lay-filter="videoTable"></table>

    <script type="text/html" id="toolbar">
      <div class="layui-inline">
        <div class="form-item">
            <span>时间范围:</span>
            <div class="layui-inline">
                <input type="text" class="layui-input" style="width:350px;" id="exportTimeRange" />
            </div>
            <button class="layui-btn layui-btn-sm" style="margin-left:5px;" lay-event="export">EXCEL导出</button>
        </div>
      </div>
    </script>
  </body>
  <script src="../../layui/layui.js"></script>
  <script>
    window.onload = function () {
      layui.config({
        base: "../../static/",
      });
      layui.use(["jquery", "table", "laydate"], function () {
        var $ = layui.jquery,
          table = layui.table,
          laydate = layui.laydate;

        laydate.render({
          elem: "#exportTimeRange",
          type: "datetime",
          range: true, //或 range: '~' 来自定义分割字符
          done: function (start, end) {
            console.log(start);
            console.log(end);
          },
        });

        let tableInstance = table.render({
          elem: "#videoTable",
          url: "/source/click/video",
          request: {
            pageName: "current",
            limitName: "limit",
          },
          parseData: function (res) {
            let transformData = res.obj && res.obj.data ? res.obj.data : [];
            let count = res.obj && res.obj.total ? res.obj.total : [];
            let d = transformData.map((item, index) => {
              item.clickFromPages.forEach((counts, i) => {
                let { from, fromCounts } = counts;
                if (from === 1) {
                  item.fromHome = fromCounts;
                  item.type = 'OBS桶';
                } else if (from === 2) {
                  item.fromToturial = fromCounts;
                  item.type = 'OBS桶';
                } else if(from === 3 ) {
                  item.fromCourse = fromCounts;
                  item.type = '后台上传';
                } else if(from === 4) {
                  item.fromCourse = fromCounts;
                  item.type = 'OBS桶';
                }
              });
              return item;
            });
            return {
              code: 0, //解析接口状态
              msg: "", //解析提示文本
              count: count, //解析数据长度
              data: d, //解析数据列表
            };
          },
          toolbar: "#toolbar",
          title: "视频统计表",
          cols: [[
              { field: "name", title: "名称" },
              { field: "type", title: "视频分类" },
              { field: "clicks", title: "总点击数" },
              { field: "clicksByIp", title: "点击人数" },
              { field: "fromHome", title: "来自首页次数" },
              { field: "fromToturial", title: "来自教程次数" },
              { field: "fromCourse", title: "来自课程次数" }
          ]],
          page: true
        });

        //工具栏事件
        table.on("toolbar(videoTable)", function (obj) {
          let checkStatus = table.checkStatus(obj.config.id);
          let data = checkStatus.data;
          switch (obj.event) {
            case "export":
              let timeRange = $("#exportTimeRange")[0].value;
              if (timeRange) {
                let startTimestamp = new Date(
                  timeRange.split(" - ")[0]
                ).getTime();
                let endTimestamp = new Date(
                  timeRange.split(" - ")[1]
                ).getTime();
                window.open(
                  "/source/export/clickvideo?begin=" +
                    startTimestamp +
                    "&end=" +
                    endTimestamp,
                  "_blank"
                ).location;
              } else {
                alert("请选择时间范围");
              }
              break;
            default:
              break;
          }
        });
      });
    };
  </script>
</html>
