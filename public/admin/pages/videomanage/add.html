<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>视频管理-添加</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
    <style>
      .layui-upload-drag {
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .layui-form-item .layui-input-inline {
        width: calc(100% - 200px);
      }
    </style>
  </head>

  <body>
    <div class="weadmin-body">
      <form class="layui-form" lay-filter="videoForm">
        <div class="layui-form-item">
          <label for="title" class="layui-form-label">
            <span class="we-red">*</span>视频标题
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="title"
              name="title"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="link" class="layui-form-label">
            <span class="we-red">*</span>视频链接
          </label>
          <div class="layui-input-inline">
            <input
              type="text"
              id="link"
              name="link"
              required=""
              lay-verify="required"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <label for="lang" class="layui-form-label">
            <span class="we-red">*</span>视频语言
          </label>
          <div class="layui-input-block">
            <input type="radio" lay-filter='lang' name="lang" value="zh" title="中文" checked="" />
            <input type="radio" lay-filter='lang' name="lang" value="en" title="英语" />
          </div>
        </div>
        <div class="layui-form-item" id="supercode">
          
        </div>
        <div class="layui-form-item">
          <label for="sort" class="layui-form-label">
            <span class="we-red">*</span>视频顺序
          </label>
          <div class="layui-input-block">
            <input type="radio" name="sort" value="1" title="1" checked="" />
            <input type="radio" name="sort" value="2" title="2" />
            <input type="radio" name="sort" value="3" title="3" />
          </div>
        </div>
        <div class="layui-form-item" id="codeImage">
          <label for="videoImageValue" class="layui-form-label">
            <span class="we-red">*</span>视频海报
          </label>

          <div class="layui-input-inline">
            <input
              type="hidden"
              id="videoImageValue"
              lay-verify="required"
              name="image"
              value=""
            />
            <div
              class="layui-upload-drag"
              id="image"
              style="width: 360px; height: 180px;"
            >
              <i class="layui-icon layui-upload-icon"></i>
              <p class="layui-upload-text">
                请使用长宽尺寸为360px*180px的图片封面
              </p>
              <div class="layui-hide" id="uploadVideoImageView">
                <img
                  src=""
                  alt="上传成功后渲染"
                  style="width: 360px; height: 180px;"
                />
              </div>
            </div>
          </div>
        </div>
        <br />
        <div class="layui-form-item">
          <label class="layui-form-label"></label>
          <button class="layui-btn" lay-filter="add" lay-submit="">保存</button>
          <button class="layui-btn" id="videoAddCancel">取消</button>
        </div>
      </form>
      <input style="display: none;" type="text" id="pData" value="" />
    </div>
    <script src="../../layui/layui.js"></script>
    <script src="../../static/wangEditor.js"></script>
    <script src="../../static/tools.js"></script>
    <script>
      String.prototype.hashCode = function () {
        var hash = 0,
          i,
          chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr = this.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(
          ["form", "weadmin", "jquery", "upload", "layer"],
          function () {
            var form = layui.form,
              weadmin = layui.weadmin,
              $ = layui.jquery,
              upload = layui.upload,
              layer = layui.layer;

            //自定义验证规则
            form.verify({});

            // 视频分类函数
            let supercodeOption = function(lang) {
              layui.$.ajax({
                type: 'get',
                url: '/latestvideo/list?lang=' + lang,
                success: function (res) {
                  let supercodeHTML = '';
                  $('#supercode').html('');
                  res.obj.map((item,index) => {
                    if(item.code) {
                      if(index === 0){
                        supercodeHTML += `<input type="radio" value=${item.code} title=${item.title} name="supercode" checked= "" />`;
                      } else {
                        supercodeHTML += `<input type="radio" value=${item.code} title=${item.title} name="supercode" />`;
                      }
                    }
                  })
                  let str = `<label for="supercode" class="layui-form-label">
                              <span class="we-red">*</span>视频分类
                            </label>
                            <div class="layui-input-block" >` + supercodeHTML + `</div>`;
                  $('#supercode').append(str);
                  form.render();
                },
                error: function (err) {
                  console.log(err);
                }
              })
            }
            
            //编辑时有初始化
            let initData = document.getElementById("pData").value;
            if(!initData) {
              supercodeOption('zh');
            }
            if (initData) {
              let initDataJson = JSON.parse(initData);
              // 编辑内层数据
              if(initDataJson.supercode){
                // 动态获取视频分类的选项
                layui.$.ajax({
                  type: 'get',
                  url: '/latestvideo/list?lang=' + initDataJson.lang,
                  success: function (res) {
                    let supercodeHTML = '';
                    $('#supercode').html('');
                    res.obj.map((item,index) => {
                      if(item.code) {
                        if(item.code === initDataJson.supercode){
                          supercodeHTML += `<input type="radio" value=${item.code} title=${item.title} name="supercode" checked= "" />`;
                        } else {
                          supercodeHTML += `<input type="radio" value=${item.code} title=${item.title} name="supercode" />`;
                        }
                      }
                    })
                    let str = `<label for="supercode" class="layui-form-label">
                                <span class="we-red">*</span>视频分类
                              </label>
                              <div class="layui-input-block" >` + supercodeHTML + `</div>`;
                    $('#supercode').append(str);
                    form.render();
                  },
                  error: function (err) {
                    console.log(err);
                  }
                })
                let image =
                  initDataJson.image.startsWith("http://") ||
                  initDataJson.image.startsWith("https://") ||
                  initDataJson.image.startsWith("/")
                    ? initDataJson.image
                    : initDataJson.image.startsWith("1")
                    ? "http://" + initDataJson.image
                    : "https://" + initDataJson.image;
                layui
                  .$("#uploadVideoImageView")
                  .removeClass("layui-hide")
                  .find("img")
                  .attr("src", image);
                form.val("videoForm", {
                  title: initDataJson.title,
                  link: initDataJson.link,
                  image: initDataJson.image,
                  lang: initDataJson.lang,
                  supercode: initDataJson.supercode,
                  sort:initDataJson.sort
                });
                $(".layui-upload-text, .layui-upload-icon").css({
                  display: "none",
                });
              }
             
              // 编辑外层数据
              if(initDataJson.code) {
                layui .$("#supercode").remove();
                layui .$("#codeImage").remove();
                form.render();
                form.val("videoForm", {
                  id: initDataJson.id,
                  title: initDataJson.title,
                  link: initDataJson.link,
                  lang: initDataJson.lang,
                  sort:initDataJson.sort
                });
              }
              
              layui.$.ajax({
                type: "get",
                url: "/source/latestvideo/getById?id=" + initDataJson.id,
                success: function (res) {
                  try {
                    form.val("videoForm", {
                      lang: res.obj.lang,
                      image: res.obj.image
                    });
                  } catch (error) {}
                },
                error: function (err) {
                  console.log(err);
                },
              });
            }

            // 视频分类---监听语言单选框，动态控制视频分类选项
            form.on("radio(lang)", function(data){
              supercodeOption(data.elem.value);
            })

            //监听提交
            form.on("submit(add)", function (data) {
              let formdata = new FormData();
              formdata.append("numRandom", Math.ceil(Math.random() * 100000));
              for (const key in data.field) {
                // B站的视频网址打开的是网页模式，需要复制B站分享的嵌入代码,并前拼接https,后拼接&high_quality=1
                if(data.field['link'].indexOf('iframe') !== -1){
                  let srcStr = data.field['link'];
                  let newLink =  srcStr.match(/\/\/[^"'\s]*/);
                  data.field['link'] = 'https:' + newLink[0] + '&high_quality=1'
                }
                formdata.append(key, data.field[key]);
              }
              
              if (initData && JSON.parse(initData).id) {
                //是否有id
                formdata.append("id", JSON.parse(initData).id);
              }

              layui.$.ajax({
                type: "post",
                url:
                  initData && JSON.parse(initData).id
                    ? "/source/latestvideo/update"
                    : "/source/latestvideo/insert",
                processData: false,
                contentType: false,
                data: formdata,
                success: function (res) {
                  if (res.status === 200) {
                    layer.alert(
                      "保存成功",
                      {
                        icon: 6,
                      },
                      function () {
                        window.parent.postMessage(
                          { messageType: "reloadTable" },
                          location.origin
                        );
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                      }
                    );
                  }
                },
                error: function (err) {
                  console.log(err);
                },
              });
              return false;
            });

            layui.$("#videoAddCancel").on("click", function () {
              var index = parent.layer.getFrameIndex(window.name);
              parent.layer.close(index);
            });

            //文件上传
            //拖拽上传
            upload.render({
              elem: "#image",
              url: "/source/latestvideo/uploadFile", //改成您自己的上传接口
              field: "uploadFile",
              done: function (res) {
                layer.msg("上传成功");
                let url =
                  res.url.startsWith("/") ||
                  res.url.startsWith("https://") ||
                  res.url.startsWith("http://")
                    ? res.url
                    : res.url.startsWith("1")
                    ? "http://" + res.url
                    : "https://" + res.url;
                layui
                  .$("#uploadVideoImageView")
                  .removeClass("layui-hide")
                  .find("img")
                  .attr("src", url);
                $(".layui-upload-text, .layui-upload-icon").css({
                  display: "none",
                });
                $("#videoImageValue")[0].value = res.url;
              },
            });

            var E = window.wangEditor;
            var editor = new E("#editor");
            // 配置服务器端地址(上传图片部分)
            editor.config.uploadImgServer = "/source/latestvideo/uploadFile?lang=zh";
            editor.config.uploadFileName = "uploadFile";
            editor.config.uploadImgHooks = {
              success: function (xhr, editor, result) {
                console.log(result, 11);
              },
              fail: function (xhr, editor, result) {
                console.log(result, 22);
              },
              customInsert: function (insertImg, result, editor) {
                let url =
                  result.url.startsWith("/") ||
                  result.url.startsWith("https://") ||
                  result.url.startsWith("http://")
                    ? result.url
                    : result.url.startsWith("1")
                    ? "http://" + result.url
                    : "https://" + result.url;
                insertImg(url);
              },
            };
            editor.config.uploadImgMaxSize = 10 * 1024 * 1024;
            editor.create();
            editor.txt.html("");
          }
        );
      };
    </script>
  </body>
</html>
