<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>视频管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css" />
    <link rel="stylesheet" href="../../static/weadmin.css" />
  </head>

  <body>
    <div class="weadmin-body">
      <table class="layui-hide" id="videoTable" lay-filter="videoTable"></table>

      <script type="text/html" id="toolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="mutiDelete">批量删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="add">添加视频</button>
        </div>
      </script>
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>
    </div>
    <script src="../../layui/layui.js"></script>
    <script>
      window.onload = function () {
        layui.config({
          base: "../../static/",
        });
        layui.use(["jquery", "weadmin", "table", "form"], function () {
          var $ = layui.jquery,
            weadmin = layui.weadmin,
            table = layui.table,
            form = layui.form;

          let tableInstance = table.render({
            elem: "#videoTable",
            url: "/source/latestvideo/list",
            request: {
              pageName: "pageCurrent",
              limitName: "limit",
            },
            parseData: function (res) {
              let transformData = res.records.map((newsRow, index) => {
                return newsRow;
              });
              return {
                code: 0, //解析接口状态
                msg: "", //解析提示文本
                count: res.totalNum.totalNum, //解析数据长度
                data: transformData, //数据列表
              };
            },
            toolbar: "#toolbar",
            title: "视频表",
            cols: [[ // 表头
                { type: "checkbox", fixed: "left" },
                { field: "id", title: "ID", fixed: "left"},
                { field: "title", title: "视频标题" },
                { field: "link", title: "视频链接" },
                { field: "lang", title: "语言" },
                { field: "sort", title: "视频顺序" },
                { fixed: "right", title: "操作", toolbar: "#barDemo"},
            ]],
            page: true,
            done:function (res, curr, count) {
                var state = "";
                for (let i in res.data) {
                  let item = res.data[i];
                  if(item.code){
                    $('tr[data-index='+ i +'] .layui-btn-danger')
                      .removeClass('layui-btn-danger')
                      .addClass('layui-btn-disabled');
                    $('tr[data-index='+ i +'] input[type="checkbox"]').prop('disabled', true);
                    $('tr[data-index='+ i +'] .layui-form-checkbox').addClass('layui-btn-disabled');
                    $('tr[data-index='+ i +'] .layui-form-checkbox i' ).css({ 'background-color':'#e6e6e6', 'color':'#e6e6e6' });
                    $('tr[data-index='+ i +'] .layui-form-checkbox[lay-skin="primary"]' ).hover(
                      function(){
                        $(this).children().css('border-color','#d2d2d2');
                      }
                    )
                    state = "1";// 隐藏表头全选判断状态
                  }
                  if (state === "1") {
                    // 根据条件移除全选 checkboxfi
                    $('th[data-field='+ 0 +'] input[type="checkbox"]').prop('disabled', true);
                    $('th[data-field='+ 0 +'] .layui-form-checkbox').addClass('layui-btn-disabled');
                    $('th[data-field='+ 0 +'] .layui-form-checkbox i').css({ 'background-color':'#e6e6e6', 'color':'#e6e6e6' });
                    $('th[data-field='+ 0 +'] .layui-form-checkbox[lay-skin="primary"]' ).hover(
                      function(){
                        $(this).children().css('border-color','#d2d2d2');
                      }
                    )
                  } else {
                    // 翻译显示全选按钮 checkbox
                    $('th[data-field='+ 0 +'] input[type="checkbox"]').prop('disabled', false);
                    $('th[data-field='+ 0 +'] .layui-form-checkbox').removeClass('layui-btn-disabled');
                    $('th[data-field='+ 0 +'] .layui-form-checkbox i').css({ 'background-color':'#fff', 'color':'#fff' });
                    $('th[data-field='+ 0 +'] .layui-form-checkbox[lay-skin="primary"]' ).hover(
                      function(){
                        $(this).children().css('border-color','#5FB878');
                      }
                    )
                  }
                  table.render(); // 重新渲染一下
                }
            }
          });

          //工具栏事件
          table.on("toolbar(videoTable)", function (obj) {
            let checkStatus = table.checkStatus(obj.config.id);
            let data = checkStatus.data;
            switch (obj.event) {
              case "mutiDelete":
                if (data.length > 0) {
                  let index = layer.confirm(
                    "您确定要删除已选的视频吗？",
                    {
                      btn: ["确定", "取消"], //按钮
                    },
                    function () {
                      let ids = data.map((rowData, index) => {
                        return rowData.id;
                      });
                      $.ajax({
                        type: "get",
                        url: "/source/latestvideo/delete?ids=" + ids,
                        success: function (response) {
                          let index = layer.alert(
                            "删除成功",
                            { icon: 6 },
                            function () {
                              layer.close(index);
                              tableInstance.reload();
                            }
                          );
                        },
                        error: function (err) {
                          layer.alert("删除失败:" + err, { icon: 5 });
                        },
                      });
                    },
                    function () {
                      layer.close(index);
                    }
                  );
                } else {
                  layer.alert("请选择您要删除的视频", { icon: 5 });
                }
                break;
              case "add":
                WeAdminShow("视频添加", "./add.html");
                break;
              default:
                break;
            }
          });

          //监听行单击事件
          table.on("tool(videoTable)", function (obj) {
            switch (obj.event) {
              case "edit":
                WeAdminEdit("视频编辑", "./add.html", JSON.stringify(obj.data));
                break;
              case "del":
                let index1 = layer.confirm(
                  "您确定要删除这条视频吗？",
                  {
                    btn: ["确定", "取消"], //按钮
                  },
                  function () {
                    $.ajax({
                      type: "get",
                      url: "/source/latestvideo/delete?ids=" + [obj.data.id],
                      success: function (response) {
                        let index = layer.alert(
                          "删除成功",
                          { icon: 6 },
                          function () {
                            layer.close(index);
                            tableInstance.reload();
                          }
                        );
                      },
                      error: function (err) {
                        console.log("删除失败");
                      },
                    });
                  },
                  function () {
                    layer.close(index1);
                  }
                );
                break;
              default:
                break;
            }
          });

          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
            switch (event.data.messageType) {
              case "reloadTable":
                tableInstance.reload();
                break;
              default:
                break;
            }
          }
        });
      };
    </script>
  </body>
</html>
