<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Constructing MindSpore Network &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script>
      
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script><script src="../../_static/jquery.js"></script>
        <script src="../../_static/js/theme.js"></script><script src="../../_static/underscore.js"></script><script src="../../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Constructing Dataset" href="dataset.html" />
    <link rel="prev" title="Model Analysis and Preparation" href="../analysis_and_preparation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../design/overview.html">MindSpore Design Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/programming_paradigm.html">Programming Paradigm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/auto_gradient.html">Functional Differential Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/mindir.html">MindSpore IR (MindIR)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/all_scenarios.html">Full-scenarios Unification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/dynamic_graph_and_static_graph.html">Combination of Dynamic and Static Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/pluggable_device.html">Third-Party Hardware Interconnection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/distributed_training_design.html">Distributed Training Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/graph_fusion_engine.html">Graph-Kernel Fusion Acceleration Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/data_engine.html">High Performance Data Processing Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../note/official_models.html">Official Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../note/api_mapping/pytorch_api_mapping.html">PyTorch and MindSpore API Mapping Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../note/api_mapping/tensorflow_api_mapping.html">TensorFlow and MindSpore API Mapping Table</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Migration Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview of Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../enveriment_preparation.html">Environment Preparation and Information Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis_and_preparation.html">Model Analysis and Preparation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Constructing MindSpore Network</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dataset.html">Constructing Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_and_cell.html">Network Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="learning_rate_and_optimizer.html">Learning Rate and Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="gradient.html">Gradient Derivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_and_evaluation_procession.html">Inference and Training Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../debug_and_tune.html">Debugging and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_code.html">Network Migration Debugging Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Syntax Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../note/static_graph_syntax_support.html">Static Graph Syntax Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../note/index_support.html">Tensor Index Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/implement_problem.html">Implement Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/network_compilation.html">Network Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/operators_compile.html">Operators Compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/usage_migrate_3rd.html">Migration from a Third-party Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/performance_tuning.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/precision_tuning.html">Precision Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/distributed_parallel.html">Distributed Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/feature_advice.html">Feature Advice</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Constructing MindSpore Network</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/migration_guide/model_development/model_development.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="constructing-mindspore-network">
<h1>Constructing MindSpore Network<a class="headerlink" href="#constructing-mindspore-network" title="Permalink to this headline"></a></h1>
<a class="reference external image-reference" href="https://gitee.com/mindspore/docs/blob/r2.0/docs/mindspore/source_en/migration_guide/model_development/model_development.rst"><img alt="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_source_en.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_source_en.png" /></a>
<p>This chapter will introduce the related contents of MindSpore scripting,
including datasets, network models and loss functions, optimizers,
training processes, inference processes from the basic modules needed
for training and inference. It will include some functional techniques
commonly used in network migration, such as network writing
specifications, training and inference process templates, and dynamic
shape mitigation strategies.</p>
<section id="network-training-principle">
<h2>Network Training Principle<a class="headerlink" href="#network-training-principle" title="Permalink to this headline"></a></h2>
<figure class="align-default">
<img alt="train_procession.png" src="../../_images/train_procession.png" />
</figure>
<p>The basic principle of network training is shown in the figure above.</p>
<p>The training process of the whole network consists of 5 modules:</p>
<ul class="simple">
<li><p>dataset: for obtaining data, containing input of network and labels.
MindSpore provides a basic <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/mindspore.dataset.html">common dataset processing
interface</a>,
and also supports constructing datasets by using python iterators.</p></li>
<li><p>network: network model implementation, typically encapsulated by
using Cell. Declare the required modules and operators in init, and
implement graph construction in construct.</p></li>
<li><p>loss: loss function. Used to measure the degree of difference between
the predicted value and the true value. In deep learning, model
training is the process of shrinking the loss function value by
iterating continuously. Defining a good loss function can help the
loss function value converge faster to achieve better precision.
MindSpore provides many <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/mindspore.nn.html#loss-function">common loss
functions</a>,
but of course you can define and implement your own loss function.</p></li>
<li><p>Automatic gradient derivation: Generally, network and loss are
encapsulated together as a forward network and the forward network is
given to the automatic gradient derivation module for gradient
calculation. MindSpore provides an automatic gradient derivation
interface, which shields the user from a large number of derivation
details and procedures and greatly reduces the threshold of
framework. When you need to customize the gradient, MindSpore also
provides
<a class="reference external" href="https://mindspore.cn/tutorials/zh-CN/r2.0/advanced/modules/layer.html#自定义cell反向">interface</a>
to freely implement the gradient calculation.</p></li>
<li><p>Optimizer: used to calculate and update network parameters during
model training. MindSpore provides a number of <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/mindspore.nn.html#optimizer">general-purpose
optimizers</a>
for users to choose, and also supports users to customize the
optimizers.</p></li>
</ul>
</section>
<section id="principles-of-network-inference">
<h2>Principles of Network Inference<a class="headerlink" href="#principles-of-network-inference" title="Permalink to this headline"></a></h2>
<figure class="align-default">
<img alt="evaluation_procession.png" src="../../_images/evaluation_procession.png" />
</figure>
<p>The basic principles of network inference are shown in the figure above.</p>
<p>The training process of the whole network consists of 3 modules:</p>
<ul class="simple">
<li><p>dataset: used to obtain data, including the input of the network and
labels. Since entire inference dataset needs to be inferred during
inference process, batchsize is recommended to set to 1. If batchsize
is not 1, note that when adding batch, add drop_remainder=False. In
addition the inference process is a fixed process. Loading the same
parameters every time has the same inference results, and the
inference process should not have random data augmentation.</p></li>
<li><p>network: network model implementation, generally encapsulated by
using Cell. The network structure during inference is generally the
same as the network structure during training. It should be noted
that Cell is tagged with set_train(False) for inference and
set_train(True) for training, just like PyTorch model.eval() (model
evaluation mode) and model.train() (model training mode).</p></li>
<li><p>metrics: When the training task is over, evaluation metrics (Metrics)
and evaluation functions are used to assess whether the model works
well. Commonly used evaluation metrics include Confusion Matrix,
Accuracy, Precision, and Recall. The mindspore.nn module provides the
common <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/mindspore.train.html#evaluation-metrics">evaluation
functions</a>,
and users can also define their own evaluation metrics as needed.
Customized Metrics functions need to inherit train.Metric parent class
and reimplement the clear method, update method and eval method of
the parent class.</p></li>
</ul>
</section>
<section id="constructing-network">
<h2>Constructing Network<a class="headerlink" href="#constructing-network" title="Permalink to this headline"></a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Constructing Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_and_cell.html">Network Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="learning_rate_and_optimizer.html">Learning Rate and Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="gradient.html">Gradient Derivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="training_and_evaluation_procession.html">Inference and Training Process</a></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When doing network migration, we recommend doing inference validation
of the model as a priority after completing the network scripting.
This has several benefits:</p>
<ul class="simple">
<li><p>Compared with training, the inference process is fixed and able to
be compared with the reference implementation.</p></li>
<li><p>Compared with training, the time required for inference is
relatively short, enabling rapid verification of the correctness
of the network structure and inference process.</p></li>
<li><p>The trained results need to be validated through the inference
process to verify results of the model. It is necessary that the
correctness of the inference be ensured first, then to prove that
the training is valid.</p></li>
</ul>
</div>
</section>
<section id="considerations-for-mindspore-network-authoring">
<h2>Considerations for MindSpore Network Authoring<a class="headerlink" href="#considerations-for-mindspore-network-authoring" title="Permalink to this headline"></a></h2>
<p>During MindSpore network implementation, there are some problem-prone
areas. When you encounter problems, please prioritize troubleshooting
for the following situations:</p>
<ol class="arabic simple">
<li><p>The MindSpore operator is used in data processing.
Multi-threaded/multi-process is usually in the data processing
process, so there is a limitation of using MindSpore operators in
this scenario. It is recommended to use a three-party implemented
operation as an alternative in the data processing process, such as
numpy, opencv, pandas, PIL.</p></li>
<li><p>Control flow. For details, refer to <a class="reference external" href="https://www.mindspore.cn/tutorials/experts/en/r2.0/network/control_flow.html">Flow Control
Statements</a>.
Compilation in graph mode can be slow when multiple layers of
conditional control statements are called.</p></li>
<li><p>Slicing operation. When it comes to slicing a Tensor, note that
whether subscript of the slice is a variable. When it is a variable,
there will be restrictions. Please refer to <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/migration_guide/model_development/model_and_cell.html">network body and loss
building</a>
for dynamic shape mitigation.</p></li>
<li><p>Customized mixed precision conflicts with <code class="docutils literal notranslate"><span class="pre">amp_level</span></code> in Model, so
don’t set <code class="docutils literal notranslate"><span class="pre">amp_level</span></code> in Model if you use customized mixed
precision.</p></li>
<li><p>In Ascend environment, Conv, Sort and TopK can only be float16, and
add <a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r2.0/advanced/mixed_precision.html">loss
scale</a>
to avoid overflow.</p></li>
<li><p>In the Ascend environment, operators with the stride property such as
Conv and Pooling have rules about the length of the stride, which
needs to be mitigated.</p></li>
<li><p>In a distributed environment, seed must be added to ensure that the
initialized parameters of multiple cards are consistent.</p></li>
<li><p>In the case of using list of Cell or list of Parameter in the
network, please convert the list to
<a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/nn/mindspore.nn.CellList.html">CellList</a>,
<a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/nn/mindspore.nn.SequentialCell.html">SequentialCell</a>,
and
<a class="reference external" href="https://www.mindspore.cn/docs/en/r2.0/api_python/mindspore/mindspore.ParameterTuple.html">ParameterTuple</a>
in <code class="docutils literal notranslate"><span class="pre">init</span></code>.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the required layers for graph construction in init, and don&#39;t write it like this</span>
<span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()]</span>

<span class="c1"># Need to encapsulate as CellList or SequentialCell</span>
<span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CellList</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()])</span>
<span class="c1"># Or</span>
<span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()])</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../analysis_and_preparation.html" class="btn btn-neutral float-left" title="Model Analysis and Preparation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dataset.html" class="btn btn-neutral float-right" title="Constructing Dataset" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>