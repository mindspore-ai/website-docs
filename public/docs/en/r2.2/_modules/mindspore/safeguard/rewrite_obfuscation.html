<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mindspore.safeguard.rewrite_obfuscation &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script>
      <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/training.css" type="text/css" /><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script><script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/js/theme.js"></script><script src="../../../_static/underscore.js"></script><script src="../../../_static/doctools.js"></script><script src="../../../_static/js/training.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/overview.html">MindSpore Design Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/programming_paradigm.html">Functional and Object-Oriented Fusion Programming Paradigm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/dynamic_graph_and_static_graph.html">Combination of Dynamic and Static Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/distributed_training_design.html">Distributed Parallel Native</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/data_engine.html">High Performance Data Processing Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/all_scenarios.html">Full-scenarios Unified Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/graph_fusion_engine.html">Graph-Kernel Fusion Acceleration Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/pluggable_device.html">Third-Party Hardware Interconnection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/official_models.html">Official Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.experimental.html">mindspore.experimental</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/api_mapping/pytorch_api_mapping.html">PyTorch and MindSpore API Mapping Table</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Migration Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/overview.html">Overview of Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/enveriment_preparation.html">Environment Preparation and Information Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/analysis_and_preparation.html">Model Analysis and Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/typical_api_comparision.html">Differences between PyTorch and MindSpore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/model_development/model_development.html">Constructing MindSpore Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/debug_and_tune.html">Debugging and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/sample_code.html">Network Migration Debugging Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/migrator_with_tools.html">Application Practice Guide for Network Migration Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/faq.html">FAQs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Syntax Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax_support.html">Static Graph Syntax Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/operators.html">Static Graph Syntax - Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/statements.html">Static Graph Syntax - Python Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/python_builtin_functions.html">Static Graph Syntax - Python Built-in Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/index_support.html">Tensor Index Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/env_var_list.html">Environment Variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/implement_problem.html">Implement Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/network_compilation.html">Network Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/operators_compile.html">Operators Compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/usage_migrate_3rd.html">Migration from a Third-party Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/performance_tuning.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/precision_tuning.html">Precision Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/distributed_parallel.html">Distributed Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/feature_advice.html">Feature Advice</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>mindspore.safeguard.rewrite_obfuscation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mindspore.safeguard.rewrite_obfuscation</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2023 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;obfuscate network based on rewrite interfaces.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">ops</span><span class="p">,</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common.tensor</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">save_checkpoint</span>
<span class="kn">from</span> <span class="nn">mindspore.rewrite</span> <span class="kn">import</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">NodeType</span><span class="p">,</span> <span class="n">TreeNodeHelper</span><span class="p">,</span> <span class="n">ScopedValue</span>

<span class="n">OBF_RATIOS_LENGTH</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">OBF_RATIOS_WIDTH</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">OBF_RATIOS_INSERT_INDEX</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="obfuscate_ckpt"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.obfuscate_ckpt.html#mindspore.obfuscate_ckpt">[docs]</a><span class="k">def</span> <span class="nf">obfuscate_ckpt</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">ckpt_files</span><span class="p">,</span> <span class="n">target_modules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saved_path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    obfuscate the plaintext checkpoint files. Usually used in conjunction with</span>
<span class="sd">    :func:`mindspore.load_obf_params_into_net`.</span>
<span class="sd">    interface.</span>

<span class="sd">    Args:</span>
<span class="sd">        network (nn.Cell): The original network that need to be obfuscated.</span>
<span class="sd">        ckpt_files (str): The directory path of original ckpt files.</span>
<span class="sd">        target_modules (list[str]): The target module of network that need to be obfuscated. The first string</span>
<span class="sd">            represents the network path of target module in original network, which should be in form of ``&#39;A/B/C&#39;``.</span>
<span class="sd">            The second string represents the obfuscation target module, which should be in form of ``&#39;D|E|F&#39;``. For</span>
<span class="sd">            example, thr target_modules of GPT2 can be ``[&#39;backbone/blocks/attention&#39;, &#39;dense1|dense2|dense3&#39;]``.</span>
<span class="sd">            If target_modules has the third value, it should be in the format of &#39;obfuscate_layers:all&#39; or</span>
<span class="sd">            &#39;obfuscate_layers:int&#39;, which represents the number of layers need to be obfuscated of duplicate layers</span>
<span class="sd">            (such as transformer layers or resnet blocks). If target_modules is ``None``, the function would search</span>
<span class="sd">            target modules by itself. If found, the searched target module would be used, otherwise suggested target</span>
<span class="sd">            modules would be given with warning log. Default: ``None``.</span>
<span class="sd">        saved_path (str): The directory path for saving obfuscated ckpt files and obf_ratios (a numpy file). obf_ratios</span>
<span class="sd">            is the necessary data that needs to be load when running obfuscated network. Default: ``&#39;./&#39;``.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `network` is not nn.Cell.</span>
<span class="sd">        TypeError: If `ckpt_files` is not string or `saved_path` is not string.</span>
<span class="sd">        TypeError: If `target_modules` is not list.</span>
<span class="sd">        TypeError: If target_modules&#39;s elements are not string.</span>
<span class="sd">        ValueError: If `ckpt_files` is not exist or `saved_path` is not exist.</span>
<span class="sd">        ValueError: If the number of elements of `target_modules` is less than ``2``.</span>
<span class="sd">        ValueError: If the first string of `target_modules` contains characters other than uppercase and lowercase</span>
<span class="sd">            letters, numbers, ``&#39;_&#39;`` and ``&#39;/&#39;``.</span>
<span class="sd">        ValueError: If the second string of `target_modules` is empty or contains characters other than uppercase and</span>
<span class="sd">            lowercase letters, numbers, ``&#39;_&#39;`` and ``&#39;|&#39;``.</span>
<span class="sd">        ValueError: If the third string of `target_modules` is not in the format of &#39;obfuscate_layers:all&#39; or</span>
<span class="sd">            &#39;obfuscate_layers:int&#39;.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import obfuscate_ckpt, save_checkpoint</span>
<span class="sd">        &gt;&gt;&gt; # Refer to https://gitee.com/mindspore/docs/blob/r2.2/docs/mindspore/code/lenet.py</span>
<span class="sd">        &gt;&gt;&gt; net = LeNet5()</span>
<span class="sd">        &gt;&gt;&gt; save_checkpoint(net, &#39;./test_net.ckpt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; target_modules = [&#39;&#39;, &#39;fc1|fc2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; obfuscate_ckpt(net, target_modules, &#39;./&#39;, &#39;./&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;network must be nn.Cell, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">network</span><span class="p">)))</span>
    <span class="n">_check_dir_path</span><span class="p">(</span><span class="s1">&#39;ckpt_files&#39;</span><span class="p">,</span> <span class="n">ckpt_files</span><span class="p">)</span>
    <span class="n">_check_dir_path</span><span class="p">(</span><span class="s1">&#39;saved_path&#39;</span><span class="p">,</span> <span class="n">saved_path</span><span class="p">)</span>
    <span class="c1"># Try to find default target modules</span>
    <span class="k">if</span> <span class="n">target_modules</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">to_split_modules</span> <span class="o">=</span> <span class="n">_get_default_target_modules</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">to_split_modules</span> <span class="o">=</span> <span class="n">target_modules</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_valid_target</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">to_split_modules</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The obfuscate module path </span><span class="si">{}</span><span class="s2"> is not exist, please check the input &#39;target_modules&#39;.&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_split_modules</span><span class="p">))</span>
    <span class="c1"># generate and save obf_ratios to saved_path</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="n">to_split_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">target_list</span> <span class="o">=</span> <span class="n">to_split_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">OBF_RATIOS_WIDTH</span><span class="p">,</span> <span class="n">OBF_RATIOS_LENGTH</span>
    <span class="n">number_of_ratios</span> <span class="o">=</span> <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="k">if</span> <span class="n">number_of_ratios</span> <span class="o">&gt;</span> <span class="n">MAX_OBF_RATIOS_NUM</span><span class="p">:</span>
        <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">=</span> <span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">//</span> <span class="n">OBF_RATIOS_WIDTH</span>
        <span class="n">number_of_ratios</span> <span class="o">=</span> <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="n">obf_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">secrets_generator</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_ratios</span><span class="p">):</span>
        <span class="n">secure_float</span> <span class="o">=</span> <span class="n">secrets_generator</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">obf_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">secure_float</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">saved_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;obf_ratios.npy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obf_ratios</span><span class="p">))</span>
    <span class="c1"># start obfuscate ckpt</span>
    <span class="n">ckpt_dir_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ckpt_name</span> <span class="ow">in</span> <span class="n">ckpt_dir_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">ckpt_files</span> <span class="o">+</span> <span class="n">ckpt_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">sub_path</span> <span class="o">=</span> <span class="n">ckpt_files</span> <span class="o">+</span> <span class="n">ckpt_name</span>
            <span class="n">sub_ckpt_file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span>
            <span class="n">new_saved_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">saved_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ckpt_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_saved_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_saved_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o700</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">sub_ckpt_name</span> <span class="ow">in</span> <span class="n">sub_ckpt_file_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sub_ckpt_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">_obfuscate_single_ckpt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sub_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">sub_ckpt_name</span><span class="p">,</span> <span class="n">obf_ratios</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span>
                                       <span class="n">target_list</span><span class="p">,</span> <span class="n">new_saved_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ckpt_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">_obfuscate_single_ckpt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ckpt_name</span><span class="p">,</span> <span class="n">obf_ratios</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span>
                                   <span class="n">target_list</span><span class="p">,</span> <span class="n">saved_path</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_obfuscate_single_ckpt</span><span class="p">(</span><span class="n">ckpt_name</span><span class="p">,</span> <span class="n">obf_ratios</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">,</span> <span class="n">saved_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obfuscate single ckpt file&quot;&quot;&quot;</span>
    <span class="n">module_has_been_obfuscated</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">ckpt_param</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_name</span><span class="p">)</span>
    <span class="n">obf_ratios_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">global</span> <span class="n">OBF_RATIOS_LENGTH</span><span class="p">,</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ckpt_param</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">_get_valid_module</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
            <span class="n">layer_index</span> <span class="o">=</span> <span class="n">_judge_layer_index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layer_index</span> <span class="o">&gt;=</span> <span class="n">OBF_RATIOS_LENGTH</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_has_been_obfuscated</span><span class="p">:</span>
                <span class="n">module_has_been_obfuscated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="n">obf_ratios_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ratio_total_index</span> <span class="o">=</span> <span class="n">layer_index</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span> <span class="o">+</span> <span class="n">obf_ratios_index</span> <span class="o">%</span> <span class="n">OBF_RATIOS_WIDTH</span>
            <span class="n">ckpt_param</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ckpt_param</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="n">obf_ratios</span><span class="p">[</span><span class="n">ratio_total_index</span><span class="p">])</span>
    <span class="c1"># save the obfuscated model to saved_path</span>
    <span class="n">obf_param_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ckpt_param</span><span class="p">:</span>
        <span class="n">obf_param_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ckpt_param</span><span class="p">[</span><span class="n">item</span><span class="p">]})</span>
    <span class="n">ckpt_file_name</span> <span class="o">=</span> <span class="n">ckpt_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">obf_ckpt_file_name</span> <span class="o">=</span> <span class="n">ckpt_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_obf&#39;</span> <span class="o">+</span> <span class="s1">&#39;.ckpt&#39;</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">obf_param_list</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">saved_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">obf_ckpt_file_name</span><span class="p">)</span>


<div class="viewcode-block" id="load_obf_params_into_net"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.load_obf_params_into_net.html#mindspore.load_obf_params_into_net">[docs]</a><span class="k">def</span> <span class="nf">load_obf_params_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">target_modules</span><span class="p">,</span> <span class="n">obf_ratios</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load obfuscate ratios into obfuscated network. Usually used in conjunction with :func:`mindspore.obfuscate_ckpt`</span>
<span class="sd">    interface.</span>

<span class="sd">    Args:</span>
<span class="sd">        network (nn.Cell): The original network that need to be obfuscated.</span>
<span class="sd">        target_modules (list[str]): The target module of network that need to be obfuscated. The first string</span>
<span class="sd">            represents the network path of target module in original network, which should be in form of ``&#39;A/B/C&#39;``.</span>
<span class="sd">            The second string represents the obfuscation target module, which should be in form of ``&#39;D|E|F&#39;``. For</span>
<span class="sd">            example, thr target_modules of GPT2 can be ``[&#39;backbone/blocks/attention&#39;, &#39;dense1|dense2|dense3&#39;]``.</span>
<span class="sd">            If target_modules has the third value, it should be in the format of &#39;obfuscate_layers:all&#39; or</span>
<span class="sd">            &#39;obfuscate_layers:int&#39;, which represents the number of layers need to be obfuscated of duplicate layers</span>
<span class="sd">            (such as transformer layers or resnet blocks).</span>
<span class="sd">        obf_ratios (Tensor): The obf ratios generated when execute :func:`mindspore.obfuscate_ckpt`.</span>
<span class="sd">        kwargs (dict): Configuration options dictionary.</span>

<span class="sd">            - ignored_func_decorators (list[str]): The name list of function decorators in network&#39;s python code.</span>
<span class="sd">            - ignored_class_decorators (list[str]): The name list of class decorators in network&#39;s python code.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `network` is not nn.Cell.</span>
<span class="sd">        TypeError: If `obf_ratios` is not Tensor.</span>
<span class="sd">        TypeError: If `target_modules` is not list.</span>
<span class="sd">        TypeError: If target_modules&#39;s elements are not string.</span>
<span class="sd">        ValueError: If the number of elements of `target_modules` is less than ``2``.</span>
<span class="sd">        ValueError: If `obf_ratios` is empty Tensor.</span>
<span class="sd">        ValueError: If the first string of `target_modules` contains characters other than uppercase and lowercase</span>
<span class="sd">            letters, numbers, ``&#39;_&#39;`` and ``&#39;/&#39;``.</span>
<span class="sd">        ValueError: If the second string of `target_modules` is empty or contains characters other than uppercase and</span>
<span class="sd">            lowercase letters, numbers, ``&#39;_&#39;`` and ``&#39;|&#39;``.</span>
<span class="sd">        ValueError: If the third string of `target_modules` is not in the format of &#39;obfuscate_layers:all&#39; or</span>
<span class="sd">            &#39;obfuscate_layers:int&#39;.</span>
<span class="sd">        TypeError: If `ignored_func_decorators` is not list[str] or `ignored_class_decorators` is not list[str].</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import obfuscate_ckpt, save_checkpoint, load_checkpoint, Tensor</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.common.dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # Refer to https://gitee.com/mindspore/docs/blob/r2.2/docs/mindspore/code/lenet.py</span>
<span class="sd">        &gt;&gt;&gt; net = LeNet5()</span>
<span class="sd">        &gt;&gt;&gt; save_checkpoint(net, &#39;./test_net.ckpt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; target_modules = [&#39;&#39;, &#39;fc1|fc2&#39;]</span>
<span class="sd">        &gt;&gt;&gt; # obfuscate ckpt files</span>
<span class="sd">        &gt;&gt;&gt; obfuscate_ckpt(net, target_modules, &#39;./&#39;, &#39;./&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # load obf ckpt into network</span>
<span class="sd">        &gt;&gt;&gt; new_net = LeNet5()</span>
<span class="sd">        &gt;&gt;&gt; load_checkpoint(&#39;./test_net_obf.ckpt&#39;, new_net)</span>
<span class="sd">        &gt;&gt;&gt; obf_ratios = Tensor(np.load(&#39;./obf_ratios.npy&#39;), mstype.float16)</span>
<span class="sd">        &gt;&gt;&gt; obf_net = load_obf_params_into_net(new_net, target_modules, obf_ratios)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;network must be nn.Cell, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">network</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obf_ratios</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;obf_ratios must be MindSpore Tensor, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obf_ratios</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">obf_ratios</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obf_ratios can not be empty.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_valid_target</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">target_modules</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not exist, please check the input &#39;target_modules&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">path_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span>
    <span class="n">target_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">path_len</span><span class="p">):</span>
        <span class="n">target_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="n">target_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">MAX_OBF_RATIOS_NUM</span><span class="p">,</span> <span class="n">OBF_RATIOS_WIDTH</span><span class="p">,</span> <span class="n">OBF_RATIOS_LENGTH</span>
    <span class="n">number_of_ratios</span> <span class="o">=</span> <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="k">if</span> <span class="n">number_of_ratios</span> <span class="o">&gt;</span> <span class="n">MAX_OBF_RATIOS_NUM</span><span class="p">:</span>
        <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">=</span> <span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">//</span> <span class="n">OBF_RATIOS_WIDTH</span>
        <span class="n">number_of_ratios</span> <span class="o">=</span> <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">=</span> <span class="n">number_of_ratios</span>
    <span class="n">rewrite_network</span> <span class="o">=</span> <span class="n">_obfuscate_network</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">rewrite_network</span><span class="p">,</span> <span class="s1">&#39;obf_ratios&#39;</span><span class="p">,</span> <span class="n">obf_ratios</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rewrite_network</span></div>


<span class="k">def</span> <span class="nf">_check_dir_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check directory path&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be string, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not exist, please check the input </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be a directory path, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_judge_layer_index</span><span class="p">(</span><span class="n">layer_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge the layer index of target layers&quot;&quot;&quot;</span>
    <span class="n">split_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">split_str</span> <span class="ow">in</span> <span class="n">split_name</span><span class="p">[:]:</span>
        <span class="k">if</span> <span class="n">split_str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">split_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_check_valid_target</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">target_modules</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check whether the input &#39;target_modules&#39; exists&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_modules</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;target_modules type should be list, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_modules should contain at least two string values, in the form of [&#39;A/B/C&#39;, &#39;D1|D2&#39;],&quot;</span>
                         <span class="s2">&quot;but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The values of target_modules should be string, but got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be a non-empty string value, in the form of &#39;D1|D2&#39;&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z]*[0-9]*\/*_*)*&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>\
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z]*[0-9]*\|*_*)*&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;please check the input &#39;target_modules&#39;</span><span class="si">{}</span><span class="s2">,it should be in the form of [&#39;A/B/C&#39;, &#39;D1|D2&#39;].&quot;</span>
                         <span class="s2">&quot;target_modules[0] can only contain uppercase and lowercase letters, numbers, &#39;_&#39; and &#39;/&#39;,&quot;</span>
                         <span class="s2">&quot;target_modules[1] can only contain uppercase and lowercase letters, numbers, &#39;_&#39; and &#39;|&#39;&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">))</span>
    <span class="c1"># target_modules[0] is allowed to be &#39;&#39;, it means the main network path</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">target_list</span> <span class="o">=</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">network</span>
    <span class="c1"># DFS check whether path_list is valid</span>
    <span class="n">stk</span> <span class="o">=</span> <span class="p">[</span><span class="n">net</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">global</span> <span class="n">OBF_RATIOS_LENGTH</span>
    <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">stk</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_list</span><span class="p">):</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">path_list</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">net</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">path_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">CellList</span><span class="p">):</span>
                <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">net</span><span class="p">:</span>
                    <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Target_modules[0] should be a subgraph and it&#39;s type should be nn.Cell(nn.CellList),&quot;</span>
                                <span class="s2">&quot;but got type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">net</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the path </span><span class="si">{}</span><span class="s2"> does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># check whether target_list is valid</span>
    <span class="k">global</span> <span class="n">OBF_RATIOS_WIDTH</span>
    <span class="n">OBF_RATIOS_WIDTH</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">target_list</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exist in the path </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">OBF_RATIOS_WIDTH</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">OBF_RATIOS_WIDTH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;all targets </span><span class="si">{}</span><span class="s2"> do not exist in the path </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_list</span><span class="p">,</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">_update_max_obf_ratios_num</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_update_max_obf_ratios_num</span><span class="p">(</span><span class="n">target_modules</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update MAX_OBF_RATIOS_NUM&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_modules</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">obfuscate_layers</span> <span class="o">=</span> <span class="n">target_modules</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obfuscate_layers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">obfuscate_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;obfuscate_layers&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The third value of target_modules should be in the format of &#39;obfuscate_layers:all&#39; or&quot;</span>
                             <span class="s2">&quot;&#39;obfuscate_layers:int&#39;&quot;</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">MAX_OBF_RATIOS_NUM</span>
        <span class="k">if</span> <span class="n">obfuscate_layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">=</span> <span class="n">OBF_RATIOS_LENGTH</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obfuscate_layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The third value of target_modules should be in the format of &#39;obfuscate_layers:all&#39; or&quot;</span>
                    <span class="s2">&quot;&#39;obfuscate_layers:int&#39;&quot;</span><span class="p">)</span>
            <span class="n">MAX_OBF_RATIOS_NUM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obfuscate_layers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">OBF_RATIOS_WIDTH</span>


<span class="k">def</span> <span class="nf">_get_default_target_modules</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the default or suggested target modules, if the target modules is None.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_split_to_path_and_target</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># split module into path list and target list</span>
        <span class="n">target_index</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">module</span><span class="p">[:</span><span class="n">target_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">module</span><span class="p">[</span><span class="n">target_index</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">_find_default_obfuscate_modules</span><span class="p">(</span><span class="n">net_path</span><span class="p">):</span>
        <span class="c1"># find modules including the default paths</span>
        <span class="n">default_module</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attention&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">default_module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">net_path</span> <span class="ow">and</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate_modules</span><span class="p">:</span>
                <span class="n">candidate_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net_path</span><span class="p">)</span>
        <span class="c1"># find the default targets in the default module</span>
        <span class="n">default_target</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">default_target</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidate_modules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">candidate</span><span class="p">:</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">_split_to_path_and_target</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_suggested_obfuscate_modules</span><span class="p">(</span><span class="n">net_path</span><span class="p">):</span>
        <span class="n">default_target</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dense&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">default_target</span><span class="p">:</span>
            <span class="c1"># find the suggest modules</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">net_path</span><span class="p">:</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">_split_to_path_and_target</span><span class="p">(</span><span class="n">net_path</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">suggest_modules</span><span class="p">:</span>
                    <span class="n">suggest_modules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>

    <span class="c1"># store the potential candidate_modules</span>
    <span class="n">candidate_modules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">suggest_modules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ckpt_dir_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ckpt_name</span> <span class="ow">in</span> <span class="n">ckpt_dir_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ckpt_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">ckpt_param</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ckpt_files</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ckpt_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ckpt_param</span><span class="p">:</span>
            <span class="n">param_path</span> <span class="o">=</span> <span class="n">_remove_digit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">param_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_path</span><span class="p">)</span>
            <span class="c1"># find candidate modules including the default paths and append candidate_modules</span>
            <span class="n">_find_default_obfuscate_modules</span><span class="p">(</span><span class="n">param_path</span><span class="p">)</span>
            <span class="c1"># give the suggested modules and find the default targets in the default module</span>
            <span class="n">_find_suggested_obfuscate_modules</span><span class="p">(</span><span class="n">param_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">paths</span> <span class="ow">and</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">target_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targets</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The default obfuscate modules is obtained:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_modules</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">target_modules</span>
    <span class="c1"># logging the suggested target module</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The default obfuscate modules can not be obtained. The suggested possible paths are given below: </span><span class="si">{}</span><span class="s2">&quot;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suggest_modules</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can not get the default path, please specify the path in the form of [&#39;A/B/C&#39;, &#39;D1|D2&#39;]&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_valid_module</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get the valid module&quot;&quot;&quot;</span>
    <span class="n">number_path</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span>
    <span class="n">net_path</span> <span class="o">=</span> <span class="n">_remove_digit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">net_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">net_path</span><span class="p">[:</span><span class="n">number_path</span><span class="p">])</span>
    <span class="n">tar_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span>
    <span class="c1"># update the weights with obf_ratios in target module</span>
    <span class="k">if</span> <span class="n">net_path</span> <span class="o">==</span> <span class="n">tar_path</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">target_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">target_index</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="n">target_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">module</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_remove_digit</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;remove digit in the parameter path&quot;&quot;&quot;</span>
    <span class="n">param_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tmp_str</span> <span class="ow">in</span> <span class="n">param_path</span><span class="p">[:]:</span>
        <span class="k">if</span> <span class="n">tmp_str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">param_path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">param_path</span>


<span class="k">def</span> <span class="nf">_obfuscate_network</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;obfuscate original network, including add mul operation and add inputs for passing obf_ratio.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_insert_input</span><span class="p">(</span><span class="n">stree</span><span class="p">:</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;y_obf&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;add inputs for passing obf_ratio&quot;&quot;&quot;</span>
        <span class="n">last_input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">stree</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">Input</span><span class="p">:</span>
                <span class="n">last_input</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">stree</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">last_input</span><span class="p">)</span>
        <span class="c1"># the insert input node name would be &#39;input_y_obf&#39;</span>
        <span class="n">new_input_node</span> <span class="o">=</span> <span class="n">last_input</span><span class="o">.</span><span class="n">create_input</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span>
        <span class="n">stree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">new_input_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_input_node</span>

    <span class="k">def</span> <span class="nf">_insert_mul</span><span class="p">(</span><span class="n">stree</span><span class="p">:</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;add mul operation for original network&quot;&quot;&quot;</span>
        <span class="n">arg_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_targets</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">input_y_node</span> <span class="o">=</span> <span class="n">stree</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s2">&quot;input_y_obf&quot;</span><span class="p">)</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">input_y_node</span><span class="o">.</span><span class="n">get_targets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sv</span><span class="p">:</span> <span class="n">ScopedValue</span> <span class="o">=</span> <span class="n">ScopedValue</span><span class="o">.</span><span class="n">create_naming_value</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
        <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>
        <span class="n">target_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_targets</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_mul_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">create_call_cell</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">ops</span><span class="o">.</span><span class="n">Mul</span><span class="p">(),</span> <span class="n">targets</span><span class="o">=</span><span class="n">target_list</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mul&#39;</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">stree</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">stree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">new_mul_node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_insert_mul_by_name</span><span class="p">(</span><span class="n">stree</span><span class="p">:</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">after_name_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;add mul operation after the target nodes according the name of them&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">after_name_list</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">stree</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">after_name</span> <span class="ow">in</span> <span class="n">after_name_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">after_name</span><span class="p">:</span>
                    <span class="k">global</span> <span class="n">OBF_RATIOS_INSERT_INDEX</span>
                    <span class="k">if</span> <span class="n">OBF_RATIOS_INSERT_INDEX</span> <span class="o">&lt;</span> <span class="n">MAX_OBF_RATIOS_NUM</span><span class="p">:</span>
                        <span class="n">_insert_mul</span><span class="p">(</span><span class="n">stree</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">OBF_RATIOS_INSERT_INDEX</span><span class="p">)</span>
                        <span class="n">OBF_RATIOS_INSERT_INDEX</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_update_subnet</span><span class="p">(</span><span class="n">stree</span><span class="p">:</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">substree</span><span class="p">:</span> <span class="n">SymbolTree</span><span class="p">,</span> <span class="n">subnode</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;update the network once the subnet is obfuscated&quot;&quot;&quot;</span>
        <span class="n">new_net</span> <span class="o">=</span> <span class="n">substree</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
        <span class="n">input_y_node</span> <span class="o">=</span> <span class="n">substree</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s2">&quot;input_y_obf&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_y_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">arg_list</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">input_y_node</span><span class="o">.</span><span class="n">get_targets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">arg_obf</span><span class="p">:</span> <span class="n">ScopedValue</span> <span class="o">=</span> <span class="n">ScopedValue</span><span class="o">.</span><span class="n">create_naming_value</span><span class="p">(</span><span class="s2">&quot;y_obf=&quot;</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_obf</span><span class="p">)</span>
        <span class="n">target_list</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">get_targets</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">create_call_cell</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">new_net</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">target_list</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">stree</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="p">[</span><span class="n">new_node</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_traverse</span><span class="p">(</span><span class="n">stree</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;traverse and obfuscate the original network&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">stree</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get_node_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">Tree</span> <span class="ow">and</span> <span class="n">node_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">path_list</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">sub_stree</span> <span class="o">=</span> <span class="n">TreeNodeHelper</span><span class="o">.</span><span class="n">get_sub_tree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">_traverse</span><span class="p">(</span><span class="n">sub_stree</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">_insert_input</span><span class="p">(</span><span class="n">sub_stree</span><span class="p">,</span> <span class="n">arg_name</span><span class="o">=</span><span class="s1">&#39;y_obf&#39;</span><span class="p">)</span>
                <span class="n">_insert_mul_by_name</span><span class="p">(</span><span class="n">sub_stree</span><span class="p">,</span> <span class="n">after_name_list</span><span class="o">=</span><span class="n">target_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">_update_subnet</span><span class="p">(</span><span class="n">stree</span><span class="p">,</span> <span class="n">sub_stree</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_denied_func_decorators</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set the function decorators which should be denied for parse&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mindspore.rewrite.parsers.class_def_parser</span> <span class="kn">import</span> <span class="n">ClassDefParser</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;denied_function_decorator_list&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ClassDefParser</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_denied_class_decorators</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set the class decorators which should be denied for parse&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mindspore.rewrite.parsers.class_def_parser</span> <span class="kn">import</span> <span class="n">ModuleParser</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;denied_class_decorator_list&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ModuleParser</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ignored_func_decorators&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kw_func_dec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignored_func_decorators&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be list, but got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">kw_func_dec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;elements of </span><span class="si">{}</span><span class="s1"> should be str, but got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">_register_denied_func_decorators</span><span class="p">(</span><span class="n">kw_func_dec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_register_denied_func_decorators</span><span class="p">([</span><span class="s2">&quot;_args_type_validator_check&quot;</span><span class="p">,</span> <span class="s2">&quot;_LogActionOnce&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_attr_register&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;ignored_class_decorators&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kw_class_dec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ignored_class_decorators&quot;</span><span class="p">]</span>
        <span class="n">_register_denied_class_decorators</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be list[str] type, but got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">kw_class_dec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;elements of </span><span class="si">{}</span><span class="s1"> should be str, but got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">kw_class_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="n">main_stree</span> <span class="o">=</span> <span class="n">SymbolTree</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">_traverse</span><span class="p">(</span><span class="n">main_stree</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_insert_input</span><span class="p">(</span><span class="n">main_stree</span><span class="p">,</span> <span class="n">arg_name</span><span class="o">=</span><span class="s1">&#39;y_obf&#39;</span><span class="p">)</span>
    <span class="n">_insert_mul_by_name</span><span class="p">(</span><span class="n">main_stree</span><span class="p">,</span> <span class="n">after_name_list</span><span class="o">=</span><span class="n">target_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_net</span> <span class="o">=</span> <span class="n">main_stree</span><span class="o">.</span><span class="n">get_network</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_net</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>