<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Distributed Parallel &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script src="../_static/js/mermaid-9.3.0.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Inference" href="inference.html" />
    <link rel="prev" title="Precision Tuning" href="precision_tuning.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/overview.html">MindSpore Design Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/tensor_view.html">TENSOR VIEWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/programming_paradigm.html">Functional and Object-Oriented Fusion Programming Paradigm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/dynamic_graph_and_static_graph.html">Combination of Dynamic and Static Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/distributed_training_design.html">Distributed Parallel Native</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/data_engine.html">High Performance Data Processing Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/all_scenarios.html">Full-scenarios Unified Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/graph_fusion_engine.html">Graph-Kernel Fusion Acceleration Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/pluggable_device.html">Third-Party Hardware Interconnection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/official_models.html">Official Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.hal.html">mindspore.hal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.multiprocessing.html">mindspore.multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.experimental.html">mindspore.experimental</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/api_mapping/pytorch_api_mapping.html">PyTorch and MindSpore API Mapping Table</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Migration Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/overview.html">Overview of Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/enveriment_preparation.html">Environment Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/analysis_and_preparation.html">Model Analysis and Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/model_development/model_development.html">Network Constructing Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/debug_and_tune.html">Debugging and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/sample_code.html">Network Migration Debugging Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guide/faq.html">FAQs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Syntax Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax_support.html">Static Graph Syntax Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/operators.html">Static Graph Syntax - Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/statements.html">Static Graph Syntax - Python Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/python_builtin_functions.html">Static Graph Syntax - Python Built-in Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/index_support.html">Tensor Index Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/env_var_list.html">Environment Variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="implement_problem.html">Implement Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="network_compilation.html">Network Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators_compile.html">Operators Compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance_tuning.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="precision_tuning.html">Precision Tuning</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Distributed Parallel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#q-what-should-i-do-if-the-error-message-init-plugin-so-failed,-ret-=-1343225860-is-displayed-during-the-hccl-distributed-training?">Q: What should I do if the error message <code class="docutils literal notranslate"><span class="pre">Init</span> <span class="pre">plugin</span> <span class="pre">so</span> <span class="pre">failed,</span> <span class="pre">ret</span> <span class="pre">=</span> <span class="pre">1343225860</span></code> is displayed during the HCCL distributed training?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-in-the-gpu-distributed-training-scenario,-if-the-number-of-environment-variables-cuda-visible-devices-set-incorrectly-is-less-than-the-number-of-processes-executed,-the-process-blocking-problem-may-occur-">Q: In the GPU distributed training scenario, if the number of environment variables CUDA_VISIBLE_DEVICES set incorrectly is less than the number of processes executed, the process blocking problem may occur.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-what-can-we-do-when-in-the-gpu-distributed-training-scenario,-if-a-process-exits-abnormally,-it-may-cause-other-processes-to-block?">Q: What can we do when in the GPU distributed training scenario, if a process exits abnormally, it may cause other processes to block?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-when-executing-a-gpu-stand-alone-single-card-script,-when-the-process-is-started-without-mpirun,-calling-the-mindspore-communication-init-method-may-report-an-error,-resulting-in-execution-failure,-how-to-deal-with-it?">Q: When executing a GPU stand-alone single-card script, when the process is started without mpirun, calling the mindspore.communication.init method may report an error, resulting in execution failure, how to deal with it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-prompt-fails-due-to-mpi-allgather?">Q: What can we do when performing multi-machine multi-card training via OpenMPI, the prompt fails due to MPI_Allgather?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-what-can-we-do-when-performing-distributed-training-via-openmpi,-stand-alone-multi-card-training-is-normal,-but-during-the-multi-machine-multi-card-training,-some-machines-prompt-the-gpu-device-id-setting-to-fail?">Q: What can we do when performing distributed training via OpenMPI, stand-alone multi-card training is normal, but during the multi-machine multi-card training, some machines prompt the GPU device id setting to fail?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-nccl-error-message-displays-that-the-network-is-not-working?">Q: What can we do when performing multi-machine multi-card training via OpenMPI, the NCCL error message displays that the network is not working?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-after-selecting-rdma-nic-with-a-specific-name-set-via-nccl-socket-ifname-for-communication-for-multiple-machines-and-multiple-cards,-the-training-still-reports-an-error-">Q: After selecting RDMA NIC with a specific name (set via NCCL_SOCKET_IFNAME) for communication for multiple machines and multiple cards, the training still reports an error:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q：single-machine-multi-card-training-can-be-successful,-but-after-expanding-the-script-to-multi-machine-multi-card,-other-hosts-prompt-all-kinds-of-errors-">Q：Single-machine multi-card training can be successful, but after expanding the script to multi-machine multi-card, other hosts prompt all kinds of errors:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-performing-the-distributed-training-via-openmpi-on-ascend,-got-hcclcomminitrootinfo-error-message-">Q: Performing the distributed training via OpenMPI on Ascend, got <code class="docutils literal notranslate"><span class="pre">HcclCommInitRootInfo</span></code> error message:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-when-executing-a-distributed-network-under-auto-parallel,-an-error-is-reported-that-the-tensor-cannot-be-split-by-the-strategy-how-can-i-solve-it?">Q: When executing a distributed network under <code class="docutils literal notranslate"><span class="pre">auto_parallel</span></code>, an error is reported that the tensor cannot be split by the strategy. How can I solve it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-what-should-i-do-if-a-process-exits-abnormally-during-the-execution-of-multi-card-training-on-a-linux-environment-and-there-is-a-shared-memory-residue-through-the-ipcs-command?">Q: What should I do if a process exits abnormally during the execution of multi-card training on a Linux environment and there is a shared memory residue through the ipcs command?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#q-i-try-to-train-a-small-network-on-ascend-platform-but-during-initializing-distributed-module,-device-memory-not-enough-exception-is-still-thrown-how-should-i-solve-this-issue?">Q: I try to train a small network on Ascend platform but during initializing distributed module, <code class="docutils literal notranslate"><span class="pre">device</span> <span class="pre">memory</span> <span class="pre">not</span> <span class="pre">enough</span></code> exception is still thrown. How should I solve this issue?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="feature_advice.html">Feature Advice</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Distributed Parallel</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/faq/distributed_parallel.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="distributed-parallel">
<h1>Distributed Parallel<a class="headerlink" href="#distributed-parallel" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.3.q1/docs/mindspore/source_en/faq/distributed_parallel.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.3.q1/resource/_static/logo_source_en.svg" /></a></p>
<section id="q-what-should-i-do-if-the-error-message-init-plugin-so-failed,-ret-=-1343225860-is-displayed-during-the-hccl-distributed-training?">
<h2>Q: What should I do if the error message <code class="docutils literal notranslate"><span class="pre">Init</span> <span class="pre">plugin</span> <span class="pre">so</span> <span class="pre">failed,</span> <span class="pre">ret</span> <span class="pre">=</span> <span class="pre">1343225860</span></code> is displayed during the HCCL distributed training?<a class="headerlink" href="#q-what-should-i-do-if-the-error-message-init-plugin-so-failed,-ret-=-1343225860-is-displayed-during-the-hccl-distributed-training?" title="Permalink to this headline"></a></h2>
<p>A: When the user starts distributed training on the Ascend and meets the error that HCCL fails to be initialized, the possible cause is that <code class="docutils literal notranslate"><span class="pre">rank_table.json</span></code> is incorrect. You can use the tool in <a class="reference external" href="https://gitee.com/mindspore/models/blob/master/utils/hccl_tools/hccl_tools.py">hccl_tools.py</a> to generate new <code class="docutils literal notranslate"><span class="pre">rank_table.json</span></code>. Alternatively, set the environment variable <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">ASCEND_SLOG_PRINT_TO_STDOUT=1</span></code> to enable the log printing function of HCCL and check the ERROR log information.</p>
<br/>
</section>
<section id="q-in-the-gpu-distributed-training-scenario,-if-the-number-of-environment-variables-cuda-visible-devices-set-incorrectly-is-less-than-the-number-of-processes-executed,-the-process-blocking-problem-may-occur-">
<h2>Q: In the GPU distributed training scenario, if the number of environment variables CUDA_VISIBLE_DEVICES set incorrectly is less than the number of processes executed, the process blocking problem may occur.<a class="headerlink" href="#q-in-the-gpu-distributed-training-scenario,-if-the-number-of-environment-variables-cuda-visible-devices-set-incorrectly-is-less-than-the-number-of-processes-executed,-the-process-blocking-problem-may-occur-" title="Permalink to this headline"></a></h2>
<p>A: In this scenario, some training processes will prompt the following error:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[ERROR] DEVICE [mindspore/ccsrc/runtime/device/gpu/cuda_driver.cc:245] SetDevice] SetDevice for id:7 failed, ret[101], invalid device ordinal. Please make sure that the &#39;device_id&#39; set in context is in the range:[0, total number of GPU). If the environment variable &#39;CUDA_VISIBLE_DEVICES&#39; is set, the total number of GPU will be the number set in the environment variable &#39;CUDA_VISIBLE_DEVICES&#39;. For example, if export CUDA_VISIBLE_DEVICES=4,5,6, the &#39;device_id&#39; can be 0,1,2 at the moment, &#39;device_id&#39; starts from 0, and &#39;device_id&#39;=0 means using GPU of number 4.
[ERROR] DEVICE [mindspore/ccsrc/runtime/device/gpu/gpu_device_manager.cc:27] InitDevice] Op Error: Failed to set current device id | Error Number: 0
</pre></div>
</div>
<p>The remaining processes may normally execute to the initialization <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> step due to the successful allocation of GPU resources, and the log is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INFO] DEVICE [mindspore/ccsrc/runtime/hardware/gpu/gpu_device_context.cc:90] Initialize] Start initializing NCCL communicator for device 1
</pre></div>
</div>
<p>In this step, the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> interface <code class="docutils literal notranslate"><span class="pre">ncclCommInitRank</span></code> is called, which blocks until all processes agree. So if a process doesn’t call <code class="docutils literal notranslate"><span class="pre">ncclCommInitRank</span></code>, it will cause the process to block.
We have reported this issue to the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> community, and the community developers are designing a solution. The latest version has not been fixed, see <a class="reference external" href="https://github.com/NVIDIA/nccl/issues/593#issuecomment-965939279">issue link</a>.
Solution: Manually <code class="docutils literal notranslate"><span class="pre">kill</span></code> the training process. According to the error log, set the correct card number, and then restart the training task.</p>
<br/>
</section>
<section id="q-what-can-we-do-when-in-the-gpu-distributed-training-scenario,-if-a-process-exits-abnormally,-it-may-cause-other-processes-to-block?">
<h2>Q: What can we do when in the GPU distributed training scenario, if a process exits abnormally, it may cause other processes to block?<a class="headerlink" href="#q-what-can-we-do-when-in-the-gpu-distributed-training-scenario,-if-a-process-exits-abnormally,-it-may-cause-other-processes-to-block?" title="Permalink to this headline"></a></h2>
<p>A: In this scenario, the abnormal process exits due to various problems, and the remaining processes are executed normally to the initialization <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> step due to the successful allocation of GPU resources. The log is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INFO] DEVICE [mindspore/ccsrc/runtime/hardware/gpu/gpu_device_context.cc:90] Initialize] Start initializing NCCL communicator for device 1
</pre></div>
</div>
<p>In this step, the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> interface <code class="docutils literal notranslate"><span class="pre">ncclCommInitRank</span></code> is called, which blocks until all processes agree. So if a process doesn’t call <code class="docutils literal notranslate"><span class="pre">ncclCommInitRank</span></code>, it will cause the process to block.
We have reported this issue to the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> community, and the community developers are designing a solution. The latest version has not been fixed, see <a class="reference external" href="https://github.com/NVIDIA/nccl/issues/593#issuecomment-965939279">issue link</a>.
Solution: Manually <code class="docutils literal notranslate"><span class="pre">kill</span></code> the training process and then restart the training task.</p>
<br/>
</section>
<section id="q-when-executing-a-gpu-stand-alone-single-card-script,-when-the-process-is-started-without-mpirun,-calling-the-mindspore-communication-init-method-may-report-an-error,-resulting-in-execution-failure,-how-to-deal-with-it?">
<h2>Q: When executing a GPU stand-alone single-card script, when the process is started without mpirun, calling the mindspore.communication.init method may report an error, resulting in execution failure, how to deal with it?<a class="headerlink" href="#q-when-executing-a-gpu-stand-alone-single-card-script,-when-the-process-is-started-without-mpirun,-calling-the-mindspore-communication-init-method-may-report-an-error,-resulting-in-execution-failure,-how-to-deal-with-it?" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[CRITICAL] DISTRIBUTED [mindspore/ccsrc/distributed/cluster/cluster_context.cc:130] InitNodeRole] Role name is invalid...
</pre></div>
</div>
<p>A: In the case where the user does not start the process using <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> but still calls the <code class="docutils literal notranslate"><span class="pre">init()</span></code> method, MindSpore requires the user to configure several environment variables and verify according to training and <a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r2.3.0rc1/parallel/dynamic_cluster.html">dynamic cluster startup methods</a>. If without configuring, MindSpore may display the above error message. Therefore, it is suggested that only when performing distributed training, <code class="docutils literal notranslate"><span class="pre">mindspore.communication.init</span></code> is called, and in the case of not using <code class="docutils literal notranslate"><span class="pre">mpirun</span></code>, it is configured the correct environment variables according to the documentation to start distributed training.</p>
<br/>
</section>
<section id="q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-prompt-fails-due-to-mpi-allgather?">
<h2>Q: What can we do when performing multi-machine multi-card training via OpenMPI, the prompt fails due to MPI_Allgather?<a class="headerlink" href="#q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-prompt-fails-due-to-mpi-allgather?" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>pml_ucx.c:175 Error: Failed to receive UCX worker address: Not found (-13)
pml_ucx.c:452 Error: Failed to resolve UCX endpoint for rank X
</pre></div>
</div>
<p>A: This problem is that <code class="docutils literal notranslate"><span class="pre">OpenMPI</span></code> cannot communicate with the peer address when communicating on the Host side, which is generally caused by the different configuration of the NIC between the machines, and can be solved by manually setting the NIC name or subnet:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mpirun -n process_num --mca btl tcp --mca btl_tcp_if_include eth0 ./run.sh
</pre></div>
</div>
<p>The above instruction starts the <code class="docutils literal notranslate"><span class="pre">process_num</span></code> of <code class="docutils literal notranslate"><span class="pre">run.sh</span></code> processes, and selects the Host side communication mode as <code class="docutils literal notranslate"><span class="pre">tcp</span></code>. The network card selects <code class="docutils literal notranslate"><span class="pre">eth0</span></code>, so that the network card used on each machine is the same, and then the communication abnormal problem is solved.</p>
<p>You can also select subnets for matching:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mpirun -n process_num --mca btl tcp --mca btl_tcp_if_include 192.168.1.0/24 ./run.sh
</pre></div>
</div>
<p>The subnet range needs to include the IP addresses used by all machines.</p>
<br/>
</section>
<section id="q-what-can-we-do-when-performing-distributed-training-via-openmpi,-stand-alone-multi-card-training-is-normal,-but-during-the-multi-machine-multi-card-training,-some-machines-prompt-the-gpu-device-id-setting-to-fail?">
<h2>Q: What can we do when performing distributed training via OpenMPI, stand-alone multi-card training is normal, but during the multi-machine multi-card training, some machines prompt the GPU device id setting to fail?<a class="headerlink" href="#q-what-can-we-do-when-performing-distributed-training-via-openmpi,-stand-alone-multi-card-training-is-normal,-but-during-the-multi-machine-multi-card-training,-some-machines-prompt-the-gpu-device-id-setting-to-fail?" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[ERROR] DEVICE [mindspore/ccsrc/runtime/device/gpu/cuda_driver.cc:245] SetDevice] SetDevice for id:7 failed, ret[101], invalid device ordinal. Please make sure that the &#39;device_id&#39; set in context is in the range:[0, total number of GPU). If the environment variable &#39;CUDA_VISIBLE_DEVICES&#39; is set, the total number of GPU will be the number set in the environment variable &#39;CUDA_VISIBLE_DEVICES&#39;. For example, if export CUDA_VISIBLE_DEVICES=4,5,6, the &#39;device_id&#39; can be 0,1,2 at the moment, &#39;device_id&#39; starts from 0, and &#39;device_id&#39;=0 means using GPU of number 4.
[ERROR] DEVICE [mindspore/ccsrc/runtime/device/gpu/gpu_device_manager.cc:27] InitDevice] Op Error: Failed to set current device id | Error Number: 0
</pre></div>
</div>
<p>A: In the multi-machine scenario, each process card number needs to be calculated after the host side <code class="docutils literal notranslate"><span class="pre">AllGather</span></code>and <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code>. If the same <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is used between machines, the process card number will be calculated incorrectly, causing the card number to cross the boundary and the setting to fail. This can be resolved by setting the HOSTNAME of each machine to its respective IP address in the execution script:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>export HOSTNAME=node_ip_address
</pre></div>
</div>
<br/>
</section>
<section id="q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-nccl-error-message-displays-that-the-network-is-not-working?">
<h2>Q: What can we do when performing multi-machine multi-card training via OpenMPI, the NCCL error message displays that the network is not working?<a class="headerlink" href="#q-what-can-we-do-when-performing-multi-machine-multi-card-training-via-openmpi,-the-nccl-error-message-displays-that-the-network-is-not-working?" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>include/socket.h:403 NCCL WARN Connect to XXX failed: Network is unreachable
</pre></div>
</div>
<p>A: This problem is that <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> cannot communicate with the peer address when synchronizing process information or initializing the communication domain on the Host side, which is generally caused by the different configuration of the network card between the machines, and the network card can be selected by setting the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> environment variable <code class="docutils literal notranslate"><span class="pre">NCCL_SOCKET_IFNAME</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>export NCCL_SOCKET_IFNAME=eth
</pre></div>
</div>
<p>The above command sets the <code class="docutils literal notranslate"><span class="pre">NCCL</span></code> to select the network card name with <code class="docutils literal notranslate"><span class="pre">eth</span></code> in the Host side to communicate.</p>
<br/>
</section>
<section id="q-after-selecting-rdma-nic-with-a-specific-name-set-via-nccl-socket-ifname-for-communication-for-multiple-machines-and-multiple-cards,-the-training-still-reports-an-error-">
<h2>Q: After selecting RDMA NIC with a specific name (set via NCCL_SOCKET_IFNAME) for communication for multiple machines and multiple cards, the training still reports an error:<a class="headerlink" href="#q-after-selecting-rdma-nic-with-a-specific-name-set-via-nccl-socket-ifname-for-communication-for-multiple-machines-and-multiple-cards,-the-training-still-reports-an-error-" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>misc/ibvwrap.cc:284 NCCL WARN Call to ibv_modify_qp failed with error Invalid argument
...
include/socket.h:403 NCCL WARN Connect to XXX failed: Connection refused
</pre></div>
</div>
<p>A: Generally this problem is the existence of differences in the configuration of the RDMA network card between multiple machines, which need to be analyzed on a case-by-case basis. However, the common reason is there are IB protocol and RoCE protocol on some host NICs at the same time, and there may be connection establishment failure. Solution:</p>
<p>The following command is required to specify the name of the RDMA NIC to be used as beginning with ib:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>export NCCL_IB_HCA=mlx
</pre></div>
</div>
<br/>
</section>
<section id="q：single-machine-multi-card-training-can-be-successful,-but-after-expanding-the-script-to-multi-machine-multi-card,-other-hosts-prompt-all-kinds-of-errors-">
<h2>Q：Single-machine multi-card training can be successful, but after expanding the script to multi-machine multi-card, other hosts prompt all kinds of errors:<a class="headerlink" href="#q：single-machine-multi-card-training-can-be-successful,-but-after-expanding-the-script-to-multi-machine-multi-card,-other-hosts-prompt-all-kinds-of-errors-" title="Permalink to this headline"></a></h2>
<p>There are various types of errors reported. Here are a few typical ones:</p>
<ol class="arabic simple">
<li><p>The installed whl package could not be found.</p></li>
<li><p>IB NIC communication failure.</p></li>
<li><p>Cuda library load failure.</p></li>
</ol>
<p>A: These problems are caused by the fact that when <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> starts other hosts, the environment variables of the other hosts (including the NCCL’s NIC selection configurations) are not synchronized with the local machine, resulting in the phenomenon that single-machine multi-card executes normally while multi-machine multi-card fails. The solution is to export specific environment variables via mpirun -x option:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mpirun --hostfile /path/to/hostfile -n 64 -x PYTHONPATH -x GLOG_v -x LD_LIBRARY_PATH -x NCCL_SOCKET_IFNAME -x NCCL_IB_HCA -x NCCL_DEBUG=INFO python train.py
</pre></div>
</div>
<p>The above command exports some environment variables that have been set on this machine to other hosts, ensuring that the environment variables of all hosts remain the same before executing the training script to achieve the goal of multi-machine multi-card training.</p>
<br/>
</section>
<section id="q-performing-the-distributed-training-via-openmpi-on-ascend,-got-hcclcomminitrootinfo-error-message-">
<h2>Q: Performing the distributed training via OpenMPI on Ascend, got <code class="docutils literal notranslate"><span class="pre">HcclCommInitRootInfo</span></code> error message:<a class="headerlink" href="#q-performing-the-distributed-training-via-openmpi-on-ascend,-got-hcclcomminitrootinfo-error-message-" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Ascend collective Error: &quot;HcclCommInitRootInfo failed. | Error Number 2
</pre></div>
</div>
<p>A: Currently, when training via OpenMPI, hccl needs to allocate about 300M device memory for each card within a communicator. The more communicators one card involved in, the more extra device memory needed. This probably cause memory issue.
You can set <code class="docutils literal notranslate"><span class="pre">variable_memory_max_size</span></code> in <code class="docutils literal notranslate"><span class="pre">context</span></code>to reduce variable memory for Ascend processes, so that hccl will have enough memory to create communicators.</p>
<br/>
</section>
<section id="q-when-executing-a-distributed-network-under-auto-parallel,-an-error-is-reported-that-the-tensor-cannot-be-split-by-the-strategy-how-can-i-solve-it?">
<h2>Q: When executing a distributed network under <code class="docutils literal notranslate"><span class="pre">auto_parallel</span></code>, an error is reported that the tensor cannot be split by the strategy. How can I solve it?<a class="headerlink" href="#q-when-executing-a-distributed-network-under-auto-parallel,-an-error-is-reported-that-the-tensor-cannot-be-split-by-the-strategy-how-can-i-solve-it?" title="Permalink to this headline"></a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>np_tensor can not be split by strategy!
</pre></div>
</div>
<p>A: This error indicates that a strategy is configured for a parameter on the network, but a certain dimension of the parameter is not devisible by the strategy. There are two possible problems: 1. The parameter is used as the input of an operator, and the shard interface is called to set an illegel strategy for this operator. 2. When <code class="docutils literal notranslate"><span class="pre">dataset_strategy</span></code>=”data_parallel” or <code class="docutils literal notranslate"><span class="pre">full_batch</span></code>=False is set in <code class="docutils literal notranslate"><span class="pre">auto_parallel_context</span></code>, the framework will automatically set a data-parallel strategy for network input. This error is also reported if the network input contains parameter whose shape cannot be divisible by the data-parallel strategy. However, auto-parallel only supports Tensor as network input, and you need to make adjustments to your script.</p>
<br/>
</section>
<section id="q-what-should-i-do-if-a-process-exits-abnormally-during-the-execution-of-multi-card-training-on-a-linux-environment-and-there-is-a-shared-memory-residue-through-the-ipcs-command?">
<h2>Q: What should I do if a process exits abnormally during the execution of multi-card training on a Linux environment and there is a shared memory residue through the ipcs command?<a class="headerlink" href="#q-what-should-i-do-if-a-process-exits-abnormally-during-the-execution-of-multi-card-training-on-a-linux-environment-and-there-is-a-shared-memory-residue-through-the-ipcs-command?" title="Permalink to this headline"></a></h2>
<p>A: In the case of multi-card training and enabling graph operator fusion, the framework uses a shared memory mechanism for unified compilation of operators among multiple cards, and the shared memory is not effectively freed if the process ends unexpectedly due to internal or external exceptions during the compilation process. The ipcs command shows that nattch of the residual shared memory is 0. The framework will take over the shared memory again when the training script is re-executed, and it can be released normally as long as no exception occurs. You can also release the shared memory by ipcrm command, which will not affect the training script execution.</p>
<br/>
</section>
<section id="q-i-try-to-train-a-small-network-on-ascend-platform-but-during-initializing-distributed-module,-device-memory-not-enough-exception-is-still-thrown-how-should-i-solve-this-issue?">
<h2>Q: I try to train a small network on Ascend platform but during initializing distributed module, <code class="docutils literal notranslate"><span class="pre">device</span> <span class="pre">memory</span> <span class="pre">not</span> <span class="pre">enough</span></code> exception is still thrown. How should I solve this issue?<a class="headerlink" href="#q-i-try-to-train-a-small-network-on-ascend-platform-but-during-initializing-distributed-module,-device-memory-not-enough-exception-is-still-thrown-how-should-i-solve-this-issue?" title="Permalink to this headline"></a></h2>
<p>A: This is because under the Ascend platform, the MindSpore backend defaults to pre-allocate a block of memory, with approximately 80% of NPU memory occupied and the remaining 20% used for initializing the HCCL collection communication library. Each HCCL communication group occupies 200 MB memory by default, so in scenarios with more communication groups, it is easy to encounter device side memory shortage errors. The solution is to set up <code class="docutils literal notranslate"><span class="pre">HCCL_BUFFSIZE</span></code> environment variable to change communication domain memory usage. Specific configuration method can refer to <a class="reference external" href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/80RC1alpha001/apiref/envref/envref_07_0081.html">HCCL official document</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="precision_tuning.html" class="btn btn-neutral float-left" title="Precision Tuning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="inference.html" class="btn btn-neutral float-right" title="Inference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>