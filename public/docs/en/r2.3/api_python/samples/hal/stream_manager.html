<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Illustration of stream management &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script><script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/js/theme.js"></script><script src="../../../_static/underscore.js"></script><script src="../../../_static/doctools.js"></script><script src="../../../_static/js/mermaid-9.3.0.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/overview.html">MindSpore Design Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/tensor_view.html">TENSOR VIEWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/programming_paradigm.html">Functional and Object-Oriented Fusion Programming Paradigm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/dynamic_graph_and_static_graph.html">Combination of Dynamic and Static Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/distributed_training_design.html">Distributed Parallel Native</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/data_engine.html">High Performance Data Processing Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/all_scenarios.html">Full-scenarios Unified Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/graph_fusion_engine.html">Graph-Kernel Fusion Acceleration Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/pluggable_device.html">Third-Party Hardware Interconnection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/official_models.html">Official Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.hal.html">mindspore.hal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.multiprocessing.html">mindspore.multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mindspore.experimental.html">mindspore.experimental</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/api_mapping/pytorch_api_mapping.html">PyTorch and MindSpore API Mapping Table</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Migration Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/overview.html">Overview of Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/enveriment_preparation.html">Environment Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/analysis_and_preparation.html">Model Analysis and Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/model_development/model_development.html">Network Constructing Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/debug_and_tune.html">Debugging and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/sample_code.html">Network Migration Debugging Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/faq.html">FAQs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Syntax Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax_support.html">Static Graph Syntax Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/operators.html">Static Graph Syntax - Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/statements.html">Static Graph Syntax - Python Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/python_builtin_functions.html">Static Graph Syntax - Python Built-in Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/index_support.html">Tensor Index Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/env_var_list.html">Environment Variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/implement_problem.html">Implement Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/network_compilation.html">Network Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/operators_compile.html">Operators Compile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/performance_tuning.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/precision_tuning.html">Precision Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/distributed_parallel.html">Distributed Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/feature_advice.html">Feature Advice</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Illustration of stream management</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/api_python/samples/hal/stream_manager.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="illustration-of-stream-management">
<h1>Illustration of stream management<a class="headerlink" href="#illustration-of-stream-management" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r2.3/docs/api/api_python_en/samples/hal/stream_manager.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.3/resource/_static/logo_source_en.svg" /></a></p>
<section id="device-stream">
<h2>Device stream<a class="headerlink" href="#device-stream" title="Permalink to this headline"></a></h2>
<p>A device stream is a linear sequence of execution that belongs to a specific device. You normally do not need to create one explicitly: by default, each device uses its own “default” stream.</p>
<p>Operations in each stream are serialized in the order in which they are created, but operations from different streams can execute concurrently in any relative order, unless explicit synchronization functions (such as <code class="docutils literal notranslate"><span class="pre">synchronize()</span></code> or <code class="docutils literal notranslate"><span class="pre">wait_stream()</span></code>) are used. For example, the following code is incorrect:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>  <span class="c1"># Create a new stream.</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># sum() may start execution before matmul() finishes!</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

</pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">current</span> <span class="pre">stream</span></code> is the default stream, it is the user’s responsibility to ensure proper synchronization when switch to the non-default streams. The fixed version of this example is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>  <span class="c1"># Create a new stream.</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">wait_stream</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">current_stream</span><span class="p">())</span>  <span class="c1"># Dispatch wait event to device.</span>
<span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
</pre></div>
</div>
<p>Because both application and release require overheads, it is recommended that the same stream be used in the same cell or function instead of applying for a stream before each use. The following code is not recommended:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following cell formats are not recommended:</span>
<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
            <span class="o">...</span>

<span class="c1"># The following function formats are not recommended:</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The recommended format is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following cell formats are recommended:</span>
<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="p">):</span>
            <span class="o">...</span>

<span class="c1"># The following function formats are recommended:</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">s1</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="device-event">
<h2>Device event<a class="headerlink" href="#device-event" title="Permalink to this headline"></a></h2>
<p>Device events can be used to monitor the device’s progress, to accurately measure timing, and to synchronize device streams. For ease of use, we provide several encapsulation interfaces in the <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.3/api_python/hal/mindspore.hal.Stream.html">Stream</a> class, such as the <code class="docutils literal notranslate"><span class="pre">wait_stream()</span></code> interface used in the above example, you can see the interface documentation for details.</p>
<p>The most common use of <code class="docutils literal notranslate"><span class="pre">ms.hal.Event</span></code> is the combination of <code class="docutils literal notranslate"><span class="pre">record()</span></code> and <code class="docutils literal notranslate"><span class="pre">wait()</span></code> to ensure that the execution order can meet the user’s expectations in a multi-stream network, as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>     <span class="c1"># Create a new stream.</span>
<span class="n">ev1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>    <span class="c1"># Create a new event.</span>
<span class="n">ev2</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>    <span class="c1"># Create a new event.</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">ev1</span><span class="o">.</span><span class="n">record</span><span class="p">()</span>
<span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">ev1</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># Ensure &#39;B = ops.matmul(A, A)&#39; is complete.</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">ev2</span><span class="o">.</span><span class="n">record</span><span class="p">()</span>
    <span class="o">...</span>
<span class="n">ev1</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>      <span class="c1"># Ensure &#39;C = ops.sum(B)&#39; is complete.</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In addition, delivery of the host operator and execution of the device operator are asynchronous. In the following example, after the device address of <code class="docutils literal notranslate"><span class="pre">add_s0</span></code> on the host is released, it is applied for by <code class="docutils literal notranslate"><span class="pre">mess_output</span></code>, and the output data is written to the device address. However, at this time, the device may execute <code class="docutils literal notranslate"><span class="pre">add_s1</span> <span class="pre">=</span> <span class="pre">add_s0</span> <span class="pre">+</span> <span class="pre">1</span></code>, but the device memory of <code class="docutils literal notranslate"><span class="pre">add_s0</span></code> has been used by other operators. As a result, the precision is incorrect.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">ops</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">)</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>

<span class="n">input_s0</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">weight_s0</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">mess_input</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Use default stream</span>
<span class="n">add_s0</span> <span class="o">=</span> <span class="n">input_s0</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">s1</span><span class="o">.</span><span class="n">wait_stream</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">default_stream</span><span class="p">())</span>
<span class="k">with</span> <span class="n">ms</span><span class="o">.</span><span class="n">hal</span><span class="o">.</span><span class="n">StreamCtx</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
  <span class="c1"># Use conv2d because this operator takes a long time in device.</span>
  <span class="n">conv_res</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">add_s0</span><span class="p">,</span> <span class="n">weight_s0</span><span class="p">)</span>
  <span class="n">add_s1</span> <span class="o">=</span> <span class="n">add_s0</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">ev</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">record_event</span><span class="p">()</span>
<span class="k">del</span> <span class="n">add_s0</span>

<span class="c1"># Mess up the mem of add_s0. The value of add_s1 might be wrong.</span>
<span class="n">mess_output</span> <span class="o">=</span> <span class="n">mess_input</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ev</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">add_1_s0</span> <span class="o">=</span> <span class="n">add_s1</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Therefore, MindSpore has developed a mechanism to automatically extend the lifecycle of cross-streams device addresses. You don’t need to manually execute the function like <code class="docutils literal notranslate"><span class="pre">record_stream()</span></code> to extend its lifetime. The general principle is as follows: MindSpore identifies the stream where the operator and input/output are located. After identifying the operator and input/output cross-streams(For example, <code class="docutils literal notranslate"><span class="pre">add_s0</span></code> is from stream0, and the operator is on stream1), an event will be inserted for the input or output address, and the address and event information is saved to the device memory pool. Then, if there is a “back-stream”(<code class="docutils literal notranslate"><span class="pre">record()</span></code> on stream1, <code class="docutils literal notranslate"><span class="pre">wait()</span></code> on stream0), the address and event information in the device memory pool will be removed. If there is no “back-stream” and the device memory pool fails to allocate, all events will be synchronized and the bound information is released.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>