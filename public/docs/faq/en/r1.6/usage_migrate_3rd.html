

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Migration from a Third-party Framework &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Performance Tuning" href="performance_tuning.html" />
    <link rel="prev" title="Operators Compile" href="operators_compile.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="implement_problem.html">Implement Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="network_compilation.html">Network Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators_compile.html">Operators Compile</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Migration from a Third-party Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance_tuning.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="precision_tuning.html">Precision Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_configure.html">Distributed Configure</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="feature_advice.html">Feature Advice</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Migration from a Third-party Framework</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/usage_migrate_3rd.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="migration-from-a-third-party-framework">
<h1>Migration from a Third-party Framework<a class="headerlink" href="#migration-from-a-third-party-framework" title="Permalink to this headline">Â¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.6/docs/mindspore/faq/source_en/usage_migrate_3rd.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.6/resource/_static/logo_source_en.png"></a></p>
<p><font size=3><strong>Q: How do I load a pre-trained PyTorch model for fine-tuning on MindSpore?</strong></font></p>
<p>A: Map parameters of PyTorch and MindSpore one by one. No unified conversion script is provided due to flexible network definitions.</p>
<p>In general, the parameters names and parameters values are saved in the CheckPoint file. After invoking the loading interface of the corresponding framework and obtaining the parameter names and values, construct the object according to the MindSpore format, and then you can directly invoke the MindSpore interface to save as CheckPoint files in the MindSpore format.</p>
<p>The main work is to compare the parameter names between different frameworks, so that all parameter names in the network of the two frameworks correspond to each other (a map can be used for mapping). The logic of the following code is transforming the parameter format, excluding the corresponding parameter name.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">save_checkpoint</span>

<span class="k">def</span> <span class="nf">pytorch2mindspore</span><span class="p">(</span><span class="n">default_file</span> <span class="o">=</span> <span class="s1">&#39;torch_resnet.pth&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read pth file&quot;&quot;&quot;</span>
    <span class="n">par_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">default_file</span><span class="p">)[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">]</span>
    <span class="n">params_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">par_dict</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">par_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">params_list</span><span class="p">,</span>  <span class="s1">&#39;ms_resnet.ckpt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<br/>
<p><font size=3><strong>Q: How do I convert a PyTorch <code class="docutils literal notranslate"><span class="pre">dataset</span></code> to a MindSpore <code class="docutils literal notranslate"><span class="pre">dataset</span></code>?</strong></font></p>
<p>A: The custom dataset logic of MindSpore is similar to that of PyTorch. You need to define a <code class="docutils literal notranslate"><span class="pre">dataset</span></code> class containing <code class="docutils literal notranslate"><span class="pre">__init__</span></code>, <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, and <code class="docutils literal notranslate"><span class="pre">__len__</span></code> to read your dataset, instantiate the class into an object (for example, <code class="docutils literal notranslate"><span class="pre">dataset/dataset_generator</span></code>), and transfer the instantiated object to <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> (on MindSpore) or <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> (on PyTorch). Then, you are ready to load the custom dataset. MindSpore provides further <code class="docutils literal notranslate"><span class="pre">map</span></code>-&gt;<code class="docutils literal notranslate"><span class="pre">batch</span></code> operations based on <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code>. Users can easily add other custom operations to <code class="docutils literal notranslate"><span class="pre">map</span></code> and start <code class="docutils literal notranslate"><span class="pre">batch</span></code>.
The custom dataset of MindSpore is loaded as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Perform operations such as data argumentation, shuffle, and sampler.</span>
<span class="k">class</span> <span class="nc">Mydata</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">58</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__label</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span>
<span class="n">dataset_generator</span> <span class="o">=</span> <span class="n">Mydata</span><span class="p">()</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">dataset_generator</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># 2. Customize data argumentation.</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">pyFunc</span><span class="p">,</span> <span class="p">{</span><span class="n">other_params</span><span class="p">})</span>
<span class="c1"># 3. batch</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<br/>
<p><font size=3><strong>Q: How do I migrate scripts or models of other frameworks to MindSpore?</strong></font></p>
<p>A: For details about script or model migration, please visit the <a class="reference external" href="https://www.mindspore.cn/docs/migration_guide/en/r1.6/migration_script.html">MindSpore official website</a>.</p>
<br/>
<p><font size=3><strong>Q: MindConverter converts TensorFlow script error prompt<code class="docutils literal notranslate"><span class="pre">terminate</span> <span class="pre">called</span> <span class="pre">after</span> <span class="pre">throwing</span> <span class="pre">an</span> <span class="pre">instance</span> <span class="pre">of</span> <span class="pre">'std::system_error',</span> <span class="pre">what():</span> <span class="pre">Resource</span> <span class="pre">temporarily</span> <span class="pre">unavailable,</span> <span class="pre">Aborted</span> <span class="pre">(core</span> <span class="pre">dumped)</span></code></strong></font></p>
<p>A: This problem is caused by TensorFlow. During script conversion, you need to load the TensorFlow model file through the TensorFlow library. At this time, TensorFlow will apply for relevant resources for initialization. If the resource application fails (maybe because the number of system processes exceeds the maximum number of Linux processes), the TensorFlow C/C++ layer will appear Core Dumped problem. For more information, please refer to the official ISSUE of TensorFlow. The following ISSUE is for reference only: <a class="reference external" href="https://github.com/tensorflow/tensorflow/issues/14885">TF ISSUE 14885</a>, <a class="reference external" href="https://github.com/tensorflow/tensorflow/issues/37449">TF ISSUE 37449</a></p>
<br/>
<p><font size=3><strong>Q: Can MindConverter run on ARM platform?</strong></font></p>
<p>A: MindConverter supports both x86 and ARM platform. Please ensure all required dependencies and environments have been installed in the ARM platform.</p>
<br/>
<p><font size=3><strong>Q: Why does the conversion process take a lot of time (more than 10 minutes), but the model is not so large?</strong></font></p>
<p>A: When converting, MindConverter needs to use Protobuf to deserialize the model file. Please make sure that the Protobuf installed in Python environment is implemented by C++ backend. The validation method is as follows. If the output is âpythonâ, you need to install Python Protobuf implemented by C++ (download the Protobuf source code, enter the âpythonâ subdirectory in the source code, and use <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span> <span class="pre">--cpp_implementation</span></code> to install). If the output is âcppâ and the conversion process still takes a long time, please add environment variable <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=cpp</span></code> before conversion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.protobuf.internal</span> <span class="kn">import</span> <span class="n">api_implementation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">api_implementation</span><span class="o">.</span><span class="n">Type</span><span class="p">())</span>
</pre></div>
</div>
<br/>
<p><font size=3><strong>Q: While converting .pb file to MindSpore script, what may be the cause of error code 1000001 with ensuring <code class="docutils literal notranslate"><span class="pre">model_file</span></code>, <code class="docutils literal notranslate"><span class="pre">shape</span></code>, <code class="docutils literal notranslate"><span class="pre">iput_nodes</span></code> and <code class="docutils literal notranslate"><span class="pre">output_nodes</span></code> set right and third party requirements installed correctly?</strong></font></p>
<p>A: Make sure that the TensorFlow version to generate .pb file is no higher than that to convert .pb file, avoiding the conflict which caused by using low version TensorFlow to parse .pb file generated by the high version.</p>
<br/>
<p><font size=3><strong>Q: What should I do to deal with Exception <code class="docutils literal notranslate"><span class="pre">[ERROR]</span> <span class="pre">MINDCONVERTER:</span> <span class="pre">[BaseConverterError]</span> <span class="pre">code:</span> <span class="pre">0000000,</span> <span class="pre">msg:</span> <span class="pre">{python_home}/lib/libgomp.so.1:</span> <span class="pre">cannot</span> <span class="pre">allocate</span> <span class="pre">memory</span> <span class="pre">in</span> <span class="pre">static</span> <span class="pre">TLS</span> <span class="pre">block</span></code>?</strong></font></p>
<p>A: In most cases, the problem is caused by environment variable exported incorrectly. Please set <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">LD_PRELOAD={python_home}/lib/libgomp.so.1.0.0</span></code>, then try to run MindConverter again.</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="performance_tuning.html" class="btn btn-neutral float-right" title="Performance Tuning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="operators_compile.html" class="btn btn-neutral float-left" title="Operators Compile" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>