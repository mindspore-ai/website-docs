<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindSpore IR (MindIR) &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Distributed Training Design" href="distributed_training_design.html" />
    <link rel="prev" title="Technical White Paper" href="technical_white_paper.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Design</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="technical_white_paper.html">Technical White Paper</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MindSpore IR (MindIR)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#syntax">Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#saving-ir">Saving IR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ir-file-contents-introduction">IR File Contents Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#function-style-semantics">Function-style Semantics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#higher-order-functions">Higher-Order Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#control-flows">Control Flows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#free-variables-and-closures">Free Variables and Closures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_design.html">Distributed Training Design</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Specification Note</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../benchmark.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network_list.html">Network List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list.html">Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syntax_list.html">Syntax Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_var_list.html">Environment Variables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">RoadMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help_seeking_path.html">Seeking Help and Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Participating in MindSpore Community</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>MindSpore IR (MindIR)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design/mindir.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mindspore-ir-mindir">
<h1>MindSpore IR (MindIR)<a class="headerlink" href="#mindspore-ir-mindir" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Windows</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">Framework</span> <span class="pre">Development</span></code> <code class="docutils literal notranslate"><span class="pre">Intermediate</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Development</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code> <code class="docutils literal notranslate"><span class="pre">Contributor</span></code></p>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/note/source_en/design/mindir.md"><img alt="View Source On Gitee" src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>An intermediate representation (IR) is a representation of a program between the source and target languages, which facilitates program analysis and optimization for the compiler. Therefore, the IR design needs to consider the difficulty in converting the source language to the target language, as well as the ease-of-use and performance of program analysis and optimization.</p>
<p>MindSpore IR (MindIR) is a function-style IR based on graph representation. Its core purpose is to serve automatic differential transformation. Automatic differentiation uses the transformation method based on the function-style programming framework. Therefore, IR uses the semantics close to that of the ANF function. In addition, a manner of representation based on an explicit dependency graph is used by referring to excellent designs of Sea of Nodes[1] and Thorin[2]. For the specific introduction of ANF-IR, please refer to <a class="reference internal" href="#syntax"><span class="std std-doc">MindSpore IR Syntax</span></a>.</p>
<p>When a model compiled using MindSpore runs in the graph mode <code class="docutils literal notranslate"><span class="pre">context.set_context(mode=context.GRAPH_MODE)</span></code> and <code class="docutils literal notranslate"><span class="pre">context.set_context(save_graphs=True)</span></code> is set in the configuration, some intermediate files will be generated during graph compliation. These intermediate files are called IR files. Currently, there are three IR files:</p>
<ul class="simple">
<li><p>.ir file: An IR file that describes the model structure in text format and can be directly viewed using any text editors. We will also introduce how to view it in the following sections.</p></li>
<li><p>.dat file: An IR file that describes the model structure more strictly than the .ir file. It contains more contents and can be directly viewed using any text editors.</p></li>
<li><p>.dot file: An IR file that describes the topology relationships between different nodes. You can use this file by <a class="reference external" href="http://graphviz.org/">graphviz</a> as the input to generate images for users to view the model structure. For models with multiple operators, it is recommended using the visualization component <a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/r1.3/dashboard.html#computational-graph-visualization">MindInsight</a> to visualize computing graphs.</p></li>
</ul>
</section>
<section id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline"></a></h2>
<p>ANF is a simple IR commonly used during functional programming. The ANF syntax is defined as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;aexp&gt; ::= NUMBER | STRING | VAR | BOOLEAN | PRIMOP
          |  (lambda (VAR …) &lt;exp&gt;)
&lt;cexp&gt; ::= (&lt;aexp&gt; &lt;aexp&gt; …)
          |  (if &lt;aexp&gt; &lt;exp&gt; &lt;exp&gt;)
&lt;exp&gt; ::= (let ([VAR &lt;cexp&gt;]) &lt;exp&gt;) | &lt;cexp&gt; | &lt;aexp&gt;
</pre></div>
</div>
<p>Expressions in the ANF are classified into atomic expressions (aexp) and compound expressions (cexp). An atomic expression indicates a constant value, a variable, or an anonymous function. A compound expression consists of multiple atomic expressions, indicating that an anonymous function or primitive function call. The first input expression of a compound expression is the called function, and the other input expressions are the called parameters.</p>
<p>The syntax of MindIR is inherited from the ANF and is defined as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;ANode&gt; ::= &lt;ValueNode&gt; | &lt;ParameterNode&gt;
&lt;ParameterNode&gt; ::= Parameter
&lt;ValueNode&gt; ::= Scalar | Named | Tensor | Type | Shape
               | Primitive | MetaFuncGraph | FuncGraph
&lt;CNode&gt; ::= (&lt;AnfNode&gt; …)
&lt;AnfNode&gt; ::= &lt;CNode&gt; | &lt;ANode&gt;
</pre></div>
</div>
<p>ANode in a MindIR corresponds to the atomic expression of ANF. ANode has two subclasses: ValueNode and ParameterNode. ValueNode refers to a constant node, which can carry a constant value (such as a scalar, symbol, tensor, type, and dimension), a primitive function (Primitive), a metafunction (MetaFuncGraph), or a common function (FuncGraph). In functional programming, the function definition itself is a value. ParameterNode refers to a parameter node, which indicates the formal parameter of a function.</p>
<p>CNode in a MindIR corresponds to the compound expression of ANF, indicating a function call.</p>
<p>During automatic differentiation of MindSpore, the gradient contribution of ParameterNode and CNode are calculated, and the final gradient of ParameterNode is returned. The gradient of ValueNode is not calculated.</p>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h2>
<p>The following uses a program code segment as an example to help you understand MindIR.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>

<span class="nd">@ms_function</span>
<span class="k">def</span> <span class="nf">test_f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">y</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
<p>The ANF corresponding to the Python code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span>
    <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">y</span> <span class="ow">in</span>
    <span class="n">let</span> <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span> <span class="ow">in</span>
        <span class="n">ret</span> <span class="n">end</span> <span class="ow">in</span>
    <span class="n">let</span> <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span>
    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="o">%</span><span class="mi">1</span> <span class="ow">in</span>
    <span class="n">c</span> <span class="n">end</span>
</pre></div>
</div>
<p>The corresponding MindIR is <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/note/source_en/design/images/ir/ir.dot">ir.dot</a>.</p>
<p><img alt="image" src="../_images/ir.png" /></p>
<p>In a MindIR, a function graph (FuncGraph) indicates the definition of a common function. A directed acyclic graph (DAG) usually consists of ParameterNode, ValueNode, and CNode, which clearly shows the calculation process from parameters to return values. As shown in the preceding figure, the <code class="docutils literal notranslate"><span class="pre">test_f</span></code> and <code class="docutils literal notranslate"><span class="pre">func</span></code> functions in the Python code are converted into two function graphs. The <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> parameters are converted into ParameterNode in the function graphs, and each expression is converted into a CNode. The first input of CNode links to the called functions, for example, <code class="docutils literal notranslate"><span class="pre">add</span></code>, <code class="docutils literal notranslate"><span class="pre">func</span></code>, and <code class="docutils literal notranslate"><span class="pre">return</span></code> in the figure. It should be noted that these nodes are all <code class="docutils literal notranslate"><span class="pre">ValueNode</span></code> because they are considered as constant function values. Other input of CNode links to the called parameters. The parameter values can be obtained from the ParameterNode, ValueNode, and other CNode.</p>
<p>In the ANF, each expression is bound as a variable by using the let expression, and the dependency on the expression output is represented by referencing the variable. In the MindIR, each expression is bound as a node, and the dependency is represented by using the directed edges between nodes.</p>
</section>
<section id="saving-ir">
<h2>Saving IR<a class="headerlink" href="#saving-ir" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">context.set_context(save_graphs=True)</span></code> is used to save the intermediate code in each compilation phase. The intermediate code can be saved in two formats. One is the text format with the suffix <code class="docutils literal notranslate"><span class="pre">.ir</span></code>, and the other is the graphical format with the suffix <code class="docutils literal notranslate"><span class="pre">.dot</span></code>. When the network scale is small, you are advised to use the graphical format that is more intuitive. When the network scale is large, you are advised to use the text format that is more efficient.</p>
<p>You can run the graphviz command to convert a .dot file to the picture format. For example, you can run the <code class="docutils literal notranslate"><span class="pre">dot</span> <span class="pre">-Tpng</span> <span class="pre">*.dot</span> <span class="pre">-o</span> <span class="pre">*.png</span></code> command to convert a .dot file to a .png file.</p>
<p>Add the following code to <code class="docutils literal notranslate"><span class="pre">train.py</span></code>, When running the script, MindSpore will automatically store the IR files generated during compilation under the specified path.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_graphs_path</span><span class="o">=</span><span class="s2">&quot;path/to/ir/files&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we run the training script on stand-alone computing device. When running on multiple computing devices, MindSpore will generate separate processes for each computing device. So, in multiple computing devices scenario, you are advised to read the ID of the current computing device from the training script and set an independent <code class="docutils literal notranslate"><span class="pre">save_graphs_path</span></code> for each decive to save the IR files to a different path. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">device_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEVICE_ID&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_graphs_path</span><span class="o">=</span><span class="s2">&quot;path/to/ir/files&quot;</span><span class="o">+</span><span class="n">device_id</span><span class="p">)</span>
</pre></div>
</div>
<p>After the training command is executed, the following files are generated in the specified directory: the IR files starting with digits and underscores are generated during the ME diagram compilation. The calculation diagram is saved in each phase of the <code class="docutils literal notranslate"><span class="pre">pipeline</span></code>. Let’s see the important phases, For examples, the <code class="docutils literal notranslate"><span class="pre">parse</span></code> phase parses the <code class="docutils literal notranslate"><span class="pre">construct</span></code> function of the entrance. The <code class="docutils literal notranslate"><span class="pre">symbol_resolve</span></code> phase recursively parses other functions and objects directly or indirectly referenced by the entry function. The <code class="docutils literal notranslate"><span class="pre">abstract_specialize</span></code> phase, type derivation and <code class="docutils literal notranslate"><span class="pre">shape</span></code> derivation are performed. The <code class="docutils literal notranslate"><span class="pre">optimize</span></code> phase, hardware-independent optimization is performed, The automatic differential and automatic parallel functions are also performed. The <code class="docutils literal notranslate"><span class="pre">validate</span></code> phase, the compiled compute graph is verified. The <code class="docutils literal notranslate"><span class="pre">task_emit</span></code> phase, the computing graph is transferred to the backend for further processing. The calculation graph is executed in the <code class="docutils literal notranslate"><span class="pre">execute</span></code> phase.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>.
├── 00_parse_[xxxx].ir
├── 00_parse.dat
├── 00_parse.dot
├── 01_symbol_resolve_[xxxx].ir
├── 01_symbol_resolve.dat
├── 01_symbol_resolve.dot
├── 02_combine_like_graphs_[xxxx].ir
├── 02_combine_like_graphs.dat
├── 02_combine_like_graphs.dot
├── 03_inference_opt_prepare_[xxxx].ir
├── 03_inference_opt_prepare.dat
├── 03_inference_opt_prepare.dot
├── 04_abstract_specialize_[xxxx].ir
├── 04_abstract_specialize.dat
├── 04_abstract_specialize.dot
├── 05_inline_[xxxx].ir
├── 05_inline.dat
├── 05_inline.dot
├── 06_py_pre_ad_[xxxx].ir
├── 06_py_pre_ad.dat
├── 06_py_pre_ad.dot
├── 07_pipeline_split_[xxxx].ir
├── 07_pipeline_split.dat
├── 07_pipeline_split.dot
├── 08_optimize_[xxxx].ir
├── 08_optimize.dat
├── 08_optimize.dot
├── 09_py_opt_[xxxx].ir
├── 09_py_opt.dat
├── 09_py_opt.dot
├── 10_validate_[xxxx].ir
├── 10_validate.dat
├── 10_validate.dot
├── 11_task_emit_[xxxx].ir
├── 11_task_emit.dat
├── 11_task_emit.dot
├── 12_execute_[xxxx].ir
├── 12_execute.dat
├── 12_execute.dot
...
</pre></div>
</div>
</section>
<section id="ir-file-contents-introduction">
<h2>IR File Contents Introduction<a class="headerlink" href="#ir-file-contents-introduction" title="Permalink to this headline"></a></h2>
<p>The following is an example to describe the contents of the IR file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.context</span> <span class="k">as</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;Ascend&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_graphs_path</span><span class="o">=</span><span class="s2">&quot;./ir_files&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<p>Use a text editing software (for example, vi) to open the <code class="docutils literal notranslate"><span class="pre">12_execute_[xxxx].ir</span></code> file. The file contents are as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> 1 #IR entry      : @6_5_1_construct_wrapper.15
 2 #attrs         :
 3 check_set_strategy_valid_once_only : 1
 4 #Total params  : 2
 5
 6 %para1_x : &lt;Tensor[Float32]x[const vector][]&gt;
 7 %para2_y : &lt;Tensor[Float32]x[const vector][]&gt;
 8
 9 #Total subgraph : 1
10
11 subgraph attr:
12 check_set_strategy_valid_once_only : 1
13 subgraph @6_5_1_construct_wrapper.15() {
14   %0([CNode]8) = Add(%para1_x, %para2_y) primitive_attrs: {output_names: [output], input_names: [x, y]}
15       : (&lt;Tensor[Float32]x[const vector][]&gt;, &lt;Tensor[Float32]x[const vector][]&gt;) -&gt; (&lt;Tensor[Float32]x[const vector][]&gt;)
16       # In file /home/workspace/mindspore/mindspore/ops/composite/multitype_ops/add_impl.py(129)/    return F.add(x, y)/
17       # In file demo.py(14)/        x = x + y/
18   %1([CNode]10) = Mul(%0, %para2_y) primitive_attrs: {output_names: [output], input_names: [x, y]}
19       : (&lt;Tensor[Float32]x[const vector][]&gt;, &lt;Tensor[Float32]x[const vector][]&gt;) -&gt; (&lt;Tensor[Float32]x[const vector][]&gt;)
20       # In file /home/workspace/mindspore/mindspore/ops/composite/multitype_ops/mul_impl.py(48)/    return F.tensor_mul(x, y)/
21       # In file demo.py(15)/        x = x * y/
22   return(%1)
23       : (&lt;Tensor[Float32]x[const vector][]&gt;)
24 }
</pre></div>
</div>
<p>The above contents can be divided into two parts, the first part is the input list and the second part is the graph structure. The first line tells us the name of the top MindSpore graph about the network, <code class="docutils literal notranslate"><span class="pre">&#64;6_5_1_construct_wrapper.15</span></code>, or the entry graph. Line 4 tells us how many inputs are in the network. Line 6 to 7 are the input list, which is in the format of <code class="docutils literal notranslate"><span class="pre">%para[No.]_[name]</span> <span class="pre">:</span> <span class="pre">&lt;[data_type]x[shape]&gt;</span></code>. Line 9 tells us the number of subgraphs parsed by the network. Line 11 to 24 indicate the graph structure, which contains several nodes, namely, <code class="docutils literal notranslate"><span class="pre">CNode</span></code>. In this example, there are only two nodes: <code class="docutils literal notranslate"><span class="pre">Add</span></code> in row 14 and <code class="docutils literal notranslate"><span class="pre">Mul</span></code> in row 18.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CNode</span></code> information format is as follows: including the node name, attribute, input node, output information, format, and source code parsing call stack. The ANF diagram is a unidirectional acyclic graph. So, the connection between nodes is displayed only based on the input relationshape. The source code parsing call stack reflects the relationship between the <code class="docutils literal notranslate"><span class="pre">CNode</span></code> and the script source code. For example, line 20 is parsed from line 21, and line 21 corresponds to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">x</span> <span class="pre">*</span> <span class="pre">y</span></code> of the script.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>  %[No.]([debug_name]) = [OpName]([arg], ...) primitive_attrs: {[key]: [value], ...}
      : (&lt;[input data_type]x[input shape]&gt;, ...) -&gt; (&lt;[output data_type]x[output shape]&gt;, ...)
      # Call stack for source code parsing
</pre></div>
</div>
<blockquote>
<div><p>After several optimizations by the compiler, the node may undergo several changes (such as operator splitting and operator merging). The source code parsing call stack information of the node may not be in a one-to-one correspondence with the script. This is only an auxiliary method.</p>
</div></blockquote>
</section>
<section id="function-style-semantics">
<h2>Function-style Semantics<a class="headerlink" href="#function-style-semantics" title="Permalink to this headline"></a></h2>
<p>Compared with traditional computational graphs, MindIR can not only express data dependency between operators, but also express rich function-style semantics.</p>
<section id="higher-order-functions">
<h3>Higher-Order Functions<a class="headerlink" href="#higher-order-functions" title="Permalink to this headline"></a></h3>
<p>In a MindIR, a function is defined by a subgraph. However, the function itself can be transferred as the input or output of other higher-order functions.
In the following simple example, the <code class="docutils literal notranslate"><span class="pre">f</span></code> function is transferred as a parameter into the <code class="docutils literal notranslate"><span class="pre">g</span></code> function. Therefore, the <code class="docutils literal notranslate"><span class="pre">g</span></code> function is a higher-order function that receives function input, and the actual call site of the <code class="docutils literal notranslate"><span class="pre">f</span></code> function is inside the <code class="docutils literal notranslate"><span class="pre">g</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ms_function</span>
<span class="k">def</span> <span class="nf">hof</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>The corresponding MindIR is <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/note/source_en/design/images/ir/hof.dot">hof.dot</a>.
<img alt="image" src="../_images/hof.png" /></p>
<p>In the actual network training scripts, the automatic derivation generic function <code class="docutils literal notranslate"><span class="pre">GradOperation</span></code> and <code class="docutils literal notranslate"><span class="pre">Partial</span></code> and <code class="docutils literal notranslate"><span class="pre">HyperMap</span></code> that are commonly used in the optimizer are typical high-order functions. Higher-order semantics greatly improve the flexibility and simplicity of MindSpore representations.</p>
</section>
<section id="control-flows">
<h3>Control Flows<a class="headerlink" href="#control-flows" title="Permalink to this headline"></a></h3>
<p>In a MindIR, control flows are expressed in the form of high-order function selection and calling. This form transforms a control flow into a data flow of higher-order functions, making the automatic differential algorithm more powerful. It not only supports automatic differentiation of data flows, but also supports automatic differentiation of control flows such as conditional jumps, loops, and recursion.</p>
<p>The following uses a simple Fibonacci instance as an example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ms_function</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The corresponding MindIR is <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/note/source_en/design/images/ir/cf.dot">cf.dot</a>.
<img alt="image" src="../_images/cf.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">fibonacci</span></code> is a top-level function graph. Two function graphs at the top level are selected and called by <code class="docutils literal notranslate"><span class="pre">switch</span></code>. <code class="docutils literal notranslate"><span class="pre">✓fibonacci</span></code> is the True branch of the first <code class="docutils literal notranslate"><span class="pre">if</span></code>, and <code class="docutils literal notranslate"><span class="pre">✗fibonacci</span></code> is the False branch of the first <code class="docutils literal notranslate"><span class="pre">if</span></code>. <code class="docutils literal notranslate"><span class="pre">✓✗fibonacci</span></code> called in <code class="docutils literal notranslate"><span class="pre">✗fibonacci</span></code> is the True branch of <code class="docutils literal notranslate"><span class="pre">elif</span></code>, and <code class="docutils literal notranslate"><span class="pre">✗✗fibonacci</span></code> is the False branch of <code class="docutils literal notranslate"><span class="pre">elif</span></code>. The key is, in a MindIR, conditional jumps and recursion are represented in the form of higher-order control flows. For example, <code class="docutils literal notranslate"><span class="pre">✓✗fibonacci</span></code> and <code class="docutils literal notranslate"><span class="pre">✗fibonacci</span></code> are transferred in as parameters of the <code class="docutils literal notranslate"><span class="pre">switch</span></code> operator. <code class="docutils literal notranslate"><span class="pre">switch</span></code> selects a function as the return value based on the condition parameter. In this way, <code class="docutils literal notranslate"><span class="pre">switch</span></code> performs a binary selection operation on the input functions as common values and does not call the functions. The real function call is completed on CNode following <code class="docutils literal notranslate"><span class="pre">switch</span></code>.</p>
</section>
<section id="free-variables-and-closures">
<h3>Free Variables and Closures<a class="headerlink" href="#free-variables-and-closures" title="Permalink to this headline"></a></h3>
<p>Closure is a programming language feature that refers to the combination of code blocks and scope environment. A free variable refers to a variable in the scope environment referenced in a code block instead of a local variable. In a MindIR, a code block is represented as a function graph. The scope environment can be considered as the context where the function is called. The capture method of free variables is value copy instead of reference.</p>
<p>A typical closure instance is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ms_function</span>
<span class="k">def</span> <span class="nf">func_outer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func_inner</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">func_inner</span>

<span class="nd">@ms_function</span>
<span class="k">def</span> <span class="nf">ms_closure</span><span class="p">():</span>
    <span class="n">closure</span> <span class="o">=</span> <span class="n">func_outer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">closure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">closure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out1</span><span class="p">,</span> <span class="n">out2</span>
</pre></div>
</div>
<p>The corresponding MindIR is <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/note/source_en/design/images/ir/closure.dot">closure.dot</a>.
<img alt="image" src="../_images/closure.png" /></p>
<p>In the example, <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are free variables because the variables <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> in <code class="docutils literal notranslate"><span class="pre">func_inner</span></code> are parameters defined in the referenced parent graph <code class="docutils literal notranslate"><span class="pre">func_outer</span></code>. The variable <code class="docutils literal notranslate"><span class="pre">closure</span></code> is a closure, which is the combination of the function <code class="docutils literal notranslate"><span class="pre">func_inner</span></code> and its context <code class="docutils literal notranslate"><span class="pre">func_outer(1,</span> <span class="pre">2)</span></code>. Therefore, the result of <code class="docutils literal notranslate"><span class="pre">out1</span></code> is 4, which is equivalent to <code class="docutils literal notranslate"><span class="pre">1+2+1</span></code>, and the result of <code class="docutils literal notranslate"><span class="pre">out2</span></code> is 5, which is equivalent to <code class="docutils literal notranslate"><span class="pre">1+2+2</span></code>.</p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline"></a></h2>
<p>[1] C. Click and M. Paleczny. A simple graph-based intermediate representation.
SIGPLAN Not., 30:35–49, March 1995.</p>
<p>[2] Roland Leißa, Marcel Köster, and Sebastian Hack. A graph-based higher-order intermediate
representation. In Proceedings of the 13th Annual IEEE/ACM International Symposium on
Code Generation and Optimization, pages 202–212. IEEE Computer Society, 2015.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="technical_white_paper.html" class="btn btn-neutral float-left" title="Technical White Paper" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="distributed_training_design.html" class="btn btn-neutral float-right" title="Distributed Training Design" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>