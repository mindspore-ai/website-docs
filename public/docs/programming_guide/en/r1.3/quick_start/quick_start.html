<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementing an Image Classification Application &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hands-on Installation and Experience" href="quick_video.html" />
    <link rel="prev" title="Implementing Simple Linear Function Fitting" href="linear_regression.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Overall Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_structure.html">MindSpore API Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="linear_regression.html">Implementing Simple Linear Function Fitting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementing an Image Classification Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Preparations">Preparations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Downloading-the-Dataset">Downloading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Importing-Python-Libraries-and-Modules">Importing Python Libraries and Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Configuring-the-Running-Information">Configuring the Running Information</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Processing-Data">Processing Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Defining-the-Dataset-and-Data-Operations">Defining the Dataset and Data Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Viewing-Enhanced-Data">Viewing Enhanced Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Defining-the-Network">Defining the Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Custom-Callback-Function-to-Collect-the-Model-Loss-Value-and-Precision-Value">Custom Callback Function to Collect the Model Loss Value and Precision Value</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Defining-the-Loss-Function-and-Optimizer">Defining the Loss Function and Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Training-the-Network">Training the Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Checking-the-Loss-Value-of-the-Model-with-the-Change-of-Training-Steps">Checking the Loss Value of the Model with the Change of Training Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Validating-the-Model">Validating the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Inference-and-Prediction">Inference and Prediction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quick_video.html">Hands-on Installation and Experience</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basic Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dtype.html">dtype</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tensor.html">Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cell.html">Cell</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Numpy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../numpy.html">NumPy Interfaces in MindSpore</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Execution Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../context.html">Configuring Running Information</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Pipeline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dataset_sample.html">Quick Start of Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset.html">Loading Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline.html">Processing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset_advanced.html">Advanced Usage of Pipeline</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Build the Network</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../initializer.html">Initialization of Network Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameter.html">Updating Network Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../layer.html">Model Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../loss.html">Loss Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optim.html">Optimization Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom_net.html">Building a Customized Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network_component.html">Common Network Components</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Train Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../run.html">Running Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callback.html">Callback Mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../save_model.html">Saving Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../load_model_for_inference_and_transfer.html">Loading a Model for Inference and Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../train.html">Advanced Usage of Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../multi_platform_inference.html">Inference Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_platform_inference_ascend_910.html">Inference on the Ascend 910 AI processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_platform_inference_ascend_310.html">Inference on Ascend 310</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_platform_inference_gpu.html">Inference on a GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi_platform_inference_cpu.html">Inference on a CPU</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Distributed Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../distributed_training.html">Distributed Training Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed_training_ascend.html">Parallel Distributed Training (Ascend)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed_training_gpu.html">Distributed Parallel Training (GPU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_pipeline_parallel.html">Pipeline Parallelism Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_host_device_training.html">Applying Host&amp;Device Hybrid Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_parameter_server_training.html">Training with Parameter Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../save_load_model_hybrid_parallel.html">Saving and Loading Models in Hybrid Parallel Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed_inference.html">Distributed Inference With Multi Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_parallel.html">Parallel Distributed Training Interfaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Function Debugging</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../debug_in_pynative_mode.html">Debugging in PyNative Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dump_in_graph_mode.html">Using Dump in the Graph Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom_debugging_info.html">Custom Debugging Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../evaluate_the_model_during_training.html">Evaluating the Model during Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incremental_operator_build.html">Incremental Operator Build</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Performance Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimize_data_processing.html">Optimizing the Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../enable_mixed_precision.html">Enabling Mixed Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../enable_graph_kernel_fusion.html">Enabling Graph Kernel Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_gradient_accumulation.html">Applying a Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_quantization_aware_training.html">Applying Quantization Aware Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apply_post_training_quantization.html">Applying Post Training Quantization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cv.html">Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp.html">Natural Language Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc.html">High Performance Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use_on_the_cloud.html">Using MindSpore on the Cloud</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Implementing an Image Classification Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/quick_start/quick_start.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Implementing-an-Image-Classification-Application">
<h1>Implementing an Image Classification Application<a class="headerlink" href="#Implementing-an-Image-Classification-Application" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Windows</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">CPU</span></code> <code class="docutils literal notranslate"><span class="pre">Whole</span> <span class="pre">Process</span></code> <code class="docutils literal notranslate"><span class="pre">Beginner</span></code> <code class="docutils literal notranslate"><span class="pre">Intermediate</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code></p>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/mindspore/programming_guide/source_en/quick_start/quick_start.ipynb"><img alt="image0" src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r1.3/programming_guide/en/mindspore_quick_start.ipynb"><img alt="image1" src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_notebook.png" /></a> <a class="reference external" href="https://authoring-modelarts-cnnorth4.huaweicloud.com/console/lab?share-url-b64=aHR0cHM6Ly9taW5kc3BvcmUtd2Vic2l0ZS5vYnMuY24tbm9ydGgtNC5teWh1YXdlaWNsb3VkLmNvbS9ub3RlYm9vay9yMS4zL3Byb2dyYW1taW5nX2d1aWRlL2VuL21pbmRzcG9yZV9xdWlja19zdGFydC5pcHluYg==&amp;imageid=65f636a0-56cf-49df-b941-7d2a07ba8c8c"><img alt="image2" src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_modelarts.png" /></a></p>
<section id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline"></a></h2>
<p>This document uses a practice example to demonstrate the basic functions of MindSpore. For common users, it takes 20 to 30 minutes to complete the practice.</p>
<p>During the practice, a simple image classification function is implemented. The overall process is as follows:</p>
<ol class="arabic simple">
<li><p>Process the required dataset. The MNIST dataset is used in this example.</p></li>
<li><p>Define a network. The LeNet network is used in this example.</p></li>
<li><p>The loss value and precision value of the model collected by the custom callback function.</p></li>
<li><p>Define the loss function and optimizer.</p></li>
<li><p>Load the dataset and perform training. After the training is complete, check the result and save the model file.</p></li>
<li><p>Load the saved model for inference.</p></li>
<li><p>Validate the model, load the test dataset and trained model, and validate the result accuracy.</p></li>
</ol>
<p>This is a simple and basic application process. Other advanced and complex applications can be extended based on this basic process.</p>
<blockquote>
<div><p>This document is applicable to CPU, GPU and Ascend environments.</p>
<p>You can find the complete executable sample code at <a class="reference external" href="https://gitee.com/mindspore/docs/tree/r1.3/docs/sample_code/lenet">https://gitee.com/mindspore/docs/tree/r1.3/docs/sample_code/lenet</a>.</p>
</div></blockquote>
</section>
<section id="Preparations">
<h2>Preparations<a class="headerlink" href="#Preparations" title="Permalink to this headline"></a></h2>
<p>Before you start, check whether MindSpore has been correctly installed. If not, install MindSpore on your computer by visiting <a class="reference external" href="https://www.mindspore.cn/install/en">MindSpore installation page</a>.</p>
<p>In addition, you shall have basic mathematical knowledge such as Python coding basics, probability, and matrix.</p>
<p>Start your MindSpore experience now.</p>
<section id="Downloading-the-Dataset">
<h3>Downloading the Dataset<a class="headerlink" href="#Downloading-the-Dataset" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> dataset used in this example consists of 10 classes of 28 x 28 pixels grayscale images. It has a training set of 60,000 examples, and a test set of 10,000 examples.</p>
<p>Execute the following command in jupyter notebook to download the MNIST dataset.</p>
<blockquote>
<div><p>Download the MNIST dataset at <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>. This page provides four download links of dataset files. The first two links are required for data training, and the last two links are required for data test.</p>
</div></blockquote>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>./datasets/MNIST_Data/train<span class="w"> </span>./datasets/MNIST_Data/test
<span class="o">!</span>wget<span class="w"> </span>-NP<span class="w"> </span>./datasets/MNIST_Data/train<span class="w"> </span>https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/train-labels-idx1-ubyte<span class="w"> </span>--no-check-certificate
<span class="o">!</span>wget<span class="w"> </span>-NP<span class="w"> </span>./datasets/MNIST_Data/train<span class="w"> </span>https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/train-images-idx3-ubyte<span class="w"> </span>--no-check-certificate
<span class="o">!</span>wget<span class="w"> </span>-NP<span class="w"> </span>./datasets/MNIST_Data/test<span class="w"> </span>https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/t10k-labels-idx1-ubyte<span class="w"> </span>--no-check-certificate
<span class="o">!</span>wget<span class="w"> </span>-NP<span class="w"> </span>./datasets/MNIST_Data/test<span class="w"> </span>https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/t10k-images-idx3-ubyte<span class="w"> </span>--no-check-certificate
<span class="o">!</span>tree<span class="w"> </span>./datasets/MNIST_Data
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./datasets/MNIST_Data
├── test
│   ├── t10k-images-idx3-ubyte
│   └── t10k-labels-idx1-ubyte
└── train
    ├── train-images-idx3-ubyte
    └── train-labels-idx1-ubyte

2 directories, 4 files
</pre></div></div>
</div>
</section>
<section id="Importing-Python-Libraries-and-Modules">
<h3>Importing Python Libraries and Modules<a class="headerlink" href="#Importing-Python-Libraries-and-Modules" title="Permalink to this headline"></a></h3>
<p>Before start, you need to import Python libraries.</p>
<p>Currently, only the <code class="docutils literal notranslate"><span class="pre">os</span></code> library is required. Other libraries are not described here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<p>For details about MindSpore modules, search on the <a class="reference external" href="https://www.mindspore.cn/docs/api/en/r1.3/index.html">MindSpore API Page</a>.</p>
</section>
<section id="Configuring-the-Running-Information">
<h3>Configuring the Running Information<a class="headerlink" href="#Configuring-the-Running-Information" title="Permalink to this headline"></a></h3>
<p>Before compiling code, you need to learn basic information about the hardware and backend required for MindSpore running.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code> to configure the information required for running, such as the running mode, backend information, and hardware information.</p>
<p>Import the <code class="docutils literal notranslate"><span class="pre">context</span></code> module and configure the required information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This example runs in graph mode. You can configure hardware information based on actual requirements. For example, if the code runs on the Ascend AI processor, set <code class="docutils literal notranslate"><span class="pre">--device_target</span></code> to <code class="docutils literal notranslate"><span class="pre">Ascend</span></code>. This rule also applies to the code running on the CPU and GPU. For details about parameters, see the API description for <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code>.</p>
</section>
</section>
<section id="Processing-Data">
<h2>Processing Data<a class="headerlink" href="#Processing-Data" title="Permalink to this headline"></a></h2>
<p>Datasets are important for training. A good dataset can effectively improve training accuracy and efficiency. Generally, before loading a dataset, you need to perform some operations on the dataset.</p>
<p>A convolutional neural network such as LeNet is used to train the dataset. During data training, the data format is required. Therefore, you need to check the data in the dataset first. In this way, a targeted data conversion function can be constructed to convert the data in the dataset into a data format that meets the training requirements.</p>
<p>Execute the following code to view the original dataset data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>

<span class="n">train_data_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data/train&quot;</span>
<span class="n">test_data_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data/test&quot;</span>
<span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">train_data_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The type of mnist_ds:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">mnist_ds</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of pictures contained in the mnist_ds：&quot;</span><span class="p">,</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>

<span class="n">dic_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
<span class="n">item</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dic_ds</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The item of mnist_ds:&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensor of image in item:&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The label of item:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;number:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The type of mnist_ds: &lt;class &#39;mindspore.dataset.engine.datasets.MnistDataset&#39;&gt;
Number of pictures contained in the mnist_ds： 60000
The item of mnist_ds: dict_keys([&#39;image&#39;, &#39;label&#39;])
Tensor of image in item: (28, 28, 1)
The label of item: 9
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_10_1.png" src="../_images/quick_start_quick_start_10_1.png" />
</div>
</div>
<p>From the above operation, we can see that the training datasets <code class="docutils literal notranslate"><span class="pre">train-images-idx3-ubyte</span></code> and <code class="docutils literal notranslate"><span class="pre">train-labels-idx1-ubyte</span></code> correspond to 60,000 images and 60,000 digital labels. After loading the data, the dictionary data set is converted by <code class="docutils literal notranslate"><span class="pre">create_dict_iterator</span></code>. View one of the data, which is a dictionary with keys <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code>. The tensor of <code class="docutils literal notranslate"><span class="pre">image</span></code> (height: 28; width: 28; channel: 1) and <code class="docutils literal notranslate"><span class="pre">label</span></code> are numbers corresponding to the image.</p>
<section id="Defining-the-Dataset-and-Data-Operations">
<h3>Defining the Dataset and Data Operations<a class="headerlink" href="#Defining-the-Dataset-and-Data-Operations" title="Permalink to this headline"></a></h3>
<p>Define the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function to create a dataset. In this function, define the data augmentation and processing operations to be performed.</p>
<ol class="arabic simple">
<li><p>Define the dataset.</p></li>
<li><p>Define parameters required for data augmentation and processing.</p></li>
<li><p>Generate corresponding data augmentation operations according to the parameters.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">map</span></code> mapping function to apply data operations to the dataset.</p></li>
<li><p>Process the generated dataset.</p></li>
</ol>
<p>After the definition is completed, use <code class="docutils literal notranslate"><span class="pre">create_datasets</span></code> to perform data augmentation on the original data, and extract a <code class="docutils literal notranslate"><span class="pre">batch</span></code> of data to view the changes after data augmentation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset.vision.c_transforms</span> <span class="k">as</span> <span class="nn">CV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.vision</span> <span class="kn">import</span> <span class="n">Inter</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>


<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataset for train or test</span>

<span class="sd">    Args:</span>
<span class="sd">        data_path (str): Data path</span>
<span class="sd">        batch_size (int): The number of data records in each group</span>
<span class="sd">        repeat_size (int): The number of replicated data records</span>
<span class="sd">        num_parallel_workers (int): The number of parallel workers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># define some parameters needed for data enhancement and rough justification</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">rescale_nml</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.3081</span>
    <span class="n">shift_nml</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mf">0.1307</span> <span class="o">/</span> <span class="mf">0.3081</span>

    <span class="c1"># according to the parameters, generate the corresponding data enhancement method</span>
    <span class="n">resize_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">Inter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
    <span class="n">rescale_nml_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale_nml</span><span class="p">,</span> <span class="n">shift_nml</span><span class="p">)</span>
    <span class="n">rescale_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">hwc2chw_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># using map to apply operations to a dataset</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">resize_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_nml_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">hwc2chw_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>

    <span class="c1"># process the generated dataset</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="n">ms_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">train_data_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of groups in the dataset:&#39;</span><span class="p">,</span> <span class="n">ms_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of groups in the dataset: 1875
</pre></div></div>
</div>
<p>After the data augmentation function is called, the dataset <code class="docutils literal notranslate"><span class="pre">size</span></code> changes from 60000 to 1875, which meets the expectations of the <code class="docutils literal notranslate"><span class="pre">mnist_ds.batch</span></code> operation in data augmentation (<span class="math notranslate nohighlight">\(60000/32=1875\)</span>).</p>
<p>In the preceding augmentation process:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">label</span></code> data enhancement operation in the dataset:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">C.TypeCast</span></code>: Convert the data type to <code class="docutils literal notranslate"><span class="pre">int32</span></code>.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">image</span></code> data enhancement operation in the dataset:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">datasets.MnistDataset</span></code>: Convert the dataset into MindSpore trainable data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.Resize</span></code>: Resize image data pixels to meet the data size requirements of the LeNet network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.Rescale</span></code>: Standardize and normalize image data so that the value of each pixel is in the range (0,1), which can improve training efficiency.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.HWC2CHW</span></code>: Transform the image data tensor, the tensor form is changed from <code class="docutils literal notranslate"><span class="pre">height</span> <span class="pre">x</span> <span class="pre">width</span> <span class="pre">x</span> <span class="pre">channel</span></code> (HWC) to <code class="docutils literal notranslate"><span class="pre">channel</span> <span class="pre">x</span> <span class="pre">height</span> <span class="pre">x</span> <span class="pre">width</span></code> (CHW), which is convenient for data training.</p></li>
</ul>
</li>
<li><p>Other enhancement operations:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.shuffle</span></code>: Randomly store data in a memory that can hold 10,000 images for shuffle.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.batch</span></code>: Extract 32 images from the shuffled 10,000 image addresses to form a <code class="docutils literal notranslate"><span class="pre">batch</span></code>, the parameter <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> indicates the number of data contained in each group, and each group is now set to contain 32 data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.repeat</span></code>: The <code class="docutils literal notranslate"><span class="pre">batch</span></code> data is replicated and enhanced. The parameter <code class="docutils literal notranslate"><span class="pre">repeat_size</span></code> indicates the number of replicated datasets.</p></li>
</ul>
</li>
</ul>
<p>Perform the <code class="docutils literal notranslate"><span class="pre">shuffle</span></code> and <code class="docutils literal notranslate"><span class="pre">batch</span></code> operations, and then perform the <code class="docutils literal notranslate"><span class="pre">repeat</span></code> operation to ensure that data is unique during one <code class="docutils literal notranslate"><span class="pre">epoch</span></code>.</p>
<blockquote>
<div><p>MindSpore supports multiple data processing and augmentation operations, which are usually used in combined. For details, see section <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/dataset_sample.html">Data Processing</a> and <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/augmentation.html">Data Augmentation</a> in the MindSpore tutorials.</p>
</div></blockquote>
</section>
<section id="Viewing-Enhanced-Data">
<h3>Viewing Enhanced Data<a class="headerlink" href="#Viewing-Enhanced-Data" title="Permalink to this headline"></a></h3>
<p>Obtain a group of data from the 1875 groups of data and view the data tensor and <code class="docutils literal notranslate"><span class="pre">label</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ms_dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">(</span><span class="n">output_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tensor of image:&#39;</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Tensor of image: (32, 1, 32, 32)
Labels: [5 5 6 4 7 0 1 2 2 8 7 4 3 3 6 5 8 9 6 6 9 7 9 8 2 9 0 2 4 3 9 3]
</pre></div></div>
</div>
<p>Visualize the tensor data and the value corresponding to <code class="docutils literal notranslate"><span class="pre">label</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;num:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">labels</span>[count-1])
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_18_0.png" src="../_images/quick_start_quick_start_18_0.png" />
</div>
</div>
<p>Through the above query operation, you can see the transformed images. The dataset is divided into 1875 groups of data. Each group of data contains 32 images. The resolution of each image is 32 x 32. After all the data is prepared, you can proceed to the next step of data training.</p>
</section>
</section>
<section id="Defining-the-Network">
<h2>Defining the Network<a class="headerlink" href="#Defining-the-Network" title="Permalink to this headline"></a></h2>
<p>The LeNet network is relatively simple. In addition to the input layer, the LeNet network has seven layers, including two convolutional layers, two down-sample layers (pooling layers), and three full connection layers. Each layer contains different numbers of training parameters, as shown in the following figure:</p>
<blockquote>
<div><p>For details about the LeNet network, visit <a class="reference external" href="http://yann.lecun.com/exdb/lenet/">http://yann.lecun.com/exdb/lenet/</a>.</p>
</div></blockquote>
<p>You can initialize the full connection layers and convolutional layers by <code class="docutils literal notranslate"><span class="pre">Normal</span></code>.</p>
<p>MindSpore supports multiple parameter initialization methods, such as <code class="docutils literal notranslate"><span class="pre">TruncatedNormal</span></code>, <code class="docutils literal notranslate"><span class="pre">Normal</span></code>, and <code class="docutils literal notranslate"><span class="pre">Uniform</span></code>, default value is <code class="docutils literal notranslate"><span class="pre">Normal</span></code>. For details, see the description of the <code class="docutils literal notranslate"><span class="pre">mindspore.common.initializer</span></code> module in the MindSpore API.</p>
<p>To use MindSpore for neural network definition, inherit <code class="docutils literal notranslate"><span class="pre">mindspore.nn.Cell</span></code>. <code class="docutils literal notranslate"><span class="pre">Cell</span></code> is the base class of all neural networks (such as <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code>).</p>
<p>Define each layer of a neural network in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method in advance, and then define the <code class="docutils literal notranslate"><span class="pre">construct</span></code> method to complete the forward construction of the neural network. According to the structure of the LeNet network, define the network layers as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">Normal</span>

<span class="k">class</span> <span class="nc">LeNet5</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lenet network structure.&quot;&quot;&quot;</span>
    <span class="c1"># define the operator required</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeNet5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="n">num_class</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>

    <span class="c1"># use the preceding operators to construct networks</span>
    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;layer conv1:&quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">conv1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;layer fc1:&quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">fc1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
layer conv1: Conv2d&lt;input_channels=1, output_channels=6, kernel_size=(5, 5),stride=(1, 1),  pad_mode=valid, padding=0, dilation=(1, 1), group=1, has_bias=Falseweight_init=normal, bias_init=zeros, format=NCHW&gt;
****************************************
layer fc1: Dense&lt;input_channels=400, output_channels=120, has_bias=True&gt;
</pre></div></div>
</div>
<p>After the construction is completed, you can use <code class="docutils literal notranslate"><span class="pre">print(LeNet5())</span></code> to print out all the parameters of each layer in the neural network, or use <code class="docutils literal notranslate"><span class="pre">LeNet().{layer</span> <span class="pre">name}</span></code> to print the corresponding parameter information. This example chooses to print the corresponding parameters of the first convolutional layer and the first fully connected layer.</p>
</section>
<section id="Custom-Callback-Function-to-Collect-the-Model-Loss-Value-and-Precision-Value">
<h2>Custom Callback Function to Collect the Model Loss Value and Precision Value<a class="headerlink" href="#Custom-Callback-Function-to-Collect-the-Model-Loss-Value-and-Precision-Value" title="Permalink to this headline"></a></h2>
<p>Customize a data collection callback class <code class="docutils literal notranslate"><span class="pre">StepLossAccInfo</span></code>, it is used to collect two types of information:</p>
<ol class="arabic simple">
<li><p>Information about the relationship between <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">loss</span></code> values during training;</p></li>
<li><p>Information of each 125 training <code class="docutils literal notranslate"><span class="pre">step</span></code> and corresponding model accuracy value <code class="docutils literal notranslate"><span class="pre">accuracy</span></code>.</p></li>
</ol>
<p>This class inherits the <code class="docutils literal notranslate"><span class="pre">Callback</span></code> class. You can customize operations during training. After the training is completed, the data can be drawn into a graph to view the changes in <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">loss</span></code>, as well as the <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> changes.</p>
<p>The following code will be used as a callback function to be called in the model training function <code class="docutils literal notranslate"><span class="pre">model.train</span></code>. The following visualizes the information collected during the model verification stage.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">Callback</span>

<span class="c1"># custom callback function</span>
<span class="k">class</span> <span class="nc">StepLossAccInfo</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">steps_loss</span><span class="p">,</span> <span class="n">steps_eval</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span> <span class="o">=</span> <span class="n">steps_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span> <span class="o">=</span> <span class="n">steps_eval</span>

    <span class="k">def</span> <span class="nf">step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="n">cb_params</span> <span class="o">=</span> <span class="n">run_context</span><span class="o">.</span><span class="n">original_args</span><span class="p">()</span>
        <span class="n">cur_epoch</span> <span class="o">=</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_epoch_num</span>
        <span class="n">cur_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1875</span> <span class="o">+</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_step_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;loss_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cb_params</span><span class="o">.</span><span class="n">net_outputs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_step</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cur_step</span> <span class="o">%</span> <span class="mi">125</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: computational graph model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eval_dataset</span></code>: validation dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steps_loss</span></code>: Collect the relationship between step and loss value, the data format is <code class="docutils literal notranslate"><span class="pre">{&quot;step&quot;:</span> <span class="pre">[],</span> <span class="pre">&quot;loss_value&quot;:</span> <span class="pre">[]}</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steps_eval</span></code>: Collect information about the model accuracy value <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> corresponding to step, the data format is <code class="docutils literal notranslate"><span class="pre">{&quot;step&quot;:</span> <span class="pre">[],</span> <span class="pre">&quot;acc&quot;:</span> <span class="pre">[]}</span></code>.</p></li>
</ul>
</section>
<section id="Defining-the-Loss-Function-and-Optimizer">
<h2>Defining the Loss Function and Optimizer<a class="headerlink" href="#Defining-the-Loss-Function-and-Optimizer" title="Permalink to this headline"></a></h2>
<p>Before definition, this section briefly describes concepts of loss function and optimizer.</p>
<ul class="simple">
<li><p>Loss function: It is also called objective function and is used to measure the difference between a predicted value and an actual value. Deep learning reduces the value of the loss function by continuous iteration. Defining a good loss function can effectively improve the model performance.</p></li>
<li><p>Optimizer: It is used to minimize the loss function, improving the model during training.</p></li>
</ul>
<p>After the loss function is defined, the weight-related gradient of the loss function can be obtained. The gradient is used to indicate the weight optimization direction for the optimizer, improving model performance.</p>
<p>Loss functions supported by MindSpore include <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code>, <code class="docutils literal notranslate"><span class="pre">L1Loss</span></code>, <code class="docutils literal notranslate"><span class="pre">MSELoss</span></code>. The loss function <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code> is used in this example.</p>
<p>The optimizers supported by MindSpore include <code class="docutils literal notranslate"><span class="pre">Adam</span></code>, <code class="docutils literal notranslate"><span class="pre">AdamWeightDecay</span></code>, <code class="docutils literal notranslate"><span class="pre">Momentum</span></code>, etc. The popular <code class="docutils literal notranslate"><span class="pre">Momentum</span></code> optimizer is used here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">SoftmaxCrossEntropyWithLogits</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span>

<span class="c1"># create the network</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>

<span class="c1"># define the optimizer</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="p">)</span>

<span class="c1"># define the loss function</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Training-the-Network">
<h2>Training the Network<a class="headerlink" href="#Training-the-Network" title="Permalink to this headline"></a></h2>
<p>After completing the construction of the neural network, you can start network training. The network training can be conveniently performed through the <code class="docutils literal notranslate"><span class="pre">Model.train</span></code> interface provided by MindSpore. The parameters mainly include:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">epoch_size</span></code>: specifies the number of batches of images that need to be traversed by each epoch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ds_train</span></code>: specifies the training dataset.</p></li>
<li><p>MindSpore-provided callback mechanism. The callback function <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> contains <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code>, <code class="docutils literal notranslate"><span class="pre">LossMonitor</span></code>, and <code class="docutils literal notranslate"><span class="pre">Callback</span></code> arguments, where <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code> is used to save network models and parameters for performing fine-tuning.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dataset_sink_mode</span></code>: specifies the dataset sink mode. The default value <code class="docutils literal notranslate"><span class="pre">True</span></code> needs to be set to <code class="docutils literal notranslate"><span class="pre">False</span></code> because this mode does not support the CPU computing platform.</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">LossMonitor</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">Accuracy</span>

<span class="n">epoch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">mnist_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data&quot;</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;./models/ckpt/mindspore_quick_start/&quot;</span>

<span class="n">repeat_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="p">)</span>
<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># clean up old run files before in Linux</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -f </span><span class="si">{0}</span><span class="s1">*.ckpt </span><span class="si">{0}</span><span class="s1">*.meta </span><span class="si">{0}</span><span class="s1">*.pb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

<span class="c1"># define the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">net_loss</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">()}</span> <span class="p">)</span>

<span class="c1"># save the network model and parameters for subsequence fine-tuning</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span> <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="c1"># group layers into an object with training and evaluation features</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;checkpoint_lenet&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>

<span class="n">steps_loss</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;loss_value&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">steps_eval</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;acc&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="c1"># collect the steps,loss and accuracy information</span>
<span class="n">step_loss_acc_info</span> <span class="o">=</span> <span class="n">StepLossAccInfo</span><span class="p">(</span><span class="n">model</span> <span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">steps_loss</span><span class="p">,</span> <span class="n">steps_eval</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">,</span> <span class="n">LossMonitor</span><span class="p">(</span><span class="mi">125</span><span class="p">),</span> <span class="n">step_loss_acc_info</span><span class="p">],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch: 1 step: 125, loss is 0.13396409
epoch: 1 step: 250, loss is 0.1545082
epoch: 1 step: 375, loss is 0.12724978
epoch: 1 step: 500, loss is 0.034271903
epoch: 1 step: 625, loss is 0.13005787
epoch: 1 step: 750, loss is 0.010596659
epoch: 1 step: 875, loss is 0.008820764
epoch: 1 step: 1000, loss is 0.09243655
epoch: 1 step: 1125, loss is 0.054233808
epoch: 1 step: 1250, loss is 0.074425355
epoch: 1 step: 1375, loss is 0.005053058
epoch: 1 step: 1500, loss is 0.13170624
epoch: 1 step: 1625, loss is 0.028616104
epoch: 1 step: 1750, loss is 0.12095115
epoch: 1 step: 1875, loss is 0.013343395
</pre></div></div>
</div>
<p>After training, multiple model files will be generated and saved under the pre-set directory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tree<span class="w"> </span><span class="nv">$model_path</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./models/ckpt/mindspore_quick_start/
├── checkpoint_lenet-1_1125.ckpt
├── checkpoint_lenet-1_1500.ckpt
├── checkpoint_lenet-1_1875.ckpt
├── checkpoint_lenet-1_375.ckpt
├── checkpoint_lenet-1_750.ckpt
└── checkpoint_lenet-graph.meta

0 directories, 6 files
</pre></div></div>
</div>
<p>The meaning of the file name: <code class="docutils literal notranslate"><span class="pre">{Customized</span> <span class="pre">name</span> <span class="pre">configured</span> <span class="pre">in</span> <span class="pre">ModelCheckpoint}-{The</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">epoch}-{The</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">step}</span></code>.</p>
<blockquote>
<div><p>To use free control loop iterations, traversing data sets, etc., you can refer to the “Customizing a Training Cycle” part of the official website programming guide “<a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/train.html#customizing-a-training-cycle">Training</a>”.</p>
</div></blockquote>
<section id="Checking-the-Loss-Value-of-the-Model-with-the-Change-of-Training-Steps">
<h3>Checking the Loss Value of the Model with the Change of Training Steps<a class="headerlink" href="#Checking-the-Loss-Value-of-the-Model-with-the-Change-of-Training-Steps" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
<span class="n">loss_value</span> <span class="o">=</span> <span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;loss_value&quot;</span><span class="p">]</span>
<span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">steps</span><span class="p">))</span>
<span class="n">loss_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">loss_value</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">loss_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Steps&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss_value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Change chart of model loss value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_30_0.png" src="../_images/quick_start_quick_start_30_0.png" />
</div>
</div>
<p>Judging from the above, it can be divided into three stages:</p>
<p>Stage 1: When the training starts, the loss value is around 2.2, which indicates that the training performance is not satisfied.</p>
<p>Stage 2: When the training arrives at a certain point, the loss value decreases sharply and the training performance is greatly improved.</p>
<p>Stage 3: After the loss value converges to a small value, it tends to get close to 0. At this point, the training performance is steady and cannot be further improved, leading to the result that the training is terminated.</p>
</section>
</section>
<section id="Validating-the-Model">
<h2>Validating the Model<a class="headerlink" href="#Validating-the-Model" title="Permalink to this headline"></a></h2>
<p>After obtaining the model file, validate the model generalization capability.</p>
<p>The process of building a network for verification is as follows:</p>
<ol class="arabic simple">
<li><p>Load the model by reading the parameter <code class="docutils literal notranslate"><span class="pre">param_dict</span></code> in the <code class="docutils literal notranslate"><span class="pre">.ckpt</span></code> file.</p></li>
<li><p>Load the parameter <code class="docutils literal notranslate"><span class="pre">param_dict</span></code> to the neural network, Lenet.</p></li>
<li><p>Load the test dataset.</p></li>
<li><p>Call the function, <code class="docutils literal notranslate"><span class="pre">model.eval</span></code>, to transfer the parameters of the test dataset, <code class="docutils literal notranslate"><span class="pre">ds_eval</span></code>. Compute the accuracy of <code class="docutils literal notranslate"><span class="pre">checkpoint_lenet-{epoch}_1875.ckpt</span></code></p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>

<span class="c1"># testing relate modules</span>
<span class="k">def</span> <span class="nf">test_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mnist_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define the evaluation method.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Testing ==============&quot;</span><span class="p">)</span>
    <span class="c1"># load the saved model for evaluation</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;./models/ckpt/mindspore_quick_start/checkpoint_lenet-1_1875.ckpt&quot;</span><span class="p">)</span>
    <span class="c1"># load parameter to the network</span>
    <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="c1"># load testing dataset</span>
    <span class="n">ds_eval</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">))</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ds_eval</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Accuracy:</span><span class="si">{}</span><span class="s2"> ==============&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>

<span class="n">test_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mnist_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
============== Starting Testing ==============
============== Accuracy:{&#39;Accuracy&#39;: 0.9758613782051282} ==============
</pre></div></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>：This API is used to load the CheckPoint model parameter file and return a parameter dictionary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_lenet-1_1875.ckpt</span></code>：name of the saved CheckPoint model file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>：This API is used to load parameters to the network.</p></li>
</ul>
<p>When the training step reaches 1875, the accuracy of the model is over 95%, meaning the model performance is good.</p>
<p>We can check the change of the model accuracy as the training step changes.</p>
<p><code class="docutils literal notranslate"><span class="pre">eval_show</span></code> draws the line chart of model accuracy every 25 <code class="docutils literal notranslate"><span class="pre">step</span></code>. In particular, <code class="docutils literal notranslate"><span class="pre">steps_eval</span></code> stores the training step of the model and the corresponding accuracy information.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_show</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step number&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Model accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model accuracy variation chart&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span> <span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">],</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">eval_show</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_34_0.png" src="../_images/quick_start_quick_start_34_0.png" />
</div>
</div>
<p>In the figure, it can be seen that the change of the model accuracy can be divided in three stages:</p>
<p>Stage 1: When the training starts, the model accuracy rises slowly.</p>
<p>Stage 2: At a certain point, the model accuracy rises sharply.</p>
<p>Stage 3: The model accuracy nearly comes to 1 without reaching.</p>
<p>During the training process, as the training data increases, it will have a positive correlation with the model accuracy, but as the accuracy reaches a certain level, the training gains will decrease.</p>
</section>
<section id="Inference-and-Prediction">
<h2>Inference and Prediction<a class="headerlink" href="#Inference-and-Prediction" title="Permalink to this headline"></a></h2>
<p>Apply the trained model to predict a single image or a set of images. The procedure is as follows:</p>
<ol class="arabic simple">
<li><p>Transform the test data to the data that fits LeNet.</p></li>
<li><p>Extract the <code class="docutils literal notranslate"><span class="pre">image</span></code> data.</p></li>
<li><p>Call the function, <code class="docutils literal notranslate"><span class="pre">model.predict</span></code>, to predict the corresponding digit in each <code class="docutils literal notranslate"><span class="pre">image</span></code>. To be noted, <code class="docutils literal notranslate"><span class="pre">predict</span></code> will returns the probability of predicting 0 to 9 for each <code class="docutils literal notranslate"><span class="pre">image</span></code>.</p></li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">plot_pie</span></code> function to display the probability of predictions. Negative probabilities will be removed and not be displayed.</p></li>
</ol>
<p>Load the dataset to be predicted and call the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function to transform the test dataset into required formats. Select a set of 32 images for inference and prediction.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_test</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">test_data_path</span><span class="p">)</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]))</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">err_num</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;pre:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Row </span><span class="si">{}</span><span class="s2">, column </span><span class="si">{}</span><span class="s2"> is incorrectly identified as </span><span class="si">{}</span><span class="s2">, the correct value should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="k">8</span>+1, pred[i], labels[i]), &#39;\n&#39;)
<span class="k">if</span> <span class="n">index</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All the figures in this group are predicted correctly!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s2">&quot;&lt;--Predicted figures&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="s2">&quot;&lt;--The right number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Row 1, column 7 is incorrectly identified as 5, the correct value should be 3

[2 0 1 3 0 0 5 8 7 2 6 2 7 3 1 2 9 5 4 6 0 3 0 8 3 9 5 1 9 6 4 2] &lt;--Predicted figures
[2 0 1 3 0 0 3 8 7 2 6 2 7 3 1 2 9 5 4 6 0 3 0 8 3 9 5 1 9 6 4 2] &lt;--The right number
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_36_1.png" src="../_images/quick_start_quick_start_36_1.png" />
</div>
</div>
<p>Draw a pie chart for probability analysis. In this example, it displays a pie chart for the current <code class="docutils literal notranslate"><span class="pre">batch</span></code> in the first image.</p>
<p><code class="docutils literal notranslate"><span class="pre">prb</span></code> stores the preceding 32 prediction numbers and corresponding output results. The classification result <code class="docutils literal notranslate"><span class="pre">prb[0]</span></code> corresponding to the first image is obtained, and the sigmol formula <span class="math notranslate nohighlight">\(\frac{1}{1+e^{-x}}\)</span> is used to obtain the probability of [0-9] corresponding to the image. The number whose probability value is greater than 0.5 is analyzed in the pie chart.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># define the pie drawing function of probability analysis</span>

<span class="n">prb</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_pie</span><span class="p">(</span><span class="n">prbs</span><span class="p">):</span>
    <span class="n">dict1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># remove the negative number and build the dictionary dict1. The key is the number and the value is the probability value</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dict1</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span> <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%1.1f%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">pctdistance</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image classification&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The probability of corresponding numbers [0-9] in Figure 1:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)),</span> <span class="n">prb</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="n">plot_pie</span><span class="p">(</span><span class="n">prb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The probability of corresponding numbers [0-9] in Figure 1:
 [0.054608213813288335, 0.04007988333681419, 0.9999934046689553, 0.9469836696068331, 0.347608619405929, 0.020873059274634436, 0.0013652782671098932, 0.9990516692085604, 0.39083703602997244, 0.036189847324771866]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/quick_start_quick_start_38_1.png" src="../_images/quick_start_quick_start_38_1.png" />
</div>
</div>
<p>That’s the whole experience of the handwritten number classification application.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="linear_regression.html" class="btn btn-neutral float-left" title="Implementing Simple Linear Function Fitting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="quick_video.html" class="btn btn-neutral float-right" title="Hands-on Installation and Experience" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>