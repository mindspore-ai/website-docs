

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Implementing Regional Ocean Model GOMO &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using MindSpore on the Cloud" href="use_on_the_cloud.html" />
    <link rel="prev" title="High Performance Computing" href="hpc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Overall Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_structure.html">MindSpore API Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="design/technical_white_paper.html">Technical White Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/gradient.html">MindSpore Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/distributed_training_design.html">Distributed Training Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/mindir.html">MindSpore IR (MindIR)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/r1.5/training_visual_design.html">Design of Visualization↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/tutorials/en/r1.5/linear_regression.html">Implementing Simple Linear Function Fitting↗</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/tutorials/en/r1.5/quick_start.html">Implementing an Image Classification Application↗</a></li>
</ul>
<p class="caption"><span class="caption-text">Basic Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dtype.html">DataType</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensor.html">Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter_introduction.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="cell.html">Cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_introduction.html">Dataset</a></li>
</ul>
<p class="caption"><span class="caption-text">Data Pipeline</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dataset_sample.html">Quick Start of Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Loading Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Processing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_advanced.html">Advanced Usage of Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_usage.html">Data Iteration</a></li>
</ul>
<p class="caption"><span class="caption-text">Build the Network</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="build_net.html">Constructing Single Operator Network and Multi-layer Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="initializer.html">Initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Network Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="control_flow.html">Using the Process Control Statement</a></li>
<li class="toctree-l1"><a class="reference internal" href="loss.html">Loss Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="grad_operation.html">Gradient Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="indefinite_parameter.html">Parameter Passing</a></li>
<li class="toctree-l1"><a class="reference internal" href="constexpr.html">Construct Constants In the Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="hypermap.html">Operation Overloading</a></li>
<li class="toctree-l1"><a class="reference internal" href="optim.html">Optimization Algorithms</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Running</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="context.html">Configuring Running Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">Running Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="save_and_load_models.html">Save and Load Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="model.html">Application of Model</a></li>
</ul>
<p class="caption"><span class="caption-text">Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="multi_platform_inference.html">Inference Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="online_inference.html">Online Inference with Checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="offline_inference.html">Using Offline Model for Inference</a></li>
</ul>
<p class="caption"><span class="caption-text">Distributed Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training.html">Distributed Parallel Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_advanced.html">Distributed Parallel Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_example.html">Distributed Parallel Usage Example</a></li>
</ul>
<p class="caption"><span class="caption-text">PyNative</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">Debugging in PyNative Mode</a></li>
</ul>
<p class="caption"><span class="caption-text">Numpy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="numpy.html">NumPy Interfaces in MindSpore</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="second_order_optimizer.html">Second Order Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">Applying Quantization Aware Training</a></li>
</ul>
<p class="caption"><span class="caption-text">Function Debugging</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="read_ir_files.html">Reading IR</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.5/debug_in_pynative_mode.html">Debugging in PyNative Mode↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="dump_in_graph_mode.html">Using Dump in the Graph Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">Custom Debugging Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_operator_build.html">Incremental Operator Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">Enabling Mixed Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">Enabling Graph Kernel Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_tune.html">Enabling AutoTune</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">Applying a Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/r1.5/performance_profiling.html">Debugging performance with Profiler↗</a></li>
</ul>
<p class="caption"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="cv.html">Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">Natural Language Processing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="hpc.html">High Performance Computing</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Implementing Regional Ocean Model GOMO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparations">Preparations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-software-dependencies">Installing Software Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-data">Preparing Data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-data">Loading Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-gomo-grid">Defining GOMO Grid</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#initializing-variables">Initializing Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-gomo-model">Defining GOMO Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#training-grid">Training Grid</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-script">Running Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">Using MindSpore on the Cloud</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="hpc.html">High Performance Computing</a> &raquo;</li>
        
      <li>Implementing Regional Ocean Model GOMO</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/hpc_gomo.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="implementing-regional-ocean-model-gomo">
<h1>Implementing Regional Ocean Model GOMO<a class="headerlink" href="#implementing-regional-ocean-model-gomo" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">High</span> <span class="pre">Performance</span> <span class="pre">Computing</span></code> <code class="docutils literal notranslate"><span class="pre">Whole</span> <span class="pre">Process</span></code></p>
<!-- TOC -->
<ul class="simple">
<li><p><a class="reference external" href="#implementing-regional-ocean-model-gomo">Implementing Regional Ocean Model GOMO</a></p>
<ul>
<li><p><a class="reference external" href="#overview">Overview</a></p></li>
<li><p><a class="reference external" href="#preparations">Preparations</a></p>
<ul>
<li><p><a class="reference external" href="#installing-software-dependencies">Installing Software Dependencies</a></p></li>
<li><p><a class="reference external" href="#preparing-data">Preparing Data</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#loading-data">Loading Data</a></p></li>
<li><p><a class="reference external" href="#defining-gomo-grid">Defining GOMO Grid</a></p>
<ul>
<li><p><a class="reference external" href="#initializing-variables">Initializing Variables</a></p></li>
<li><p><a class="reference external" href="#defining-gomo-model">Defining GOMO Model</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#training-grid">Training Grid</a></p>
<ul>
<li><p><a class="reference external" href="#running-script">Running Script</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#references">References</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><a href="https://gitee.com/mindspore/docs/blob/r1.5/docs/mindspore/programming_guide/source_en/hpc_gomo.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.5/resource/_static/logo_source_en.png"></a>  </p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Generalized Operator Modelling of the Ocean (GOMO) is a 3D regional ocean model based on OpenArray. It is a universal model developed by Huang Xiaomeng from Tsinghua University for ocean modeling and parallel computing (<a class="reference external" href="https://gmd.copernicus.org/articles/12/4729/2019/gmd-12-4729-2019.pdf">Xiaomeng Huang et al, 2019</a>). The basic equations and algorithms in the GOMO model are derived from the POM2k model (<a class="reference external" href="http://www.sciepub.com/portal/downloads?doi=10.12691/ajmo-2-2-2&amp;filename=ajmo-2-2-2.pdf">Blumberg and Mellor, 1987</a>). The 3D ocean model plays an important role in the earth system modeling. Following the law of conservation of mass, the model simulates phenomena such as ocean currents and whirlpools to display the distribution of sea surface temperature and sea surface height and predict typhoons, tsunami and other phenomena in real time. Traditional ocean models have complex code implementation and run on CPUs. However, the GOMO model has its framework accelerated by MindSpore and runs on a GPU, which greatly improves the model performance.</p>
<p>The following describes how to use MindSpore to build and run the 3D ocean model GOMO on GPU.</p>
<blockquote>
<div><p>Download address of the complete sample code:
<a class="reference external" href="https://gitee.com/mindspore/models/tree/r1.5/research/hpc/ocean_model">https://gitee.com/mindspore/models/tree/r1.5/research/hpc/ocean_model</a>.</p>
</div></blockquote>
<p>The directory structure of the sample code is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└── ocean_model
    ├── README.md                                  # descriptions about ocean model GOMO
    ├── scripts
    │    ├── run_distribute_train.sh               # launch distributed training for GPU
    ├──src
    │    ├── GOMO.py                               # GOMO model
    │    ├── Grid.py                               # grid initial
    │    ├── stencil.py                            # averaging and differential stencil oprator
    │    ├── op_operator.py                        # averaging and differential kernel operator
    │    ├── read_var.py                           # read variables from nc file
    ├── train.py                                   # train script
</pre></div>
</div>
<p>The overall execution process is as follows:</p>
<ol class="simple">
<li><p>Prepare a seamount file as the ocean simulation dataset, and load and process the data.</p></li>
<li><p>Define GOMO variable initialization.</p></li>
<li><p>Define the GOMO model.</p></li>
<li><p>Load the dataset and perform training. After the training is complete, view the result and save the file.</p></li>
</ol>
</div>
<div class="section" id="preparations">
<h2>Preparations<a class="headerlink" href="#preparations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installing-software-dependencies">
<h3>Installing Software Dependencies<a class="headerlink" href="#installing-software-dependencies" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Install MindSpore.</p>
<p>Before the practice, ensure that MindSpore has been properly installed. If not, install MindSpore by following the <a class="reference external" href="https://www.mindspore.cn/install/en">Installation Guide</a>.</p>
</li>
<li><p>Install netCDF4.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install netCDF4
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="preparing-data">
<h3>Preparing Data<a class="headerlink" href="#preparing-data" title="Permalink to this headline">¶</a></h3>
<p>Prepare a seamount file in netCDF format. The seamount problem proposed by Beckmann and Haidvogel is a widely used ideal test case for regional ocean models (<a class="reference external" href="https://journals.ametsoc.org/view/journals/phoc/23/8/1520-0485_1993_023_1736_nsofaa_2_0_co_2.xml?tab_body=fulltext-display">Beckmann and Haidvogel, 1993</a>). Download the <a class="reference external" href="https://github.com/hxmhuang/GOMO/tree/master/bin/data">seamount file</a>.</p>
</div>
</div>
<div class="section" id="loading-data">
<h2>Loading Data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>Load the seamount data file and read the initial variable values from the file script. The data type in the seamount file is float64, which needs to be converted into float32 for MindSpore computation. The script for loading and processing data is in the <code class="docutils literal notranslate"><span class="pre">src/read_var.py</span></code> script of the source code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>

<span class="c1"># variable name list</span>
<span class="n">params_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;zz&#39;</span><span class="p">,</span> <span class="s1">&#39;dz&#39;</span><span class="p">,</span> <span class="s1">&#39;dzz&#39;</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;cor&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;fsm&#39;</span><span class="p">,</span> <span class="s1">&#39;dum&#39;</span><span class="p">,</span> <span class="s1">&#39;dvm&#39;</span><span class="p">,</span> <span class="s1">&#39;art&#39;</span><span class="p">,</span> <span class="s1">&#39;aru&#39;</span><span class="p">,</span> <span class="s1">&#39;arv&#39;</span><span class="p">,</span> <span class="s1">&#39;rfe&#39;</span><span class="p">,</span> <span class="s1">&#39;rfw&#39;</span><span class="p">,</span>
               <span class="s1">&#39;rfn&#39;</span><span class="p">,</span> <span class="s1">&#39;rfs&#39;</span><span class="p">,</span> <span class="s1">&#39;east_e&#39;</span><span class="p">,</span> <span class="s1">&#39;north_e&#39;</span><span class="p">,</span> <span class="s1">&#39;east_c&#39;</span><span class="p">,</span> <span class="s1">&#39;north_c&#39;</span><span class="p">,</span> <span class="s1">&#39;east_u&#39;</span><span class="p">,</span> <span class="s1">&#39;north_u&#39;</span><span class="p">,</span> <span class="s1">&#39;east_v&#39;</span><span class="p">,</span> <span class="s1">&#39;north_v&#39;</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">,</span>
               <span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="s1">&#39;tclim&#39;</span><span class="p">,</span> <span class="s1">&#39;sclim&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">,</span> <span class="s1">&#39;vfluxf&#39;</span><span class="p">,</span> <span class="s1">&#39;wusurf&#39;</span><span class="p">,</span> <span class="s1">&#39;wvsurf&#39;</span><span class="p">,</span> <span class="s1">&#39;e_atmos&#39;</span><span class="p">,</span> <span class="s1">&#39;ub&#39;</span><span class="p">,</span> <span class="s1">&#39;vb&#39;</span><span class="p">,</span> <span class="s1">&#39;uab&#39;</span><span class="p">,</span> <span class="s1">&#39;vab&#39;</span><span class="p">,</span> <span class="s1">&#39;elb&#39;</span><span class="p">,</span>
               <span class="s1">&#39;etb&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;uabw&#39;</span><span class="p">,</span> <span class="s1">&#39;uabe&#39;</span><span class="p">,</span> <span class="s1">&#39;vabs&#39;</span><span class="p">,</span> <span class="s1">&#39;vabn&#39;</span><span class="p">,</span> <span class="s1">&#39;els&#39;</span><span class="p">,</span> <span class="s1">&#39;eln&#39;</span><span class="p">,</span> <span class="s1">&#39;ele&#39;</span><span class="p">,</span> <span class="s1">&#39;elw&#39;</span><span class="p">,</span> <span class="s1">&#39;ssurf&#39;</span><span class="p">,</span> <span class="s1">&#39;tsurf&#39;</span><span class="p">,</span> <span class="s1">&#39;tbe&#39;</span><span class="p">,</span> <span class="s1">&#39;sbe&#39;</span><span class="p">,</span>
               <span class="s1">&#39;sbw&#39;</span><span class="p">,</span> <span class="s1">&#39;tbw&#39;</span><span class="p">,</span> <span class="s1">&#39;tbn&#39;</span><span class="p">,</span> <span class="s1">&#39;tbs&#39;</span><span class="p">,</span> <span class="s1">&#39;sbn&#39;</span><span class="p">,</span> <span class="s1">&#39;sbs&#39;</span><span class="p">,</span> <span class="s1">&#39;wtsurf&#39;</span><span class="p">,</span> <span class="s1">&#39;swrad&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">load_var</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load variable from nc data file&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">read_nc</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; put the load variable into the dict &quot;&quot;&quot;</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params_name</span><span class="p">:</span>
        <span class="n">variable</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_var</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">variable</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-gomo-grid">
<h2>Defining GOMO Grid<a class="headerlink" href="#defining-gomo-grid" title="Permalink to this headline">¶</a></h2>
<p>A GOMO model deduces differential equations and boundary conditions based on momentum, energy, and law of conservation of mass, and determines seven equations to be solved. For details about formula derivation, see <a class="reference external" href="https://gmd.copernicus.org/articles/12/4729/2019/gmd-12-4729-2019.pdf">this paper</a>. Figure 1 shows an overall GOMO execution flowchart.</p>
<p>First, data is loaded from the seamount data for initializing model variables. After the initial value and model parameters are loaded, the computation is divided into two parts: internal mode and external mode. In external mode, the 2D sea surface elevation <code class="docutils literal notranslate"><span class="pre">el</span></code> and column-averaged velocity (ua, va) are mainly computed. In internal mode, the number of loops <code class="docutils literal notranslate"><span class="pre">iend</span></code> indicates the total number of time steps during training (set by users). The 3D array computations predominate in order to compute the turbulence kinetic energy <code class="docutils literal notranslate"><span class="pre">q2</span></code> and the turbulence length <code class="docutils literal notranslate"><span class="pre">q2l</span></code> that generates the turbulence kinetic energy, temperature <code class="docutils literal notranslate"><span class="pre">t</span></code> and salinity <code class="docutils literal notranslate"><span class="pre">s</span></code>, as well as the velocity fields <code class="docutils literal notranslate"><span class="pre">u</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code> in the x and y directions. After the computation is complete, save the required variable result and end the training.</p>
<p><img alt="GOMO" src="_images/gomo.png" /></p>
<p>Figure 1: GOMO model flowchart</p>
<div class="section" id="initializing-variables">
<h3>Initializing Variables<a class="headerlink" href="#initializing-variables" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">src.GOMO</span> <span class="kn">import</span> <span class="n">GOMO_init</span>
<span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># define grid and init variable update</span>
    <span class="n">net_init</span> <span class="o">=</span> <span class="n">GOMO_init</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">stencil_width</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-gomo-model">
<h3>Defining GOMO Model<a class="headerlink" href="#defining-gomo-model" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q2l</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
              <span class="n">rho</span><span class="p">,</span> <span class="n">wubot</span><span class="p">,</span> <span class="n">wvbot</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">egb</span><span class="p">,</span> <span class="n">etb</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">,</span> <span class="n">utb</span><span class="p">,</span> <span class="n">vtb</span><span class="p">,</span> <span class="n">vfluxb</span><span class="p">,</span> <span class="n">et</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;construct&quot;&quot;&quot;</span>
    <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_d</span>
    <span class="n">q2b</span><span class="p">,</span> <span class="n">q2lb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2lb</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
    <span class="c1"># surface forcing</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_h</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vfluxf</span>
    <span class="c1"># lateral_viscosity</span>
    <span class="n">advx</span><span class="p">,</span> <span class="n">advy</span><span class="p">,</span> <span class="n">drhox</span><span class="p">,</span> <span class="n">drhoy</span><span class="p">,</span> <span class="n">aam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lateral_viscosity</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aam</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmean</span><span class="p">)</span>
    <span class="c1"># mode_interaction</span>
    <span class="n">adx2d</span><span class="p">,</span> <span class="n">ady2d</span><span class="p">,</span> <span class="n">drx2d</span><span class="p">,</span> <span class="n">dry2d</span><span class="p">,</span> <span class="n">aam2d</span><span class="p">,</span> <span class="n">advua</span><span class="p">,</span> <span class="n">advva</span><span class="p">,</span> <span class="n">egf</span><span class="p">,</span> <span class="n">utf</span><span class="p">,</span> <span class="n">vtf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_interaction</span><span class="p">(</span><span class="n">advx</span><span class="p">,</span> <span class="n">advy</span><span class="p">,</span> <span class="n">drhox</span><span class="p">,</span> <span class="n">drhoy</span><span class="p">,</span> <span class="n">aam</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
    <span class="c1"># ===========external model===========</span>
    <span class="n">vamax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">iext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span>
        <span class="c1"># external_el</span>
        <span class="n">elf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_el</span><span class="p">(</span><span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">elb</span><span class="p">)</span>
        <span class="c1"># external_ua</span>
        <span class="n">advua</span><span class="p">,</span> <span class="n">uaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ua</span><span class="p">(</span><span class="n">iext</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">elf</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">advua</span><span class="p">,</span> <span class="n">aam2d</span><span class="p">,</span> <span class="n">adx2d</span><span class="p">,</span> <span class="n">drx2d</span><span class="p">,</span> <span class="n">wubot</span><span class="p">)</span>
        <span class="c1"># external_va</span>
        <span class="n">advva</span><span class="p">,</span> <span class="n">vaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_va</span><span class="p">(</span><span class="n">iext</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">elf</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">advva</span><span class="p">,</span> <span class="n">aam2d</span><span class="p">,</span> <span class="n">ady2d</span><span class="p">,</span> <span class="n">dry2d</span><span class="p">,</span> <span class="n">wvbot</span><span class="p">)</span>
        <span class="c1"># external_update</span>
        <span class="n">etf</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">egf</span><span class="p">,</span> <span class="n">utf</span><span class="p">,</span> <span class="n">vtf</span><span class="p">,</span> <span class="n">vamax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_update</span><span class="p">(</span><span class="n">iext</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">elf</span><span class="p">,</span> <span class="n">uaf</span><span class="p">,</span> <span class="n">vaf</span><span class="p">,</span> <span class="n">egf</span><span class="p">,</span> <span class="n">utf</span><span class="p">,</span> <span class="n">vtf</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="c1"># ===========internal model===========</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># adjust_uv</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">utb</span><span class="p">,</span> <span class="n">vtb</span><span class="p">,</span> <span class="n">utf</span><span class="p">,</span> <span class="n">vtf</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># internal_w</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_w</span><span class="p">(</span><span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">etb</span><span class="p">,</span> <span class="n">vfluxb</span><span class="p">)</span>
        <span class="c1"># internal_q</span>
        <span class="n">dhf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">q2b_</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q2lb_</span><span class="p">,</span> <span class="n">q2l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_q</span><span class="p">(</span><span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">aam</span><span class="p">,</span> <span class="n">q2b</span><span class="p">,</span> <span class="n">q2lb</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q2l</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">wubot</span><span class="p">,</span> <span class="n">wvbot</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">q2b</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Assign</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">q2b</span><span class="p">,</span> <span class="n">q2b_</span><span class="p">)</span>
        <span class="n">q2lb</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Assign</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">q2lb</span><span class="p">,</span> <span class="n">q2lb_</span><span class="p">)</span>
        <span class="c1"># internal_t_t</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_t_</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wtsurf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsurf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swrad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tclim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbs</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">aam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dum</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dhf</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzz</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzz1</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="p">,</span> <span class="n">dhb</span><span class="p">)</span>
        <span class="c1"># internal_t_s</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_t_</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wssurf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssurf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swrad0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sclim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbs</span><span class="p">,</span> <span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">aam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dum</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dhf</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzz</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzz1</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="p">,</span> <span class="n">dhb</span><span class="p">)</span>
        <span class="c1"># dense</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="p">)</span>
        <span class="c1"># internal_u</span>
        <span class="n">uf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">wubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_u</span><span class="p">(</span><span class="n">x_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">dhf</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">egf</span><span class="p">,</span> <span class="n">egb</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbc</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">advx</span><span class="p">,</span> <span class="n">drhox</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">)</span>
        <span class="c1"># internal_v</span>
        <span class="n">vf</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">wvbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_v</span><span class="p">(</span><span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="p">,</span> <span class="n">dhf</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">egf</span><span class="p">,</span> <span class="n">egb</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbc</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">advy</span><span class="p">,</span> <span class="n">drhoy</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">)</span>
        <span class="c1"># adjust_ufvf</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_ufvf</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">uf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">)</span>
    <span class="c1"># internal_update</span>
    <span class="n">egb</span><span class="p">,</span> <span class="n">etb</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">,</span> <span class="n">utb</span><span class="p">,</span> <span class="n">vtb</span><span class="p">,</span> <span class="n">vfluxb</span><span class="p">,</span> <span class="n">et</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_update</span><span class="p">(</span><span class="n">egf</span><span class="p">,</span> <span class="n">etb</span><span class="p">,</span> <span class="n">utf</span><span class="p">,</span> <span class="n">vtf</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">AssignAdd</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elf</span><span class="p">,</span> <span class="n">etf</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uab</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vab</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">elb</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kq</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q2l</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">wubot</span><span class="p">,</span> <span class="n">wvbot</span><span class="p">,</span> \
           <span class="n">ub</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">egb</span><span class="p">,</span> <span class="n">etb</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dhb</span><span class="p">,</span> <span class="n">utb</span><span class="p">,</span> <span class="n">vtb</span><span class="p">,</span> <span class="n">vfluxb</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">vamax</span><span class="p">,</span> <span class="n">q2b</span><span class="p">,</span> <span class="n">q2lb</span>
</pre></div>
</div>
<p>Call the defined GOMO model in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">src.GOMO</span> <span class="kn">import</span> <span class="n">GOMO</span>
<span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
   <span class="c1"># define GOMO model</span>
    <span class="n">Model</span> <span class="o">=</span> <span class="n">GOMO</span><span class="p">(</span><span class="n">im</span><span class="o">=</span><span class="n">im</span><span class="p">,</span> <span class="n">jm</span><span class="o">=</span><span class="n">jm</span><span class="p">,</span> <span class="n">kb</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span> <span class="n">stencil_width</span><span class="o">=</span><span class="n">stencil_width</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">x_d</span><span class="o">=</span><span class="n">x_d</span><span class="p">,</span> <span class="n">y_d</span><span class="o">=</span><span class="n">y_d</span><span class="p">,</span> <span class="n">z_d</span><span class="o">=</span><span class="n">z_d</span><span class="p">,</span>
                 <span class="n">q2b</span><span class="o">=</span><span class="n">q2b</span><span class="p">,</span> <span class="n">q2lb</span><span class="o">=</span><span class="n">q2lb</span><span class="p">,</span> <span class="n">aam</span><span class="o">=</span><span class="n">aam</span><span class="p">,</span> <span class="n">cbc</span><span class="o">=</span><span class="n">cbc</span><span class="p">,</span> <span class="n">rmean</span><span class="o">=</span><span class="n">rmean</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="training-grid">
<h2>Training Grid<a class="headerlink" href="#training-grid" title="Permalink to this headline">¶</a></h2>
<div class="section" id="running-script">
<h3>Running Script<a class="headerlink" href="#running-script" title="Permalink to this headline">¶</a></h3>
<p>After the training script is defined, call the shell script in the <code class="docutils literal notranslate"><span class="pre">scripts</span></code> directory to start training.
Run the following command to execute the script:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sh run_distribute_train.sh &lt;im&gt; &lt;jm&gt; &lt;kb&gt; &lt;step&gt; &lt;DATASET_PATH&gt;
</pre></div>
</div>
<p>Pass the variables <code class="docutils literal notranslate"><span class="pre">im</span></code>, <code class="docutils literal notranslate"><span class="pre">jm</span></code>, <code class="docutils literal notranslate"><span class="pre">kb</span></code>, <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code> to the script, where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">im</span></code>, <code class="docutils literal notranslate"><span class="pre">jm</span></code>, <code class="docutils literal notranslate"><span class="pre">kb</span></code>: resolution of the simulated ocean region, which is related to the used data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">step</span></code>: number of time steps during training (corresponding to <code class="docutils literal notranslate"><span class="pre">iend</span></code> in Figure 1).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>: training data path.</p></li>
</ul>
<p>After the training is complete, the variable change values during the training are saved in the <code class="docutils literal notranslate"><span class="pre">train/outputs</span></code> directory. The following four variable values are saved every five time steps: east wind velocity (unit: m/s), north wind velocity (unit: m/s), position temperature (unit: K), and sea surface elevation (unit: m).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└─outputs
    ├─u_5.npy
    ├─v_5.npy
    ├─t_5.npy
    ├─et_5.npy
    ├─u_10.npy
    ├─v_10.npy
    ├─t_10.npy
    ├─et_10.npy
</pre></div>
</div>
<p>In the preceding information:
<code class="docutils literal notranslate"><span class="pre">*.npy</span></code>: saved variables. File name format: <em>Variable name</em>_<em>Step count</em>.npy.</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>Huang X, Huang X, Wang D, et al. OpenArray v1. 0: a simple operator library for the decoupling of ocean modeling and parallel computing[J]. Geoscientific Model Development, 2019, 12(11).</p></li>
<li><p>Blumberg A F, Mellor G L. A description of a three‐dimensional coastal ocean circulation model[J]. Three‐dimensional coastal ocean models, 1987, 4: 1-16.</p></li>
<li><p>Beckmann A, Haidvogel D B. Numerical simulation of flow around a tall isolated seamount. Part I: Problem formulation and model accuracy[J]. Journal of Physical Oceanography, 1993, 23(8): 1736-1753.</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="use_on_the_cloud.html" class="btn btn-neutral float-right" title="Using MindSpore on the Cloud" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="hpc.html" class="btn btn-neutral float-left" title="High Performance Computing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>