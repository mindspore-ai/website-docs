<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>保存和加载模型（HyBrid Parallel模式） &mdash; MindSpore master documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/training.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/training.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="分布式并行训练Transformer模型" href="distributed_training_transformer.html" />
    <link rel="prev" title="分布式并行训练基础样例（GPU）" href="distributed_training_gpu.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">整体介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">MindSpore总体架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_structure.html">MindSpore API概述</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">设计介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="design/technical_white_paper.html">技术白皮书</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/all_scenarios_architecture.html">全场景统一架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/gradient.html">函数式可微分编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/dynamic_graph_and_static_graph.html">静态图和动态图</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/distributed_training_design.html">分布式训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/heterogeneous_training.html">异构并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/mindir.html">MindSpore IR（MindIR）</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.6/training_visual_design.html">可视化调试调优↗</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindarmour/docs/zh-CN/r1.6/design.html">安全可信↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r1.6/linear_regression.html">实现简单线性函数拟合↗</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r1.6/quick_start.html">实现一个图片分类应用↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基本概念</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dtype.html">DataType</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensor.html">Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter_introduction.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators.html">算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="cell.html">Cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_introduction.html">Dataset</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">数据加载和处理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dataset_sample.html">快速入门数据加载和处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">数据集加载</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_advanced.html">数据处理高级用法</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset_usage.html">数据迭代</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">网络构建</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="build_net.html">构建单算子网络和多层网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="initializer.html">Initializer初始化器</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">网络参数</a></li>
<li class="toctree-l1"><a class="reference internal" href="control_flow.html">使用流程控制语句</a></li>
<li class="toctree-l1"><a class="reference internal" href="indefinite_parameter.html">参数传递</a></li>
<li class="toctree-l1"><a class="reference internal" href="constexpr.html">网络内构造常量</a></li>
<li class="toctree-l1"><a class="reference internal" href="loss.html">损失函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="grad_operation.html">求导</a></li>
<li class="toctree-l1"><a class="reference internal" href="hypermap.html">运算重载</a></li>
<li class="toctree-l1"><a class="reference internal" href="optim.html">优化器</a></li>
<li class="toctree-l1"><a class="reference internal" href="train_and_eval.html">构建训练与评估网络</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型运行</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="context.html">配置运行信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">运行方式</a></li>
<li class="toctree-l1"><a class="reference internal" href="ms_function.html">ms_function动静结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="save_and_load_models.html">模型保存与加载</a></li>
<li class="toctree-l1"><a class="reference internal" href="model.html">Model接口应用</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">推理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="multi_platform_inference.html">推理模型总览</a></li>
<li class="toctree-l1"><a class="reference internal" href="online_inference.html">加载Checkpoint在线推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="offline_inference.html">使用离线模型推理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">分布式并行</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="distributed_training.html">分布式并行总览</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_advanced.html">分布式并行高级特性</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="distributed_example.html">分布式并行使用样例</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="distributed_training_ascend.html">分布式并行训练基础样例（Ascend）</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributed_training_gpu.html">分布式并行训练基础样例（GPU）</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">保存和加载模型（HyBrid Parallel模式）</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">概述</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">背景</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">使用场景</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#checkpoint">对保存的CheckPoint文件做合并处理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">整体流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">准备工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">对模型并行的参数做合并处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">保存数据生成新的CheckPoint文件</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">加载合并保存的CheckPoint文件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">整体流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">步骤1：加载CheckPoint文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">步骤2：对模型并行参数做切分处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">步骤3：将修改后的参数数据加载到网络中</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">示例场景说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">示例代码</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="distributed_training_transformer.html">分布式并行训练Transformer模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributed_training_fault_recover.html">分布式故障恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="pangu_alpha.html">鹏程·盘古模型网络多维度混合并行解析</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">图编译</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="jit_fallback.html">JIT Fallback</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PyNative</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">PyNative模式应用</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Numpy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="numpy.html">MindSpore NumPy函数</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">功能调试</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="read_ir_files.html">如何查看IR文件</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/zh-CN/r1.6/debug_in_pynative_mode.html">使用PyNative模式调试↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="dump_in_graph_mode.html">使用Dump功能在Graph模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_operator_build.html">算子增量编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="fixing_randomness.html">固定随机性以复现脚本运行结果</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">精度调优</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.6/accuracy_problem_preliminary_location.html">精度问题初步定位指南↗</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.6/accuracy_optimization.html">精度问题详细定位和调优指南↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">性能优化</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_tune.html">算子调优工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_dataset_autotune.html">自动数据加速</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_dataset_offload.html">数据准备异构加速</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.6/performance_profiling.html">使用Profiler调试性能↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_adaptive_summation.html">自适应梯度求和算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_dimention_reduce_training.html">降维训练算法</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">高级特性</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="second_order_optimizer.html">二阶优化</a></li>
<li class="toctree-l1"><a class="reference internal" href="graph_kernel_fusion.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">感知量化训练</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cv.html">机器视觉</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">高性能计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="distributed_example.html">分布式并行使用样例</a> &raquo;</li>
      <li>保存和加载模型（HyBrid Parallel模式）</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/save_load_model_hybrid_parallel.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="hybrid-parallel">
<h1>保存和加载模型（HyBrid Parallel模式）<a class="headerlink" href="#hybrid-parallel" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">分布式并行</span></code> <code class="docutils literal notranslate"><span class="pre">模型导出</span></code> <code class="docutils literal notranslate"><span class="pre">模型加载</span></code></p>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.6/docs/mindspore/programming_guide/source_zh_cn/save_load_model_hybrid_parallel.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.6/resource/_static/logo_source.png"></a></p>
<section id="id1">
<h2>概述<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<section id="id2">
<h3>背景<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h3>
<p>MindSpore模型并行场景下，每个实例进程只保存有本节点对应的参数数据。对于模型并行的Cell，其在每个节点上的参数数据，都是完整参数数据的一个切片。比如完整参数数据shape为[8, 8]，每个节点上的参数数据为其中的一部分，如shape[2, 8]。</p>
<p>对于自动切分的模型并行场景（Auto Parallel），切分逻辑由MindSpore自动生成，MindSpore的CheckPoint模块可以支持自动合并保存和基于合并保存的加载能力。</p>
<p>对于用户手动设置的并行场景（HyBrid Parallel），切分逻辑由用户自己实现，MindSpore在每个节点上保存相同的模型参数切分策略文件和本节点上的数据，用户需要自己实现CheckPoint文件的合并保存与加载功能。本教程用于指导用户在手动切分场景下，实现CheckPoint的合并保存与加载能力。</p>
</section>
<section id="id3">
<h3>使用场景<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<p>如果你遇到如下两个场景，需要参考本教程操作，完成CheckPoint的合并保存与加载：</p>
<p>场景1：多卡训练，单卡推理。</p>
<p>以在64卡上训练，并在单卡上推理为例，整体操作流程如下：</p>
<ol class="arabic">
<li><p>执行训练，自动生成CheckPoint文件和模型参数切分策略文件。</p></li>
<li><p>用户对保存的CheckPoint文件做合并处理。</p>
<p>根据具体的切分逻辑，对于存在切分的具体模型参数做合并处理，生成新CheckPoint文件。</p>
</li>
<li><p>在单卡环境加载新的CheckPoint文件，之后再根据需要调用export接口导出用于推理的模型。</p></li>
</ol>
<p>若CheckPoint的保存环境和加载环境集群的卡数相同，比如在同一训练环境保存加载CheckPoint，或者单卡训练单卡推理，则可以不需要做合并保存和加载。</p>
<p>场景2：训练分为多阶段，每个阶段的集群大小不一样。</p>
<p>​ 以训练阶段一是64卡训练环境，阶段二是56卡训练环境为例，整体操作流程如下：</p>
<ol class="arabic">
<li><p>执行阶段一训练，自动生成CheckPoint文件和模型参数切分策略文件。</p></li>
<li><p>用户对保存的CheckPoint文件做合并处理。</p>
<p>根据具体的切分逻辑，对于存在切分的具体模型参数做合并处理，生成新CheckPoint文件。</p>
</li>
<li><p>在阶段二集群上加载合并保存的CheckPoint文件。</p>
<p>在加载过程中，用户需要根据新的训练环境配置，重新切分CheckPoint文件中的参数数据。</p>
</li>
<li><p>执行阶段二训练。</p></li>
</ol>
</section>
</section>
<section id="checkpoint">
<h2>对保存的CheckPoint文件做合并处理<a class="headerlink" href="#checkpoint" title="Permalink to this headline"></a></h2>
<section id="id4">
<h3>整体流程<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<p>首先，执行准备工作，按逻辑顺序将待合并处理的CheckPoint文件导入网络，获取模型全量参数并添加至列表中，再获取模型参数切分策略。对应下图中的Step1和Step2。</p>
<p>其次，更新参数列表，对涉及模型并行的参数做合并处理。对应下图中的Step3。</p>
<p>最后，将更新之后的参数列表，通过MindSpore提供的API保存到文件，生成新的CheckPoint文件。对应下图中的Step4。</p>
<p><img alt="img" src="_images/checkpoint_integration_process.jpg" /></p>
</section>
<section id="id5">
<h3>准备工作<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<section id="id6">
<h4>按逻辑顺序导入CheckPoint文件<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h4>
<p>定义网络，调用<code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>、<code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>接口，按逻辑顺序将CheckPoint文件导入网络，之后调用<code class="docutils literal notranslate"><span class="pre">parameters_and_names</span></code>接口获取网络里所有的参数数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
<span class="n">param_dicts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./node&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;CKP_1-4_32.ckpt&quot;</span><span class="p">)</span>  <span class="c1"># checkpoint file name of current node</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>  
    <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">():</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">param_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank_size</span></code>：之前分布式训练的节点数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>：通过该接口加载CheckPoint模型参数文件，返回一个参数字典。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>：模型参数数据加载到网络中。</p></li>
</ul>
</section>
<section id="id7">
<h4>获取模型参数切分策略<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h4>
<p>调用<code class="docutils literal notranslate"><span class="pre">build_searched_strategy</span></code>接口，得到模型各个参数的切分策略。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">strategy</span> <span class="o">=</span> <span class="n">build_searched_strategy</span><span class="p">(</span><span class="s2">&quot;./strategy_train.cpkt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">strategy_train.ckpt</span></code>：保存的模型参数切分策略文件名称，训练网络之前由用户调用<code class="docutils literal notranslate"><span class="pre">set_auto_parallel_context</span></code>接口自定义<code class="docutils literal notranslate"><span class="pre">strategy_ckpt_save_file</span></code>参数生成。</p></li>
</ul>
</section>
</section>
<section id="id8">
<h3>对模型并行的参数做合并处理<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h3>
<p>下面以一个具体的模型参数为例，说明下参数合并处理的具体流程。</p>
<p>参数名称为”weight”，切分逻辑为4卡场景。</p>
<ol class="arabic">
<li><p>针对涉及模型并行的参数，获取所有节点上的参数数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sliced_parameters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
    <span class="n">sliced_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>如果要保证参数更新速度不变，需要对优化器中保存的参数，如”moments.weight”，同样做合并处理。</p>
</div></blockquote>
</li>
<li><p>调用<code class="docutils literal notranslate"><span class="pre">merge_sliced_parameter</span></code>接口进行参数合并。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">merged_parameter</span> <span class="o">=</span> <span class="n">merge_sliced_parameter</span><span class="p">(</span><span class="n">sliced_parameters</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>如果存在多个模型并行的参数，则需要重复步骤1到步骤2循环逐个处理。</p>
</div></blockquote>
</section>
<section id="id9">
<h3>保存数据生成新的CheckPoint文件<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>将<code class="docutils literal notranslate"><span class="pre">param_dict</span></code>转换为list类型数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">each_param</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
        <span class="n">param_data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_data</span>
    <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_param</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>调用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>接口，将参数数据写入文件，生成新的CheckPoint文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="s2">&quot;./CKP-Integrated_1-4_32.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>： 通过该接口将网络模型参数信息存入文件。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CKP-Integrated_1-4_32.ckpt</span></code>： 新生成的CheckPoint模型参数文件名称。</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="id10">
<h2>加载合并保存的CheckPoint文件<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h2>
<section id="id11">
<h3>整体流程<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h3>
<p>如果需要将合并保存的CheckPoint加载到多卡训练或推理中，在模型参数真正加载到网络前，需要对于涉及并行的参数数据按照新的逻辑切分。
如下步骤在训练前脚本里实现，步骤1和3同单机CheckPoint加载的逻辑，步骤2为新增，用于涉及并行的模型参数的切分。
对于加载到单卡训练/推理的场景，不涉及数据切分，则步骤2可省略。</p>
</section>
<section id="id12">
<h3>步骤1：加载CheckPoint文件<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h3>
<p>调用<code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>接口，从CheckPoint文件中加载模型参数数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;./CKP-Integrated_1-4_32.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>：通过该接口加载CheckPoint模型参数文件，返回一个参数字典。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CKP-Integrated_1-4_32.ckpt</span></code>：需要加载的CheckPoint模型参数文件名称。</p></li>
</ul>
</section>
<section id="id13">
<h3>步骤2：对模型并行参数做切分处理<a class="headerlink" href="#id13" title="Permalink to this headline"></a></h3>
<p>下面以一个具体的模型参数为例，参数名称为”weight”， 数据值为Tensor [[1, 2, 3, 4],  [5, 6, 7, 8]]，切分逻辑为2卡场景，按[2, 1]切分。
切分后数据分布情况如下：</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Device0</p></th>
<th class="head"><p>Device1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value [1, 2, 3, 4]</p></td>
<td><p>Value [5, 6, 7, 8]</p></td>
</tr>
</tbody>
</table>
<ol class="arabic">
<li><p>对模型参数数据做切分。</p>
<p>如下代码示例，在维度0上，将数据切分为两个切片。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_param</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
<span class="n">slice_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">new_param_moments</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s2">&quot;moments.weight&quot;</span><span class="p">]</span>
<span class="n">slice_moments_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param_moments</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>切分后的数据情况：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>slice_list[0]  --- [1, 2, 3, 4]    对应device0
slice_list[1]  --- [5, 6, 7, 8]    对应device1
</pre></div>
</div>
<p>与<code class="docutils literal notranslate"><span class="pre">slice_list</span></code>类似，<code class="docutils literal notranslate"><span class="pre">slice_moments_list</span></code> 也被切分为两个shape为[1, 4]的Tensor。</p>
</li>
<li><p>在每个节点分别加载对应的数据切片。</p>
<p>获取本节点的rank_id，根据rank_id加载数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
<span class="n">tensor_slice</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">slice_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
<span class="n">tensor_slice_moments</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">slice_moments_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_rank</span></code>：获取当前设备在集群中的ID。</p></li>
</ul>
</li>
<li><p>修改模型参数数据值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_param</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">new_param_moments</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice_moments</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">set_data</span></code>：设置模型参数的值，接口参数类型为Tensor 或number。</p></li>
</ul>
</li>
</ol>
</section>
<section id="id14">
<h3>步骤3：将修改后的参数数据加载到网络中<a class="headerlink" href="#id14" title="Permalink to this headline"></a></h3>
<p>调用<code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>接口，将模型参数数据加载到网络中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parallel_net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id15">
<h2>示例<a class="headerlink" href="#id15" title="Permalink to this headline"></a></h2>
<section id="id16">
<h3>示例场景说明<a class="headerlink" href="#id16" title="Permalink to this headline"></a></h3>
<p>整体场景：训练分为两个阶段，两阶段的集群规模不一致，模拟FC层MatMul算子并行。</p>
<p>用户流程：</p>
<ol class="arabic simple">
<li><p>执行阶段1训练：阶段1为4卡训练环境，每卡上MatMul算子weight的shape为[2, 8]，训练过程中自动导出CheckPoint。</p></li>
<li><p>执行脚本对CheckPoint文件做合并处理，根据具体的切分逻辑，对于存在切分的具体模型参数做合并处理，生成合并的CheckPoint文件。</p></li>
<li><p>执行阶段2训练：阶段2为2卡训练环境，每卡上MatMul算子weight的shape为[4, 8]，从合并后的CheckPoint文件加载初始化模型参数数据，之后执行训练。</p></li>
</ol>
<blockquote>
<div><p>具体分布式环境配置和训练部分代码，此处不做详细说明，可以参考<a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/zh-CN/r1.6/distributed_training_ascend.html">分布式并行训练</a>
章节。</p>
<p>本文档附上对CheckPoint文件做合并处理以及分布式训练前加载CheckPoint文件的示例代码，仅作为参考，实际请参考具体情况实现。</p>
</div></blockquote>
</section>
<section id="id17">
<h3>示例代码<a class="headerlink" href="#id17" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>执行脚本对CheckPoint文件做合并处理。</p>
<p>脚本执行命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w">  </span>./integrate_checkpoint.py<span class="w"> </span><span class="s2">&quot;待合并的CheckPoint文件名称&quot;</span><span class="w"> </span><span class="s2">&quot;合并生成的CheckPoint文件路径&amp;名称&quot;</span><span class="w"> </span><span class="s2">&quot;策略文件路径&amp;名称&quot;</span><span class="w"> </span><span class="s2">&quot;节点数&quot;</span>
</pre></div>
</div>
<p>integrate_checkpoint.py：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">save_checkpoint</span><span class="p">,</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">build_searched_strategy</span><span class="p">,</span> <span class="n">merge_sliced_parameter</span>

<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight_init</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">weight_init</span><span class="p">),</span> <span class="n">layerwise_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MatMul</span><span class="p">(</span><span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">integrate_ckpt_file</span><span class="p">(</span><span class="n">old_ckpt_file</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">,</span> <span class="n">strategy_file</span><span class="p">,</span> <span class="n">rank_size</span><span class="p">):</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="c1"># load CheckPoint into net in rank id order</span>
    <span class="n">param_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./node&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">old_ckpt_file</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>  
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">():</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
            <span class="n">param_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>

    <span class="n">strategy</span> <span class="o">=</span> <span class="n">build_searched_strategy</span><span class="p">(</span><span class="n">strategy_file</span><span class="p">)</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">paramname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;moments.weight&quot;</span><span class="p">]:</span>
        <span class="c1"># get layer wise model parallel parameter</span>
        <span class="n">sliced_parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
            <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paramname</span><span class="p">)</span>
            <span class="n">sliced_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

        <span class="c1"># merge the parallel parameters of the model</span>
        <span class="n">merged_parameter</span> <span class="o">=</span> <span class="n">merge_sliced_parameter</span><span class="p">(</span><span class="n">sliced_parameters</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">paramname</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_parameter</span>

    <span class="c1"># convert param_dict to list type data</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">each_param</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="n">param_data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_data</span>
        <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_param</span><span class="p">)</span>

    <span class="c1"># call the API to generate a new CheckPoint file</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">strategy_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rank_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">integrate_ckpt_file</span><span class="p">(</span><span class="n">old_ckpt_file</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">,</span> <span class="n">strategy_file</span><span class="p">,</span> <span class="n">rank_size</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fail to integrate checkpoint file&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>执行结果：</p>
<p>脚本执行前，CheckPoint文件中参数值：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>device0：
name is weight
value is
[[0.87537426 1.0448935 0.86736983 0.8836905 0.77354026 0.69588304 0.9183654 0.7792076]
 [0.87224025 0.8726848 0.771446 0.81967723 0.88974726 0.7988162 0.72919345 0.7677011]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
 [0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194]]

device1：
name is weight
value is
[[0.9210751 0.9050457 0.9827775 0.920396 0.9240526 0.9750359 1.0275179 1.0819869]
 [0.73605865 0.84631145 0.9746683 0.9386582 0.82902765 0.83565056 0.9702136 1.0514659]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
 [0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102 -0.15327111]]

device2：
name is weight
value is
[[1.0108461 0.8689414  0.91719437 0.8805056 0.7994629 0.8999671 0.7585804 1.0287056 ]
 [0.90653455 0.60146594 0.7206475 0.8306303 0.8364681 0.89625114 0.7354735 0.8447268]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
 [0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738 0.24933104]]

device3：
name is weight
value is
[[0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
 [0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619 0.40430856]
[-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405 -0.12860501]]
</pre></div>
</div>
<p>脚本执行后，CheckPoint文件中参数值：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>name is weight
value is
[[1.1138763 1.0962057 1.3516843 1.0812817 1.1579804 1.1078343 1.0906502 1.3207073]
 [0.916671 1.0781671 1.0368758 0.9680898 1.1735439 1.0628364 0.9960786 1.0135143]
 [0.8828271 0.7963984 0.90675324 0.9830291 0.89010954 0.897052 0.7890109 0.89784735]
 [1.0011744 1.0840297 1.0201758 1.0882459 0.94232416 1.0775206 1.0195118 1.0528734]
 [1.0053468 0.98402303 0.99762845 0.97587246 1.0259694 1.0055295 0.99420834 0.9496847]
 [1.0851002 1.0295962 1.0999886 1.0958165 0.9765328 1.146529 1.0970603 1.1388365]
 [0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
 [0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
 [0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194 ]
 [0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
 [0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102 -0.15327111]
 [0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
 [0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738  0.24933104]
 [0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619  0.40430856]
 [-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405
  -0.12860501]]
</pre></div>
</div>
</li>
<li><p>执行阶段2训练，训练前加载CheckPoint文件。其中训练代码部分，需要根据实际情况补充。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>

<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span>
<span class="n">devid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEVICE_ID&#39;</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span><span class="n">device_target</span><span class="o">=</span><span class="s1">&#39;Ascend&#39;</span><span class="p">,</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="n">devid</span><span class="p">)</span>
<span class="n">init</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight_init</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">weight_init</span><span class="p">),</span> <span class="n">layerwise_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MatMul</span><span class="p">(</span><span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">train_mindspore_impl_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ckpt_file</span><span class="p">):</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">paramname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;moments.weight&quot;</span><span class="p">]:</span>
        <span class="c1"># get layer wise model parallel parameter</span>
        <span class="n">new_param</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="n">paramname</span><span class="p">]</span>
        <span class="c1"># split the model parameter data</span>
        <span class="n">slice_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Load the corresponding data slice</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
        <span class="n">tensor_slice</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">slice_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
        <span class="c1"># modify model parameter data values</span>
        <span class="n">new_param</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># load the modified parameter data into the network</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parallel_net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="c1"># train code</span>
        <span class="o">...</span>

    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mean = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">train_mindspore_impl_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ckpt_file</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode=context.GRAPH_MODE</span></code>：使用分布式训练需要指定运行模式为图模式（PyNative模式不支持并行）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device_id</span></code>：卡物理序号，即卡所在机器中的实际序号。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">init</span></code>：完成分布式训练初始化操作。</p></li>
</ul>
<p>加载后的参数值：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>device0：
name is weight
value is
[[0.87537426 1.0448935 0.86736983 0.8836905 0.77354026 0.69588304 0.9183654 0.7792076]
[0.87224025 0.8726848 0.771446 0.81967723 0.88974726 0.7988162 0.72919345 0.7677011]
[0.8828271 0.7963984 0.90675324 0.9830291 0.89010954 0.897052 0.7890109 0.89784735]
[1.0011744 1.0840297 1.0201758 1.0882459 0.94232416 1.0775206 1.0195118 1.0528734]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
[0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194]
[0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
[0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102  -0.15327111]]

device1：
name is weight
value is
[[1.0053468 0.98402303 0.99762845 0.97587246 1.0259694 1.0055295 0.99420834 0.9496847]
[1.0851002 1.0295962 1.0999886 1.0958165 0.9765328 1.146529 1.0970603 1.1388365]
[0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
[0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
[0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738  0.24933104]
[0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619  0.40430856]
[-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405 -0.12860501]]
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="distributed_training_gpu.html" class="btn btn-neutral float-left" title="分布式并行训练基础样例（GPU）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="distributed_training_transformer.html" class="btn btn-neutral float-right" title="分布式并行训练Transformer模型" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>