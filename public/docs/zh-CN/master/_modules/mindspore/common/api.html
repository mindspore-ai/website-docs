<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mindspore.common.api &mdash; MindSpore master 文档</title>
      <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/training.css" type="text/css" /><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/js/training.js"></script>
        <script src="../../../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/overview.html">MindSpore设计概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/programming_paradigm.html">函数式和对象式融合编程范式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/all_scenarios.html">全场景统一架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/dynamic_graph_and_static_graph.html">动静态图结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/pluggable_device.html">三方硬件对接</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/distributed_training_design.html">原生分布式并行架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/graph_fusion_engine.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型库</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/official_models.html">官方模型库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API映射</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/api_mapping/pytorch_api_mapping.html">PyTorch与MindSpore API映射表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/api_mapping/tensorflow_api_mapping.html">TensorFlow与MindSpore API映射表</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">迁移指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/overview.html">迁移指南概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/enveriment_preparation.html">环境准备与资料获取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/analysis_and_preparation.html">模型分析与准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/typical_api_comparision.html">与PyTorch典型区别</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/model_development/model_development.html">MindSpore网络搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/debug_and_tune.html">调试调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/sample_code.html">网络迁移调试实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/migrator_with_tools.html">网络迁移工具应用实践指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/faq.html">常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语法支持</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax_support.html">静态图语法支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/operators.html">静态图语法——运算符</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/statements.html">静态图语法——Python语句</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/python_builtin_functions.html">静态图语法——Python内置函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/index_support.html">Tensor索引支持</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">环境变量</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/env_var_list.html">环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/data_processing.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/implement_problem.html">执行问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/network_compilation.html">网络编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/operators_compile.html">算子编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/usage_migrate_3rd.html">第三方框架迁移使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/performance_tuning.html">性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/precision_tuning.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/distributed_parallel.html">分布式并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/inference.html">推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/feature_advice.html">特性咨询</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">模块代码</a> &raquo;</li>
      <li>mindspore.common.api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>mindspore.common.api 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># This is the Python adaptation and derivative work of Myia (https://github.com/mila-iqia/myia/).</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2020-2023 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;Providing interface methods.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">mindspore._extends.remote</span> <span class="kn">import</span> <span class="n">kernel_build_server</span>
<span class="kn">from</span> <span class="nn">mindspore.common.jit_config</span> <span class="kn">import</span> <span class="n">JitConfig</span>
<span class="kn">from</span> <span class="nn">mindspore.common.tensor</span> <span class="kn">import</span> <span class="n">Tensor</span> <span class="k">as</span> <span class="n">PythonTensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common.sparse_tensor</span> <span class="kn">import</span> <span class="n">CSRTensor</span> <span class="k">as</span> <span class="n">PythonCSRTensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common.sparse_tensor</span> <span class="kn">import</span> <span class="n">COOTensor</span> <span class="k">as</span> <span class="n">PythonCOOTensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common.sparse_tensor</span> <span class="kn">import</span> <span class="n">RowTensor</span> <span class="k">as</span> <span class="n">PythonRowTensor</span>
<span class="kn">from</span> <span class="nn">mindspore._c_expression</span> <span class="kn">import</span> <span class="n">GraphExecutor_</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">CSRTensor</span><span class="p">,</span> <span class="n">RowTensor</span><span class="p">,</span> <span class="n">COOTensor</span><span class="p">,</span> \
    <span class="n">PyNativeExecutor_</span><span class="p">,</span> <span class="n">verify_inputs_signature</span><span class="p">,</span> <span class="n">init_exec_dataset</span><span class="p">,</span> <span class="n">_set_dataset_mode_config</span><span class="p">,</span> <span class="n">init_pipeline</span><span class="p">,</span> \
    <span class="n">_ms_memory_recycle</span><span class="p">,</span> <span class="n">_bind_device_ctx</span>
<span class="kn">from</span> <span class="nn">mindspore.parallel._ps_context</span> <span class="kn">import</span> <span class="n">_is_role_sched</span>
<span class="kn">from</span> <span class="nn">mindspore.parallel._utils</span> <span class="kn">import</span> <span class="n">_check_full_batch</span><span class="p">,</span> <span class="n">_get_parameter_broadcast</span><span class="p">,</span> <span class="n">_is_pynative_parallel</span><span class="p">,</span> \
    <span class="n">_is_in_auto_parallel_mode</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">_checkparam</span> <span class="k">as</span> <span class="n">Validator</span>
<span class="kn">from</span> <span class="nn">mindspore._checkparam</span> <span class="kn">import</span> <span class="n">is_stub_tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common._utils</span> <span class="kn">import</span> <span class="n">is_shape_unknown</span>
<span class="kn">from</span> <span class="nn">mindspore.common.mutable</span> <span class="kn">import</span> <span class="n">mutable</span>
<span class="kn">from</span> <span class="nn">mindspore.common._register_for_adapter</span> <span class="kn">import</span> <span class="n">ms_adapter_registry</span>
<span class="kn">from</span> <span class="nn">mindspore.common.auto_dynamic_shape</span> <span class="kn">import</span> <span class="n">_AutoIdentifyDynamicShape</span>

<span class="c1"># Store ms_function class compiled pipeline cache.</span>
<span class="n">ms_compile_cache</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="c1"># Store cell compiled pipeline cache.</span>
<span class="n">cells_compile_cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">BROADCAST_PHASE</span> <span class="o">=</span> <span class="s2">&quot;_broadcast_&quot;</span>
<span class="n">_PYNATIVE_PARALLEL_FUNC_NAME</span> <span class="o">=</span> <span class="s2">&quot;after_shard&quot;</span>


<span class="k">def</span> <span class="nf">_convert_python_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert C++ data to python.</span>

<span class="sd">    Args:</span>
<span class="sd">        data : The data need be convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data, a data convert C++ to python</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">adapter_flag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ms_adapter_registry</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">PythonTensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PythonTensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CSRTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">PythonCSRTensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PythonCSRTensor</span><span class="p">(</span><span class="n">csr_tensor</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">COOTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">PythonCOOTensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PythonCOOTensor</span><span class="p">(</span><span class="n">coo_tensor</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">RowTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">PythonRowTensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PythonRowTensor</span><span class="p">(</span><span class="n">row_tensor</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_convert_python_data</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Keep list object not change for inplace operation.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convert_python_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">_convert_python_data</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">_convert_python_data</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_wrap_func</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function, convert return data to tensor or tuple of tensor.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): The function need be wrapped.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function, a new function with return suitable format data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_convert_python_data</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">_check_all_tensor</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_stub_tensor</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                                                                                    <span class="ow">and</span> <span class="n">_check_all_tensor</span><span class="p">(</span><span class="n">element</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_handle_func_args</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the *args and **kwargs inputs of the function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;fn </span><span class="si">{}</span><span class="s1"> is not function or method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">bound_arguments</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">bound_arguments</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">args</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">kwargs</span>

    <span class="n">positional_args</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">default_args</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">has_var</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
            <span class="n">has_var</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">positional_args</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default_args</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">has_var</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">positional_args</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs </span><span class="si">{</span><span class="n">positional_args</span><span class="si">}</span><span class="s2"> positional argument, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">positional_args</span> <span class="o">+</span> <span class="n">default_args</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs </span><span class="si">{</span><span class="n">positional_args</span><span class="si">}</span><span class="s2"> positional argument and </span><span class="si">{</span><span class="n">default_args</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;default argument, total </span><span class="si">{</span><span class="n">positional_args</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">default_args</span><span class="si">}</span><span class="s2">, but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>


<span class="n">sys_path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="c1"># Get the entry script path.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
    <span class="n">entry_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">entry_script_path_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">entry_script_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">entry_script_path_dir</span> <span class="ow">in</span> <span class="n">sys_path</span><span class="p">:</span>
        <span class="n">sys_path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry_script_path_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_in_sys_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sys_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">__get_compile_cache_dep_files</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">compile_cache_dep_files</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the dependency files of the network&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">module_name</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Do not care the files in mindspore package</span>
        <span class="k">if</span> <span class="n">module_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mindspore&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mindspore&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">whole_module</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">whole_module</span> <span class="o">=</span> <span class="n">module_name</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">whole_module</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module_spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">whole_module</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">whole_module</span> <span class="o">=</span> <span class="n">whole_module</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">whole_module</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
                <span class="n">module_spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">whole_module</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">module_spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">):</span>
                <span class="n">dep_file_path</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Exclude the installed modules.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_in_sys_path</span><span class="p">(</span><span class="n">dep_file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dep_file_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compile_cache_dep_files</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dependent file path: </span><span class="si">{</span><span class="n">dep_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">compile_cache_dep_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_file_path</span><span class="p">)</span>
                <span class="n">__get_compile_cache_dep_files</span><span class="p">(</span><span class="n">dep_file_path</span><span class="p">,</span> <span class="n">compile_cache_dep_files</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__package__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_compile_cache_dep_files</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the dependency files of the network&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">entry_script_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can not get the entry script file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">compile_cache_dep_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;entry script file path: </span><span class="si">{</span><span class="n">entry_script_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">compile_cache_dep_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_script_path</span><span class="p">)</span>
    <span class="n">__get_compile_cache_dep_files</span><span class="p">(</span><span class="n">entry_script_path</span><span class="p">,</span> <span class="n">compile_cache_dep_files</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compile_cache_dep_files</span>


<span class="k">def</span> <span class="nf">_restore_mutable_attr</span><span class="p">(</span><span class="n">args_list</span><span class="p">,</span> <span class="n">compile_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore the mutable attr for every arg.&quot;&quot;&quot;</span>
    <span class="n">new_compile_args</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_mutable__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_mutable__&quot;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;const_arg&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;const_arg&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_dynamic_len__&quot;</span><span class="p">):</span>
                <span class="n">new_compile_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">mutable</span><span class="p">(</span><span class="n">compile_args</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_dynamic_len__&quot;</span><span class="p">)),)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_compile_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">mutable</span><span class="p">(</span><span class="n">compile_args</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="kc">False</span><span class="p">),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_compile_args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">compile_args</span><span class="p">[</span><span class="n">idx</span><span class="p">],)</span>
    <span class="k">return</span> <span class="n">new_compile_args</span>


<span class="k">def</span> <span class="nf">_get_parameter_layout</span><span class="p">():</span>
    <span class="n">graph_executor</span> <span class="o">=</span> <span class="n">GraphExecutor_</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">ms_compile_cache</span><span class="p">:</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">graph_executor</span><span class="o">.</span><span class="n">get_parameter_layout</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">layout</span>


<span class="k">def</span> <span class="nf">_handle_arg</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle arg for runtime .If need handle the arg, return True&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">PythonTensor</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">has_init</span><span class="p">:</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">init_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">const_arg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">CSRTensor</span><span class="p">,</span> <span class="n">COOTensor</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_mutable__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__ms_mutable__&quot;</span><span class="p">):</span>
        <span class="c1"># mutable([]) will be eliminated by FuncGraphSpecializer, and empty list is not supported by backend.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;grad_for_scalar&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;enable_tuple_broaden&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">_check_all_tensor</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_args_for_run</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the actual input args and kwargs for runtime.&quot;&quot;&quot;</span>
    <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">new_arg</span> <span class="o">=</span> <span class="n">_handle_arg</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_arg</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">_handle_arg</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_args</span>


<span class="k">class</span> <span class="nc">_MindsporeFunctionExecutor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a function compiled by graph compiler.</span>

<span class="sd">    _MindsporeFunctionExecutor will compile the original function for every combination</span>
<span class="sd">    of argument types and shapes it is given (as well as their values, optionally).</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): The root function to compile.</span>
<span class="sd">        input_signature (Function): User defines signature to verify input.</span>
<span class="sd">        ms_create_time(TimeStamp): Time the function was created</span>
<span class="sd">        obj (Object): If function is a method, obj is the owner of function,</span>
<span class="sd">             else, obj is none.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The result of pipeline running in graph mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">ms_create_time</span><span class="p">,</span> <span class="n">input_signature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jit_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">init_pipeline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;fn </span><span class="si">{}</span><span class="s1"> is not function or method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span> <span class="o">=</span> <span class="n">input_signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shard_parent_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span> <span class="o">=</span> <span class="n">GraphExecutor_</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_time</span> <span class="o">=</span> <span class="n">ms_create_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jit_config_dict</span> <span class="o">=</span> <span class="n">jit_config</span><span class="o">.</span><span class="n">jit_config_dict</span> <span class="k">if</span> <span class="n">jit_config</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span> <span class="o">=</span> <span class="n">_AutoIdentifyDynamicShape</span><span class="p">()</span>

    <span class="nd">@_wrap_func</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">args_list</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args_list</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
                <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_jit_compile_status</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">*</span><span class="n">args_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_jit_compile_status</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">*</span><span class="n">args_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">clear_res</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;precompile_only&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">new_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_run_args</span><span class="p">(</span><span class="n">args_list</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_inputs</span><span class="p">),</span> <span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">grad_jit</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">new_inputs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns pipeline for the given args.&quot;&quot;&quot;</span>
        <span class="c1"># Check whether hook function registered on Cell object.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_hook_fn_registered&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">_hook_fn_registered</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, it&#39;s not support hook function when using &#39;jit&#39; decorator. &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;If you want to use hook function, please use context.set_context to set &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;pynative mode and remove &#39;jit&#39; decorator.&quot;</span><span class="p">)</span>
        <span class="c1"># Chose dynamic shape tensors or actual input tensors as compile args.</span>
        <span class="n">compile_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># Restore the mutable attr for every arg.</span>
        <span class="n">compile_args</span> <span class="o">=</span> <span class="n">_restore_mutable_attr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">compile_args</span><span class="p">)</span>
        <span class="n">generate_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> \
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">grad_flag</span><span class="p">():</span>
            <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s2">&quot;.grad&quot;</span>
        <span class="k">if</span> <span class="n">_is_pynative_parallel</span><span class="p">():</span>
            <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span><span class="p">[:</span><span class="n">generate_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)))]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shard_parent_obj</span><span class="p">))</span>

        <span class="c1"># Add key with obj</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The module of `self.obj`: `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">` is not same with the module of `self.fn`: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">`&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">__parse_method__</span> <span class="o">=</span> <span class="n">method_name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
                <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_time</span><span class="p">)</span>
            <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Different instance of same class may use same memory(means same obj_id) at diff times.</span>
            <span class="c1"># To avoid unexpected phase matched, add create_time to generate_name.</span>
            <span class="n">generate_name</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;enable_tuple_broaden&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">enable_tuple_broaden</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_enable_tuple_broaden</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">generate_arguments_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">compile_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">generate_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span><span class="o">.</span><span class="n">update_phase_and_compile_args</span><span class="p">(</span><span class="n">compile_args</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">ms_compile_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phase</span>

        <span class="c1"># If enable compile cache, get the dependency files list and set to graph executor.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_compile_cache_dep_files</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit_config_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_jit_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jit_config_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jit_config_dict</span> <span class="o">=</span> <span class="n">JitConfig</span><span class="p">()</span><span class="o">.</span><span class="n">jit_config_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_jit_config</span><span class="p">(</span><span class="n">jit_config_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_compile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">compile_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_weights_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">parameters_dict</span><span class="p">())</span>
            <span class="n">is_compile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">compile_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_compile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Executor compile failed.&quot;</span><span class="p">)</span>
        <span class="n">ms_compile_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_optimizer_state_init</span><span class="p">(</span><span class="n">opt_states</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set data for all optimizer states in case it is executed in graph mode&quot;&quot;&quot;</span>
        <span class="n">prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;moments&quot;</span><span class="p">,</span> <span class="s2">&quot;accum&quot;</span><span class="p">,</span> <span class="s2">&quot;moment1&quot;</span><span class="p">,</span> <span class="s2">&quot;moment2&quot;</span><span class="p">,</span> <span class="s2">&quot;lamb_m&quot;</span><span class="p">,</span> <span class="s2">&quot;lamb_v&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_grad&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;mean_square&quot;</span><span class="p">,</span> <span class="s2">&quot;prev&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">opt_param</span> <span class="ow">in</span> <span class="n">opt_states</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">opt_param</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">opt_param</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">opt_param</span><span class="o">.</span><span class="n">has_init</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefix_list</span> <span class="ow">or</span> <span class="n">opt_param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;global_step&quot;</span><span class="p">):</span>
                <span class="n">opt_param</span><span class="o">.</span><span class="n">init_data</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_set_compile_cache_dep_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If enable compile cache, get the dependency files list</span>
        <span class="n">enable_compile_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;enable_compile_cache&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_compile_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">enable_compile_cache</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">enable_compile_cache</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MS_COMPILER_CACHE_ENABLE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_compile_cache</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">enable_compile_cache</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_compile_cache_dep_files</span><span class="p">(</span><span class="n">_get_compile_cache_dep_files</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">_generate_compile_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Chose dynamic shape tensors or actual input tensors as compile args.&quot;&quot;&quot;</span>
        <span class="c1"># Case: If the shape of input args is dynamic, get dynamic shape tensor from context and use it to compile.</span>
        <span class="n">compile_args</span> <span class="o">=</span> <span class="n">args_list</span>
        <span class="c1"># Case: The `set_inputs()` of Cell object has been set, using these dynamic shape args as compile args.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;construct&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">():</span>
            <span class="n">compile_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compile_args</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of actual input tensors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not equal to the number of &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;dynamic shape tensors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">compile_args</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compile_args</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">PythonTensor</span><span class="p">):</span>
                    <span class="n">Validator</span><span class="o">.</span><span class="n">check_dynamic_shape</span><span class="p">(</span><span class="n">compile_args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># Case: If dynamic shape tensors have been assigned to `input_signature`, they are preferred as compile args.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">)</span>
            <span class="n">dyn_shape</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">PythonTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_shape_unknown</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">Validator</span><span class="o">.</span><span class="n">check_dynamic_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">dyn_shape</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">dyn_shape</span><span class="p">:</span>
                <span class="c1"># Checkout whether the `sens` has been added to args_list.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of actual input args &#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; is one more than the number &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;of input_signature args &#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. The last actual args may &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;be &#39;sens&#39; and added it to compile args.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">compile_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">)</span>
                <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_dynamic_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_inputs_signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_signature</span><span class="p">,</span> <span class="n">args_list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input args is incompatible with the args in `input_signature`!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compile_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span><span class="o">.</span><span class="n">auto_dynamic_generate_compile_args</span><span class="p">(</span><span class="n">args_list</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compile_args</span>

    <span class="k">def</span> <span class="nf">_generate_run_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate input args, which are required for running.</span>

<span class="sd">        Args:</span>
<span class="sd">            args_list (Tuple): Actual input args.</span>
<span class="sd">            kwargs (Dict): Actual input kwargs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_inputs, new input args, which are required for running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_get_args_for_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_list</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># The attributes used to identify a given object.</span>
<span class="n">attr_op</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__str__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
           <span class="s2">&quot;__hash__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()),</span>
           <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
           <span class="s2">&quot;__name__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
           <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
           <span class="s2">&quot;__len__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()),</span>
           <span class="s2">&quot;__code__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">)</span>
           <span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_obj_id</span><span class="p">(</span><span class="n">input_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get hash id of single object.&quot;&quot;&quot;</span>
    <span class="n">obj_id</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">attr_op</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)(</span><span class="n">input_obj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">input_obj</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">input_obj</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">attr_op</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">obj_id</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">input_obj</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_jit_hash</span><span class="p">(</span><span class="n">hash_input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get hash value of single object or list of objects.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_get_obj_id</span><span class="p">,</span> <span class="n">hash_input</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_get_obj_id</span><span class="p">(</span><span class="n">hash_input</span><span class="p">)</span>


<div class="viewcode-block" id="jit"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.jit.html#mindspore.jit">[文档]</a><span class="k">def</span> <span class="nf">jit</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_signature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hash_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jit_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a callable MindSpore graph from a Python function.</span>

<span class="sd">    This allows the MindSpore runtime to apply optimizations based on graph.</span>

<span class="sd">    Note:</span>
<span class="sd">        If `input_signature` is specified, each input of `fn` must be a Tensor. And the input arguments for `fn`</span>
<span class="sd">        will not accept `**kwargs`.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): The Python function that will be run as a graph. Default: ``None`` .</span>
<span class="sd">        input_signature (Tensor): The Tensor which describes the input arguments. The shape and dtype of the Tensor</span>
<span class="sd">            will be supplied to this function. If input_signature is specified, each input to `fn` must be a `Tensor`.</span>
<span class="sd">            And the input parameters of `fn` cannot accept `**kwargs`. The shape and dtype of actual inputs should</span>
<span class="sd">            keep the same as input_signature. Otherwise, TypeError will be raised. Default: ``None`` .</span>
<span class="sd">        hash_args (Union[Object, List or Tuple of Objects]): The local free variables used inside `fn`,</span>
<span class="sd">            like functions or objects of class defined outside `fn`. Calling `fn` again with change of `hash_args`</span>
<span class="sd">            will trigger recompilation. Default: ``None`` .</span>
<span class="sd">        jit_config (JitConfig): Jit config for compile. Default: ``None`` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function, if `fn` is not None, returns a callable function that will execute the compiled function; If `fn` is</span>
<span class="sd">        None, returns a decorator and when this decorator invokes with a single `fn` argument, the callable function is</span>
<span class="sd">        equal to the case when `fn` is not None.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import ops</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import jit</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; x = Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))</span>
<span class="sd">        &gt;&gt;&gt; y = Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph by calling decorator @jit</span>
<span class="sd">        &gt;&gt;&gt; def tensor_add(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; tensor_add_graph = jit(fn=tensor_add)</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_graph(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph through decorator @jit</span>
<span class="sd">        &gt;&gt;&gt; @jit</span>
<span class="sd">        ... def tensor_add_with_dec(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_with_dec(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph through decorator @jit with input_signature parameter</span>
<span class="sd">        &gt;&gt;&gt; @jit(input_signature=(Tensor(np.ones([1, 1, 3, 3]).astype(np.float32)),</span>
<span class="sd">        ...                       Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))))</span>
<span class="sd">        ... def tensor_add_with_sig(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_with_sig(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        ... # Set hash_args as fn, otherwise cache of compiled `closure_fn` will not be reused.</span>
<span class="sd">        ... # While fn differs during calling again, recompilation will be triggered.</span>
<span class="sd">        &gt;&gt;&gt; def func(x):</span>
<span class="sd">        ...     return ops.exp(x)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; def closure_fn(x, fn):</span>
<span class="sd">        ...     @jit(hash_args=fn)</span>
<span class="sd">        ...     def inner_fn(a):</span>
<span class="sd">        ...         return fn(a)</span>
<span class="sd">        ...     return inner_fn(x)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; inputs = Tensor(np.ones([10, 10, 10]).astype(np.float32))</span>
<span class="sd">        &gt;&gt;&gt; for i in range(10):</span>
<span class="sd">        ...     closure_fn(inputs, func)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">wrap_mindspore</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hash_args</span><span class="p">:</span>
            <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">_get_jit_hash</span><span class="p">(</span><span class="n">hash_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hash_obj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">staging_specialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MS_JIT&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">_handle_func_args</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">process_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PythonTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
                <span class="n">process_obj</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># only the function or cell instance wrapped by shard will fall into this branch</span>
            <span class="k">if</span> <span class="n">_is_pynative_parallel</span><span class="p">()</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">_PYNATIVE_PARALLEL_FUNC_NAME</span><span class="p">:</span>
                <span class="n">process_obj</span> <span class="o">=</span> <span class="n">hash_args</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_MindsporeFunctionExecutor</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">hash_obj</span><span class="p">,</span> <span class="n">input_signature</span><span class="p">,</span> <span class="n">process_obj</span><span class="p">,</span> <span class="n">jit_config</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">return</span> <span class="n">staging_specialize</span>

    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wrap_mindspore</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrap_mindspore</span></div>


<div class="viewcode-block" id="ms_function"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.ms_function.html#mindspore.ms_function">[文档]</a><span class="k">def</span> <span class="nf">ms_function</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_signature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hash_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jit_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a callable MindSpore graph from a Python function.</span>

<span class="sd">    This allows the MindSpore runtime to apply optimizations based on graph.</span>

<span class="sd">    Note:</span>
<span class="sd">        `ms_function` will be deprecated and removed in a future version. Please use `jit` instead.</span>
<span class="sd">        If `input_signature` is specified, each input of `fn` must be a Tensor. And the input arguments for `fn`</span>
<span class="sd">        will not accept `**kwargs`.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): The Python function that will be run as a graph. Default: ``None`` .</span>
<span class="sd">        input_signature (Tensor): The Tensor which describes the input arguments. The shape and dtype of the Tensor</span>
<span class="sd">            will be supplied to this function. If input_signature is specified, each input to `fn` must be a `Tensor`.</span>
<span class="sd">            And the input parameters of `fn` cannot accept `**kwargs`. The shape and dtype of actual inputs should</span>
<span class="sd">            keep the same as input_signature. Otherwise, TypeError will be raised. Default: ``None`` .</span>
<span class="sd">        hash_args (Union[Object, List or Tuple of Objects]): The local free variables used inside `fn`,</span>
<span class="sd">            like functions or objects of class defined outside `fn`. Calling `fn` again with change of `hash_args`</span>
<span class="sd">            will trigger recompilation. Default: ``None`` .</span>
<span class="sd">        jit_config (JitConfig): Jit config for compile. Default: ``None`` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function, if `fn` is not None, returns a callable function that will execute the compiled function; If `fn` is</span>
<span class="sd">        None, returns a decorator and when this decorator invokes with a single `fn` argument, the callable function is</span>
<span class="sd">        equal to the case when `fn` is not None.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import ops</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import ms_function</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; x = Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))</span>
<span class="sd">        &gt;&gt;&gt; y = Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph by calling ms_function</span>
<span class="sd">        &gt;&gt;&gt; def tensor_add(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; tensor_add_graph = ms_function(fn=tensor_add)</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_graph(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph through decorator @ms_function</span>
<span class="sd">        &gt;&gt;&gt; @ms_function</span>
<span class="sd">        ... def tensor_add_with_dec(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_with_dec(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; # create a callable MindSpore graph through decorator @ms_function with input_signature parameter</span>
<span class="sd">        &gt;&gt;&gt; @ms_function(input_signature=(Tensor(np.ones([1, 1, 3, 3]).astype(np.float32)),</span>
<span class="sd">        ...                               Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))))</span>
<span class="sd">        ... def tensor_add_with_sig(x, y):</span>
<span class="sd">        ...     z = x + y</span>
<span class="sd">        ...     return z</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; out = tensor_add_with_sig(x, y)</span>
<span class="sd">        ...</span>
<span class="sd">        ... # Set hash_args as fn, otherwise cache of compiled `closure_fn` will not be reused.</span>
<span class="sd">        ... # While fn differs during calling again, recompilation will be triggered.</span>
<span class="sd">        &gt;&gt;&gt; def func(x):</span>
<span class="sd">        ...     return ops.exp(x)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; def closure_fn(x, fn):</span>
<span class="sd">        ...     @ms_function(hash_args=fn)</span>
<span class="sd">        ...     def inner_fn(a):</span>
<span class="sd">        ...         return fn(a)</span>
<span class="sd">        ...     return inner_fn(x)</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; inputs = Tensor(np.ones([10, 10, 10]).astype(np.float32))</span>
<span class="sd">        &gt;&gt;&gt; for i in range(10):</span>
<span class="sd">        ...     closure_fn(inputs, func)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;mindspore.ms_function&#39; will be deprecated and removed in a future version. &quot;</span>
                   <span class="s2">&quot;Please use &#39;mindspore.jit&#39; instead.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jit</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">input_signature</span><span class="o">=</span><span class="n">input_signature</span><span class="p">,</span> <span class="n">hash_args</span><span class="o">=</span><span class="n">hash_args</span><span class="p">,</span> <span class="n">jit_config</span><span class="o">=</span><span class="n">jit_config</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_core</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A decorator that adds a flag to the function.</span>

<span class="sd">    By default, the function is marked as True, enabling to use this decorator to</span>
<span class="sd">    set flag to a graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): Function to add flag. Default: ``None``.</span>
<span class="sd">        flags (dict): The following flags can be set core, which indicates that this is a core function or</span>
<span class="sd">                      other flag. Default: ``None``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function, the function with core flag.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># need set the attr and access on c++</span>
    <span class="k">def</span> <span class="nf">deco</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">_func_graph_flags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;core&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">flags</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">deco</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">deco</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_add_flags</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A decorator that adds a flag to the function.</span>

<span class="sd">    Note:</span>
<span class="sd">        Only supports bool value.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn (Function): Function or cell to add flag. Default: ``None``.</span>
<span class="sd">        flags (dict): Flags use kwargs. Default: ``None``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function, the function with added flags.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">deco</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="c1"># need set the attr and access on c++</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;_func_graph_flags&quot;</span><span class="p">):</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">_func_graph_flags</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fn</span><span class="o">.</span><span class="n">_func_graph_flags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="n">flags</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">deco</span>
    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">deco</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_no_recursive</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method or function decorator for ignoring recursive check.</span>

<span class="sd">    This allows MindSpore to skip the procedure of checking function or method recursive.</span>

<span class="sd">    Args:</span>
<span class="sd">        callable_obj (Union(method, function)): The function or method to call.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Function or method with no_recursive flag.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ms_class is used for non-class types or nn.Cell.</span>
<span class="sd">        AttributeError: If the private attributes or magic methods of the class decorated by ms_class is called.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isCellSubClass</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isCellSubClass</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorator no_recursive is used for callable object, but got </span><span class="si">{</span><span class="n">callable_obj</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">_add_flags</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">,</span> <span class="n">no_recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">callable_obj</span>


<div class="viewcode-block" id="ms_class"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.ms_class.html#mindspore.ms_class">[文档]</a><span class="k">def</span> <span class="nf">ms_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class decorator for user-defined classes.</span>

<span class="sd">    This allows MindSpore to identify user-defined classes and thus obtain their attributes and methods.</span>

<span class="sd">    Note:</span>
<span class="sd">        `ms_class` will be deprecated and removed in a future version. Please use `jit_class` instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls (Class): User-defined class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Class.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ms_class is used for non-class types or nn.Cell.</span>
<span class="sd">        AttributeError: If the private attributes or magic methods of the class decorated with ms_class is called.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import ms_class</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; @ms_class</span>
<span class="sd">        ... class UserDefinedNet:</span>
<span class="sd">        ...     def __init__(self):</span>
<span class="sd">        ...         self.value = 10</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def func(self, x):</span>
<span class="sd">        ...         return 2 * x</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">        ...     def __init__(self):</span>
<span class="sd">        ...         super(Net, self).__init__()</span>
<span class="sd">        ...         self.net = UserDefinedNet()</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def construct(self, x):</span>
<span class="sd">        ...         out = self.net.value + self.net.func(x)</span>
<span class="sd">        ...         return out</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; net = Net()</span>
<span class="sd">        &gt;&gt;&gt; out = net(5)</span>
<span class="sd">        &gt;&gt;&gt; print(out)</span>
<span class="sd">        20</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;mindspore.ms_class&#39; will be deprecated and removed in a future version. &quot;</span>
                   <span class="s2">&quot;Please use &#39;mindspore.jit_class&#39; instead.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if cls is of type class.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decorator ms_class can only be used for class type, but got </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># Check if cls is nn.Cell.</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorator ms_class is used for user-defined classes and cannot be used for nn.Cell: </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found ms_class: </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__ms_class__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span></div>


<div class="viewcode-block" id="jit_class"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.jit_class.html#mindspore.jit_class">[文档]</a><span class="k">def</span> <span class="nf">jit_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class decorator for user-defined classes.</span>

<span class="sd">    This allows MindSpore to identify user-defined classes and thus obtain their attributes and methods.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls (Class): User-defined class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Class.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `jit_class` is used for non-class types or nn.Cell.</span>
<span class="sd">        AttributeError: If the private attributes or magic methods of the class decorated with `jit_class` is called.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import jit_class</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; @jit_class</span>
<span class="sd">        ... class UserDefinedNet:</span>
<span class="sd">        ...     def __init__(self):</span>
<span class="sd">        ...         self.value = 10</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def func(self, x):</span>
<span class="sd">        ...         return 2 * x</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">        ...     def __init__(self):</span>
<span class="sd">        ...         super(Net, self).__init__()</span>
<span class="sd">        ...         self.net = UserDefinedNet()</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def construct(self, x):</span>
<span class="sd">        ...         out = self.net.value + self.net.func(x)</span>
<span class="sd">        ...         return out</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; net = Net()</span>
<span class="sd">        &gt;&gt;&gt; out = net(5)</span>
<span class="sd">        &gt;&gt;&gt; print(out)</span>
<span class="sd">        20</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
    <span class="c1"># Check if cls is of type class.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decorator jit_class can only be used for class type, but got </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># Check if cls is nn.Cell.</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorator jit_class is used for user-defined classes and cannot be used for nn.Cell: </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__ms_class__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span></div>


<span class="k">def</span> <span class="nf">set_adapter_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register configuration information for MSAdapter.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): Configuration information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The input argument of &#39;set_adapter_config&#39; should be a dict, but got </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
            <span class="n">ms_adapter_registry</span><span class="o">.</span><span class="n">register_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Parameter&quot;</span><span class="p">:</span>
            <span class="n">ms_adapter_registry</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;convert_object_map&quot;</span><span class="p">:</span>
            <span class="n">ms_adapter_registry</span><span class="o">.</span><span class="n">register_convert_map</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported key in adapter config: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_function_forbid_reuse</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decorator _function_forbid_reuse can only be used for function type, but got </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__function_forbid_reuse__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_build_broadcast_graph</span><span class="p">(</span><span class="n">broadcast_params_dict</span><span class="p">,</span> <span class="n">broadcast_phase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build broadcast graph.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mindspore.nn.wrap.cell_wrapper</span> <span class="kn">import</span> <span class="n">_BroadCastCell</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">broadcast_params_dict</span><span class="p">:</span>
        <span class="n">broadcast_params_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">broadcast_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">broadcast_params_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">broadcast_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()))</span>
    <span class="n">_broadcast_net</span> <span class="o">=</span> <span class="n">_BroadCastCell</span><span class="p">(</span><span class="n">broadcast_params</span><span class="p">)</span>
    <span class="n">_broadcast_net</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">broadcast_phase</span>
    <span class="n">broadcasted_params</span> <span class="o">=</span> <span class="n">_broadcast_net</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">broadcast_params_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">broadcasted_params</span><span class="p">):</span>
        <span class="n">broadcast_params_dict</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_auto_split_param_names</span><span class="p">(</span><span class="n">parameter_layout_dict</span><span class="p">):</span>
    <span class="n">auto_split_param_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameter_layout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">auto_split_param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">auto_split_param_names</span>


<span class="k">def</span> <span class="nf">_parameter_broadcast</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameter broadcast.</span>
<span class="sd">    When the parallel mode is &#39;semi_auto_parallel&#39; or &#39;auto_parallel&#39;, it will broadcast the parameters that have not</span>
<span class="sd">    split.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">auto_split_param_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">_is_in_auto_parallel_mode</span><span class="p">():</span>
        <span class="n">auto_split_param_names</span> <span class="o">=</span> <span class="n">_get_auto_split_param_names</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">parameter_layout_dict</span><span class="p">)</span>

    <span class="n">broadcast_params_dict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">parameters_broadcast_dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">auto_split_param_names</span> <span class="ow">and</span> <span class="n">broadcast_params_dict</span><span class="p">:</span>
        <span class="n">broadcast_params_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">parameters_broadcast_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">auto_split_param_names</span><span class="p">:</span>
                <span class="n">broadcast_params_dict</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">broadcast_phase</span> <span class="o">=</span> <span class="s2">&quot;_broadcast_subgraph&quot;</span>
    <span class="n">_build_broadcast_graph</span><span class="p">(</span><span class="n">broadcast_params_dict</span><span class="p">,</span> <span class="n">broadcast_phase</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_no_grad</span><span class="p">(</span><span class="n">contextlib</span><span class="o">.</span><span class="n">ContextDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context Manager to disable gradient calculation. When enter this context, we will disable calculate</span>
<span class="sd">    gradient. When exit this context, we will resume its prev state.</span>
<span class="sd">    Currently, it can only use in Pynative mode. It also can be used as decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;For no_grad feature, currently only support Pynative mode, but got Graph mode.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">()</span>
        <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_enable_grad</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_enable_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">_PyNativeExecutor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pynative executor used to compile/manage/run single op.</span>

<span class="sd">    The main functions include: construct op graph, compile op graph, auto grad and run op graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (Object): The python network that will be run in pynative mode.</span>
<span class="sd">        args (Tuple(Tensor...)): The inputs of network in tuple form.</span>

<span class="sd">    Returns:</span>
<span class="sd">        gradients (Tuple(Tensor...)): The gradients of network parameters and inputs.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">PyNativeExecutor_</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_py_exe_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_kernel_build_server_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kernel_build_server</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_cell</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PyNative executor run grad graph.</span>

<span class="sd">        Return:</span>
<span class="sd">            The return object after running grad graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parameter_broadcast</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run broadcast for parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Cell): The cell instance.</span>
<span class="sd">            phase (str): The phase of cell instance.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">BROADCAST_PHASE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase</span> <span class="ow">and</span> <span class="n">_get_parameter_broadcast</span><span class="p">():</span>
            <span class="n">_parameter_broadcast</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">real_run_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run single op.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Op prim and input arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            Tensor, result of run op.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">real_run_op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_op_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run single op async.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Op prim and input arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            StubNode, result of run op.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">run_op_async</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize resources for building forward and backward graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Function/Cell): The function or cell instance.</span>
<span class="sd">            args (tuple): Function or cell input arguments.</span>
<span class="sd">            kwargs (dict): keyword arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">new_graph</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">end_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean resources after building forward and backward graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Function/Cell): The function or cell instance.</span>
<span class="sd">            output (Tensor/tuple/list): Function or cell output object.</span>
<span class="sd">            args (tuple): Function or cell input arguments.</span>
<span class="sd">            kwargs (dict): keyword arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">end_graph</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">check_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">grad_hash_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether the forward graph need to construct.</span>

<span class="sd">        Args:</span>
<span class="sd">            grad (GradOperation): The gradoperation object.</span>
<span class="sd">            obj (Function/Cell): The function or cell instance.</span>
<span class="sd">            grad_hash_id (tuple): The id of objects which contribute to cache of compiled graph in pynative mode.</span>
<span class="sd">            args (tuple): Function or cell input arguments.</span>
<span class="sd">            kwargs (dict): keyword arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, specifies whether the forward graph need to construct.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">check_run</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">grad_hash_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">grad_position</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get grad graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Function/Cell): The function or cell instance.</span>
<span class="sd">            grad (GradOperation): The gradoperation object.</span>
<span class="sd">            weights (ParameterTuple): The weights of cell instance.</span>
<span class="sd">            grad_position (Union(int, tuple[int])): If int, get the gradient with respect to single input.</span>
<span class="sd">              If tuple, get the gradients with respect to selected inputs. &#39;grad_position&#39; begins with 0. Default: 0.</span>
<span class="sd">            args (tuple): Function or cell input arguments.</span>
<span class="sd">            kwargs (dict): keyword arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">grad_net</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">grad_position</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">clear_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean resource for _PyNativeExecutor.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">clear_res</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SyncStream.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">grad_jit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Building grad graph decorated by jit.</span>

<span class="sd">        Args:</span>
<span class="sd">            output (tuple): The function or cell decorated by jit output object.</span>
<span class="sd">            args (tuple): Function or cell decorated by jit input arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">grad_jit</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">grad_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The flag of building grad graph.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, whether building grad graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">grad_flag</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_grad_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the flag of building grad graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            flag (bool): Specifying whether building grad graph.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_grad_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">enable_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The global flag whether needing to calculate gradient.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, whether needing to calculate gradient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_enable_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the flag of calculating gradient.</span>

<span class="sd">        Args:</span>
<span class="sd">            flag (bool): Specifying whether calculating gradient.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_enable_grad</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_jit_compile_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set jit is compiling</span>

<span class="sd">        Args:</span>
<span class="sd">            status(bool): jit compile status</span>
<span class="sd">            phase (str): The phase of cell/function instance.</span>
<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_jit_compile_status</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_dynamic_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set dynamic shape tensor of input arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Function/Cell): The function or cell instance.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_dynamic_input</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_first_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The flag of first cell instance.</span>

<span class="sd">        Return:</span>
<span class="sd">            bool, specifies whether is the first cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">is_first_cell</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_hook_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The flag of registering or removing a hook function on Cell instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            cell (Cell): The cell instance.</span>

<span class="sd">        Return:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">set_hook_changed</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_top_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the top cell object.</span>

<span class="sd">        Return:</span>
<span class="sd">            The top cell object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_cell</span>

    <span class="k">def</span> <span class="nf">constant_folding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get value by infer value.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Op prim and input arguments.</span>

<span class="sd">        Return:</span>
<span class="sd">            Tensor, the value get by op infer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">constant_folding</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CellGraphExecutor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An executor used to compile/manage/run graph for a Cell.</span>

<span class="sd">    Including data_graph, train_graph, eval_graph and predict graph.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (Function/Cell): The function or cell instance need compile.</span>
<span class="sd">        args (tuple): Function or cell input arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Graph, return the result of pipeline running.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create needed graph by lazy mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># used for model&#39;s dynamic obfuscation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span> <span class="o">=</span> <span class="n">GraphExecutor_</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_py_exe_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_kernel_build_server_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kernel_build_server</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span> <span class="o">=</span> <span class="n">_AutoIdentifyDynamicShape</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">dataset_types</span><span class="p">,</span> <span class="n">dataset_shapes</span><span class="p">,</span>
                     <span class="n">input_indexs</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="n">need_run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization interface for calling data subgraph.</span>

<span class="sd">        Args:</span>
<span class="sd">            queue_name (str): The name of tdt queue on the device.</span>
<span class="sd">            dataset_size (int): The size of dataset.</span>
<span class="sd">            batch_size (int): The size of batch.</span>
<span class="sd">            dataset_types (list): The output types of element in dataset.</span>
<span class="sd">            dataset_shapes (list): The output shapes of element in dataset.</span>
<span class="sd">            input_indexs (list): The index of data with net.</span>
<span class="sd">            phase (str): The name of phase, e.g., train_dataset/eval_dataset. Default: &#39;dataset&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool, specifies whether the data subgraph was initialized successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">init_exec_dataset</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
                                 <span class="n">size</span><span class="o">=</span><span class="n">dataset_size</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                 <span class="n">types</span><span class="o">=</span><span class="n">dataset_types</span><span class="p">,</span>
                                 <span class="n">shapes</span><span class="o">=</span><span class="n">dataset_shapes</span><span class="p">,</span>
                                 <span class="n">input_indexs</span><span class="o">=</span><span class="n">input_indexs</span><span class="p">,</span>
                                 <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                 <span class="n">need_run</span><span class="o">=</span><span class="n">need_run</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failure to init and dataset subgraph!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_queue_name</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">set_queue_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        while a mode use shared dataset with others, need set queue_name which saved in data_set</span>
<span class="sd">        :param queue_name:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_queue_name</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queue_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get cached queue name for the graph loaded from compile cache.</span>
<span class="sd">        :return: cached queue name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_queue_name</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_dataset_mode</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set dataset mode.&quot;&quot;&quot;</span>
        <span class="c1"># decide whether to sink based on the sink_mode flag which is set in connect_network_with_dataset</span>
        <span class="k">if</span> <span class="s1">&#39;sink_mode&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_flags</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_flags</span><span class="p">()[</span><span class="s1">&#39;sink_mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_set_dataset_mode_config</span><span class="p">(</span><span class="s1">&#39;sink&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_set_dataset_mode_config</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_use_vm_mode</span><span class="p">():</span>
        <span class="n">enable_ge</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;enable_ge&quot;</span><span class="p">)</span>
        <span class="n">enable_debug_runtime</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;enable_debug_runtime&quot;</span><span class="p">)</span>
        <span class="n">exe_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">enable_ge</span> <span class="ow">or</span> <span class="p">(</span><span class="n">enable_debug_runtime</span> <span class="ow">and</span> <span class="n">exe_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_data_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">build_data_graph</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">parameters_dict</span><span class="p">(),</span> <span class="n">phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_compile_cache_dep_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="c1"># If enable compile cache, get the dependency files list</span>
        <span class="n">enable_compile_cache</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;enable_compile_cache&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_compile_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">enable_compile_cache</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">enable_compile_cache</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MS_COMPILER_CACHE_ENABLE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;train&quot;</span> <span class="ow">in</span> <span class="n">phase</span> <span class="ow">and</span> <span class="p">(</span><span class="n">enable_compile_cache</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">enable_compile_cache</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_compile_cache_dep_files</span><span class="p">(</span><span class="n">_get_compile_cache_dep_files</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="n">do_convert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jit_config_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compiles graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Function/Cell): The function or cell instance need compile.</span>
<span class="sd">            phase (str): The name of compile phase. Default: &#39;predict&#39;.</span>
<span class="sd">            do_convert (bool): When set to True, convert ME graph to GE graph after compiling graph.</span>
<span class="sd">            jit_config_dict (dict): Jit config for compile. Default: ``None``.</span>
<span class="sd">            args (tuple): Args of the Cell object.</span>
<span class="sd">            kwargs (dict): Kwargs of the Cell object.</span>

<span class="sd">        Return:</span>
<span class="sd">            Str, the full phase of the cell.</span>
<span class="sd">            Bool, if the graph has been compiled before, return False, else return True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">__parse_method__</span> <span class="o">=</span> <span class="s1">&#39;construct&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__parse_method__</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;The class </span><span class="si">{}</span><span class="s1"> dose not have method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__parse_method__</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;enable_tuple_broaden&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">enable_tuple_broaden</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_enable_tuple_broaden</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span><span class="o">.</span><span class="n">auto_dynamic_generate_compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">generate_arguments_key</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_tuple_broaden</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_identify_dynamic_shape</span><span class="o">.</span><span class="n">update_phase_and_compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">compile_cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">phase</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> graph has existed.&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">False</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">check_names</span><span class="p">()</span>
        <span class="n">_check_full_batch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dataset_mode</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_compile_cache_dep_files</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

        <span class="n">enable_ge</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;enable_ge&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_ge</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="n">ge_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_weights_values</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">parameters_dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">jit_config_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_jit_config</span><span class="p">(</span><span class="n">jit_config_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jit_config_dict</span> <span class="o">=</span> <span class="n">JitConfig</span><span class="p">()</span><span class="o">.</span><span class="n">jit_config_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">set_jit_config</span><span class="p">(</span><span class="n">jit_config_dict</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_vm_mode</span><span class="p">())</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">compile_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Executor compile failed.&quot;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_func_graph</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Compile graph failed for phase </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>

        <span class="n">auto_parallel_mode</span> <span class="o">=</span> <span class="n">_is_in_auto_parallel_mode</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_parallel_mode</span><span class="p">:</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">init_parameters_data</span><span class="p">(</span><span class="n">auto_parallel_mode</span><span class="o">=</span><span class="n">auto_parallel_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_node_default_input</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;skip_auto_parallel_compile&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_flags</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">parameter_layout_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_parameter_layout</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">parallel_parameter_name_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_parallel_parameter_name_list</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_convert</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">True</span>

        <span class="c1"># the following GE init process is not needed when use vm or ms backend</span>
        <span class="k">if</span> <span class="n">enable_ge</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="s2">&quot;export&quot;</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_data_graph</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">BROADCAST_PHASE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase</span> <span class="ow">and</span> <span class="n">_get_parameter_broadcast</span><span class="p">():</span>
            <span class="n">_parameter_broadcast</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_update_param_node_default_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="n">new_param</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">replace</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">replace</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="n">replace</span><span class="p">[</span><span class="n">x</span><span class="p">])}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">updata_param_node_default_input</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">new_param</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_shard_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">real_phase</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">(</span><span class="n">real_phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_num_parallel_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">real_phase</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_num_parallel_ops</span><span class="p">(</span><span class="n">real_phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_allreduce_fusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">real_phase</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_allreduce_fusion</span><span class="p">(</span><span class="n">real_phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;precompile_only&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_role_sched</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_compiled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specify whether have been compiled.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase (str): The phase name. Default: &#39;predict&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool, specifies whether the specific graph has been compiled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

    <span class="nd">@_wrap_func</span>
    <span class="k">def</span> <span class="nf">_exec_pip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the generated pipeline.&quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">construct</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">__parse_method__</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the specific graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj (Cell): The cell object.</span>
<span class="sd">            args (tuple): Args of the Cell object.</span>
<span class="sd">            phase (str): The phase name. Default: &#39;predict&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tensor/Tuple, return execute result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;save&#39;</span><span class="p">:</span>
            <span class="n">exe_phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="p">((),</span> <span class="n">exe_phase</span><span class="p">)</span>

        <span class="n">phase_real</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">phase_real</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_pip</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase_real</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> graph is not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase_real</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">del_net_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">net_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the memory resource of a network.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">del_net_res</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">net_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_branch_control_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;obf_ratio&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="s1">&#39;obf_random_seed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;obf_ratio&#39; and &#39;obf_random_seed&#39; must be in obfuscate_config.&quot;</span><span class="p">)</span>
        <span class="n">obf_random_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;obf_random_seed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obf_random_seed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">branch_control_input</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branch_control_input</span> <span class="o">=</span> <span class="n">_generate_branch_control_input</span><span class="p">(</span><span class="n">obf_random_seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">branch_control_input</span>

    <span class="k">def</span> <span class="nf">_get_func_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">exec_id</span><span class="p">,</span> <span class="n">use_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get func graph from pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_prefix</span><span class="p">:</span>
            <span class="n">exec_id</span> <span class="o">=</span> <span class="n">exec_id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;For get func graph, obfuscate_config is currently not supported now.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_func_graph</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_func_graph_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">exec_id</span><span class="p">,</span> <span class="n">ir_type</span><span class="o">=</span><span class="s2">&quot;onnx_ir&quot;</span><span class="p">,</span> <span class="n">use_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">incremental</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get graph proto from pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_prefix</span><span class="p">:</span>
            <span class="n">exec_id</span> <span class="o">=</span> <span class="n">exec_id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branch_control_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_branch_control_input</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_obfuscate_func_graph_proto</span><span class="p">(</span><span class="n">exec_id</span><span class="p">,</span> <span class="n">incremental</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">obfuscate_config</span><span class="p">[</span><span class="s1">&#39;obf_ratio&#39;</span><span class="p">],</span>
                                                                       <span class="n">branch_control_input</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_func_graph_proto</span><span class="p">(</span><span class="n">exec_id</span><span class="p">,</span> <span class="n">ir_type</span><span class="p">,</span> <span class="n">incremental</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_optimize_graph_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return optimize graph binary proto.&quot;&quot;&quot;</span>
        <span class="n">exec_id</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">create_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">arguments_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">has_compiled</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">graph_proto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">get_optimize_graph_proto</span><span class="p">(</span><span class="n">exec_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph_proto</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">graph_proto</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can not get optimize graph proto. Instead, try to find function graph.&quot;</span><span class="p">)</span>
            <span class="n">graph_proto</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_func_graph_proto</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">graph_proto</span>

    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">enc_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encrypt_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_name (str): File name of model to export</span>
<span class="sd">            graph_id (str): id of graph to be exported</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_executor</span><span class="o">.</span><span class="n">export_graph</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">,</span> <span class="n">encrypt_func</span><span class="p">,</span> <span class="n">enc_key</span><span class="p">)</span>


<div class="viewcode-block" id="ms_memory_recycle"><a class="viewcode-back" href="../../../api_python/mindspore/mindspore.ms_memory_recycle.html#mindspore.ms_memory_recycle">[文档]</a><span class="k">def</span> <span class="nf">ms_memory_recycle</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recycle memory used by MindSpore.</span>
<span class="sd">    When train multi Neural network models in one process, memory used by MindSpore is very large,</span>
<span class="sd">    this is because MindSpore cached runtime memory for every model.</span>
<span class="sd">    To recycle these cached memory, users can call this function after training of one model.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; ms.ms_memory_recycle()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ms_compile_cache</span><span class="p">:</span>
        <span class="n">_cell_graph_executor</span><span class="o">.</span><span class="n">del_net_res</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms_compile_cache</span><span class="p">)</span>
        <span class="n">ms_compile_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cell_cache</span> <span class="ow">in</span> <span class="n">cells_compile_cache</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cell_cache</span><span class="p">:</span>
            <span class="n">_cell_graph_executor</span><span class="o">.</span><span class="n">del_net_res</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_cache</span><span class="p">)</span>
            <span class="n">cell_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">_ms_memory_recycle</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_generate_branch_control_input</span><span class="p">(</span><span class="n">obf_random_seed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate append network input for dynamic obfuscation in random seed mode.&quot;&quot;&quot;</span>
    <span class="n">seed_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">int_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">obf_random_seed</span> <span class="o">%</span> <span class="n">seed_max</span><span class="p">)</span>
    <span class="c1"># generate a string as hash function inputs</span>
    <span class="n">word_repo</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span> <span class="o">+</span> <span class="s2">&quot;abcdefghigklmnopqrstuvwxyz&quot;</span> <span class="o">+</span> <span class="s2">&quot;0123456789&quot;</span>
    <span class="n">repo_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_repo</span><span class="p">)</span>
    <span class="n">sha_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">string_len</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">string_len</span><span class="p">):</span>
        <span class="n">rand_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">repo_len</span><span class="p">)</span>
        <span class="n">sha_string</span> <span class="o">+=</span> <span class="n">word_repo</span><span class="p">[</span><span class="n">rand_index</span><span class="p">]</span>
    <span class="c1"># get hash result</span>
    <span class="n">sha_result</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">sha_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># len is 64</span>
    <span class="n">branch_control_input</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">hex_base</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sha_result</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">hex_base</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">branch_control_input</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">hex_base</span><span class="p">)</span>
    <span class="n">branch_control_input</span> <span class="o">%=</span> <span class="n">int_max</span>
    <span class="k">return</span> <span class="n">branch_control_input</span>


<span class="k">def</span> <span class="nf">_bind_device_context</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bind device context to current thread&quot;&quot;&quot;</span>
    <span class="n">_bind_device_ctx</span><span class="p">()</span>


<span class="n">_cell_graph_executor</span> <span class="o">=</span> <span class="n">_CellGraphExecutor</span><span class="p">()</span>
<span class="n">_pynative_executor</span> <span class="o">=</span> <span class="n">_PyNativeExecutor</span><span class="p">()</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms_function&#39;</span><span class="p">,</span> <span class="s1">&#39;ms_memory_recycle&#39;</span><span class="p">,</span> <span class="s1">&#39;ms_class&#39;</span><span class="p">,</span> <span class="s1">&#39;jit&#39;</span><span class="p">,</span> <span class="s1">&#39;jit_class&#39;</span><span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>