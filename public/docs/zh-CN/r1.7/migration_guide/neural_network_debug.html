

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>网络调试 &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/training.css" type="text/css" />
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/training.js"></script>
        
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="精度调优" href="accuracy_optimization.html" />
    <link rel="prev" title="基于自定义算子接口调用第三方算子库" href="use_third_party_op.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/technical_white_paper.html">技术白皮书</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/all_scenarios_architecture.html">全场景统一</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/gradient.html">函数式微分编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/dynamic_graph_and_static_graph.html">动静态图结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/heterogeneous_training.html">异构并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/distributed_training_design.html">分布式并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/mindir.html">中间表达MindIR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/graph_kernel_fusion.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/second_order_optimizer.html">二阶优化</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.7/training_visual_design.html">可视化调试调优↗</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindarmour/docs/zh-CN/r1.7/design.html">安全可信↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/benchmark.html">基准性能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/network_list.html">网络支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/operator_list.html">算子支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/env_var_list.html">环境变量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/syntax_list.html">语法支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/api_mapping.html">API映射</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.context.html">mindspore.context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.audio.html">mindspore.dataset.audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.config.html">mindspore.dataset.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.text.html">mindspore.dataset.text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.vision.html">mindspore.dataset.vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.transformer.html">mindspore.nn.transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.functional.html">mindspore.ops.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.parallel.html">mindspore.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.parallel.nn.html">mindspore.parallel.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.profiler.html">mindspore.Profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/lite/api/zh-CN/r1.7/api_cpp/mindspore.html">C++ API↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">迁移指南</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="preparation.html">准备工作</a></li>
<li class="toctree-l1"><a class="reference internal" href="script_analysis.html">网络脚本分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="script_development.html">网络脚本开发</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">网络调试</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#网络调试的基本流程">网络调试的基本流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="#网络调试中的常用方法">网络调试中的常用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#流程调试">流程调试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#用pynative模式进行流程调试">用PyNative模式进行流程调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#获取更多报错信息">获取更多报错信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#常见错误">常见错误</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loss值对比检查">loss值对比检查</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#主要步骤">主要步骤</a></li>
<li class="toctree-l4"><a class="reference internal" href="#相关问题定位">相关问题定位</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#精度调试工具">精度调试工具</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#自定义调试信息">自定义调试信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#使用mindoptimizer进行超参调优">使用MindOptimizer进行超参调优</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loss值异常定位">loss值异常定位</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="accuracy_optimization.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance_optimization.html">性能调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">推理执行</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample_code.html">网络迁移调试实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/data_processing.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/implement_problem.html">执行问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/network_compilation.html">网络编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/operators_compile.html">算子编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/usage_migrate_3rd.html">第三方框架迁移使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/performance_tuning.html">性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/precision_tuning.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/distributed_configure.html">分布式配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/inference.html">推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/feature_advice.html">特性咨询</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>网络调试</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/migration_guide/neural_network_debug.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="网络调试">
<h1>网络调试<a class="headerlink" href="#网络调试" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.7/docs/mindspore/source_zh_cn/migration_guide/neural_network_debug.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_source.png"></a></p>
<p>本章将介绍网络调试的基本思路、常用工具，以及一些常见问题处理。</p>
<section id="网络调试的基本流程">
<h2>网络调试的基本流程<a class="headerlink" href="#网络调试的基本流程" title="Permalink to this headline"></a></h2>
<p>网络调试的过程主要分为以下几个步骤：</p>
<ol class="arabic">
<li><p>网络流程调试成功，网络执行整体不报错，正确输出loss值，且正常完成参数更新。</p>
<p>一般情况下，使用<code class="docutils literal notranslate"><span class="pre">model.train</span></code>接口完整执行一个step并且不报错，即正常执行并完成了参数更新；如果需要精确确认，可以通过<code class="docutils literal notranslate"><span class="pre">mindspore.train.callback.CheckpointConfig</span></code>中的参数<code class="docutils literal notranslate"><span class="pre">save_checkpoint_steps=1</span></code>保存连续两个step的Checkpoint文件，或者使用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>接口直接保存Checkpoint文件，然后通过以下代码打印Checkpoint文件中的权重值，查看两个step的权重是否发生改变，并完成更新。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>网络多轮迭代执行输出loss值，且loss值具有基本的收敛趋势。</p></li>
<li><p>网络精度调试，超参调优。</p></li>
</ol>
</section>
<section id="网络调试中的常用方法">
<h2>网络调试中的常用方法<a class="headerlink" href="#网络调试中的常用方法" title="Permalink to this headline"></a></h2>
<section id="流程调试">
<h3>流程调试<a class="headerlink" href="#流程调试" title="Permalink to this headline"></a></h3>
<p>本节内容介绍脚本开发基本完成后，网络流程调试过程中可能出现的问题和解决方法。</p>
<section id="用pynative模式进行流程调试">
<h4>用PyNative模式进行流程调试<a class="headerlink" href="#用pynative模式进行流程调试" title="Permalink to this headline"></a></h4>
<p>在脚本开发和网络流程调试中，我们推荐使用PyNative模式进行调试。PyNative模式支持执行单算子、普通函数和网络，以及单独求梯度的操作。在PyNative模式下，可以方便地设置断点，获取网络执行的中间结果，也可以通过pdb的方式对网络进行调试。</p>
<p>在默认情况下，MindSpore处于Graph模式，可以通过<code class="docutils literal notranslate"><span class="pre">context.set_context(mode=context.PYNATIVE_MODE)</span></code>设置为PyNative模式，相关示例可参考<a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r1.7/advanced/pynative_graph/pynative.html#%E5%8A%A8%E6%80%81%E5%9B%BE%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E6%93%8D%E4%BD%9C">使用PyNative模式调试</a>。</p>
</section>
<section id="获取更多报错信息">
<h4>获取更多报错信息<a class="headerlink" href="#获取更多报错信息" title="Permalink to this headline"></a></h4>
<p>在网络流程调试过程中，如果需要获取更多的报错信息，可通过以下方式获得：</p>
<ul class="simple">
<li><p>在PyNative模式下可使用pdb进行调试，利用pdb打印相关堆栈和上下文信息帮助问题定位。</p></li>
<li><p>使用Print算子打印更多上下文信息，具体示例可参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#print%E7%AE%97%E5%AD%90%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">Print算子功能介绍</a>。</p></li>
<li><p>调整日志级别获取更多报错信息，MindSpore可通过环境变量方便地调整日志级别，具体可参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#%E6%97%A5%E5%BF%97%E7%9B%B8%E5%85%B3%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%92%8C%E9%85%8D%E7%BD%AE">日志相关的环境变量和配置</a>。</p></li>
</ul>
</section>
<section id="常见错误">
<h4>常见错误<a class="headerlink" href="#常见错误" title="Permalink to this headline"></a></h4>
<p>在网络流程调试中，常见的错误有以下几类：</p>
<ul>
<li><p>算子执行报错</p>
<p>网络流程调试过程中，常出现shape不匹配、dtype不支持等算子执行报错，此时应根据报错信息检查是否正确使用算子，以及算子输入数据的shape是否与预期相符，并进行相应修改。</p>
<p>相关算子支持和API介绍可参考<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.7/note/operator_list.html">算子支持列表</a>和<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.7/index.html">算子Python API</a>。</p>
</li>
<li><p>相同脚本，在PyNative模式下能跑通，但Graph模式下报错</p>
<p>MindSpore的Graph模式下，<code class="docutils literal notranslate"><span class="pre">construct</span></code>函数中的代码由MindSpore框架进行解析，有一些Python语法还未支持，因此导致报错。此时应当根据报错信息按照<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.7/note/static_graph_syntax_support.html">MindSpore的语法说明</a>修改相关代码。</p>
</li>
<li><p>分布式并行训练脚本配置错误</p>
<p>分布式并行训练脚本及环境配置可参考<a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r1.7/advanced/train/train_eval.html">分布式并行训练教程</a>。</p>
</li>
</ul>
</section>
</section>
<section id="loss值对比检查">
<h3>loss值对比检查<a class="headerlink" href="#loss值对比检查" title="Permalink to this headline"></a></h3>
<p>在具有对标脚本的情况下，可对比对标脚本跑出的loss值与MindSpore脚本跑出的loss值，以验证整体网络结构和算子精度的正确性。</p>
<section id="主要步骤">
<h4>主要步骤<a class="headerlink" href="#主要步骤" title="Permalink to this headline"></a></h4>
<ol class="arabic">
<li><p>保证输入相同</p>
<p>需保证两个网络中输入相同，使得在相同的网络结构下，网络输出相同。可使用以下几种方式保证输入相同：</p>
<ul>
<li><p>使用numpy自行构造输入数据，保证网络输入相同，MindSpore支持Tensor和numpy的自由转换。构造输入数据可以参考以下脚本：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>使用相同数据集进行计算，MindSpore支持使用TFRecord数据集，可使用<code class="docutils literal notranslate"><span class="pre">mindspore.dataset.TFRecordDataset</span></code>接口读取。</p></li>
</ul>
</li>
<li><p>去除网络中随机性因素的影响</p>
<p>去除网络中的随机性影响，主要方法有设置相同的随机性种子，关掉数据shuffle，修改代码去除dropout、initializer等网络中具有随机性的算子的影响等。</p>
</li>
<li><p>保证相关超参数的设置相同</p>
<p>需保证网络中的超参数设置相同，以保证相同的输入，算子的输出相同。</p>
</li>
<li><p>运行网络，比较输出的loss值，一般loss值误差在1‰左右，因为算子本身存在一定精度误差，随着step数增大，误差会有一定累加。</p></li>
</ol>
</section>
<section id="相关问题定位">
<h4>相关问题定位<a class="headerlink" href="#相关问题定位" title="Permalink to this headline"></a></h4>
<p>如果loss值误差较大，可使用以下几种方式进行问题定位：</p>
<ul>
<li><p>检查输入、超参设置是否相同，以及是否完全去除了随机性影响。</p>
<p>同一脚本多次重跑，loss值相差较大，则说明没有完全去除网络中的随机性影响。</p>
</li>
<li><p>整体判断。</p>
<p>如果第一轮loss值就出现较大误差，则说明网络的前向计算就存在问题。</p>
<p>如果第一轮loss值在误差范围内，第二轮开始loss值出现较大误差，则说明网络的前向计算应该没有问题，反向梯度和权重更新计算可能存在问题。</p>
</li>
<li><p>有了整体的判断之后，由粗到细进行输入输出数值的精度对比。</p>
<p>首先，对各个子网从输入开始逐层对比输入输出值，确定初始出现问题的子网。</p>
<p>然后，对比子网中的网络结构以及算子的输入输出，找到出现问题的网络结构或算子，进行修改。</p>
<p>如果在此过程中发现了算子精度存在问题，可在<a class="reference external" href="https://gitee.com/mindspore/mindspore">MindSpore代码托管平台</a>上提issue，相关人员将对问题进行跟踪处理。</p>
</li>
<li><p>MindSpore提供了丰富的工具获取网络中间数据，可根据实际情况选用。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#%E6%95%B0%E6%8D%AEdump%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">数据Dump功能</a></p></li>
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#print%E7%AE%97%E5%AD%90%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">使用Print算子打印相关信息</a></p></li>
<li><p><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.7/index.html">使用可视化组件MindInsight</a></p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="精度调试工具">
<h3>精度调试工具<a class="headerlink" href="#精度调试工具" title="Permalink to this headline"></a></h3>
<section id="自定义调试信息">
<h4>自定义调试信息<a class="headerlink" href="#自定义调试信息" title="Permalink to this headline"></a></h4>
<ul>
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#mindspore%E7%9A%84callback%E8%83%BD%E5%8A%9B">Callback功能</a></p>
<p>MindSpore已提供ModelCheckpoint、LossMonitor、SummaryCollector等Callback类用于保存模型参数、监控loss值、保存训练过程信息等功能，用户也可自定义Callback函数用于实现在每个epoch和step的开始和结束运行相关功能，具体示例可参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#%E8%87%AA%E5%AE%9A%E4%B9%89callback">自定义Callback</a>。</p>
</li>
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.7/debug/custom_debug.html#mindspore-metrics%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">MindSpore metrics功能</a></p>
<p>当训练结束后，可以使用metrics评估训练结果的好坏。MindSpore提供了多种metrics评估指标，如：<code class="docutils literal notranslate"><span class="pre">accuracy</span></code>、<code class="docutils literal notranslate"><span class="pre">loss</span></code>、<code class="docutils literal notranslate"><span class="pre">precision</span></code>、<code class="docutils literal notranslate"><span class="pre">recall</span></code>、<code class="docutils literal notranslate"><span class="pre">F1</span></code>等。</p>
</li>
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/zh-CN/r1.7/advanced/train/train_eval.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%AD%E7%BB%83%E7%BD%91%E7%BB%9C">自定义训练</a></p></li>
<li><p>自定义学习率</p>
<p>MindSpore提供了一些常见的动态学习率实现以及一些常见的具有自适应学习率调整功能的优化器，可参考API文档中的<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.7/api_python/mindspore.nn.html#%E5%8A%A8%E6%80%81%E5%AD%A6%E4%B9%A0%E7%8E%87">Dynamic Learning Rate</a>和<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.7/api_python/mindspore.nn.html#%E4%BC%98%E5%8C%96%E5%99%A8">Optimizer Functions</a>。</p>
<p>同时，用户可实现自定义的动态学习率，以WarmUpLR为例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WarmUpLR</span><span class="p">(</span><span class="n">LearningRateSchedule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WarmUpLR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1">## check the input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;learning_rate must be float.&quot;</span><span class="p">)</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">check_non_negative_float</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span><span class="p">)</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">check_positive_int</span><span class="p">(</span><span class="n">warmup_steps</span><span class="p">,</span> <span class="s1">&#39;warmup_steps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span><span class="p">)</span>
        <span class="c1">## define the operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="n">warmup_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Minimum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cast</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Cast</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_step</span><span class="p">):</span>
        <span class="c1">## calculate the lr</span>
        <span class="n">warmup_percent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">global_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">),</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">warmup_percent</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="使用mindoptimizer进行超参调优">
<h4>使用MindOptimizer进行超参调优<a class="headerlink" href="#使用mindoptimizer进行超参调优" title="Permalink to this headline"></a></h4>
<p>MindSpore提供了MindOptimizer工具帮助用户进行更便捷的超参调优，详细示例和使用方法可参考<a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.7/hyper_parameters_auto_tuning.html">使用MindOptimizer进行超参调优</a>。</p>
</section>
<section id="loss值异常定位">
<h4>loss值异常定位<a class="headerlink" href="#loss值异常定位" title="Permalink to this headline"></a></h4>
<p>对loss值为INF、NAN，或者loss值不收敛的情况，可从以下几种情况进行排查：</p>
<ol class="arabic">
<li><p>检查loss_scale溢出。</p>
<p>在混合精度使用loss_scale的场景下，出现loss值为INF、NAN的情况，可能是scale值过大造成的，如果为动态loss_scale，则会自动调整scale值；如果为静态loss_scale，则需要减小scale值。</p>
<p>如果<code class="docutils literal notranslate"><span class="pre">scale=1</span></code>的情况下依旧存在loss值为INF、NAN的情况，则网络中应该有算子出现溢出，需要进行进一步定位。</p>
</li>
<li><p>造成loss值异常的原因可能由输入数据异常、算子溢出、梯度消失、梯度爆炸等原因造成。</p>
<p>排查算子溢出、梯度为0、权重异常、梯度消失和梯度爆炸等网络中间值情况，推荐使用<a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.7/debugger.html">MindInsight调试器</a>设置相应检测点进行检测和调试，这种方式可较为全面地进行问题定位，可调试性也比较强。</p>
<p>下面介绍几种简单的初步排查方法：</p>
<ul>
<li><p>观察权重值是否出现梯度爆炸的情况，也可通过加载保存的Checkpoint文件，打印权重值进行初步判断，打印权重值可参考以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>查看是否出现梯度为0的情况，也可以通过对比不同step保存的Checkpoint文件的权重值是否发生变化，进行初步判断，Checkpoint文件的权重值对比可参考以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">ckpt1</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt1_path</span><span class="p">)</span>
<span class="n">ckpt2</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt2_path</span><span class="p">)</span>
<span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">same</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">param1</span><span class="p">,</span><span class="n">param2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ckpt1</span><span class="p">,</span><span class="n">ckpt2</span><span class="p">):</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">value1</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="n">param1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">value2</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="n">param2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value1</span> <span class="o">==</span> <span class="n">value2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;same value: &#39;</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
        <span class="n">same</span> <span class="o">=</span> <span class="n">same</span> <span class="o">+</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All params num: &#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;same params num: &#39;</span><span class="p">,</span> <span class="n">same</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>查看权重值中是否出现NAN、INF异常数据，也可通过加载Checkpoint文件进行简单判断，一般来说，权重值中出现NAN、INF，则梯度计算中也出现了NAN、INF，可能有溢出情况发生，相关代码可参考：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NAN value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INF value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="use_third_party_op.html" class="btn btn-neutral float-left" title="基于自定义算子接口调用第三方算子库" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="accuracy_optimization.html" class="btn btn-neutral float-right" title="精度调优" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
</body>
</html>