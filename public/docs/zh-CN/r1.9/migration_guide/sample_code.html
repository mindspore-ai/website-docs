<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>网络迁移调试实例 &mdash; MindSpore master documentation</title>
      <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/training.css" type="text/css" /><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/training.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="常见问题" href="faq.html" />
    <link rel="prev" title="调试调优" href="debug_and_tune.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/overview.html">MindSpore设计概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/auto_gradient.html">函数式微分编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/mindir.html">中间表示MindIR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/all_scenarios.html">全场景统一</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/dynamic_graph_and_static_graph.html">动静态图结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/distributed_training_design.html">分布式并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/graph_fusion_engine.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">规格</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/benchmark.html">基准性能</a></li>
<li class="toctree-l1"><a class="reference external" href="https://gitee.com/mindspore/models/blob/r1.9/README_CN.md#目录">网络支持↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/operator_list.html">API支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/syntax_list.html">语法支持</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.audio.html">mindspore.dataset.audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.config.html">mindspore.dataset.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.text.html">mindspore.dataset.text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.vision.html">mindspore.dataset.vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.transformer.html">mindspore.nn.transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.function.html">mindspore.ops.function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/lite/api/zh-CN/r1.9/api_cpp/mindspore.html">C++ API↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API映射</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/api_mapping/pytorch_api_mapping.html">PyTorch与MindSpore API映射表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/api_mapping/tensorflow_api_mapping.html">TensorFlow与MindSpore API映射表</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">迁移指南</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="enveriment_preparation.html">环境准备与资料获取</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis_and_preparation.html">模型分析与准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_development/model_development.html">MindSpore网络搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_and_tune.html">调试调优</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">网络迁移调试实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="typical_api_comparision.html">与PyTorch典型区别</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_third_party_op.html">基于自定义算子接口调用第三方算子库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/data_processing.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/implement_problem.html">执行问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/network_compilation.html">网络编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/operators_compile.html">算子编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/usage_migrate_3rd.html">第三方框架迁移使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/performance_tuning.html">性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/precision_tuning.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/distributed_configure.html">分布式配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/inference.html">推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/feature_advice.html">特性咨询</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>网络迁移调试实例</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/migration_guide/sample_code.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="网络迁移调试实例">
<h1>网络迁移调试实例<a class="headerlink" href="#网络迁移调试实例" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.9/docs/mindspore/source_zh_cn/migration_guide/sample_code.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.9/resource/_static/logo_source.png"></a></p>
<p>本章将以经典网络 ResNet50 为例，结合代码来详细介绍网络迁移方法。</p>
<section id="模型分析与准备">
<h2>模型分析与准备<a class="headerlink" href="#模型分析与准备" title="Permalink to this headline"></a></h2>
<p>假设已经按照<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/migration_guide/enveriment_preparation.html">环境准备</a>章节配置好了MindSpore的运行环境。且假设resnet50在models仓还没有实现。</p>
<p>首先需要分析算法及网络结构。</p>
<p>残差神经网络（ResNet）由微软研究院何凯明等人提出，通过ResNet单元，成功训练152层神经网络，赢得了ILSVRC2015冠军。传统的卷积网络或全连接网络或多或少存在信息丢失的问题，还会造成梯度消失或爆炸，导致深度网络训练失败，ResNet则在一定程度上解决了这个问题。通过将输入信息传递给输出，确保信息完整性。整个网络只需要学习输入和输出的差异部分，简化了学习目标和难度。ResNet的结构大幅提高了神经网络训练的速度，并且大大提高了模型的准确率。</p>
<p><a class="reference external" href="https://arxiv.org/pdf/1512.03385.pdf">论文</a>：Kaiming He, Xiangyu Zhang, Shaoqing Ren, Jian Sun.”Deep Residual Learning for Image Recognition”</p>
<p>我们找到了一份<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r1.9/docs/mindspore/source_zh_cn/migration_guide/code/resnet_convert/resnet_pytorch">PyTorch ResNet50 Cifar10的示例代码</a>，里面包含了PyTorch ResNet的实现，Cifar10数据处理，网络训练及推理流程。</p>
<section id="checklist">
<h3>checklist<a class="headerlink" href="#checklist" title="Permalink to this headline"></a></h3>
<p>在阅读论文和参考实现过程中，我们分析填写以下checklist：</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>trick</p></th>
<th class="head"><p>记录</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>数据增强</p></td>
<td><p>RandomCrop，RandomHorizontalFlip，Resize，Normalize</p></td>
</tr>
<tr class="row-odd"><td><p>学习率衰减策略</p></td>
<td><p>固定学习率 0.001</p></td>
</tr>
<tr class="row-even"><td><p>优化器参数</p></td>
<td><p>Adam优化器，weight_decay=1e-5</p></td>
</tr>
<tr class="row-odd"><td><p>训练参数</p></td>
<td><p>batch_size=32，epochs=90</p></td>
</tr>
<tr class="row-even"><td><p>网络结构优化点</p></td>
<td><p>Bottleneck</p></td>
</tr>
<tr class="row-odd"><td><p>训练流程优化点</p></td>
<td><p>无</p></td>
</tr>
</tbody>
</table>
</section>
<section id="复现参考实现">
<h3>复现参考实现<a class="headerlink" href="#复现参考实现" title="Permalink to this headline"></a></h3>
<p>下载PyTorch的代码，cifar10的数据集，对网络进行训练：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Train Epoch: 89 [0/1563 (0%)]    Loss: 0.010917
Train Epoch: 89 [100/1563 (6%)]    Loss: 0.013386
Train Epoch: 89 [200/1563 (13%)]    Loss: 0.078772
Train Epoch: 89 [300/1563 (19%)]    Loss: 0.031228
Train Epoch: 89 [400/1563 (26%)]    Loss: 0.073462
Train Epoch: 89 [500/1563 (32%)]    Loss: 0.098645
Train Epoch: 89 [600/1563 (38%)]    Loss: 0.112967
Train Epoch: 89 [700/1563 (45%)]    Loss: 0.137923
Train Epoch: 89 [800/1563 (51%)]    Loss: 0.143274
Train Epoch: 89 [900/1563 (58%)]    Loss: 0.088426
Train Epoch: 89 [1000/1563 (64%)]    Loss: 0.071185
Train Epoch: 89 [1100/1563 (70%)]    Loss: 0.094342
Train Epoch: 89 [1200/1563 (77%)]    Loss: 0.126669
Train Epoch: 89 [1300/1563 (83%)]    Loss: 0.245604
Train Epoch: 89 [1400/1563 (90%)]    Loss: 0.050761
Train Epoch: 89 [1500/1563 (96%)]    Loss: 0.080932

Test set: Average loss: -9.7052, Accuracy: 91%

Finished Training
</pre></div>
</div>
<p>可以从<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/models/resnet_pytorch_res.zip">resnet_pytorch_res</a>下载到训练时日志和保存的参数文件。</p>
</section>
<section id="分析api特性缺失">
<h3>分析API/特性缺失<a class="headerlink" href="#分析api特性缺失" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>API分析</p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>PyTorch 使用API</p></th>
<th class="head"><p>MindSpore 对应API</p></th>
<th class="head"><p>是否有差异</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.Conv2D</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.Conv2d</span></code></p></td>
<td><p>有，<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/note/api_mapping/pytorch_diff/nn_Conv2d.html">差异对比</a></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nn.BatchNorm2D</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.BatchNom2d</span></code></p></td>
<td><p>有，<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/note/api_mapping/pytorch_diff/BatchNorm2d.html">差异对比</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.ReLU</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.ReLU</span></code></p></td>
<td><p>无</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nn.MaxPool2D</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.MaxPool2d</span></code></p></td>
<td><p>有，<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/note/api_mapping/pytorch_diff/MaxPool2d.html">差异对比</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.AdaptiveAvgPool2D</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.AdaptiveAvgPool2D</span></code></p></td>
<td><p>无</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nn.Linear</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.Dense</span></code></p></td>
<td><p>有，<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/note/api_mapping/pytorch_diff/Dense.html">差异对比</a></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">torch.flatten</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.Flatten</span></code></p></td>
<td><p>无</p></td>
</tr>
</tbody>
</table>
<p>查看<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/note/api_mapping/pytorch_api_mapping.html">PyTorch API映射</a>，我们获取到有四个API有差异。</p>
<ul class="simple">
<li><p>功能分析</p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Pytorch 使用功能</p></th>
<th class="head"><p>MindSpore 对应功能</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.init.kaiming_normal_</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">initializer(init='HeNormal')</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nn.init.constant_</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">initializer(init='Constant')</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.Sequential</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.SequentialCell</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nn.Module</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.Cell</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nn.distibuted</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">set_auto_parallel_context</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">torch.optim.SGD</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nn.optim.SGD</span></code> or <code class="docutils literal notranslate"><span class="pre">nn.optim.Momentum</span></code></p></td>
</tr>
</tbody>
</table>
<p>（由于MindSpore 和 PyTorch 在接口设计上不完全一致，这里仅列出关键功能的比对）</p>
<p>经过API和功能分析，我们发现，相比 PyTorch，MindSpore 上没有缺失的API和功能。</p>
</section>
</section>
<section id="mindspore模型实现">
<h2>MindSpore模型实现<a class="headerlink" href="#mindspore模型实现" title="Permalink to this headline"></a></h2>
<section id="数据集">
<h3>数据集<a class="headerlink" href="#数据集" title="Permalink to this headline"></a></h3>
<p>PyTorch 的 cifar10数据集处理如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">trans</span>
<span class="kn">import</span> <span class="nn">torchvision</span>

<span class="n">train_transform</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">]),</span>
<span class="p">])</span>
<span class="n">test_transform</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">]),</span>
<span class="p">])</span>
<span class="n">train_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transform</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transform</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>如果本地没有cifar10数据集，在使用<code class="docutils literal notranslate"><span class="pre">torchvision.datasets.CIFAR10</span></code>时添加<code class="docutils literal notranslate"><span class="pre">download=True</span></code>可以自动下载。</p>
<p>cifar10数据集目录组织参考：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└─dataset_path
    ├─cifar-10-batches-bin      # train dataset
        ├─ data_batch_1.bin
        ├─ data_batch_2.bin
        ├─ data_batch_3.bin
        ├─ data_batch_4.bin
        ├─ data_batch_5.bin
    └─cifar-10-verify-bin       # evaluate dataset
        ├─ test_batch.bin
</pre></div>
</div>
<p>这个操作在MindSpore上实现如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset</span> <span class="kn">import</span> <span class="n">vision</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.transforms.transforms</span> <span class="kn">import</span> <span class="n">TypeCast</span>

<span class="k">def</span> <span class="nf">create_cifar_dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">do_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">rank_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rank_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">do_train</span><span class="p">,</span>
                                <span class="n">num_shards</span><span class="o">=</span><span class="n">rank_size</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="n">rank_id</span><span class="p">)</span>

    <span class="c1"># define map operations</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">do_train</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">vision</span><span class="o">.</span><span class="n">RandomCrop</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="n">vision</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="n">trans</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">image_size</span><span class="p">),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">]),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">TypeCast</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">data_set</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>

    <span class="c1"># apply batch operations</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="n">do_train</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_set</span>
</pre></div>
</div>
</section>
<section id="网络模型实现">
<h3>网络模型实现<a class="headerlink" href="#网络模型实现" title="Permalink to this headline"></a></h3>
<p>参考<a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.9/docs/mindspore/source_zh_cn/migration_guide/code/resnet_convert/resnet_pytorch/resnet.py">PyTorch resnet</a>，我们实现了一版<a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.9/docs/mindspore/source_zh_cn/migration_guide/code/resnet_convert/resnet_ms/src/resnet.py">MindSpore resnet</a>，通过比较工具发现，实现只有几个地方有差别：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conv2d PyTorch</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
    <span class="n">in_planes</span><span class="p">,</span>
    <span class="n">out_planes</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span>
    <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">##########################################</span>

<span class="c1"># Conv2d MindSpore</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
    <span class="n">in_planes</span><span class="p">,</span>
    <span class="n">out_planes</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">pad_mode</span><span class="o">=</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span>
    <span class="n">group</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
    <span class="n">has_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dilation</span><span class="o">=</span><span class="n">dilation</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Module</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Cell</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch</span>
<span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore</span>
<span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch 图构造</span>
<span class="n">forward</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore 图构造</span>
<span class="n">construct</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch 带padding的MaxPool2d</span>
<span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore 带padding的MaxPool2d</span>
<span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">([</span>
              <span class="n">nn</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span><span class="n">paddings</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;CONSTANT&quot;</span><span class="p">),</span>
              <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch AdaptiveAvgPool2d</span>
<span class="n">avgpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore ReduceMean 和 AdaptiveAvgPool2d output shape是1时功能一致，且速度会快</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ReduceMean</span><span class="p">(</span><span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch 全连接</span>
<span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore 全连接</span>
<span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch Sequential</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span>
<span class="c1">############################################</span>
<span class="c1"># MindSpore SequentialCell</span>
<span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PyTorch 初始化</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fan_out&quot;</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">)):</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Zero-initialize the last BN in each residual branch,</span>
<span class="c1"># so that the residual branch starts with zeros, and each residual block behaves like an identity.</span>
<span class="c1"># This improves the model by 0.2~0.3% according to https://arxiv.org/abs/1706.02677</span>
<span class="k">if</span> <span class="n">zero_init_residual</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Bottleneck</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">BasicBlock</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>

<span class="c1">############################################</span>

<span class="c1"># MindSpore 初始化</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">HeNormal</span><span class="p">(</span><span class="n">negative_slope</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">)):</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span><span class="s2">&quot;ones&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">)):</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">HeUniform</span><span class="p">(</span><span class="n">negative_slope</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">initializer</span><span class="p">(</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

<span class="c1"># Zero-initialize the last BN in each residual branch,</span>
<span class="c1"># so that the residual branch starts with zeros, and each residual block behaves like an identity.</span>
<span class="c1"># This improves the model by 0.2~0.3% according to https://arxiv.org/abs/1706.02677</span>
<span class="k">if</span> <span class="n">zero_init_residual</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">Bottleneck</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn3</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">BasicBlock</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">bn2</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="loss函数">
<h3>Loss函数<a class="headerlink" href="#loss函数" title="Permalink to this headline"></a></h3>
<p>PyTorch：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>
</div>
<p>MindSpore:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="学习率与优化器">
<h3>学习率与优化器<a class="headerlink" href="#学习率与优化器" title="Permalink to this headline"></a></h3>
<p>PyTorch：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net_opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
</div>
<p>MindSpore:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">resnet</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="模型验证">
<h2>模型验证<a class="headerlink" href="#模型验证" title="Permalink to this headline"></a></h2>
<p>在<span class="xref myst">复现参考实现</span>章节我们获取到了训练好的PyTorch的参数，我们怎样将参数文件转换成MindSpore能够使用的checkpoint文件呢？</p>
<p>基本需要以下几个流程：</p>
<ol class="arabic simple">
<li><p>打印PyTorch的参数文件里所有参数的参数名和shape，打印需要加载参数的MindSpore Cell里所有参数的参数名和shape；</p></li>
<li><p>比较参数名和shape，构造参数映射关系；</p></li>
<li><p>按照参数映射将PyTorch的参数 -&gt; numpy -&gt; MindSpore的Parameter，构成Parameter List后保存成checkpoint；</p></li>
<li><p>单元测试：PyTorch加载参数，MindSpore加载参数，构造随机输入，对比输出。</p></li>
</ol>
<section id="打印参数">
<h3>打印参数<a class="headerlink" href="#打印参数" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="c1"># 通过PyTorch参数文件，打印PyTorch的参数文件里所有参数的参数名和shape，返回参数字典</span>
<span class="k">def</span> <span class="nf">pytorch_params</span><span class="p">(</span><span class="n">pth_file</span><span class="p">):</span>
    <span class="n">par_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pth_file</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">pt_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">par_dict</span><span class="p">:</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">par_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">pt_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pt_params</span>

<span class="c1"># 通过MindSpore的Cell，打印Cell里所有参数的参数名和shape，返回参数字典</span>
<span class="k">def</span> <span class="nf">mindspore_params</span><span class="p">(</span><span class="n">network</span><span class="p">):</span>
    <span class="n">ms_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ms_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">ms_params</span>
</pre></div>
</div>
<p>执行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">resnet_ms.src.resnet</span> <span class="kn">import</span> <span class="n">resnet50</span> <span class="k">as</span> <span class="n">ms_resnet50</span>
<span class="n">pth_path</span> <span class="o">=</span> <span class="s2">&quot;resnet.pth&quot;</span>
<span class="n">pt_param</span> <span class="o">=</span> <span class="n">pytorch_params</span><span class="p">(</span><span class="n">pth_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ms_param</span> <span class="o">=</span> <span class="n">mindspore_params</span><span class="p">(</span><span class="n">ms_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>得到</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>conv1.weight (64, 3, 7, 7)
bn1.weight (64,)
bn1.bias (64,)
bn1.running_mean (64,)
bn1.running_var (64,)
bn1.num_batches_tracked ()
layer1.0.conv1.weight (64, 64, 1, 1)
......
===========================================
conv1.weight (64, 3, 7, 7)
bn1.moving_mean (64,)
bn1.moving_variance (64,)
bn1.gamma (64,)
bn1.beta (64,)
layer1.0.conv1.weight (64, 64, 1, 1)
......
</pre></div>
</div>
</section>
<section id="参数映射及checkpoint保存">
<h3>参数映射及checkpoint保存<a class="headerlink" href="#参数映射及checkpoint保存" title="Permalink to this headline"></a></h3>
<p>发现除了BatchNorm的参数外，其他参数的名字和shape是完全能够对的上的，这时可以写一个简单的python脚本来做参数映射:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="k">def</span> <span class="nf">param_convert</span><span class="p">(</span><span class="n">ms_params</span><span class="p">,</span> <span class="n">pt_params</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">):</span>
    <span class="c1"># 参数名映射字典</span>
    <span class="n">bn_ms2pt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
                <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="s2">&quot;bias&quot;</span><span class="p">,</span>
                <span class="s2">&quot;moving_mean&quot;</span><span class="p">:</span> <span class="s2">&quot;running_mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;moving_variance&quot;</span><span class="p">:</span> <span class="s2">&quot;running_var&quot;</span><span class="p">}</span>
    <span class="n">new_params_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms_param</span> <span class="ow">in</span> <span class="n">ms_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># 在参数列表中，只有包含bn和downsample.1的参数是BatchNorm算子的参数</span>
        <span class="k">if</span> <span class="s2">&quot;bn&quot;</span> <span class="ow">in</span> <span class="n">ms_param</span> <span class="ow">or</span> <span class="s2">&quot;downsample.1&quot;</span> <span class="ow">in</span> <span class="n">ms_param</span><span class="p">:</span>
            <span class="n">ms_param_item</span> <span class="o">=</span> <span class="n">ms_param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">pt_param_item</span> <span class="o">=</span> <span class="n">ms_param_item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">bn_ms2pt</span><span class="p">[</span><span class="n">ms_param_item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">pt_param</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt_param_item</span><span class="p">)</span>
            <span class="c1"># 如找到参数对应且shape一致，加入到参数列表</span>
            <span class="k">if</span> <span class="n">pt_param</span> <span class="ow">in</span> <span class="n">pt_params</span> <span class="ow">and</span> <span class="n">pt_params</span><span class="p">[</span><span class="n">pt_param</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">ms_params</span><span class="p">[</span><span class="n">ms_param</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">ms_value</span> <span class="o">=</span> <span class="n">pt_params</span><span class="p">[</span><span class="n">pt_param</span><span class="p">]</span>
                <span class="n">new_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ms_param</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">ms_value</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ms_param</span><span class="p">,</span> <span class="s2">&quot;not match in pt_params&quot;</span><span class="p">)</span>
        <span class="c1"># 其他参数</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 如找到参数对应且shape一致，加入到参数列表</span>
            <span class="k">if</span> <span class="n">ms_param</span> <span class="ow">in</span> <span class="n">pt_params</span> <span class="ow">and</span> <span class="n">pt_params</span><span class="p">[</span><span class="n">ms_param</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">ms_params</span><span class="p">[</span><span class="n">ms_param</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">ms_value</span> <span class="o">=</span> <span class="n">pt_params</span><span class="p">[</span><span class="n">ms_param</span><span class="p">]</span>
                <span class="n">new_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ms_param</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">ms_value</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ms_param</span><span class="p">,</span> <span class="s2">&quot;not match in pt_params&quot;</span><span class="p">)</span>
    <span class="c1"># 保存成MindSpore的checkpoint</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">new_params_list</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">)</span>

<span class="n">ckpt_path</span> <span class="o">=</span> <span class="s2">&quot;resnet50.ckpt&quot;</span>
<span class="n">param_convert</span><span class="p">(</span><span class="n">ms_params</span><span class="p">,</span> <span class="n">pt_params</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">)</span>
</pre></div>
</div>
<p>执行完成可以在<code class="docutils literal notranslate"><span class="pre">ckpt_path</span></code>找到生成的checkpoint文件。</p>
<p>当参数映射关系非常复杂，通过参数名很难找到映射关系时，可以写一个参数映射字典，如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bn1.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bn1.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn1.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bn1.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IN.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;IN.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IN.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;IN.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BN.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;BN.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;in.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;in.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bn.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bn.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn2.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bn2.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn2.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bn2.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn3.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bn3.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn3.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bn3.gamma&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BN.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;BN.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BN.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;BN.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;bn.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;bn.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn1.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;bn1.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn1.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;bn1.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn2.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;bn2.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn2.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;bn2.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn3.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;bn3.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bn3.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;bn3.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;downsample.1.running_mean&#39;</span><span class="p">:</span> <span class="s1">&#39;downsample.1.moving_mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;downsample.1.running_var&#39;</span><span class="p">:</span> <span class="s1">&#39;downsample.1.moving_variance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;downsample.0.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;downsample.1.weight&#39;</span><span class="p">,</span>
    <span class="s1">&#39;downsample.1.bias&#39;</span><span class="p">:</span> <span class="s1">&#39;downsample.1.beta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;downsample.1.weight&#39;</span><span class="p">:</span> <span class="s1">&#39;downsample.1.gamma&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>再结合<code class="docutils literal notranslate"><span class="pre">param_convert</span></code>的相关流程就可以获取到参数文件了。</p>
</section>
<section id="单元测试">
<h3>单元测试<a class="headerlink" href="#单元测试" title="Permalink to this headline"></a></h3>
<p>获得对应的参数文件后，我们需要对整个模型做一次单元测试，保证模型的一致性：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">resnet_ms.src.resnet</span> <span class="kn">import</span> <span class="n">resnet50</span> <span class="k">as</span> <span class="n">ms_resnet50</span>
<span class="kn">from</span> <span class="nn">resnet_pytorch.resnet</span> <span class="kn">import</span> <span class="n">resnet50</span> <span class="k">as</span> <span class="n">pt_resnet50</span>

<span class="k">def</span> <span class="nf">check_res</span><span class="p">(</span><span class="n">pth_path</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">):</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># 注意做单元测试时，需要给Cell打训练或推理的标签</span>
    <span class="n">ms_resnet</span> <span class="o">=</span> <span class="n">ms_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pt_resnet</span> <span class="o">=</span> <span class="n">pt_resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">pt_resnet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pth_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">ms_resnet</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= pt_resnet conv1.weight ==========&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pt_resnet</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ms_resnet conv1.weight ==========&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ms_resnet</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">pt_res</span> <span class="o">=</span> <span class="n">pt_resnet</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>
    <span class="n">ms_res</span> <span class="o">=</span> <span class="n">ms_resnet</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= pt_resnet res ==========&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pt_res</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========= ms_resnet res ==========&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ms_res</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pt_res</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">ms_res</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())))</span>

<span class="n">pth_path</span> <span class="o">=</span> <span class="s2">&quot;resnet.pth&quot;</span>
<span class="n">ckpt_path</span> <span class="o">=</span> <span class="s2">&quot;resnet50.ckpt&quot;</span>
<span class="n">check_res</span><span class="p">(</span><span class="n">pth_path</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">)</span>
</pre></div>
</div>
<p>注意做单元测试时，需要给Cell打训练或推理的标签，PyTorch 训练 <code class="docutils literal notranslate"><span class="pre">.train()</span></code>，推理<code class="docutils literal notranslate"><span class="pre">.eval()</span></code>，MindSpore训练<code class="docutils literal notranslate"><span class="pre">.set_train()</span></code>，推理<code class="docutils literal notranslate"><span class="pre">.set_train(False)</span></code>。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>========= pt_resnet conv1.weight ==========
[ 1.091892e-40 -1.819391e-39  3.509566e-40 -8.281730e-40  1.207908e-39
 -3.576954e-41 -1.000796e-39  1.115791e-39 -1.077758e-39 -6.031427e-40]
========= ms_resnet conv1.weight ==========
[ 1.091892e-40 -1.819391e-39  3.509566e-40 -8.281730e-40  1.207908e-39
 -3.576954e-41 -1.000796e-39  1.115791e-39 -1.077758e-39 -6.031427e-40]
========= pt_resnet res ==========
tensor([[-15.1945,  -5.6529,   6.5738,   9.7807,  -2.4615,   3.0365,  -4.7216,
         -11.1005,   2.7121,  -9.3612],
        [-14.2412,  -5.9004,   5.6366,   9.7030,  -1.6322,   2.6926,  -3.7307,
         -10.7582,   1.4195,  -7.9930],
        [-13.4795,  -5.6582,   5.6432,   8.9152,  -1.5169,   2.6958,  -3.4469,
         -10.5300,   1.3318,  -8.1476],
        [-13.6448,  -5.4239,   5.8254,   9.3094,  -2.1969,   2.7042,  -4.1194,
         -10.4388,   1.9331,  -8.1746]], grad_fn=&lt;AddmmBackward0&gt;)
========= ms_resnet res ==========
[[-15.194535   -5.652934    6.5737996   9.780719   -2.4615316   3.0365033
   -4.7215843 -11.100524    2.7121294  -9.361177 ]
 [-14.24116    -5.9004383   5.6366115   9.702984   -1.6322318   2.69261
   -3.7307222 -10.758192    1.4194587  -7.992969 ]
 [-13.47945    -5.658216    5.6432185   8.915173   -1.5169426   2.6957715
   -3.446888  -10.529953    1.3317728  -8.147601 ]
 [-13.644804   -5.423854    5.825424    9.309403   -2.1969485   2.7042081
   -4.119426  -10.438771    1.9330862  -8.174606 ]]
diff 2.861023e-06
</pre></div>
</div>
<p>可以看到最后的结果差不大，基本符合预期。当结果差很大时需要逐层对比下输出，这里不多做说明。</p>
</section>
</section>
<section id="推理流程">
<h2>推理流程<a class="headerlink" href="#推理流程" title="Permalink to this headline"></a></h2>
<p>对比下PyTorch的推理:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">trans</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">resnet</span> <span class="kn">import</span> <span class="n">resnet50</span>

<span class="k">def</span> <span class="nf">test_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
            <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="c1"># sum up batch loss</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># get the index of the max log-probability</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">test_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Test set: Average loss: </span><span class="si">{:.4f}</span><span class="s1">, Accuracy: </span><span class="si">{:.0f}</span><span class="s1">%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>

<span class="n">use_cuda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">use_cuda</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">test_transform</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">]),</span>
<span class="p">])</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transform</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># 2. define forward network</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span> <span class="k">if</span> <span class="n">use_cuda</span> <span class="k">else</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./resnet.pth&quot;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
<span class="n">test_epoch</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Test set: Average loss: -9.7075, Accuracy: 91%
</pre></div>
</div>
<p>MindSpore实现这个流程：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">create_dataset</span>
<span class="kn">from</span> <span class="nn">src.model_utils.moxing_adapter</span> <span class="kn">import</span> <span class="n">moxing_wrapper</span>
<span class="kn">from</span> <span class="nn">src.model_utils.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">init_env</span>
<span class="kn">from</span> <span class="nn">src.resnet</span> <span class="kn">import</span> <span class="n">resnet50</span>


<span class="k">def</span> <span class="nf">test_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">test_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_func</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">dataset_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">/=</span> <span class="n">dataset_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Test set: Average loss: </span><span class="si">{:.4f}</span><span class="s1">, Accuracy: </span><span class="si">{:.0f}</span><span class="s1">%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">dataset_size</span><span class="p">))</span>


<span class="nd">@moxing_wrapper</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test_net</span><span class="p">():</span>
    <span class="n">init_env</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_width</span><span class="p">)))</span>
    <span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_num</span><span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">test_epoch</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test_net</span><span class="p">()</span>
</pre></div>
</div>
<p>执行</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>test.py<span class="w"> </span>--data_path<span class="w"> </span>data/cifar10/<span class="w"> </span>--checkpoint_path<span class="w"> </span>resnet.ckpt
</pre></div>
</div>
<p>得到推理精度结果：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>run standalone!
Test set: Average loss: 0.3240, Accuracy: 91%
</pre></div>
</div>
<p>推理精度一致。</p>
</section>
<section id="训练流程">
<h2>训练流程<a class="headerlink" href="#训练流程" title="Permalink to this headline"></a></h2>
<p>PyTorch的训练流程参考<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r1.9/docs/mindspore/source_zh_cn/migration_guide/code/resnet_convert/resnet_pytorch">pytoch resnet50 cifar10的示例代码</a>，日志文件和训练好的pth保存在<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/models/resnet_pytorch_res.zip">resnet_pytorch_res</a>。</p>
<p>对应的MindSpore代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.profiler</span> <span class="kn">import</span> <span class="n">Profiler</span>
<span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">create_dataset</span>
<span class="kn">from</span> <span class="nn">src.model_utils.moxing_adapter</span> <span class="kn">import</span> <span class="n">moxing_wrapper</span>
<span class="kn">from</span> <span class="nn">src.model_utils.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">init_env</span>
<span class="kn">from</span> <span class="nn">src.resnet</span> <span class="kn">import</span> <span class="n">resnet50</span>


<span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
    <span class="n">dataset_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Train Epoch: </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{:.0f}</span><span class="s1">%)]</span><span class="se">\t</span><span class="s1">Loss: </span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">,</span>
                <span class="mf">100.</span> <span class="o">*</span> <span class="n">batch_idx</span> <span class="o">/</span> <span class="n">dataset_size</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">loss_func</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">test_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_func</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">dataset_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">/=</span> <span class="n">dataset_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Test set: Average loss: </span><span class="si">{:.4f}</span><span class="s1">, Accuracy: </span><span class="si">{:.0f}</span><span class="s1">%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">dataset_size</span><span class="p">))</span>


<span class="nd">@moxing_wrapper</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">train_net</span><span class="p">():</span>
    <span class="n">init_env</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
        <span class="n">profiler</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">()</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_width</span><span class="p">)),</span>
                                   <span class="n">rank_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">rank_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rank_id</span><span class="p">)</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_width</span><span class="p">)))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_num</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">resnet</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">train_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TrainOneStepWithLossScaleCell</span><span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">WithLossCell</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">loss</span><span class="p">),</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epoch_size</span><span class="p">):</span>
        <span class="n">train_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_net</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">test_epoch</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished Training&#39;</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="s1">&#39;./resnet.ckpt&#39;</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">train_net</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="性能优化">
<h2>性能优化<a class="headerlink" href="#性能优化" title="Permalink to this headline"></a></h2>
<p>我们在执行上面的训练时发现训练比较慢，需要进行性能优化，在进行具体的优化项前，我们先执行profiler工具获取下性能数据。由于profiler工具只能获取Model封装的训练，需要先改造下训练流程：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">device_num</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">device_num</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_profilor</span><span class="p">:</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">()</span>
    <span class="c1"># 注意，profiling的数据不宜过多，否则处理会很慢，这里当use_profilor=True，将原始dataset切40份</span>
    <span class="n">device_num</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                               <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_height</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">image_width</span><span class="p">)),</span>
                               <span class="n">rank_size</span><span class="o">=</span><span class="n">device_num</span><span class="p">,</span> <span class="n">rank_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rank_id</span><span class="p">)</span>
<span class="o">.....</span>
<span class="n">loss_scale</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">FixedLossScaleManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">drop_overflow_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">)</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_profilor</span><span class="p">:</span>
    <span class="c1"># 注意，profiling的数据不宜过多，否则处理会很慢</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">()],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">analyse</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">()],</span>
                <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>设置<code class="docutils literal notranslate"><span class="pre">use_profilor=True</span></code>，会在运行目录下生成<code class="docutils literal notranslate"><span class="pre">data</span></code>目录，重命名成<code class="docutils literal notranslate"><span class="pre">profiler_v1</span></code>，在同目录执行<code class="docutils literal notranslate"><span class="pre">mindinsight</span> <span class="pre">start</span></code>。</p>
<p><img alt="resnet_profiler1" src="../_images/resnet_profiler1.png" /></p>
<p>Mindinsihgt性能分析的界面如图所示（此分析是在Ascend环境上进行的，GPU上差不多，CPU暂不支持profiler）。整体上有三大部分。</p>
<p>第一部分是迭代轨迹，这部分是进行性能分析最基本的，单卡的数据包括迭代间隙和前向反向，其中前向反向的时间是模型在device上实际运行的时间，迭代间隙是其他的时间，在训练过程中包括数据处理，打印数据，保存参数等在CPU上的时间。
可以看到迭代间隙和前向反向执行的时间基本一半一半，数据处理等非device操作占了很大的一部分。</p>
<p>第二部分是前反向的网络执行时间，点进第二部分的查看详情：</p>
<p><img alt="resnet_profiler2" src="../_images/resnet_profiler2.png" /></p>
<p>上半部分是各个AICore算子占总时间的比例图，下半部分是每个算子详细的情况：</p>
<p><img alt="resnet_profiler3" src="../_images/resnet_profiler3.png" /></p>
<p>点击进去，可以获取每个算子的执行时间，算子的scope信息，算子的shape和type信息。</p>
<p>除了AICore算子，网络中还可能有AICPU算子和HOST CPU算子，这些算子相比与AICore算子会占用更多的时间，可以通过点击上方的页签查看：</p>
<p><img alt="resnet_profiler4" src="../_images/resnet_profiler4.png" /></p>
<p>除了这种查看算子性能的方法，还可以查看原始数据进行分析：</p>
<p><img alt="resnet_profiler5" src="../_images/resnet_profiler5.png" /></p>
<p>进入<code class="docutils literal notranslate"><span class="pre">profiler_v1/profiler/</span></code>目录，点击查看<code class="docutils literal notranslate"><span class="pre">aicore_intermediate_0_type.csv</span></code>文件可以查看每个算子的统计数据，共30个AICore算子，总执行时间：37.526ms</p>
<p><img alt="resnet_profiler6" src="../_images/resnet_profiler6.png" /></p>
<p>此外，<code class="docutils literal notranslate"><span class="pre">aicore_intermediate_0_detail.csv</span></code>是每个算子的详细数据，和MindInsight里显示的算子详细信息差不多。<code class="docutils literal notranslate"><span class="pre">ascend_timeline_display_0.json</span></code>是timeline数据文件，详情请参考<a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/r1.9/performance_profiling_ascend.html#timeline%E5%88%86%E6%9E%90">timeline</a>。</p>
<p>第三部分是数据处理的性能数据，在这部分可以查看，数据队列的情况：</p>
<p><img alt="resnet_profiler7" src="../_images/resnet_profiler7.png" /></p>
<p>以及每个数据处理操作的队列情况：</p>
<p><img alt="resnet_profiler8" src="../_images/resnet_profiler8.png" /></p>
<p>下面我们来对这个过程进行分析以及问题解决方法介绍：</p>
<p>从迭代轨迹来看，迭代间隙和前向反向执行的时间基本一半一半。MindSpore提供了一种<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/design/overview.html#%E9%9D%A2%E5%90%91%E6%98%87%E8%85%BE%E7%A1%AC%E4%BB%B6%E7%9A%84%E7%AB%9E%E4%BA%89%E5%8A%9B%E4%BC%98%E5%8C%96">on-device执行</a>的方法将数据处理和网络在device上的执行并行起来，只需要在<code class="docutils literal notranslate"><span class="pre">model.train</span></code>中设置<code class="docutils literal notranslate"><span class="pre">dataset_sink_mode=True</span></code>即可，注意这个配置默认是<code class="docutils literal notranslate"><span class="pre">True</span></code>当打开这个配置时，一个epoch只会返回一个网络的结果，当进行调试时建议先将这个值改成<code class="docutils literal notranslate"><span class="pre">False</span></code>。</p>
<p>下面是设置<code class="docutils literal notranslate"><span class="pre">dataset_sink_mode=True</span></code>的profiler的结果：</p>
<p><img alt="resnet_profiler9" src="../_images/resnet_profiler9.png" /></p>
<p>我们发现执行时间节省了一半。</p>
<p>我们接着进行分析和优化。从前反向的算子执行时间来看，<code class="docutils literal notranslate"><span class="pre">Cast</span></code>和<code class="docutils literal notranslate"><span class="pre">BatchNorm</span></code>几乎占了50%，那为什么会有这么多<code class="docutils literal notranslate"><span class="pre">Cast</span></code>呢？之前<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/migration_guide/model_development/model_development.html">MindSpore网络编写容易出现问题的地方</a>章节有介绍说Ascend环境下Conv，Sort，TopK只能是float16的，所以在Conv计算前后会加<code class="docutils literal notranslate"><span class="pre">Cast</span></code>算子。一个最直接的方法是将网络计算都改成float16的，只会在网络的输入和loss计算前加<code class="docutils literal notranslate"><span class="pre">Cast</span></code>，<code class="docutils literal notranslate"><span class="pre">Cast</span></code>算子的消耗就可以不计了，这就涉及到MindSpore的混合精度策略。</p>
<p>MindSpore有三种方法使用混合精度：</p>
<ol class="arabic simple">
<li><p>直接使用<code class="docutils literal notranslate"><span class="pre">Cast</span></code>，将网络的输入<code class="docutils literal notranslate"><span class="pre">cast</span></code>成<code class="docutils literal notranslate"><span class="pre">float16</span></code>，将loss的输入<code class="docutils literal notranslate"><span class="pre">cast</span></code>成<code class="docutils literal notranslate"><span class="pre">float32</span></code>；</p></li>
<li><p>使用<code class="docutils literal notranslate"><span class="pre">Cell</span></code>的<code class="docutils literal notranslate"><span class="pre">to_float</span></code>方法，详情参考<a class="reference external" href="https://www.mindspore.cn/docs/zh-CN/r1.9/migration_guide/model_development/model_and_loss.html">网络主体及loss搭建</a>；</p></li>
<li><p>使用<code class="docutils literal notranslate"><span class="pre">Model</span></code>的<code class="docutils literal notranslate"><span class="pre">amp_level</span></code>接口进行混合精度，详情参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.9/others/mixed_precision.html#%E8%87%AA%E5%8A%A8%E6%B7%B7%E5%90%88%E7%B2%BE%E5%BA%A6">自动混合精度</a>。</p></li>
</ol>
<p>这里我们使用第三种方法，将<code class="docutils literal notranslate"><span class="pre">Model</span></code>中的<code class="docutils literal notranslate"><span class="pre">amp_level</span></code>设置成<code class="docutils literal notranslate"><span class="pre">O3</span></code>，看一下profiler的结果：</p>
<p><img alt="resnet_profiler10" src="../_images/resnet_profiler10.png" /></p>
<p>我们发现每step只需要23ms了。</p>
<p>最后看一下数据处理：</p>
<p><img alt="resnet_profiler11" src="../_images/resnet_profiler11.png" /></p>
<p>加了下沉之后发现一共有两个队列了，其中主机队列是在内存上的一个队列，数据集对象不断的将网络需要的输入数据放到主机队列里。
然后又有了一个数据队列，这个队列是在device上的，将主机队列里的数据缓存到数据队列里，然后网络直接从这里获取到模型的输入。</p>
<p>可以看到主机队列很多地方是空的，这说明数据集在不断生成数据的同时很快就被数据队列拿走了；数据队列基本是满的，所以数据是完全跟得上网络训练的，数据处理不是网络训练的瓶颈。</p>
<p>如果数据队列有大部分空的情况，则需要考虑数据性能优化了。首先需要参考：</p>
<p><img alt="resnet_profiler12" src="../_images/resnet_profiler12.png" /></p>
<p>每个数据处理操作的队列，发现最后一个算子，<code class="docutils literal notranslate"><span class="pre">batch</span></code>算子空的时间比较多，可以考虑增加<code class="docutils literal notranslate"><span class="pre">batch</span></code>算子的并行度。详情请参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r1.9/dataset/optimize.html">数据处理性能优化</a>。</p>
<p>整个resnet迁移需要的代码可以在<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r1.9/docs/mindspore/source_zh_cn/migration_guide/code">code</a>获取。</p>
<p>欢迎点击下面视频，一起来学习。</p>
<div style="position: relative; padding: 30% 45%;">
<iframe style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;" src="https://player.bilibili.com/player.html?aid=216889508&bvid=BV1sa411P737&cid=802191204&page=1&high_quality=1&&danmaku=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="debug_and_tune.html" class="btn btn-neutral float-left" title="调试调优" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="faq.html" class="btn btn-neutral float-right" title="常见问题" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>