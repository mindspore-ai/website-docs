<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mindspore.nn.cell &mdash; MindSpore master 文档</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script><script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/js/theme.js"></script><script src="../../../_static/underscore.js"></script><script src="../../../_static/doctools.js"></script><script src="../../../_static/js/mermaid-9.3.0.js"></script><script src="../../../_static/translations.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/overview.html">MindSpore设计概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/programming_paradigm.html">函数式和对象式融合编程范式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/dynamic_graph_and_static_graph.html">动静态图结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/distributed_training_design.html">分布式并行原生</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/all_scenarios.html">全场景统一架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/graph_fusion_engine.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/pluggable_device.html">三方硬件对接</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型库</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/official_models.html">官方模型库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.multiprocessing.html">mindspore.multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_python/mindspore.experimental.html">mindspore.experimental</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API映射</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/api_mapping/pytorch_api_mapping.html">PyTorch与MindSpore API映射表</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">迁移指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/overview.html">迁移指南概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/enveriment_preparation.html">环境准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/analysis_and_preparation.html">模型分析与准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/model_development/model_development.html">网络搭建对比</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/debug_and_tune.html">调试调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/sample_code.html">网络迁移调试实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migration_guide/faq.html">常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语法支持</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax_support.html">静态图语法支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/operators.html">静态图语法-运算符</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/statements.html">静态图语法-Python语句</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/static_graph_syntax/python_builtin_functions.html">静态图语法-Python内置函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../note/index_support.html">Tensor索引支持</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">环境变量</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/env_var_list.html">环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/data_processing.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/implement_problem.html">执行问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/network_compilation.html">网络编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/operators_compile.html">算子编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/usage_migrate_3rd.html">第三方框架迁移使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/performance_tuning.html">性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/precision_tuning.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/distributed_parallel.html">分布式并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/inference.html">推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/feature_advice.html">特性咨询</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">模块代码</a> &raquo;</li>
      <li>mindspore.nn.cell</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>mindspore.nn.cell 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020-2024 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;cell&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">mindspore._checkparam</span> <span class="kn">import</span> <span class="n">args_type_check</span>
<span class="kn">from</span> <span class="nn">mindspore.common._auto_dynamic</span> <span class="kn">import</span> <span class="n">is_auto_dynamic</span><span class="p">,</span> <span class="n">convert_inputs_to_dynamic</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">mindspore.common.parameter</span> <span class="kn">import</span> <span class="n">PARAMETER_NAME_DEFAULT</span>
<span class="kn">from</span> <span class="nn">mindspore.common.hook_handle</span> <span class="kn">import</span> <span class="n">HookHandle</span>
<span class="kn">from</span> <span class="nn">mindspore.context</span> <span class="kn">import</span> <span class="n">ParallelMode</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore._c_expression</span> <span class="kn">import</span> <span class="n">init_pipeline</span><span class="p">,</span> <span class="n">update_func_graph_hyper_params</span><span class="p">,</span> <span class="n">Cell_</span><span class="p">,</span> <span class="n">FuncGraph</span><span class="p">,</span> <span class="n">MixedPrecisionType</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">_checkparam</span> <span class="k">as</span> <span class="n">Validator</span>
<span class="kn">from</span> <span class="nn">mindspore.common</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>
<span class="kn">from</span> <span class="nn">mindspore.common.api</span> <span class="kn">import</span> <span class="n">_cell_graph_executor</span><span class="p">,</span> <span class="n">_pynative_executor</span><span class="p">,</span> <span class="n">_get_args_for_run</span><span class="p">,</span> <span class="n">cells_compile_cache</span>
<span class="kn">from</span> <span class="nn">mindspore.common.api</span> <span class="kn">import</span> <span class="n">_generate_branch_control_input</span>
<span class="kn">from</span> <span class="nn">mindspore.common.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">ParameterTuple</span>
<span class="kn">from</span> <span class="nn">mindspore.common.tensor</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.ops.operations</span> <span class="kn">import</span> <span class="n">Cast</span>
<span class="kn">from</span> <span class="nn">mindspore.ops.primitive</span> <span class="kn">import</span> <span class="n">Primitive</span>
<span class="kn">from</span> <span class="nn">mindspore.ops.operations</span> <span class="kn">import</span> <span class="n">_inner_ops</span> <span class="k">as</span> <span class="n">inner</span>
<span class="kn">from</span> <span class="nn">mindspore.parallel.shard</span> <span class="kn">import</span> <span class="n">Shard</span>
<span class="kn">from</span> <span class="nn">mindspore._check_jit_forbidden_api</span> <span class="kn">import</span> <span class="n">jit_forbidden_register</span>
<span class="kn">from</span> <span class="nn">mindspore.common._decorator</span> <span class="kn">import</span> <span class="n">deprecated</span>


<div class="viewcode-block" id="Cell"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell">[文档]</a><span class="k">class</span> <span class="nc">Cell</span><span class="p">(</span><span class="n">Cell_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The basic building block of neural networks in MindSpore. The model or neural network layer should inherit this</span>
<span class="sd">    base class.</span>

<span class="sd">    Layers in `mindspore.nn` are also the subclass of Cell, such as :class:`mindspore.nn.Conv2d`,</span>
<span class="sd">    and :class:`mindspore.nn.ReLU`, etc. Cell will be compiled into a calculation</span>
<span class="sd">    graph in GRAPH_MODE (static graph mode) and used as the basic module of neural networks in</span>
<span class="sd">    PYNATIVE_MODE (dynamic graph mode).</span>

<span class="sd">    .. note::</span>
<span class="sd">        Cell is the inference mode by default. For a class that inherits a Cell,</span>
<span class="sd">        if the training and inference have different structures, the subclass performs the inference branch by default.</span>
<span class="sd">        To set the training mode, refer to `mindspore.nn.Cell.set_train` .</span>

<span class="sd">    .. warning::</span>
<span class="sd">        In the subclass of Cell, it&#39;s not allowed to define a method named &#39;cast&#39; and not allowed to define an attribute</span>
<span class="sd">        named &#39;phase&#39; or &#39;cells&#39;, otherwise, an error will be raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        auto_prefix (bool, optional): Whether to automatically generate NameSpace for Cell and its child cells. It also</span>
<span class="sd">                      affects the names of parameters in the `Cell`. If set to ``True`` , the parameter name will be</span>
<span class="sd">                      automatically prefixed, otherwise not. In general, the backbone network should be set to</span>
<span class="sd">                      ``True`` , otherwise the duplicate name problem will appear. The cell to train the backbone</span>
<span class="sd">                      network, such as optimizer and :class:`mindspore.nn.TrainOneStepCell`, should be set to</span>
<span class="sd">                      ``False`` , otherwise the parameter name in backbone will be changed by mistake.</span>
<span class="sd">                      Default: ``True`` .</span>
<span class="sd">        flags (dict, optional): Network configuration information, currently it is used for the binding of network</span>
<span class="sd">                      and dataset. Users can also customize network attributes by this parameter. Default: ``None`` .</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.ops as ops</span>
<span class="sd">        &gt;&gt;&gt; class MyCell(nn.Cell):</span>
<span class="sd">        ...     def __init__(self, forward_net):</span>
<span class="sd">        ...         super(MyCell, self).__init__(auto_prefix=False)</span>
<span class="sd">        ...         self.net = forward_net</span>
<span class="sd">        ...         self.relu = ops.ReLU()</span>
<span class="sd">        ...</span>
<span class="sd">        ...     def construct(self, x):</span>
<span class="sd">        ...         y = self.net(x)</span>
<span class="sd">        ...         return self.relu(y)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; inner_net = nn.Conv2d(120, 240, 4, has_bias=False, weight_init=&#39;normal&#39;)</span>
<span class="sd">        &gt;&gt;&gt; my_net = MyCell(inner_net)</span>
<span class="sd">        &gt;&gt;&gt; print(my_net.trainable_params())</span>
<span class="sd">        ... # If the &#39;auto_prefix&#39; set to True or not set when call the &#39;__init__&#39; method of the parent class,</span>
<span class="sd">        ... # the parameter&#39;s name will be &#39;net.weight&#39;.</span>
<span class="sd">        [Parameter (name=weight, shape=(240, 120, 4, 4), dtype=Float32, requires_grad=True)]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">IGNORE_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_scope&#39;</span><span class="p">,</span> <span class="s1">&#39;_cell_init_args&#39;</span><span class="p">,</span> <span class="s1">&#39;_auto_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;_cells&#39;</span><span class="p">,</span> <span class="s1">&#39;_params&#39;</span><span class="p">,</span> <span class="s1">&#39;_create_time&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;_func_graph_flags&#39;</span><span class="p">,</span> <span class="s1">&#39;_parameter_layout_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;_params_list&#39;</span><span class="p">,</span> <span class="s1">&#39;_tensor_list&#39;</span><span class="p">,</span> <span class="s1">&#39;_phase&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;_forward_pre_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_forward_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_enable_forward_pre_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_enable_forward_hook&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;_bprop_debug&#39;</span><span class="p">,</span> <span class="s1">&#39;_enable_backward_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_cell_backward_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_is_run&#39;</span><span class="p">,</span> <span class="s1">&#39;_param_prefix&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;_attr_synced&#39;</span><span class="p">,</span> <span class="s1">&#39;pynative&#39;</span><span class="p">,</span> <span class="s1">&#39;requires_grad&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Cell_</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensor_list</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primitives</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pynative</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_prefix</span> <span class="o">=</span> <span class="n">auto_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_layout_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_name_list</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_merge_net_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cells_compile_cache</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_broadcast_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exist_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exist_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">init_pipeline</span><span class="p">()</span>

        <span class="c1"># call gc to release GE session resources used by non-used cell objects</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GC_COLLECT_IN_CELL&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bprop_debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_pre_hook</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_hook</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_backward_hook</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_recursion_hook</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cast</span> <span class="o">=</span> <span class="n">Cast</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_config_recompute</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_dynamic_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_ops_label</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ge_sync_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_check_and_refresh</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_amp_level</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">Cell_</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">Cell_</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">dict_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_cell_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># `&lt;class &#39;xxxxxxx&#39;&gt;` to `xxxxxxx`</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)[</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">create_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_init_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Param prefix is the prefix of current cell&#39;s direct child parameter.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.dense = nn.Dense(2, 2)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.dense(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; net.update_cell_prefix()</span>
<span class="sd">            &gt;&gt;&gt; print(net.dense.param_prefix)</span>
<span class="sd">            dense</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_prefix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bprop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get whether cell custom bprop debug is enabled.</span>

<span class="sd">        Tutorial Examples:</span>
<span class="sd">            - `Cell and Parameter - Custom Cell Reverse</span>
<span class="sd">              &lt;https://mindspore.cn/tutorials/en/r2.3/advanced/modules/layer.html#custom-cell-reverse&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bprop_debug</span>

    <span class="nd">@bprop_debug</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bprop_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set whether to enable cell custom bprop debug.</span>

<span class="sd">        Note:</span>
<span class="sd">            When bprop is defined in cell, the bprop function will be executed</span>
<span class="sd">            in python interpreter when bprop debug is true, and will be parsed</span>
<span class="sd">            and add to graph when bprop debug is false.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bool): Specifies whether to enable bprop debug. Default: ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;bprop_debug&#39; must be bool type, but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bprop_debug</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Cell.update_cell_prefix"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.update_cell_prefix">[文档]</a>    <span class="k">def</span> <span class="nf">update_cell_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the `param_prefix` of all child cells.</span>

<span class="sd">        After being invoked, it can get all the cell&#39;s children&#39;s name prefix by &#39;_param_prefix&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cells_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cell_name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells_name</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_param_prefix</span> <span class="o">=</span> <span class="n">cell_name</span></div>

<div class="viewcode-block" id="Cell.update_cell_type"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.update_cell_type">[文档]</a>    <span class="k">def</span> <span class="nf">update_cell_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The current cell type is updated when a quantization aware training network is encountered.</span>

<span class="sd">        After being invoked, it can set the cell type to &#39;cell_type&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            cell_type(str): The type of cell to be updated, cell_type can be &quot;quant&quot; or &quot;second-order&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">=</span> <span class="n">cell_type</span></div>

    <span class="nd">@cell_init_args</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cell_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;cell_init_args&#39; must be string type, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_init_args</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span>

    <span class="nd">@phase</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;phase&#39; must be string type, but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_layout_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `parameter_layout_dict` represents the tensor layout of a parameter, which is inferred by shard strategy and</span>
<span class="sd">        distributed operator information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_layout_dict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cls_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@parameter_layout_dict</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parameter_layout_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;parameter_layout_dict&#39; must be dict type, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_layout_dict</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parallel_parameter_name_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_name_list</span>

    <span class="nd">@parallel_parameter_name_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parallel_parameter_name_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;parallel_parameter_name_list&#39; must be list type, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_name_list</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipeline_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_stage</span>

    <span class="nd">@pipeline_stage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pipeline_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;pipeline_stage&#39; &quot;</span>
                            <span class="s2">&quot;must be int type, but got type : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;pipeline_stage&#39; &quot;</span>
                             <span class="s2">&quot;can not be less than 0, but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_stage</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">add_pipeline_stage</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipeline_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_segment</span>

    <span class="nd">@pipeline_segment</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pipeline_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;For &#39;context.set_auto_parallel_context&#39;, the argument &#39;pipeline_stages&#39; &quot;</span>
                            <span class="s2">&quot;must be int type, but got type : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For &#39;context.set_auto_parallel_context&#39;, the argument &#39;pipeline_stages&#39; &quot;</span>
                             <span class="s2">&quot;can not be less than 0, but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_segment</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parallel_parameter_merge_net_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_merge_net_dict</span>

    <span class="nd">@parallel_parameter_merge_net_dict</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parallel_parameter_merge_net_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the property &#39;parallel_parameter_merge_net_dict&#39; must be dict type, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_parameter_merge_net_dict</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jit_config_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span>

<div class="viewcode-block" id="Cell.get_func_graph_proto"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.get_func_graph_proto">[文档]</a>    <span class="k">def</span> <span class="nf">get_func_graph_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return graph binary proto.&quot;&quot;&quot;</span>
        <span class="n">exec_id</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_time</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))])</span>
        <span class="k">return</span> <span class="n">_cell_graph_executor</span><span class="o">.</span><span class="n">_get_func_graph_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exec_id</span><span class="p">,</span> <span class="s2">&quot;anf_ir&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;_params&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_params&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;_cells&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_cells&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;_tensor_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">tensor_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_tensor_list&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tensor_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tensor_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;_params_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">params_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_params_list&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">params_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The &#39;</span><span class="si">{}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cells_compile_cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># while deepcopy a cell instance, the copied cell instance can&#39;t be added to cells_compile_cache</span>
            <span class="c1"># here using pop(id(self), None) to avoid KeyError exception</span>
            <span class="n">cells_compile_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span><span class="p">:</span>
                <span class="n">_cell_graph_executor</span><span class="o">.</span><span class="n">del_net_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object does not inherit attribute from &#39;cell&#39;. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;Please use &#39;super().__init__()&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;_params_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;_tensor_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor_list</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensor_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_cast_mixed_precision_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cast input for mixed precision&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cast_mixed_precision_inputs</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> \
                <span class="p">{</span><span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">}</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dst_type</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.cast_inputs"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.cast_inputs">[文档]</a>    <span class="k">def</span> <span class="nf">cast_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cast inputs to specified type.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (tuple[Tensor]): The cell inputs.</span>
<span class="sd">            dst_type (mindspore.dtype): The specified data type.</span>

<span class="sd">        returns:</span>
<span class="sd">            tuple[Tensor], the result with destination data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cast_inputs</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_parameter_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;parallel_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ParallelMode</span><span class="o">.</span><span class="n">DATA_PARALLEL</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_broadcast_done</span><span class="p">:</span>
                <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">parameter_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameter_broadcast_done</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Cell.run_construct"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.run_construct">[文档]</a>    <span class="k">def</span> <span class="nf">run_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cast_inputs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the construct function.</span>

<span class="sd">        Note:</span>
<span class="sd">            This function will be removed in a future version. It is not recommended to call this function.</span>

<span class="sd">        Args:</span>
<span class="sd">            cast_inputs (tuple): The input objects of Cell.</span>
<span class="sd">            kwargs (dict): Provide keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            output, the output object of Cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;run_construct&#39; function of &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span><span class="si">}</span><span class="s2">&#39; will be removed in a future version. &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;Calling this function is not recommended.&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_construct</span><span class="p">(</span><span class="n">cast_inputs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>

    <span class="k">def</span> <span class="nf">_run_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cast_inputs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the construct function&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_pre_hook</span><span class="p">:</span>
            <span class="n">cast_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_forward_pre_hook</span><span class="p">(</span><span class="n">cast_inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_backward_hook</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backward_hook_construct</span><span class="p">(</span><span class="o">*</span><span class="n">cast_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_shard_fn&quot;</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shard_fn</span><span class="p">(</span><span class="o">*</span><span class="n">cast_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">*</span><span class="n">cast_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_hook</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_forward_hook</span><span class="p">(</span><span class="n">cast_inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_check_construct_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the args needed by the function construct&quot;&quot;&quot;</span>
        <span class="n">positional_args</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">has_var</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">has_var</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">positional_args</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">default_args</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">has_var</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">positional_args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the function construct requires </span><span class="si">{</span><span class="n">positional_args</span><span class="si">}</span><span class="s2"> positional argument, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">. When using set_inputs, please make sure that all networks &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;and loss functions are configured with set_inputs.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">positional_args</span> <span class="o">+</span> <span class="n">default_args</span><span class="p">:</span>
            <span class="n">construct_inputs_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>
            <span class="k">if</span> <span class="s1">&#39;self&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">construct_inputs_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the method &#39;construct&#39; must have parameter &#39;self&#39;. &quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the function construct requires </span><span class="si">{</span><span class="n">positional_args</span><span class="si">}</span><span class="s2"> positional argument and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_args</span><span class="si">}</span><span class="s2"> default argument, total </span><span class="si">{</span><span class="n">positional_args</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">default_args</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hook_fn_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Hook function in graph mode&#39;&#39;&#39;</span>
        <span class="c1"># Check super().__init__() in graph mode.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_pre_hook</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_hook</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_backward_hook</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object does not inherit attribute from &#39;cell&#39;. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;Please use &#39;super().__init__()&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_recursion_hook</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_recursion_hook</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">_hook_fn_registered</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_prims_recursively</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_prims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primitives</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">all_prims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">all_prims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">_get_prims_recursively</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">all_prims</span>

<div class="viewcode-block" id="Cell.set_data_parallel"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_data_parallel">[文档]</a>    <span class="k">def</span> <span class="nf">set_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For all primitive ops in this cell(including ops of cells that wrapped by this cell),</span>
<span class="sd">        if parallel strategy is not specified, then instead of auto-searching, data parallel</span>
<span class="sd">        strategy will be generated for those primitive ops.</span>

<span class="sd">        Note:</span>
<span class="sd">            Only effective while using auto_parallel_context = ParallelMode.AUTO_PARALLEL under graph mode.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">            &gt;&gt;&gt; net = nn.Dense(3, 4)</span>
<span class="sd">            &gt;&gt;&gt; net.set_data_parallel()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;set_data_parallel: does not support PyNative mode.&quot;</span><span class="p">)</span>

        <span class="n">all_prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prims_recursively</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prim</span> <span class="ow">in</span> <span class="n">all_prims</span><span class="p">:</span>
            <span class="n">prim</span><span class="o">.</span><span class="n">add_prim_attr</span><span class="p">(</span><span class="s2">&quot;strategy_gen_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;data_parallel&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.shard"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.shard">[文档]</a>    <span class="k">def</span> <span class="nf">shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_strategy</span><span class="p">,</span> <span class="n">out_strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameter_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;Ascend&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defining the input and output layouts of this cell and the parallel strategies of remaining ops will be</span>
<span class="sd">        generated by sharding propagation. In PyNative mode, use this method</span>
<span class="sd">        to specify a Cell for distributed execution in graph mode.</span>
<span class="sd">        in_strategy and out_strategy define the input and output layout respectively.</span>
<span class="sd">        in_strategy/out_strategy should be a tuple, each element of which corresponds to the desired layout of</span>
<span class="sd">        this input/output, and None represents data_parallel,</span>
<span class="sd">        which can refer to the description of `mindspore.ops.Primitive.shard`.</span>
<span class="sd">        The parallel strategies of remaining operators are derived from the strategy specified by the input and output.</span>

<span class="sd">        Note:</span>
<span class="sd">            Only effective in PYNATIVE_MODE and in either ParallelMode.AUTO_PARALLEL with</span>
<span class="sd">            search_mode in auto_parallel_context set as sharding_propagation.</span>
<span class="sd">            If the input contain Parameter, its strategy should be set in `in_strategy`.</span>

<span class="sd">        Args:</span>
<span class="sd">            in_strategy (tuple): Define the layout of inputs, each element of the tuple should be a tuple or None. Tuple</span>
<span class="sd">                             defines the layout of the corresponding input and None represents a data parallel strategy.</span>
<span class="sd">            out_strategy (Union[None, tuple]): Define the layout of outputs similar with in_strategy.</span>
<span class="sd">                                               It is not in use right now. Default: ``None`` .</span>
<span class="sd">            parameter_plan (Union[dict, None]): Define the layout for the specified parameters. Each element in dict</span>
<span class="sd">                                                defines the layout of the parameter like &quot;param_name: layout&quot;.</span>
<span class="sd">                                                The key is a parameter name of type &#39;str&#39;.</span>
<span class="sd">                                                The value is a 1-D integer tuple, indicating the corresponding layout.</span>
<span class="sd">                                                If the parameter name is incorrect or the corresponding parameter</span>
<span class="sd">                                                has been set, the parameter setting will be ignored.</span>
<span class="sd">                                                Default: ``None`` .</span>
<span class="sd">            device (string): Select a certain device target. It is not in use right now.</span>
<span class="sd">                             Support [ ``&quot;CPU&quot;`` , ``&quot;GPU&quot;`` , ``&quot;Ascend&quot;`` ]. Default: ``&quot;Ascend&quot;`` .</span>
<span class="sd">            level (int): Option for parallel strategy infer algorithm, namely the object function, maximize computation</span>
<span class="sd">                         over communication ratio, maximize speed performance, minimize memory usage etc. It is not in</span>
<span class="sd">                         use right now. Support [ ``&quot;0&quot;`` , ``&quot;1&quot;`` , ``&quot;2&quot;`` ]. Default: ``0`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, the cell itself.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; class Block(nn.Cell):</span>
<span class="sd">            ...   def __init__(self):</span>
<span class="sd">            ...     self.dense1 = nn.Dense(10, 10)</span>
<span class="sd">            ...     self.relu = nn.ReLU()</span>
<span class="sd">            ...     self.dense2 = nn.Dense2(10, 10)</span>
<span class="sd">            ...   def construct(self, x):</span>
<span class="sd">            ...     x = self.relu(self.dense2(self.relu(self.dense1(x))))</span>
<span class="sd">            ...     return x</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; class example(nn.Cell):</span>
<span class="sd">            ...   def __init__(self):</span>
<span class="sd">            ...     self.block1 = Block()</span>
<span class="sd">            ...     self.block2 = Block()</span>
<span class="sd">            ...     self.block2.shard(in_strategy=((2, 1),), out_strategy=(None,),</span>
<span class="sd">            ...                       parameter_plan={&#39;self.block2.shard.dense1.weight&#39;: (4, 1)})</span>
<span class="sd">            ...   def construct(self, x):</span>
<span class="sd">            ...     x = self.block1(x)</span>
<span class="sd">            ...     x = self.block2(x)</span>
<span class="sd">            ...     return x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span> <span class="ow">or</span> \
                <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;parallel_mode&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;auto_parallel&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cell shard only supports auto parallel under PyNative mode. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;Please check if you call Cell.shard in the script.&quot;</span><span class="p">)</span>

        <span class="n">shard_fn</span> <span class="o">=</span> <span class="n">Shard</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">shard_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_strategy</span><span class="p">,</span> <span class="n">out_strategy</span><span class="p">,</span> <span class="n">parameter_plan</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_shard_fn&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.auto_cast_inputs"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.auto_cast_inputs">[文档]</a>    <span class="k">def</span> <span class="nf">auto_cast_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auto cast inputs in mixed precision scenarios.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (tuple): the inputs of construct.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple, the inputs after data type cast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;auto_cast_inputs&#39; is deprecated from version 2.0 and will be removed in a future version.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">cast_inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">mixed_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mixed_precision_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP16</span><span class="p">:</span>
            <span class="n">cast_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast_mixed_precision_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP32</span><span class="p">:</span>
            <span class="n">cast_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast_mixed_precision_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cast_inputs</span></div>

    <span class="k">def</span> <span class="nf">_init_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">has_init</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">init_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">construct</span> <span class="ow">is</span> <span class="n">Cell</span><span class="o">.</span><span class="n">construct</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, the method &#39;construct&#39; is not defined.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">bound_arguments</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">bound_arguments</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">args</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">bound_arguments</span><span class="o">.</span><span class="n">kwargs</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_is_check_and_refresh&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_check_and_refresh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_names_and_refresh_name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_check_and_refresh</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Run in Graph mode.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MS_JIT&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_construct_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook_fn_registered</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, it&#39;s not support hook function in graph mode. If you want to use hook &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;function, please use context.set_context to set pynative mode.&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_and_run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="c1"># Run in PyNative mode.</span>
        <span class="k">if</span> <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">is_first_cell</span><span class="p">():</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">_top_cell</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="c1"># There many Casts in parameter_broadcast. Enable build faster.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_parameter_broadcast</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cell_flags_in_pynative</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_grad_flag</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_compile_dynamic_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">new_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_construct</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">end_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">clear_res</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_check_cell_flags_in_pynative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the flags added to cell in pynative mode&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_func_graph_flags&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_graph_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_no_recompute&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Recompute is not supported in PyNative mode currently, you can use &quot;</span>
                            <span class="s2">&quot;&#39;context.set_context(mode=context.GRAPH_MODE)&#39; or @jit to set graph mode.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;__&#39;</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Cell</span><span class="o">.</span><span class="n">IGNORE_LIST</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Cell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sync_attr_for_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sync the attr to c++ object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_cells&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_sync_attr_for_compile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params_list&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">:</span>
            <span class="n">params_list_item</span> <span class="o">=</span> <span class="n">params_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">params_list_item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set attr for parameter.&quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_cells&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, can not assign params before Cell.__init__() is called.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> should not be Parameter.&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cells</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be Cell, but got Parameter.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_param_to_cell</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_parameter_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set attr for parameter in ParameterTuple.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params_list&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, can not assign params before Cell.__init__() is called.&quot;</span><span class="p">)</span>
        <span class="n">exist_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">exist_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">exist_objs</span><span class="p">:</span>
                <span class="c1"># If there are multiple identical objects, their names only check once.</span>
                <span class="k">continue</span>
            <span class="n">exist_objs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">PARAMETER_NAME_DEFAULT</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, the parameter definition is deprecated.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Please set a unique name for the parameter in ParameterTuple &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_param_to_cell</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">check_name_contain_dot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">exist_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The value </span><span class="si">{}</span><span class="s2"> , its name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. &quot;</span>
                                 <span class="s2">&quot;Please set a unique name for the parameter.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">exist_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">params_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_parameter_in_list_or_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set attr for parameter in list or tuple.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exist_objs</span><span class="p">:</span>
                <span class="c1"># If there are multiple identical objects, their names only check once.</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exist_objs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">PARAMETER_NAME_DEFAULT</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exist_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The value </span><span class="si">{}</span><span class="s2"> , its name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. &quot;</span>
                                 <span class="s2">&quot;Please set a unique name for the parameter.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exist_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set attr for cell.&quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_cells&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;For &#39;Cell&#39;, can not assign cells before Cell.__init__() is called.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be Parameter, but got Cell.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_prefix</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cell_init_args&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_init_args</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the type of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be Parameter or ParameterTuple, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_param_to_cell</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_attr_for_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">tensor_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_tensor_list&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">tensor_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_cells&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ParameterTuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_parameter_tuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">_check_param_list_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_parameter_in_list_or_tuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Cell</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_cell</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_params</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cells</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;Cell&#39;, the type of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be cell, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attr_for_tensor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Primitive</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">set_prim_instance_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_primitives</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Cell</span><span class="o">.</span><span class="n">IGNORE_LIST</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attr_synced</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Cell.extend_repr"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.extend_repr">[文档]</a>    <span class="k">def</span> <span class="nf">extend_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expand the description of Cell.</span>

<span class="sd">        To print customized extended information, re-implement this method in your own cells.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">extra_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extend_repr</span><span class="p">()</span>
        <span class="n">info_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;&lt;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">:</span>
            <span class="n">sub_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">extra_str</span><span class="p">:</span>
                <span class="n">sub_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extend_repr</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sub_str</span> <span class="o">+=</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">sub_str</span> <span class="o">=</span> <span class="n">sub_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
            <span class="n">info_str</span> <span class="o">+=</span> <span class="n">sub_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_str</span> <span class="o">+=</span> <span class="n">extra_str</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
        <span class="k">return</span> <span class="n">info_str</span>

    <span class="k">def</span> <span class="nf">load_parameter_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace parameters with sliced tensors by parallel strategies.</span>

<span class="sd">        Note:</span>
<span class="sd">            This interface is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;load_parameter_slice&#39; function is deprecated.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_parallel_input_with_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice inputs tensors by parallel strategies.</span>

<span class="sd">        Note:</span>
<span class="sd">            This interface is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;set_parallel_input_with_inputs&#39; function is deprecated.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.set_inputs"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_inputs">[文档]</a>    <span class="k">def</span> <span class="nf">set_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save set inputs for computation graph. The number of inputs should be the same with that of the datasets. When</span>
<span class="sd">        using Model for dynamic shape, please make sure that all networks and loss functions passed to the Model are</span>
<span class="sd">        configured with set_inputs. The inputs can be Tensor of either dynamic or static shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (tuple): Inputs of the Cell object.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This is an experimental API that is subject to change or deletion.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import nn, Tensor</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; class ReluNet(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(ReluNet, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         return self.relu(x)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; net = ReluNet()</span>
<span class="sd">            &gt;&gt;&gt; input_dyn = Tensor(shape=[3, None], dtype=ms.float32)</span>
<span class="sd">            &gt;&gt;&gt; net.set_inputs(input_dyn)</span>
<span class="sd">            &gt;&gt;&gt; input1 = Tensor(np.random.random([3, 10]), dtype=ms.float32)</span>
<span class="sd">            &gt;&gt;&gt; output = net(input1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_ops_label</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For Cell, set_inputs must be set before the gradient function of the network is &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;generated.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_construct_args</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_dynamic_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.get_inputs"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.get_inputs">[文档]</a>    <span class="k">def</span> <span class="nf">get_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the dynamic_inputs of a cell object in one network.</span>

<span class="sd">        Returns:</span>
<span class="sd">            inputs (tuple), Inputs of the Cell object.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This is an experimental API that is subject to change or deletion.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import nn, Tensor</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; class ReluNet(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(ReluNet, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         return self.relu(x)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; net = ReluNet()</span>
<span class="sd">            &gt;&gt;&gt; input_dyn = Tensor(shape=[3, None], dtype=ms.float32)</span>
<span class="sd">            &gt;&gt;&gt; net.set_inputs(input_dyn)</span>
<span class="sd">            &gt;&gt;&gt; get_inputs = net.get_inputs()</span>
<span class="sd">            &gt;&gt;&gt; print(get_inputs)</span>
<span class="sd">            (Tensor(shape=[3, -1], dtype=Float32, value= ),)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span></div>

    <span class="k">def</span> <span class="nf">_get_compile_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get compile arguments.&quot;&quot;&quot;</span>
        <span class="c1"># this is used only for test</span>
        <span class="k">if</span> <span class="n">is_auto_dynamic</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="o">=</span> <span class="n">convert_inputs_to_dynamic</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Compiled Graph with dynamic shape&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_compile_dynamic_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saved_dynamic_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_shape_inputs</span>
        <span class="k">return</span> <span class="n">args</span>


<div class="viewcode-block" id="Cell.compile"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.compile">[文档]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile Cell as a computation graph, the input must be consistent with the input defined in construct.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Args of the Cell object.</span>
<span class="sd">            kwargs (dict): Kwargs of the Cell object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_compile_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">_cell_graph_executor</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                     <span class="n">jit_config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.compile_and_run"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.compile_and_run">[文档]</a>    <span class="k">def</span> <span class="nf">compile_and_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile and run Cell, the input must be consistent with the input defined in construct.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is not recommended to call directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Args of the Cell object.</span>
<span class="sd">            kwargs (dict): Kwargs of the Cell object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Object, the result of executing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="n">ge_sync_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="n">_get_args_for_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_cell_graph_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">new_args</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">auto_parallel_compile_and_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not to execute compile and run in &#39;AUTO_PARALLEL&#39; or &#39;SEMI_AUTO_PARALLEL&#39; mode.</span>

<span class="sd">        Note:</span>
<span class="sd">            This interface is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;auto_parallel_compile_and_run&#39; function is deprecated.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.exec_checkpoint_graph"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.exec_checkpoint_graph">[文档]</a>    <span class="k">def</span> <span class="nf">exec_checkpoint_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes GE saving checkpoint graph operation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="n">ge_sync_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_cell_graph_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.insert_param_to_cell"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.insert_param_to_cell">[文档]</a>    <span class="k">def</span> <span class="nf">insert_param_to_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">check_name_contain_dot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a parameter to the current cell.</span>

<span class="sd">        Inserts a parameter with given name to the cell. The method is currently used in</span>
<span class="sd">        `mindspore.nn.Cell.__setattr__`.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_name (str): Name of the parameter.</span>
<span class="sd">            param (Parameter): Parameter to be inserted to the cell.</span>
<span class="sd">            check_name_contain_dot (bool): Determines whether the name input is compatible. Default: ``True`` .</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the name of parameter is null or contains dot.</span>
<span class="sd">            TypeError: If the type of parameter is not Parameter.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn, Parameter</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; net.insert_param_to_cell(&quot;bias&quot;, Parameter(Tensor([1, 2, 3])))</span>
<span class="sd">            &gt;&gt;&gt; print(net.bias)</span>
<span class="sd">            Parameter(name=bias, shape=(3,), dtype=Int64, requires_grad=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_param_to_cell&#39;, the argument &#39;param_name&#39; should not be None.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_name_contain_dot</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">param_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_param_to_cell&#39;, the argument &#39;param_name&#39; should not contain&#39;.&#39; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_params&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_param_to_cell&#39;, please call Cell.__init__() firstly.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_param_to_cell&#39;, the </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> parameter already exists in the network.&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Cannot insert another parameter with the same name.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_param_to_cell&#39;, the argument &#39;param&#39; must be &#39;Parameter&#39; if not None, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">PARAMETER_NAME_DEFAULT</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">param_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span></div>

<div class="viewcode-block" id="Cell.cast_param"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.cast_param">[文档]</a>    <span class="k">def</span> <span class="nf">cast_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cast parameter according to auto mix precision level in pynative mode.</span>

<span class="sd">        This interface is currently used in the case of auto mix precision and usually needs not to be used explicitly.</span>

<span class="sd">        Args:</span>
<span class="sd">            param (Parameter): Parameters, the type of which should be cast.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Parameter, the input parameter with type automatically cast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;cast_param&#39; is deprecated from version 2.0 and will be removed in a future version.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">mixed_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mixed_precision_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">!=</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP32</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">set_cast_dtype</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP16</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">set_cast_dtype</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s2">&quot;set_cast_dtype&quot;</span><span class="p">):</span>
            <span class="c1"># retest dtype</span>
            <span class="n">param</span><span class="o">.</span><span class="n">set_cast_dtype</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">param</span></div>

<div class="viewcode-block" id="Cell.insert_child_to_cell"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.insert_child_to_cell">[文档]</a>    <span class="k">def</span> <span class="nf">insert_child_to_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a child cell to the current cell with a given name.</span>

<span class="sd">        Args:</span>
<span class="sd">            child_name (str): Name of the child cell.</span>
<span class="sd">            child_cell (Cell): The child cell to be inserted.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: Child Cell&#39;s name is incorrect or duplicated with the other child name.</span>
<span class="sd">            TypeError: If type of `child_name` is not str.</span>
<span class="sd">            TypeError: Child Cell&#39;s type is incorrect.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; net1 = nn.ReLU()</span>
<span class="sd">            &gt;&gt;&gt; net2 = nn.Dense(2, 2)</span>
<span class="sd">            &gt;&gt;&gt; net1.insert_child_to_cell(&quot;child&quot;, net2)</span>
<span class="sd">            &gt;&gt;&gt; print(net1)</span>
<span class="sd">            ReLU&lt;</span>
<span class="sd">              (child): Dense&lt;input_channels=2, output_channels=2, has_bias=True&gt;</span>
<span class="sd">              &gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_child_to_cell&#39;, the type of parameter &#39;child_name&#39; must be str, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">child_name</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">child_name</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">child_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_child_to_cell&#39;, the parameter &#39;child_name&#39; can not be None and &quot;</span>
                           <span class="s2">&quot;can not contain &#39;.&#39; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_child_to_cell&#39;, the </span><span class="si">{</span><span class="n">child_name</span><span class="si">}</span><span class="s2"> child cell already exists in the network.&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Cannot insert another child cell with the same name.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_cell</span><span class="p">,</span> <span class="n">Cell</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;insert_child_to_cell&#39;, the argument &#39;child_cell&#39; must be &#39;Cell&#39; if not None, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">child_cell</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_cell</span></div>

<div class="viewcode-block" id="Cell.construct"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.construct">[文档]</a>    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the computation to be performed. This method must be overridden by all subclasses.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is not supported currently that inputs contain both tuple and non-tuple types at same time.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (tuple): Tuple of variable parameters.</span>
<span class="sd">            kwargs (dict): Dictionary of variable keyword parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tensor, returns the computed result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Cell.remove_redundant_parameters"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.remove_redundant_parameters">[文档]</a>    <span class="k">def</span> <span class="nf">remove_redundant_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the redundant parameters.</span>

<span class="sd">        This interface usually needs not to be used explicitly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_parameter_name_list</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;remove the redundant parameter: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ParameterTuple</span><span class="p">):</span>
                    <span class="n">param_tuple</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">new_param_tuple</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_tuple</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_parameter_name_list</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;remove the redundant parameter: </span><span class="si">%s</span><span class="s2"> in ParameterTuple&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">new_param_tuple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParameterTuple</span><span class="p">(</span><span class="n">new_param_tuple</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.init_parameters_data"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.init_parameters_data">[文档]</a>    <span class="k">def</span> <span class="nf">init_parameters_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_parallel_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize all parameters and replace the original saved parameters in cell.</span>

<span class="sd">        Note:</span>
<span class="sd">            trainable_params() and other similar interfaces may return different parameter instance after</span>
<span class="sd">            `init_parameters_data`, do not save these results.</span>

<span class="sd">        Args:</span>
<span class="sd">            auto_parallel_mode (bool): If running in auto_parallel_mode. Default: ``False`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[Parameter, Parameter], returns a dict of original parameter and replaced parameter.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.dense = nn.Dense(2, 2)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.dense(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; print(net.init_parameters_data())</span>
<span class="sd">            {Parameter (name=dense.weight, shape=(2,2), dtype=Float32, requires_grad=True):</span>
<span class="sd">             Parameter (name=dense.weight, shape=(2,2), dtype=Float32, requires_grad=True),</span>
<span class="sd">             Parameter (name=dense.bias, shape=(2,), dtype=Float32, requires_grad=True):</span>
<span class="sd">             Parameter (name=dense.bias, shape=(2,), dtype=Float32, requires_grad=True)}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_updata</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">replace</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">replace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">new_p</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">init_data</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_sliced</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">replace</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_p</span>
            <span class="k">return</span> <span class="n">new_p</span>

        <span class="c1"># replace all original usage.</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_parallel_mode</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_updata</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_parameter_name_list</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_updata</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">cell_dict</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cell_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ParameterTuple</span><span class="p">):</span>
                    <span class="n">param_tuple</span> <span class="o">=</span> <span class="n">cell_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">new_param_tuple</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_tuple</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_parallel_mode</span><span class="p">:</span>
                            <span class="n">new_param_tuple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_updata</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_parameter_name_list</span><span class="p">:</span>
                            <span class="n">new_param_tuple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_updata</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_param_tuple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ParameterTuple</span><span class="p">(</span><span class="n">new_param_tuple</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">replace</span></div>

<div class="viewcode-block" id="Cell.parameters_dict"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.parameters_dict">[文档]</a>    <span class="k">def</span> <span class="nf">parameters_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the parameters dictionary of this cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse (bool): Whether contains the parameters of subcells. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            OrderedDict, return parameters dictionary.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn, Parameter</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.dense = nn.Dense(2, 2)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.dense(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; print(net.parameters_dict())</span>
<span class="sd">            OrderedDict([(&#39;dense.weight&#39;, Parameter(name=dense.weight, shape=(2, 2), dtype=Float32,</span>
<span class="sd">            requires_grad=True)), (&#39;dense.bias&#39;, Parameter(name=dense.bias, shape=(2,), dtype=Float32,</span>
<span class="sd">            requires_grad=True))])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">):</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">return</span> <span class="n">param_dict</span></div>

<div class="viewcode-block" id="Cell.parameters_broadcast_dict"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.parameters_broadcast_dict">[文档]</a>    <span class="k">def</span> <span class="nf">parameters_broadcast_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the parameters broadcast dictionary of this cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse (bool): Whether contains the parameters of subcells. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            OrderedDict, return parameters broadcast dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">layerwise_parallel</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">param_dict</span></div>

<div class="viewcode-block" id="Cell.update_parameters_name"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.update_parameters_name">[文档]</a>    <span class="k">def</span> <span class="nf">update_parameters_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the `prefix` string to the names of parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): The prefix string. Default: ``&#39;&#39;`` .</span>
<span class="sd">            recurse (bool): Whether contains the parameters of subcells. Default: ``True`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Validator</span><span class="o">.</span><span class="n">check_str_and_none_by_regular</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">is_init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span></div>

    <span class="k">def</span> <span class="nf">_update_local_parameters_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the names of local parameters with given prefix string.</span>

<span class="sd">        Adds the given prefix to the names of local parameters.</span>

<span class="sd">        Local parameters means the parameters without user input.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): The prefix string. Default: &#39;&#39;.</span>
<span class="sd">            recurse (bool): Whether contains the parameters of subcells. Default: ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Validator</span><span class="o">.</span><span class="n">check_str_by_regular</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_parameters</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">param</span><span class="o">.</span><span class="n">is_init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span>

    <span class="c1"># generate api by del decorator.</span>
<div class="viewcode-block" id="Cell.trainable_params"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.trainable_params">[文档]</a>    <span class="k">def</span> <span class="nf">trainable_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all trainable parameters.</span>

<span class="sd">        Returns a list of all trainable parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse (bool): Whether contains the trainable parameters of subcells. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            List, the list of trainable parameters.</span>

<span class="sd">        Tutorial Examples:</span>
<span class="sd">            - `Model Training - Optimizer</span>
<span class="sd">              &lt;https://mindspore.cn/tutorials/en/r2.3/beginner/train.html#optimizer&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">)))</span></div>

    <span class="c1"># generate api by del decorator.</span>
<div class="viewcode-block" id="Cell.untrainable_params"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.untrainable_params">[文档]</a>    <span class="k">def</span> <span class="nf">untrainable_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all untrainable parameters.</span>

<span class="sd">        Returns a list of all untrainable parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse (bool): Whether contains the untrainable parameters of subcells. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            List, the list of untrainable parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">recurse</span><span class="p">)))</span></div>

    <span class="c1"># generate api by del decorator.</span>
<div class="viewcode-block" id="Cell.get_parameters"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.get_parameters">[文档]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over cell parameters.</span>

<span class="sd">        Yields parameters of this cell. If `expand` is ``true`` , yield parameters of this cell and all subcells.</span>
<span class="sd">        For more details about subcells, please see the example below.</span>

<span class="sd">        Args:</span>
<span class="sd">            expand (bool): If ``true`` , yields parameters of this cell and all subcells. Otherwise, only yield</span>
<span class="sd">                           parameters that are direct members of this cell. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iteration, all parameters at the cell.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import nn, ops, Tensor</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; class TestNet(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super().__init__()</span>
<span class="sd">            ...         self.my_w1 = ms.Parameter(Tensor(np.ones([4, 4]), ms.float32))</span>
<span class="sd">            ...         self.my_w2 = ms.Parameter(Tensor(np.ones([16]), ms.float32))</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x += self.my_w1</span>
<span class="sd">            ...         x = ops.reshape(x, (16,)) - self.my_w2</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; class TestNet2(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super().__init__()</span>
<span class="sd">            ...         self.my_t1 = ms.Parameter(Tensor(np.ones([4, 4]), ms.float32))</span>
<span class="sd">            ...         # self.subcell is a subcell of TestNet2, when using expand=True, the parameters of TestNet will</span>
<span class="sd">            ...         # also be gathered.</span>
<span class="sd">            ...         self.subcell = TestNet()</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x += self.my_w1</span>
<span class="sd">            ...         x = ops.reshape(x, (16,)) - self.my_w2</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = TestNet2()</span>
<span class="sd">            &gt;&gt;&gt; print([p for p in net.get_parameters(expand=True)])</span>
<span class="sd">            [Parameter (name=my_t1, shape=(4, 4), dtype=Float32, requires_grad=True), Parameter (name=subcell.my_w1,</span>
<span class="sd">            shape=(4, 4), dtype=Float32, requires_grad=True), Parameter (name=subcell.my_w2, shape=(16,), dtype=Float32,</span>
<span class="sd">            requires_grad=True)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">param</span></div>

    <span class="c1"># pylint: disable=missing-docstring</span>
    <span class="k">def</span> <span class="nf">check_names_and_refresh_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_params&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">all_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_name</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_names</span><span class="p">()</span>

<div class="viewcode-block" id="Cell.check_names"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.check_names">[文档]</a>    <span class="k">def</span> <span class="nf">check_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the names of cell parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The value of </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">, its name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists. &quot;</span>
                                 <span class="s2">&quot;Please set a unique name for the parameter.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.parameters_and_names"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.parameters_and_names">[文档]</a>    <span class="k">def</span> <span class="nf">parameters_and_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over cell parameters.</span>

<span class="sd">        Includes the parameter&#39;s name and itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            name_prefix (str): Namespace. Default: ``&#39;&#39;`` .</span>
<span class="sd">            expand (bool): If true, yields parameters of this cell and all subcells. Otherwise, only yield parameters</span>
<span class="sd">                           that are direct members of this cell. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iteration, all the names and corresponding parameters in the cell.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import nn</span>
<span class="sd">            &gt;&gt;&gt; n = nn.Dense(3, 4)</span>
<span class="sd">            &gt;&gt;&gt; names = []</span>
<span class="sd">            &gt;&gt;&gt; for m in n.parameters_and_names():</span>
<span class="sd">            ...     if m[0]:</span>
<span class="sd">            ...         names.append(m[0])</span>

<span class="sd">        Tutorial Examples:</span>
<span class="sd">            - `Building a Network - Model Parameters</span>
<span class="sd">              &lt;https://mindspore.cn/tutorials/en/r2.3/beginner/model.html#model-parameters&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">(</span><span class="n">name_prefix</span><span class="o">=</span><span class="n">name_prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="n">params_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cell_name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">par</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">inited_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">inited_param</span>
                <span class="k">if</span> <span class="n">par</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params_set</span><span class="p">:</span>
                    <span class="n">params_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">par</span><span class="p">))</span>
                    <span class="n">par_new_name</span> <span class="o">=</span> <span class="n">par_name</span>
                    <span class="k">if</span> <span class="n">cell_name</span><span class="p">:</span>
                        <span class="n">par_new_name</span> <span class="o">=</span> <span class="n">cell_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">par_new_name</span>

                    <span class="k">yield</span> <span class="n">par_new_name</span><span class="p">,</span> <span class="n">par</span></div>

<div class="viewcode-block" id="Cell.cells_and_names"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.cells_and_names">[文档]</a>    <span class="k">def</span> <span class="nf">cells_and_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over all cells in the network, including the cell&#39;s name and itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            cells (str): Cells to iterate over. Default: ``None`` .</span>
<span class="sd">            name_prefix (str): Namespace. Default: ``&#39;&#39;`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iteration, all the child cells and corresponding names in the cell.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import nn</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.conv = nn.Conv2d(3, 64, 3)</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         out = self.conv(x)</span>
<span class="sd">            ...         return out</span>
<span class="sd">            &gt;&gt;&gt; names = []</span>
<span class="sd">            &gt;&gt;&gt; n = Net()</span>
<span class="sd">            &gt;&gt;&gt; for m in n.cells_and_names():</span>
<span class="sd">            ...     if m[0]:</span>
<span class="sd">            ...         names.append(m[0])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_cells</span> <span class="o">=</span> <span class="n">cells</span> <span class="k">if</span> <span class="n">cells</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">t_cells</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">t_cells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">name_prefix</span><span class="p">,</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cell</span><span class="p">:</span>
                <span class="n">cells_name_prefix</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">name_prefix</span><span class="p">:</span>
                    <span class="n">cells_name_prefix</span> <span class="o">=</span> <span class="n">name_prefix</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cells_name_prefix</span>
                <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">cells_and_names</span><span class="p">(</span><span class="n">t_cells</span><span class="p">,</span> <span class="n">cells_name_prefix</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">ele</span></div>

<div class="viewcode-block" id="Cell.cells"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.cells">[文档]</a>    <span class="k">def</span> <span class="nf">cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over immediate cells.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iteration, the immediate cells in the cell.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.dense = nn.Dense(2, 2)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.dense(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; print(net.cells())</span>
<span class="sd">            odict_values([Dense&lt;input_channels=2, output_channels=2, has_bias=True&gt;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_cells</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_set_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the name on the first time.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">==</span> <span class="s1">&#39;recompute_&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_children_scope_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_prefix</span><span class="o">=</span><span class="s1">&#39;Default&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the scope of each layer of the network recursively.&quot;&quot;&quot;</span>
        <span class="n">reserve_class_name_in_scope</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;reserve_class_name_in_scope&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_cells</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">cell</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">if</span> <span class="n">reserve_class_name_in_scope</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">yield</span> <span class="n">parent_prefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">cell</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_cells</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">cell</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">if</span> <span class="n">reserve_class_name_in_scope</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">_children_scope_recursive</span><span class="p">(</span><span class="n">parent_prefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

<div class="viewcode-block" id="Cell.get_scope"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.get_scope">[文档]</a>    <span class="k">def</span> <span class="nf">get_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the scope of a cell object in one network.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String, scope of the cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span></div>

<div class="viewcode-block" id="Cell.generate_scope"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.generate_scope">[文档]</a>    <span class="k">def</span> <span class="nf">generate_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the scope for each cell object in the network.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children_scope_recursive</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_set_scope</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.name_cells"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.name_cells">[文档]</a>    <span class="k">def</span> <span class="nf">name_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over all immediate cells in the network.</span>

<span class="sd">        Include name of the cell and cell itself.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict, all the child cells and corresponding names in the cell.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.dense = nn.Dense(2, 2)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.dense(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; print(net.name_cells())</span>
<span class="sd">            OrderedDict([(&#39;dense&#39;, Dense&lt;input_channels=2, output_channels=2, has_bias=True&gt;)])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value_set</span><span class="p">:</span>
                <span class="n">value_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">cells</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="k">return</span> <span class="n">cells</span></div>

    <span class="k">def</span> <span class="nf">_add_mixed_precision_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add mixed precision flag to current cell&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;fp16&quot;</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">and</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">Cell_</span><span class="o">.</span><span class="n">set_mixed_precision_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP16</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;fp32&quot;</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">and</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">Cell_</span><span class="o">.</span><span class="n">set_mixed_precision_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP32</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;bf16&quot;</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">and</span> <span class="n">flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bf16&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">Cell_</span><span class="o">.</span><span class="n">set_mixed_precision_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">BF16</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.apply"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.apply">[文档]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies fn recursively to every subcell (as returned by .cells()) as well as self.</span>
<span class="sd">        Typical use includes initializing the parameters of a model.</span>

<span class="sd">        Args:</span>
<span class="sd">            fn (function): function to be applied to each subcell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, self.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">            &gt;&gt;&gt; from mindspore.common.initializer import initializer, One</span>
<span class="sd">            &gt;&gt;&gt; net = nn.SequentialCell(nn.Dense(2, 2), nn.Dense(2, 2))</span>
<span class="sd">            &gt;&gt;&gt; def func(cell):</span>
<span class="sd">            ...     if isinstance(cell, nn.Dense):</span>
<span class="sd">            ...         cell.weight.set_data(initializer(One(), cell.weight.shape, cell.weight.dtype))</span>
<span class="sd">            &gt;&gt;&gt; net.apply(func)</span>
<span class="sd">            SequentialCell&lt;</span>
<span class="sd">              (0): Dense&lt;input_channels=2, output_channels=2, has_bias=True&gt;</span>
<span class="sd">              (1): Dense&lt;input_channels=2, output_channels=2, has_bias=True&gt;</span>
<span class="sd">              &gt;</span>
<span class="sd">            &gt;&gt;&gt; print(net[0].weight.asnumpy())</span>
<span class="sd">            [[1. 1.]</span>
<span class="sd">             [1. 1.]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.add_flags"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.add_flags">[文档]</a>    <span class="k">def</span> <span class="nf">add_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add customized attributes for cell.</span>

<span class="sd">        This method is also called when the cell class is instantiated and the class parameter &#39;flags&#39; is set to True.</span>

<span class="sd">        Args:</span>
<span class="sd">            flags (dict): Network configuration information, currently it is used for the binding of network and</span>
<span class="sd">                dataset. Users can also customize network attributes by this parameter.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; net.add_flags(sink_mode=True)</span>
<span class="sd">            &gt;&gt;&gt; print(net.sink_mode)</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_func_graph_flags&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func_graph_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_graph_flags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="n">flags</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">**</span><span class="n">flags</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_mixed_precision_flag</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.add_flags_recursive"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.add_flags_recursive">[文档]</a>    <span class="k">def</span> <span class="nf">add_flags_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a cell contains child cells, this method can recursively customize attributes of all cells.</span>

<span class="sd">        Args:</span>
<span class="sd">            flags (dict): Network configuration information, currently it is used for the binding of network and</span>
<span class="sd">                dataset. Users can also customize network attributes by this parameter.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; net.add_flags_recursive(sink_mode=True)</span>
<span class="sd">            &gt;&gt;&gt; print(net.sink_mode)</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_add_init_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cell_init_args&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cell_init_args</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">({</span><span class="o">**</span><span class="n">args</span><span class="p">})</span>

<div class="viewcode-block" id="Cell.get_flags"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.get_flags">[文档]</a>    <span class="k">def</span> <span class="nf">get_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the self_defined attributes of the cell, which can be added by `add_flags` method.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; net.add_flags(sink_mode=True)</span>
<span class="sd">            &gt;&gt;&gt; print(net.get_flags())</span>
<span class="sd">            {&#39;sink_mode&#39;:True}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_func_graph_flags&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func_graph_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_graph_flags</span></div>

<div class="viewcode-block" id="Cell.to_float"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.to_float">[文档]</a>    <span class="k">def</span> <span class="nf">to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add cast on all inputs of cell and child cells to run with certain float type.</span>

<span class="sd">        If `dst_type` is `mindspore.dtype.float16`, all the inputs of Cell, including input, Parameter and Tensor, will</span>
<span class="sd">        be cast to float16. Please refer to the usage in source code of :func:`mindspore.amp.build_train_network`.</span>

<span class="sd">        Note:</span>
<span class="sd">            Multiple calls will overwrite.</span>

<span class="sd">        Args:</span>
<span class="sd">            dst_type (:class:`mindspore.dtype`): Transfer cell to run with dst_type.</span>
<span class="sd">                dst_type can be `mstype.float16` , `mstype.float32` or `mstype.bfloat16`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, the cell itself.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If dst_type is not `mstype.float32` , `mstype.float16` or `mstype.bfloat16`.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">            ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; net = nn.Conv2d(120, 240, 4, has_bias=False, weight_init=&#39;normal&#39;)</span>
<span class="sd">            &gt;&gt;&gt; net.to_float(mstype.float16)</span>
<span class="sd">            Conv2d&lt;input_channels=120, output_channels=240, kernel_size=(4, 4), stride=(1, 1), pad_mode=same,</span>
<span class="sd">            padding=0, dilation=(1, 1), group=1, has_bias=False, weight_init=normal, bias_init=None, format=NCHW&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dst_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For &#39;to_float&#39;, the argument &#39;dst_type&#39; must be mstype.float32, mstype.float16 or &quot;</span>
                             <span class="s2">&quot;mstype.bfloat16, but got type: </span><span class="si">{}</span><span class="s2"> and value: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dst_type</span><span class="p">),</span> <span class="n">dst_type</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fp16&#39;</span><span class="p">:</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">&#39;fp32&#39;</span><span class="p">:</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                 <span class="s1">&#39;bf16&#39;</span><span class="p">:</span> <span class="n">dst_type</span> <span class="o">==</span> <span class="n">mstype</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_init_args</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.set_boost"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_boost">[文档]</a>    <span class="k">def</span> <span class="nf">set_boost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boost_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In order to improve the network performance, configure the network auto enable to</span>
<span class="sd">        accelerate the algorithm in the algorithm library.</span>

<span class="sd">        If `boost_type` is not in the algorithm library, please view the algorithm in the algorithm library through</span>
<span class="sd">        `algorithm library &lt;https://gitee.com/mindspore/mindspore/tree/r2.3/mindspore/python/mindspore/boost&gt;`_.</span>

<span class="sd">        Note:</span>
<span class="sd">            Some acceleration algorithms may affect the accuracy of the network, please choose carefully.</span>

<span class="sd">        Args:</span>
<span class="sd">            boost_type (str): accelerate algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, the cell itself.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If boost_type is not in the algorithm library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">boost_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;less_bn&quot;</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For &#39;set_boost&#39;, the argument &#39;boost_type&#39; must be &#39;less_bn&#39;, &quot;</span>
                             <span class="s2">&quot;but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">boost_type</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;less_bn&quot;</span><span class="p">:</span> <span class="n">boost_type</span> <span class="o">==</span> <span class="s2">&quot;less_bn&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.set_grad"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_grad">[文档]</a>    <span class="k">def</span> <span class="nf">set_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the cell flag for gradient. In pynative mode, this parameter specifies whether the network requires</span>
<span class="sd">        gradients. If ``true`` , the backward network needed to compute the gradients will be generated when the forward</span>
<span class="sd">        network is executed.</span>

<span class="sd">        Args:</span>
<span class="sd">            requires_grad (bool): Specifies if the net need to grad, if it is</span>
<span class="sd">                ``true`` , the cell will construct backward network in pynative mode. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, the cell itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="n">requires_grad</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.set_train"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_train">[文档]</a>    <span class="k">def</span> <span class="nf">set_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the cell to training mode.</span>

<span class="sd">        The cell itself and all children cells will be set to training mode. Layers that have different constructions</span>
<span class="sd">        for training and predicting, such as `BatchNorm`, will distinguish between the branches by this attribute. If</span>
<span class="sd">        set to true, the training branch will be executed, otherwise another branch.</span>

<span class="sd">        Note:</span>
<span class="sd">            When execute function Model.train(), framework will call Cell.set_train(True).</span>
<span class="sd">            When execute function Model.eval(), framework will call Cell.set_train(False).</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (bool): Specifies whether the model is training. Default: ``True`` .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Cell, the cell itself.</span>

<span class="sd">        Tutorial Examples:</span>
<span class="sd">            - `Model Training - Implementing Training and Evaluation</span>
<span class="sd">              &lt;https://mindspore.cn/tutorials/en/r2.3/beginner/train.html#training-and-evaluation&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="s1">&#39;predict&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Cell.set_broadcast_flag"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_broadcast_flag">[文档]</a>    <span class="k">def</span> <span class="nf">set_broadcast_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set parameter broadcast mode for this cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (bool): Specifies whether the mode is parameter broadcast. Default: ``True`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="n">broadcast_flag</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">set_auto_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the cell to auto parallel mode.</span>

<span class="sd">        Note:</span>
<span class="sd">            This interface is deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;set_auto_parallel&#39; function is deprecated.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.set_jit_config"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_jit_config">[文档]</a>    <span class="k">def</span> <span class="nf">set_jit_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jit_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set jit config for cell.</span>

<span class="sd">        Args:</span>
<span class="sd">            jit_config (JitConfig): Jit config for compile. For details, please refer to :class:`mindspore.JitConfig`.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; jitconfig = ms.JitConfig()</span>
<span class="sd">            &gt;&gt;&gt; net.set_jit_config(jitconfig)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;For Cell, jit config can only be set once, ignore this setting.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span> <span class="o">=</span> <span class="n">jit_config</span><span class="o">.</span><span class="n">jit_config_dict</span></div>

<div class="viewcode-block" id="Cell.flatten_weights"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.flatten_weights">[文档]</a>    <span class="k">def</span> <span class="nf">flatten_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fusion_size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset data for weight parameters so that they are using contiguous memory chunks grouped by data type.</span>

<span class="sd">        Note:</span>
<span class="sd">            By default, parameters with same data type will using a single contiguous memory chunk. but for</span>
<span class="sd">            some models with huge number of parameters, splitting a large memory chunk into several smaller</span>
<span class="sd">            memory chunks has the potential for performance gains, if this is the case, we can use &#39;fusion_size&#39;</span>
<span class="sd">            to limit the maximum memory chunk size.</span>

<span class="sd">        Args:</span>
<span class="sd">            fusion_size (int): Maximum memory chunk size in bytes, ``0`` for unlimited. Default: ``0`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fusion_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative &#39;fusion_size&#39; </span><span class="si">{</span><span class="n">fusion_size</span><span class="si">}</span><span class="s2"> is invalid.&quot;</span><span class="p">)</span>
        <span class="n">Tensor</span><span class="o">.</span><span class="n">_flatten_tensors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">fusion_size</span><span class="p">)</span>  <span class="c1"># pylint: disable=W0212</span></div>

<div class="viewcode-block" id="Cell.register_forward_pre_hook"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.register_forward_pre_hook">[文档]</a>    <span class="k">def</span> <span class="nf">register_forward_pre_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register forward pre hook function for Cell object.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The `register_forward_pre_hook(hook_fn)` does not work in graph mode or functions decorated with &#39;jit&#39;.</span>
<span class="sd">            - &#39;hook_fn&#39; must be defined as the following code.</span>
<span class="sd">              `cell_id` is the information of registered Cell object, including name and ID. `inputs` is the forward</span>
<span class="sd">              input objects passed to the Cell. The &#39;hook_fn&#39; can modify the forward input objects by returning new</span>
<span class="sd">              forward input objects.</span>
<span class="sd">            - It should have the following signature:</span>
<span class="sd">              hook_fn(cell_id, inputs) -&gt; new input objects or none.</span>
<span class="sd">            - In order to prevent running failed when switching to graph mode, it is not recommended to write it in the</span>
<span class="sd">              `construct` function of Cell object. In the pynative mode, if the `register_forward_pre_hook` function is</span>
<span class="sd">              called in the `construct` function of the Cell object, a hook function will be added at each run time of</span>
<span class="sd">              Cell object.</span>

<span class="sd">        Args:</span>
<span class="sd">            hook_fn (function): Python function. Forward pre hook function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Handle, it is an instance of `mindspore.common.hook_handle.HookHandle` and corresponding to the `hook_fn` .</span>
<span class="sd">            The handle can be used to remove the added `hook_fn` by calling `handle.remove()` .</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the `hook_fn` is not a function of python.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn, ops</span>
<span class="sd">            &gt;&gt;&gt; ms.set_context(mode=ms.PYNATIVE_MODE)</span>
<span class="sd">            &gt;&gt;&gt; def forward_pre_hook_fn(cell_id, inputs):</span>
<span class="sd">            ...     print(&quot;forward inputs: &quot;, inputs)</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.mul = nn.MatMul()</span>
<span class="sd">            ...         self.handle = self.mul.register_forward_pre_hook(forward_pre_hook_fn)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x, y):</span>
<span class="sd">            ...         x = x + x</span>
<span class="sd">            ...         x = self.mul(x, y)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; grad = ops.GradOperation(get_all=True)</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; output = grad(net)(Tensor(np.ones([1]).astype(np.float32)), Tensor(np.ones([1]).astype(np.float32)))</span>
<span class="sd">            forward inputs: (Tensor(shape=[1], dtype=Float32, value= [ 2.00000000e+00]), Tensor(shape=[1],</span>
<span class="sd">                            dtype=Float32, value= [ 1.00000000e+00]))</span>
<span class="sd">            &gt;&gt;&gt; print(output)</span>
<span class="sd">            (Tensor(shape=[1], dtype=Float32, value= [ 2.00000000e+00]), Tensor(shape=[1], dtype=Float32,</span>
<span class="sd">            value= [ 2.00000000e+00]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;register_forward_pre_hook&#39; function is only supported in pynative mode, you can use &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;context.set_context to set pynative mode.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HookHandle</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;When using &#39;register_forward_pre_hook(hook_fn)&#39;, the type of &#39;hook_fn&#39; must be python &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;function, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hook_fn</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_name</span> <span class="o">==</span> <span class="s2">&quot;staging_specialize&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorating hook function </span><span class="si">{</span><span class="n">hook_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with &#39;@jit&#39; is not supported.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_pre_hook</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_hook_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_forward_pre_hook_key&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook_key</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook_fn</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">HookHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook_key</span><span class="p">,</span> <span class="s2">&quot;_forward_pre_hook&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle</span></div>

    <span class="k">def</span> <span class="nf">_run_forward_pre_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Running forward pre hook function registered on Cell object.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: The input objects of cell object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            - **outputs** - New input objects or none.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hook</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">inputs</span>

<div class="viewcode-block" id="Cell.register_forward_hook"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.register_forward_hook">[文档]</a>    <span class="k">def</span> <span class="nf">register_forward_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Cell forward hook function.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The `register_forward_hook(hook_fn)` does not work in graph mode or functions decorated with &#39;jit&#39;.</span>
<span class="sd">            - &#39;hook_fn&#39; must be defined as the following code.</span>
<span class="sd">              `cell_id` is the information of registered Cell object, including name and ID. `inputs` is the forward</span>
<span class="sd">              input objects passed to the Cell. `output` is the forward output object of the Cell. The &#39;hook_fn&#39; can</span>
<span class="sd">              modify the forward output object by returning new forward output object.</span>
<span class="sd">            - It should have the following signature:</span>
<span class="sd">              hook_fn(cell_id, inputs, output) -&gt; new output object or none.</span>
<span class="sd">            - In order to prevent running failed when switching to graph mode, it is not recommended to write it in the</span>
<span class="sd">              `construct` function of Cell object. In the pynative mode, if the `register_forward_hook` function is</span>
<span class="sd">              called in the `construct` function of the Cell object, a hook function will be added at each run time of</span>
<span class="sd">              Cell object.</span>

<span class="sd">        Args:</span>
<span class="sd">            hook_fn (function): Python function. Forward hook function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Handle, it is an instance of `mindspore.common.hook_handle.HookHandle` and corresponding to the `hook_fn` .</span>
<span class="sd">            The handle can be used to remove the added `hook_fn` by calling `handle.remove()` .</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the `hook_fn` is not a function of python.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn, ops</span>
<span class="sd">            &gt;&gt;&gt; ms.set_context(mode=ms.PYNATIVE_MODE)</span>
<span class="sd">            &gt;&gt;&gt; def forward_hook_fn(cell_id, inputs, output):</span>
<span class="sd">            ...     print(&quot;forward inputs: &quot;, inputs)</span>
<span class="sd">            ...     print(&quot;forward output: &quot;, output)</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.mul = nn.MatMul()</span>
<span class="sd">            ...         self.handle = self.mul.register_forward_hook(forward_hook_fn)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x, y):</span>
<span class="sd">            ...         x = x + x</span>
<span class="sd">            ...         x = self.mul(x, y)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; grad = ops.GradOperation(get_all=True)</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; output = grad(net)(Tensor(np.ones([1]).astype(np.float32)), Tensor(np.ones([1]).astype(np.float32)))</span>
<span class="sd">            forward inputs: (Tensor(shape=[1], dtype=Float32, value= [ 2.00000000e+00]), Tensor(shape=[1],</span>
<span class="sd">                            dtype=Float32, value= [ 1.00000000e+00]))</span>
<span class="sd">            forward output: 2.0</span>
<span class="sd">            &gt;&gt;&gt; print(output)</span>
<span class="sd">            (Tensor(shape=[1], dtype=Float32, value= [ 2.00000000e+00]), Tensor(shape=[1], dtype=Float32,</span>
<span class="sd">            value= [ 2.00000000e+00]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;register_forward_hook&#39; function is only supported in pynative mode, you can use &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;context.set_context to set pynative mode.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HookHandle</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;When using &#39;register_forward_hook(hook_fn)&#39;, the type of &#39;hook_fn&#39; must be python &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;function, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hook_fn</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_name</span> <span class="o">==</span> <span class="s2">&quot;staging_specialize&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorating hook function </span><span class="si">{</span><span class="n">hook_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with &#39;@jit&#39; is not supported.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_forward_hook</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_pynative_executor</span><span class="o">.</span><span class="n">set_hook_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_forward_hook_key&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook_key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook_key</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hook_fn</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">HookHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook_key</span><span class="p">,</span> <span class="s2">&quot;_forward_hook&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle</span></div>

    <span class="k">def</span> <span class="nf">_run_forward_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Running forward hook function registered on Cell object.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: The input objects of Cell object.</span>
<span class="sd">            output: The output object of Cell object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            - **output** - New output object or none.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hook</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">output</span>

<div class="viewcode-block" id="Cell.register_backward_hook"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.register_backward_hook">[文档]</a>    <span class="k">def</span> <span class="nf">register_backward_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_fn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register the backward hook function.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The `register_backward_hook(hook_fn)` does not work in graph mode or functions decorated with &#39;jit&#39;.</span>
<span class="sd">            - The &#39;hook_fn&#39; must be defined as the following code.</span>
<span class="sd">              `cell_id` is the information of registered Cell object, including name and ID. `grad_input` is the</span>
<span class="sd">              gradient passed to the Cell. `grad_output` is the gradient computed and passed to the next Cell or</span>
<span class="sd">              primitive, which may be modified by returning a new output gradient.</span>
<span class="sd">            - The &#39;hook_fn&#39; should have the following signature:</span>
<span class="sd">              hook_fn(cell_id, grad_input, grad_output) -&gt; New output gradient or none.</span>
<span class="sd">            - The &#39;hook_fn&#39; is executed in the python environment. In order to prevent running failed when switching to</span>
<span class="sd">              graph mode, it is not recommended to write it in the `construct` function of Cell object. In the pynative</span>
<span class="sd">              mode, if the `register_backward_hook` function is called in the `construct` function of the Cell object,</span>
<span class="sd">              a hook function will be added at each run time of Cell object.</span>

<span class="sd">        Args:</span>
<span class="sd">            hook_fn (function): Python function. Backward hook function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Handle, it is an instance of `mindspore.common.hook_handle.HookHandle` and corresponding to the `hook_fn` .</span>
<span class="sd">            The handle can be used to remove the added `hook_fn` by calling `handle.remove()` .</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the `hook_fn` is not a function of python.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import Tensor, nn, ops</span>
<span class="sd">            &gt;&gt;&gt; ms.set_context(mode=ms.PYNATIVE_MODE)</span>
<span class="sd">            &gt;&gt;&gt; def backward_hook_fn(cell_id, grad_input, grad_output):</span>
<span class="sd">            ...     print(&quot;backward input: &quot;, grad_input)</span>
<span class="sd">            ...     print(&quot;backward output: &quot;, grad_output)</span>
<span class="sd">            ...</span>
<span class="sd">            &gt;&gt;&gt; class Net(nn.Cell):</span>
<span class="sd">            ...     def __init__(self):</span>
<span class="sd">            ...         super(Net, self).__init__()</span>
<span class="sd">            ...         self.relu = nn.ReLU()</span>
<span class="sd">            ...         self.handle = self.relu.register_backward_hook(backward_hook_fn)</span>
<span class="sd">            ...</span>
<span class="sd">            ...     def construct(self, x):</span>
<span class="sd">            ...         x = x + x</span>
<span class="sd">            ...         x = self.relu(x)</span>
<span class="sd">            ...         return x</span>
<span class="sd">            &gt;&gt;&gt; grad = ops.GradOperation(get_all=True)</span>
<span class="sd">            &gt;&gt;&gt; net = Net()</span>
<span class="sd">            &gt;&gt;&gt; output = grad(net)(Tensor(np.ones([1]).astype(np.float32)))</span>
<span class="sd">            backward input: (Tensor(shape=[1], dtype=Float32, value= [ 1.00000000e+00]),)</span>
<span class="sd">            backward output: (Tensor(shape=[1], dtype=Float32, value= [ 1.00000000e+00]),)</span>
<span class="sd">            &gt;&gt;&gt; print(output)</span>
<span class="sd">            (Tensor(shape=[1], dtype=Float32, value= [ 2.00000000e+00]),)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;register_backward_hook&#39; function is only supported in pynative mode, you can use &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;context.set_context to set pynative mode.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HookHandle</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;When using &#39;register_backward_hook(hook_fn)&#39;, the type of &#39;hook_fn&#39; must be python &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;function, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_backward_hook</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">CellBackwardHook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">backward_hook_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span><span class="o">.</span><span class="n">register_backward_hook</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">)</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">HookHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backward_hook_key</span><span class="p">,</span> <span class="s2">&quot;_cell_backward_hook&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backward_hook_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span><span class="o">.</span><span class="n">register_backward_hook</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">)</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">HookHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backward_hook_key</span><span class="p">,</span> <span class="s2">&quot;_cell_backward_hook&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle</span></div>

    <span class="k">def</span> <span class="nf">_backward_hook_construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backward hook construct method to replace original construct method.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: The input objects of Cell object.</span>
<span class="sd">            kwargs (dict): Dictionary of variable keyword parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            - **outputs** - The output objects of Cell object.</span>

<span class="sd">        Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_backward_hook</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

<div class="viewcode-block" id="Cell.set_param_ps"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_param_ps">[文档]</a>    <span class="k">def</span> <span class="nf">set_param_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_in_server</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set whether the trainable parameters are updated by parameter server and whether the</span>
<span class="sd">        trainable parameters are initialized on server.</span>

<span class="sd">        Note:</span>
<span class="sd">            It only works when a running task is in the parameter server mode.</span>
<span class="sd">            It is only supported in graph mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse (bool): Whether sets the trainable parameters of subcells. Default: ``True`` .</span>
<span class="sd">            init_in_server (bool): Whether trainable parameters updated by parameter server are</span>
<span class="sd">                initialized on server. Default: ``False`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(</span><span class="n">recurse</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">set_param_ps</span><span class="p">(</span><span class="n">init_in_server</span><span class="p">)</span></div>

    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;1.8&quot;</span><span class="p">,</span> <span class="s2">&quot;set_param_fl&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_param_fl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push_to_server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pull_from_server</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requires_aggr</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_param_fl</span><span class="p">(</span><span class="n">push_to_server</span><span class="p">,</span> <span class="n">pull_from_server</span><span class="p">,</span> <span class="n">requires_aggr</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.set_comm_fusion"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.set_comm_fusion">[文档]</a>    <span class="k">def</span> <span class="nf">set_comm_fusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fusion_type</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set `comm_fusion` for all the parameters in this cell. Please refer to the description of</span>
<span class="sd">        :class:`mindspore.Parameter.comm_fusion`.</span>

<span class="sd">        Note:</span>
<span class="sd">            The value of attribute will be overwritten when the function is called multiply.</span>

<span class="sd">        Args:</span>
<span class="sd">            fusion_type (int): The value of `comm_fusion`.</span>
<span class="sd">            recurse (bool): Whether sets the trainable parameters of subcells. Default: ``True`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Validator</span><span class="o">.</span><span class="n">check_non_negative_int</span><span class="p">(</span><span class="n">fusion_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(</span><span class="n">recurse</span><span class="p">):</span>
            <span class="n">param</span><span class="o">.</span><span class="n">comm_fusion</span> <span class="o">=</span> <span class="n">fusion_type</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_set_recompute_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;recompute_&#39;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">prefix</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>

    <span class="k">def</span> <span class="nf">_mp_comm_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mp_comm_recompute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the model parallel communication in cell recomputed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primitives</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">add_prim_attr</span><span class="p">(</span><span class="s2">&quot;recompute_comm_op&quot;</span><span class="p">,</span> <span class="n">mp_comm_recompute</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_mp_comm_recompute</span><span class="p">(</span><span class="n">mp_comm_recompute</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parallel_optimizer_comm_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallel_optimizer_comm_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the parallel optimizer communication in cell recomputed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">parallel_optimizer_comm_recompute</span> <span class="o">=</span> <span class="n">parallel_optimizer_comm_recompute</span>

    <span class="k">def</span> <span class="nf">_recompute_slice_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_activation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice the cell output which would remains in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primitives</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">add_prim_attr</span><span class="p">(</span><span class="s2">&quot;slice_activation&quot;</span><span class="p">,</span> <span class="n">slice_activation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_recompute_slice_activation</span><span class="p">(</span><span class="n">slice_activation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the cell recomputed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Validator</span><span class="o">.</span><span class="n">check_bool</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">Validator</span><span class="o">.</span><span class="n">check_bool</span><span class="p">(</span><span class="n">output_recompute</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_config_recompute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_config_recompute</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The recompute interface can be configured only once.&quot;</span>
                               <span class="s2">&quot; When the parent cell is configured, the child cell should not be configured&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_recompute_scope</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_recompute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flags</span><span class="p">(</span><span class="n">output_no_recompute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">_recompute</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.recompute"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.recompute">[文档]</a>    <span class="nd">@args_type_check</span><span class="p">(</span><span class="n">mp_comm_recompute</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">parallel_optimizer_comm_recompute</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the cell recomputed. All the primitive in the cell except the outputs will be set recomputed.</span>
<span class="sd">        If a primitive set recomputed feeds into some backward nodes for computing gradient, rather than</span>
<span class="sd">        storing the intermediate activation computed in forward pass, we will recompute it in backward pass.</span>

<span class="sd">        Note:</span>

<span class="sd">            - If the computation involves something like randomization or global variable, the equivalence</span>
<span class="sd">              is not guaranteed currently.</span>
<span class="sd">            - If the recompute api of a primitive in this cell is also called, the recompute mode of this</span>
<span class="sd">              primitive is subject to the recompute api of the primitive.</span>
<span class="sd">            - The interface can be configured only once.</span>
<span class="sd">              Therefore, when the parent cell is configured, the child cell should not be configured.</span>
<span class="sd">            - The outputs of cell are excluded from recomputation by default, which is based on our configuration</span>
<span class="sd">              experience to reduce memory footprint. If a cell has only one primitive and the primitive is wanted</span>
<span class="sd">              to be set recomputed, use the recompute api of the primtive.</span>
<span class="sd">            - When the memory remains after applying the recomputation, configuring &#39;mp_comm_recompute=False&#39;</span>
<span class="sd">              to improve performance if necessary.</span>
<span class="sd">            - When the memory still not enough after applying the recompute, configuring</span>
<span class="sd">              &#39;parallel_optimizer_comm_recompute=True&#39; to save more memory if necessary.</span>
<span class="sd">              Cells in the same fusion group should have the same parallel_optimizer_comm_recompute configures.</span>

<span class="sd">        Args:</span>
<span class="sd">            mp_comm_recompute (bool): Specifies whether the model parallel communication operators</span>
<span class="sd">                in the cell are recomputed in auto parallel or semi auto parallel mode. Default: ``True`` .</span>
<span class="sd">            parallel_optimizer_comm_recompute (bool): Specifies whether the communication operator allgathers</span>
<span class="sd">                introduced by optimizer shard are recomputed in auto parallel or semi auto parallel mode.</span>
<span class="sd">                Default: ``False`` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recompute</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;mp_comm_recompute&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mp_comm_recompute</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mp_comm_recompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;parallel_optimizer_comm_recompute&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallel_optimizer_comm_recompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;pipeline_stages&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Currently, the communication operator allgathers introduced by optimizer shard &quot;</span>
                               <span class="s2">&quot;are not support recomputation in pipeline parallel.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;pipeline_stages&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_optimizer_comm_recompute</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallel_optimizer_comm_recompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;recompute_slice_activation&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_slice_activation</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute_slice_activation&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mp_comm_recompute&#39;</span><span class="p">,</span> <span class="s1">&#39;parallel_optimizer_comm_recompute&#39;</span><span class="p">,</span> <span class="s1">&#39;recompute_slice_activation&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For &#39;recompute&#39;, keyword &#39;</span><span class="si">%s</span><span class="s2">&#39; is not recognized! &quot;</span>
                                 <span class="s2">&quot;the key kwargs must be &#39;mp_comm_recompute&#39;, &quot;</span>
                                 <span class="s2">&quot;&#39;parallel_optimizer_comm_recompute&#39;, &#39;recompute_slice_activation&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cell.infer_param_pipeline_stage"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.infer_param_pipeline_stage">[文档]</a>    <span class="k">def</span> <span class="nf">infer_param_pipeline_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer pipeline stages of all parameters in the cell.</span>

<span class="sd">        Note:</span>
<span class="sd">            - If a parameter does not belong to any cell which has been set pipeline_stage,</span>
<span class="sd">              the parameter should use add_pipeline_stage to add it&#39;s pipeline_stage information.</span>
<span class="sd">            - If a parameter P has been used by two operators in different stages &quot;stageA&quot; and &quot;stageB&quot;,</span>
<span class="sd">              the parameter P should use P.add_pipeline_stage(stageA) and P.add_pipeline_stage(stageB)</span>
<span class="sd">              to add it&#39;s stage information before using infer_param_pipeline_stage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The params belong to current stage in pipeline parallel.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If there is a parameter does not belong to any stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mindspore.parallel._utils</span> <span class="kn">import</span> <span class="n">_get_global_rank</span><span class="p">,</span> <span class="n">_get_device_num</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This interface may be deleted in the future.&quot;</span><span class="p">)</span>
        <span class="n">stage_num</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;pipeline_stages&quot;</span><span class="p">)</span>
        <span class="n">device_num</span> <span class="o">=</span> <span class="n">_get_device_num</span><span class="p">()</span>
        <span class="n">rank_id</span> <span class="o">=</span> <span class="n">_get_global_rank</span><span class="p">()</span>
        <span class="n">per_stage_devices</span> <span class="o">=</span> <span class="n">device_num</span> <span class="o">//</span> <span class="n">stage_num</span>
        <span class="n">current_stage</span> <span class="o">=</span> <span class="n">rank_id</span> <span class="o">//</span> <span class="n">per_stage_devices</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">_pipeline_stage_list</span><span class="p">:</span>  <span class="c1"># pylint: disable=W0212</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;For &#39;infer_param_pipeline_stage&#39;, the parameter </span><span class="si">{}</span><span class="s2"> does not belong to any stage, &quot;</span>
                                   <span class="s2">&quot;please check whether the cell where the param locates has been set &quot;</span>
                                   <span class="s2">&quot;&#39;pipeline_stage&#39;. Otherwise, the parameter should use &#39;add_pipeline_stage&#39; &quot;</span>
                                   <span class="s2">&quot;to add its stage information&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">current_stage</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">_pipeline_stage_list</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="Cell.place"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.Cell.html#mindspore.nn.Cell.place">[文档]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">rank_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the label for all operators in this cell.</span>
<span class="sd">        This label tells MindSpore compiler on which process this cell should be launched.</span>
<span class="sd">        And each process&#39;s identical label consists of input `role` and `rank_id`.</span>
<span class="sd">        So by setting different cells with different labels, which will be launched on different processes,</span>
<span class="sd">        users can launch a distributed training or predicting job.</span>

<span class="sd">        Note:</span>
<span class="sd">            - This method is effective only after</span>
<span class="sd">              `mindspore.communication.init()` is called for dynamic cluster building.</span>

<span class="sd">        Args:</span>
<span class="sd">            role (str): The role of the process on which this cell will be launched.</span>
<span class="sd">                        Only &#39;MS_WORKER&#39; is supported for now.</span>
<span class="sd">            rank_id (int): The rank id of the process on which this cell will be launched.</span>
<span class="sd">                           The rank is unique in processes with the same role.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindspore import context</span>
<span class="sd">            &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">            &gt;&gt;&gt; context.set_context(mode=context.GRAPH_MODE)</span>
<span class="sd">            &gt;&gt;&gt; fc = nn.Dense(2, 3)</span>
<span class="sd">            &gt;&gt;&gt; fc.place(&#39;MS_WORKER&#39;, 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prims_recursively</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">all_ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">rank_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_dynamic_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_input</span><span class="p">,</span> <span class="n">net_input</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if tensor is correctly set for dynamic shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_input (Tensor): Tensor set for dynamic shape.</span>
<span class="sd">            net_input (Tensor): Input tensor of the Cell object.</span>
<span class="sd">            index (int): Tensor index for set inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net_input</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;For &#39;set_inputs&#39; and tuple(list) in &#39;set_inputs&#39;,the type of </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input must be Tensor, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">net_input</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">is_param_set_input</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span>
        <span class="n">is_param_net_input</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net_input</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_param_set_input</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_param_net_input</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_param_net_input</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_param_set_input</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;For &#39;set_inputs&#39; and tuple(list) in &#39;set_inputs&#39;, the </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input must be the same &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;as network&#39;s input, but got &#39;set_inputs&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">set_input</span><span class="p">)</span><span class="si">}</span><span class="s2"> and network&#39;s input: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">net_input</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_input</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">net_input</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;For &#39;set_inputs&#39; and tuple(list) in &#39;set_inputs&#39;,the dtype of </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input must be the same &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;as network&#39;s input, but got &#39;set_inputs&#39;: </span><span class="si">{</span><span class="n">set_input</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> and network&#39;s input: </span><span class="si">{</span><span class="n">net_input</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_input</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">net_input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">set_input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="n">net_input</span><span class="o">.</span><span class="n">dim</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;For &#39;set_inputs&#39; and tuple(list) in &#39;set_inputs&#39;,the dims of </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input must be the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;same as network&#39;s input, but got &#39;set_inputs&#39;: </span><span class="si">{</span><span class="n">set_input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2"> and network&#39;s input: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net_input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">ele1</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ele2</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele1</span><span class="p">,</span> <span class="n">ele2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">set_input</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">net_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;For &#39;set_inputs&#39; and tuple(list) in &#39;set_inputs&#39;,the shape of </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input must be the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;same as network&#39;s input, but got &#39;set_inputs&#39;: </span><span class="si">{</span><span class="n">set_input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and network&#39;s input: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net_input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_compile_dynamic_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_inputs</span><span class="p">,</span> <span class="n">net_inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if graph has been compiled with dynamic shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            net_inputs (tuple): Inputs of the Cell object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_inputs_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">set_inputs</span><span class="p">)</span>
        <span class="n">net_inputs_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">net_inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_inputs_len</span> <span class="o">!=</span> <span class="n">net_inputs_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of &#39;set_inputs&#39; or tuple(list) in &#39;set_inputs&#39; must be equal to network&#39;s &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;inputs, but got &#39;set_inputs&#39;: </span><span class="si">{</span><span class="n">set_inputs_len</span><span class="si">}</span><span class="s2"> and network&#39;s input: </span><span class="si">{</span><span class="n">net_inputs_len</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="n">net_input</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">set_inputs</span><span class="p">,</span> <span class="n">net_inputs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_dynamic_tensor</span><span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="n">net_input</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net_input</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">th input type of &#39;set_inputs&#39; or tuple(list) in &#39;set_inputs&#39; must be tuple or &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;list, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">net_input</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_compile_dynamic_shape</span><span class="p">(</span><span class="n">set_input</span><span class="p">,</span> <span class="n">net_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mixed_precision_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">mixed_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mixed_precision_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inputs</span>
        <span class="k">if</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">FP16</span><span class="p">:</span>
            <span class="n">cast_type</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">elif</span> <span class="n">mixed_type</span> <span class="o">==</span> <span class="n">MixedPrecisionType</span><span class="o">.</span><span class="n">BF16</span><span class="p">:</span>
            <span class="n">cast_type</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">bfloat16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cast_type</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">cast_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast_mixed_precision_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">cast_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast_inputs</span>

    <span class="k">def</span> <span class="nf">_get_attr_from_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">Cell</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;jit_config_dict&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jit_config_dict</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">jit_config_dict</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;_amp_level&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_amp_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;_amp_level&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphCell"><a class="viewcode-back" href="../../../api_python/nn/mindspore.nn.GraphCell.html#mindspore.nn.GraphCell">[文档]</a><span class="k">class</span> <span class="nc">GraphCell</span><span class="p">(</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for running the graph loaded from a MindIR.</span>

<span class="sd">    This feature is still under development. Currently `GraphCell` do not support modifying the structure of the</span>
<span class="sd">    diagram, and can only use data that shape and type are the same as the input when exporting the MindIR.</span>

<span class="sd">    Args:</span>
<span class="sd">        graph (FuncGraph): A compiled graph loaded from MindIR.</span>
<span class="sd">        params_init (dict): Parameters need to be inited in the graph.</span>
<span class="sd">            The key is the parameter name whose type is str, and the value is a Tensor or Parameter.</span>
<span class="sd">            If the parameter exists in the graph according to the name, update it&#39;s value.</span>
<span class="sd">            If the parameter does not exist, ignore it. Default: ``None`` .</span>
<span class="sd">        obf_random_seed (Union[int, None]): The random seed used for dynamic obfuscation. &quot;dynamic obfuscation&quot; is</span>
<span class="sd">            used for model protection, which can refer to :func:`mindspore.obfuscate_model`. If the input `graph` is</span>
<span class="sd">            a func_graph loaded from a mindir file obfuscated with `obf_random_seed` , then `obf_random_seed` should be</span>
<span class="sd">            provided. `obf_random_seed` should be in (0, 9223372036854775807]. default: ``None`` .</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the `graph` is not a FuncGraph.</span>
<span class="sd">        TypeError: If the `params_init` is not a dict.</span>
<span class="sd">        TypeError: If the key of the `params_init` is not a str.</span>
<span class="sd">        TypeError: If the value of the `params_init` is neither a Tensor nor a Parameter.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; import mindspore.nn as nn</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import context</span>
<span class="sd">        &gt;&gt;&gt; context.set_context(mode=context.GRAPH_MODE)</span>
<span class="sd">        &gt;&gt;&gt; net = nn.Conv2d(1, 1, kernel_size=3, weight_init=&quot;ones&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = Tensor(np.ones([1, 1, 3, 3]).astype(np.float32))</span>
<span class="sd">        &gt;&gt;&gt; ms.export(net, input, file_name=&quot;net&quot;, file_format=&quot;MINDIR&quot;)</span>
<span class="sd">        &gt;&gt;&gt; graph = ms.load(&quot;net.mindir&quot;)</span>
<span class="sd">        &gt;&gt;&gt; net = nn.GraphCell(graph)</span>
<span class="sd">        &gt;&gt;&gt; output = net(input)</span>
<span class="sd">        &gt;&gt;&gt; print(output)</span>
<span class="sd">        [[[[4. 6. 4.]</span>
<span class="sd">           [6. 9. 6.]</span>
<span class="sd">           [4. 6. 4.]]]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">params_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obf_random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GraphCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">FuncGraph</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;GraphCell&#39;, the argument &#39;graph&#39; must be a FuncGraph loaded from MindIR, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obf_random_seed</span> <span class="o">=</span> <span class="n">obf_random_seed</span>
        <span class="k">if</span> <span class="n">obf_random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obf_random_seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;obf_random_seed&#39; must be int, but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obf_random_seed</span><span class="p">)))</span>
            <span class="n">int_64_max</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>
            <span class="k">if</span> <span class="n">obf_random_seed</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">obf_random_seed</span> <span class="o">&gt;</span> <span class="n">int_64_max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;obf_random_seed&#39; must be larger than 0, and less or equal than int64 (</span><span class="si">{}</span><span class="s2">),&quot;</span>
                    <span class="s2">&quot;but got </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">int_64_max</span><span class="p">,</span> <span class="n">obf_random_seed</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_branch_control_input</span> <span class="o">=</span> <span class="n">_generate_branch_control_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obf_random_seed</span><span class="p">)</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">params_init</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_init</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For &#39;GraphCell&#39;, the argument &#39;params_init&#39; must be a dict, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">params_init</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params_init</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;For &#39;GraphCell&#39;, the key of the &#39;params_init&#39; must be str, &quot;</span>
                                <span class="s2">&quot;and the value must be Tensor or Parameter, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;but got the key type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">, and the value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">params_dict</span> <span class="o">=</span> <span class="n">update_func_graph_hyper_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">params_init</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;graph_load_from_mindir&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attr</span><span class="p">(</span><span class="s2">&quot;graph_load_from_mindir&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obf_random_seed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_and_run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">append_input</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_control_input</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_and_run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">append_input</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_check_param_list_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the type of input in list or tuple is Parameter.</span>
<span class="sd">    :param value: list or tuple.</span>
<span class="sd">    :return: The types of all inputs are parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>