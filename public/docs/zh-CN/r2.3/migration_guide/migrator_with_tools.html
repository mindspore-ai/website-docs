<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>网络迁移工具应用实践指南 &mdash; MindSpore master 文档</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script src="../_static/js/mermaid-9.3.0.js"></script><script src="../_static/translations.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">设计</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../design/overview.html">MindSpore设计概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/tensor_view.html">张量视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/programming_paradigm.html">函数式和对象式融合编程范式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/dynamic_graph_and_static_graph.html">动静态图结合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/distributed_training_design.html">分布式并行原生</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/data_engine.html">高性能数据处理引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/all_scenarios.html">全场景统一架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/graph_fusion_engine.html">图算融合加速引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/pluggable_device.html">三方硬件对接</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/glossary.html">术语</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型库</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/official_models.html">官方模型库</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.html">mindspore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.html">mindspore.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.html">mindspore.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.extend.html">mindspore.ops.extend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.ops.primitive.html">mindspore.ops.primitive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.amp.html">mindspore.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.train.html">mindspore.train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.communication.html">mindspore.communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.common.initializer.html">mindspore.common.initializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.hal.html">mindspore.hal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.html">mindspore.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.dataset.transforms.html">mindspore.dataset.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.mindrecord.html">mindspore.mindrecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.nn.probability.html">mindspore.nn.probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.rewrite.html">mindspore.rewrite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.multiprocessing.html">mindspore.multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.boost.html">mindspore.boost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.numpy.html">mindspore.numpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.scipy.html">mindspore.scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_python/mindspore.experimental.html">mindspore.experimental</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API映射</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/api_mapping/pytorch_api_mapping.html">PyTorch与MindSpore API映射表</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">迁移指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">迁移指南概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="enveriment_preparation.html">环境准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis_and_preparation.html">模型分析与准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_development/model_development.html">网络搭建对比</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_and_tune.html">调试调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample_code.html">网络迁移调试实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语法支持</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax_support.html">静态图语法支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/operators.html">静态图语法-运算符</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/statements.html">静态图语法-Python语句</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/static_graph_syntax/python_builtin_functions.html">静态图语法-Python内置函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../note/index_support.html">Tensor索引支持</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">环境变量</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../note/env_var_list.html">环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/data_processing.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/implement_problem.html">执行问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/network_compilation.html">网络编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/operators_compile.html">算子编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/performance_tuning.html">性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/precision_tuning.html">精度调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/distributed_parallel.html">分布式并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/inference.html">推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/feature_advice.html">特性咨询</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>网络迁移工具应用实践指南</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/migration_guide/migrator_with_tools.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="网络迁移工具应用实践指南">
<h1>网络迁移工具应用实践指南<a class="headerlink" href="#网络迁移工具应用实践指南" title="永久链接至标题"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.3/docs/mindspore/source_zh_cn/migration_guide/migrator_with_tools.md"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.3/resource/_static/logo_source.svg" /></a></p>
<section id="概述">
<h2>概述<a class="headerlink" href="#概述" title="永久链接至标题"></a></h2>
<p>本指导介绍了将神经网络从其他机器学习框架迁移到MindSpore过程时，如何应用各种迁移相关工具以提高迁移效率，侧重描述如何将迁移工具与迁移过程紧密结合。</p>
</section>
<section id="网络迁移路径相关工具说明">
<h2>网络迁移路径相关工具说明<a class="headerlink" href="#网络迁移路径相关工具说明" title="永久链接至标题"></a></h2>
<section id="迁移路径工具地图">
<h3>迁移路径工具地图<a class="headerlink" href="#迁移路径工具地图" title="永久链接至标题"></a></h3>
<p><img alt="map" src="../_images/map.png" /></p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>工具</p></th>
<th class="head"><p>工具说明</p></th>
<th class="head"><p>网络迁移用途</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://www.mindspore.cn/devtoolkit/docs/zh-CN/master/index.html">MindSpore Dev Toolkit</a></p></td>
<td><p>MindSpore Dev Toolkit是一款支持MindSpore开发的多平台Python IDE插件，提供创建项目、智能补全、API互搜和文档搜索等功能。</p></td>
<td><p>通过API扫描等能力，能够提升用户的网络迁移开发效率。</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://gitee.com/mindspore/toolkits/tree/master/troubleshooter">TroubleShooter</a></p></td>
<td><p>TroubleShooter 是MindSpore网络开发调试工具包，用于提供便捷、易用的调试能力。</p></td>
<td><p>网络调试工具集（如：网络权重迁移、精度比对、代码跟踪、报错分析、执行跟踪等功能），帮助用户提高迁移调试效率。</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/master/performance_profiling.html">Profiler</a></p></td>
<td><p>Profiler可将训练过程中的算子耗时等信息记录到文件中，通过可视化界面供用户查看分析，帮助用户更高效地调试神经网络性能。</p></td>
<td><p>网络迁移后，如果执行性能不佳，可用Profiler进行性能分析，Profiler提供框架的host执行、以及算子执行的Profiler分析功能。</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/r2.3/debug/dump.html">Dump</a></p></td>
<td><p>提供了Dump功能，用来将模型训练中的图以及算子的输入输出数据保存到磁盘文件。</p></td>
<td><p>一般用于网络迁移复杂问题定位（例如：算子溢出等）可以dump出算子级别的数据。</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="网络迁移工具应用实例">
<h2>网络迁移工具应用实例<a class="headerlink" href="#网络迁移工具应用实例" title="永久链接至标题"></a></h2>
<p>本章节以一张网络（Vision Transformer）为例子完成网络迁移，并介绍关键迁移过程中各种工具的应用方法。</p>
<p>注：迁移网络的完整样例代码可参考如下链接</p>
<p><a class="reference external" href="https://github.com/WZMIAOMIAO/deep-learning-for-image-processing/tree/master/pytorch_classification/vision_transformer">https://github.com/WZMIAOMIAO/deep-learning-for-image-processing/tree/master/pytorch_classification/vision_transformer</a></p>
<section id="网络迁移开发">
<h3>网络迁移开发<a class="headerlink" href="#网络迁移开发" title="永久链接至标题"></a></h3>
<p><a class="reference external" href="https://www.mindspore.cn/devtoolkit/docs/zh-CN/master/index.html">MindSpore Dev Toolkit</a>的API扫描功能，扫描到PyTorch网络中的API与MindSpore API的映射关系，有差异的API可以打开“说明”的URL，会给出API详细分析，帮助用户快速构建MindSpore的网络代码。</p>
<p><img alt="img" src="../_images/api_scan.jpg" /></p>
<p>例如：<code class="docutils literal notranslate"><span class="pre">torch.cat</span></code>接口：</p>
<p>在“说明”的URL（PyTorch与MindSpore API映射表）中可见如下API差异。</p>
<p><img alt="img" src="../_images/api_diff.jpg" /></p>
<p>按照规则，可参考如下PyTorch代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [B, 197, 768]</span>
</pre></div>
</div>
<p>写出MindSpore代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cls_token</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [B, 197, 768]</span>
</pre></div>
</div>
</section>
<section id="网络结构初始验证">
<h3>网络结构初始验证<a class="headerlink" href="#网络结构初始验证" title="永久链接至标题"></a></h3>
<p>在网络初步迁移构建完成后，我们可以先进行一些网络结构的基础比对，以验证迁移的网络结构是否正确。可以分别使用如下两种方式进行网络结构的比对：</p>
<p><strong>步骤1：获取PyTorch ViT网络结构和权重参数(pth)</strong></p>
<p>调用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/save_net_and_weight_params.md#">ts.migrator.save_net_and_weight_params</a>接口，可以将网络对象保存成文件（与用print打印model对象的内容相同，这里model是一个nn.Module对象），并且会保存权重参数到pth文件以及映射文件（用于与MindSpore进行权重比对）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">net_pt_vit</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>在配置的path下，可以找到如下文件。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-rw-r--r-- 1 root root      8709 Jul  5 20:36 torch_net_architecture.txt （网络结构信息，与用python print打印model对象的内容相同）
-rw-r--r-- 1 root root      7737 Jul  5 20:36 torch_net_map.json  （参数映射文件，用于与MindSpore进行权重比对）
-rw-r--r-- 1 root root 343261393 Jul  5 20:36 torch_troubleshooter_create.pth （权重参数）
</pre></div>
</div>
<p><strong>步骤2：获取MindSpore ViT网络结构和权重参数(ckpt)</strong></p>
<p>调用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/save_net_and_weight_params.md#">ts.migrator.save_net_and_weight_params</a>接口，可以将网络对象保存成文件（与用print打印model对象的内容相同，这里model是一个Cell对象），并且会保存权重参数到ckpt文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">net_ms_vit</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms_net_info/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>在配置的path下，可以找到如下文件。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-r-------- 1 root root 343217199 Jul  5 20:26 mindspore_troubleshooter_create.ckpt    （权重参数）
-rw-r--r-- 1 root root     14013 Jul  5 20:26 mindspore_net_architecture.txt  （网络结构信息，与用python print打印model对象的内容相同）
</pre></div>
</div>
<p><img alt="" src="../_images/image2.png" /></p>
<p><strong>步骤3：通过net_architecture.txt比对网络基础结构</strong></p>
<p>通过Beyond Compare等工具可以快速对比网络结构（即mindspore_net_architecture.txt与torch_net_architecture.txt），如下可初步判断网络结构层级基本是对齐的，存在一些天然的API以及参数差异，例如：Dense和Linear属于正常范围。</p>
<p><img alt="" src="../_images/image3.png" /></p>
<p><strong>步骤4：再通过对比权重参数进一步比对网络结构</strong></p>
<p>用我们步骤1和2保存的文件，通过TroubleShooter的<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_pth_and_ckpt.md#">ts.migrator.compare_pth_and_ckpt</a>接口，可以完成pth与ckpt的权重参数结构比较，以进一步验证网络结构是否正确。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># weight_map_path 为步骤1导出的参数映射文件，compare_value=False代表只比对数量和shape信息，不比对参数值</span>
<span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">compare_pth_and_ckpt</span><span class="p">(</span>
    <span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
    <span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_troubleshooter_create.pth&quot;</span><span class="p">,</span>
    <span class="n">ms_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms_net_info/mindspore_troubleshooter_create.ckpt&quot;</span><span class="p">,</span>
    <span class="n">compare_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="../_images/image4.png" /></p>
</section>
<section id="网络正向结果验证">
<h3>网络正向结果验证<a class="headerlink" href="#网络正向结果验证" title="永久链接至标题"></a></h3>
<p>在迁移的MindSpore网络可以正常执行后，即可进行网络正向结果验证，验证是通过比对PyTorch和MindSpore网络正向结果来完成的。这里提供了两种不同的验证方案，一种是半自动验证方案，一种是全自动验证方案，我们将分别介绍两种方案适用场景和使用方法。</p>
<section id="网络比对三个基本条件">
<h4>网络比对三个基本条件<a class="headerlink" href="#网络比对三个基本条件" title="永久链接至标题"></a></h4>
<blockquote>
<div><p>说明：此处只做简单说明，详细步骤可参考半自动验证方案的例子</p>
</div></blockquote>
<p>要进行PyTorch和MindSpore网络比对前，需要满足三个条件：</p>
<ol class="arabic">
<li><p>随机性固定并相同</p>
<p>可以在PyTorch和MindSpore使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/widget/fix_random.md#">ts.migrator.fix_random</a>来固定随机性，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">fix_random</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>输入数据样本一致</p>
<p>参考如下两步，可以用来保存和加载相同的数据样本（包含：数据和标签都可用此方法）。</p>
<ul>
<li><p>步骤1：使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>保存PyTorch网络的某个数据样本为npy，<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>会自动编号为<code class="docutils literal notranslate"><span class="pre">0_images.npy</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt/npy/images.npy&quot;</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>步骤2：再使用<code class="docutils literal notranslate"><span class="pre">np.load</span></code>将这个数据分别加载成PyTorch的Tenosr和MindSpore的Tensor</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/0_images.npy&#39;</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/0_images.npy&#39;</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>初始化权重参数一致</p>
<p>一般我们会以PyTorch网络的权重为基准，转换为MindSpore的权重并加载，来实现统一的初始化权重参数，参考如下两步。</p>
<ul>
<li><p>步骤1：保存PyTorch网络权重和转换映射，用于在MindSpore加载。</p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/save_net_and_weight_params.md#">ts.migrator.save_net_and_weight_params</a>接口，保存PyTorch网络权重和转换映射。
例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>步骤2：在MindSpore网络转换并加载权重。</p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/convert_weight_and_load.md#">ts.migrator.convert_weight_and_load</a>接口转换PyTorch权重，并加载到MindSpore的网络中。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">convert_weight_and_load</span><span class="p">(</span><span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
<span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_troubleshooter_create.pth&quot;</span><span class="p">,</span><span class="n">net</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="半自动验证方案">
<h4>半自动验证方案<a class="headerlink" href="#半自动验证方案" title="永久链接至标题"></a></h4>
<p>在满足比对的三个前提条件基础上，半自动验证方案通过手工指定要保存的数据，并进行批量比对完成正向结果的验证。半自动方案优点是场景适用性强，缺点是需要较多手工操作。</p>
<p><strong>步骤1：执行PyTorch网络并获取正向结果</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_pt_net</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># 1）固定随机性，调用ts.widget.fix_random接口固定PyTorch的随机性</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">fix_random</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># 2）加载相同数据样本（样本可以用numpy.save在PyTorch网络执行时保持一个.npy格式的数据。）</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/0_images.npy&#39;</span><span class="p">))</span>
    <span class="c1"># 3）保存权重和转换映射，用于在MindSpore加载</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/&quot;</span><span class="p">)</span>
    <span class="c1"># 4）执行网络并保存正向结果，使用ts.save接口保存网络执行结果</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt/npy/pred.npy&quot;</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>步骤2：执行MindSpore网络获取正向结果</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_ms_net</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># 1）固定随机性，与步骤1相同，调用相同接口 ts.widget.fix_random(16)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">fix_random</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1"># 2）加载相同数据样本</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/0_images.npy&#39;</span><span class="p">))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 3）加载pt导出的权重，保证初始化权重参数一致</span>
    <span class="c1"># 调用ts.migrator.convert_weight_and_load接口，将PyTorch权重参数转为MindSpore权重参数并加载到MindSpore网络中</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">convert_weight_and_load</span><span class="p">(</span><span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
                                        <span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_troubleshooter_create.pth&quot;</span><span class="p">,</span>
                                        <span class="n">net</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># 4）执行网络并保存正向结果</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms/npy/pred.npy&quot;</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>步骤3：进行比较并查看比对结果</strong></p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_npy_dir.md#">ts.migrator.compare_npy_dir</a>接口，进行正向结果比较。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5）比较PyTorch与MindSpore的正向输出结果，调用ts.migrator.compare_npy_dir接口完成保存的正向结果比较</span>
<span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">compare_npy_dir</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/pt/npy&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;/mindspore_model/vit/v1/temp_data/ms/npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>可见如下比对结果，正向网络结果通过allclose和余弦相似度比较，都可以正常对齐，证明结果完全相同。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The orig dir: /mnt/sdb2/mindspore_model/vit/v1/temp_data/pt/npy
The target dir: /mnt/sdb2/mindspore_model/vit/v1/temp_data/ms/npy
</pre></div>
</div>
<p><img alt="" src="../_images/image6.png" /></p>
</section>
<section id="全自动验证方案">
<h4>全自动验证方案<a class="headerlink" href="#全自动验证方案" title="永久链接至标题"></a></h4>
<p>全自动验证方案适用于验证推理网络或网络正向结果等迁移场景，与半自动方案的差别在于由工具自动完成各种对比前的条件对齐，用户只需要传入网络对象即可，相对于半自动方案更为简单，基本可实现一键式比对，但一些复杂场景使用可能受限，例如：PyTorch网络和MindSpore网络不方便跑在同一机器上。全自动验证方案不能支持的场景，请参考半自动验证方案章节。</p>
<p><strong>步骤1：导入PyTorch模型对象，完成网络正向自动比对</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">auto_run_ms_net</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># 1）导入pytoch脚本路径，并import pytorch的model，用于创建PyTorch模型对象</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;/mindspore_model/vit/v1/pytorch_org&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">pytorch_org.vision_transformer.vit_model</span> <span class="kn">import</span> <span class="n">vit_base_patch16_224_in21k</span> <span class="k">as</span> <span class="n">create_pt_model</span>
    <span class="c1"># 2）分别创建MindSpore的model对象和PyTorch的model对象，用于传入自动比对接口</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pt_model</span> <span class="o">=</span> <span class="n">create_pt_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 3）创建正向自动比对对象，并执行比对</span>
    <span class="n">diff_finder</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">NetDifferenceFinder</span><span class="p">(</span><span class="n">pt_net</span><span class="o">=</span><span class="n">pt_model</span><span class="p">,</span>
                                                  <span class="n">ms_net</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># auto_inputs参数，可自动按照shape生成数据样本，compare将自动对齐权重、固定随机性。</span>
    <span class="n">diff_finder</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">auto_inputs</span><span class="o">=</span><span class="p">(((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),))</span>
</pre></div>
</div>
<p><strong>步骤2：查看比对结果</strong></p>
<p>接口运行后会打印一些执行过程的日志，最后会打印网络正向输出的比对结果。</p>
<p><img alt="" src="../_images/image5.png" /></p>
<blockquote>
<div><p>说明：当结果不一致的时候，可通过<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>接口，二分或逐层导出网络各层API的输出，并通过<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_npy_dir.md#">ts.migrator.compare_npy_dir</a>接口批量比对，来定位到问题引入的API。</p>
</div></blockquote>
</section>
</section>
<section id="网络loss结果验证">
<h3>网络loss结果验证<a class="headerlink" href="#网络loss结果验证" title="永久链接至标题"></a></h3>
<p>loss的验证方案，与正向结果的半自动验证方案类似，在满足比对的三个前提条件基础上，通过手工指定要保存的loss并使用ts.save接口进行保存，并使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_npy_dir.md#">ts.migrator.compare_npy_dir</a>进行批量比对完成loss的结果验证，具体步骤参考正向结果的半自动验证方案即可。</p>
</section>
<section id="反向结果验证含梯度权重参数的比对">
<h3>反向结果验证(含梯度、权重参数的比对)<a class="headerlink" href="#反向结果验证含梯度权重参数的比对" title="永久链接至标题"></a></h3>
<p>梯度的比对验证方案，思路也与正向结果的半自动验证方案类似，但调用方式略有不同，参考如下步骤操作。</p>
<p><strong>步骤1：保存PyTorch网络训练各阶段的输出</strong></p>
<p>与正向结果的半自动验证方案类似，我们可以用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>接口进行训练各阶段关键数据的保存，例如：正向输出、loss、grads、权重参数等。参考下方例子，会对每个关键数据保存进行说明。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_one_step</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># 1）固定随机性</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">fix_random</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1"># 2）训练网络的创建流程</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">loss_function</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">5E-5</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="c1"># 3）统一数据样本和标签</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/&#39;</span>
                                  <span class="s1">&#39;pytorch_org/vision_transformer/1_None.npy&#39;</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/&#39;</span>
                                  <span class="s1">&#39;pytorch_org/vision_transformer/0_None.npy&#39;</span><span class="p">))</span>
    <span class="c1"># 4）保存权重和转换映射，用于在MindSpore加载</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/&quot;</span><span class="p">)</span>
    <span class="c1"># 5）执行训练过程</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="c1"># 6）保存梯度</span>
    <span class="c1"># ts.widget.get_pt_grads 接口封装了PyTorch保存grads的方法，可直接调用此接口并使用ts.save保存</span>
    <span class="c1"># 因为梯度是一个Tensor list所以ts.save保存梯度会保存多个文件并自动编号，建议单独建立目录保存梯度列表</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt/grads/grads.npy&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_pt_grads</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="c1"># 7) 保存权重参数pth，设置weight_params_filename名称，不使用默认值避免覆盖初始化的权重</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">save_net_and_weight_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/&quot;</span><span class="p">,</span>
                                           <span class="n">weight_params_filename</span><span class="o">=</span><span class="s1">&#39;result_pt.pth&#39;</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>步骤2：保存MindSpore网络训练各阶段的输出</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_one_step_ms</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># 1）固定随机性</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">fix_random</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1"># 2）训练网络的创建流程</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">5E-5</span><span class="p">)</span>
    <span class="n">loss_function</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">forward_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span>
    <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 3）加载pt导出的权重，保证初始化权重参数一致</span>
    <span class="c1"># 调用ts.migrator.convert_weight_and_load接口，将PyTorch权重参数转为MindSpore权重参数并加载到MindSpore网络中</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">convert_weight_and_load</span><span class="p">(</span><span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
                                        <span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_troubleshooter_create.pth&quot;</span><span class="p">,</span>
                                        <span class="n">net</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># 4）加载与PT相同的数据样本和标签</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/1_None.npy&#39;</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/pytorch_org/vision_transformer/0_None.npy&#39;</span><span class="p">))</span>
    <span class="c1"># 5）执行训练过程</span>
    <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">pred</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="c1"># 6）保存梯度</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms/grads/grads.npy&quot;</span><span class="p">,</span> <span class="n">grads</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
    <span class="c1"># 7）保存权重参数pth</span>
    <span class="n">mindspore</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms/ms_result.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>步骤3：比较梯度</strong></p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_grads_dir.md#">ts.migrator.compare_grads_dir</a>接口，进行梯度比较。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">compare_grads_dir</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/pt/grads&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;/mindspore_model/vit/v1/temp_data/ms/grads&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行结果：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The orig dir: /mindspore_model/vit/v1/temp_data/pt/grads
The target dir: /mindspore_model/vit/v1/temp_data/ms/grads
</pre></div>
</div>
<p><img alt="" src="../_images/image8.png" /></p>
<p><strong>步骤4：比较权重参数</strong></p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_pth_and_ckpt.md#">ts.migrator.compare_pth_and_ckpt</a>接口，进行权重参数比对。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">compare_pth_and_ckpt</span><span class="p">(</span><span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
                                 <span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/result_pt.pth&quot;</span><span class="p">,</span>
                                 <span class="n">ms_file_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/ms/ms_result.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>获取到权重参数shape的比较结果。</p>
<p><img alt="" src="../_images/image9.png" /></p>
<p>获取到权重参数数值的比较结果。</p>
<p><img alt="" src="../_images/image10.png" /></p>
<blockquote>
<div><p>说明：如果比对结果不一致，可以往前回溯到梯度是否一致，如果梯度一致，则可以检查优化器使用是否正确，可参考网络逐层差异点排查章节，逐层进行问题定界排查。</p>
</div></blockquote>
</section>
<section id="其他">
<h3>其他<a class="headerlink" href="#其他" title="永久链接至标题"></a></h3>
<section id="网络逐层差异点排查">
<h4>网络逐层差异点排查<a class="headerlink" href="#网络逐层差异点排查" title="永久链接至标题"></a></h4>
<p>在比较网络正向结果或者loss不一致时，我们需要定位问题原因，则可采取二分或者逐层保存API输出并进行数据比对的方式来排查差异引入点。此比对也需要满足比对的三个基本条件。</p>
<p><strong>步骤1：保存PyTorch的网络部分API输出</strong></p>
<p>在网络中，使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>保存API的输出，用于排查网络差异引入点。</p>
<blockquote>
<div><p>说明：<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>支持保存Tensor（包括mindspore.Tensor和torch.tensor），以及Tensor构成的list/tuple/dict。当为list/tuple类型时，会按照顺序添加编号；当为dict类型时，文件名中会添加key，详细参考<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">troubleshooter.save</a>。</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mlp</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MLP as used in Vision Transformer, MLP-Mixer and related networks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">hidden_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span> <span class="ow">or</span> <span class="n">in_features</span>
        <span class="n">hidden_features</span> <span class="o">=</span> <span class="n">hidden_features</span> <span class="ow">or</span> <span class="n">in_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">hidden_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">act_layer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 保存self.fc1 即nn.Linear的输出</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/pt/npy/fc1.npy&#39;</span><span class="p">,</span>  <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 保存self.fc2 即nn.Linear的输出</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/pt/npy/fc2.npy&#39;</span><span class="p">,</span>  <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p><strong>步骤2：保存MindSpore的网络部分API输出</strong></p>
<p>在网络中，使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/save.md#">ts.save</a>保存API的输出，用于排查网络差异引入点。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mlp</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">hidden_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span> <span class="ow">or</span> <span class="n">in_features</span>
        <span class="n">hidden_features</span> <span class="o">=</span> <span class="n">hidden_features</span> <span class="ow">or</span> <span class="n">in_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">hidden_features</span><span class="p">)</span>
        <span class="c1">#self.act = act_layer(approximate=False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">hidden_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 保存self.fc1 即nn.Dense的输出</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/ms/npy/fc1.npy&#39;</span><span class="p">,</span>  <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 保存self.fc2 即nn.Dense的输出</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/ms/npy/fc2.npy&#39;</span><span class="p">,</span>  <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p><strong>步骤3：比对API输出结果，查找差异点</strong></p>
<p>使用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/compare_npy_dir.md#">ts.migrator.compare_npy_dir</a>接口对各层保存的数据进行比对，可以通过比对结果判定哪里引入了差异，以进行问题定位。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">compare_npy_dir</span><span class="p">(</span><span class="s1">&#39;/mindspore_model/vit/v1/temp_data/pt/npy&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;/mindspore_model/vit/v1/temp_data/ms/npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="../_images/image7.png" /></p>
</section>
<section id="网络权重迁移">
<h4>网络权重迁移<a class="headerlink" href="#网络权重迁移" title="永久链接至标题"></a></h4>
<p>在迁移推理网络或微调网络训练等场景中，通常需要将PyTorch的权重迁移到MindSpore中。此时可以使用TroubleShooter的权重迁移工具，先调用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/get_weight_map.md#">ts.migrator.get_weight_map</a>获取权重映射的json文件，再调用<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/api/migrator/convert_weight.md#">ts.migrator.convert_weight</a>完成权重自动化迁移，以下为基本样例。需要添加前缀、自定义映射等复杂场景可参考<a class="reference external" href="https://gitee.com/mindspore/toolkits/blob/master/troubleshooter/docs/migrator.md#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF1pth%E5%88%B0ckpt%E6%9D%83%E9%87%8D%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">TroubleShooter pth到ckpt权重自动转换</a>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">troubleshooter</span> <span class="k">as</span> <span class="nn">ts</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="c1"># 1）创建Torch网络</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">has_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># 2）通过Torch网络，获取权重映射json文件</span>
<span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">get_weight_map</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">weight_map_save_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">)</span>

<span class="c1"># 3）使用2）得到的权重映射json文件，进行权重转换</span>
<span class="n">ts</span><span class="o">.</span><span class="n">migrator</span><span class="o">.</span><span class="n">convert_weight</span><span class="p">(</span><span class="n">weight_map_path</span><span class="o">=</span><span class="s2">&quot;/mindspore_model/vit/v1/temp_data/pt_net_info/torch_net_map.json&quot;</span><span class="p">,</span>
                           <span class="n">pt_file_path</span><span class="o">=</span><span class="s2">&quot;/torch_model/vit/v1/torch_net.pth&quot;</span><span class="p">,</span>
                           <span class="n">ms_file_save_path</span><span class="o">=</span><span class="s1">&#39;/mindspore_model/vit/v1/ms_net.ckpt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>执行<code class="docutils literal notranslate"><span class="pre">convert_weight</span></code>时会打印权重转换过程中的详细信息，包括名称、转换详情、参数的shape等信息，如下图所示。</p>
<p><img alt="" src="../_images/image11.png" /></p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>