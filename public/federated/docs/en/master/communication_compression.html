

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Device-Cloud Federated Learning Communication Compression &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vertical Federated Learning Communication Compression" href="vfl_communication_compress.html" />
    <link rel="prev" title="Vertical Federated - Label Protection Based on Differential Privacy" href="secure_vertical_federated_learning_with_DP.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Horizontal Federated Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">Horizontal Federated Device-side Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">Vertical Federated Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Horizontal Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="image_classfication_dataset_process.html">Federated Learning Image Classification Dataset Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">Implementing a Cloud-Slio Federated Image Classification Application (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_detection_application_in_cross_silo.html">Implementing a Cross-Silo Federated Target Detection Application (x86)</a></li>
</ul>
<p class="caption"><span class="caption-text">Vertical Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_join.html">Vertical Federated Learning Data Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_wnd_application.html">Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_pangu_alpha_application.html">Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training</a></li>
</ul>
<p class="caption"><span class="caption-text">Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">Horizontal FL-Local Differential Privacy Perturbation Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">Horizontal FL-Local Differential Privacy SignDS training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_eval_laplace.html">Horizontal Federated-Local Differential Privacy Inference Result Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">Horizontal FL-Pairwise encryption training</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">Vertical Federated-Privacy Set Intersection</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">Vertical Federated-Feature Protection Based on Information Obfuscation</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">Vertical Federated - Feature Protection Based on Trusted Execution Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">Vertical Federated - Label Protection Based on Differential Privacy</a></li>
</ul>
<p class="caption"><span class="caption-text">Communication Compression</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Device-Cloud Federated Learning Communication Compression</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#compression-method">Compression Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#upload-compression-method">Upload Compression Method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#weight-difference-codec">Weight Difference Codec</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sparse-codec">Sparse Codec</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quantization-codec">Quantization Codec</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#download-compression-method">Download Compression Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quantization-codec-1">Quantization Codec</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code-implementation-preparation">Code Implementation Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-open-script">Algorithm Open Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="#albert-results">ALBERT Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">Vertical Federated Learning Communication Compression</a></li>
</ul>
<p class="caption"><span class="caption-text">Horizontal Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">Federated Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">Device-side Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">Cross-Silo</a></li>
</ul>
<p class="caption"><span class="caption-text">Vertical Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">Data Join</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">Vertical Federated Learning Communicator</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">Vertical Federated Trainer</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Device-Cloud Federated Learning Communication Compression</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/communication_compression.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="device-cloud-federated-learning-communication-compression">
<h1>Device-Cloud Federated Learning Communication Compression<a class="headerlink" href="#device-cloud-federated-learning-communication-compression" title="Permalink to this headline">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/master/docs/federated/docs/source_en/communication_compression.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.png"></a></p>
<p>During the horizontal device-side federated learning training process, the traffic volume affects the user experience of the device-side (user traffic, communication latency, number of FL-Client participants) and is limited by the cloud-side performance constraints (memory, bandwidth, CPU usage). To improve user experience and reduce performance bottlenecks, MindSpore federated learning framework provides traffic compression for upload and download in device-cloud federated scenarios.</p>
<div class="section" id="compression-method">
<h2>Compression Method<a class="headerlink" href="#compression-method" title="Permalink to this headline">¶</a></h2>
<div class="section" id="upload-compression-method">
<h3>Upload Compression Method<a class="headerlink" href="#upload-compression-method" title="Permalink to this headline">¶</a></h3>
<p>The upload compression method can be divided into three main parts: weight difference codec, sparse codec and quantization codec. The flowcharts on FL-Client and FL-Server are given below.</p>
<p><img alt="Upload compression client execution order" src="_images/upload_compression_client_en.png" /></p>
<p>Fig.1 Flowchart of the upload compression method on FL-Client</p>
<p><img alt="Upload compression server execution order" src="_images/upload_compress_server_en.png" /></p>
<p>Fig.2 Flowchart of the upload compression method on FL-Server</p>
</div>
<div class="section" id="weight-difference-codec">
<h3>Weight Difference Codec<a class="headerlink" href="#weight-difference-codec" title="Permalink to this headline">¶</a></h3>
<p>The weight difference is the vector difference of the weight matrix before and after the device-side training. Compared with the original weights, the distribution of the weight difference is more in line with the Gaussian distribution and therefore more suitable to be compressed. FL-Client performs the encoding operation on the weight difference, while FL-Server performs the decoding operation. Note that in order to reduce the weight difference to weights before FL-Server aggregates the weights, FL-Client does not multiply the weights by the amount of data when uploading the weights. When FL-Server decodes, it needs to multiply the weights by the amount of data.</p>
<p><img alt="Weight difference encoding" src="_images/weight_diff_encode_en.png" /></p>
<p>Fig.3 Flow chart of weight difference encoding on FL-Client</p>
<p><img alt="Weight difference decoding" src="_images/weight_diff_decode_en.png" /></p>
<p>Fig.4 Flow chart of weight difference decoding on FL-Server</p>
</div>
<div class="section" id="sparse-codec">
<h3>Sparse Codec<a class="headerlink" href="#sparse-codec" title="Permalink to this headline">¶</a></h3>
<p>The device-side and cloud-side follow the same random algorithm to generate a sparse mask matrix that has the same shape as the original weights that need to be uploaded. The mask matrix contains only two values, 0 or 1. Each FL-Client only uploads data with the same weight as the non-zero value position of the mask matrix to the FL-Server.</p>
<p>Take the sparse method with a sparse rate of sparse_rate=0.08 as an example. The parameters that are required to be uploaded by FL-Client:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Parameters</th>
<th>Length</th>
</tr>
</thead>
<tbody>
<tr>
<td>albert.pooler.weight</td>
<td>97344</td>
</tr>
<tr>
<td>albert.pooler.bias</td>
<td>312</td>
</tr>
<tr>
<td>classifier.weight</td>
<td>1560</td>
</tr>
<tr>
<td>classifier.bias</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>Concatenate all parameters as one-dimensional vectors:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Parameters</th>
<th>Length</th>
</tr>
</thead>
<tbody>
<tr>
<td>merged_data</td>
<td>97344+312+1560+5=99221</td>
</tr>
</tbody>
</table>
<p>Generate a mask vector with the same length as the concatenated parameter. There are 7937 values of 1, i.e., 7937 = int(sparse_rate*concatenated parameter length) and the rest have a value of 0, i.e., mask_vector = (1,1,1,… ,0,0,0,…):</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Parameters</th>
<th>Length</th>
</tr>
</thead>
<tbody>
<tr>
<td>mask_vector</td>
<td>99221</td>
</tr>
</tbody>
</table>
<p>Use a pseudo-random algorithm to randomize the mask_vector. The random seed is the current number of iteration. Take out the indexes in the mask_vector with value 1. Take out the value of merged_data[indexes], i.e. the compressed vector.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Parameters</th>
<th>Length</th>
</tr>
</thead>
<tbody>
<tr>
<td>compressed_vector</td>
<td>7937</td>
</tr>
</tbody>
</table>
<p>After sparse compression, the parameter that FL-Client needs to upload is the compressed_vector.</p>
<p>After receiving the compressed_vector, FL-Server first constructs the mask vector mask_vector with the same pseudo-random algorithm and random seeds as FL-Client. Then it takes out the indexes with the value of 1 in the mask_vector. Generate the all-zero matrix with the same shape as the model. The values in compressed_vector are put into weight_vector[indexes] in turn. weight_vector is the sparsely decoded vector.</p>
</div>
<div class="section" id="quantization-codec">
<h3>Quantization Codec<a class="headerlink" href="#quantization-codec" title="Permalink to this headline">¶</a></h3>
<p>The quantization compression method is approximating communication data fixed-point of floating-point type to a finite number of discrete values.</p>
<p>Taking the 8-bit quantization as an example:</p>
<p>Quantify the number of bits num_bits = 8</p>
<p>The floating-point data before compression is</p>
<p>data = [0.03356021, -0.01842778, -0.009684053, 0.025363436, -0.027571501, 0.0077043395, 0.016391572, -0.03598478,  -0.0009508357]</p>
<p>Compute the max and min values:</p>
<p>min_val = -0.03598478</p>
<p>max_val = 0.03356021</p>
<p>Calculate scaling factor:</p>
<p>scale = (max_val - min_val ) / (2 ^ num_bits - 1) = 0.000272725450980392</p>
<p>Convert the pre-compressed data to an integer between -128 and 127 with the conversion formula quant_data = round((data - min_val) / scale) - 2 ^ (num_bits - 1). And strongly convert the data type to int8:</p>
<p>quant_data = [127, -64, -32, 97, -97, 32, 64, -128, 0]</p>
<p>After the quantitative encoding, the parameters that FL-Client needs to upload are quant_data and the minimum and maximum values min_val and max_val.</p>
<p>After receiving quant_data, min_val and max_val, FL-Server uses the inverse quantization formula (quant_data + 2 ^ (num_bits - 1)) * (max_val - min_val) / (2 ^ num_bits - 1) + min_val to reduce the weights.</p>
</div>
</div>
<div class="section" id="download-compression-method">
<h2>Download Compression Method<a class="headerlink" href="#download-compression-method" title="Permalink to this headline">¶</a></h2>
<p>The download compression method is mainly a quantization codec operation, and the flow charts on FL-Server and FL-Client are given below.</p>
<p><img alt="Download compression server execution order" src="_images/download_compress_server_en.png" /></p>
<p>Fig.5 Flowchart of the download compression method on FL-Server</p>
<p><img alt="Download compression client execution order" src="_images/download_compress_client_en.png" /></p>
<p>Fig.6 Flowchart of the download compression method on FL-Client</p>
<div class="section" id="quantization-codec-1">
<h3>Quantization Codec<a class="headerlink" href="#quantization-codec-1" title="Permalink to this headline">¶</a></h3>
<p>The quantization codec is the same as that in upload compression.</p>
</div>
</div>
<div class="section" id="code-implementation-preparation">
<h2>Code Implementation Preparation<a class="headerlink" href="#code-implementation-preparation" title="Permalink to this headline">¶</a></h2>
<p>To use the upload and download compression methods, first successfully complete the training aggregation process for either device or cloud federated scenario, e.g. <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/master/sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a>. The preparation work including datasets and network models and the simulation of the process to initiate multi-client participation in federated learning are described in detail in this document.</p>
</div>
<div class="section" id="algorithm-open-script">
<h2>Algorithm Open Script<a class="headerlink" href="#algorithm-open-script" title="Permalink to this headline">¶</a></h2>
<p>The upload and download compression methods are currently only supported in the device-cloud federated learning scenario. The open method requires setting <code class="docutils literal notranslate"><span class="pre">upload_compress_type='DIFF_SPARSE_QUANT'</span></code> and <code class="docutils literal notranslate"><span class="pre">download_compress_type='QUANT'</span></code> in the corresponding yaml in the server startup script when starting the cloud-side service.</p>
<p>The relevant parameter configuration to start the algorithm is given in the cloud-side <a class="reference external" href="https://gitee.com/mindspore/federated/tree/master/tests/st/cross_device_cloud/">full startup script</a>. After determining the parameter configuration, the user needs to configure the corresponding parameters before executing the training, as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">compression</span><span class="p">:</span>
<span class="w">  </span><span class="nt">upload_compress_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NO_COMPRESS</span>
<span class="w">  </span><span class="nt">upload_sparse_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">  </span><span class="nt">download_compress_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NO_COMPRESS</span>
</pre></div>
</div>
<table border="1" class="docutils">
<thead>
<tr>
<th>Hyperparameter Names and Reference Values</th>
<th>Hyperparameter Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>upload_compress_type</td>
<td>Upload compression type, string type, including: "NO_COMPRESS", "DIFF_SPARSE_QUANT"</td>
</tr>
<tr>
<td>upload_sparse_rate</td>
<td>Sparse ratio, i.e., weight retention, float type, defined in the domain (0, 1]</td>
</tr>
<tr>
<td>download_compress_type</td>
<td>Download compression type, string type, including: "NO_COMPRESS", "QUANT"</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="albert-results">
<h2>ALBERT Results<a class="headerlink" href="#albert-results" title="Permalink to this headline">¶</a></h2>
<p>The total number of federated learning iterations is 100. The number of client local training epochs is 1. The number of clients is 20. The batchSize is set to 16. The learning rate is 1e-5. Both upload and download compression methods are turned on. The upload sparse ratio is 0.4. The final accuracy on the validation set is 72.5%, and 72.3% for the common federated scenario without compression.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="vfl_communication_compress.html" class="btn btn-neutral float-right" title="Vertical Federated Learning Communication Compression" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="secure_vertical_federated_learning_with_DP.html" class="btn btn-neutral float-left" title="Vertical Federated - Label Protection Based on Differential Privacy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>