

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Horizontal Federated-Local Differential Privacy Inference Result Protection &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Horizontal FL-Pairwise encryption training" href="pairwise_encryption_training.html" />
    <link rel="prev" title="Horizontal FL-Local Differential Privacy SignDS training" href="local_differential_privacy_training_signds.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Horizontal Federated Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">Horizontal Federated Device-side Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">Vertical Federated Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Horizontal Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="image_classfication_dataset_process.html">Federated Learning Image Classification Dataset Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">Implementing a Cloud-Slio Federated Image Classification Application (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_detection_application_in_cross_silo.html">Implementing a Cross-Silo Federated Target Detection Application (x86)</a></li>
</ul>
<p class="caption"><span class="caption-text">Vertical Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_join.html">Vertical Federated Learning Data Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_wnd_application.html">Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_pangu_alpha_application.html">Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training</a></li>
</ul>
<p class="caption"><span class="caption-text">Security and Privacy</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">Horizontal FL-Local Differential Privacy Perturbation Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">Horizontal FL-Local Differential Privacy SignDS training</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Horizontal Federated-Local Differential Privacy Inference Result Protection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#privacy-protection-background">Privacy Protection Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-analysis">Algorithm Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#l1-and-l2-paradigm"><span class="math notranslate nohighlight">\(L1\)</span> and <span class="math notranslate nohighlight">\(L2\)</span> Paradigm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#l1-and-l2-sensitivity"><span class="math notranslate nohighlight">\(L1\)</span> and <span class="math notranslate nohighlight">\(L2\)</span> Sensitivity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#laplace-distribution">Laplace Distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#laplace-mechanism">Laplace Mechanism</a></li>
<li class="toctree-l3"><a class="reference internal" href="#proving-that-the-laplace-mechanism-is-satisfied-with-the-\epsilon-ldp">Proving that the Laplace Mechanism is Satisfied with the <span class="math notranslate nohighlight">\(\epsilon-LDP\)</span></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-determination-of-\epsilon-with-the-corresponding-probability-density-plot">The Determination of <span class="math notranslate nohighlight">\(\epsilon\)</span> with the Corresponding Probability Density Plot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#impact-analysis-of-clustering-evaluation-indicators">Impact Analysis of Clustering Evaluation Indicators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#end-side-java-implementation">End-side Java Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#get-familiar">Get Familiar</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-items">Configuration Items</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#experimental-results">Experimental Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">Horizontal FL-Pairwise encryption training</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">Vertical Federated-Privacy Set Intersection</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">Vertical Federated-Feature Protection Based on Information Obfuscation</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">Vertical Federated - Feature Protection Based on Trusted Execution Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">Vertical Federated - Label Protection Based on Differential Privacy</a></li>
</ul>
<p class="caption"><span class="caption-text">Communication Compression</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="communication_compression.html">Device-Cloud Federated Learning Communication Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">Vertical Federated Learning Communication Compression</a></li>
</ul>
<p class="caption"><span class="caption-text">Horizontal Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">Federated Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">Device-side Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">Cross-Silo</a></li>
</ul>
<p class="caption"><span class="caption-text">Vertical Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">Data Join</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">Vertical Federated Learning Communicator</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">Vertical Federated Trainer</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Horizontal Federated-Local Differential Privacy Inference Result Protection</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/local_differential_privacy_eval_laplace.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="horizontal-federated-local-differential-privacy-inference-result-protection">
<h1>Horizontal Federated-Local Differential Privacy Inference Result Protection<a class="headerlink" href="#horizontal-federated-local-differential-privacy-inference-result-protection" title="Permalink to this headline">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/master/docs/federated/docs/source_en/local_differential_privacy_eval_laplace.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.png"></a></p>
<div class="section" id="privacy-protection-background">
<h2>Privacy Protection Background<a class="headerlink" href="#privacy-protection-background" title="Permalink to this headline">¶</a></h2>
<p>Evaluating the federated unsupervised model training can be judged by the <span class="math notranslate nohighlight">\(loss\)</span> of end-side feedback, or the end-side inference results combined with cloud-side clustering and clustering evaluation metrics can be used to further monitor the federated unsupervised model training progress. The latter involves end-side inference data on the cloud, and in order to meet privacy protection requirements, privacy protection processing of end-side inference data is required, while the cloud side can still be evaluated for clustering. This task is a secondary task compared to the training task, so we use lightweight algorithms and cannot introduce privacy protection algorithms with higher computational or communication overhead than the training phase. This paper presents a lightweight scheme for protecting inference results by using the local differential privacy Laplace noise mechanism.</p>
<p>The effective integration of privacy protection technology into the product services will, on the one hand, help enhance the trust of users and the industry in the products and technology, and on the other hand, help to better carry out the federated tasks under the current privacy compliance requirements and create a full lifecycle (training-inference-evaluation) of privacy protection.</p>
</div>
<div class="section" id="algorithm-analysis">
<h2>Algorithm Analysis<a class="headerlink" href="#algorithm-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="l1-and-l2-paradigm">
<h3><span class="math notranslate nohighlight">\(L1\)</span> and <span class="math notranslate nohighlight">\(L2\)</span> Paradigm<a class="headerlink" href="#l1-and-l2-paradigm" title="Permalink to this headline">¶</a></h3>
<p>The <span class="math notranslate nohighlight">\(L1\)</span>-norm of a vector <span class="math notranslate nohighlight">\(V\)</span> with length <span class="math notranslate nohighlight">\(k\)</span> is <span class="math notranslate nohighlight">\(||V|||_1=\sum^{k}_{i=1}{|V_i|}\)</span>, then the <span class="math notranslate nohighlight">\(L1\)</span>-norm of the difference between two vectors in two-dimensional space is the Manhattan distance.</p>
<p><span class="math notranslate nohighlight">\(L2\)</span>-norm is <span class="math notranslate nohighlight">\(||V||_2=\sqrt{\sum^{k}_{i=1}{V^2_i}}\)</span>.</p>
<p>The inference result is generally a <span class="math notranslate nohighlight">\(softmax\)</span> result with a sum of <span class="math notranslate nohighlight">\(1\)</span>, and each dimension value of the vector indicates the probability of belonging to the corresponding category of that dimension.</p>
</div>
<div class="section" id="l1-and-l2-sensitivity">
<h3><span class="math notranslate nohighlight">\(L1\)</span> and <span class="math notranslate nohighlight">\(L2\)</span> Sensitivity<a class="headerlink" href="#l1-and-l2-sensitivity" title="Permalink to this headline">¶</a></h3>
<p>Local differential privacy introduces uncertainty on the data to be uploaded, and the sensitivity describes an upper bound on the uncertainty. Gaussian noise with <span class="math notranslate nohighlight">\(L2\)</span> sensitivity can be added to the gradient in the optimizer and federated training, since a cropping operation is performed on the gradient vector before addition. Here the <span class="math notranslate nohighlight">\(softmax\)</span> inference result satisfies the sum as <span class="math notranslate nohighlight">\(1\)</span>, so the Laplace noise of <span class="math notranslate nohighlight">\(L1\)</span> is added. For applications where the <span class="math notranslate nohighlight">\(L2\)</span> sensitivity is much lower than the <span class="math notranslate nohighlight">\(L1\)</span> sensitivity, the Gaussian mechanism allows to add less noise, but the scenario has no <span class="math notranslate nohighlight">\(L2\)</span>-related constraint limits and uses only the <span class="math notranslate nohighlight">\(L1\)</span> sensitivity.</p>
<p>The <span class="math notranslate nohighlight">\(L1\)</span>-sensitivity is expressed as the maximum distance for any input in the defined domain in local differential privacy:</p>
<p><span class="math notranslate nohighlight">\(\Delta f=max||X-Y||_1\)</span></p>
<p>In this scenario, <span class="math notranslate nohighlight">\(X=&lt;x_1, x_2, ..., x_k&gt;, Y=&lt;y_1, y_2, ..., y_k&gt;, \sum X = 1, \sum Y = 1, |x_1-y_1|+|x_2-y_2|+...+|x_k-y_k|\leq1=\Delta f\)</span>.</p>
</div>
<div class="section" id="laplace-distribution">
<h3>Laplace Distribution<a class="headerlink" href="#laplace-distribution" title="Permalink to this headline">¶</a></h3>
<p>The Laplace distribution is continuous, and the probability density function of the Laplace with mean value 0 is:</p>
<p><span class="math notranslate nohighlight">\(Lap(x|b)=\frac{1}{2b}exp(-\frac{|x|}{b})\)</span></p>
</div>
<div class="section" id="laplace-mechanism">
<h3>Laplace Mechanism<a class="headerlink" href="#laplace-mechanism" title="Permalink to this headline">¶</a></h3>
<p><span class="math notranslate nohighlight">\(M(x,\epsilon)=X+Lap(\Delta f/\epsilon)\)</span></p>
<p>where <span class="math notranslate nohighlight">\(Lap(\Delta f/\epsilon)\)</span> is a vector of random variables with the same shape as <span class="math notranslate nohighlight">\(X\)</span>, independently and identically distributed.</p>
<p>In this scenario, <span class="math notranslate nohighlight">\(b\)</span> (also called <span class="math notranslate nohighlight">\(scale\)</span>, <span class="math notranslate nohighlight">\(lambda\)</span>, <span class="math notranslate nohighlight">\(beta\)</span>) is <span class="math notranslate nohighlight">\(1/\epsilon\)</span>.</p>
</div>
<div class="section" id="proving-that-the-laplace-mechanism-is-satisfied-with-the-\epsilon-ldp">
<h3>Proving that the Laplace Mechanism is Satisfied with the <span class="math notranslate nohighlight">\(\epsilon-LDP\)</span><a class="headerlink" href="#proving-that-the-laplace-mechanism-is-satisfied-with-the-\epsilon-ldp" title="Permalink to this headline">¶</a></h3>
<p>Any two different clients, after being processed by the Laplace mechanism, both output the same result to achieve the confusion indistinguishable and the purpose probability ratio of outputting the same result has upper exact bound. Substituting <span class="math notranslate nohighlight">\(b=\Delta f/\epsilon\)</span> yields:</p>
<p><span class="math notranslate nohighlight">\(Lap(\Delta f/\epsilon)=\frac{\epsilon}{2\Delta f}exp(-\frac{\epsilon|x|}{\Delta f})\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{P(Z|X)}{P(Z|Y)}\)</span></p>
<p><span class="math notranslate nohighlight">\(=\prod^k_{i=1}(\frac{exp(-\frac{\epsilon|x_i-z_i|}{\Delta f})}{exp(-\frac{\epsilon |y_i-z_i|}{\Delta f})})\)</span></p>
<p><span class="math notranslate nohighlight">\(=\prod^k_{i=1}exp(\epsilon\frac{|x_i-z_i|-|y_i-z_i|}{\Delta f})\)</span></p>
<p><span class="math notranslate nohighlight">\(\leq\prod^k_{i=1}(\epsilon\frac{|x_i-y_i|}{\Delta f})\)</span></p>
<p><span class="math notranslate nohighlight">\(=exp(\epsilon\frac{X-Y}{\Delta f})\)</span></p>
<p><span class="math notranslate nohighlight">\(\leq exp(\epsilon)\)</span></p>
<div class="section" id="the-determination-of-\epsilon-with-the-corresponding-probability-density-plot">
<h4>The Determination of <span class="math notranslate nohighlight">\(\epsilon\)</span> with the Corresponding Probability Density Plot<a class="headerlink" href="#the-determination-of-\epsilon-with-the-corresponding-probability-density-plot" title="Permalink to this headline">¶</a></h4>
<p>The privacy budget with high availability is calculated by combining the data characteristics, such as the requirement to output noise of the order of <span class="math notranslate nohighlight">\(1e-5\)</span> with high probability, otherwise it will directly affect the clustering results. The privacy budget calculation method corresponding to generating the specified amount of noise is given below.</p>
<p>There is the <span class="math notranslate nohighlight">\(90\%\)</span> probability to output the magnitude of <span class="math notranslate nohighlight">\(1e-5\)</span>, and the value of <span class="math notranslate nohighlight">\(\epsilon\)</span> is obtained by integrating the probability density curve.</p>
<p><span class="math notranslate nohighlight">\(x&gt;=0, Lap(x|b)=\frac{1}{2b}exp(-\frac{x}{b})\)</span></p>
<p><span class="math notranslate nohighlight">\(\int^ {E^{-5}}_0 {Lap(x|b)dx}\)</span></p>
<p><span class="math notranslate nohighlight">\(=1-\frac{1}{2}exp(-\frac{x}{b})|^{E^{-5}}_{0}\)</span></p>
<p><span class="math notranslate nohighlight">\(=\frac{1}{2}(exp(0)-exp(-\frac{E^{-5}}{b}))\)</span></p>
<p><span class="math notranslate nohighlight">\(=0.5(1-exp(-\frac{E^{-5}}{b})) = 0.45\)</span></p>
<p>i.e.</p>
<p><span class="math notranslate nohighlight">\(exp(-\frac{E^{-5}}{b})=0.1\)</span></p>
<p><span class="math notranslate nohighlight">\(b=-E^{-5}/ln(0.1)=E^{-5}/2.3026=1/\epsilon\)</span></p>
<p><span class="math notranslate nohighlight">\(\epsilon=2.3026E^5\)</span></p>
<p>When the privacy budget takes this value, the Laplace probability density function is as follows:</p>
<p><img alt="laplace" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/federated/docs/source_zh_cn/images/laplace_pdf.png" /></p>
</div>
</div>
<div class="section" id="impact-analysis-of-clustering-evaluation-indicators">
<h3>Impact Analysis of Clustering Evaluation Indicators<a class="headerlink" href="#impact-analysis-of-clustering-evaluation-indicators" title="Permalink to this headline">¶</a></h3>
<p>Using the <strong>Calinski-Harabasz Index</strong> assessment method as an example, the evaluation indicator is calculated in two steps:</p>
<ol class="simple">
<li><p>Each class calculates the sum of the squares of the distances from all <code class="docutils literal notranslate"><span class="pre">points</span></code> in the class to the <code class="docutils literal notranslate"><span class="pre">center</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">class</span></code>;</p></li>
<li><p>Calculate the sum of squares of distances from each <code class="docutils literal notranslate"><span class="pre">class</span></code> to the <code class="docutils literal notranslate"><span class="pre">center</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">class</span></code>;</p></li>
</ol>
<p>Source code implementation and impact analysis after noise addition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.The cloud-side clustering algorithm gets the class ordinal number to which it belongs, with impact</span>
<span class="n">n_labels</span> <span class="o">=</span> <span class="n">argmax</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">extra_disp</span><span class="p">,</span> <span class="n">intra_disp</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
<span class="c1"># 2.Calculate the class center of all points, without impact</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
    <span class="c1"># 3.Get all points in class k, based on the effect of 1</span>
    <span class="n">cluster_k</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
    <span class="c1"># 4.Get the class center, based on the impact of 1</span>
    <span class="n">mean_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster_k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 5.The distance between the class and the center of all classes, based on the impact of 1</span>
    <span class="n">extra_disp</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_k</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">mean_k</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># 6.The distance from the point to the center of the class, with impact</span>
    <span class="n">intra_disp</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cluster_k</span> <span class="o">-</span> <span class="n">mean_k</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">return</span> <span class="p">(</span>
    <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">intra_disp</span> <span class="o">==</span> <span class="mf">0.0</span>
    <span class="k">else</span> <span class="n">extra_disp</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_labels</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">intra_disp</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_labels</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In a comprehensive analysis, the main impact is on the clustering algorithm after noise addition, and the error on the distance calculation. When calculating the class center, the error introduced is small because the noise sum is  expected to be <span class="math notranslate nohighlight">\(0\)</span>.</p>
<p>Taking <strong>SILHOUETTE SCORE</strong> as an example, the process of calculating this evaluation indicator is divided into two steps:</p>
<ol class="simple">
<li><p>Calculate the average distance of a sample point <span class="math notranslate nohighlight">\(i\)</span> from all other sample points in the same cluster, which is denoted as <span class="math notranslate nohighlight">\(a_i\)</span>. The smaller the value is, the more the sample <span class="math notranslate nohighlight">\(i\)</span> should be assigned to this cluster.</p></li>
<li><p>Calculate the average distance <span class="math notranslate nohighlight">\(b_{ij}\)</span> of sample <span class="math notranslate nohighlight">\(i\)</span> to all samples of some other cluster <span class="math notranslate nohighlight">\(C_j\)</span>, which is called the dissimilarity of sample <span class="math notranslate nohighlight">\(i\)</span> to cluster <span class="math notranslate nohighlight">\(C_j\)</span>. The inter-cluster dissimilarity of sample <span class="math notranslate nohighlight">\(i\)</span> is defined as: <span class="math notranslate nohighlight">\(b_i = min(b_{i1}, b_{i2}, ..., b_{ik})\)</span>. The larger the value is, the less the sample <span class="math notranslate nohighlight">\(i\)</span> should belong to this cluster.</p></li>
</ol>
<p><img alt="flow" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/federated/docs/source_zh_cn/images/two_cluster.png" /></p>
<p><span class="math notranslate nohighlight">\(s_i=(b_i-a_i) / max(a_i, b_i)\)</span>.</p>
<p>The smaller <span class="math notranslate nohighlight">\(a_i\)</span> is, the larger <span class="math notranslate nohighlight">\(b_i\)</span> is, and the result is <span class="math notranslate nohighlight">\(1-a_i / b_i\)</span>. The closer to <span class="math notranslate nohighlight">\(1\)</span>, the better the clustering effect.</p>
<p>Pseudocode implementation and impact analysis after noise addition:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Calculate distance matrix, space for time, upper triangle storage, which has an impact on noise addition</span>
<span class="n">euclidean_distance_matrix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">distance_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">group_ids</span><span class="p">);</span>

<span class="c1">// Perform the same calculation for each point, and finally calculate the mean value</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_samples</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">b_i_map</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_samples</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">label_j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// Same cluster calculates ai</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">label_j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">label_i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a_distances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Different clusters calculate bi</span>
<span class="w">            </span><span class="n">b_i_map</span><span class="p">[</span><span class="n">label_j</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a_distances</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Calculate the average distance of the point from other points in the same cluster</span>
<span class="w">        </span><span class="n">a_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">a_distances</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">a_distances</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">a_distances</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">item</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">b_i_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b_i_distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">b_i_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">b_i_distances</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">b_i_distances</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">b_i_distances</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">        </span><span class="n">b_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">b_i</span><span class="p">,</span><span class="w"> </span><span class="n">b_i_distance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">s_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">s_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">b_i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a_i</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">a_i</span><span class="p">,</span><span class="w"> </span><span class="n">b_i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">s_i</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">s_i</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n_samples</span><span class="p">;</span>
</pre></div>
</div>
<p>As above, the main impact is the main impact is on the clustering algorithm after noise addition, and the error on the distance calculation.</p>
</div>
<div class="section" id="end-side-java-implementation">
<h3>End-side Java Implementation<a class="headerlink" href="#end-side-java-implementation" title="Permalink to this headline">¶</a></h3>
<p>There is no function in the Java basic library to generate Laplace distributed random numbers. The following combination strategy of random numbers is used to generate.</p>
<p>The source code is as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">genLaplaceNoise</span><span class="p">(</span><span class="n">SecureRandom</span><span class="w"> </span><span class="n">secureRandom</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">u1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secureRandom</span><span class="p">.</span><span class="na">nextFloat</span><span class="p">();</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">u2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">secureRandom</span><span class="p">.</span><span class="na">nextFloat</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u2</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">beta</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">u2</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After obtaining a new round of model on the end-side, the inference calculation is executed immediately. After the training, the inference results after privacy protection are uploaded to the cloud side together with the new model, and the cloud side finally performs operations such as clustering and score calculation. The flow is shown in the following figure, where the red part is the output result of privacy protection processing:</p>
<p><img alt="flow" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/federated/docs/source_zh_cn/images/eval_flow.png" /></p>
</div>
</div>
<div class="section" id="get-familiar">
<h2>Get Familiar<a class="headerlink" href="#get-familiar" title="Permalink to this headline">¶</a></h2>
<div class="section" id="preparation">
<h3>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h3>
<p>To use this feature, one first needs to successfully complete the training aggregation process for either end-cloud federated scenario. <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/master/image_classification_application.html">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a> details the preparation of datasets and network models, as well as simulates the process of initiating multi-client participation in federated learning.</p>
</div>
<div class="section" id="configuration-items">
<h3>Configuration Items<a class="headerlink" href="#configuration-items" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/tests/st/cross_device_cloud/default_yaml_config.yaml">cloud-side yaml configuration file</a> gives the complete configuration items for opening the end-cloud federated, and the program involves the following additional configuration file items:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">encrypt</span><span class="p">:</span>
<span class="w">    </span><span class="nl">privacy_eval_type</span><span class="p">:</span><span class="w"> </span><span class="n">LAPLACE</span>
<span class="w">    </span><span class="nl">laplace_eval</span><span class="p">:</span>
<span class="w">        </span><span class="nl">laplace_eval_eps</span><span class="p">:</span><span class="w"> </span><span class="mi">230260</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">privacy_eval_type</span></code> currently supports only <code class="docutils literal notranslate"><span class="pre">NOT_ENCRYPT</span></code> and <code class="docutils literal notranslate"><span class="pre">LAPLACE</span></code>, indicating that the inference results are processed without privacy protection methods and with the <code class="docutils literal notranslate"><span class="pre">LAPLACE</span></code> mechanism, respectively.</p>
<p><code class="docutils literal notranslate"><span class="pre">laplace_eval_eps</span></code> indicates how much of the privacy budget is used if <code class="docutils literal notranslate"><span class="pre">LAPLACE</span></code> processing is used.</p>
</div>
</div>
<div class="section" id="experimental-results">
<h2>Experimental Results<a class="headerlink" href="#experimental-results" title="Permalink to this headline">¶</a></h2>
<p>The basic configuration associated with the inference result evaluation function is used as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">unsupervised</span><span class="p">:</span>
<span class="w">  </span><span class="nl">cluster_client_num</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">  </span><span class="nl">eval_type</span><span class="p">:</span><span class="w"> </span><span class="n">SILHOUETTE_SCORE</span>
</pre></div>
</div>
<p>We can see that the relationship between <span class="math notranslate nohighlight">\(loss\)</span> and the score under the <code class="docutils literal notranslate"><span class="pre">LAPLACE</span></code> mechanism by using <code class="docutils literal notranslate"><span class="pre">NOT_ENCRYPT</span></code> and using <code class="docutils literal notranslate"><span class="pre">laplace_eval_eps=230260</span></code> is shown in the figure:</p>
<p><img alt="flow" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/federated/docs/source_zh_cn/images/SILHOUETTE.png" /></p>
<p>The red dashed line shows the SILHOUETTE scores after the Laplace mechanism is used to protect the inference results. Since the model contains <span class="math notranslate nohighlight">\(dropout\)</span> and Gaussian input, the <span class="math notranslate nohighlight">\(loss\)</span> of the two trainings are slightly different and the scores obtained based on different models are slightly different. However, the overall trend remains consistent and can assist <span class="math notranslate nohighlight">\(loss\)</span> together to detect the model training progress.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="pairwise_encryption_training.html" class="btn btn-neutral float-right" title="Horizontal FL-Pairwise encryption training" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="local_differential_privacy_training_signds.html" class="btn btn-neutral float-left" title="Horizontal FL-Local Differential Privacy SignDS training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>