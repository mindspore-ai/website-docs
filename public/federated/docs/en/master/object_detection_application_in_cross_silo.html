<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementing a Cross-Silo Federated Target Detection Application (x86) &mdash; MindSpore master documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vertical Federated Learning Data Access" href="data_join.html" />
    <link rel="prev" title="Implementing a Cloud-Slio Federated Image Classification Application (x86)" href="image_classification_application_in_cross_silo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Horizontal Federated Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">Horizontal Federated Device-side Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">Vertical Federated Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Horizontal Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="image_classfication_dataset_process.html">Federated Learning Image Classification Dataset Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">Implementing a Cloud-Slio Federated Image Classification Application (x86)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementing a Cross-Silo Federated Target Detection Application (x86)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-the-cross-silo-federated-mission">Starting the Cross-Silo Federated Mission</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installing-mindspore-and-mindspore-federated">Installing MindSpore and Mindspore Federated</a></li>
<li class="toctree-l3"><a class="reference internal" href="#starting-mission">Starting Mission</a></li>
<li class="toctree-l3"><a class="reference internal" href="#viewing-the-log">Viewing the Log</a></li>
<li class="toctree-l3"><a class="reference internal" href="#closing-the-mission">Closing the Mission</a></li>
<li class="toctree-l3"><a class="reference internal" href="#results">Results</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vertical Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_join.html">Vertical Federated Learning Data Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_wnd_application.html">Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_pangu_alpha_application.html">Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">Horizontal FL-Local Differential Privacy Perturbation Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">Horizontal FL-Local Differential Privacy SignDS training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_eval_laplace.html">Horizontal Federated-Local Differential Privacy Inference Result Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">Horizontal FL-Pairwise encryption training</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">Vertical Federated-Privacy Set Intersection</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">Vertical Federated-Feature Protection Based on Information Obfuscation</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">Vertical Federated - Feature Protection Based on Trusted Execution Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">Vertical Federated - Label Protection Based on Differential Privacy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Communication Compression</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="communication_compression.html">Device-Cloud Federated Learning Communication Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">Vertical Federated Learning Communication Compression</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Horizontal Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">Federated Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">Device-side Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">Cross-Silo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vertical Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">Data Join</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">Vertical Federated Learning Communicator</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">Vertical Federated Trainer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Implementing a Cross-Silo Federated Target Detection Application (x86)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/object_detection_application_in_cross_silo.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="implementing-a-cross-silo-federated-target-detection-application-x86">
<h1>Implementing a Cross-Silo Federated Target Detection Application (x86)<a class="headerlink" href="#implementing-a-cross-silo-federated-target-detection-application-x86" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/federated/docs/source_en/object_detection_application_in_cross_silo.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.png" /></a></p>
<p>Based on the type of participating clients, federated learning can be classified into cross-silo federated learning and cross-device federated learning. In a cross-silo federated learning scenario, the clients involved in federated learning are different organizations (e.g., healthcare or finance) or geographically distributed data centers, i.e., training models on multiple data silos. In the cross-device federated learning scenario, the participating clients are a large number of mobile or IoT devices. This framework will describe how to implement a target detection application by using network Fast R-CNN on MindSpore Federated cross-silo federated framework.</p>
<p>The full script to launch cross-silo federated target detection application can be found <a class="reference external" href="https://gitee.com/mindspore/federated/tree/master/example/cross_silo_faster_rcnn">here</a>.</p>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline"></a></h2>
<p>This tutorial deploy the cross-silo federated target detection task based on the faster_rcnn network provided in MindSpore model_zoo. Please first follow the official <a class="reference external" href="https://gitee.com/mindspore/models/tree/master/official/cv/FasterRCNN">faster_rcnn tutorial and code</a> to understand the COCO dataset, faster_rcnn network structure, training process and evaluation process first. Since the COCO dataset is open source, please refer to its <a class="reference external" href="https://cocodataset.org/#home">official website</a> guidelines to download a dataset by yourself and perform dataset slicing (for example, suppose there are 100 clients, the dataset can be sliced into 100 copies, each representing the data held by one client).</p>
<p>Since the original COCO dataset is in json file format, the target detection script provided by cross-silo federated learning framework only supports input data in MindRecord format. You can convert the json file to MindRecord format file according to the following steps.</p>
<ul>
<li><p>Configure the following parameters in the configuration file<a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/default_config.yaml">default_config.yaml</a>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mindrecord_dir</span></code></p>
<p>Used to set the generated MindRecord format file save path. The folder name must be mindrecord_{num} format, and the number num represents the client label number 0, 1, 2, 3, ……</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mindrecord_dir:<span class="s2">&quot;./datasets/coco_split/split_100/mindrecord_0&quot;</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">instance_set</span></code></p>
<p>Used to set original json file path.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>instance_set:<span class="w"> </span><span class="s2">&quot;./datasets/coco_split/split_100/train_0.json&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Run the script <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/generate_mindrecord.py">generate_mindrecord.py</a> to generate MindRecord file according to <code class="docutils literal notranslate"><span class="pre">train_0.json</span></code>, saved in the <code class="docutils literal notranslate"><span class="pre">mindrecord_dir</span></code> path.</p></li>
</ul>
</section>
<section id="starting-the-cross-silo-federated-mission">
<h2>Starting the Cross-Silo Federated Mission<a class="headerlink" href="#starting-the-cross-silo-federated-mission" title="Permalink to this headline"></a></h2>
<section id="installing-mindspore-and-mindspore-federated">
<h3>Installing MindSpore and Mindspore Federated<a class="headerlink" href="#installing-mindspore-and-mindspore-federated" title="Permalink to this headline"></a></h3>
<p>Including both downloading source code and downloading release version, supporting CPU, GPU, Ascend hardware platforms, just choose to install according to the hardware platforms.  For the installing step, refer to <a class="reference external" href="https://www.mindspore.cn/install">MindSpore installation</a>， <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/master/index.html">Mindspore Federated installation</a>.</p>
<p>Currently the federated learning framework is only supported for deployment in Linux environments, and cross-silo federated learning framework requires MindSpore version number &gt;= 1.5.0.</p>
</section>
<section id="starting-mission">
<h3>Starting Mission<a class="headerlink" href="#starting-mission" title="Permalink to this headline"></a></h3>
<p>Refer to <a class="reference external" href="https://gitee.com/mindspore/federated/tree/master/example/cross_silo_faster_rcnn">example</a> to start the cluster. The reference example directory structure is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cross_silo_faster_rcnn
├── src
│   ├── FasterRcnn
│   │   ├── __init__.py                  // init file
│   │   ├── anchor_generator.py          // Anchor generator
│   │   ├── bbox_assign_sample.py        // Phase I Sampler
│   │   ├── bbox_assign_sample_stage2.py // Phase II Sampler
│   │   ├── faster_rcnn_resnet.py        // Faster R-CNN network
│   │   ├── faster_rcnn_resnet50v1.py    // Faster R-CNN network taking Resnet50v1.0 as backbone
│   │   ├── fpn_neck.py                  // Feature Pyramid Network
│   │   ├── proposal_generator.py        // Candidate generator
│   │   ├── rcnn.py                      // R-CNN network
│   │   ├── resnet.py                    // Backbone network
│   │   ├── resnet50v1.py                // Resnet50v1.0 backbone network
│   │   ├── roi_align.py                 // ROI aligning network
│   │   └── rpn.py                       // Regional candidate network
│   ├── dataset.py                     // Create and process datasets
│   ├── lr_schedule.py                 // Learning rate generator
│   ├── network_define.py              // Faster R-CNN network definition
│   ├── util.py                        // Routine operation
│   └── model_utils
│           ├── __init__.py                  // init file
│           ├── config.py                    // Obtain .yaml configuration parameter
│           ├── device_adapter.py            // Obtain on-cloud id
│           ├── local_adapter.py             // Get local id
│           └── moxing_adapter.py            // On-cloud data preparation
├── requirements.txt
├── mindspore_hub_conf.py
├── generate_mindrecord.py              // Convert annotations files in .json format to MindRecord format for reading datasets
├── default_yaml_config.yaml                 // Required configuration files for Federated training
├── default_config.yaml                         // Required configuration file of network structure, dataset address, and fl_plan
├── run_cross_silo_fasterrcnn_worker.py // Start Cloud Federated worker script
├── run_cross_silo_fasterrcnn_worker_distribute.py // Start the Cloud Federated distributed worker training script
└── test_fl_fasterrcnn.py               // Training scripts used by the client
└── run_cross_silo_fasterrcnn_sched.py  // Start Cloud federated scheduler script
└── run_cross_silo_fasterrcnn_server.py // Start Cloud federated server script
</pre></div>
</div>
<ol class="arabic">
<li><p>Note that you can choose whether to record the loss value for each step by setting the parameter <code class="docutils literal notranslate"><span class="pre">dataset_sink_mode</span></code> in the <code class="docutils literal notranslate"><span class="pre">test_fl_fasterrcnn.py</span></code> file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">client_epoch_num</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># Not setting dataset_sink_mode means that only the loss value of the last step in each epoch is recorded.</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">client_epoch_num</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   <span class="c1"># Set dataset_sink_mode=False to record the loss value of each step, which is the default mode in the code.</span>
</pre></div>
</div>
</li>
<li><p>Set the following parameters in configuration file <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/default_config.yaml">default_config.yaml</a>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">pre_trained</span></code></p>
<p>Used to set the pre-trained model path (.ckpt format).</p>
<p>The pre-trained model experimented in this tutorial is a ResNet-50 checkpoint trained on ImageNet 2012. You can use the <a class="reference external" href="https://gitee.com/mindspore/models/tree/master/official/cv/ResNet">resnet50</a> script in ModelZoo to train, and then use src/convert_checkpoint.py to convert the trained resnet50 weight file into a loadable weight file.</p>
</li>
</ul>
</li>
<li><p>Start redis</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redis-server<span class="w"> </span>--port<span class="w"> </span><span class="m">2345</span><span class="w"> </span>--save<span class="w"> </span><span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p>Start Scheduler</p>
<p><code class="docutils literal notranslate"><span class="pre">run_cross_silo_fasterrcnn_sched.py</span></code> is the Python script used to start <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> and supports modifying the configuration by passing argument <code class="docutils literal notranslate"><span class="pre">argparse</span></code>. Execute the following command, which represents the <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> that starts this federated learning task. <code class="docutils literal notranslate"><span class="pre">--yaml_config</span></code> is used to set the yaml file path, and its management ip:port is <code class="docutils literal notranslate"><span class="pre">127.0.0.1:18019</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_cross_silo_fasterrcnn_sched.py<span class="w"> </span>--yaml_config<span class="o">=</span><span class="s2">&quot;default_yaml_config.yaml&quot;</span><span class="w"> </span>--scheduler_manage_address<span class="o">=</span><span class="s2">&quot;127.0.0.1:18019&quot;</span>
</pre></div>
</div>
<p>For the detailed implementation, see <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/run_cross_silo_fasterrcnn_sched.py">run_cross_silo_fasterrcnn_sched.py</a>.</p>
<p>The following print represents a successful starting:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b280497ed00,python<span class="o">)</span>:2022-10-10-17:11:08.154.878<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/scheduler/scheduler.cc:35<span class="o">]</span><span class="w"> </span>Run<span class="o">]</span><span class="w"> </span>Scheduler<span class="w"> </span>started<span class="w"> </span>successfully.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b28c5ada700,python<span class="o">)</span>:2022-10-10-17:11:08.155.056<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/common/communicator/http_request_handler.cc:90<span class="o">]</span><span class="w"> </span>Run<span class="o">]</span><span class="w"> </span>Start<span class="w"> </span>http<span class="w"> </span>server!
</pre></div>
</div>
</li>
<li><p>Start Server</p>
<p><code class="docutils literal notranslate"><span class="pre">run_cross_silo_fasterrcnn_server.py</span></code> is a Python script for starting a number of <code class="docutils literal notranslate"><span class="pre">Server</span></code>s, and supports modifying the configuration by passing argument <code class="docutils literal notranslate"><span class="pre">argparse</span></code>. Execute the following command, representing the <code class="docutils literal notranslate"><span class="pre">Server</span></code> that starts this Federated Learning task with a TCP address of <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>. The starting port for the Federated Learning HTTP service is <code class="docutils literal notranslate"><span class="pre">6668</span></code> and the number of <code class="docutils literal notranslate"><span class="pre">Server</span></code>s is <code class="docutils literal notranslate"><span class="pre">4</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_cross_silo_fasterrcnn_server.py<span class="w"> </span>--yaml_config<span class="o">=</span><span class="s2">&quot;default_yaml_config.yaml&quot;</span><span class="w"> </span>--tcp_server_ip<span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="w"> </span>--checkpoint_dir<span class="o">=</span><span class="s2">&quot;/path/to/fl_ckpt&quot;</span><span class="w"> </span>--local_server_num<span class="o">=</span><span class="m">4</span><span class="w"> </span>--http_server_address<span class="o">=</span><span class="s2">&quot;127.0.0.1:6668&quot;</span>
</pre></div>
</div>
<p>The above command is equivalent to starting four <code class="docutils literal notranslate"><span class="pre">Server</span></code> processes, each with a federated learning service port of <code class="docutils literal notranslate"><span class="pre">6668</span></code>, <code class="docutils literal notranslate"><span class="pre">6669</span></code>, <code class="docutils literal notranslate"><span class="pre">6670</span></code> and <code class="docutils literal notranslate"><span class="pre">6671</span></code>, as detailed in <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/run_cross_silo_fasterrcnn_server.py">run_cross_silo_fasterrcnn_server.py</a>, and checkpoint_dir needs to enter the directory path where the checkpoint is located. The server will read the checkpoint initialization weight from this path. The prefix format of the checkpoint needs to be <code class="docutils literal notranslate"><span class="pre">{fl_name}_</span> <span class="pre">recovery_</span> <span class="pre">iteration_</span></code>.</p>
<p>The following print represents a successful starting:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b280497ed00,python<span class="o">)</span>:2022-10-10-17:11:08.154.645<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/common/communicator/http_server.cc:122<span class="o">]</span><span class="w"> </span>Start<span class="o">]</span><span class="w"> </span>Start<span class="w"> </span>http<span class="w"> </span>server!
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b280497ed00,python<span class="o">)</span>:2022-10-10-17:11:08.154.725<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/common/communicator/http_request_handler.cc:85<span class="o">]</span><span class="w"> </span>Initialize<span class="o">]</span><span class="w"> </span>Ev<span class="w"> </span>http<span class="w"> </span>register<span class="w"> </span>handle<span class="w"> </span>of:<span class="w"> </span><span class="o">[</span>/d<span class="w">    </span>isableFLS,<span class="w"> </span>/enableFLS,<span class="w"> </span>/state,<span class="w"> </span>/queryInstance,<span class="w"> </span>/newInstance<span class="o">]</span><span class="w"> </span>success.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b280497ed00,python<span class="o">)</span>:2022-10-10-17:11:08.154.878<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/scheduler/scheduler.cc:35<span class="o">]</span><span class="w"> </span>Run<span class="o">]</span><span class="w"> </span>Scheduler<span class="w"> </span>started<span class="w"> </span>successfully.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>FEDERATED<span class="o">(</span><span class="m">3944</span>,2b28c5ada700,python<span class="o">)</span>:2022-10-10-17:11:08.155.056<span class="w"> </span><span class="o">[</span>mindspore_federated/fl_arch/ccsrc/common/communicator/http_request_handler.cc:90<span class="o">]</span><span class="w"> </span>Run<span class="o">]</span><span class="w"> </span>Start<span class="w"> </span>http<span class="w"> </span>server!
</pre></div>
</div>
</li>
<li><p>Start Worker</p>
<p><code class="docutils literal notranslate"><span class="pre">run_cross_silo_femnist_worker.py</span></code> is a Python script for starting a number of <code class="docutils literal notranslate"><span class="pre">worker</span></code>s, and supports modifying the configuration by the passing argument <code class="docutils literal notranslate"><span class="pre">argparse</span></code>. The following instruction is executed, representing the <code class="docutils literal notranslate"><span class="pre">worker</span></code> that starts this federated learning task, and the number of <code class="docutils literal notranslate"><span class="pre">workers</span></code> needed for the federated learning task to proceed properly is at least <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_cross_silo_fasterrcnn_worker.py<span class="w"> </span>--local_worker_num<span class="o">=</span><span class="m">2</span><span class="w"> </span>--yaml_config<span class="o">=</span><span class="s2">&quot;default_yaml_config.yaml&quot;</span><span class="w"> </span>--pre_trained<span class="o">=</span><span class="s2">&quot;/path/to/pre_trained&quot;</span><span class="w"> </span>--dataset_path<span class="o">=</span>/path/to/datasets/coco_split/split_100<span class="w"> </span>--http_server_address<span class="o">=</span><span class="m">127</span>.0.0.1:6668
</pre></div>
</div>
<p>For the detailed implementation, see <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/example/cross_silo_faster_rcnn/run_cross_silo_fasterrcnn_worker.py">run_cross_silo_femnist_worker.py</a>. Note that in dataset sink mode, the unit of the synchronization frequency of Cloud Federated is in epoch, otherwise the synchronization frequency is in step.</p>
<p>As the above command, <code class="docutils literal notranslate"><span class="pre">--local_worker_num=2</span></code> means starting two clients, and the datasets used by the two clients are <code class="docutils literal notranslate"><span class="pre">datasets/coco_split/split_100/mindrecord_0</span></code> and <code class="docutils literal notranslate"><span class="pre">datasets/coco_split/split_100/mindrecord_1</span></code>. Please prepare the required datasets for the corresponding clients according to the <code class="docutils literal notranslate"><span class="pre">pre-task</span> <span class="pre">preparation</span></code> tutorial.</p>
<p>After executing the above three commands and waiting for a while, go to the <code class="docutils literal notranslate"><span class="pre">worker_0</span></code> folder in the current directory and check the <code class="docutils literal notranslate"><span class="pre">worker_0</span></code> log with the command <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-rn</span> <span class="pre">&quot;\epoch:&quot;</span> <span class="pre">*</span></code> and you will see a log message similar to the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">1</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">0</span>.6060338
</pre></div>
</div>
<p>Then it means that cross-silo federated is started successfully and <code class="docutils literal notranslate"><span class="pre">worker_0</span></code> is training. Other workers can be viewed in a similar way.</p>
<p>At present, the ‘worker’ node of Cloud Federated supports the distributed training mode of single machine multi-card and multi-machine multi-card. <code class="docutils literal notranslate"><span class="pre">run_cross_silo_fasterrcnn_worker_distributed.py</span></code> is a python script for users to start distributed training of the worker node, and supports configuration modification via argparse. Execute the following instructions, representing the distributed ‘worker’ that starts this federated learning task, where ‘device_num’ represents the number of processes started by the ‘worker’ cluster, ‘run_distribute’ represents the distributed training started by the cluster, and its http start port is ‘6668’. Number of ‘worker’ processes is ‘4’:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_cross_silo_fasterrcnn_worker_distributed.py<span class="w"> </span>--device_num<span class="o">=</span><span class="m">4</span><span class="w"> </span>--run_distribute<span class="o">=</span>True<span class="w"> </span>--dataset_path<span class="o">=</span>/path/to/datasets/coco_split/split_100<span class="w"> </span>--http_server_address<span class="o">=</span><span class="m">127</span>.0.0.1:6668
</pre></div>
</div>
<p>Enter the ‘worker_distributed/log_output/’ folder in the current directory and run the ‘grep -rn “epoch” *’ command to view the logs of the ‘worker’ distributed cluster. You can see the following information:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">1</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">0</span>.613467
</pre></div>
</div>
<p>Please refer to <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/master/horizontal/federated_server_yaml.html">yaml configuration notes</a> for the description of parameter configuration in the above script.</p>
</li>
</ol>
</section>
<section id="viewing-the-log">
<h3>Viewing the Log<a class="headerlink" href="#viewing-the-log" title="Permalink to this headline"></a></h3>
<p>After successfully starting the task, the corresponding log file will be generated under the current directory <code class="docutils literal notranslate"><span class="pre">cross_silo_faster_rcnn</span></code>. The log file directory structure is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>cross_silo_faster_rcnn
├── scheduler
│   └── scheduler.log     # Print logs during running scheduler
├── server_0
│   └── server.log        # Print logs during running server_0
├── server_1
│   └── server.log        # Print logs during running server_1
├── server_2
│   └── server.log        # Print logs during running server_2
├── server_3
│   └── server.log        # Print logs during running server_3
├── worker_0
│   ├── ckpt              # Store the aggregated model ckpt obtained by worker_0 at the end of each federated learning iteration
│   │  └── mindrecord_0
│   │      ├── mindrecord_0-fast-rcnn-0epoch.ckpt
│   │      ├── mindrecord_0-fast-rcnn-1epoch.ckpt
│   │      │
│   │      │              ......
│   │      │
│   │      └── mindrecord_0-fast-rcnn-29epoch.ckpt
│   ├──loss_0.log         # Record the loss value of each step in the training process of worker_0
│   └── worker.log        # Record the output logs during worker_0 participation in the federal learning task
└── worker_1
    ├── ckpt              # Store the aggregated model ckpt obtained by worker_1 at the end of each federated learning iteration
    │  └── mindrecord_1
    │      ├── mindrecord_1-fast-rcnn-0epoch.ckpt
    │      ├── mindrecord_1-fast-rcnn-1epoch.ckpt
    │      │
    │      │                     ......
    │      │
    │      └── mindrecord_1-fast-rcnn-29epoch.ckpt
    ├──loss_0.log         # Record the loss value of each step in the training process of worker_1
    └── worker.log        # Record the output logs during worker_1 participation in the federal learning task
</pre></div>
</div>
</section>
<section id="closing-the-mission">
<h3>Closing the Mission<a class="headerlink" href="#closing-the-mission" title="Permalink to this headline"></a></h3>
<p>If you want to exit in the middle, the following command is available:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finish_cross_silo_fasterrcnn.py<span class="w"> </span>--redis_port<span class="o">=</span><span class="m">2345</span>
</pre></div>
</div>
<p>For the detailed implementation, see <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/tests/st/cross_device_cloud/finish_cloud.py">finish_cloud.py</a>.</p>
<p>Or when the training task is finished, the cluster exits automatically, no need to close it manually.</p>
</section>
<section id="results">
<h3>Results<a class="headerlink" href="#results" title="Permalink to this headline"></a></h3>
<ul>
<li><p>Use data：</p>
<p>COCO dataset is split into 100 copies, and the first two copies are taken as two worker datasets respectively</p>
</li>
<li><p>The number of client-side local training epochs: 1</p></li>
<li><p>Total number of cross-silo federated learning iterations: 30</p></li>
<li><p>Results (recording the loss values during the client-side local training):</p>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">worker_0</span></code> folder in the current directory, and check the <code class="docutils literal notranslate"><span class="pre">worker_0</span></code> log with the command <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-rn</span> <span class="pre">&quot;\]epoch:&quot;</span> <span class="pre">*</span></code> to see the loss values output in each step:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">1</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">5</span>.249325
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">2</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">4</span>.0856013
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">3</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">2</span>.6916502
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">4</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">1</span>.3917351
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">0</span>.8109232
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">6</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">0</span>.99101084
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">7</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">1</span>.7741735
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">8</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">0</span>.9517553
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">9</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">1</span>.7988946
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">10</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">1</span>.0213892
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">11</span><span class="w"> </span>total_loss:<span class="w"> </span><span class="m">1</span>.1700443
<span class="w">                  </span>.
<span class="w">                  </span>.
<span class="w">                  </span>.
</pre></div>
</div>
</li>
</ul>
<p>The histograms of the training loss transformations in each step of worker_1 and worker_2 during the 30 iterations training are as follows, [1] and [2]:</p>
<p>The polygrams of the average loss (the sum of the losses of all the steps in an epoch divided by the number of steps) in each step of worker_1 and worker_2 during the 30 iterations training are as follows, [3] and [4]:</p>
<p><img alt="cross-silo_fastrcnn-2workers-loss.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/federated/docs/source_zh_cn/images/cross-silo_fastrcnn-2workers-loss.png" /></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="image_classification_application_in_cross_silo.html" class="btn btn-neutral float-left" title="Implementing a Cloud-Slio Federated Image Classification Application (x86)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="data_join.html" class="btn btn-neutral float-right" title="Vertical Federated Learning Data Access" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>