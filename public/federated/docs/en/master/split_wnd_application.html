<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script><script src="_static/jquery.js"></script>
        <script src="_static/js/theme.js"></script><script src="_static/underscore.js"></script><script src="_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training" href="split_pangu_alpha_application.html" />
    <link rel="prev" title="Vertical Federated Learning Data Access" href="data_join.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Horizontal Federated Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">Horizontal Federated Device-side Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">Vertical Federated Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Horizontal Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="image_classfication_dataset_process.html">Federated Learning Image Classification Dataset Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">Implementing a Cloud-Slio Federated Image Classification Application (x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_detection_application_in_cross_silo.html">Implementing a Cross-Silo Federated Target Detection Application (x86)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vertical Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_join.html">Vertical Federated Learning Data Access</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#network-and-data">Network and Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset-preparation">Dataset Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quick-experience">Quick Experience</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deep-experience">Deep Experience</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-the-dataset">Building the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-the-network">Building the Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vertical-federated-communication-base">Vertical Federated Communication Base</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-a-vertical-federated-network">Building a Vertical Federated Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vertical-training">Vertical Training</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="split_pangu_alpha_application.html">Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">Horizontal FL-Local Differential Privacy Perturbation Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">Horizontal FL-Local Differential Privacy SignDS training</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_eval_laplace.html">Horizontal Federated-Local Differential Privacy Inference Result Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">Horizontal FL-Pairwise encryption training</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">Vertical Federated-Privacy Set Intersection</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">Vertical Federated-Feature Protection Based on Information Obfuscation</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">Vertical Federated - Feature Protection Based on Trusted Execution Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">Vertical Federated - Label Protection Based on Differential Privacy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Communication Compression</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="communication_compression.html">Device-Cloud Federated Learning Communication Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">Vertical Federated Learning Communication Compression</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Horizontal Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">Federated Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">Device-side Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">Cross-Silo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vertical Federated API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">Data Join</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">Vertical Federated Learning Communicator</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">Vertical Federated Trainer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/split_wnd_application.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="vertical-federated-learning-model-training--widedeep-recommendation-application">
<h1>Vertical Federated Learning Model Training - Wide&amp;Deep Recommendation Application<a class="headerlink" href="#vertical-federated-learning-model-training--widedeep-recommendation-application" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/federated/docs/source_en/split_wnd_application.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>MindSpore Federated provides a vertical federated learning infrastructure component based on Split Learning.</p>
<p>Vertical FL model training scenarios: including two stages of forward propagation and backward propagation/parameter update.</p>
<p>Forward propagation: After the data intersection module processes the parameter-side data and aligns the feature information and label information, the Follower participant inputs the local feature information into the precursor network model, and the feature tensor output from the precursor network model is encrypted/scrambled by the privacy security module and transmitted to the Leader participant by the communication module. The Leader participants input the received feature tensor into the post-level network model, and the predicted values and local label information output from the post-level network model are used as the loss function input to calculate the loss values.</p>
<p><img alt="" src="_images/vfl_forward_en.png" /></p>
<p>Backward propagation: The Leader participant calculates the parameter gradient of the backward network model based on the loss value, trains and updates the parameters of the backward network model, and transmits the gradient tensor associated with the feature tensor to the Follower participant by the communication module after encrypted and scrambled by the privacy security module. The Follower participant uses the received gradient tensor for training and update of of frontward network model parameters.</p>
<p><img alt="" src="_images/vfl_backward_en.png" /></p>
<p>Vertical FL model inference scenario: similar to the forward propagation phase of the training scenario, but with the predicted values of the backward network model directly as the output, without calculating the loss values.</p>
</section>
<section id="network-and-data">
<h2>Network and Data<a class="headerlink" href="#network-and-data" title="Permalink to this headline"></a></h2>
<p><img alt="" src="_images/splitnn_wide_and_deep_en.png" /></p>
<p>This sample provides a federated learning training example for recommendation-oriented tasks by using Wide&amp;Deep network and Criteo dataset as examples. As shown above, in this case, the vertical federated learning system consists of the Leader participant and the Follower participant. Among them, the Leader participant holds 20×2 dimensional feature information and label information, and the Follower participant holds 19×2 dimensional feature information. Leader participant and Follower participant deploy 1 set of Wide&amp;Deep network respectively, and realize the collaborative training of the network model by exchanging embedding vectors and gradient vectors without disclosing the original features and label information.</p>
<p>For a detailed description of the principle properties of Wide&amp;Deep networks, see <a class="reference external" href="https://gitee.com/mindspore/models/blob/master/official/recommend/Wide_and_Deep/README.md#widedeep-description">MindSpore ModelZoo - Wide&amp;Deep - Wide&amp;Deep Overview</a> and its <a class="reference external" href="https://arxiv.org/pdf/1606.07792.pdf">research paper</a>.</p>
</section>
<section id="dataset-preparation">
<h2>Dataset Preparation<a class="headerlink" href="#dataset-preparation" title="Permalink to this headline"></a></h2>
<p>This sample is based on the Criteo dataset for training and testing. Before running the sample, you need to refer to <a class="reference external" href="https://gitee.com/mindspore/models/blob/master/official/recommend/Wide_and_Deep/README.md#quick-start">MindSpore ModelZoo - Wide&amp;Deep - Quick Start</a> to pre-process the Criteo dataset.</p>
<ol class="arabic">
<li><p>Clone MindSpore ModelZoo code.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://gitee.com/mindspore/models.git
<span class="nb">cd</span><span class="w"> </span>models/official/recommend/Wide_and_Deep
</pre></div>
</div>
</li>
<li><p>Download the dataset</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>data/origin_data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>data/origin_data
wget<span class="w"> </span>http://go.criteo.net/criteo-research-kaggle-display-advertising-challenge-dataset.tar.gz
tar<span class="w"> </span>-zxvf<span class="w"> </span>criteo-research-kaggle-display-advertising-challenge-dataset.tar.gz
</pre></div>
</div>
</li>
<li><p>Use this script to pre-process the data. The preprocessing process may take up to an hour and the generated MindRecord data is stored in the data/mindrecord path. The preprocessing process consumes a lot of memory, so it is recommended to use a server.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>../..
python<span class="w"> </span>src/preprocess_data.py<span class="w">  </span>--data_path<span class="o">=</span>./data/<span class="w"> </span>--dense_dim<span class="o">=</span><span class="m">13</span><span class="w"> </span>--slot_dim<span class="o">=</span><span class="m">26</span><span class="w"> </span>--threshold<span class="o">=</span><span class="m">100</span><span class="w"> </span>--train_line_count<span class="o">=</span><span class="m">45840617</span><span class="w"> </span>--skip_id_convert<span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="quick-experience">
<h2>Quick Experience<a class="headerlink" href="#quick-experience" title="Permalink to this headline"></a></h2>
<p>This sample runs as a Shell script pulling up a Python program.</p>
<ol class="arabic">
<li><p>Refer to <a class="reference external" href="https://www.mindspore.cn/install">MindSpore website guidance</a>, installing MindSpore 1.8.1 or higher.</p></li>
<li><p>Use to install the Python libraries that MindSpore Federated depends on.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>federated
python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements_test.txt
</pre></div>
</div>
</li>
<li><p>Copy the Criteo dataset after <a class="reference internal" href="#dataset-preparation"><span class="std std-doc">preprocessing</span></a> to this directory.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>tests/example/splitnn_criteo
cp<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">DATA_ROOT_PATH</span><span class="si">}</span>/data/mindrecord/<span class="w"> </span>./
</pre></div>
</div>
</li>
<li><p>Run the sample program to start the script.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># start leader:</span>
bash<span class="w"> </span>run_vfl_train_leader.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span>/path/to/data_set<span class="w"> </span>False

<span class="c1"># start follower:</span>
bash<span class="w"> </span>run_vfl_train_follower.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span>/path/to/data_set<span class="w"> </span>False
</pre></div>
</div>
<p>or</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start the leader process with https encrypted communication:</span>
bash<span class="w"> </span>run_vfl_train_leader.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span>/path/to/data_set<span class="w"> </span>True<span class="w"> </span>server_cert_password<span class="w"> </span>client_cert_password<span class="w"> </span>/path/to/server_cert<span class="w"> </span>/path/to/client_cert<span class="w"> </span>/path/to/ca_cert

<span class="c1"># Start the follower process using https encrypted communication:</span>
bash<span class="w"> </span>run_vfl_train_follower.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span>/path/to/data_set<span class="w"> </span>True<span class="w"> </span>server_cert_password<span class="w"> </span>client_cert_password<span class="w"> </span>/path/to/server_cert<span class="w"> </span>/path/to/client_cert<span class="w"> </span>/path/to/ca_cert
</pre></div>
</div>
</li>
<li><p>View training log <code class="docutils literal notranslate"><span class="pre">log_local_gpu.txt</span></code>.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>INFO:root:epoch 0 step 100/2582 wide_loss: 0.528141 deep_loss: 0.528339
INFO:root:epoch 0 step 200/2582 wide_loss: 0.499408 deep_loss: 0.499410
INFO:root:epoch 0 step 300/2582 wide_loss: 0.477544 deep_loss: 0.477882
INFO:root:epoch 0 step 400/2582 wide_loss: 0.474377 deep_loss: 0.476771
INFO:root:epoch 0 step 500/2582 wide_loss: 0.472926 deep_loss: 0.475157
INFO:root:epoch 0 step 600/2582 wide_loss: 0.464844 deep_loss: 0.467011
INFO:root:epoch 0 step 700/2582 wide_loss: 0.464496 deep_loss: 0.466615
INFO:root:epoch 0 step 800/2582 wide_loss: 0.466895 deep_loss: 0.468971
INFO:root:epoch 0 step 900/2582 wide_loss: 0.463155 deep_loss: 0.465299
INFO:root:epoch 0 step 1000/2582 wide_loss: 0.457914 deep_loss: 0.460132
INFO:root:epoch 0 step 1100/2582 wide_loss: 0.453361 deep_loss: 0.455767
INFO:root:epoch 0 step 1200/2582 wide_loss: 0.457566 deep_loss: 0.459997
INFO:root:epoch 0 step 1300/2582 wide_loss: 0.460841 deep_loss: 0.463281
INFO:root:epoch 0 step 1400/2582 wide_loss: 0.460973 deep_loss: 0.463365
INFO:root:epoch 0 step 1500/2582 wide_loss: 0.459204 deep_loss: 0.461563
INFO:root:epoch 0 step 1600/2582 wide_loss: 0.456771 deep_loss: 0.459200
INFO:root:epoch 0 step 1700/2582 wide_loss: 0.458479 deep_loss: 0.460963
INFO:root:epoch 0 step 1800/2582 wide_loss: 0.449609 deep_loss: 0.452122
INFO:root:epoch 0 step 1900/2582 wide_loss: 0.451775 deep_loss: 0.454225
INFO:root:epoch 0 step 2000/2582 wide_loss: 0.460343 deep_loss: 0.462826
INFO:root:epoch 0 step 2100/2582 wide_loss: 0.456814 deep_loss: 0.459201
INFO:root:epoch 0 step 2200/2582 wide_loss: 0.452091 deep_loss: 0.454555
INFO:root:epoch 0 step 2300/2582 wide_loss: 0.461522 deep_loss: 0.464001
INFO:root:epoch 0 step 2400/2582 wide_loss: 0.442355 deep_loss: 0.444790
INFO:root:epoch 0 step 2500/2582 wide_loss: 0.450675 deep_loss: 0.453242
...
</pre></div>
</div>
</li>
<li><p>Close training process.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>ps<span class="w"> </span>-ef<span class="p">|</span>grep<span class="w"> </span>run_vfl_train_socket<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;grep&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;finish&quot;</span><span class="w"> </span><span class="p">|</span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>id<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$pid</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-9<span class="w"> </span><span class="nv">$id</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;killed </span><span class="nv">$id</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="deep-experience">
<h2>Deep Experience<a class="headerlink" href="#deep-experience" title="Permalink to this headline"></a></h2>
<p>Before starting the vertical federated learning training, users need to construct the dataset iterator and network structure as they do for normal deep learning training with MindSpore.</p>
<section id="building-the-dataset">
<h3>Building the Dataset<a class="headerlink" href="#building-the-dataset" title="Permalink to this headline"></a></h3>
<p>The current simulation process is used, i.e., both participants read the same data source. But for training, both participants use only part of the feature or label data, as shown in <a class="reference internal" href="#network-and-data"><span class="std std-doc">Network and Data</span></a>. Later, the <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/master/data_join/data_join.html">Data Access</a> method will be used for both participants to import the data individually.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">run_vfl_train_local</span> <span class="kn">import</span> <span class="n">construct_local_dataset</span>


<span class="n">ds_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">construct_local_dataset</span><span class="p">()</span>
<span class="n">train_iter</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="building-the-network">
<h3>Building the Network<a class="headerlink" href="#building-the-network" title="Permalink to this headline"></a></h3>
<p>Leader participant network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wide_and_deep</span> <span class="kn">import</span> <span class="n">WideDeepModel</span><span class="p">,</span> <span class="n">BottomLossNet</span><span class="p">,</span> <span class="n">LeaderTopNet</span><span class="p">,</span> <span class="n">LeaderTopLossNet</span><span class="p">,</span> <span class="n">LeaderTopEvalNet</span><span class="p">,</span> \
     <span class="n">LeaderTeeNet</span><span class="p">,</span> <span class="n">LeaderTeeLossNet</span><span class="p">,</span> <span class="n">LeaderTopAfterTeeNet</span><span class="p">,</span> <span class="n">LeaderTopAfterTeeLossNet</span><span class="p">,</span> <span class="n">LeaderTopAfterTeeEvalNet</span><span class="p">,</span> \
     <span class="n">AUCMetric</span>
<span class="kn">from</span> <span class="nn">network_config</span> <span class="kn">import</span> <span class="n">config</span>


<span class="c1"># Leader Top Net</span>
<span class="n">leader_top_base_net</span> <span class="o">=</span> <span class="n">LeaderTopNet</span><span class="p">()</span>
<span class="n">leader_top_train_net</span> <span class="o">=</span> <span class="n">LeaderTopLossNet</span><span class="p">(</span><span class="n">leader_top_base_net</span><span class="p">)</span>
<span class="o">...</span>
<span class="c1"># Leader Bottom Net</span>
<span class="n">leader_bottom_eval_net</span> <span class="o">=</span> <span class="n">leader_bottom_base_net</span> <span class="o">=</span> <span class="n">WideDeepModel</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">leader_field_size</span><span class="p">)</span>
<span class="n">leader_bottom_train_net</span> <span class="o">=</span> <span class="n">BottomLossNet</span><span class="p">(</span><span class="n">leader_bottom_base_net</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>Follower participant network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wide_and_deep</span> <span class="kn">import</span> <span class="n">WideDeepModel</span><span class="p">,</span> <span class="n">BottomLossNet</span>
<span class="kn">from</span> <span class="nn">network_config</span> <span class="kn">import</span> <span class="n">config</span>


<span class="n">follower_bottom_eval_net</span> <span class="o">=</span> <span class="n">follower_base_net</span> <span class="o">=</span> <span class="n">WideDeepModel</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">follower_field_size</span><span class="p">)</span>
<span class="n">follower_bottom_train_net</span> <span class="o">=</span> <span class="n">BottomLossNet</span><span class="p">(</span><span class="n">follower_base_net</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vertical-federated-communication-base">
<h3>Vertical Federated Communication Base<a class="headerlink" href="#vertical-federated-communication-base" title="Permalink to this headline"></a></h3>
<p>Before training, we first have to start the communication base to make Leader and Follower participants group network. Detailed API documentation can be found in <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/docs/api/api_python_en/vertical/vertical_communicator.rst">Vertical Federated Communicator</a>.</p>
<p>Both parties need to import the vertical federated communicator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore_federated.startup.vertical_federated_local</span> <span class="kn">import</span> <span class="n">VerticalFederatedCommunicator</span><span class="p">,</span> <span class="n">ServerConfig</span>
</pre></div>
</div>
<p>Leader participant communication base:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">http_server_config</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="p">(</span><span class="n">server_name</span><span class="o">=</span><span class="s1">&#39;leader&#39;</span><span class="p">,</span> <span class="n">server_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">http_server_address</span><span class="p">)</span>
<span class="n">remote_server_config</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="p">(</span><span class="n">server_name</span><span class="o">=</span><span class="s1">&#39;follower&#39;</span><span class="p">,</span> <span class="n">server_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">remote_server_address</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span> <span class="o">=</span> <span class="n">VerticalFederatedCommunicator</span><span class="p">(</span><span class="n">http_server_config</span><span class="o">=</span><span class="n">http_server_config</span><span class="p">,</span>
                                                           <span class="n">remote_server_config</span><span class="o">=</span><span class="n">remote_server_config</span><span class="p">,</span>
                                                           <span class="n">compress_configs</span><span class="o">=</span><span class="n">compress_configs</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>Follower participant communication base:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">http_server_config</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="p">(</span><span class="n">server_name</span><span class="o">=</span><span class="s1">&#39;follower&#39;</span><span class="p">,</span> <span class="n">server_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">http_server_address</span><span class="p">)</span>
<span class="n">remote_server_config</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="p">(</span><span class="n">server_name</span><span class="o">=</span><span class="s1">&#39;leader&#39;</span><span class="p">,</span> <span class="n">server_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">remote_server_address</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span> <span class="o">=</span> <span class="n">VerticalFederatedCommunicator</span><span class="p">(</span><span class="n">http_server_config</span><span class="o">=</span><span class="n">http_server_config</span><span class="p">,</span>
                                                           <span class="n">remote_server_config</span><span class="o">=</span><span class="n">remote_server_config</span><span class="p">,</span>
                                                           <span class="n">compress_configs</span><span class="o">=</span><span class="n">compress_configs</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="building-a-vertical-federated-network">
<h3>Building a Vertical Federated Network<a class="headerlink" href="#building-a-vertical-federated-network" title="Permalink to this headline"></a></h3>
<p>Users need to use the classes provided by MindSpore Federated to wrap their constructed networks into a vertical federated network. The detailed API documentation can be found in <a class="reference external" href="https://gitee.com/mindspore/federated/blob/master/docs/api/api_python_en/vertical/vertical_federated_FLModel.rst">Vertical Federated Training Interface</a>.</p>
<p>Both parties need to import the vertical federated training interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore_federated</span> <span class="kn">import</span> <span class="n">FLModel</span><span class="p">,</span> <span class="n">FLYamlData</span>
</pre></div>
</div>
<p>Leader participant vertical federated network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">leader_bottom_yaml_data</span> <span class="o">=</span> <span class="n">FLYamlData</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">leader_bottom_yaml_path</span><span class="p">)</span>
<span class="n">leader_top_yaml_data</span> <span class="o">=</span> <span class="n">FLYamlData</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">leader_top_yaml_path</span><span class="p">)</span>
<span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">leader_top_fl_model</span> <span class="o">=</span> <span class="n">FLModel</span><span class="p">(</span><span class="n">yaml_data</span><span class="o">=</span><span class="n">leader_top_yaml_data</span><span class="p">,</span>
                                   <span class="n">network</span><span class="o">=</span><span class="n">leader_top_train_net</span><span class="p">,</span>
                                   <span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
                                   <span class="n">eval_network</span><span class="o">=</span><span class="n">leader_top_eval_net</span><span class="p">)</span>
<span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">leader_bottom_fl_model</span> <span class="o">=</span> <span class="n">FLModel</span><span class="p">(</span><span class="n">yaml_data</span><span class="o">=</span><span class="n">leader_bottom_yaml_data</span><span class="p">,</span>
                                      <span class="n">network</span><span class="o">=</span><span class="n">leader_bottom_train_net</span><span class="p">,</span>
                                      <span class="n">eval_network</span><span class="o">=</span><span class="n">leader_bottom_eval_net</span><span class="p">)</span>
</pre></div>
</div>
<p>Follower participant vertical federated network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">follower_bottom_yaml_data</span> <span class="o">=</span> <span class="n">FLYamlData</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">follower_bottom_yaml_path</span><span class="p">)</span>
<span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">follower_bottom_fl_model</span> <span class="o">=</span> <span class="n">FLModel</span><span class="p">(</span><span class="n">yaml_data</span><span class="o">=</span><span class="n">follower_bottom_yaml_data</span><span class="p">,</span>
                                        <span class="n">network</span><span class="o">=</span><span class="n">follower_bottom_train_net</span><span class="p">,</span>
                                        <span class="n">eval_network</span><span class="o">=</span><span class="n">follower_bottom_eval_net</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vertical-training">
<h3>Vertical Training<a class="headerlink" href="#vertical-training" title="Permalink to this headline"></a></h3>
<p>For the process of vertical training, refer to <a class="reference internal" href="#overview"><span class="std std-doc">overview</span></a>.</p>
<p>Leader participant training process:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_iter</span><span class="p">):</span>
        <span class="n">leader_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader_bottom_fl_model</span><span class="o">.</span><span class="n">forward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leader_embedding</span><span class="p">)</span>
        <span class="n">follower_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="s2">&quot;follower&quot;</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="n">leader_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader_top_fl_model</span><span class="o">.</span><span class="n">forward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">follower_embedding</span><span class="p">)</span>
        <span class="n">grad_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader_top_fl_model</span><span class="o">.</span><span class="n">backward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">follower_embedding</span><span class="p">)</span>
        <span class="n">scale_name</span> <span class="o">=</span> <span class="s1">&#39;loss&#39;</span>
        <span class="o">...</span>
        <span class="n">grad_scale_follower</span> <span class="o">=</span> <span class="p">{</span><span class="n">scale_name</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grad_scale</span><span class="p">[</span><span class="n">scale_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">2</span><span class="p">:])}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">send_tensors</span><span class="p">(</span><span class="s2">&quot;follower&quot;</span><span class="p">,</span> <span class="n">grad_scale_follower</span><span class="p">)</span>
        <span class="n">grad_scale_leader</span> <span class="o">=</span> <span class="p">{</span><span class="n">scale_name</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">grad_scale</span><span class="p">[</span><span class="n">scale_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">2</span><span class="p">])}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leader_bottom_fl_model</span><span class="o">.</span><span class="n">backward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="n">grad_scale_leader</span><span class="p">)</span>
</pre></div>
</div>
<p>Follower participant training process:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_iter</span><span class="p">):</span>
        <span class="n">follower_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follower_bottom_fl_model</span><span class="o">.</span><span class="n">forward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">send_tensors</span><span class="p">(</span><span class="s2">&quot;leader&quot;</span><span class="p">,</span> <span class="n">follower_embedding</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertical_communicator</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="s2">&quot;leader&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">follower_bottom_fl_model</span><span class="o">.</span><span class="n">backward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data_join.html" class="btn btn-neutral float-left" title="Vertical Federated Learning Data Access" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="split_pangu_alpha_application.html" class="btn btn-neutral float-right" title="Vertical Federated Learning Model Training - Pangu Alpha Large Model Cross-Domain Training" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>