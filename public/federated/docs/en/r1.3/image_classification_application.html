<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementing an Image Classification Application (x86) &mdash; MindSpore master documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Implementing a Sentiment Classification Application (Android)" href="sentiment_classification_application.html" />
    <link rel="prev" title="On-Device Deployment" href="deploy_federated_client.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">On-Device Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementing an Image Classification Application (x86)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#downloading-the-dataset">Downloading the Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-network">Defining the Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-training-process">Defining the Training Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generating-a-device-model-file">Generating a Device Model File</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simulating-multi-client-participation-in-federated-learning">Simulating Multi-client Participation in Federated Learning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="security_and_privacy_protection.html">Model Security and Privacy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Implementing an Image Classification Application (x86)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/image_classification_application.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="implementing-an-image-classification-application-x86">
<h1>Implementing an Image Classification Application (x86)<a class="headerlink" href="#implementing-an-image-classification-application-x86" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.3/docs/federated/docs/source_en/image_classification_application.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png"></a></p>
<p>Before you start, check whether MindSpore has been correctly installed. If not, install MindSpore on your computer by referring to <a class="reference external" href="https://www.mindspore.cn/install/en">Install</a> on the MindSpore website.</p>
<section id="downloading-the-dataset">
<h2>Downloading the Dataset<a class="headerlink" href="#downloading-the-dataset" title="Permalink to this headline"></a></h2>
<p>You can refer to <a class="reference external" href="https://github.com/TalwalkarLab/leaf">LEAF: A Benchmark for Federated Settings</a>.</p>
<p>In this example, the federated learning dataset <code class="docutils literal notranslate"><span class="pre">FEMNIST</span></code> in the <code class="docutils literal notranslate"><span class="pre">leaf</span></code> dataset is used. The dataset contains 62 different types of handwritten digits and letters (digits 0 to 9, lowercase letters, and uppercase letters). The image size is 28 x 28 pixels, the dataset contains handwritten digits and letters of 3500 users (a maximum of 3500 clients can be simulated to participate in federated learning). The total data volume is 805,263, the average data volume of each user is 226.83, and the variance of the data volume of all users is 88.94.</p>
<ol class="arabic">
<li><p>Ensure that the following environment requirements are met:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.16.4
scipy<span class="w">                      </span><span class="c1"># conda install scipy</span>
<span class="nv">tensorflow</span><span class="o">==</span><span class="m">1</span>.13.1<span class="w">         </span><span class="c1"># pip install tensorflow</span>
Pillow<span class="w">                     </span><span class="c1"># pip install Pillow</span>
matplotlib<span class="w">                 </span><span class="c1"># pip install matplotlib</span>
jupyter<span class="w">                    </span><span class="c1"># conda install jupyter notebook==5.7.8 tornado==4.5.3</span>
pandas<span class="w">                     </span><span class="c1"># pip install pandas</span>
</pre></div>
</div>
</li>
<li><p>Download the dataset generation script from GitHub:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/TalwalkarLab/leaf.git
</pre></div>
</div>
<p>After the project is downloaded, the directory structure is as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf-master/data/femnist
├──<span class="w"> </span>data<span class="w">  </span><span class="c1"># Generated dataset</span>
├──<span class="w"> </span>preprocess<span class="w">  </span><span class="c1"># Code related to data preprocessing</span>
├──<span class="w"> </span>preprocess.sh<span class="w">  </span><span class="c1"># Shell script for generating the `femnist` dataset</span>
└──<span class="w"> </span>README.md<span class="w">  </span><span class="c1"># Official dataset download guide</span>
</pre></div>
</div>
</li>
<li><p>Take the <code class="docutils literal notranslate"><span class="pre">femnist</span></code> dataset as an example. Run the following command to go to the specified path:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w">  </span>leaf-master/data/femnist
</pre></div>
</div>
</li>
<li><p>According to the description in the <code class="docutils literal notranslate"><span class="pre">README.md</span></code> file, run the command on the device to download the corresponding dataset.</p>
<p>Run the <code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span></code> script. The options are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-s</span></code>: The value ‘iid’ indicates that data is sampled in iid mode. The value ‘niid’ indicates that data is sampled in niid mode.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--iu</span></code>: indicates the number of users (if iid sampling is performed). It is the fraction of the total number of users. The default value is 0.01.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sf</span></code>: indicates the data to be sampled, in decimal number. The default value is 0.1.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-k</span></code>: indicates the minimum number of samples for each user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-t</span></code>: The value ‘user’ indicates that users are divided into training test groups. The value ‘sample’ indicates that samples of each user are divided into training test groups.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--tf</span></code>: indicates the data in the training dataset, in decimal number. The default value is 0.9.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--smplseed</span></code>: indicates the seed to be used before random data sampling.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--spltseed</span></code>: indicates the seed to be used before random data splits.</p></li>
</ul>
<p>Examples:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">1.0</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code>: downloads a complete dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">0.05</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code>: downloads a small dataset.</p></li>
</ul>
<p>Before running the preprocess.sh script again, ensure that the rem_user_data, sampled_data, test, and train subfolders are deleted from the data directory.</p>
</li>
<li><p>For example, run the command <code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">1.0</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code> to generate a dataset containing data of 3500 users, and split data of each user into a training dataset and a test dataset at 9:1.</p>
<p>The directory structure is as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf-master/data/femnist/35_client_sf1_data/
├──<span class="w"> </span>all_data<span class="w">  </span><span class="c1"># All datasets are mixed together. There are 35 JSON files in total, and each JSON file contains the data of 100 users.</span>
├──<span class="w"> </span><span class="nb">test</span><span class="w">  </span><span class="c1"># Test dataset obtained after splitting the data of each user into the training and test datasets at 9:1. There are 35 JSON files in total, and each JSON file contains the data of 100 users.</span>
├──<span class="w"> </span>train<span class="w">  </span><span class="c1"># Test dataset obtained after splitting the data of each user into the training and test datasets at 9:1. There are 35 JSON files in total, and each JSON file contains the data of 100 users.</span>
└──<span class="w"> </span>...<span class="w">  </span><span class="c1"># Other files are not involved and are not described here.</span>
</pre></div>
</div>
<p>Each JSON file consists of the following parts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">users</span></code>: user list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: sample quantity list of each user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: a dictionary object with the username as the key and their data as the value. For each user, the data is represented as an image list, and each image is represented as an integer list whose size is 784 (obtained by flattening the 28 x 28 image array).</p></li>
</ul>
</li>
<li><p>Split 35 JSON files into 3500 JSON files (each JSON file represents a user).</p>
<p>The sample code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">partition_json</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">new_root_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    partition 35 json files to 3500 json file</span>

<span class="sd">    Each raw .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;users&#39;, a list of users</span>
<span class="sd">    2. &#39;num_samples&#39;, a list of the number of samples for each user</span>
<span class="sd">    3. &#39;user_data&#39;, an object with user names as keys and their respective data as values; for each user, data is represented as a list of images, with each image represented as a size-784 integer list (flattened from 28 by 28)</span>

<span class="sd">    Each new .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;user_name&#39;, the name of user</span>
<span class="sd">    2. &#39;num_samples&#39;, the number of samples for the user</span>
<span class="sd">    3. &#39;user_data&#39;, an dict object with &#39;x&#39; as keys and their respective data as values; with &#39;y&#39; as keys and their respective label as values;</span>

<span class="sd">    Args:</span>
<span class="sd">        root_path (str): raw root path of 35 json files</span>
<span class="sd">        new_root_path (str): new root path of 3500 json files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">file_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======== process &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;======================&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f</span><span class="p">:</span>
            <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f</span><span class="p">)</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
            <span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---processing user: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;---&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;num_samples&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">cur_user_id</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_data_num</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">,</span> <span class="n">cur_user_id</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_user_id</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_data_num</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="n">cur_user_id</span><span class="p">])</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cur_user_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cur_out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s1">&#39; users have been processed!&#39;</span><span class="p">)</span>
<span class="c1"># partition train json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf-master/data/femnist/35_client_sf1_data/train&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf-master/data/femnist/3500_client_json/train&quot;</span><span class="p">)</span>
<span class="c1"># partition test json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf-master/data/femnist/35_client_sf1_data/test&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf-master/data/femnist/3500_client_json/test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the preceding command, <code class="docutils literal notranslate"><span class="pre">root_path</span></code> is set to <code class="docutils literal notranslate"><span class="pre">leaf-master/data/femnist/35_client_sf1_data/{train,test}</span></code>, and <code class="docutils literal notranslate"><span class="pre">new_root_path</span></code> is set to a user-defined value to store the generated 3500 JSON files. The training and test folders need to be processed separately.</p>
<p>A total of 3500 JSON files are generated. Each file contains the following parts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">user_name</span></code>: username.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: number of user samples.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: a dictionary object that uses ‘x’ as the key and user data as the value; uses ‘y’ as the key and the label corresponding to the user data as the value.</p></li>
</ul>
<p>If the following information is displayed, the script is successfully executed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">========</span><span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>file:<span class="w"> </span>/leaf-master/data/femnist/35_client_sf1_data/train/all_data_16_niid_0_keep_0_train_9.json<span class="o">======================</span>
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">1</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">2</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">3</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">4</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">5</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">6</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">7</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">8</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">9</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">10</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">11</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">12</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">13</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">14</span>---
......
</pre></div>
</div>
</li>
<li><p>Convert the JSON file to an image file.</p>
<p>For details, see the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span>
             <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span>
             <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span>
             <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span>
             <span class="p">]</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">json_2_numpy</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read json file to numpy</span>
<span class="sd">    Args:</span>
<span class="sd">        img_size (list): contain three elements: the height, width, channel of image</span>
<span class="sd">        file_path (str): root path of 3500 json files</span>
<span class="sd">    return:</span>
<span class="sd">        image_numpy (numpy)</span>
<span class="sd">        label_numpy (numpy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># open json file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f_train</span><span class="p">:</span>
        <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f_train</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">image_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>  <span class="c1"># mindspore doesn&#39;t support float64 and int64</span>
        <span class="n">label_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_numpy</span><span class="p">,</span> <span class="n">label_numpy</span>

<span class="k">def</span> <span class="nf">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform single json file to images</span>

<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the path json file</span>
<span class="sd">        save_path (str): the root path to save images</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">json_2_numpy</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">json_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span>  <span class="c1"># PIL don&#39;t support the 0/1 image ,need convert to 0~255 image</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
        <span class="n">img_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name_list</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">img_name</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;-----&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">all_json_2_img</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">save_root_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform json files to images</span>
<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the root path of 3500 json files</span>
<span class="sd">        save_path (str): the root path to save images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">files_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">user_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">save_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_root_path</span><span class="p">,</span> <span class="n">user_name</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path1</span><span class="p">)</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=============================&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;=======================&#39;</span><span class="p">)</span>
            <span class="n">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>

<span class="n">all_json_2_img</span><span class="p">(</span><span class="s2">&quot;leaf-master/data/femnist/3500_client_json/&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf-master/data/femnist/3500_client_img/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the following information is displayed, the script is successfully executed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">=============================</span>f0644_19.json<span class="o">=======================</span>
-----<span class="w"> </span><span class="m">0</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">2</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">3</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">4</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">5</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">6</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">7</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">8</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">9</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">10</span><span class="w"> </span>-----
......
</pre></div>
</div>
</li>
<li><p>Convert the image dataset into a .bin file format available to the federated learning framework.</p>
<p>For details, see the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">tC</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision.py_transforms</span> <span class="k">as</span> <span class="nn">PV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.py_transforms</span> <span class="k">as</span> <span class="nn">PT</span>
<span class="kn">import</span> <span class="nn">mindspore</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count_id</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ids</span>

<span class="k">def</span> <span class="nf">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; create dataset for train or test</span>
<span class="sd">        Args:</span>
<span class="sd">            data_path: Data path</span>
<span class="sd">            batch_size: The number of data records in each group</span>
<span class="sd">            repeat_size: The number of replicated data records</span>
<span class="sd">            num_parallel_workers: The number of parallel workers</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">count_id</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ImageFolderDataset</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_indexing</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
    <span class="c1"># define operation parameters</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 32</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Decode</span><span class="p">(),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">)),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="p">]</span>
    <span class="n">compose</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="c1"># apply map operations on images</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">tC</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mindspore</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">compose</span><span class="p">)</span>

    <span class="c1"># apply DatasetOps</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>  <span class="c1"># 10000 as in LeNet train script</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="k">def</span> <span class="nf">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform images to bin files</span>

<span class="sd">    Args:</span>
<span class="sd">    root_path: the root path of 3500 images files</span>
<span class="sd">    root_save: the root path to save bin files</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">root_save</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">use_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">train_test</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">user_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">train_test</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_path</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">batch_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">():</span>
                <span class="n">batch_x_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="n">batch_y_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">trans_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">batch_x_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans_img</span><span class="p">)</span>
                <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_y_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                <span class="n">batch_num</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                <span class="n">train_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="n">test_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>

            <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>  <span class="c1"># (batch_num, 32,3,32,32)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
            <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_save</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_data.bin&quot;</span><span class="p">)</span>
            <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_label.bin&quot;</span><span class="p">)</span>

            <span class="n">imgs</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">label_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user: &quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_batch_num: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">use_list</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; users finished!&quot;</span><span class="p">)</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="s2">&quot;leaf-master/data/femnist/3500_client_img/&quot;</span>
<span class="n">root_save</span> <span class="o">=</span> <span class="s2">&quot;leaf-master/data/femnist/3500_clients_bin&quot;</span>
<span class="n">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">)</span>
</pre></div>
</div>
<p>If the following information is displayed, the script is successfully executed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>user:<span class="w"> </span>f0141_43<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0141_43<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">10</span>
user:<span class="w"> </span>f0137_14<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0137_14<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">11</span>
user:<span class="w"> </span>f0049_32<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0049_32<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">11</span>
user:<span class="w"> </span>f0178_39<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0178_39<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">9</span>
user:<span class="w"> </span>f0222_06<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0222_06<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">9</span>
......
total<span class="w"> </span><span class="m">3500</span><span class="w"> </span>users<span class="w"> </span>finished!
</pre></div>
</div>
</li>
<li><p>The 3500_clients_bin folder contains 3500 user folders. The directory structure is as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf-master/data/femnist/3500_clients_bin
├──<span class="w"> </span>f0000_14<span class="w">  </span><span class="c1"># User ID.</span>
│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_10_train_data.bin<span class="w">  </span><span class="c1"># Training data of user f0000_14 (The number 10 following bn_ indicates the batch number.)</span>
│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_10_train_label.bin<span class="w">  </span><span class="c1"># Training label of user f0000_14.</span>
│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_1_test_data.bin<span class="w">  </span><span class="c1"># Test data of user f0000_14 (The number 1 following bn_ indicates the batch number.)</span>
│<span class="w">   </span>└──<span class="w"> </span>f0000_14_bn_1_test_label.bin<span class="w">  </span><span class="c1"># Training label of user f0000_14.</span>
├──<span class="w"> </span>f0001_41<span class="w">  </span><span class="c1"># User ID.</span>
│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_11_train_data.bin<span class="w">  </span><span class="c1"># Training data of user f0001_41 (The number 11 following bn_ indicates the batch number.)</span>
│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_11_train_label.bin<span class="w">  </span><span class="c1"># Training label of user f0001_41.</span>
│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_1_test_data.bin<span class="w">  </span><span class="c1"># Test data of user f0001_41 (The number 1 following bn_ indicates the batch number.)</span>
│<span class="w">   </span>└──<span class="w"> </span>f0001_41_bn_1_test_label.bin<span class="w">  </span><span class="c1"># Test label of user f0001_41.</span>
│
│
│<span class="w">                    </span>...
│
│
└──<span class="w"> </span>f4099_10<span class="w">  </span><span class="c1"># User ID.</span>
<span class="w">    </span>├──<span class="w"> </span>f4099_10_bn_4_train_data.bin<span class="w">  </span><span class="c1"># Training data of user f4099_10 (The number 4 following bn_ indicates the batch number.)</span>
<span class="w">    </span>├──<span class="w"> </span>f4099_10_bn_4_train_label.bin<span class="w">  </span><span class="c1"># Training label of user f4099_10.</span>
<span class="w">    </span>├──<span class="w"> </span>f4099_10_bn_1_test_data.bin<span class="w">  </span><span class="c1"># Test data of user f4099_10 (The number 1 following bn_ indicates the batch number.)</span>
<span class="w">    </span>└──<span class="w"> </span>f4099_10_bn_1_test_label.bin<span class="w">  </span><span class="c1"># Test label of user f4099_10.</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="defining-the-network">
<h2>Defining the Network<a class="headerlink" href="#defining-the-network" title="Permalink to this headline"></a></h2>
<p>The LeNet network is relatively simple. In addition to the input layer, the LeNet network has seven layers, including two convolutional layers, two down-sample layers (pooling layers), and three full connection layers. Each layer contains different numbers of training parameters, as shown in the following figure:</p>
<p><img alt="LeNet5" src="_images/LeNet_5.jpg" /></p>
<blockquote>
<div><p>For details about the LeNet network, visit <a class="reference external" href="http://yann.lecun.com/exdb/lenet/">http://yann.lecun.com/exdb/lenet/</a>.</p>
</div></blockquote>
<p>For the network defining process, see the <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py</a>.</p>
<p>For more details, see the <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/quick_start/quick_start.html#%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C">MindSpore Image Classification Task</a>.</p>
</section>
<section id="defining-the-training-process">
<h2>Defining the Training Process<a class="headerlink" href="#defining-the-training-process" title="Permalink to this headline"></a></h2>
<p>For details, see the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore.context</span> <span class="k">as</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">TrainOneStepCell</span><span class="p">,</span> <span class="n">WithLossCell</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">LeNet5</span>
<span class="kn">from</span> <span class="nn">src.adam</span> <span class="kn">import</span> <span class="n">AdamWeightDecayOp</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;test_fl_lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_target&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;FEDERATED_LEARNING&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ms_role&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;MS_WORKER&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--worker_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_ip&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8113</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_server_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6666</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start_fl_job_threshold&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start_fl_job_time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--update_model_ratio&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--update_model_time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_iteration_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_epoch_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_manage_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">11202</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">device_target</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device_target</span>
<span class="n">server_mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_mode</span>
<span class="n">ms_role</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ms_role</span>
<span class="n">worker_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">worker_num</span>
<span class="n">server_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_num</span>
<span class="n">scheduler_ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_ip</span>
<span class="n">scheduler_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_port</span>
<span class="n">fl_server_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_server_port</span>
<span class="n">start_fl_job_threshold</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_fl_job_threshold</span>
<span class="n">start_fl_job_time_window</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_fl_job_time_window</span>
<span class="n">update_model_ratio</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">update_model_ratio</span>
<span class="n">update_model_time_window</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">update_model_time_window</span>
<span class="n">fl_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_name</span>
<span class="n">fl_iteration_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_iteration_num</span>
<span class="n">client_epoch_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_epoch_num</span>
<span class="n">client_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_batch_size</span>
<span class="n">client_learning_rate</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_learning_rate</span>
<span class="n">scheduler_manage_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_manage_port</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;enable_fl&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;server_mode&quot;</span><span class="p">:</span> <span class="n">server_mode</span><span class="p">,</span>
    <span class="s2">&quot;ms_role&quot;</span><span class="p">:</span> <span class="n">ms_role</span><span class="p">,</span>
    <span class="s2">&quot;worker_num&quot;</span><span class="p">:</span> <span class="n">worker_num</span><span class="p">,</span>
    <span class="s2">&quot;server_num&quot;</span><span class="p">:</span> <span class="n">server_num</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_ip&quot;</span><span class="p">:</span> <span class="n">scheduler_ip</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_port&quot;</span><span class="p">:</span> <span class="n">scheduler_port</span><span class="p">,</span>
    <span class="s2">&quot;fl_server_port&quot;</span><span class="p">:</span> <span class="n">fl_server_port</span><span class="p">,</span>
    <span class="s2">&quot;start_fl_job_threshold&quot;</span><span class="p">:</span> <span class="n">start_fl_job_threshold</span><span class="p">,</span>
    <span class="s2">&quot;start_fl_job_time_window&quot;</span><span class="p">:</span> <span class="n">start_fl_job_time_window</span><span class="p">,</span>
    <span class="s2">&quot;update_model_ratio&quot;</span><span class="p">:</span> <span class="n">update_model_ratio</span><span class="p">,</span>
    <span class="s2">&quot;update_model_time_window&quot;</span><span class="p">:</span> <span class="n">update_model_time_window</span><span class="p">,</span>
    <span class="s2">&quot;fl_name&quot;</span><span class="p">:</span> <span class="n">fl_name</span><span class="p">,</span>
    <span class="s2">&quot;fl_iteration_num&quot;</span><span class="p">:</span> <span class="n">fl_iteration_num</span><span class="p">,</span>
    <span class="s2">&quot;client_epoch_num&quot;</span><span class="p">:</span> <span class="n">client_epoch_num</span><span class="p">,</span>
    <span class="s2">&quot;client_batch_size&quot;</span><span class="p">:</span> <span class="n">client_batch_size</span><span class="p">,</span>
    <span class="s2">&quot;client_learning_rate&quot;</span><span class="p">:</span> <span class="n">client_learning_rate</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_manage_port&quot;</span><span class="p">:</span> <span class="n">scheduler_manage_port</span>
<span class="p">}</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">device_target</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_fl_context</span><span class="p">(</span><span class="o">**</span><span class="n">ctx</span><span class="p">)</span>               <span class="c1"># Sets parameters related to the federated learning training process.</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">net_adam_opt</span> <span class="o">=</span> <span class="n">AdamWeightDecayOp</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">net_with_criterion</span> <span class="o">=</span> <span class="n">WithLossCell</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
    <span class="n">train_network</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net_with_criterion</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">)</span>
    <span class="n">train_network</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_network</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
<p>In the dictionary <code class="docutils literal notranslate"><span class="pre">ctx</span></code>, the <code class="docutils literal notranslate"><span class="pre">enable_fl</span></code> parameter is used to set whether to start the federated learning training process. If the value is <code class="docutils literal notranslate"><span class="pre">true</span></code>, the federated learning process is started. If the value is <code class="docutils literal notranslate"><span class="pre">false</span></code>, the common training process is started. Other parameters can be set based on the actual situations. Only available model files need to be generated. In the preceding script, <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code> use the simulation data.</p>
<p>In the preceding information, <code class="docutils literal notranslate"><span class="pre">src.model</span></code> is the model definition file. For details, see the <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py file</a>. <code class="docutils literal notranslate"><span class="pre">src.adam</span></code> is the optimizer definition file. For details, see the <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/adam.py">adam.py file</a>.</p>
<p>For details about the definition of the optimizer loss function, see the <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/quick_start/quick_start.html#%E5%AE%9A%E4%B9%89%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E5%8F%8A%E4%BC%98%E5%8C%96%E5%99%A8">MindSpore official document</a>.</p>
</section>
<section id="generating-a-device-model-file">
<h2>Generating a Device Model File<a class="headerlink" href="#generating-a-device-model-file" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p><strong>Export a model as a MindIR file.</strong></p>
<p>You can add the <code class="docutils literal notranslate"><span class="pre">export</span></code> statement to the training process code in <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py</a> to obtain the MindIR model file. The sample code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">export</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_network</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">mindir_name</span> <span class="o">=</span> <span class="s2">&quot;lenet_train.mindir&quot;</span>
        <span class="n">export</span><span class="p">(</span><span class="n">train_network</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span> <span class="n">mindir_name</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>  <span class="c1"># Add the export statement to obtain the model file in MindIR format.</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
<p>When generating a MindIR format model file, you need to comment the statement <code class="docutils literal notranslate"><span class="pre">context.set_fl_context(**ctx)</span></code> in the  <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py</a> file, and set <code class="docutils literal notranslate"><span class="pre">epoch</span></code> to 1. Running <code class="docutils literal notranslate"><span class="pre">model.py</span></code> requires <a class="reference external" href="https://www.mindspore.cn/install/en">MindSpore</a> to be installed in the environment . The file <code class="docutils literal notranslate"><span class="pre">lenet_train.mindir</span></code> will be generated in the current path after running the script <code class="docutils literal notranslate"><span class="pre">model.py</span></code>.</p>
<p>For details, see <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.3/save_model.html?highlight=mindir#mindir">here</a>.</p>
</li>
<li><p><strong>Convert the MindIR file into an .ms file that can be used by the federated learning framework on the device.</strong></p>
<p>For details about model conversion, see <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r1.3/use/converter_train.html">Training Model Conversion Tutorial</a>.</p>
<p>The following is an example of model conversion:</p>
<p>Assume that the model file to be converted is <code class="docutils literal notranslate"><span class="pre">lenet_train.mindir</span></code>. Run the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>MINDIR<span class="w"> </span>--trainModel<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--modelFile<span class="o">=</span>lenet_train.mindir<span class="w"> </span>--outputFile<span class="o">=</span>lenet_train
</pre></div>
</div>
<p>If the conversion is successful, the following information is displayed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERTER<span class="w"> </span>RESULT<span class="w"> </span>SUCCESS:0
</pre></div>
</div>
<p>This indicates that the MindSpore model is successfully converted to the MindSpore device model and the new file <code class="docutils literal notranslate"><span class="pre">lenet_train.ms</span></code> is generated. If the conversion fails, the following information is displayed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERT<span class="w"> </span>RESULT<span class="w"> </span>FAILED:
</pre></div>
</div>
<p>Save the generated model file in <code class="docutils literal notranslate"><span class="pre">.ms</span></code> format to a path. When the federated learning API is called, FLParameter.trainModelPath can be set to the path of the model file.</p>
</li>
</ol>
</section>
<section id="simulating-multi-client-participation-in-federated-learning">
<h2>Simulating Multi-client Participation in Federated Learning<a class="headerlink" href="#simulating-multi-client-participation-in-federated-learning" title="Permalink to this headline"></a></h2>
<p>You can write a Python script to call the JAR package of the federated learning framework. (For details about how to obtain the JAR package in the x86 environment, see <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/federated/docs/source_en/deploy_federated_client.md">Building a Package</a> in the Federated-Client deployment tutorial.</p>
<ol class="arabic">
<li><p><strong>Take the Lenet network as an example. The reference script <code class="docutils literal notranslate"><span class="pre">run.py</span></code> is as follows:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run TestClient.java case&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--jarPath&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mindspore-lite-java-flclient.jar&quot;</span><span class="p">)</span>  <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_dataset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;leaf-master/data/femnist/3500_clients_bin/&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_dataset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--vocal_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ids_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--flName&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_model_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="p">)</span>    <span class="c1"># must be absolute path of .ms files</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--infer_model_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="p">)</span>    <span class="c1"># must be absolute path of .ms files</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ip&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10.113.216.106&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6668</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_elb&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_https&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cert_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--task&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">jarPath</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">jarPath</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_dataset</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_dataset</span>
<span class="n">vocal_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">vocal_file</span>
<span class="n">ids_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ids_file</span>
<span class="n">flName</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">flName</span>
<span class="n">train_model_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_model_path</span>
<span class="n">infer_model_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">infer_model_path</span>
<span class="n">ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ip</span>
<span class="n">ssl</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ssl</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span>
<span class="n">server_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_num</span>
<span class="n">client_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_num</span>
<span class="n">time_window</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">time_window</span><span class="p">)</span>
<span class="n">use_elb</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_elb</span>
<span class="n">use_https</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_https</span>
<span class="n">cert_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cert_path</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">task</span>

<span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_client_data_path</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">use_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">bin_file_paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">use_path</span><span class="p">)</span>

    <span class="n">train_data_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_label_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_batch_num</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">test_data_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">test_label_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">test_batch_num</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bin_file_paths</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
            <span class="n">train_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">train_batch_num</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
            <span class="n">train_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
            <span class="n">test_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">test_batch_num</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
            <span class="n">test_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">train_path</span> <span class="o">=</span> <span class="n">train_data_path</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">train_label_path</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="n">test_data_path</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">test_label_path</span>
    <span class="k">return</span> <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">train_batch_num</span><span class="p">,</span> <span class="n">test_batch_num</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">client_num</span><span class="p">):</span>
    <span class="n">clientID</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="n">get_client_data_path</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;client id: &quot;</span><span class="p">,</span> <span class="n">clientID</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train path: &quot;</span><span class="p">,</span> <span class="n">train_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test path: &quot;</span><span class="p">,</span> <span class="n">test_path</span><span class="p">)</span>

    <span class="n">cmd_client</span> <span class="o">=</span> <span class="s2">&quot;execute_path=$(pwd) &amp;&amp; self_path=$(dirname </span><span class="se">\&quot;</span><span class="s2">$</span><span class="si">{script_self}</span><span class="se">\&quot;</span><span class="s2">) &amp;&amp; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;rm -rf $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ &amp;&amp;&quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;mkdir $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ &amp;&amp;&quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;cd $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ || exit &amp;&amp;&quot;</span>

    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;java -jar &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">jarPath</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">train_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">vocal_file</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ids_file</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">test_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">flName</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">train_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model path: &quot;</span><span class="p">,</span> <span class="n">train_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">infer_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model path: &quot;</span><span class="p">,</span> <span class="n">infer_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">clientID</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ip</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ssl</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">time_window</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">use_elb</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">use_https</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">cert_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">task</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot; &gt; client&quot;</span> <span class="o">+</span> <span class="s2">&quot;.log 2&gt;&amp;1 &amp;&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd_client</span><span class="p">])</span>
</pre></div>
</div>
<p>The input parameters in the run.py script are described as follows and can be set based on the actual situations:</p>
<p>Absolute paths must be provided for the following paths:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--jarPath</span></code></strong></p>
<p>Specifies the path of the federated learning JAR package. For details about how to obtain the JAR package in the x86 environment, see <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/federated/docs/source_en/deploy_federated_client.md">Building a Package</a> in the Federated-Client deployment tutorial.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--train_dataset</span></code></strong></p>
<p>Specifies the root path of the training dataset.The sentiment classification task stores the training data (in .txt format) of each client. The LeNet image classification task stores the training files data.bin and label.bin of each client, for example, <code class="docutils literal notranslate"><span class="pre">leaf-master/data/femnist/3500_clients_bin/</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--test_dataset</span></code></strong></p>
<p>Specifies the test dataset path. For LeNet image classification tasks, this parameter does not need to be set and the default value is null. For sentiment classification tasks, if this parameter is not set, validation is not performed during training.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--vocal_file</span></code></strong></p>
<p>Specifies the path of the dictionary file for data preprocessing. Set the value to null for LeNet, or set the value to the actual absolute path for the sentiment classification task.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--ids_file</span></code></strong></p>
<p>Specifies the path of the dictionary mapping ID. Set the value to null for LeNet, or set the value to the actual absolute path for the sentiment classification task.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--flName</span></code></strong></p>
<p>Specifies the name of the federated learning model. Currently, only <code class="docutils literal notranslate"><span class="pre">lenet</span></code> (using the LeNet for image classification tasks) and <code class="docutils literal notranslate"><span class="pre">albert</span></code> (using the Albert network for sentiment classification tasks) are supported.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--train_model_path</span></code></strong></p>
<p>Specifies the training model path used for federated learning. The path is the directory where multiple .ms files copied in the preceding tutorial are stored, for example, <code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code>. The path must be an absolute path.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--infer_model_path</span></code></strong></p>
<p>Specifies the path of the inference model used by federated learning. It is the absolute path of the model file in .ms format. This parameter is mandatory for sentiment classification tasks, and can be set to the value of train_model_path for LeNet image classification tasks.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--ip</span></code></strong></p>
<p>Specifies the IP address of the server. The format is 10.113.216.106. Currently, the cloud supports only the HTTP communication mode. The HTTP communication mode is used by default.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--ssl</span></code></strong></p>
<p>Determines whether to perform SSL certificate authentication for device-cloud communication. SSL certificate authentication is used only for HTTPS communication. If this parameter is set to false, SSL certificate authentication is not performed. If this parameter is set to true, SSL certificate authentication is performed only in HTTPS communication mode. In this case, <code class="docutils literal notranslate"><span class="pre">useHttps</span></code> must be set to true, and <code class="docutils literal notranslate"><span class="pre">cert_path</span></code> must be set to a specific certificate path. The default value is false.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--port</span></code></strong></p>
<p>Specifies the port number. The value must be the same as the value of the <code class="docutils literal notranslate"><span class="pre">fl_server_port</span></code> parameter used when the server is started. The format is 6668.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--time_window</span></code></strong></p>
<p>Specifies the total time window for repeated requests on the device. The value must be the same as the sum of <code class="docutils literal notranslate"><span class="pre">start_fl_job_time_windows</span></code> and <code class="docutils literal notranslate"><span class="pre">update_model_time_windows</span></code> when the server is started.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--server_num</span></code></strong></p>
<p>Specifies the number of servers. The value must be the same as the value of <code class="docutils literal notranslate"><span class="pre">server_num</span></code> when the server is started. This parameter is used to simulate the scenario where the client randomly selects different servers to send messages. This parameter is not required in actual scenarios.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--client_num</span></code></strong></p>
<p>Specifies the number of clients. The value must be the same as that of <code class="docutils literal notranslate"><span class="pre">start_fl_job_cnt</span></code> when the server is started. This parameter is not required in actual scenarios.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--use_elb</span></code></strong></p>
<p>Applies to the multi-server scenario. If the value is true, each round request of the client uses a random port within the specified range. If the value is false, a fixed port is used. The default value is false. If the value of <code class="docutils literal notranslate"><span class="pre">server_num</span></code> is greater than 1, set this parameter to true. Simulates a client to randomly select different servers to send messages. This parameter is not required in actual scenarios.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--use_https</span></code></strong></p>
<p>Determines whether to perform HTTPS communication for device-cloud communication. The value false indicates that HTTP communication is performed. The value true indicates that HTTPS communication is performed. The default value is false.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--cert_path</span></code></strong></p>
<p>Specifies the absolute path of the certificate. This parameter is mandatory when <code class="docutils literal notranslate"><span class="pre">--ssl</span></code> is set to true. The default value is <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--task</span></code></strong></p>
<p>Specifies the type of the task to be started. <code class="docutils literal notranslate"><span class="pre">train</span></code> indicates that a training task is started. <code class="docutils literal notranslate"><span class="pre">inference</span></code> indicates that multiple data inference tasks are started. <code class="docutils literal notranslate"><span class="pre">getModel</span></code> indicates that the task for obtaining the cloud model is started. Other character strings indicate that the inference task of a single data record is started. The default value is <code class="docutils literal notranslate"><span class="pre">train</span></code>. The initial model file (.ms file) is not trained. Therefore, you are advised to start the training task first. After the training is complete, start the inference task. (Note that the values of client_num in the two startups must be the same to ensure that the model file used by <code class="docutils literal notranslate"><span class="pre">inference</span></code> is the same as that used by <code class="docutils literal notranslate"><span class="pre">train</span></code>.)</p>
</li>
</ul>
</li>
<li><p><strong>Prepare a model file for the client.</strong></p>
<p>In the actual scenario, a client contains a model file in .ms format. In the simulation scenario, you need to copy multiple .ms files and name them in <code class="docutils literal notranslate"><span class="pre">lenet_train{i}.ms</span></code> format. In the format, i indicates the client ID. Due to the script settings in <code class="docutils literal notranslate"><span class="pre">run.py</span></code>, i must be set to a number, such as <code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">5...</span></code>. Each client uses an .ms file.</p>
<p>You can copy and name the original .ms file by referring to the following steps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span><span class="n">new_path</span><span class="p">,</span><span class="n">copy_num</span><span class="p">):</span>
    <span class="c1"># Copy the specified number of files from the raw path to the new path</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">copy_num</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span>
        <span class="n">new_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">raw_path</span> <span class="p">,</span><span class="n">new_file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;====== copying &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39; file ======&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the number of copy .ms files: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="s2">&quot;lenet_train.ms&quot;</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;ms/lenet&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</pre></div>
</div>
<p>Set <code class="docutils literal notranslate"><span class="pre">raw_path</span></code> to the path of the original .ms file, <code class="docutils literal notranslate"><span class="pre">new_path</span></code> to the path of the .ms file to be copied, and <code class="docutils literal notranslate"><span class="pre">num</span></code> to the number of copies. Generally, you need to simulate the number of started clients.</p>
<p>For example, in the preceding script, the .ms file is generated in the <code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code> directory for five clients. The directory structure is as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ms/lenet
├──<span class="w"> </span>lenet_train0.ms<span class="w">  </span><span class="c1"># .ms file used by client 0.</span>
├──<span class="w"> </span>lenet_train1.ms<span class="w">  </span><span class="c1"># .ms file used by client 1.</span>
├──<span class="w"> </span>lenet_train2.ms<span class="w">  </span><span class="c1"># .ms file used by client 2.</span>
├──<span class="w"> </span>lenet_train3.ms<span class="w">  </span><span class="c1"># .ms file used by client 3.</span>
└──<span class="w"> </span>lenet_train4.ms<span class="w">  </span><span class="c1"># .ms file used by client 4.</span>
</pre></div>
</div>
</li>
<li><p><strong>Start the client.</strong></p>
<p>Before starting the client, please refer to the section <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.3/deploy_federated_client.html">x86</a> in the Federated-Client deployment tutorial for deployment of device environment .</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">run.py</span></code> as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run.py<span class="w"> </span>--ip<span class="o">=</span><span class="m">10</span>.113.216.106<span class="w"> </span>--port<span class="o">=</span><span class="m">6668</span><span class="w"> </span>--server_num<span class="o">=</span><span class="m">8</span><span class="w">  </span>--client_num<span class="o">=</span><span class="m">5</span><span class="w"> </span>--task<span class="o">=</span>train
</pre></div>
</div>
<p>This command indicates that five clients are started to participate in federated learning. If the startup is successful, log files corresponding to the five clients are generated in the current folder. You can view the log files to learn the running status of each client.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./
├──<span class="w"> </span>client_0
│<span class="w">   </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 0.</span>
├──<span class="w"> </span>client_1
│<span class="w">   </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 1.</span>
├──<span class="w"> </span>client_2
<span class="w"> </span>│<span class="w">   </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 2.</span>
├──<span class="w"> </span>client_3
│<span class="w">   </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 3.</span>
└──<span class="w"> </span>lenet_train4.ms
<span class="w">    </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 4.</span>
</pre></div>
</div>
</li>
<li><p><strong>Stop the client process.</strong></p>
<p>For details, see the <code class="docutils literal notranslate"><span class="pre">finish.py</span></code> script. The details are as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Finish test_mobile_lenet.py case&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--kill_tag&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mindspore-lite-java-flclient&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">kill_tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kill_tag</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;pid=`ps -ef|grep &quot;</span> <span class="o">+</span> <span class="n">kill_tag</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot; |grep -v </span><span class="se">\&quot;</span><span class="s2">grep</span><span class="se">\&quot;</span><span class="s2"> | grep -v </span><span class="se">\&quot;</span><span class="s2">finish</span><span class="se">\&quot;</span><span class="s2"> |awk &#39;{print $2}&#39;` &amp;&amp; &quot;</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;for id in $pid; do kill -9 $id &amp;&amp; echo </span><span class="se">\&quot;</span><span class="s2">killed $id</span><span class="se">\&quot;</span><span class="s2">; done&quot;</span>

<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">])</span>
</pre></div>
</div>
<p>Run the following command to shut down the client:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finish.py<span class="w"> </span>--kill_tag<span class="o">=</span>mindspore-lite-java-flclient
</pre></div>
</div>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">--kill_tag</span></code> is used to search for the keyword to kill the client process. You only need to set the special keyword in <code class="docutils literal notranslate"><span class="pre">--jarPath</span></code>. The default value is <code class="docutils literal notranslate"><span class="pre">mindspore-lite-java-flclient</span></code>, that is, the name of the federated learning JAR package.</p>
<p>Assume that five clients are started and each client contains a Python process and a Java process. The following information is displayed if the clients are successfully shut down:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>killed<span class="w"> </span><span class="m">56427</span>
killed<span class="w"> </span><span class="m">56432</span>
killed<span class="w"> </span><span class="m">56435</span>
killed<span class="w"> </span><span class="m">56444</span>
killed<span class="w"> </span><span class="m">56449</span>
killed<span class="w"> </span><span class="m">56451</span>
killed<span class="w"> </span><span class="m">56452</span>
killed<span class="w"> </span><span class="m">56461</span>
killed<span class="w"> </span><span class="m">56465</span>
killed<span class="w"> </span><span class="m">56474</span>
</pre></div>
</div>
<p>That is, 10 processes are successfully killed.</p>
</li>
<li><p><strong>View the experimental result.</strong></p>
<p>Currently, the <strong><code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code></strong> folder contains data of 3500 clients. This script can simulate a maximum of 3500 clients to participate in federated learning.</p>
<p>The following figure shows the accuracy of the test dataset for federated learning on 50 clients (set <code class="docutils literal notranslate"><span class="pre">server_num</span></code> to 16).</p>
<p><img alt="lenet_50_clients_acc" src="_images/lenet_50_clients_acc.png" /></p>
<p>The total number of federated learning iterations is 100, the number of epochs for local training on the client is 20, and the value of batchSize is 32.</p>
<p>The test accuracy in the figure refers to the accuracy of each client test dataset on the aggregated model on the cloud for each federated learning iteration:</p>
<p>AVG: average accuracy of 50 client test datasets</p>
<p>TOP5: average accuracy of the five clients with the highest accuracy in the test dataset</p>
<p>LOW5: average accuracy of the five clients with the lowest accuracy in the test dataset</p>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="deploy_federated_client.html" class="btn btn-neutral float-left" title="On-Device Deployment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sentiment_classification_application.html" class="btn btn-neutral float-right" title="Implementing a Sentiment Classification Application (Android)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>