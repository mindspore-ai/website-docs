<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementing an Image Classification Application of Cross-device Federated Learning (x86) &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script><script src="_static/jquery.js"></script>
        <script src="_static/js/theme.js"></script><script src="_static/underscore.js"></script><script src="_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Implementing a Sentiment Classification Application (Android)" href="sentiment_classification_application.html" />
    <link rel="prev" title="On-Device Deployment" href="deploy_federated_client.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">Obtaining MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">Cloud-based Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">On-Device Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementing an Image Classification Application of Cross-device Federated Learning (x86)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#preparatory-work">Preparatory Work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-processing">Data Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-a-device-model-file">Generating a Device Model File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simulating-multi-client-participation-in-federated-learning">Simulating Multi-client Participation in Federated Learning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">Implementing a Sentiment Classification Application (Android)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">Local differential privacy perturbation training</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">Pairwise encryption training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_server.html">Federated-Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="federated_client.html">Federated-Client</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Implementing an Image Classification Application of Cross-device Federated Learning (x86)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/image_classification_application.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="implementing-an-image-classification-application-of-cross-device-federated-learning-x86">
<h1>Implementing an Image Classification Application of Cross-device Federated Learning (x86)<a class="headerlink" href="#implementing-an-image-classification-application-of-cross-device-federated-learning-x86" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.7/docs/federated/docs/source_en/image_classification_application.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_source_en.png" /></a></p>
<p>Federated learning can be divided into cross-silo federated learning and cross-device federated learning according to different participating customers. In the cross-silo federation learning scenario, the customers participating in federated learning are different organizations (for example, medical or financial) or geographically distributed data centers, that is, training models on multiple data islands. The clients participating in the cross-device federation learning scenario are a large number of mobiles or IoT devices. This framework will introduce how to use the network LeNet to implement an image classification application on the MindSpore cross-silo federation framework, and provides related tutorials for simulating to start multi-client participation in federated learning in the x86 environment.</p>
<p>Before you start, check whether MindSpore has been correctly installed. If not, install MindSpore on your computer by referring to <a class="reference external" href="https://www.mindspore.cn/install/en">Install</a> on the MindSpore website.</p>
<section id="preparatory-work">
<h2>Preparatory Work<a class="headerlink" href="#preparatory-work" title="Permalink to this headline"></a></h2>
<p>We provide <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/federated/3500_clients_bin.zip">Federated Learning Image Classification Dataset FEMNIST</a> and the <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/models/lenet_train.ms">device-side model file</a> of the <code class="docutils literal notranslate"><span class="pre">.ms</span></code> format for users to use directly. Users can also refer to the following tutorials to generate the datasets and models based on actual needs.</p>
<section id="data-processing">
<h3>Data Processing<a class="headerlink" href="#data-processing" title="Permalink to this headline"></a></h3>
<p>In this example, the federated learning dataset <code class="docutils literal notranslate"><span class="pre">FEMNIST</span></code> in the <code class="docutils literal notranslate"><span class="pre">leaf</span></code> dataset is used. For the specific acquisition method of the dataset, please refer to the document <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/tests/st/fl/cross_device_lenet/client/image_classfication_dataset_process_en.md#">Device-cloud federation learning image classification dataset processing</a>.</p>
<p>Users can also define the dataset by themselves. Note that the dataset must be a <code class="docutils literal notranslate"><span class="pre">.bin</span></code> format file, and the data dimension in the file must be consistent with the input dimension of the network.</p>
</section>
<section id="generating-a-device-model-file">
<h3>Generating a Device Model File<a class="headerlink" href="#generating-a-device-model-file" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p><strong>Define the network and training process</strong></p>
<p>For the definition of the specific network and training process, please refer to <a class="reference external" href="https://www.mindspore.cn/tutorials/en/r1.7/beginner/quick_start.html">Beginners Getting Started</a>.</p>
<p>We provide the network definition file <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/tests/st/fl/mobile/src/model.py">model.py</a> and the training process definition file <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/tests/st/fl/cross_device_lenet/cloud/run_export_lenet.py">run_export_lenet.py</a> for your reference.</p>
</li>
<li><p><strong>Export a model as a MindIR file.</strong></p>
<p>Run the script <code class="docutils literal notranslate"><span class="pre">run_export_lenet.py</span></code> to obtain the MindIR format model file, the code snippet is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">export</span>
<span class="o">...</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;export mindir for lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_target&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mindir_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lenet_train.mindir&quot;</span><span class="p">)</span>  <span class="c1"># The path for the file in MindIR format.</span>
<span class="o">...</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_network</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">export</span><span class="p">(</span><span class="n">train_network</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span> <span class="n">mindir_path</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>  <span class="c1"># Add the export statement to obtain the model file in MindIR format.</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
<p>The specific operating instructions are as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_export_lenet.py<span class="w"> </span>--mindir_path<span class="o">=</span><span class="s2">&quot;ms/lenet/lenet_train.mindir&quot;</span>
</pre></div>
</div>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">--mindir_path</span></code> is used to set the path of the generated file in MindIR format.</p>
</li>
<li><p><strong>Convert the MindIR file into an .ms file that can be used by the federated learning framework on the device.</strong></p>
<p>For details about model conversion, see <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r1.7/use/converter_train.html">Training Model Conversion Tutorial</a>.</p>
<p>The following is an example of model conversion:</p>
<p>Assume that the model file to be converted is <code class="docutils literal notranslate"><span class="pre">lenet_train.mindir</span></code>. Run the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>MINDIR<span class="w"> </span>--trainModel<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--modelFile<span class="o">=</span>lenet_train.mindir<span class="w"> </span>--outputFile<span class="o">=</span>lenet_train
</pre></div>
</div>
<p>If the conversion is successful, the following information is displayed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERTER<span class="w"> </span>RESULT<span class="w"> </span>SUCCESS:0
</pre></div>
</div>
<p>This indicates that the MindSpore model is successfully converted to the MindSpore device model and the new file <code class="docutils literal notranslate"><span class="pre">lenet_train.ms</span></code> is generated. If the conversion fails, the following information is displayed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERT<span class="w"> </span>RESULT<span class="w"> </span>FAILED:
</pre></div>
</div>
<p>Save the generated model file in <code class="docutils literal notranslate"><span class="pre">.ms</span></code> format to a path. When the federated learning API is called, FLParameter.trainModelPath can be set to the path of the model file.</p>
</li>
</ol>
</section>
</section>
<section id="simulating-multi-client-participation-in-federated-learning">
<h2>Simulating Multi-client Participation in Federated Learning<a class="headerlink" href="#simulating-multi-client-participation-in-federated-learning" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p><strong>Prepare a model file for the client.</strong></p>
<p>In the actual scenario, a client contains a model file in .ms format. In the simulation scenario, you need to copy multiple .ms files and name them in <code class="docutils literal notranslate"><span class="pre">lenet_train{i}.ms</span></code> format. In the format, i indicates the client ID. Due to the script settings in <code class="docutils literal notranslate"><span class="pre">run.py</span></code>, i must be set to a number, such as <code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">5...</span></code>. Each client uses an .ms file.</p>
<p>You can copy and name the original .ms file by referring to the following steps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span><span class="n">new_path</span><span class="p">,</span><span class="n">copy_num</span><span class="p">):</span>
    <span class="c1"># Copy the specified number of files from the raw path to the new path</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">copy_num</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span>
        <span class="n">new_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">raw_path</span> <span class="p">,</span><span class="n">new_file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;====== copying &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39; file ======&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the number of copy .ms files: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="s2">&quot;lenet_train.ms&quot;</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;ms/lenet&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</pre></div>
</div>
<p>Set <code class="docutils literal notranslate"><span class="pre">raw_path</span></code> to the path of the original .ms file, <code class="docutils literal notranslate"><span class="pre">new_path</span></code> to the path of the .ms file to be copied, and <code class="docutils literal notranslate"><span class="pre">num</span></code> to the number of copies. Generally, you need to simulate the number of started clients.</p>
<p>For example, in the preceding script, the .ms file is generated in the <code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code> directory for eight clients. The directory structure is as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ms/lenet
├──<span class="w"> </span>lenet_train0.ms<span class="w">  </span><span class="c1"># .ms file used by client 0.</span>
├──<span class="w"> </span>lenet_train1.ms<span class="w">  </span><span class="c1"># .ms file used by client 1.</span>
├──<span class="w"> </span>lenet_train2.ms<span class="w">  </span><span class="c1"># .ms file used by client 2.</span>
├──<span class="w"> </span>lenet_train3.ms<span class="w">  </span><span class="c1"># .ms file used by client 3.</span>
│
│<span class="w">          </span>......
│
└──<span class="w"> </span>lenet_train7.ms<span class="w">  </span><span class="c1"># .ms file used by client 7.</span>
</pre></div>
</div>
</li>
<li><p><strong>Start the cloud side service</strong></p>
<p>Users can first refer to <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/deploy_federated_server.html">cloud-side deployment tutorial</a> to deploy the cloud-side environment and start the cloud-side service.</p>
</li>
<li><p><strong>Start the client</strong></p>
<p>Before starting the client, please refer to the section <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/deploy_federated_client.html">x86</a> in the Federated-Client deployment tutorial for deployment of device environment.</p>
<p>Our framework provides three types of federated learning interfaces for users to call. For specific interface introduction, please refer to <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/java_api_syncfljob.html">API file</a> :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SyncFLJob.flJobRun()</span></code></p>
<p>Used to start the client to participate in the federated learning training task, and to obtain the final trained aggregation model.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SyncFLJob.modelInfer()</span></code></p>
<p>Used to obtain the inference result of a given dataset.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SyncFLJob.getModel()</span></code></p>
<p>Used to get the latest model on the cloud side.</p>
</li>
</ul>
<p>After the cloud-side service starts successfully, you can write a Python script to call the federated learning framework jar package <code class="docutils literal notranslate"><span class="pre">mindspore-lite-java-flclient.jar</span></code> and the jar package corresponding to the model script <code class="docutils literal notranslate"><span class="pre">quick_start_flclient.jar</span></code> (refer to <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/deploy_federated_client.html">Building a Package</a> in the Federated-Client deployment tutorial) to simulate multi-client participation in federated learning tasks.</p>
<p>We provide a reference script <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/tests/st/fl/cross_device_lenet/client/run_client_x86.py">run_client_x86.py</a>, users can set relevant parameters to start different federated learning interfaces.</p>
<p>Taking the LeNet network as an example, some of the input parameters in the <code class="docutils literal notranslate"><span class="pre">run_client_x86.py</span></code> script have the following meanings, and users can set them according to the actual situation:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--jarPath</span></code></strong></p>
<p>Specifies the path of the JAR package of the federated learning framework. For details about how to obtain the JAR package in the x86 environment, see <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/deploy_federated_client.html">Building a Package</a> in the Federated-Client deployment tutorial.</p>
<p>Note, please make sure that only the JAR package is included in the path. For example, in the above reference script, <code class="docutils literal notranslate"><span class="pre">--jarPath</span></code> is set to <code class="docutils literal notranslate"><span class="pre">&quot;libs/jarX86/mindspore-lite-java-flclient.jar&quot;</span></code>, you need to make sure that the <code class="docutils literal notranslate"><span class="pre">jarX86</span></code> folder contains only one JAR package <code class="docutils literal notranslate"><span class="pre">mindspore-lite-java-flclient.jar</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--case_jarPath</span></code></strong></p>
<p>Specifies the path of the JAR package <code class="docutils literal notranslate"><span class="pre">quick_start_flclient.jar</span></code> corresponding to the model script. For details about how to obtain the JAR package in the x86 environment, see <a class="reference external" href="https://www.mindspore.cn/federated/docs/en/r1.7/deploy_federated_client.html">Building a Package</a> in the Federated-Client deployment tutorial.</p>
<p>Note, please make sure that only the JAR package is included in the path. For example, in the above reference script, <code class="docutils literal notranslate"><span class="pre">--case_jarPath</span></code> is set to <code class="docutils literal notranslate"><span class="pre">&quot;case_jar/quick_start_flclient.jar&quot;</span></code>, you need to make sure that the <code class="docutils literal notranslate"><span class="pre">case_jar</span></code> folder contains only one JAR package <code class="docutils literal notranslate"><span class="pre">quick_start_flclient.jar</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--train_dataset</span></code></strong></p>
<p>Specifies the root path of the training dataset.The sentiment classification task stores the training data (in .txt format) of each client. The LeNet image classification task stores the training files data.bin and label.bin of each client, for example, <code class="docutils literal notranslate"><span class="pre">data/femnist/3500_clients_bin/</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--flName</span></code></strong></p>
<p>Specifies the package path of model script used by federated learning. We provide two types of model scripts for your reference (<a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.7/mindspore/lite/examples/quick_start_flclient/src/main/java/com/mindspore/flclient/demo/albert">Supervised sentiment classification task</a>, <a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.7/mindspore/lite/examples/quick_start_flclient/src/main/java/com/mindspore/flclient/demo/lenet">Lenet image classification task</a>). For supervised sentiment classification tasks, this parameter can be set to the package path of the provided script file <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/examples/quick_start_flclient/src/main/java/com/mindspore/flclient/demo/albert/AlbertClient.java">AlBertClient.java</a>, like as <code class="docutils literal notranslate"><span class="pre">com.mindspore.flclient.demo.albert.AlbertClient</span></code>; for Lenet image classification tasks, this parameter can be set to the package path of the provided script file <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/examples/quick_start_flclient/src/main/java/com/mindspore/flclient/demo/lenet/LenetClient.java">LenetClient.java</a>, like as <code class="docutils literal notranslate"><span class="pre">com.mindspore.flclient.demo.lenet.LenetClient</span></code>. At the same time, users can refer to these two types of model scripts, define the model script by themselves, and then set the parameter to the package path of the customized model file ModelClient.java (which needs to inherit from the class <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/java/java/fl_client/src/main/java/com/mindspore/flclient/model/Client.java">Client.java</a>).</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--train_model_path</span></code></strong></p>
<p>Specifies the training model path used for federated learning. The path is the directory where multiple .ms files copied in the preceding tutorial are stored, for example, <code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code>. The path must be an absolute path.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--train_ms_name</span></code></strong></p>
<p>Set the same part of the multi-client training model file name. The model file name must be in the format <code class="docutils literal notranslate"><span class="pre">{train_ms_name}1.ms</span></code>, <code class="docutils literal notranslate"><span class="pre">{train_ms_name}2.ms</span></code>, <code class="docutils literal notranslate"><span class="pre">{train_ms_name}3.ms</span></code>, etc.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--domain_name</span></code></strong></p>
<p>Used to set the url for device-cloud communication. Currently, https and http communication are supported, the corresponding formats are like as: https://……, http://……, and when <code class="docutils literal notranslate"><span class="pre">if_use_elb</span></code> is set to true, the format must be: https://127.0.0.1:6666 or http://127.0.0.1:6666 , where <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> corresponds to the ip of the machine providing cloud-side services (corresponding to the cloud-side parameter <code class="docutils literal notranslate"><span class="pre">--scheduler_ip</span></code>), and <code class="docutils literal notranslate"><span class="pre">6666</span></code> corresponds to the cloud-side parameter <code class="docutils literal notranslate"><span class="pre">--fl_server_port</span></code>.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--task</span></code></strong></p>
<p>Specifies the type of the task to be started. <code class="docutils literal notranslate"><span class="pre">train</span></code> indicates that a training task is started. <code class="docutils literal notranslate"><span class="pre">inference</span></code> indicates that multiple data inference tasks are started. <code class="docutils literal notranslate"><span class="pre">getModel</span></code> indicates that the task for obtaining the cloud model is started. Other character strings indicate that the inference task of a single data record is started. The default value is <code class="docutils literal notranslate"><span class="pre">train</span></code>. The initial model file (.ms file) is not trained. Therefore, you are advised to start the training task first. After the training is complete, start the inference task. (Note that the values of client_num in the two startups must be the same to ensure that the model file used by <code class="docutils literal notranslate"><span class="pre">inference</span></code> is the same as that used by <code class="docutils literal notranslate"><span class="pre">train</span></code>.)</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--batch_size</span></code></strong></p>
<p>Specifies the number of single-step training samples used in federated learning training and inference, that is, batch size. It needs to be consistent with the batch size of the input data of the model.</p>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">--client_num</span></code></strong></p>
<p>Specifies the number of clients. The value must be the same as that of <code class="docutils literal notranslate"><span class="pre">start_fl_job_cnt</span></code> when the server is started. This parameter is not required in actual scenarios.</p>
</li>
</ul>
<p>If you want to know more about the meaning of other parameters in the <code class="docutils literal notranslate"><span class="pre">run_client_x86.py</span></code> script, you can refer to the comments in the script.</p>
<p>The basic startup instructions of the federated learning interface are as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_client_x86.py<span class="w"> </span>--jarPath<span class="o">=</span><span class="s2">&quot;libs/jarX86/mindspore-lite-java-flclient.jar&quot;</span><span class="w"> </span>--case_jarPath<span class="o">=</span><span class="s2">&quot;case_jar/quick_start_flclient.jar&quot;</span><span class="w"> </span>--train_dataset<span class="o">=</span><span class="s2">&quot;data/femnist/3500_clients_bin/&quot;</span><span class="w"> </span>--test_dataset<span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="w"> </span>--vocal_file<span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="w"> </span>--ids_file<span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="w"> </span>--flName<span class="o">=</span><span class="s2">&quot;com.mindspore.flclient.demo.lenet.LenetClient&quot;</span><span class="w"> </span>--train_model_path<span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="w"> </span>--infer_model_path<span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="w"> </span>--train_ms_name<span class="o">=</span><span class="s2">&quot;lenet_train&quot;</span><span class="w"> </span>--infer_ms_name<span class="o">=</span><span class="s2">&quot;lenet_train&quot;</span><span class="w"> </span>--domain_name<span class="o">=</span><span class="s2">&quot;http://127.0.0.1:6666&quot;</span><span class="w"> </span>--cert_path<span class="o">=</span><span class="s2">&quot;certs/https_signature_certificate/client/CARoot.pem&quot;</span><span class="w"> </span>--use_elb<span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w"> </span>--server_num<span class="o">=</span><span class="m">4</span><span class="w"> </span>--client_num<span class="o">=</span><span class="m">8</span><span class="w"> </span>--thread_num<span class="o">=</span><span class="m">1</span><span class="w"> </span>--server_mode<span class="o">=</span><span class="s2">&quot;FEDERATED_LEARNING&quot;</span><span class="w"> </span>--batch_size<span class="o">=</span><span class="m">32</span><span class="w"> </span>--task<span class="o">=</span><span class="s2">&quot;train&quot;</span>
</pre></div>
</div>
<p>Note that the path-related parameters must give an absolute path.</p>
<p>The above commands indicate that eight clients are started to participate in federated learning. If the startup is successful, log files corresponding to the eight clients are generated in the current folder. You can view the log files to learn the running status of each client.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./
├──<span class="w"> </span>client_0
│<span class="w">   </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 0.</span>
│<span class="w">           </span>......
└──<span class="w"> </span>client_7
<span class="w">    </span>└──<span class="w"> </span>client.log<span class="w">  </span><span class="c1"># Log file of client 7.</span>
</pre></div>
</div>
<p>For different interfaces and scenarios, you only need to modify specific parameter values according to the meaning of the parameters, such as:</p>
<ul>
<li><p>Start federated learning and training tasks: SyncFLJob.flJobRun()</p>
<p>When <code class="docutils literal notranslate"><span class="pre">--task</span></code> in <code class="docutils literal notranslate"><span class="pre">Basic</span> <span class="pre">Start</span> <span class="pre">Command</span></code> is set to <code class="docutils literal notranslate"><span class="pre">train</span></code>, it means to start the task.</p>
<p>You can use the command <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&quot;average</span> <span class="pre">loss:&quot;</span> <span class="pre">client_0/client.log</span></code> to view the average loss of each epoch of <code class="docutils literal notranslate"><span class="pre">client_0</span></code> during the training process. It will be printed as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>INFO:<span class="w"> </span>&lt;FLClient&gt;<span class="w"> </span>----------epoch:0,average<span class="w"> </span>loss:4.1258564<span class="w"> </span>----------
......
</pre></div>
</div>
<p>You can also use the command <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&quot;evaluate</span> <span class="pre">acc:&quot;</span> <span class="pre">client_0/client.log</span></code> to view the verification accuracy of the model after the aggregation in each federated learning iteration for <code class="docutils literal notranslate"><span class="pre">client_0</span></code> . It will be printed like the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>INFO:<span class="w"> </span>&lt;FLClient&gt;<span class="w"> </span><span class="o">[</span>evaluate<span class="o">]</span><span class="w"> </span>evaluate<span class="w"> </span>acc:<span class="w"> </span><span class="m">0</span>.125
......
</pre></div>
</div>
</li>
<li><p>Start the inference task: SyncFLJob.modelInference()</p>
<p>When <code class="docutils literal notranslate"><span class="pre">--task</span></code> in <code class="docutils literal notranslate"><span class="pre">Basic</span> <span class="pre">Start</span> <span class="pre">Command</span></code> is set to <code class="docutils literal notranslate"><span class="pre">inference</span></code>, it means to start the task.</p>
<p>You can view the inference result of <code class="docutils literal notranslate"><span class="pre">client_0</span></code> through the command <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-r</span> <span class="pre">&quot;the</span> <span class="pre">predicted</span> <span class="pre">labels:&quot;</span> <span class="pre">client_0/client.log</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>INFO:<span class="w"> </span>&lt;FLClient&gt;<span class="w"> </span><span class="o">[</span>model<span class="w"> </span>inference<span class="o">]</span><span class="w"> </span>the<span class="w"> </span>predicted<span class="w"> </span>labels:<span class="w"> </span><span class="o">[</span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">2</span><span class="o">]</span>
......
</pre></div>
</div>
</li>
<li><p>Start the task of obtaining the latest model on the cloud side: SyncFLJob.getModel()</p>
<p>When <code class="docutils literal notranslate"><span class="pre">--task</span></code> in <code class="docutils literal notranslate"><span class="pre">Basic</span> <span class="pre">Start</span> <span class="pre">Command</span></code> is set to <code class="docutils literal notranslate"><span class="pre">inference</span></code>, it means to start the task.</p>
<p>If there is the following content in the log file, it means that the latest model on the cloud side is successfully obtained:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>INFO:<span class="w"> </span>&lt;FLClient&gt;<span class="w"> </span><span class="o">[</span>getModel<span class="o">]</span><span class="w"> </span>get<span class="w"> </span>response<span class="w"> </span>from<span class="w"> </span>server<span class="w"> </span>ok!
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Stop the client process.</strong></p>
<p>For details, see the <code class="docutils literal notranslate"><span class="pre">finish.py</span></code> script. The details are as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Finish test_mobile_lenet.py case&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--kill_tag&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mindspore-lite-java-flclient&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">kill_tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kill_tag</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;pid=`ps -ef|grep &quot;</span> <span class="o">+</span> <span class="n">kill_tag</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot; |grep -v </span><span class="se">\&quot;</span><span class="s2">grep</span><span class="se">\&quot;</span><span class="s2"> | grep -v </span><span class="se">\&quot;</span><span class="s2">finish</span><span class="se">\&quot;</span><span class="s2"> |awk &#39;{print $2}&#39;` &amp;&amp; &quot;</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;for id in $pid; do kill -9 $id &amp;&amp; echo </span><span class="se">\&quot;</span><span class="s2">killed $id</span><span class="se">\&quot;</span><span class="s2">; done&quot;</span>

<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">])</span>
</pre></div>
</div>
<p>Run the following command to shut down the client:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>finish.py<span class="w"> </span>--kill_tag<span class="o">=</span>mindspore-lite-java-flclient
</pre></div>
</div>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">--kill_tag</span></code> is used to search for the keyword to kill the client process. You only need to set the special keyword in <code class="docutils literal notranslate"><span class="pre">--jarPath</span></code>. The default value is <code class="docutils literal notranslate"><span class="pre">mindspore-lite-java-flclient</span></code>, that is, the name of the federated learning JAR package.</p>
<p>The user can check whether the process still exists through the command <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-ef</span> <span class="pre">|grep</span> <span class="pre">&quot;mindspore-lite-java-flclient&quot;</span></code>.</p>
</li>
<li><p>**Experimental results of 50 clients participating in federated learning and training tasks. **</p>
<p>Currently, the <strong><code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code></strong> folder contains data of 3500 clients. This script can simulate a maximum of 3500 clients to participate in federated learning.</p>
<p>The following figure shows the accuracy of the test dataset for federated learning on 50 clients (set <code class="docutils literal notranslate"><span class="pre">server_num</span></code> to 16).</p>
<p><img alt="lenet_50_clients_acc" src="_images/lenet_50_clients_acc.png" /></p>
<p>The total number of federated learning iterations is 100, the number of epochs for local training on the client is 20, and the value of batchSize is 32.</p>
<p>The test accuracy in the figure refers to the accuracy of each client test dataset on the aggregated model on the cloud for each federated learning iteration:</p>
<p>AVG: average accuracy of 50 client test datasets</p>
<p>TOP5: average accuracy of the five clients with the highest accuracy in the test dataset</p>
<p>LOW5: average accuracy of the five clients with the lowest accuracy in the test dataset3</p>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="deploy_federated_client.html" class="btn btn-neutral float-left" title="On-Device Deployment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sentiment_classification_application.html" class="btn btn-neutral float-right" title="Implementing a Sentiment Classification Application (Android)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>