

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>联邦学习图像分类数据集处理 &mdash; MindSpore master 文档</title>
  

  
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
        
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="实现一个端云联邦的图像分类应用(x86)" href="image_classification_application.html" />
    <link rel="prev" title="纵向联邦部署" href="deploy_vfl.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">获取MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">横向联邦云侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">横向联邦端侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">纵向联邦部署</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">横向应用实践</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">联邦学习图像分类数据集处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">实现一个端云联邦的图像分类应用(x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">实现一个端云情感分类应用(Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">实现一个云云联邦的图像分类应用(x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_detection_application_in_cross_silo.html">实现一个云云联邦的目标检测应用(x86)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">纵向应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data_join.html">纵向联邦学习数据接入</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_wnd_application.html">纵向联邦学习模型训练 - Wide&amp;Deep推荐应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_pangu_alpha_application.html">纵向联邦学习模型训练 - 盘古α大模型跨域训练</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">横向联邦-局部差分隐私加噪训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">横向联邦-局部差分隐私SignDS训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_eval_laplace.html">横向联邦-局部差分隐私推理结果保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">横向联邦-安全聚合训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">纵向联邦-隐私集合求交</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">纵向联邦-基于信息混淆的特征保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">纵向联邦-基于可信执行环境的特征保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">纵向联邦-基于差分隐私的标签保护</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">通信压缩</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="communication_compression.html">端云联邦学习通信压缩</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">纵向联邦学习通信压缩</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">横向联邦API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">联邦服务器</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">端侧客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">云侧客户端</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">纵向联邦API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">数据求交</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">纵向联邦学习通信器</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">纵向联邦训练器</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>联邦学习图像分类数据集处理</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/image_classfication_dataset_process.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="联邦学习图像分类数据集处理">
<h1>联邦学习图像分类数据集处理<a class="headerlink" href="#联邦学习图像分类数据集处理" title="永久链接至标题"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/master/docs/federated/docs/source_zh_cn/image_classfication_dataset_process.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source.png"></a></p>
<p>本教程采用<code class="docutils literal notranslate"><span class="pre">leaf</span></code>数据集中的联邦学习数据集<code class="docutils literal notranslate"><span class="pre">FEMNIST</span></code>，该数据集包含62个不同类别的手写数字和字母（数字0~9、26个小写字母、26个大写字母），图像大小为<code class="docutils literal notranslate"><span class="pre">28</span> <span class="pre">x</span> <span class="pre">28</span></code>像素，数据集包含3500个用户的手写数字和字母（最多可模拟3500个客户端参与联邦学习），总数据量为805263，平均每个用户包含数据量为226.83，所有用户数据量的方差为88.94。</p>
<p>参考<a class="reference external" href="https://github.com/TalwalkarLab/leaf">leaf数据集官方指导</a>下载数据集。</p>
<ol class="arabic">
<li><p>下载数据集前的环境要求。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.16.4
scipy<span class="w">                      </span><span class="c1"># conda install scipy</span>
<span class="nv">tensorflow</span><span class="o">==</span><span class="m">1</span>.13.1<span class="w">         </span><span class="c1"># pip install tensorflow</span>
Pillow<span class="w">                     </span><span class="c1"># pip install Pillow</span>
matplotlib<span class="w">                 </span><span class="c1"># pip install matplotlib</span>
jupyter<span class="w">                    </span><span class="c1"># conda install jupyter notebook==5.7.8 tornado==4.5.3</span>
pandas<span class="w">                     </span><span class="c1"># pip install pandas</span>
</pre></div>
</div>
</li>
<li><p>使用git下载官方数据集生成脚本。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/TalwalkarLab/leaf.git
</pre></div>
</div>
<p>下载项目后，目录结构如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist
<span class="w">    </span>├──<span class="w"> </span>data<span class="w">  </span><span class="c1"># 用来存放指令生成的数据集</span>
<span class="w">    </span>├──<span class="w"> </span>preprocess<span class="w">  </span><span class="c1"># 存放数据预处理的相关代码</span>
<span class="w">    </span>├──<span class="w"> </span>preprocess.sh<span class="w">  </span><span class="c1"># femnist数据集生成shell脚本</span>
<span class="w">    </span>└──<span class="w"> </span>README.md<span class="w">  </span><span class="c1"># 官方数据集下载指导文档</span>
</pre></div>
</div>
</li>
<li><p>以<code class="docutils literal notranslate"><span class="pre">femnist</span></code>数据集为例，运行以下指令进入指定路径。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w">  </span>leaf/data/femnist
</pre></div>
</div>
</li>
<li><p>用指令<code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">1.0</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code>生成的数据集包含3500个用户，且按照9:1对每个用户的数据划分训练和测试集。</p>
<p>指令中参数含义可参考<code class="docutils literal notranslate"><span class="pre">leaf/data/femnist/README.md</span></code>文件中的说明。</p>
<p>运行之后目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist/35_client_sf1_data/
    ├── all_data  # 所有数据集混合在一起，不区分训练测试集，共包含35个json文件，每个json文件包含100个用户的数据
    ├── test  # 按照9:1对每个用户的数据划分训练和测试集后的测试集，共包含35个json文件，每个json文件包含100个用户的数据
    ├── train  # 按照9:1对每个用户的数据划分训练和测试集后的训练集，共包含35个json文件，每个json文件包含100个用户的数据
    └── ...  # 其他文件，暂不需要用到，不作介绍
</pre></div>
</div>
<p>其中每个json文件包含以下三个部分：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">users</span></code>: 用户列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: 每个用户的样本数量列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: 一个以用户名为key，以它们各自的数据为value的字典对象；对于每个用户，数据表示为图像列表，每张图像表示为大小为784的整数列表（将<code class="docutils literal notranslate"><span class="pre">28</span> <span class="pre">x</span> <span class="pre">28</span></code>图像数组展平所得）。</p></li>
</ul>
<p>在重新运行<code class="docutils literal notranslate"><span class="pre">preprocess.sh</span></code>之前，请确保删除数据目录中的<code class="docutils literal notranslate"><span class="pre">rem_user_data</span></code>、<code class="docutils literal notranslate"><span class="pre">sampled_data</span></code>、<code class="docutils literal notranslate"><span class="pre">test</span></code>和<code class="docutils literal notranslate"><span class="pre">train</span></code>子文件夹。</p>
</li>
<li><p>将35个json文件划分为3500个json文件（每个json文件代表一个用户）。</p>
<p>参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">partition_json</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">new_root_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    partition 35 json files to 3500 json file</span>

<span class="sd">    Each raw .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;users&#39;, a list of users</span>
<span class="sd">    2. &#39;num_samples&#39;, a list of the number of samples for each user</span>
<span class="sd">    3. &#39;user_data&#39;, an object with user names as keys and their respective data as values; for each user, data is represented as a list of images, with each image represented as a size-784 integer list (flattened from 28 by 28)</span>

<span class="sd">    Each new .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;user_name&#39;, the name of user</span>
<span class="sd">    2. &#39;num_samples&#39;, the number of samples for the user</span>
<span class="sd">    3. &#39;user_data&#39;, an dict object with &#39;x&#39; as keys and their respective data as values; with &#39;y&#39; as keys and their respective label as values;</span>

<span class="sd">    Args:</span>
<span class="sd">        root_path (str): raw root path of 35 json files</span>
<span class="sd">        new_root_path (str): new root path of 3500 json files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">file_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======== process &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;======================&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f</span><span class="p">:</span>
            <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f</span><span class="p">)</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
            <span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---processing user: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;---&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;num_samples&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">cur_user_id</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_data_num</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">,</span> <span class="n">cur_user_id</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_user_id</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_data_num</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="n">cur_user_id</span><span class="p">])</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cur_user_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cur_out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s1">&#39; users have been processed!&#39;</span><span class="p">)</span>
<span class="c1"># partition train json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/35_client_sf1_data/train&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_json/train&quot;</span><span class="p">)</span>
<span class="c1"># partition test json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/35_client_sf1_data/test&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_json/test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>其中<code class="docutils literal notranslate"><span class="pre">root_path</span></code>为<code class="docutils literal notranslate"><span class="pre">leaf/data/femnist/35_client_sf1_data/{train,test}</span></code>，<code class="docutils literal notranslate"><span class="pre">new_root_path</span></code>自行设置，用于存放生成的3500个用户json文件，需分别对训练和测试文件夹进行处理。</p>
<p>新生成的3500个用户json文件，每个文件均包含以下三个部分：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">user_name</span></code>: 用户名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: 用户的样本数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: 一个以’x’为key，以用户数据为value的字典对象；以’y’为key，以用户数据对应的标签为value。</p></li>
</ul>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">========</span><span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>file:<span class="w"> </span>/leaf/data/femnist/35_client_sf1_data/train/all_data_16_niid_0_keep_0_train_9.json<span class="o">======================</span>
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">1</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">2</span>---
---processing<span class="w"> </span>user:<span class="w"> </span><span class="m">3</span>---
......
</pre></div>
</div>
</li>
<li><p>将json文件转换为图片文件。</p>
<p>可参考如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span>
             <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span>
             <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span>
             <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span>
             <span class="p">]</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">json_2_numpy</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read json file to numpy</span>
<span class="sd">    Args:</span>
<span class="sd">        img_size (list): contain three elements: the height, width, channel of image</span>
<span class="sd">        file_path (str): root path of 3500 json files</span>
<span class="sd">    return:</span>
<span class="sd">        image_numpy (numpy)</span>
<span class="sd">        label_numpy (numpy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># open json file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f_train</span><span class="p">:</span>
        <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f_train</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">image_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>  <span class="c1"># mindspore doesn&#39;t support float64 and int64</span>
        <span class="n">label_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_numpy</span><span class="p">,</span> <span class="n">label_numpy</span>

<span class="k">def</span> <span class="nf">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform single json file to images</span>

<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the path json file</span>
<span class="sd">        save_path (str): the root path to save images</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">json_2_numpy</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">json_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span>  <span class="c1"># PIL don&#39;t support the 0/1 image ,need convert to 0~255 image</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
        <span class="n">img_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name_list</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">img_name</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;-----&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">all_json_2_img</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">save_root_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform json files to images</span>
<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the root path of 3500 json files</span>
<span class="sd">        save_path (str): the root path to save images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">files_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">user_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">save_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_root_path</span><span class="p">,</span> <span class="n">user_name</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path1</span><span class="p">)</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=============================&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;=======================&#39;</span><span class="p">)</span>
            <span class="n">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>

<span class="n">all_json_2_img</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/3500_client_json/&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_img/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">=============================</span>f0644_19.json<span class="o">=======================</span>
-----<span class="w"> </span><span class="m">0</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>-----
-----<span class="w"> </span><span class="m">2</span><span class="w"> </span>-----
......
</pre></div>
</div>
</li>
<li><p>由于有些用户文件夹下的数据集较小，若数量小于batch size，需要进行随机扩充。</p>
<p>可参考下面代码对整个数据集<code class="docutils literal notranslate"><span class="pre">&quot;leaf/data/femnist/3500_client_img/&quot;</span></code>进行检查并扩充：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="k">def</span> <span class="nf">count_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">num</span>

<span class="k">def</span> <span class="nf">get_img_list</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">img_path_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label_list</span><span class="p">)):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">imgs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">imgs_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">imgs_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs_name</span><span class="p">)):</span>
            <span class="n">img_name</span> <span class="o">=</span> <span class="n">imgs_name</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgs_path</span><span class="p">,</span> <span class="n">img_name</span><span class="p">)</span>
            <span class="n">img_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_path_list</span>

<span class="k">def</span> <span class="nf">data_aug</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="n">aug_users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">num_data</span> <span class="o">=</span> <span class="n">count_dir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_data</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
                <span class="n">aug_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user: &quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s2">&quot; data number: &quot;</span><span class="p">,</span> <span class="n">num_data</span><span class="p">,</span> <span class="s2">&quot; &lt; &quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="s2">&quot; should be aug&quot;</span><span class="p">)</span>
                <span class="n">aug_num</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">num_data</span>
                <span class="n">img_path_list</span> <span class="o">=</span> <span class="n">get_img_list</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aug_num</span><span class="p">):</span>
                    <span class="n">img_path</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">img_path_list</span><span class="p">)</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">img_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">aug_img_path</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_aug_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">aug_img_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[aug&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;============= copy file:&quot;</span><span class="p">,</span> <span class="n">img_path</span><span class="p">,</span> <span class="s2">&quot;to -&gt;&quot;</span><span class="p">,</span> <span class="n">aug_img_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the number of all aug users: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aug_users</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aug user name: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aug_users</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">aug_users</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">data_root_path</span> <span class="o">=</span> <span class="s2">&quot;leaf/data/femnist/3500_client_img/&quot;</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">data_aug</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span>  <span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>将扩充后图片数据集转换为联邦学习框架可用的bin文件格式。</p>
<p>可参考下面代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">vision</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">mindspore</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count_id</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ids</span>

<span class="k">def</span> <span class="nf">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; create dataset for train or test</span>
<span class="sd">        Args:</span>
<span class="sd">            data_path: Data path</span>
<span class="sd">            batch_size: The number of data records in each group</span>
<span class="sd">            repeat_size: The number of replicated data records</span>
<span class="sd">            num_parallel_workers: The number of parallel workers</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">count_id</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ImageFolderDataset</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_indexing</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
    <span class="c1"># define operation parameters</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 32</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">)),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">vision</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="p">]</span>
    <span class="n">compose</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="c1"># apply map operations on images</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mindspore</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">compose</span><span class="p">)</span>

    <span class="c1"># apply DatasetOps</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>  <span class="c1"># 10000 as in LeNet train script</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="k">def</span> <span class="nf">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform images to bin files</span>

<span class="sd">    Args:</span>
<span class="sd">    root_path: the root path of 3500 images files</span>
<span class="sd">    root_save: the root path to save bin files</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">root_save</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">use_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">train_test</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">user_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">train_test</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_path</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">batch_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">():</span>
                <span class="n">batch_x_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="n">batch_y_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">trans_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">batch_x_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans_img</span><span class="p">)</span>
                <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_y_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                <span class="n">batch_num</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                <span class="n">train_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="n">test_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>

            <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>  <span class="c1"># (batch_num, 32,3,32,32)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
            <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_save</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_data.bin&quot;</span><span class="p">)</span>
            <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_label.bin&quot;</span><span class="p">)</span>

            <span class="n">imgs</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">label_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user: &quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_batch_num: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">use_list</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; users finished!&quot;</span><span class="p">)</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="s2">&quot;leaf/data/femnist/3500_client_img/&quot;</span>
<span class="n">root_save</span> <span class="o">=</span> <span class="s2">&quot;leaf/data/femnist/3500_clients_bin&quot;</span>
<span class="n">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">)</span>
</pre></div>
</div>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>user:<span class="w"> </span>f0141_43<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0141_43<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">10</span>
user:<span class="w"> </span>f0137_14<span class="w"> </span>test_batch_num:<span class="w"> </span><span class="m">1</span>
user:<span class="w"> </span>f0137_14<span class="w"> </span>train_batch_num:<span class="w"> </span><span class="m">11</span>
......
total<span class="w"> </span><span class="m">3500</span><span class="w"> </span>users<span class="w"> </span>finished!
</pre></div>
</div>
</li>
<li><p>生成<code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code>文件夹内共包含3500个用户文件夹，其目录结构如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist/3500_clients_bin
<span class="w">  </span>├──<span class="w"> </span>f0000_14<span class="w">  </span><span class="c1"># 用户编号</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_10_train_data.bin<span class="w">  </span><span class="c1"># 用户f0000_14的训练数据 （bn_后面的数字10代表batch number）</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_10_train_label.bin<span class="w">  </span><span class="c1"># 用户f0000_14的训练标签</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0000_14_bn_1_test_data.bin<span class="w">  </span><span class="c1"># 用户f0000_14的测试数据  （bn_后面的数字1代表batch number）</span>
<span class="w">  </span>│<span class="w">   </span>└──<span class="w"> </span>f0000_14_bn_1_test_label.bin<span class="w">  </span><span class="c1"># 用户f0000_14的测试标签</span>
<span class="w">  </span>├──<span class="w"> </span>f0001_41<span class="w">  </span><span class="c1"># 用户编号</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_11_train_data.bin<span class="w">  </span><span class="c1"># 用户f0001_41的训练数据 （bn_后面的数字11代表batch number）</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_11_train_label.bin<span class="w">  </span><span class="c1"># 用户f0001_41的训练标签</span>
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>f0001_41_bn_1_test_data.bin<span class="w">  </span><span class="c1"># 用户f0001_41的测试数据 （bn_后面的数字1代表batch number）</span>
<span class="w">  </span>│<span class="w">   </span>└──<span class="w"> </span>f0001_41_bn_1_test_label.bin<span class="w">  </span><span class="c1"># 用户f0001_41的测试标签</span>
<span class="w">  </span>│<span class="w">                    </span>...
<span class="w">  </span>└──<span class="w"> </span>f4099_10<span class="w">  </span><span class="c1"># 用户编号</span>
<span class="w">      </span>├──<span class="w"> </span>f4099_10_bn_4_train_data.bin<span class="w">  </span><span class="c1"># 用户f4099_10的训练数据 （bn_后面的数字4代表batch number）</span>
<span class="w">      </span>├──<span class="w"> </span>f4099_10_bn_4_train_label.bin<span class="w">  </span><span class="c1"># 用户f4099_10的训练标签</span>
<span class="w">      </span>├──<span class="w"> </span>f4099_10_bn_1_test_data.bin<span class="w">  </span><span class="c1"># 用户f4099_10的测试数据 （bn_后面的数字1代表batch number）</span>
<span class="w">      </span>└──<span class="w"> </span>f4099_10_bn_1_test_label.bin<span class="w">  </span><span class="c1"># 用户f4099_10的测试标签</span>
</pre></div>
</div>
</li>
</ol>
<p>根据以上1～9步骤生成的<code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code>文件夹可直接作为端云联邦图像分类任务的输入数据。</p>
</section>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="deploy_vfl.html" class="btn btn-neutral float-left" title="纵向联邦部署" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="image_classification_application.html" class="btn btn-neutral float-right" title="实现一个端云联邦的图像分类应用(x86)" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
</body>
</html>