

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>纵向联邦学习模型训练 - 盘古α大模型跨域训练 &mdash; MindSpore master 文档</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/translations.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="横向联邦-局部差分隐私加噪训练" href="local_differential_privacy_training_noise.html" />
    <link rel="prev" title="纵向联邦学习模型训练 - Wide&amp;Deep推荐应用" href="split_wnd_application.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">获取MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">横向联邦云侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">横向联邦端侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_vfl.html">纵向联邦部署</a></li>
</ul>
<p class="caption"><span class="caption-text">横向应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="image_classfication_dataset_process.html">联邦学习图像分类数据集处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">实现一个端云联邦的图像分类应用(x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">实现一个端云情感分类应用(Android)</a></li>
<li class="toctree-l1"><a class="reference internal" href="image_classification_application_in_cross_silo.html">实现一个云云联邦的图像分类应用(x86)</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_detection_application_in_cross_silo.html">实现一个云云联邦的目标检测应用(x86)</a></li>
</ul>
<p class="caption"><span class="caption-text">纵向应用实践</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_join.html">纵向联邦学习数据接入</a></li>
<li class="toctree-l1"><a class="reference internal" href="split_wnd_application.html">纵向联邦学习模型训练 - Wide&amp;Deep推荐应用</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">纵向联邦学习模型训练 - 盘古α大模型跨域训练</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#概述">概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="#准备环节">准备环节</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#环境准备">环境准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#数据集准备">数据集准备</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#定义纵向联邦学习训练过程">定义纵向联邦学习训练过程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#定义网络模型">定义网络模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#定义优化器">定义优化器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#定义梯度加权系数计算">定义梯度加权系数计算</a></li>
<li class="toctree-l3"><a class="reference internal" href="#执行训练">执行训练</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#运行样例">运行样例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#运行单进程样例">运行单进程样例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#运行多进程样例">运行多进程样例</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_noise.html">横向联邦-局部差分隐私加噪训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_differential_privacy_training_signds.html">横向联邦-局部差分隐私SignDS训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairwise_encryption_training.html">横向联邦-安全聚合训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="private_set_intersection.html">纵向联邦-隐私集合求交</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_EmbeddingDP.html">纵向联邦-基于信息混淆的特征保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_TEE.html">纵向联邦-基于可信执行环境的特征保护</a></li>
<li class="toctree-l1"><a class="reference internal" href="secure_vertical_federated_learning_with_DP.html">纵向联邦-基于差分隐私的标签保护</a></li>
</ul>
<p class="caption"><span class="caption-text">通信压缩</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="communication_compression.html">端云联邦学习通信压缩</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfl_communication_compress.html">纵向联邦学习通信压缩</a></li>
</ul>
<p class="caption"><span class="caption-text">横向联邦API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="horizontal_server.html">联邦服务器</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_device.html">端侧客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizontal/cross_silo.html">云侧客户端</a></li>
</ul>
<p class="caption"><span class="caption-text">纵向联邦API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Data_Join.html">数据求交</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical/vertical_communicator.html">纵向联邦学习通信器</a></li>
<li class="toctree-l1"><a class="reference internal" href="vertical_federated_trainer.html">纵向联邦训练器</a></li>
</ul>
<p class="caption"><span class="caption-text">参考文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>纵向联邦学习模型训练 - 盘古α大模型跨域训练</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/split_pangu_alpha_application.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="纵向联邦学习模型训练---盘古α大模型跨域训练">
<h1>纵向联邦学习模型训练 - 盘古α大模型跨域训练<a class="headerlink" href="#纵向联邦学习模型训练---盘古α大模型跨域训练" title="永久链接至标题">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r2.0/docs/federated/docs/source_zh_cn/split_pangu_alpha_application.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_source.png"></a></p>
<div class="section" id="概述">
<h2>概述<a class="headerlink" href="#概述" title="永久链接至标题">¶</a></h2>
<p>随着硬件算力的进步和网络数据规模的持续膨胀，预训练大模型已日趋成为自然语言处理、图文多模态等领域的重要研究方向。以2021年发布中文NLP预训练大模型的盘古α为例，其模型参数量达2000亿，训练过程依赖海量数据和先进计算中心，限制了其应用落地和技术演进。一种可行的解决方案是基于纵向联邦学习或拆分学习（Split Learning）技术，整合多参与方的算力和数据资源，在确保安全隐私的前提下，实现预训练大模型的的跨域协同训练。</p>
<p>MindSpore Federated提供基于拆分学习的纵向联邦学习基础功能组件。本样例以盘古α模型为例，提供了面向NLP大模型的联邦学习训练样例。</p>
<p><img alt="实现盘古α大模型跨域训练" src="_images/splitnn_pangu_alpha.png" /></p>
<p>如上图所示，该案例中，盘古α模型被依次切分为Embedding、Backbone、Head等3个子网络。其中，前级子网络Embedding和末级子网络Head部署在的参与方A网络域内，包含多级Transformer模块的Backbone子网络部署在参与方B网络域内。Embedding子网络和Head子网络读取参与方A所持有的数据，主导执行盘古α模型的训练和推理任务。</p>
<ul class="simple">
<li><p>前向推理阶段，参与方A采用Embedding子网络处理原始数据后，将输出的Embedding Feature特征张量和Attention Mask特征张量传输给参与方B，作为参与方B Backbone子网络的输入。然后，参与方A读取Backbone子网络输出的Hide State特征张量，作为参与方A Head子网络的输入，最终由Head子网络输出预测结果或损失值。</p></li>
<li><p>反向传播阶段，参与方A在完成Head子网络的梯度计算和参数更新后，将Hide State特征张量所关联的梯度张量，传输给参与方B，用于Backbone子网络的梯度计算和参数更新。然后，参与方B在完成Backbone子网络的梯度计算和参数更新后，将Embedding Feature特征张量所关联的梯度张量，传输给参与方A，用于Embedding子网络的梯度计算和参数更新。</p></li>
</ul>
<p>上述前向推理和反向传播过程中，参与方A和参与方B交换的特征张量和梯度张量，均采用隐私安全机制和加密算法进行处理，从而无需将参与方A所持有的数据传输给参与方B，即可实现两个参与方对网络模型的协同训练。由于Embedding子网络和Head子网络参数量较少，而Backbone子网络参数量巨大，该应用样例适用于业务方（对应参与方A）与计算中心（对应参与方B）的大模型协同训练或部署。</p>
<p>盘古α模型原理的详细介绍，可参考<a class="reference external" href="https://gitee.com/mindspore/models/tree/r2.0/official/nlp/Pangu_alpha">MindSpore ModelZoo - pangu_alpha</a>、<a class="reference external" href="https://git.openi.org.cn/PCL-Platform.Intelligence/PanGu-Alpha">鹏程·盘古α介绍</a>，及其<a class="reference external" href="https://arxiv.org/pdf/2104.12369.pdf">研究论文</a>。</p>
</div>
<div class="section" id="准备环节">
<h2>准备环节<a class="headerlink" href="#准备环节" title="永久链接至标题">¶</a></h2>
<div class="section" id="环境准备">
<h3>环境准备<a class="headerlink" href="#环境准备" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>参考<a class="reference external" href="https://mindspore.cn/federated/docs/zh-CN/r0.1/federated_install.html">获取MindSpore Federated</a>，安装MindSpore 1.8.1及以上版本和MindSpore Federated。</p></li>
<li><p>下载MindSpore Federated代码，安装本应用样例依赖的Python软件包。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>https://gitee.com/mindspore/federated.git
<span class="nb">cd</span><span class="w"> </span>federated/example/splitnn_pangu_alpha/
python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="数据集准备">
<h3>数据集准备<a class="headerlink" href="#数据集准备" title="永久链接至标题">¶</a></h3>
<p>在运行样例前，需参考<a class="reference external" href="https://gitee.com/mindspore/models/tree/r2.0/official/nlp/Pangu_alpha#dataset-generation">MindSpore ModelZoo - pangu_alpha - Dataset Generation</a>，采用preprocess.py脚本将用于训练的原始文本语料，转换为可用于模型训练的数据集。</p>
</div>
</div>
<div class="section" id="定义纵向联邦学习训练过程">
<h2>定义纵向联邦学习训练过程<a class="headerlink" href="#定义纵向联邦学习训练过程" title="永久链接至标题">¶</a></h2>
<p>MindSpore Federated纵向联邦学习框架采用FLModel（参见<a class="reference external" href="https://mindspore.cn/federated/docs/zh-CN/r0.1/vertical/vertical_federated_FLModel.html">纵向联邦学习模型训练接口</a>）和yaml文件（参见<a class="reference external" href="https://mindspore.cn/federated/docs/zh-CN/r0.1/vertical/vertical_federated_yaml.html">纵向联邦学习yaml详细配置项</a>），建模纵向联邦学习的训练过程。</p>
<div class="section" id="定义网络模型">
<h3>定义网络模型<a class="headerlink" href="#定义网络模型" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>采用MindSpore提供的功能组件，以nn.Cell（参见<a class="reference external" href="https://mindspore.cn/docs/zh-CN/r2.0/api_python/nn/mindspore.nn.Cell.html?highlight=cell#mindspore-nn-cell">mindspore.nn.Cell</a>）为基类，编程开发本参与方待参与纵向联邦学习的训练网络。以本应用实践中参与方A的Embedding子网络为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/src/split_pangu_alpha.py">示例代码</a>如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EmbeddingLossNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train net of the embedding party, or the tail sub-network.</span>
<span class="sd">    Args:</span>
<span class="sd">        net (class): EmbeddingLayer, which is the 1st sub-network.</span>
<span class="sd">        config (class): default config info.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">:</span> <span class="n">EmbeddingLayer</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EmbeddingLossNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seq_length</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">data_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eod_token</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">eod_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">StridedSlice</span><span class="p">()</span><span class="o">.</span><span class="n">shard</span><span class="p">(((</span><span class="n">dp</span><span class="p">,</span> <span class="mi">1</span><span class="p">),))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_equal</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">NotEqual</span><span class="p">()</span><span class="o">.</span><span class="n">shard</span><span class="p">(((</span><span class="n">dp</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seq_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice2</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">StridedSlice</span><span class="p">()</span><span class="o">.</span><span class="n">shard</span><span class="p">(((</span><span class="n">dp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),))</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">position_id</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;forward process of FollowerLossNet&quot;&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">embedding_table</span><span class="p">,</span> <span class="n">word_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">position_id</span><span class="p">,</span> <span class="n">batch_valid_length</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">embedding_table</span><span class="p">,</span> <span class="n">word_table</span><span class="p">,</span> <span class="n">position_id</span><span class="p">,</span> <span class="n">attention_mask</span>
</pre></div>
</div>
</li>
<li><p>在yaml配置文件中，描述训练网络对应的名称、输入、输出等信息。以本应用实践中参与方A的Embedding子网络为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/embedding.yaml">示例代码</a>如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">train_net</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">follower_loss_net</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_ids</span>
<span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_id</span>
<span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attention_mask</span>
<span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">embedding_table</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remote</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">word_table</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remote</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_id</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remote</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attention_mask</span>
<span class="w">        </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">remote</span>
</pre></div>
</div>
<p>其中，<code class="docutils literal notranslate"><span class="pre">name</span></code>字段为训练网络名称，将用于命名训练过程中保存的checkpoints文件。<code class="docutils literal notranslate"><span class="pre">inputs</span></code>字段为训练网络输入张量列表，<code class="docutils literal notranslate"><span class="pre">outputs</span></code>字段为训练网络输出张量列表。</p>
<p><code class="docutils literal notranslate"><span class="pre">inputs</span></code>和<code class="docutils literal notranslate"><span class="pre">outputs</span></code>字段下的<code class="docutils literal notranslate"><span class="pre">name</span></code>字段，为输入/输出张量名称。输入/输出张量的名称和顺序，需要与训练网络对应Python代码中<code class="docutils literal notranslate"><span class="pre">construct</span></code>方法的输入/输出严格对应。</p>
<p><code class="docutils literal notranslate"><span class="pre">inputs</span></code>字段下的<code class="docutils literal notranslate"><span class="pre">source</span></code>字段标识输入张量的数据来源，<code class="docutils literal notranslate"><span class="pre">local</span></code>代表输入张量来源于本地数据加载，<code class="docutils literal notranslate"><span class="pre">remote</span></code>代表输入张量来源于其它参与方网络传输。</p>
<p><code class="docutils literal notranslate"><span class="pre">outputs</span></code>字段下的<code class="docutils literal notranslate"><span class="pre">destination</span></code>字段标识输出张量的数据去向，<code class="docutils literal notranslate"><span class="pre">local</span></code>代表输出张量仅用于本地，<code class="docutils literal notranslate"><span class="pre">remote</span></code>代表输出张量将通过网络传输给其它参与方。</p>
</li>
<li><p>可选的，采用类似方法建模本参与方待参与纵向联邦学习的评估网络。</p></li>
</ol>
</div>
<div class="section" id="定义优化器">
<h3>定义优化器<a class="headerlink" href="#定义优化器" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>采用MindSpore提供的功能组件，编程开发用于本参与方训练网络参数更新的优化器。以本应用实践中参与方A用于Embedding子网络训练的自定义优化器为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/src/pangu_optim.py">示例代码</a>如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PanguAlphaAdam</span><span class="p">(</span><span class="n">TrainOneStepWithLossScaleCell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Customized Adam optimizer for training of pangu_alpha in the splitnn demo system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">optim_inst</span><span class="p">,</span> <span class="n">scale_update_cell</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">yaml_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 自定义优化器相关算子</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 定义梯度计算和参数更新过程</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>开发者可自定义优化器类的<code class="docutils literal notranslate"><span class="pre">__init__</span></code>方法的输入输出，但优化器类的<code class="docutils literal notranslate"><span class="pre">__call__</span></code>方法的输入需仅包含<code class="docutils literal notranslate"><span class="pre">inputs</span></code>和<code class="docutils literal notranslate"><span class="pre">sens</span></code>。其中，<code class="docutils literal notranslate"><span class="pre">inputs</span></code>为<code class="docutils literal notranslate"><span class="pre">list</span></code>类型，对应训练网络的输入张量列表，其元素为<code class="docutils literal notranslate"><span class="pre">mindspore.Tensor</span></code>类型。<code class="docutils literal notranslate"><span class="pre">sens</span></code>为<code class="docutils literal notranslate"><span class="pre">dict</span></code>类型，保存用于计算训练网络参数梯度值的加权系数，其key为<code class="docutils literal notranslate"><span class="pre">str</span></code>类型的梯度加权系数标识符；value为<code class="docutils literal notranslate"><span class="pre">dict</span></code>类型，其key为<code class="docutils literal notranslate"><span class="pre">str</span></code>类型，是训练网络输出张量名称，value为<code class="docutils literal notranslate"><span class="pre">mindspore.Tensor</span></code>类型，是该输出张量对应的训练网络参数梯度值的加权系数。</p>
</li>
<li><p>在yaml配置文件中，描述优化器对应的梯度计算、参数更新等信息。<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/embedding.yaml">示例代码</a>如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">opts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomizedAdam</span>
<span class="w">    </span><span class="nt">grads</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_ids</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_id</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attention_mask</span>
<span class="w">        </span><span class="nt">output</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">embedding_table</span>
<span class="w">        </span><span class="nt">sens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hidden_states</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_ids</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_id</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attention_mask</span>
<span class="w">        </span><span class="nt">output</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">word_table</span>
<span class="w">        </span><span class="nt">sens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">word_table</span>
<span class="w">    </span><span class="nt">params</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">word_embedding</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_embedding</span>
<span class="w">    </span><span class="nt">hyper_parameters</span><span class="p">:</span>
<span class="w">      </span><span class="nt">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.e-6</span>
<span class="w">      </span><span class="nt">eps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.e-8</span>
<span class="w">      </span><span class="nt">loss_scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1024.0</span>
</pre></div>
</div>
<p>其中，<code class="docutils literal notranslate"><span class="pre">type</span></code>字段为优化器类型，此处为开发者自定义优化器。</p>
<p><code class="docutils literal notranslate"><span class="pre">grads</span></code>字段为优化器关联的<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>列表，优化器将使用列表中<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子计算输出的梯度值，更新训练网络参数。<code class="docutils literal notranslate"><span class="pre">inputs</span></code>和<code class="docutils literal notranslate"><span class="pre">output</span></code>字段为<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子的输入和输出张量列表，其元素分别为一个输入/输出张量名称。<code class="docutils literal notranslate"><span class="pre">sens</span></code>字段为<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子的梯度加权系数或灵敏度（参考<a class="reference external" href="https://mindspore.cn/docs/zh-CN/r2.0/api_python/ops/mindspore.ops.GradOperation.html?highlight=gradoperation">mindspore.ops.GradOperation</a>）的标识符。</p>
<p><code class="docutils literal notranslate"><span class="pre">params</span></code>字段为优化器即将更新的训练网络参数名称列表，其元素分别为一个训练网络参数名称。本示例中，自定义优化器将更新名称中包含<code class="docutils literal notranslate"><span class="pre">word_embedding</span></code>字符串和<code class="docutils literal notranslate"><span class="pre">position_embedding</span></code>字符串的网络参数。</p>
<p><code class="docutils literal notranslate"><span class="pre">hyper_parameters</span></code>字段为优化器的超参数列表。</p>
</li>
</ol>
</div>
<div class="section" id="定义梯度加权系数计算">
<h3>定义梯度加权系数计算<a class="headerlink" href="#定义梯度加权系数计算" title="永久链接至标题">¶</a></h3>
<p>根据梯度计算的链式法则，位于全局网络后级的子网络，需要计算其输出张量相对于输入张量的梯度值，即梯度加权系数或灵敏度，传递给位于全局网络前级的子网络，用于其训练参数更新。</p>
<p>MindSpore Federated采用<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子，完成上述梯度加权系数或灵敏度计算过程。开发者需在yaml配置文件中，描述用于计算梯度加权系数的<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子。以本应用实践中参与方A的Head为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/head.yaml">示例代码</a>如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">grad_scalers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hidden_states</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input_ids</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">word_table</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position_id</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">attention_mask</span>
<span class="w">    </span><span class="nt">output</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">    </span><span class="nt">sens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1024.0</span>
</pre></div>
</div>
<p>其中，<code class="docutils literal notranslate"><span class="pre">inputs</span></code>和<code class="docutils literal notranslate"><span class="pre">output</span></code>字段为<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子的输入和输出张量列表，其元素分别为一个输入/输出张量名称。<code class="docutils literal notranslate"><span class="pre">sens</span></code>字段为该<code class="docutils literal notranslate"><span class="pre">GradOperation</span></code>算子的梯度加权系数或灵敏度（参考<a class="reference external" href="https://mindspore.cn/docs/zh-CN/r2.0/api_python/ops/mindspore.ops.GradOperation.html?highlight=gradoperation">mindspore.ops.GradOperation</a>），如果为<code class="docutils literal notranslate"><span class="pre">float</span></code>或<code class="docutils literal notranslate"><span class="pre">int</span></code>型数值，则将构造一个常量张量作为梯度加权系数，如果为<code class="docutils literal notranslate"><span class="pre">str</span></code>型字符串，则将从其它参与方经网络传输的加权系数中，解析名称与其对应的张量作为加权系数。</p>
</div>
<div class="section" id="执行训练">
<h3>执行训练<a class="headerlink" href="#执行训练" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>完成上述Python编程开发和yaml配置文件编写后，采用MindSpore Federated提供的<code class="docutils literal notranslate"><span class="pre">FLModel</span></code>类和<code class="docutils literal notranslate"><span class="pre">FLYamlData</span></code>类，构建纵向联邦学习流程。以本应用实践中参与方A的Embedding子网络为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/run_pangu_train_local.py">示例代码</a>如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">embedding_yaml</span> <span class="o">=</span> <span class="n">FLYamlData</span><span class="p">(</span><span class="s1">&#39;./embedding.yaml&#39;</span><span class="p">)</span>
<span class="n">embedding_base_net</span> <span class="o">=</span> <span class="n">EmbeddingLayer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">embedding_eval_net</span> <span class="o">=</span> <span class="n">embedding_train_net</span> <span class="o">=</span> <span class="n">EmbeddingLossNet</span><span class="p">(</span><span class="n">embedding_base_net</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">embedding_with_loss</span> <span class="o">=</span> <span class="n">_VirtualDatasetCell</span><span class="p">(</span><span class="n">embedding_eval_net</span><span class="p">)</span>
<span class="n">embedding_params</span> <span class="o">=</span> <span class="n">embedding_with_loss</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span>
<span class="n">embedding_group_params</span> <span class="o">=</span> <span class="n">set_embedding_weight_decay</span><span class="p">(</span><span class="n">embedding_params</span><span class="p">)</span>
<span class="n">embedding_optim_inst</span> <span class="o">=</span> <span class="n">FP32StateAdamWeightDecay</span><span class="p">(</span><span class="n">embedding_group_params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">embedding_optim</span> <span class="o">=</span> <span class="n">PanguAlphaAdam</span><span class="p">(</span><span class="n">embedding_train_net</span><span class="p">,</span> <span class="n">embedding_optim_inst</span><span class="p">,</span> <span class="n">update_cell</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">embedding_yaml</span><span class="p">)</span>

<span class="n">embedding_fl_model</span> <span class="o">=</span> <span class="n">FLModel</span><span class="p">(</span><span class="n">yaml_data</span><span class="o">=</span><span class="n">embedding_yaml</span><span class="p">,</span>
                             <span class="n">network</span><span class="o">=</span><span class="n">embedding_train_net</span><span class="p">,</span>
                             <span class="n">eval_network</span><span class="o">=</span><span class="n">embedding_eval_net</span><span class="p">,</span>
                             <span class="n">optimizers</span><span class="o">=</span><span class="n">embedding_optim</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，<code class="docutils literal notranslate"><span class="pre">FLYamlData</span></code>类主要完成yaml配置文件的解析和校验，<code class="docutils literal notranslate"><span class="pre">FLModel</span></code>类主要提供纵向联邦学习训练、推理等流程的控制接口。</p>
</li>
<li><p>调用<code class="docutils literal notranslate"><span class="pre">FLModel</span></code>类的接口方法，执行纵向联邦学习训练。以本应用实践中参与方A的Embedding子网络为例，<a class="reference external" href="https://gitee.com/mindspore/federated/blob/r0.1/example/splitnn_pangu_alpha/run_pangu_train_local.py">示例代码</a>如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
    <span class="n">embedding_fl_model</span><span class="o">.</span><span class="n">load_ckpt</span><span class="p">()</span>
    <span class="o">...</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># forward process</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">*</span> <span class="n">train_size</span> <span class="o">+</span> <span class="n">step</span>
        <span class="n">embedding_out</span> <span class="o">=</span> <span class="n">embedding_fl_model</span><span class="o">.</span><span class="n">forward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="c1"># backward process</span>
        <span class="n">embedding_fl_model</span><span class="o">.</span><span class="n">backward_one_step</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="n">backbone_scale</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">embedding_fl_model</span><span class="o">.</span><span class="n">save_ckpt</span><span class="p">()</span>
</pre></div>
</div>
<p>其中，<code class="docutils literal notranslate"><span class="pre">forward_one_step</span></code>方法和<code class="docutils literal notranslate"><span class="pre">backward_one_step</span></code>方法分别执行一个数据batch的前向推理和反向传播操作。<code class="docutils literal notranslate"><span class="pre">load_ckpt</span></code>方法和<code class="docutils literal notranslate"><span class="pre">save_ckpt</span></code>方法分别执行checkpoints文件的加载和保存操作。</p>
</li>
</ol>
</div>
</div>
<div class="section" id="运行样例">
<h2>运行样例<a class="headerlink" href="#运行样例" title="永久链接至标题">¶</a></h2>
<p>本样例提供2个示例程序，均以Shell脚本拉起Python程序的形式运行。</p>
<ol>
<li><p><code class="docutils literal notranslate"><span class="pre">run_pangu_train_local.sh</span></code>：单进程示例程序，参与方A和参与方B同一进程训练，其以程序内变量的方式，直接传输特征张量和梯度张量至另一参与方。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_pangu_train_leader.sh</span></code>和<code class="docutils literal notranslate"><span class="pre">run_pangu_train_follower.sh</span></code>：多进程示例程序，参与方A和参与方B分别运行一个进程，其分别将特征张量和梯度张量封装为protobuf消息后，通过https通信接口传输至另一参与方。<code class="docutils literal notranslate"><span class="pre">run_pangu_train_leader.sh</span></code>和<code class="docutils literal notranslate"><span class="pre">run_pangu_train_follower.sh</span></code>可分别在两台服务器上运行，实现跨域协同训练。</p></li>
<li><p>当前纵向联邦分布式训练支持https跨域加密通信，启动命令如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 以https加密通信的方式启动leader进程：</span>
bash<span class="w"> </span>run_pangu_train_leader.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span>/path/to/train/data_set<span class="w"> </span>/path/to/eval/data_set<span class="w"> </span>True<span class="w"> </span>server_cert_password<span class="w"> </span>client_cert_password<span class="w"> </span>/path/to/server_cert<span class="w"> </span>/path/to/client_cert<span class="w"> </span>/path/to/ca_cert

<span class="c1"># 以https加密通信的方式启动follower进程：</span>
bash<span class="w"> </span>run_pangu_train_follower.sh<span class="w"> </span><span class="m">127</span>.0.0.1:10086<span class="w"> </span><span class="m">127</span>.0.0.1:10087<span class="w"> </span>True<span class="w"> </span>server_cert_password<span class="w"> </span>client_cert_password<span class="w"> </span>/path/to/server_cert<span class="w"> </span>/path/to/client_cert<span class="w"> </span>/path/to/ca_cert
</pre></div>
</div>
</li>
</ol>
<div class="section" id="运行单进程样例">
<h3>运行单进程样例<a class="headerlink" href="#运行单进程样例" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">run_pangu_train_local.sh</span></code>为例，运行示例程序的步骤如下：</p>
<ol>
<li><p>进入示例程序目录：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>federated/example/splitnn_pangu_alpha/
</pre></div>
</div>
</li>
<li><p>以wiki数据集为例，拷贝数据集至示例程序目录：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-r<span class="w"> </span><span class="o">{</span>dataset_dir<span class="o">}</span>/wiki<span class="w"> </span>./
</pre></div>
</div>
</li>
<li><p>安装依赖的Python软件包：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</pre></div>
</div>
</li>
<li><p>修改<code class="docutils literal notranslate"><span class="pre">src/utils.py</span></code>，配置checkpoint文件加载路径、训练数据集路径、评估数据集路径等参数，示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--load_ckpt_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./checkpoints&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;predict file path.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data_url&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./wiki/train/&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Location of data.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--eval_data_url&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./wiki/eval/&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Location of eval data.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>执行训练脚本：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./run_pangu_train_local.sh
</pre></div>
</div>
</li>
<li><p>查看训练日志<code class="docutils literal notranslate"><span class="pre">splitnn_pangu_local.txt</span></code>中记录的训练loss信息。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>INFO:root:epoch 0 step 10/43391 loss: 10.616087
INFO:root:epoch 0 step 20/43391 loss: 10.424824
INFO:root:epoch 0 step 30/43391 loss: 10.209235
INFO:root:epoch 0 step 40/43391 loss: 9.950026
INFO:root:epoch 0 step 50/43391 loss: 9.712448
INFO:root:epoch 0 step 60/43391 loss: 9.557744
INFO:root:epoch 0 step 70/43391 loss: 9.501564
INFO:root:epoch 0 step 80/43391 loss: 9.326054
INFO:root:epoch 0 step 90/43391 loss: 9.387547
INFO:root:epoch 0 step 100/43391 loss: 8.795234
...
</pre></div>
</div>
<p>对应的可视化结果如下图所示，其中横轴为训练步数，纵轴为loss值，红色曲线为盘古α训练loss值，蓝色曲线为本示例中基于拆分学习的盘古α训练loss值。二者loss值下降的趋势基本一致，考虑到网络参数值初始化具有随机性，可验证训练过程的正确性。</p>
<p><img alt="盘古α大模型跨域训练结果" src="_images/splitnn_pangu_alpha_result.png" /></p>
</li>
</ol>
</div>
<div class="section" id="运行多进程样例">
<h3>运行多进程样例<a class="headerlink" href="#运行多进程样例" title="永久链接至标题">¶</a></h3>
<ol>
<li><p>类似单进程样例，进入示例程序目录，安装依赖的Python软件包：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>federated/example/splitnn_pangu_alpha/
python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</pre></div>
</div>
</li>
<li><p>拷贝数据集至服务器1的示例程序目录：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span><span class="o">{</span>dataset_dir<span class="o">}</span>/wiki<span class="w"> </span>./
</pre></div>
</div>
</li>
<li><p>在服务器1启动参与方A的训练脚本：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./run_pangu_train_leader.sh<span class="w"> </span><span class="o">{</span>ip_address_server1<span class="o">}</span><span class="w"> </span><span class="o">{</span>ip_address_server2<span class="o">}</span><span class="w"> </span>./wiki/train<span class="w"> </span>./wiki/train
</pre></div>
</div>
<p>训练脚本的第1个参数是本地服务器（服务器1）的IP地址和端口号，第2个参数是对端服务器（服务器2）的IP地址和端口号，第3个参数是训练数据集文件路径，第4个参数是评估数据集文件路径，第5个参数标识是否加载已有的checkpoint文件。</p>
</li>
<li><p>在服务器2启动参与方B的训练脚本：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./run_pangu_train_follower.sh<span class="w"> </span><span class="o">{</span>ip_address_server2<span class="o">}</span><span class="w"> </span><span class="o">{</span>ip_address_server1<span class="o">}</span>
</pre></div>
</div>
<p>训练脚本的第1个参数是本地服务器（服务器2）的IP地址和端口号，第2个参数是对端服务器（服务器2）的IP地址和端口号，第3个参数标识是否加载已有的checkpoint文件。</p>
</li>
<li><p>查看服务器1的训练日志<code class="docutils literal notranslate"><span class="pre">leader_processs.log</span></code>中记录的训练loss信息。若其loss信息与盘古α集中式训练loss值趋势一致，可验证训练过程的正确性。</p></li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="local_differential_privacy_training_noise.html" class="btn btn-neutral float-right" title="横向联邦-局部差分隐私加噪训练" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="split_wnd_application.html" class="btn btn-neutral float-left" title="纵向联邦学习模型训练 - Wide&amp;Deep推荐应用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>