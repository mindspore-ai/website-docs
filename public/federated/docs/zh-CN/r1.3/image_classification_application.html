

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>实现一个图像分类应用(x86) &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="实现一个情感分类应用(Android)" href="sentiment_classification_application.html" />
    <link rel="prev" title="端侧部署" href="deploy_federated_client.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">获取MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">云侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">端侧部署</a></li>
</ul>
<p class="caption"><span class="caption-text">应用实践</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">实现一个图像分类应用(x86)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">下载数据集</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">定义网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">定义训练过程</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">生成端侧模型文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">模拟启动多客户端参与联邦学习</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sentiment_classification_application.html">实现一个情感分类应用(Android)</a></li>
</ul>
<p class="caption"><span class="caption-text">安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="security_and_privacy_protection.html">模型安全和隐私</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>实现一个图像分类应用(x86)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/image_classification_application.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="x86">
<h1>实现一个图像分类应用(x86)<a class="headerlink" href="#x86" title="Permalink to this headline">¶</a></h1>
<!-- TOC -->
<ul class="simple">
<li><p><a class="reference external" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB%E5%BA%94%E7%94%A8x86">实现一个图像分类应用(x86)</a></p>
<ul>
<li><p><a class="reference external" href="#%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE%E9%9B%86">下载数据集</a></p></li>
<li><p><a class="reference external" href="#%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C">定义网络</a></p></li>
<li><p><a class="reference external" href="#%E5%AE%9A%E4%B9%89%E8%AE%AD%E7%BB%83%E8%BF%87%E7%A8%8B">定义训练过程</a></p></li>
<li><p><a class="reference external" href="#%E7%94%9F%E6%88%90%E7%AB%AF%E4%BE%A7%E6%A8%A1%E5%9E%8B%E6%96%87%E4%BB%B6">生成端侧模型文件</a></p></li>
<li><p><a class="reference external" href="#%E6%A8%A1%E6%8B%9F%E5%90%AF%E5%8A%A8%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%82%E4%B8%8E%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0">模拟启动多客户端参与联邦学习</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><a href="https://gitee.com/mindspore/docs/blob/r1.3/docs/federated/docs/source_zh_cn/image_classification_application.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png"></a></p>
<p>在动手进行实践之前，确保，你已经正确安装了MindSpore。如果没有，可以参考<a class="reference external" href="https://www.mindspore.cn/install">MindSpore安装页面</a>完成安装。</p>
<div class="section" id="id1">
<h2>下载数据集<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>参考<a class="reference external" href="https://github.com/TalwalkarLab/leaf">leaf数据集官方指导</a>下载数据集。</p>
<p>本示例采用<code class="docutils literal notranslate"><span class="pre">leaf</span></code>数据集中的联邦学习数据集<code class="docutils literal notranslate"><span class="pre">FEMNIST</span></code>， 该数据集包含62个不同类别的手写数字和字母（数字0~9、26个小写字母、26个大写字母），图像大小为<code class="docutils literal notranslate"><span class="pre">28</span> <span class="pre">x</span> <span class="pre">28</span></code>像素，数据集包含3500个用户的手写数字和字母（最多可模拟3500个客户端参与联邦学习），总数据量为805263，平均每个用户包含数据量为226.83，所有用户数据量的方差为88.94。</p>
<ol>
<li><p>下载数据集前的环境要求。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">numpy</span><span class="o">==</span><span class="m">1</span>.16.4
scipy                      <span class="c1"># conda install scipy</span>
<span class="nv">tensorflow</span><span class="o">==</span><span class="m">1</span>.13.1         <span class="c1"># pip install tensorflow</span>
Pillow                     <span class="c1"># pip install Pillow</span>
matplotlib                 <span class="c1"># pip install matplotlib</span>
jupyter                    <span class="c1"># conda install jupyter notebook==5.7.8 tornado==4.5.3</span>
pandas                     <span class="c1"># pip install pandas</span>
</pre></div>
</div>
</li>
<li><p>使用git下载官方数据集生成脚本。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/TalwalkarLab/leaf.git
</pre></div>
</div>
<p>下载项目后，目录结构如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist
    ├── data  <span class="c1"># 用来存放指令生成的数据集</span>
    ├── preprocess  <span class="c1"># 存放数据预处理的相关代码</span>
    ├── preprocess.sh  <span class="c1"># femnist数据集生成shell脚本</span>
    └── README.md  <span class="c1"># 官方数据集下载指导文档</span>
</pre></div>
</div>
</li>
<li><p>以<code class="docutils literal notranslate"><span class="pre">femnist</span></code>数据集为例，运行以下指令进入指定路径。</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>  leaf/data/femnist
</pre></div>
</div>
</li>
<li><p>参考<code class="docutils literal notranslate"><span class="pre">README.md</span></code>文件中的说明，在终端输入指令即可下载对应数据集。</p>
<p>运行<code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span></code>具有以下标签的选择：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-s</span></code>：’iid’以iid方式采样，或’niid’以非iid方式采样。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--iu</span></code>：用户数（如果进行iid采样）；表示为用户总数的分数；默认值为0.01。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--sf</span></code>：要采样的数据部分，用十进制表示；默认值为0.1。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-k</span></code>：每个用户的最小样本数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-t</span></code>：’user’将用户划分为训练测试组，或’sample’将每个用户的样本划分为训练测试组。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--tf</span></code>：训练集中的数据部分，用小数表示；默认值为0.9。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--smplseed</span></code>：随机抽样数据之前要使用的种子。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--spltseed</span></code>：随机分割数据之前要使用的种子。</p></li>
</ul>
<p>例如：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">1.0</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code> （下载完整数据集）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">0.05</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code> （下载小型数据集）。</p></li>
</ul>
<p>在重新运行<code class="docutils literal notranslate"><span class="pre">preprocess.sh</span></code>之前，请确保删除数据目录中的<code class="docutils literal notranslate"><span class="pre">rem_user_data</span></code>、<code class="docutils literal notranslate"><span class="pre">sampled_data</span></code>、<code class="docutils literal notranslate"><span class="pre">test</span></code>和<code class="docutils literal notranslate"><span class="pre">train</span></code>子文件夹。</p>
</li>
<li><p>用指令<code class="docutils literal notranslate"><span class="pre">./preprocess.sh</span> <span class="pre">-s</span> <span class="pre">niid</span> <span class="pre">--sf</span> <span class="pre">1.0</span> <span class="pre">-k</span> <span class="pre">0</span> <span class="pre">-t</span> <span class="pre">sample</span></code>生成的数据集包含3500个用户，且按照9:1对每个用户的数据划分训练和测试集。</p>
<p>运行之后目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist/35_client_sf1_data/
    ├── all_data  # 所有数据集混合在一起，不区分训练测试集，共包含35个json文件，每个json文件包含100个用户的数据
    ├── test  # 按照9:1对每个用户的数据划分训练和测试集后的测试集，共包含35个json文件，每个json文件包含100个用户的数据
    ├── train  # 按照9:1对每个用户的数据划分训练和测试集后的训练集，共包含35个json文件，每个json文件包含100个用户的数据
    └── ...  # 其他文件，暂不需要用到，不作介绍
</pre></div>
</div>
<p>其中每个json文件包含以下三个部分：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">users</span></code>: 用户列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: 每个用户的样本数量列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: 一个以用户名为key，以它们各自的数据为value的字典对象；对于每个用户，数据表示为图像列表，每张图像表示为大小为784的整数列表（将<code class="docutils literal notranslate"><span class="pre">28</span> <span class="pre">x</span> <span class="pre">28</span></code>图像数组展平所得）。</p></li>
</ul>
</li>
<li><p>将35个json文件划分为3500个json文件（每个json文件代表一个用户）。</p>
<p>参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">partition_json</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">new_root_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    partition 35 json files to 3500 json file</span>

<span class="sd">    Each raw .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;users&#39;, a list of users</span>
<span class="sd">    2. &#39;num_samples&#39;, a list of the number of samples for each user</span>
<span class="sd">    3. &#39;user_data&#39;, an object with user names as keys and their respective data as values; for each user, data is represented as a list of images, with each image represented as a size-784 integer list (flattened from 28 by 28)</span>

<span class="sd">    Each new .json file is an object with 3 keys:</span>
<span class="sd">    1. &#39;user_name&#39;, the name of user</span>
<span class="sd">    2. &#39;num_samples&#39;, the number of samples for the user</span>
<span class="sd">    3. &#39;user_data&#39;, an dict object with &#39;x&#39; as keys and their respective data as values; with &#39;y&#39; as keys and their respective label as values;</span>

<span class="sd">    Args:</span>
<span class="sd">        root_path (str): raw root path of 35 json files</span>
<span class="sd">        new_root_path (str): new root path of 3500 json files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">file_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======== process &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;======================&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f</span><span class="p">:</span>
            <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f</span><span class="p">)</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
            <span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---processing user: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;---&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;num_samples&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">cur_user_id</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_data_num</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cur_user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">,</span> <span class="n">cur_user_id</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_user_id</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_data_num</span>
                <span class="n">cur_out</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="n">cur_user_id</span><span class="p">])</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cur_user_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cur_out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_root_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s1">&#39; users have been processed!&#39;</span><span class="p">)</span>
<span class="c1"># partition train json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/35_client_sf1_data/train&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_json/train&quot;</span><span class="p">)</span>
<span class="c1"># partition test json files</span>
<span class="n">partition_json</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/35_client_sf1_data/test&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_json/test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>其中<code class="docutils literal notranslate"><span class="pre">root_path</span></code>为<code class="docutils literal notranslate"><span class="pre">leaf/data/femnist/35_client_sf1_data/{train,test}</span></code>，<code class="docutils literal notranslate"><span class="pre">new_root_path</span></code>自行设置，用于存放生成的3500个用户json文件，需分别对训练和测试文件夹进行处理。</p>
<p>新生成的3500个用户json文件，每个文件均包含以下三个部分：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">user_name</span></code>: 用户名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_samples</span></code>: 用户的样本数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>: 一个以’x’为key，以用户数据为value的字典对象； 以’y’为key，以用户数据对应的标签为value。</p></li>
</ul>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">========</span> process <span class="m">1</span> file: /leaf/data/femnist/35_client_sf1_data/train/all_data_16_niid_0_keep_0_train_9.json<span class="o">======================</span>
---processing user: <span class="m">1</span>---
---processing user: <span class="m">2</span>---
---processing user: <span class="m">3</span>---
---processing user: <span class="m">4</span>---
---processing user: <span class="m">5</span>---
---processing user: <span class="m">6</span>---
---processing user: <span class="m">7</span>---
---processing user: <span class="m">8</span>---
---processing user: <span class="m">9</span>---
---processing user: <span class="m">10</span>---
---processing user: <span class="m">11</span>---
---processing user: <span class="m">12</span>---
---processing user: <span class="m">13</span>---
---processing user: <span class="m">14</span>---
......
</pre></div>
</div>
</li>
<li><p>将json文件转换为图片文件。</p>
<p>可参考如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span>
             <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span>
             <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
             <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span>
             <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span>
             <span class="p">]</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">json_2_numpy</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read json file to numpy</span>
<span class="sd">    Args:</span>
<span class="sd">        img_size (list): contain three elements: the height, width, channel of image</span>
<span class="sd">        file_path (str): root path of 3500 json files</span>
<span class="sd">    return:</span>
<span class="sd">        image_numpy (numpy)</span>
<span class="sd">        label_numpy (numpy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># open json file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">load_f_train</span><span class="p">:</span>
        <span class="n">load_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_f_train</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;num_samples&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">load_dict</span><span class="p">[</span><span class="s1">&#39;user_data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">image_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>  <span class="c1"># mindspore doesn&#39;t support float64 and int64</span>
        <span class="n">label_numpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_numpy</span><span class="p">,</span> <span class="n">label_numpy</span>

<span class="k">def</span> <span class="nf">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform single json file to images</span>

<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the path json file</span>
<span class="sd">        save_path (str): the root path to save images</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">json_2_numpy</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">json_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span>  <span class="c1"># PIL don&#39;t support the 0/1 image ,need convert to 0~255 image</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
        <span class="n">img_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name_list</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">img_name</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;-----&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">all_json_2_img</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">save_root_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform json files to images</span>
<span class="sd">    Args:</span>
<span class="sd">        json_path (str): the root path of 3500 json files</span>
<span class="sd">        save_path (str): the root path to save images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">files_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">user_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">save_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_root_path</span><span class="p">,</span> <span class="n">user_name</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path1</span><span class="p">)</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=============================&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;=======================&#39;</span><span class="p">)</span>
            <span class="n">json_2_img</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>

<span class="n">all_json_2_img</span><span class="p">(</span><span class="s2">&quot;leaf/data/femnist/3500_client_json/&quot;</span><span class="p">,</span> <span class="s2">&quot;leaf/data/femnist/3500_client_img/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">=============================</span>f0644_19.json<span class="o">=======================</span>
----- <span class="m">0</span> -----
----- <span class="m">1</span> -----
----- <span class="m">2</span> -----
----- <span class="m">3</span> -----
----- <span class="m">4</span> -----
----- <span class="m">5</span> -----
----- <span class="m">6</span> -----
----- <span class="m">7</span> -----
----- <span class="m">8</span> -----
----- <span class="m">9</span> -----
----- <span class="m">10</span> -----
......
</pre></div>
</div>
</li>
<li><p>将图片数据集转换为联邦学习框架可用的bin文件格式。</p>
<p>可参考下面代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">tC</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision.py_transforms</span> <span class="k">as</span> <span class="nn">PV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.py_transforms</span> <span class="k">as</span> <span class="nn">PT</span>
<span class="kn">import</span> <span class="nn">mindspore</span>

<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count_id</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ids</span>

<span class="k">def</span> <span class="nf">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create dataset for train or test</span>
<span class="sd">        Args:</span>
<span class="sd">            data_path: Data path</span>
<span class="sd">            batch_size: The number of data records in each group</span>
<span class="sd">            repeat_size: The number of replicated data records</span>
<span class="sd">            num_parallel_workers: The number of parallel workers</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">count_id</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ImageFolderDataset</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_indexing</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
    <span class="c1"># define operation parameters</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 32</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Decode</span><span class="p">(),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">)),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">PV</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="p">]</span>
    <span class="n">compose</span> <span class="o">=</span> <span class="n">PT</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>

    <span class="c1"># apply map operations on images</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">tC</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mindspore</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">compose</span><span class="p">)</span>

    <span class="c1"># apply DatasetOps</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>  <span class="c1"># 10000 as in LeNet train script</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="k">def</span> <span class="nf">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    transform images to bin files</span>

<span class="sd">    Args:</span>
<span class="sd">    root_path: the root path of 3500 images files</span>
<span class="sd">    root_save: the root path to save bin files</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_batch_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">root_save</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">use_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">train_test</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">user_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">train_test</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_path</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset_from_folder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">batch_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">():</span>
                <span class="n">batch_x_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="n">batch_y_tensor</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">trans_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">batch_x_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trans_img</span><span class="p">)</span>
                <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_y_tensor</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                <span class="n">batch_num</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                <span class="n">train_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="n">test_batch_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span>

            <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>  <span class="c1"># (batch_num, 32,3,32,32)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
            <span class="n">path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_save</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_data.bin&quot;</span><span class="p">)</span>
            <span class="n">label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;bn_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_label.bin&quot;</span><span class="p">)</span>

            <span class="n">imgs</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">label_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user: &quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s2">&quot;_batch_num: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_num</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">use_list</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; users finished!&quot;</span><span class="p">)</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="s2">&quot;leaf/data/femnist/3500_client_img/&quot;</span>
<span class="n">root_save</span> <span class="o">=</span> <span class="s2">&quot;leaf/data/femnist/3500_clients_bin&quot;</span>
<span class="n">img2bin</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">root_save</span><span class="p">)</span>
</pre></div>
</div>
<p>运行该脚本打印如下，代表运行成功：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>user: f0141_43 test_batch_num: <span class="m">1</span>
user: f0141_43 train_batch_num: <span class="m">10</span>
user: f0137_14 test_batch_num: <span class="m">1</span>
user: f0137_14 train_batch_num: <span class="m">11</span>
user: f0049_32 test_batch_num: <span class="m">1</span>
user: f0049_32 train_batch_num: <span class="m">11</span>
user: f0178_39 test_batch_num: <span class="m">1</span>
user: f0178_39 train_batch_num: <span class="m">9</span>
user: f0222_06 test_batch_num: <span class="m">1</span>
user: f0222_06 train_batch_num: <span class="m">9</span>
......
total <span class="m">3500</span> users finished!
</pre></div>
</div>
</li>
<li><p>生成<code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code>文件夹内共包含3500个用户文件夹，其目录结构如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>leaf/data/femnist/3500_clients_bin
  ├── f0000_14  <span class="c1"># 用户编号</span>
  │   ├── f0000_14_bn_10_train_data.bin  <span class="c1"># 用户f0000_14的训练数据 （bn_后面的数字10代表batch number）</span>
  │   ├── f0000_14_bn_10_train_label.bin  <span class="c1"># 用户f0000_14的训练标签</span>
  │   ├── f0000_14_bn_1_test_data.bin  <span class="c1"># 用户f0000_14的测试数据   （bn_后面的数字1代表batch number）</span>
  │   └── f0000_14_bn_1_test_label.bin  <span class="c1"># 用户f0000_14的测试标签</span>
  ├── f0001_41  <span class="c1"># 用户编号</span>
  │   ├── f0001_41_bn_11_train_data.bin  <span class="c1"># 用户f0001_41的训练数据 （bn_后面的数字11代表batch number）</span>
  │   ├── f0001_41_bn_11_train_label.bin  <span class="c1"># 用户f0001_41的训练标签</span>
  │   ├── f0001_41_bn_1_test_data.bin  <span class="c1"># 用户f0001_41的测试数据   （bn_后面的数字1代表batch number）</span>
  │   └── f0001_41_bn_1_test_label.bin  <span class="c1">#  用户f0001_41的测试标签</span>
  │                    ...
  └── f4099_10  <span class="c1"># 用户编号</span>
      ├── f4099_10_bn_4_train_data.bin  <span class="c1"># 用户f4099_10的训练数据 （bn_后面的数字4代表batch number）</span>
      ├── f4099_10_bn_4_train_label.bin  <span class="c1"># 用户f4099_10的训练标签</span>
      ├── f4099_10_bn_1_test_data.bin  <span class="c1"># 用户f4099_10的测试数据   （bn_后面的数字1代表batch number）</span>
      └── f4099_10_bn_1_test_label.bin  <span class="c1"># 用户f4099_10的测试标签</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="id2">
<h2>定义网络<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>我们选择相对简单的LeNet网络。LeNet网络不包括输入层的情况下，共有7层：2个卷积层、2个下采样层（池化层）、3个全连接层。每层都包含不同数量的训练参数，如下图所示：</p>
<p><img alt="LeNet5" src="_images/LeNet_5.jpg" /></p>
<blockquote>
<div><p>更多的LeNet网络的介绍不在此赘述，希望详细了解LeNet网络，可以查询<a class="reference external" href="http://yann.lecun.com/exdb/lenet/">http://yann.lecun.com/exdb/lenet/</a>。</p>
</div></blockquote>
<p>网络定义流程可参考<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py文件</a>。</p>
<p>具体网络定义流程可参考<a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/zh-CN/r1.3/quick_start/quick_start.html#%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C">图片分类应用</a>。</p>
</div>
<div class="section" id="id3">
<h2>定义训练过程<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>可参考如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore.context</span> <span class="k">as</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">TrainOneStepCell</span><span class="p">,</span> <span class="n">WithLossCell</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">LeNet5</span>
<span class="kn">from</span> <span class="nn">src.adam</span> <span class="kn">import</span> <span class="n">AdamWeightDecayOp</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;test_fl_lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_target&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;FEDERATED_LEARNING&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ms_role&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;MS_WORKER&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--worker_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_ip&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8113</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_server_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6666</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start_fl_job_threshold&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start_fl_job_time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--update_model_ratio&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--update_model_time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fl_iteration_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_epoch_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scheduler_manage_port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">11202</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">device_target</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device_target</span>
<span class="n">server_mode</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_mode</span>
<span class="n">ms_role</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ms_role</span>
<span class="n">worker_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">worker_num</span>
<span class="n">server_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_num</span>
<span class="n">scheduler_ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_ip</span>
<span class="n">scheduler_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_port</span>
<span class="n">fl_server_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_server_port</span>
<span class="n">start_fl_job_threshold</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_fl_job_threshold</span>
<span class="n">start_fl_job_time_window</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_fl_job_time_window</span>
<span class="n">update_model_ratio</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">update_model_ratio</span>
<span class="n">update_model_time_window</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">update_model_time_window</span>
<span class="n">fl_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_name</span>
<span class="n">fl_iteration_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fl_iteration_num</span>
<span class="n">client_epoch_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_epoch_num</span>
<span class="n">client_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_batch_size</span>
<span class="n">client_learning_rate</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_learning_rate</span>
<span class="n">scheduler_manage_port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">scheduler_manage_port</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;enable_fl&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;server_mode&quot;</span><span class="p">:</span> <span class="n">server_mode</span><span class="p">,</span>
    <span class="s2">&quot;ms_role&quot;</span><span class="p">:</span> <span class="n">ms_role</span><span class="p">,</span>
    <span class="s2">&quot;worker_num&quot;</span><span class="p">:</span> <span class="n">worker_num</span><span class="p">,</span>
    <span class="s2">&quot;server_num&quot;</span><span class="p">:</span> <span class="n">server_num</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_ip&quot;</span><span class="p">:</span> <span class="n">scheduler_ip</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_port&quot;</span><span class="p">:</span> <span class="n">scheduler_port</span><span class="p">,</span>
    <span class="s2">&quot;fl_server_port&quot;</span><span class="p">:</span> <span class="n">fl_server_port</span><span class="p">,</span>
    <span class="s2">&quot;start_fl_job_threshold&quot;</span><span class="p">:</span> <span class="n">start_fl_job_threshold</span><span class="p">,</span>
    <span class="s2">&quot;start_fl_job_time_window&quot;</span><span class="p">:</span> <span class="n">start_fl_job_time_window</span><span class="p">,</span>
    <span class="s2">&quot;update_model_ratio&quot;</span><span class="p">:</span> <span class="n">update_model_ratio</span><span class="p">,</span>
    <span class="s2">&quot;update_model_time_window&quot;</span><span class="p">:</span> <span class="n">update_model_time_window</span><span class="p">,</span>
    <span class="s2">&quot;fl_name&quot;</span><span class="p">:</span> <span class="n">fl_name</span><span class="p">,</span>
    <span class="s2">&quot;fl_iteration_num&quot;</span><span class="p">:</span> <span class="n">fl_iteration_num</span><span class="p">,</span>
    <span class="s2">&quot;client_epoch_num&quot;</span><span class="p">:</span> <span class="n">client_epoch_num</span><span class="p">,</span>
    <span class="s2">&quot;client_batch_size&quot;</span><span class="p">:</span> <span class="n">client_batch_size</span><span class="p">,</span>
    <span class="s2">&quot;client_learning_rate&quot;</span><span class="p">:</span> <span class="n">client_learning_rate</span><span class="p">,</span>
    <span class="s2">&quot;scheduler_manage_port&quot;</span><span class="p">:</span> <span class="n">scheduler_manage_port</span>
<span class="p">}</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">device_target</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_fl_context</span><span class="p">(</span><span class="o">**</span><span class="n">ctx</span><span class="p">)</span>               <span class="c1"># 设置联邦学习训练流程相关参数</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">net_adam_opt</span> <span class="o">=</span> <span class="n">AdamWeightDecayOp</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">net_with_criterion</span> <span class="o">=</span> <span class="n">WithLossCell</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
    <span class="n">train_network</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net_with_criterion</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">)</span>
    <span class="n">train_network</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_network</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
<p>其中字典<code class="docutils literal notranslate"><span class="pre">ctx</span></code>中参数<code class="docutils literal notranslate"><span class="pre">enable_fl</span></code>用于设置是否启动联邦学习训练流程，为<code class="docutils literal notranslate"><span class="pre">true</span></code>代表启动联邦学习流程，为<code class="docutils literal notranslate"><span class="pre">false</span></code>代表启动普通训练流程，其他参数可以根据实际情况进行设置。由于只需要生成可用的模型文件即可，上面脚本中<code class="docutils literal notranslate"><span class="pre">data</span></code>和<code class="docutils literal notranslate"><span class="pre">label</span></code>均采用了模拟数据。</p>
<p>其中<code class="docutils literal notranslate"><span class="pre">src.model</span></code>为模型定义文件可参考<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py文件</a>，<code class="docutils literal notranslate"><span class="pre">src.adam</span></code>为优化器定义文件可参考<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/adam.py">adam.py文件</a>。</p>
<p>具体优化器损失函数定义可参考<a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/zh-CN/r1.3/quick_start/quick_start.html#%E5%AE%9A%E4%B9%89%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E5%8F%8A%E4%BC%98%E5%8C%96%E5%99%A8">图片分类应用</a>。</p>
</div>
<div class="section" id="id4">
<h2>生成端侧模型文件<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>将模型导出为MindIR格式文件。</p>
<p>可在<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py</a>的训练流程代码中添加<code class="docutils literal notranslate"><span class="pre">export</span></code>语句获取MindIR格式模型文件， 示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">export</span>
<span class="o">...</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_network</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">mindir_name</span> <span class="o">=</span> <span class="s2">&quot;lenet_train.mindir&quot;</span>
        <span class="n">export</span><span class="p">(</span><span class="n">train_network</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span> <span class="n">mindir_name</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>  <span class="c1"># 添加export语句获取MindIR格式模型文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
<p>生成MindIR格式模型文件时，需要先将<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/tests/st/fl/mobile/src/model.py">model.py</a>文件中<code class="docutils literal notranslate"><span class="pre">context.set_fl_context(**ctx)</span></code>语句注释，同时<code class="docutils literal notranslate"><span class="pre">epoch</span></code>设置为1即可，运行<code class="docutils literal notranslate"><span class="pre">model.py</span></code>要求环境中安装<a class="reference external" href="https://www.mindspore.cn/install">MindSpore</a>。运行脚步<code class="docutils literal notranslate"><span class="pre">model.py</span></code>之后会在当前路径下生成文件<code class="docutils literal notranslate"><span class="pre">lenet_train.mindir</span></code>。</p>
<p>具体可参考<a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/zh-CN/r1.3/save_model.html#mindir">导出MindIR格式文件</a>。</p>
</li>
<li><p>将MindIR文件转化为联邦学习端侧框架可用的ms文件。</p>
<p>模型转换可参考<a class="reference external" href="https://www.mindspore.cn/lite/docs/zh-CN/r1.3/use/converter_train.html">训练模型转换教程</a>。</p>
<p>模型转换示例如下：</p>
<p>假设待转换的模型文件为<code class="docutils literal notranslate"><span class="pre">lenet_train.mindir</span></code>，执行如下转换命令：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./converter_lite --fmk<span class="o">=</span>MINDIR --trainModel<span class="o">=</span><span class="nb">true</span> --modelFile<span class="o">=</span>lenet_train.mindir --outputFile<span class="o">=</span>lenet_train
</pre></div>
</div>
<p>转换成功输出如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERTER RESULT SUCCESS:0
</pre></div>
</div>
<p>这表明MindSpore模型成功转换为MindSpore端侧模型，并生成了新文件<code class="docutils literal notranslate"><span class="pre">lenet_train.ms</span></code>。如果转换失败输出如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>CONVERT RESULT FAILED:
</pre></div>
</div>
<p>将生成的<code class="docutils literal notranslate"><span class="pre">.ms</span></code>格式的模型文件放在某个路径上，在调用联邦学习接口时可设置<code class="docutils literal notranslate"><span class="pre">FLParameter.trainModelPath</span></code>为该模型文件的路径。</p>
</li>
</ol>
</div>
<div class="section" id="id5">
<h2>模拟启动多客户端参与联邦学习<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>可编写一个Python脚本，调用联邦学习框架jar包（x86环境联邦学习jar包获取可参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_client.html">端侧部署中编译出包流程</a>）来模拟启动多客户端联邦学习任务。</p>
<ol>
<li><p>以Lenet网络为例，参考脚本<code class="docutils literal notranslate"><span class="pre">run.py</span></code>如下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run TestClient.java case&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--jarPath&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mindspore-lite-java-flclient.jar&quot;</span><span class="p">)</span>  <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_dataset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;leaf/data/femnist/3500_clients_bin/&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_dataset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--vocal_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ids_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>   <span class="c1"># must be absolute path</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--flName&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lenet&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_model_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="p">)</span>    <span class="c1"># must be absolute path of .ms files</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--infer_model_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ms/lenet/&quot;</span><span class="p">)</span>    <span class="c1"># must be absolute path of .ms files</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ip&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10.113.216.106&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ssl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6668</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client_num&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--time_window&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_elb&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_https&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cert_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--task&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">jarPath</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">jarPath</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_dataset</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_dataset</span>
<span class="n">vocal_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">vocal_file</span>
<span class="n">ids_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ids_file</span>
<span class="n">flName</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">flName</span>
<span class="n">train_model_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_model_path</span>
<span class="n">infer_model_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">infer_model_path</span>
<span class="n">ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ip</span>
<span class="n">ssl</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ssl</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span>
<span class="n">server_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">server_num</span>
<span class="n">client_num</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">client_num</span>
<span class="n">time_window</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">time_window</span><span class="p">)</span>
<span class="n">use_elb</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_elb</span>
<span class="n">use_https</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">use_https</span>
<span class="n">cert_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cert_path</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">task</span>

<span class="n">users</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_client_data_path</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">use_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root_path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">bin_file_paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">use_path</span><span class="p">)</span>

    <span class="n">train_data_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_label_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_batch_num</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">test_data_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">test_label_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">test_batch_num</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">bin_file_paths</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
            <span class="n">train_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">train_batch_num</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
            <span class="n">train_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
            <span class="n">test_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">test_batch_num</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
            <span class="n">test_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">use_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">train_path</span> <span class="o">=</span> <span class="n">train_data_path</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">train_label_path</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="n">test_data_path</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">test_label_path</span>
    <span class="k">return</span> <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">train_batch_num</span><span class="p">,</span> <span class="n">test_batch_num</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">client_num</span><span class="p">):</span>
    <span class="n">clientID</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="n">get_client_data_path</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;client id: &quot;</span><span class="p">,</span> <span class="n">clientID</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train path: &quot;</span><span class="p">,</span> <span class="n">train_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test path: &quot;</span><span class="p">,</span> <span class="n">test_path</span><span class="p">)</span>

    <span class="n">cmd_client</span> <span class="o">=</span> <span class="s2">&quot;execute_path=$(pwd) &amp;&amp; self_path=$(dirname </span><span class="se">\&quot;</span><span class="s2">$</span><span class="si">{script_self}</span><span class="se">\&quot;</span><span class="s2">) &amp;&amp; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;rm -rf $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ &amp;&amp;&quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;mkdir $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ &amp;&amp;&quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;cd $</span><span class="si">{execute_path}</span><span class="s2">/client_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/ || exit &amp;&amp;&quot;</span>

    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot;java -jar &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">jarPath</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">train_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">vocal_file</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ids_file</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">test_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">flName</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">train_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model path: &quot;</span><span class="p">,</span> <span class="n">train_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">infer_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model path: &quot;</span><span class="p">,</span> <span class="n">infer_model_path</span> <span class="o">+</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">clientID</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ip</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">ssl</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">time_window</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">use_elb</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">server_num</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">use_https</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">cert_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="n">task</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">cmd_client</span> <span class="o">+=</span> <span class="s2">&quot; &gt; client&quot;</span> <span class="o">+</span> <span class="s2">&quot;.log 2&gt;&amp;1 &amp;&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd_client</span><span class="p">])</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">run.py</span></code>脚本中入参含义如下，可根据实际情况进行设置。以下涉及路径的必须给出绝对路径。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--jarPath</span></code></p>
<p>设置联邦学习jar包路径，x86环境联邦学习jar包获取可参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_client.html">端侧部署中编译出包流程</a>。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--train_dataset</span></code></p>
<p>训练数据集root路径，LeNet图片分类任务在该root路径中存放的是每个客户端的训练data.bin文件与label.bin文件，例如<code class="docutils literal notranslate"><span class="pre">leaf/data/femnist/3500_clients_bin/</span></code>。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--test_dataset</span></code></p>
<p>测试数据集路径，LeNet图片分类任务不需要设置该参数，默认为null。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--vocal_file</span></code></p>
<p>设置数据预处理的词典文件路径，LeNet网络设置为null。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ids_file</span></code></p>
<p>设置词典的映射id文件路径，LeNet网络设置为null。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--flName</span></code></p>
<p>设置联邦学习模型名称，目前只支持<code class="docutils literal notranslate"><span class="pre">lenet</span></code>（采用LeNet网络进行图片分类任务）和<code class="docutils literal notranslate"><span class="pre">albert</span></code>（采用ALBERT网络进行情感分类任务）。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--train_model_path</span></code></p>
<p>设置联邦学习使用的训练模型路径，为上面教程中拷贝的多份.ms文件所存放的目录，比如<code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code>，必须为绝对路径。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--infer_model_path</span></code></p>
<p>联邦学习使用的推理模型路径，为.ms格式的模型文件的绝对路径，LeNet图片分类任务可设置为与<code class="docutils literal notranslate"><span class="pre">train_model_path</span></code>相同。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ip</span></code></p>
<p>设置ip地址，即启动server端的服务器地址，格式为：10.113.216.106，目前云侧只支持http通信方式，默认采用http通信方式。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ssl</span></code></p>
<p>设置端云通信是否进行ssl证书认证，ssl证书认证只在https通信中使用，设置为false，不进行ssl证书认证；设置为true时，进行ssl证书认证且只支持https通信，<code class="docutils literal notranslate"><span class="pre">useHttps</span></code>必须设置为true，<code class="docutils literal notranslate"><span class="pre">cert_path</span></code>必须给出具体证书路径；默认为false。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--port</span></code></p>
<p>设置端口号，与启动server端时的<code class="docutils literal notranslate"><span class="pre">fl_server_port</span></code>参数保持一致，格式为： 6668。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--time_window</span></code></p>
<p>设置端侧重复请求的总时间窗口，与启动server端时的<code class="docutils literal notranslate"><span class="pre">start_fl_job_time_windows</span></code>和<code class="docutils literal notranslate"><span class="pre">update_model_time_windows</span></code>之和保持一致。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--server_num</span></code></p>
<p>设置server数量，与启动server端时的<code class="docutils literal notranslate"><span class="pre">server_num</span></code>参数保持一致，用于模拟客户端随机选择不同的server发送信息，真实场景不需要此参数。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--client_num</span></code></p>
<p>设置client数量， 与启动server端时的<code class="docutils literal notranslate"><span class="pre">start_fl_job_cnt</span></code>保持一致，真实场景不需要此参数。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--use_elb</span></code></p>
<p>用于多server场景，为true代表客户端每个round的请求都采用指定范围内的随机端口，false则采用固定端口。默认为false，当启动server端的<code class="docutils literal notranslate"><span class="pre">server_num</span></code>大于1时，该参数需设置成true。用于模拟客户端随机选择不同的server发送信息，真实场景不需要此参数。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--use_https</span></code></p>
<p>端云通信是否进行Https通信，设置为false，进行http通信；设置为true，进行https通信；默认为false。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cert_path</span></code></p>
<p>当<code class="docutils literal notranslate"><span class="pre">--ssl</span></code>设置为true时，需对该参数进行设置，设置证书的绝对路径，默认为<code class="docutils literal notranslate"><span class="pre">null</span></code>。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--task</span></code></p>
<p>用于设置本此启动的任务类型，为<code class="docutils literal notranslate"><span class="pre">train</span></code>代表启动训练任务，为<code class="docutils literal notranslate"><span class="pre">inference</span></code>代表启动多条数据推理任务，为<code class="docutils literal notranslate"><span class="pre">getModel</span></code>代表启动获取云侧模型的任务，设置其他字符串代表启动单条数据推理任务。默认为<code class="docutils literal notranslate"><span class="pre">train</span></code>。由于初始的模型文件(.ms文件)是未训练过的，建议先启动训练任务，待训练完成之后，再启动推理任务（注意两次启动的<code class="docutils literal notranslate"><span class="pre">client_num</span></code>保持一致，以保证<code class="docutils literal notranslate"><span class="pre">inference</span></code>使用的模型文件与<code class="docutils literal notranslate"><span class="pre">train</span></code>保持一致）。</p>
</li>
</ul>
</li>
<li><p>为客户端准备好模型文件。</p>
<p>由于真实场景一个客户端只包含一个.ms格式的模型文件，在模拟场景中，需要拷贝多份.ms文件，并按照<code class="docutils literal notranslate"><span class="pre">lenet_train{i}.ms</span></code>格式进行命名。其中i代表客户端编号，由于<code class="docutils literal notranslate"><span class="pre">run.py</span></code>中脚本的设置，需要设置为<code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">5</span> <span class="pre">.....</span></code>等数字。每个客户端各使用一份.ms文件。</p>
<p>可参考下面脚本，对原始.ms文件进行拷贝和命名：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span><span class="n">new_path</span><span class="p">,</span><span class="n">copy_num</span><span class="p">):</span>
    <span class="c1"># Copy the specified number of files from the raw path to the new path</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">copy_num</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;lenet_train&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ms&quot;</span>
        <span class="n">new_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">raw_path</span> <span class="p">,</span><span class="n">new_file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;====== copying &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39; file ======&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the number of copy .ms files: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="s2">&quot;lenet_train.ms&quot;</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;ms/lenet&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">copy_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</pre></div>
</div>
<p>其中<code class="docutils literal notranslate"><span class="pre">raw_path</span></code>设置原始.ms文件路径，<code class="docutils literal notranslate"><span class="pre">new_path</span></code>设置拷贝的.ms文件需要放置的路径，<code class="docutils literal notranslate"><span class="pre">num</span></code>设置拷贝的份数，一般需要模拟启动客户端的数量。</p>
<p>比如以上脚本中设置，在路径<code class="docutils literal notranslate"><span class="pre">ms/lenet</span></code>中生成了供5个客户端使用的.ms文件，其目录结构如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ms/lenet
├── lenet_train0.ms  <span class="c1"># 客户端0使用的.ms文件</span>
├── lenet_train1.ms  <span class="c1"># 客户端1使用的.ms文件</span>
├── lenet_train2.ms  <span class="c1"># 客户端2使用的.ms文件</span>
├── lenet_train3.ms  <span class="c1"># 客户端3使用的.ms文件</span>
└── lenet_train4.ms  <span class="c1"># 客户端4使用的.ms文件</span>
</pre></div>
</div>
</li>
<li><p>启动客户端。</p>
<p>启动客户端之前请先参照端侧部署教程中<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_client.html">x86环境部分</a>进行端侧环境部署。</p>
<p>运行<code class="docutils literal notranslate"><span class="pre">run.py</span></code>，指令如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python run.py --ip<span class="o">=</span><span class="m">10</span>.113.216.106 --port<span class="o">=</span><span class="m">6668</span> --server_num<span class="o">=</span><span class="m">8</span>  --client_num<span class="o">=</span><span class="m">5</span> --task<span class="o">=</span>train
</pre></div>
</div>
<p>该指令代表启动5个客户端参与联邦学习，若启动成功，会在当前文件夹生成5个客户端对应的日志文件，查看日志文件内容可了解每个客户端的运行情况：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>./
├── client_0
│   └── client.log  # 客户端0的日志文件
├── client_1
│   └── client.log  # 客户端1的日志文件
├── client_2
│   └── client.log  # 客户端2的日志文件
├── client_3
│   └── client.log  # 客户端3的日志文件
└── lenet_train4.ms
    └── client.log  # 客户端4的日志文件
</pre></div>
</div>
</li>
<li><p>关闭客户端进程。</p>
<p>可参考<code class="docutils literal notranslate"><span class="pre">finish.py</span></code>脚本，具体如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Finish test_mobile_lenet.py case&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--kill_tag&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mindspore-lite-java-flclient&quot;</span><span class="p">)</span>

<span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
<span class="n">kill_tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kill_tag</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;pid=`ps -ef|grep &quot;</span> <span class="o">+</span> <span class="n">kill_tag</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot; |grep -v </span><span class="se">\&quot;</span><span class="s2">grep</span><span class="se">\&quot;</span><span class="s2"> | grep -v </span><span class="se">\&quot;</span><span class="s2">finish</span><span class="se">\&quot;</span><span class="s2"> |awk &#39;{print $2}&#39;` &amp;&amp; &quot;</span>
<span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;for id in $pid; do kill -9 $id &amp;&amp; echo </span><span class="se">\&quot;</span><span class="s2">killed $id</span><span class="se">\&quot;</span><span class="s2">; done&quot;</span>

<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">])</span>
</pre></div>
</div>
<p>关闭客户端指令如下：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python finish.py --kill_tag<span class="o">=</span>mindspore-lite-java-flclient
</pre></div>
</div>
<p>其中参数<code class="docutils literal notranslate"><span class="pre">--kill_tag</span></code>用于搜索该关键字对客户端进程进行kill，只需要设置<code class="docutils literal notranslate"><span class="pre">--jarPath</span></code>中的特殊关键字即可。默认为<code class="docutils literal notranslate"><span class="pre">mindspore-lite-java-flclient</span></code>，即联邦学习jar包名。</p>
<p>假设启动了5个客户端，每个客户端包含一个Python进程和一个java进程，关闭成功会有以下打印：</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>killed <span class="m">56427</span>
killed <span class="m">56432</span>
killed <span class="m">56435</span>
killed <span class="m">56444</span>
killed <span class="m">56449</span>
killed <span class="m">56451</span>
killed <span class="m">56452</span>
killed <span class="m">56461</span>
killed <span class="m">56465</span>
killed <span class="m">56474</span>
</pre></div>
</div>
<p>即有10个进程成功被kill。</p>
</li>
<li><p>实验结果。</p>
<p>目前<code class="docutils literal notranslate"><span class="pre">3500_clients_bin</span></code>文件夹中包含3500个客户端的数据，本脚本最多可模拟3500个客户端参与联邦学习。</p>
<p>下图给出了50个客户端(设置<code class="docutils literal notranslate"><span class="pre">server_num</span></code>为16)进行联邦学习的测试集精度：</p>
<p><img alt="lenet_50_clients_acc" src="_images/lenet_50_clients_acc.png" /></p>
<p>其中联邦学习总迭代数为100，客户端本地训练epoch数为20，batchSize设置为32。</p>
<p>图中测试精度指对于每个联邦学习迭代，各客户端测试集在云侧聚合后的模型上的精度。</p>
<p>AVG：对于每个联邦学习迭代，50个客户端测试集精度的平均值。</p>
<p>TOP5：对于每个联邦学习迭代，测试集精度最高的5个客户端的精度平均值。</p>
<p>LOW5：对于每个联邦学习迭代，测试集精度最低的5个客户端的精度平均值。</p>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="sentiment_classification_application.html" class="btn btn-neutral float-right" title="实现一个情感分类应用(Android)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="deploy_federated_client.html" class="btn btn-neutral float-left" title="端侧部署" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, MindSpore

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>