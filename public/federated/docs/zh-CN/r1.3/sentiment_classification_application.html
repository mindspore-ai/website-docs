<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>实现一个情感分类应用(Android) &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script><script src="_static/jquery.js"></script>
        <script src="_static/js/theme.js"></script><script src="_static/underscore.js"></script><script src="_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="模型安全和隐私" href="security_and_privacy_protection.html" />
    <link rel="prev" title="实现一个图像分类应用(x86)" href="image_classification_application.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="federated_install.html">获取MindSpore Federated</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_server.html">云侧部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_federated_client.html">端侧部署</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用实践</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="image_classification_application.html">实现一个图像分类应用(x86)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">实现一个情感分类应用(Android)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">准备环节</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">模型相关文件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">定义网络</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">生成端侧模型文件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mindir">将模型导出为MindIR格式文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mindirms">将MindIR文件转化为联邦学习端侧框架可用的ms文件</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">启动联邦学习流程</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">Android新建工程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mindspore-lite-aar">编译MindSpore Lite AAR包</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">Android实例程序结构说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">编写代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">Android工程配置依赖项</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Android构建与运行</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id13">实验结果</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id14">参考文献</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="security_and_privacy_protection.html">模型安全和隐私</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>实现一个情感分类应用(Android)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/sentiment_classification_application.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="android">
<h1>实现一个情感分类应用(Android)<a class="headerlink" href="#android" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.3/docs/federated/docs/source_zh_cn/sentiment_classification_application.md"><img alt="查看源文件" src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png" /></a></p>
<p>通过端云协同的联邦学习建模方式，可以充分发挥端侧数据的优势，避免用户敏感数据直接上报云侧。由于用户在使用输入法时对自己的文字隐私十分看重，并且输入法上的智慧功能也是用户非常需要的。因此，联邦学习天然适用在输入法场景中。</p>
<p>MindSpore Federated将联邦语言模型应用到了输入法的表情图片预测功能中。联邦语言模型会根据聊天文本数据推荐出适合当前语境的表情图片。在使用联邦学习建模时，每一张表情图片会被定义为一个情感标签类别，而每个聊天短语会对应一个表情图片。MindSpore Federated将表情图片预测任务定义为联邦情感分类任务。</p>
<section id="id1">
<h2>准备环节<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<section id="id2">
<h3>环境<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h3>
<p>参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_server.html">服务端环境配置</a>和<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_client.html">客户端环境配置</a>。</p>
</section>
<section id="id3">
<h3>数据<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/supervise/client.tar.gz">用于训练的数据</a>包含20个用户聊天文件，其目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>datasets/supervise/client/
    ├── 0.txt  # 用户0的训练数据
    ├── 1.txt  # 用户1的训练数据
    │
    │          ......
    │
    └── 19.txt  # 用户19的训练数据
</pre></div>
</div>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/supervise/eval.tar.gz">用于验证的数据</a>包含1个聊天文件，其目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>datasets/supervise/eval/
    ├── eval.txt  # 验证数据
</pre></div>
</div>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/memo.tar.gz">标签对应的表情图片数据</a>包含4类表情，每类表情包括若干张图片，其目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>datasets/memo/
    ├── good  # good类表情
    │   ├── 2018new_geili_org.png
    │   ├── 2018new_good_org.png
    │   ├── 2018new_xianhua_org.png
    │   ├── 2018new_zan_org.png
    │   └── 2018new_zhongguozan_org.png
    ├── leimu  # leimu类表情
    │   ├── 2018new_beishang_org.png
    │   ├── 2018new_kelian_org.png
    │   ├── 2018new_leimu_org.png
    │   ├── 2018new_weiqu_org.png
    │   ├── 2021_alongdog_org.png
    │   ├── 2021_LZcry_org.png
    │   └── 2021_LZpoor_org.png
    ├── xiaoku  # xiaoku类表情
    │   ├── 2018new_doge02_org.png
    │   ├── 2018new_guzhang_org.png
    │   ├── 2018new_huaixiao_org.png
    │   ├── 2018new_xiaoerbuyu_org.png
    │   ├── 2018new_xiaoku_thumb.png
    │   └── 2018new_yinxian_org.png
    └── xin  # xin类表情
        ├── 2018new_aini_org.png
        ├── 2018new_huaxin_org.png
        ├── 2018new_tianping_org.png
        ├── 2018new_xin_org.png
        └── qixi2018_xiaoxinxin_org.png
</pre></div>
</div>
</section>
<section id="id4">
<h3>模型相关文件<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<p>生成模型需要的起始<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/models/albert_init.ckpt">CheckPoint文件</a>、<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/vocab.txt">词典</a>和<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/vocab_map_ids.txt">词典ID映射文件</a>的目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>models/
    ├── albert_init.ckpt  # 起始的checkpoint
    ├── vocab.txt  # 词典
    └── vocab_map_ids.txt  # 词典ID映射文件
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>定义网络<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h2>
<p>联邦学习中的语言模型使用ALBERT模型[1]。客户端上的ALBERT模型包括：embedding层、encoder层和classifier层。</p>
<p>具体网络定义请参考<a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.3/tests/st/fl/albert/src/model.py">源码</a>。</p>
<section id="id6">
<h3>生成端侧模型文件<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<section id="mindir">
<h4>将模型导出为MindIR格式文件<a class="headerlink" href="#mindir" title="Permalink to this headline"></a></h4>
<p>示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">set_seed</span><span class="p">,</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">export</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">AdamWeightDecay</span>
<span class="kn">from</span> <span class="nn">src.config</span> <span class="kn">import</span> <span class="n">train_cfg</span><span class="p">,</span> <span class="n">client_net_cfg</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">restore_params</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">AlbertModelCLS</span>
<span class="kn">from</span> <span class="nn">src.cell_wrapper</span> <span class="kn">import</span> <span class="n">NetworkWithCLSLoss</span><span class="p">,</span> <span class="n">NetworkTrainCell</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse args</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;export task&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device_target&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;GPU&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Ascend&#39;</span><span class="p">,</span> <span class="s1">&#39;GPU&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device_id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--init_model_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./models/mindir/&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">supervise_export</span><span class="p">(</span><span class="n">args_opt</span><span class="p">):</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">seed</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1"># 参数配置</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">device_id</span>
    <span class="n">init_model_path</span> <span class="o">=</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">init_model_path</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">output_dir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameters setting is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># MindSpore配置</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">args_opt</span><span class="o">.</span><span class="n">device_target</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Context setting is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># 建立模型</span>
    <span class="n">albert_model_cls</span> <span class="o">=</span> <span class="n">AlbertModelCLS</span><span class="p">(</span><span class="n">client_net_cfg</span><span class="p">)</span>
    <span class="n">network_with_cls_loss</span> <span class="o">=</span> <span class="n">NetworkWithCLSLoss</span><span class="p">(</span><span class="n">albert_model_cls</span><span class="p">)</span>
    <span class="n">network_with_cls_loss</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model construction is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># 建立优化器</span>
    <span class="n">client_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">network_with_cls_loss</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()]</span>
    <span class="n">client_decay_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">filter</span><span class="p">(</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">optimizer_cfg</span><span class="o">.</span><span class="n">AdamWeightDecay</span><span class="o">.</span><span class="n">decay_filter</span><span class="p">,</span> <span class="n">client_params</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">client_other_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">train_cfg</span><span class="o">.</span><span class="n">optimizer_cfg</span><span class="o">.</span><span class="n">AdamWeightDecay</span><span class="o">.</span><span class="n">decay_filter</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">client_params</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">client_group_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">client_decay_params</span><span class="p">,</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">train_cfg</span><span class="o">.</span><span class="n">optimizer_cfg</span><span class="o">.</span><span class="n">AdamWeightDecay</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">client_other_params</span><span class="p">,</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;order_params&#39;</span><span class="p">:</span> <span class="n">client_params</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">client_optimizer</span> <span class="o">=</span> <span class="n">AdamWeightDecay</span><span class="p">(</span><span class="n">client_group_params</span><span class="p">,</span>
                                       <span class="n">learning_rate</span><span class="o">=</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">client_cfg</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                                       <span class="n">eps</span><span class="o">=</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">optimizer_cfg</span><span class="o">.</span><span class="n">AdamWeightDecay</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">client_network_train_cell</span> <span class="o">=</span> <span class="n">NetworkTrainCell</span><span class="p">(</span><span class="n">network_with_cls_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">client_optimizer</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer construction is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># 构造数据</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">client_net_cfg</span><span class="o">.</span><span class="n">seq_length</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">client_net_cfg</span><span class="o">.</span><span class="n">seq_length</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">token_type_ids</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">client_net_cfg</span><span class="o">.</span><span class="n">seq_length</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">label_ids</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Client data loading is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># 读取checkpoint</span>
    <span class="k">if</span> <span class="n">init_model_path</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">init_param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">init_model_path</span><span class="p">)</span>
        <span class="n">restore_params</span><span class="p">(</span><span class="n">client_network_train_cell</span><span class="p">,</span> <span class="n">init_param_dict</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checkpoint loading is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># 导出</span>
    <span class="n">export</span><span class="p">(</span><span class="n">client_network_train_cell</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">token_type_ids</span><span class="p">,</span> <span class="n">label_ids</span><span class="p">,</span>
           <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;albert_supervise&#39;</span><span class="p">),</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Supervise model export process is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">total_time_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">supervise_export</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All is done! Time cost: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">total_time_start</span><span class="p">))</span>

</pre></div>
</div>
</section>
<section id="mindirms">
<h4>将MindIR文件转化为联邦学习端侧框架可用的ms文件<a class="headerlink" href="#mindirms" title="Permalink to this headline"></a></h4>
<p>参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/image_classification_application.html">图像分类应用</a>中生成端侧模型文件部分。</p>
</section>
</section>
</section>
<section id="id7">
<h2>启动联邦学习流程<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h2>
<p>首先在服务端启动脚本，参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_server.html">云端部署方式</a>。</p>
<p>以ALBERT模型的训练与推理任务为基础，整体流程为：</p>
<ol class="arabic simple">
<li><p>Android新建工程；</p></li>
<li><p>编译MindSpore Lite AAR包；</p></li>
<li><p>Android实例程序结构说明；</p></li>
<li><p>编写代码；</p></li>
<li><p>Android工程配置依赖项；</p></li>
<li><p>Android构建与运行。</p></li>
</ol>
<section id="id8">
<h3>Android新建工程<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h3>
<p>在Android Studio中新建项目工程，并安装相应的SDK（指定SDK版本后，由Android Studio自动安装）。</p>
<p><img alt="新建工程" src="_images/create_android_project.png" /></p>
</section>
<section id="mindspore-lite-aar">
<h3>编译MindSpore Lite AAR包<a class="headerlink" href="#mindspore-lite-aar" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>参考<a class="reference external" href="https://www.mindspore.cn/federated/docs/zh-CN/r1.3/deploy_federated_client.html">端侧部署</a>完成部署。</p></li>
<li><p>获取生成的Android AAR包。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mindspore-lite-&lt;version&gt;.aar
</pre></div>
</div>
</li>
<li><p>把AAR包放置安卓工程的app/libs/目录下。</p></li>
</ol>
</section>
<section id="id9">
<h3>Android实例程序结构说明<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>app
│   ├── libs # Android库项目的二进制归档文件
|   |   └── mindspore-lite-version.aar #  MindSpore Lite针对Android版本的归档文件
├── src/main
│   ├── assets # 资源目录
|   |   └── model # 模型目录
|   |       └── albert_supervise.mindir.ms # 存放的预训练模型文件
│   |       └── albert_inference.mindir.ms # 存放的推理模型文件
│   |   └── data # 数据目录
|   |       └── 0.txt # 模型数据文件
|   |       └── vocab.txt # 词典文件
|   |       └── vocab_map_ids.txt # 词典ID映射文件
|   |       └── eval.txt # 训练结果评估文件
|   |       └── eval_no_label.txt # 推理数据文件
│   |
│   ├── java # java层应用代码
│   │       └── ... 存放Android代码文件，相关目录可以自定义
│   │
│   ├── res # 存放Android相关的资源文件
│   └── AndroidManifest.xml # Android配置文件
│
│
├── build.gradle # Android工程构建配置文件
├── download.gradle # 工程依赖文件下载
└── ...
</pre></div>
</div>
</section>
<section id="id10">
<h3>编写代码<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>AssetCopyer.java：该代码文件作用是把Android工程的app/src/main/assets目录下的资源文件存放到Android系统的磁盘中，以便在模型训练与推理时联邦学习框架的接口能够根据绝对路径读取到资源文件。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AssetCopyer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">AssetCopyer</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyAllAssets</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">destination</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;destination: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">destination</span><span class="p">);</span>
<span class="w">        </span><span class="n">copyAssetsToDst</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">destination</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// copy assets目录下面的资源文件到Android系统的磁盘中，具体的路径可打印destination查看</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyAssetsToDst</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="n">String</span><span class="w"> </span><span class="n">srcPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dstPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 递归获取assets目录的所有的文件名</span>
<span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">fileNames</span><span class="w"> </span><span class="o">=</span><span class="n">context</span><span class="p">.</span><span class="na">getAssets</span><span class="p">().</span><span class="na">list</span><span class="p">(</span><span class="n">srcPath</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileNames</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 构建目标file对象</span>
<span class="w">                </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">dstPath</span><span class="p">);</span>
<span class="w">                </span><span class="c1">//创建目标目录</span>
<span class="w">                </span><span class="n">file</span><span class="p">.</span><span class="na">mkdirs</span><span class="p">();</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fileNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// copy文件到指定的磁盘</span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">srcPath</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">copyAssetsToDst</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">srcPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileName</span><span class="p">,</span><span class="n">dstPath</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">fileName</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                        </span><span class="n">copyAssetsToDst</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">fileName</span><span class="p">,</span><span class="n">dstPath</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">fileName</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 构建源文件的输入流</span>
<span class="w">                </span><span class="n">InputStream</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getAssets</span><span class="p">().</span><span class="na">open</span><span class="p">(</span><span class="n">srcPath</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// 构建目标文件的输出流</span>
<span class="w">                </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">dstPath</span><span class="p">));</span>
<span class="w">                </span><span class="c1">// 定义1024大小的缓冲数组</span>
<span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">byteCount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// 源文件写到目标文件</span>
<span class="w">                </span><span class="k">while</span><span class="p">((</span><span class="n">byteCount</span><span class="o">=</span><span class="n">is</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">fos</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">byteCount</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// 刷新输出流</span>
<span class="w">                </span><span class="n">fos</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
<span class="w">                </span><span class="c1">// 关闭输入流</span>
<span class="w">                </span><span class="n">is</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="w">                </span><span class="c1">// 关闭输出流</span>
<span class="w">                </span><span class="n">fos</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>FlJob.java：该代码文件作用是定义训练与推理任务的内容，具体的联邦学习接口含义请参考<a class="reference external" href="https://www.mindspore.cn/federated/api/zh-CN/r1.3/interface_description_federated_client.html">联邦学习接口介绍</a>。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.annotation.SuppressLint</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Build</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">androidx.annotation.RequiresApi</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mindspore.flAndroid.utils.AssetCopyer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mindspore.flclient.FLParameter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mindspore.flclient.SyncFLJob</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Arrays</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FlJob</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">AssetCopyer</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentPath</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">FlJob</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">parentPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Android的联邦学习训练任务</span>
<span class="w">    </span><span class="nd">@SuppressLint</span><span class="p">(</span><span class="s">&quot;NewApi&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@RequiresApi</span><span class="p">(</span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">M</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">syncJobTrain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">trainDataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/0.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">vocal_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/vocab.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">idsFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/vocab_map_ids.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">testDataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/eval.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">trainModelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/model/albert_supervise.mindir.ms&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">inferModelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/model/albert_inference.mindir.ms&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">flName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;albert&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// server ip address，请保证Android能够访问到server，否则会出现connection failed</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;http://127.0.0.1:&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6668</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">clientID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">useSSL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">FLParameter</span><span class="w"> </span><span class="n">flParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLParameter</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setTrainDataset</span><span class="p">(</span><span class="n">trainDataset</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setVocabFile</span><span class="p">(</span><span class="n">vocal_file</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setIdsFile</span><span class="p">(</span><span class="n">idsFile</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setTestDataset</span><span class="p">(</span><span class="n">testDataset</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setFlName</span><span class="p">(</span><span class="n">flName</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setTrainModelPath</span><span class="p">(</span><span class="n">trainModelPath</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setInferModelPath</span><span class="p">(</span><span class="n">inferModelPath</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setClientID</span><span class="p">(</span><span class="n">clientID</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setIp</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">        </span><span class="n">flParameter</span><span class="p">.</span><span class="na">setUseSSL</span><span class="p">(</span><span class="n">useSSL</span><span class="p">);</span>
<span class="w">        </span><span class="n">SyncFLJob</span><span class="w"> </span><span class="n">syncFLJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SyncFLJob</span><span class="p">();</span>
<span class="w">        </span><span class="n">syncFLJob</span><span class="p">.</span><span class="na">flJobRun</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Android的联邦学习推理任务</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">syncJobPredict</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">flName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;albert&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dataPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/eval_no_label.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">vocal_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/vocab.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">idsFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/data/vocab_map_ids.txt&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">modelPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parentPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/model/albert_inference.mindir.ms&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">SyncFLJob</span><span class="w"> </span><span class="n">syncFLJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SyncFLJob</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syncFLJob</span><span class="p">.</span><span class="na">modelInference</span><span class="p">(</span><span class="n">flName</span><span class="p">,</span><span class="w"> </span><span class="n">dataPath</span><span class="p">,</span><span class="w"> </span><span class="n">vocal_file</span><span class="p">,</span><span class="w"> </span><span class="n">idsFile</span><span class="p">,</span><span class="w"> </span><span class="n">modelPath</span><span class="p">);</span>
<span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;labels = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">labels</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上面的eval_no_label.txt是指不存在标签的文件，每一行为一条语句，格式参考如下，用户可自由设置：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>愿以吾辈之青春 护卫这盛世之中华🇨🇳
girls help girls
太美了，祝祖国繁荣昌盛！
中国人民站起来了
难道就我一个人觉得这个是plus版本？
被安利到啦！明天起来就看！早点睡觉莲莲
</pre></div>
</div>
</li>
<li><p>MainActivity.java：该代码文件作用是启动联邦学习训练与推理任务。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Build</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">androidx.annotation.RequiresApi</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mindspore.flAndroid.job.FlJob</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mindspore.flAndroid.utils.AssetCopyer</span><span class="p">;</span>
<span class="nd">@RequiresApi</span><span class="p">(</span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">VERSION_CODES</span><span class="p">.</span><span class="na">P</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">parentPath</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 获取该应用程序在Android系统中的磁盘路径</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">parentPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getExternalFilesDir</span><span class="p">(</span><span class="kc">null</span><span class="p">).</span><span class="na">getAbsolutePath</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// copy assets目录下面的资源文件到Android系统的磁盘中</span>
<span class="w">        </span><span class="n">AssetCopyer</span><span class="p">.</span><span class="na">copyAllAssets</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationContext</span><span class="p">(),</span><span class="w"> </span><span class="n">parentPath</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// 新建一个线程，启动联邦学习训练与推理任务</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">FlJob</span><span class="w"> </span><span class="n">flJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FlJob</span><span class="p">(</span><span class="n">parentPath</span><span class="p">);</span>
<span class="w">            </span><span class="n">flJob</span><span class="p">.</span><span class="na">syncJobTrain</span><span class="p">();</span>
<span class="w">            </span><span class="n">flJob</span><span class="p">.</span><span class="na">syncJobPredict</span><span class="p">();</span>
<span class="w">        </span><span class="p">}).</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id11">
<h3>Android工程配置依赖项<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>AndroidManifest.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span><span class="w"> </span><span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
<span class="w">    </span><span class="na">package=</span><span class="s">&quot;com.mindspore.flAndroid&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!--允许网络访问权限--&gt;</span>
<span class="w">    </span><span class="nt">&lt;uses-permission</span><span class="w"> </span><span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;application</span>
<span class="w">        </span><span class="na">android:allowBackup=</span><span class="s">&quot;true&quot;</span>
<span class="w">        </span><span class="na">android:supportsRtl=</span><span class="s">&quot;true&quot;</span>
<span class="w">        </span><span class="na">android:usesCleartextTraffic=</span><span class="s">&quot;true&quot;</span>
<span class="w">        </span><span class="na">android:theme=</span><span class="s">&quot;@style/Theme.Flclient&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="cm">&lt;!--MainActivity的文件位置，根据自定义填写--&gt;</span>
<span class="w">        </span><span class="nt">&lt;activity</span><span class="w"> </span><span class="na">android:name=</span><span class="s">&quot;com.mindspore.flAndroid.activity.MainActivity&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;intent-filter&gt;</span>
<span class="w">                </span><span class="nt">&lt;action</span><span class="w"> </span><span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;category</span><span class="w"> </span><span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/intent-filter&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activity&gt;</span>
<span class="w">    </span><span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</pre></div>
</div>
</li>
<li><p>app/build.gradle</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>plugins {
    id &#39;com.android.application&#39;
}
android {
    // Android SDK的编译版本，建议大于27
    compileSdkVersion 30
    buildToolsVersion &quot;30.0.3&quot;
    defaultConfig {
        applicationId &quot;com.mindspore.flAndroid&quot;
        minSdkVersion 27
        targetSdkVersion 30
        versionCode 1
        versionName &quot;1.0&quot;
        multiDexEnabled true
        testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;
        ndk {
            // 不同的手机型号，对应ndk不相同，本人使用的mate20手机是&#39;armeabi-v7a&#39;
            abiFilters &#39;armeabi-v7a&#39;
        }
    }
    //指定ndk版本
    ndkVersion &#39;21.3.6528147&#39;
    sourceSets{
        main {
            // 指定jni目录
            jniLibs.srcDirs = [&#39;libs&#39;]
            jni.srcDirs = []
        }
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
dependencies {
    //指定扫描libs目录下的AAR包
    implementation fileTree(dir:&#39;libs&#39;,include:[&#39;*.aar&#39;])
    implementation &#39;androidx.appcompat:appcompat:1.1.0&#39;
    implementation &#39;com.google.android.material:material:1.1.0&#39;
    implementation &#39;androidx.constraintlayout:constraintlayout:1.1.3&#39;
    androidTestImplementation &#39;androidx.test.ext:junit:1.1.1&#39;
    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.2.0&#39;
    implementation &#39;com.android.support:multidex:1.0.3&#39;
}
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id12">
<h3>Android构建与运行<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>连接Android设备，运行联邦学习训练与推理应用程序。通过USB连接Android设备调试，点击<code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">'app'</span></code>即可在你的设备上运行联邦学习任务。</p>
<p><img alt="run_app" src="_images/start_android_project.png" /></p>
</li>
<li><p>Android Studio连接设备调试操作，可参考<a class="reference external" href="https://developer.android.com/studio/run/device?hl=zh-cn">https://developer.android.com/studio/run/device?hl=zh-cn</a>。手机需开启“USB调试模式”，Android Studio才能识别到手机。 华为手机一般在<code class="docutils literal notranslate"><span class="pre">设置-&gt;系统和更新-&gt;开发人员选项-&gt;USB调试</span></code>中打开“USB调试模式”。</p></li>
<li><p>在Android设备上，点击“继续安装”，安装完即可在APP启动之后执行ALBERT模型的联邦学习的训练与推理任务。</p></li>
<li><p>程序运行结果如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>I/SyncFLJob: &lt;FLClient&gt; [model inference] inference finish
I/SyncFLJob: labels = [2, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 4, 4, 4, 4]
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id13">
<h2>实验结果<a class="headerlink" href="#id13" title="Permalink to this headline"></a></h2>
<p>联邦学习总迭代数为10，客户端本地训练epoch数为1，batchSize设置为16。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;FLClient&gt; total acc:0.44488978
&lt;FLClient&gt; total acc:0.583166333
&lt;FLClient&gt; total acc:0.609218437
&lt;FLClient&gt; total acc:0.645290581
&lt;FLClient&gt; total acc:0.667334669
&lt;FLClient&gt; total acc:0.685370741
&lt;FLClient&gt; total acc:0.70741483
&lt;FLClient&gt; total acc:0.711422846
&lt;FLClient&gt; total acc:0.719438878
&lt;FLClient&gt; total acc:0.733466934
</pre></div>
</div>
</section>
<section id="id14">
<h2>参考文献<a class="headerlink" href="#id14" title="Permalink to this headline"></a></h2>
<p>[1] Lan Z ,  Chen M ,  Goodman S , et al. ALBERT: A Lite BERT for Self-supervised Learning of Language Representations[J].  2019.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="image_classification_application.html" class="btn btn-neutral float-left" title="实现一个图像分类应用(x86)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="security_and_privacy_protection.html" class="btn btn-neutral float-right" title="模型安全和隐私" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>