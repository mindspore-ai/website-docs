<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Android Application Development Based on Java Interface &mdash; MindSpore Lite master documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/lite.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/lite.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Implement Device Training Based On C++ Interface" href="train_lenet.html" />
    <link rel="prev" title="Android Application Development Based on JNI Interface" href="quick_start.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore Lite
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Obtain MindSpore Lite</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/downloads.html">Downloading MindSpore Lite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/build.html">Building MindSpore Lite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start_cpp.html">Experience C++ Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start_java.html">Experience Java Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Android Application Development Based on JNI Interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Android Application Development Based on Java Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#selecting-a-model">Selecting a Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deploying-an-application">Deploying an Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-dependencies">Running Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-and-running">Building and Running</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detailed-demo-description">Detailed Demo Description</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#demo-structure">Demo Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-mindspore-lite-dependencies">Configuring MindSpore Lite Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#downloading-and-deploying-the-model-file">Downloading and Deploying the Model File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-on-device-inference-code">Writing On-Device Inference Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="train_lenet.html">Implement Device Training Based On C++ Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="train_lenet_java.html">Implement Device Training Based On Java Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Inference on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/converter_tool.html">Converting Models for Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/post_training_quantization.html">Optimizing the Model (Quantization After Training)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preprocessing.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/runtime.html">Executing Model Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/micro.html">Perform Inference on Mini and Small Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/asic.html">Application Specific Integrated Circuit Integration Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/converter_train.html">Creating MindSpore Lite Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/runtime_train.html">Executing Model Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/benchmark.html">Benchmark Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/cropper_tool.html">Static Library Cropper Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/visual_tool.html">Visual Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/obfuscator_tool.html">Obfuscator Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture_lite.html">Overall Architecture (Lite)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_lite.html">Lite Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_codegen.html">Codegen Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_lite.html">Model List</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore Lite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Android Application Development Based on Java Interface</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/quick_start/image_segmentation.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="android-application-development-based-on-java-interface">
<h1>Android Application Development Based on Java Interface<a class="headerlink" href="#android-application-development-based-on-java-interface" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Android</span></code> <code class="docutils literal notranslate"><span class="pre">Java</span></code> <code class="docutils literal notranslate"><span class="pre">Whole</span> <span class="pre">Process</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Conversion</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Loading</span></code> <code class="docutils literal notranslate"><span class="pre">Inference</span> <span class="pre">Application</span></code> <code class="docutils literal notranslate"><span class="pre">Data</span> <span class="pre">Preparation</span></code> <code class="docutils literal notranslate"><span class="pre">Beginner</span></code> <code class="docutils literal notranslate"><span class="pre">Intermediate</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code></p>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.3/docs/lite/docs/source_en/quick_start/image_segmentation.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.3/resource/_static/logo_source.png"></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>It is recommended that you start from the image segmentation demo on the Android device to understand how to build the MindSpore Lite application project, configure dependencies, and use related Java APIs.</p>
<p>This tutorial demonstrates the on-device deployment process based on the image segmentation demo on the Android device provided by the MindSpore team.</p>
</section>
<section id="selecting-a-model">
<h2>Selecting a Model<a class="headerlink" href="#selecting-a-model" title="Permalink to this headline"></a></h2>
<p>Select an image segmentation model.</p>
<blockquote>
<div><p>Click <a class="reference external" href="https://download.mindspore.cn/model_zoo/official/lite/mobile_segment_lite/segment_model.ms">here</a> to download the Android image segmentation model.</p>
<p>This example describes how to use Java APIs.</p>
</div></blockquote>
<p>Scan the QR code below or directly download the <a class="reference external" href="https://download.mindspore.cn/model_zoo/official/lite/apk/segmentation/image_segmentation.apk">APK file</a> corresponding to this sample, and deploy it on an Android device.</p>
<p><img alt="apk" src="../_images/segmentation_apk.png" /></p>
</section>
<section id="deploying-an-application">
<h2>Deploying an Application<a class="headerlink" href="#deploying-an-application" title="Permalink to this headline"></a></h2>
<p>The following describes how to build and execute an on-device image segmentation task on MindSpore Lite.</p>
<section id="running-dependencies">
<h3>Running Dependencies<a class="headerlink" href="#running-dependencies" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Android Studio 3.2 or later (Android 4.0 or later is recommended.)</p></li>
<li><p>Android SDK 26 or later (installed by Android Studio by default)</p></li>
<li><p>JDK 1.8 or later (installed by Android Studio by default)</p></li>
</ul>
</section>
<section id="building-and-running">
<h3>Building and Running<a class="headerlink" href="#building-and-running" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>Load the sample source code to Android Studio and install the corresponding SDK. (After the SDK version is specified, Android Studio automatically installs the SDK.)</p>
<p><img alt="start_home" src="../_images/lite_quick_start_home.png" /></p>
</li>
<li><p>Connect to an Android device and runs the image segmentation application.</p>
<p>Connect to the Android device through a USB cable for debugging. Click <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">'app'</span></code> to run the demo on your device.</p>
<p><img alt="run_app" src="../_images/lite_quick_start_run_app.PNG" /></p>
<p>For details about how to connect the Android Studio to a device for debugging, see <a class="reference external" href="https://developer.android.com/studio/run/device">https://developer.android.com/studio/run/device</a>.</p>
<p>Android Studio can identify the mobile phone only when USB debugging mode is enabled on the mobile phone.  For Huawei phones, enable USB debugging mode by choosing Settings &gt; System &amp; updates &gt; Developer options &gt; USB debugging.</p>
</li>
<li><p>On the Android device, click Continue. After the installation is complete, you can view the local album and the segmentation result of the image taken by the camera.</p>
<p><img alt="install" src="../_images/lite_segmentation_quick_start_install.png" /></p>
<p>The running result is shown in the following figure. (A portrait in the album is used as an example.)</p>
<p><img alt="result1" src="../_images/segmentation1.png" /></p>
<p>Select a portrait from an album.</p>
<p><img alt="result2" src="../_images/segmentation2.png" /></p>
<p>Select a background image from the nine images to replace and segment the portrait background.</p>
 <table>
   <tr>
     <td><center><img src="https://gitee.com/mindspore/docs/raw/r1.3/docs/lite/docs/source_en/images/segmentation3.png"><br>Figure 1 White background</br> </center></td>
     <td><center><img src="https://gitee.com/mindspore/docs/raw/r1.3/docs/lite/docs/source_en/images/segmentation4.png"><br>Figure 2 Blue background</br></center></td>
     <td><center><img src="https://gitee.com/mindspore/docs/raw/r1.3/docs/lite/docs/source_en/images/segmentation5.png"><br>Figure 3 Oil painting background</br></center></td>
   </tr>
 </table>
</li>
</ol>
</section>
</section>
<section id="detailed-demo-description">
<h2>Detailed Demo Description<a class="headerlink" href="#detailed-demo-description" title="Permalink to this headline"></a></h2>
<p>The Android demo for on-device image segmentation uses the Java layer. Therefore, you must have basic Android development knowledge.</p>
<section id="demo-structure">
<h3>Demo Structure<a class="headerlink" href="#demo-structure" title="Permalink to this headline"></a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>app
├── src/main
│   ├── assets # Resource file
|   |   └── model # Model file
|   |       └── segment_model.ms # Stored model file
│   |
│   ├── libs # Binary archive file of the Android library project
|   |   └── mindspore-lite-version.aar # MindSpore Lite archive file of the Android version
│   |
│   ├── java # Application code at the Java layer
│   │   └── com.mindspore.imagesegmentation
│   │       ├── help # Image processing
│   │       │   └── ...
│   │       └── ... Android page display and logic processing
│   │
│   ├── res # Resource files related to Android
│   └── AndroidManifest.xml # Android configuration file
│
│
├── build.gradle # Other Android configuration file
├── download.gradle # Downloading the files that the project depends on
└── ...
</pre></div>
</div>
</section>
<section id="configuring-mindspore-lite-dependencies">
<h3>Configuring MindSpore Lite Dependencies<a class="headerlink" href="#configuring-mindspore-lite-dependencies" title="Permalink to this headline"></a></h3>
<p>Related library files are required for Android to call MindSpore Android AAR. You can use MindSpore Lite <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r1.3/use/build.html">source code</a> to generate the <code class="docutils literal notranslate"><span class="pre">mindspore-lite-maven-{version}.zip</span></code> library file package (including the <code class="docutils literal notranslate"><span class="pre">mindspore-lite-{version}.aar</span></code> library file) and decompress it.</p>
<blockquote>
<div><p>version: version number in the output file, which is the same as the version number of the built branch code.</p>
</div></blockquote>
<p>In this example, the MindSpore Lite version file is automatically downloaded using the <code class="docutils literal notranslate"><span class="pre">app/download.gradle</span></code> file during the build process and stored in the <code class="docutils literal notranslate"><span class="pre">app/libs</span></code> directory.</p>
<p>Note: If the automatic download fails, manually download the related library file <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r1.3/use/downloads.html">mindspore-lite-{version}-android-{arch}.tar.gz</a>, decompress it, and save it to the corresponding directory.</p>
</section>
<section id="downloading-and-deploying-the-model-file">
<h3>Downloading and Deploying the Model File<a class="headerlink" href="#downloading-and-deploying-the-model-file" title="Permalink to this headline"></a></h3>
<p>Download the model file from MindSpore Model Hub. The on-device image segmentation model file used in this demo is <code class="docutils literal notranslate"><span class="pre">segment_model.ms</span></code>, which is automatically downloaded during app building using the <code class="docutils literal notranslate"><span class="pre">app/download.gradle</span></code> script and stored in the <code class="docutils literal notranslate"><span class="pre">app/src/main/assets</span></code> project directory.</p>
<p>Note: If the download fails, manually download the model file <a class="reference external" href="https://download.mindspore.cn/model_zoo/official/lite/mobile_segment_lite/segment_model.ms">segment_model.ms</a>.</p>
</section>
<section id="writing-on-device-inference-code">
<h3>Writing On-Device Inference Code<a class="headerlink" href="#writing-on-device-inference-code" title="Permalink to this headline"></a></h3>
<p>The inference code and process are as follows. For details about the complete code, see <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.3/model_zoo/official/lite/image_segmentation/app/src/main/java/com/mindspore/imagesegmentation/help/TrackingMobile.java">src/java/com/mindspore/imagesegmentation/TrackingMobile</a>.</p>
<ol class="arabic">
<li><p>Load the MindSpore Lite model file and build the context, session, and computational graph for inference.</p>
<ul>
<li><p>Load a model file. Create and configure the context for model inference.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load the .ms model.</span>
<span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Model</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">.</span><span class="na">loadModel</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;segment_model.ms&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Load Model failed&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Create a session.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create and init config.</span>
<span class="n">MSConfig</span><span class="w"> </span><span class="n">msConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MSConfig</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">msConfig</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">DeviceType</span><span class="p">.</span><span class="na">DT_CPU</span><span class="p">,</span><span class="w"> </span><span class="n">threadNum</span><span class="p">,</span><span class="w"> </span><span class="n">CpuBindMode</span><span class="p">.</span><span class="na">MID_CPU</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Init context failed&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Create the MindSpore lite session.</span>
<span class="n">LiteSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LiteSession</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">msConfig</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Create session failed&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">msConfig</span><span class="p">.</span><span class="na">free</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">msConfig</span><span class="p">.</span><span class="na">free</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>Load the model file and build a computational graph for inference.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Compile graph.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">.</span><span class="na">compileGraph</span><span class="p">(</span><span class="n">model</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Compile graph failed&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">model</span><span class="p">.</span><span class="na">freeBuffer</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Note: when use model.freeBuffer(), the model cannot be compile graph again.</span>
<span class="n">model</span><span class="p">.</span><span class="na">freeBuffer</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Convert the input image into the Tensor format that is input to the MindSpore model.</p>
<p>Convert the image data to be detected into the Tensor format that is input to the MindSpore model.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getInputs</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inputs.size() != 1&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span><span class="w"> </span><span class="n">resource_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitmap</span><span class="p">.</span><span class="na">getHeight</span><span class="p">();</span>
<span class="kt">float</span><span class="w"> </span><span class="n">resource_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitmap</span><span class="p">.</span><span class="na">getWidth</span><span class="p">();</span>

<span class="n">ByteBuffer</span><span class="w"> </span><span class="n">contentArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitmapUtils</span><span class="p">.</span><span class="na">bitmapToByteBuffer</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span><span class="w"> </span><span class="n">imageSize</span><span class="p">,</span><span class="w"> </span><span class="n">imageSize</span><span class="p">,</span><span class="w"> </span><span class="n">IMAGE_MEAN</span><span class="p">,</span><span class="w"> </span><span class="n">IMAGE_STD</span><span class="p">);</span>

<span class="n">MSTensor</span><span class="w"> </span><span class="n">inTensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">inTensor</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">contentArray</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Run the session and execute the computational graph.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Run graph to infer results.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="p">.</span><span class="na">runGraph</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Run graph failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Process the output data.</p>
<ul>
<li><p>Obtain information such as the dimension, number of batches, and number of channels based on the output data obtained by the tensor.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Get output tensor values.</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tensorNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getOutputTensorNames</span><span class="p">();</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">MSTensor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getOutputMapByTensor</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tensorName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tensorNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">MSTensor</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">tensorName</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can not find output &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tensorName</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getFloatData</span><span class="p">();</span>
<span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="n">output</span><span class="p">.</span><span class="na">elementsNum</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getShape</span><span class="p">()</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getShape</span><span class="p">()</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getShape</span><span class="p">()</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">getShape</span><span class="p">()</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">plane</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">height</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Convert the NCHW format to the NHWC format and put it in <code class="docutils literal notranslate"><span class="pre">float[]</span> <span class="pre">result</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">plane</span><span class="p">;</span><span class="w"> </span><span class="n">hw</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="n">result</span><span class="o">[</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">plane</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="o">[</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">plane</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">plane</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hw</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Perform inference and post-processing on the input tensor based on the model.</p>
<ul>
<li><p>Convert the <code class="docutils literal notranslate"><span class="pre">float[]</span> <span class="pre">result</span></code> data into the ByteBuffer data format.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteBuffer</span><span class="p">.</span><span class="na">allocate</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">FloatBuffer</span><span class="w"> </span><span class="n">floatBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">asFloatBuffer</span><span class="p">();</span>
<span class="n">floatBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Convert the ByteBuffer data format into Bitmap.</p>
<p>Based on the inferred data, compare the coordinates of each pixel in the bitmap. If the coordinate data corresponds to PERSON, the color of the coordinate point remains unchanged. Otherwise, change the color to transparent, as shown in the following figure.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Bitmap</span><span class="p">.</span><span class="na">Config</span><span class="w"> </span><span class="n">conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bitmap</span><span class="p">.</span><span class="na">Config</span><span class="p">.</span><span class="na">ARGB_8888</span><span class="p">;</span>
<span class="n">Bitmap</span><span class="w"> </span><span class="n">maskBitmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bitmap</span><span class="p">.</span><span class="na">createBitmap</span><span class="p">(</span><span class="n">imageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">imageHeight</span><span class="p">,</span><span class="w"> </span><span class="n">conf</span><span class="p">);</span>
<span class="n">Bitmap</span><span class="w"> </span><span class="n">scaledBackgroundImage</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">BitmapUtils</span><span class="p">.</span><span class="na">scaleBitmapAndKeepRatio</span><span class="p">(</span><span class="n">backgroundImage</span><span class="p">,</span><span class="w"> </span><span class="n">imageWidth</span><span class="p">,</span><span class="w"> </span><span class="n">imageHeight</span><span class="p">);</span>
<span class="kt">int</span><span class="o">[][]</span><span class="w"> </span><span class="n">mSegmentBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">imageWidth</span><span class="o">][</span><span class="n">imageHeight</span><span class="o">]</span><span class="p">;</span>
<span class="n">inputBuffer</span><span class="p">.</span><span class="na">rewind</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">imageHeight</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">imageWidth</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0f</span><span class="p">;</span>
<span class="w">        </span><span class="n">mSegmentBits</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_CLASSES</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">getFloat</span><span class="p">((</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">imageWidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NUM_CLASSES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NUM_CLASSES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">maxVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PERSON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">mSegmentBits</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">mSegmentBits</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">maskBitmap</span><span class="p">.</span><span class="na">setPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">mSegmentBits</span><span class="o">[</span><span class="n">x</span><span class="o">][</span><span class="n">y</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">colors</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">scaledBackgroundImage</span><span class="p">.</span><span class="na">getPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
  <table>
     <tr>
      <td><center><img src="https://gitee.com/mindspore/docs/raw/r1.3/docs/lite/docs/source_en/images/segmentation6.png"><br>Figure 1 Before inference</br></center></td>
      <td><center><img src="https://gitee.com/mindspore/docs/raw/r1.3/docs/lite/docs/source_en/images/segmentation7.png"><br>Figure 2 After inference</br></center></td>
    </tr>
  </table>
</li>
</ul>
</li>
<li><p>Combine the image after inference with the selected background image.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">MainActivity</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">imgPreview</span><span class="p">.</span><span class="na">setDrawingCacheEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="n">MainActivity</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">imgPreview</span><span class="p">.</span><span class="na">setBackground</span><span class="p">(</span><span class="n">isDemo</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">getDrawable</span><span class="p">(</span><span class="n">IMAGES</span><span class="o">[</span><span class="n">selectedPosition</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">customBack</span><span class="p">);</span>
<span class="n">MainActivity</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">imgPreview</span><span class="p">.</span><span class="na">setImageBitmap</span><span class="p">(</span><span class="n">foreground</span><span class="p">);</span>
<span class="n">MainActivity</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">imgPreview</span><span class="p">.</span><span class="na">setDrawingCacheEnabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quick_start.html" class="btn btn-neutral float-left" title="Android Application Development Based on JNI Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="train_lenet.html" class="btn btn-neutral float-right" title="Implement Device Training Based On C++ Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore Lite.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>