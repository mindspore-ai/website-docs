

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Java Interface to Perform Training &mdash; MindSpore Lite master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/lite.css" type="text/css" />
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/lite.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Custom Kernel" href="register.html" />
    <link rel="prev" title="Using C++ Interface to Perform Training" href="runtime_train_cpp.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore Lite
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Obtain MindSpore Lite</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="downloads.html">Downloading MindSpore Lite</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building MindSpore Lite</a></li>
</ul>
<p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/one_hour_introduction.html">Getting Started in One Hour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_cpp.html">Experience C++ Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_server_inference_cpp.html">Experience C++ Minimalist Concurrent Reasoning Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_java.html">Experience Java Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_server_inference_java.html">Experience Java Minimalist Concurrent Reasoning Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">Android Application Development Based on JNI Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/image_segmentation.html">Android Application Development Based on Java Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/train_lenet.html">Implement Device Training Based On C++ Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/train_lenet_java.html">Implement Device Training Based On Java Interface</a></li>
</ul>
<p class="caption"><span class="caption-text">Inference on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="converter_tool.html">Converting Models for Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_training_quantization.html">Post Training Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_preprocessing.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="runtime.html">Executing Model Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="micro.html">Perform Inference on Mini and Small Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="asic.html">Application Specific Integrated Circuit Integration Instructions</a></li>
</ul>
<p class="caption"><span class="caption-text">Training on Devices</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="converter_train.html">Creating MindSpore Lite Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="runtime_train.html">Executing Model Training</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="runtime_train_cpp.html">Using C++ Interface to Perform Training</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using Java Interface to Perform Training</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-creating,-loading-and-building">Model Creating, Loading and Building</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reading-models">Reading Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-contexts">Creating Contexts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-trainloop">Creating TrainLoop</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-processing">Data Processing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#data-reading-pipeline">Data Reading Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#execute-training">Execute Training</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#training">Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evaluating">Evaluating</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#others">Others</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#model-mode-switching">Model Mode Switching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resizing-the-input-dimension">Resizing the Input Dimension</a></li>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-input-tensors">Obtaining Input Tensors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-output-tensors">Obtaining Output Tensors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#saving-model">Saving Model</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Third-party hardware docking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="register.html">Custom Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="delegate.html">Using Delegate to Support Third-party AI Framework</a></li>
</ul>
<p class="caption"><span class="caption-text">Other Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmark Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="cropper_tool.html">Static Library Cropper Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="visual_tool.html">Visualization Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="obfuscator_tool.html">Model Obfuscation Tool</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture_lite.html">Overall Architecture (Lite)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_lite.html">Lite Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_codegen.html">Codegen Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_lite.html">Model List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting_guide.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log.html">Log</a></li>
</ul>
<p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore Lite</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="runtime_train.html">Executing Model Training</a> &raquo;</li>
        
      <li>Using Java Interface to Perform Training</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/use/runtime_train_java.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-java-interface-to-perform-training">
<h1>Using Java Interface to Perform Training<a class="headerlink" href="#using-java-interface-to-perform-training" title="Permalink to this headline">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.7/docs/lite/docs/source_en/use/runtime_train_java.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_source_en.png"></a></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The principal procedures of lite training is as follows:</p>
<ol class="simple">
<li><p>Design the network and export the <code class="docutils literal notranslate"><span class="pre">MindIR</span></code> model file by using the cloud side APIs.</p></li>
<li><p>Transfer the <code class="docutils literal notranslate"><span class="pre">MindIR</span></code> file to .ms model file.</p></li>
<li><p>Train, evaluate and save <code class="docutils literal notranslate"><span class="pre">ms</span></code> model files.</p></li>
</ol>
<blockquote>
<div><p>The model structure is saved in the transferred <code class="docutils literal notranslate"><span class="pre">ms</span></code> model file which will be load to the device platform for training.</p>
</div></blockquote>
<p>The following figure shows the detailed training process:</p>
<p><img alt="img" src="../_images/side_train_sequence_unify_api.png" /></p>
<blockquote>
<div><p>For more javaAPI description, please refer to <a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/index.html">API Documentation</a>.</p>
</div></blockquote>
</div>
<div class="section" id="model-creating,-loading-and-building">
<h2>Model Creating, Loading and Building<a class="headerlink" href="#model-creating,-loading-and-building" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/api_java/model.html#model">Model</a> is the main entrance of the MindSpore Lite framework. We can compile and execute graph models through <code class="docutils literal notranslate"><span class="pre">Model</span></code> class.</p>
<div class="section" id="reading-models">
<h3>Reading Models<a class="headerlink" href="#reading-models" title="Permalink to this headline">¶</a></h3>
<p>A Model file is flatbuffer-serialized file which was converted using the <a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/generate/classmindspore_Serialization.html">MindSpore Model Converter Tool</a>. These files have a <code class="docutils literal notranslate"><span class="pre">.ms</span></code> extension. Before model training and/or inference, the model needs to be loaded from the file system and parsed. Related operations are mainly implemented in the [Graph]((https://www.mindspore.cn/lite/api/en/r1.7/api_java/graph.html#graph) class which holds the model data such as the network structure, weights data and operators attributes.</p>
</div>
<div class="section" id="creating-contexts">
<h3>Creating Contexts<a class="headerlink" href="#creating-contexts" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/api_java/mscontext.html">MSContext</a> is a MindSpore Lite Object which contains basic configuration parameters required by the sessions to guide graph compilation and execution. It allows to define the device to run the model, e.g., CPU or GPU, the number of threads used for training and inference and the memory allocation scheme.
Currently, only CPU device is supported in training.</p>
</div>
<div class="section" id="creating-trainloop">
<h3>Creating TrainLoop<a class="headerlink" href="#creating-trainloop" title="Permalink to this headline">¶</a></h3>
<p>Users can create the object of the class <code class="docutils literal notranslate"><span class="pre">Model</span></code> by using the function <code class="docutils literal notranslate"><span class="pre">Build</span></code> to call MindData APIs. The member function <code class="docutils literal notranslate"><span class="pre">Build</span></code> of the class <code class="docutils literal notranslate"><span class="pre">Model</span></code>, its prototype is as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">public</span> <span class="pre">boolean</span> <span class="pre">build(Graph</span> <span class="pre">graph,</span> <span class="pre">MSContext</span> <span class="pre">context,</span> <span class="pre">TrainCfg</span> <span class="pre">cfg);</span></code></p>
<p>The following codes show how to create a training session based on the multi-threads CPU by using the class <code class="docutils literal notranslate"><span class="pre">Model</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Graph</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Graph</span><span class="p">();</span>
<span class="n">MSContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MSContext</span><span class="p">();</span>
<span class="n">context</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">context</span><span class="p">.</span><span class="na">addDeviceInfo</span><span class="p">(</span><span class="n">DeviceType</span><span class="p">.</span><span class="na">DT_CPU</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">TrainCfg</span> <span class="n">cfg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TrainCfg</span><span class="p">();</span>
<span class="n">cfg</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
<span class="n">Model</span> <span class="n">liteModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Model</span><span class="p">();</span>
<span class="n">liteModel</span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
</pre></div>
</div>
<blockquote>
<div><p>Refer <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/examples/train_lenet_java/src/main/java/com/mindspore/lite/train_lenet/NetRunner.java">Train a LeNet</a> for more details.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="data-processing">
<h2>Data Processing<a class="headerlink" href="#data-processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-reading-pipeline">
<h3>Data Reading Pipeline<a class="headerlink" href="#data-reading-pipeline" title="Permalink to this headline">¶</a></h3>
<p>Currently, java does not provide data processing API such as C++ <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class and its extended classes. Users need to define the data preprocessing process by themselves. After processing the image or text data into byte data, copy it to the input of the model.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>The following codes shows the Mnist data reading and data preprocessing process:</p>
<p>Currently, java does not provide data processing API such as C++ <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class and its extended classes. Users need to define the data preprocessing process by themselves. After processing the image or text data into byte data, copy it to the input of the model.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readMNISTFile</span><span class="p">(</span><span class="n">String</span> <span class="n">inputFileName</span><span class="p">,</span> <span class="n">String</span> <span class="n">labelFileName</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">DataLabelTuple</span><span class="o">&gt;</span> <span class="n">dataset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">BufferedInputStream</span> <span class="n">ibin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">inputFileName</span><span class="p">));</span>
            <span class="n">BufferedInputStream</span> <span class="n">lbin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">labelFileName</span><span class="p">));</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">;</span>

            <span class="p">...</span>
            <span class="c1">// read images</span>
            <span class="kt">int</span> <span class="n">image_size</span> <span class="o">=</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">;</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">image_data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">image_size</span><span class="o">]</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lnumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">byte</span> <span class="o">[]</span> <span class="n">hwc_bin_image</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">32</span><span class="o">]</span><span class="p">;</span>
                <span class="n">readFile</span><span class="p">(</span><span class="n">ibin</span><span class="p">,</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">image_size</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">29</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">hwc_bin_image</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">hwc_bin_image</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">[</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">]</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="n">DataLabelTuple</span> <span class="n">data_label_tupel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataLabelTuple</span><span class="p">();</span>
                <span class="n">data_label_tupel</span><span class="p">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">hwc_bin_image</span><span class="p">;</span>
                <span class="n">data_label_tupel</span><span class="p">.</span><span class="na">label</span> <span class="o">=</span> <span class="n">labels</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
                <span class="n">dataset</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">data_label_tupel</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Read Dateset exception&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>Refer <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/examples/train_lenet_java/src/main/java/com/mindspore/lite/train_lenet/NetRunner.java">Train a LeNet</a> for more details.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="execute-training">
<h2>Execute Training<a class="headerlink" href="#execute-training" title="Permalink to this headline">¶</a></h2>
<p>MindSpore Lite java interface can obtain the output of the model through the interface provided by the <code class="docutils literal notranslate"><span class="pre">Model</span></code> class. In the training mode, the output of the model is loss, and in the inference mode, the output of the model is the predicted value. The training and inference modes can be switched through the <code class="docutils literal notranslate"><span class="pre">setTrainMode</span></code> interface. Execute the model through the <code class="docutils literal notranslate"><span class="pre">runStep</span></code> interface.</p>
<div class="section" id="training">
<h3>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h3>
<p>Create the objects of the off-the-shelf functions and call the Train function of the class Model to train:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">.</span><span class="na">setTrainMode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cycles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">virtualBatch</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fillInputData</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="na">getTrainData</span><span class="p">(),</span> <span class="kc">false</span><span class="p">);</span>
        <span class="n">isSuccess</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="na">runStep</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isSuccess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">model</span><span class="p">.</span><span class="na">free</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;run step failed&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">float</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">getLoss</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">min_loss</span> <span class="o">&gt;</span> <span class="n">loss</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">min_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">calculateAccuracy</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// only test 10 batch size</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">max_acc</span> <span class="o">&lt;</span> <span class="n">acc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">max_acc</span> <span class="o">=</span> <span class="n">acc</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;step_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: \tLoss is &quot;</span> <span class="o">+</span> <span class="n">loss</span> <span class="o">+</span> <span class="s">&quot; [min=&quot;</span> <span class="o">+</span> <span class="n">min_loss</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;max_acc=&quot;</span> <span class="o">+</span> <span class="n">max_acc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>Refer <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.7/mindspore/lite/examples/train_lenet_java/src/main/java/com/mindspore/lite/train_lenet/NetRunner.java">Train a LeNet</a> for more details.</p>
</div></blockquote>
</div>
<div class="section" id="evaluating">
<h3>Evaluating<a class="headerlink" href="#evaluating" title="Permalink to this headline">¶</a></h3>
<p>Similarly, switch to inference mode through the <code class="docutils literal notranslate"><span class="pre">setTrainMode</span></code> interface:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">.</span><span class="na">setTrainMode</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</pre></div>
</div>
<blockquote>
<div><p>With TrainSessions, a network can be used for both inference and training. These two modes differ in several aspects:</p>
<ul class="simple">
<li><p>The input of the network: Running inference requires only the data, while running training requires both data and labels.</p></li>
<li><p>The output of the network: Running inference returns the predicted values in the output, while running in training mode returns the loss.</p></li>
<li><p>In training mode, the weights of the layers are updated in each Run, while in inference mode they are static.</p></li>
<li><p>Some layers behave differently in inference vs. training mode, e.g., updating the accumulated batch mean and variance in Batch Normalization layers.</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="others">
<h2>Others<a class="headerlink" href="#others" title="Permalink to this headline">¶</a></h2>
<div class="section" id="model-mode-switching">
<h3>Model Mode Switching<a class="headerlink" href="#model-mode-switching" title="Permalink to this headline">¶</a></h3>
<p>The function prototype of <code class="docutils literal notranslate"><span class="pre">setTrainMode</span></code> in the <code class="docutils literal notranslate"><span class="pre">Model</span></code> class is as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setTrainMode</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">isTrain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="resizing-the-input-dimension">
<h3>Resizing the Input Dimension<a class="headerlink" href="#resizing-the-input-dimension" title="Permalink to this headline">¶</a></h3>
<p>When MindSpore Lite is used for inference, if the input shape needs to be resized, you can call the Resize API of <a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/api_java/model.html#model">Model</a> to resize the shape of the input tensor after a model is created and built.</p>
<blockquote>
<div><p>Some networks do not support variable dimensions. As a result, an error message is displayed and the model exits unexpectedly. For example, the model contains the MatMul operator, one input tensor of the MatMul operator is the weight, and the other input tensor is the input. If a variable dimension API is called, the input tensor does not match the shape of the weight tensor. As a result, the training fails.</p>
</div></blockquote>
<p>The following sample code demonstrates how to perform Resize on the input tensor of MindSpore Lite:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="na">getInputs</span><span class="p">();</span>
<span class="kt">int</span><span class="o">[][]</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">3</span><span class="p">}};</span>
<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="na">resize</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">dims</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="obtaining-input-tensors">
<h3>Obtaining Input Tensors<a class="headerlink" href="#obtaining-input-tensors" title="Permalink to this headline">¶</a></h3>
<p>Before graph execution, whether it is during training or inference, the input data must be filled-in into the model input tensors.
MindSpore Lite provides the following methods to obtain model input tensors:</p>
<ol>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">getInputByTensorName</span></code> method to obtain model input tensors that are connected to the model input node based on the tensor name.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="cm">/**</span>
<span class="cm"> * Get input tensor by tensor name.</span>
<span class="cm"> *</span>
<span class="cm"> * @param tensorName name.</span>
<span class="cm"> * @return input tensor.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">MSTensor</span> <span class="nf">getInputByTensorName</span><span class="p">(</span><span class="n">String</span> <span class="n">tensorName</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">getInputs</span></code> method to directly obtain the vectors of all model input tensors.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Get model inputs tensor.</span>
<span class="cm"> *</span>
<span class="cm"> * @return input tensors.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span> <span class="nf">getInputs</span><span class="p">();</span>
</pre></div>
</div>
<p>If the model requires more than one input tensor (this is certainly the case during training, where both data and labels serve as inputs of the network) it is the user’s responsibility to know the inputs order or their tensorName. This can be obtained from the Python model.
Alternatively, one can deduce this information from the sizes of the input tensors.</p>
</li>
<li><p>Copying Data</p>
<p>After model input tensors are obtained, the data must be copied into the tensors. The following methods allows to access the size of the data, the number of elements, the data type and the writable pointer. See also detailed description in the <a class="reference external" href="https://www.mindspore.cn/lite/api/en/r1.7/api_java/mstensor.html#mstensor">MSTensor</a> API documentation.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assuming model is a valid instance of Model</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="na">getInputs</span><span class="p">();</span>
<span class="n">imageTensor</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dataIndex</span><span class="p">);</span>
<span class="n">imageInputBuf</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="p">.</span><span class="na">allocateDirect</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">imageTensor</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<span class="n">imageInputBuf</span><span class="p">.</span><span class="na">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="p">.</span><span class="na">nativeOrder</span><span class="p">());</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="obtaining-output-tensors">
<h3>Obtaining Output Tensors<a class="headerlink" href="#obtaining-output-tensors" title="Permalink to this headline">¶</a></h3>
<p>After each execution of the graph, the user might want to read the model’s outputs, whether it is the loss in the case of training mode, or the predicted output in the case of evaluation mode.</p>
<p>MindSpore Lite provides the following methods to obtain the model’s output <code class="docutils literal notranslate"><span class="pre">MSTensor</span></code>.</p>
<ol>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">getOutputsByNodeName</span></code> method to obtain the output tensors that belong to a certain node:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Get output tensors by node name.</span>
<span class="cm"> *</span>
<span class="cm"> * @param nodeName output node name</span>
<span class="cm"> * @return output tensor</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span> <span class="nf">getOutputsByNodeName</span><span class="p">(</span><span class="n">String</span> <span class="n">nodeName</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">getOutputByTensorName</span></code> method to obtain an output tensor, based on the tensor name.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>      <span class="cm">/**</span>
<span class="cm">    * Get output tensor names.</span>
<span class="cm">    *</span>
<span class="cm">    * @return output tensor name list.</span>
<span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">MSTensor</span> <span class="nf">getOutputByTensorName</span><span class="p">(</span><span class="n">String</span> <span class="n">tensorName</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">getOutputs</span></code> method to obtain all the output tensors, ordered by their tensor names.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="cm">/**</span>
<span class="cm">    * Get model outputs.</span>
<span class="cm">    *</span>
<span class="cm">    * @return model outputs tensor.</span>
<span class="cm">    */</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MSTensor</span><span class="o">&gt;</span> <span class="nf">getOutputs</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="saving-model">
<h3>Saving Model<a class="headerlink" href="#saving-model" title="Permalink to this headline">¶</a></h3>
<p>MindSpore Lite provides the <code class="docutils literal notranslate"><span class="pre">export</span></code> interface to save the model, the prototype is as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="cm">/**</span>
<span class="cm">     * Export the model.</span>
<span class="cm">     *</span>
<span class="cm">     * @param fileName          Name Model file name.</span>
<span class="cm">     * @param quantizationType  The quant type.0,no_quant,1,weight_quant,2,full_quant.</span>
<span class="cm">     * @param isOnlyExportInfer if export only inferece.</span>
<span class="cm">     * @param outputTensorNames tensor name used for export inference graph.</span>
<span class="cm">     * @return Whether the export is successful.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">export</span><span class="p">(</span><span class="n">String</span> <span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quantizationType</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isOnlyExportInfer</span><span class="p">,</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">outputTensorNames</span><span class="p">);</span>
</pre></div>
</div>
<p>You can load the saved model to perform re-training or inference.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="register.html" class="btn btn-neutral float-right" title="Custom Kernel" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="runtime_train_cpp.html" class="btn btn-neutral float-left" title="Using C++ Interface to Perform Training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, MindSpore Lite.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
</body>
</html>