<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Post Training Quantization &mdash; MindSpore Lite master documentation</title>
      <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/lite.css" type="text/css" /><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/lite.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Preprocessing" href="data_preprocessing.html" />
    <link rel="prev" title="Implement Device Training Based On Java Interface" href="../quick_start/train_lenet_java.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore Lite
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Obtain MindSpore Lite</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="downloads.html">Downloading MindSpore Lite</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building MindSpore Lite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/one_hour_introduction.html">Getting Started in One Hour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_cpp.html">Experience C++ Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_server_inference_cpp.html">Experience C++ Minimalist Concurrent Reasoning Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_java.html">Experience Java Simple Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_server_inference_java.html">Experience Java Minimalist Concurrent Reasoning Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_python.html">Experiencing the Python Simplified Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_server_inference_python.html">Experiencing the Python Simplified Concurrent Inference Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start_c.html">Expriencing Simpcified Inference Demo with C-language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/image_segmentation.html">Android Application Development Based on Java Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/train_lenet.html">Implement Device Training Based On C++ Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/train_lenet_java.html">Implement Device Training Based On Java Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Inference on Devices</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Post Training Quantization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-parameter">Configuration Parameter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#common-quantization-parameter">Common Quantization Parameter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mixed-bit-weight-quantization-parameter">Mixed Bit Weight Quantization Parameter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#full-quantization-parameters">Full Quantization Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-preprocessing">Data Preprocessing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#weight-quantization">Weight Quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mixed-bit-weight-quantization">Mixed Bit Weight Quantization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fixed-bit-weight-quantization">Fixed Bit Weight Quantization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#partial-model-accuracy-result">Partial Model Accuracy Result</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#full-quantization">Full Quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#partial-model-accuracy-result-1">Partial Model Accuracy Result</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-quantization">Dynamic Quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#partial-model-performance-results">Partial model performance results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#quantization-debug">Quantization Debug</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#skip-quantization-node">Skip Quantization Node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recommendations">Recommendations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data_preprocessing.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="runtime.html">Executing Model Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="micro.html">Performing Inference or Training on MCU or Small Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="asic.html">Application Specific Integrated Circuit Integration Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="runtime_train.html">Executing Model Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Server Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="runtime_server_inference.html">Executing Server Inference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Third-party hardware docking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="register.html">Custom Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="delegate.html">Using Delegate to Support Third-party AI Framework</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="converter.html">Converting Models for Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmark Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="cropper_tool.html">Static Library Cropper Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="visual_tool.html">Visualization Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="obfuscator_tool.html">Model Obfuscation Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture_lite.html">Overall Architecture (Lite)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_lite.html">Lite Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operator_list_codegen.html">Codegen Operator List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_lite.html">Model List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting_guide.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log.html">Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore Lite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Post Training Quantization</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/use/post_training_quantization.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="post-training-quantization">
<h1>Post Training Quantization<a class="headerlink" href="#post-training-quantization" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r2.0.0-alpha/docs/lite/docs/source_en/use/post_training_quantization.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_source_en.png"></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Converting a trained <code class="docutils literal notranslate"><span class="pre">float32</span></code> model into an <code class="docutils literal notranslate"><span class="pre">int8</span></code> model through quantization after training can reduce the model size and improve the inference performance. In MindSpore Lite, this function is integrated into the model conversion tool <code class="docutils literal notranslate"><span class="pre">converter_lite</span></code>. You can add command line parameters to convert a model into a quantization model.</p>
<p>MindSpore Lite quantization after training is classified into two types:</p>
<ol class="arabic simple">
<li><p>Weight quantization: quantizes a weight of a model and compresses only the model size. <code class="docutils literal notranslate"><span class="pre">float32</span></code> inference is still performed during inference.</p></li>
<li><p>Full quantization: quantizes the weight and activation value of a model. The <code class="docutils literal notranslate"><span class="pre">int</span></code> operation is performed during inference to improve the model inference speed and reduce power consumption.</p></li>
</ol>
</section>
<section id="configuration-parameter">
<h2>Configuration Parameter<a class="headerlink" href="#configuration-parameter" title="Permalink to this headline"></a></h2>
<p>Post training quantization can be enabled by configuring <code class="docutils literal notranslate"><span class="pre">configFile</span></code> through <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r2.0.0-alpha/use/converter_tool.html">Conversion Tool</a>. The configuration file adopts the style of <code class="docutils literal notranslate"><span class="pre">INI</span></code>, For quantization, configurable parameters include <code class="docutils literal notranslate"><span class="pre">common</span> <span class="pre">quantization</span> <span class="pre">parameter</span> <span class="pre">[common_quant_param]</span></code>, <code class="docutils literal notranslate"><span class="pre">mixed</span> <span class="pre">bit</span> <span class="pre">weight</span> <span class="pre">quantization</span> <span class="pre">parameter</span> <span class="pre">[mixed_bit_weight_quant_param]</span></code>,<code class="docutils literal notranslate"><span class="pre">full</span> <span class="pre">quantization</span> <span class="pre">parameter</span> <span class="pre">[full_quant_param]</span></code>, and <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">preprocess</span> <span class="pre">parameter</span> <span class="pre">[data_preprocess_param]</span></code>.</p>
<section id="common-quantization-parameter">
<h3>Common Quantization Parameter<a class="headerlink" href="#common-quantization-parameter" title="Permalink to this headline"></a></h3>
<p>common quantization parameters are the basic settings for post training quantization, mainly including <code class="docutils literal notranslate"><span class="pre">quant_type</span></code>, <code class="docutils literal notranslate"><span class="pre">bit_num</span></code>, <code class="docutils literal notranslate"><span class="pre">min_quant_weight_size</span></code>, and <code class="docutils literal notranslate"><span class="pre">min_quant_weight_channel</span></code>. The detailed description of the parameters is as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Attribute</p></th>
<th class="head"><p>Function Description</p></th>
<th class="head"><p>Parameter Type</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Value Range</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">quant_type</span></code></p></td>
<td><p>Mandatory</p></td>
<td><p>The quantization type. When set to WEIGHT_QUANT, weight quantization is enabled; when set to FULL_QUANT, full quantization is enabled; when set to DYNAMIC_QUANT, dynamic quantization is enabled.</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>WEIGHT_QUANT,<br/> FULL_QUANT,<br/>DYNAMIC_QUANT</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">bit_num</span></code></p></td>
<td><p>Optional</p></td>
<td><p>The number of quantized bits. Currently, weight quantization supports 0-16bit quantization. When it is set to 1-16bit, it is fixed-bit quantization. When it is set to 0bit, mixed-bit quantization is enabled. Full quantization and Dynamic quantization supports 8bit quantization.</p></td>
<td><p>Integer</p></td>
<td><p>8</p></td>
<td><p>WEIGHT_QUANT:[0，16]<br/>FULL_QUANT: 8<br/>DYNAMIC_QUANT:8</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">min_quant_weight_size</span></code></p></td>
<td><p>Optional</p></td>
<td><p>Set the threshold of the weight size for quantization. If the number of weights is greater than this value, the weight will be quantized.</p></td>
<td><p>Integer</p></td>
<td><p>0</p></td>
<td><p>[0, 65535]</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">min_quant_weight_channel</span></code></p></td>
<td><p>Optional</p></td>
<td><p>Set the threshold of the number of weight channels for quantization. If the number of weight channels is greater than this value, the weight will be quantized.</p></td>
<td><p>Integer</p></td>
<td><p>16</p></td>
<td><p>[0, 65535]</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">skip_quant_node</span></code></p></td>
<td><p>Optional</p></td>
<td><p>Set the name of the operator that does not need to be quantified, and use <code class="docutils literal notranslate"><span class="pre">,</span></code> to split between multiple operators.</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">debug_info_save_path</span></code></p></td>
<td><p>Optional</p></td>
<td><p>Set the folder path where the quantized debug information file is saved.</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">enable_encode</span></code></p></td>
<td><p>Optional</p></td>
<td><p>The enable switch of compression code for weight quantization.</p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>True, False</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">min_quant_weight_size</span></code> and <code class="docutils literal notranslate"><span class="pre">min_quant_weight_channel</span></code> are only valid for weight quantization.</p>
<p>Recommendation: When the accuracy of full quantization is not satisfied, you can set <code class="docutils literal notranslate"><span class="pre">debug_info_save_path</span></code> to turn on the Debug mode to get the relevant statistical report, and set <code class="docutils literal notranslate"><span class="pre">skip_quant_node</span></code> for operators that are not suitable for quantization to not quantize them.</p>
</div></blockquote>
<p>The common quantization parameter configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="c1"># Supports WEIGHT_QUANT or FULL_QUANT</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">WEIGHT_QUANT</span>
<span class="c1"># Weight quantization support the number of bits [0,16], Set to 0 is mixed bit quantization, otherwise it is fixed bit quantization</span>
<span class="c1"># Full quantization support 8bit</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">8</span>
<span class="c1"># Layers with size of weights exceeds threshold `min_quant_weight_size` will be quantized.</span>
<span class="na">min_quant_weight_size</span><span class="o">=</span><span class="s">0</span>
<span class="c1"># Layers with channel size of weights exceeds threshold `min_quant_weight_channel` will be quantized.</span>
<span class="na">min_quant_weight_channel</span><span class="o">=</span><span class="s">16</span>
<span class="c1"># Set the name of the operator that skips the quantization, and use `,` to split between multiple operators.</span>
<span class="na">skip_quant_node</span><span class="o">=</span><span class="s">node_name1,node_name2,node_name3</span>
<span class="c1"># Set the folder path where the quantization debug information file is saved.</span>
<span class="na">debug_info_save_path</span><span class="o">=</span><span class="s">/home/workspace/mindspore/debug_info_save_path</span>
<span class="c1"># Enable tensor compression for weight quantization. If parameter bit_num not equal to 8 or 16, it can not be set to false.</span>
<span class="na">enable_encode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</pre></div>
</div>
</section>
<section id="mixed-bit-weight-quantization-parameter">
<h3>Mixed Bit Weight Quantization Parameter<a class="headerlink" href="#mixed-bit-weight-quantization-parameter" title="Permalink to this headline"></a></h3>
<p>The mixed bit weight quantization parameters include <code class="docutils literal notranslate"><span class="pre">init_scale</span></code>. When enable the mixed bit weight quantization, the optimal number of bits will be automatically searched for different layers. The detailed description of the parameters is as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Attribute</p></th>
<th class="head"><p>Function Description</p></th>
<th class="head"><p>Parameter Type</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Value Range</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>init_scale</p></td>
<td><p>Optional</p></td>
<td><p>Initialize the scale. The larger the value, the greater the compression rate, but it will also cause varying degrees of accuracy loss.</p></td>
<td><p>Float</p></td>
<td><p>0.02</p></td>
<td><p>(0 , 1)</p></td>
</tr>
<tr class="row-odd"><td><p>auto_tune</p></td>
<td><p>Optional</p></td>
<td><p>Automatically search for the init_scale parameter. After setting, it will automatically search for a set of <code class="docutils literal notranslate"><span class="pre">init_scale</span></code> values whose cosine similarity of the model output Tensor is around 0.995.</p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>True，False</p></td>
</tr>
</tbody>
</table>
<p>The mixed bit quantization parameter configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[mixed_bit_weight_quant_param]</span>
<span class="na">init_scale</span><span class="o">=</span><span class="s">0.02</span>
<span class="na">auto_tune</span><span class="o">=</span><span class="s">false</span>
</pre></div>
</div>
</section>
<section id="full-quantization-parameters">
<h3>Full Quantization Parameters<a class="headerlink" href="#full-quantization-parameters" title="Permalink to this headline"></a></h3>
<p>The full quantization parameters mainly include <code class="docutils literal notranslate"><span class="pre">activation_quant_method</span></code>, <code class="docutils literal notranslate"><span class="pre">bias_correction</span></code> and <code class="docutils literal notranslate"><span class="pre">target_device</span></code>. The detailed description of the parameters is as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Attribute</p></th>
<th class="head"><p>Function Description</p></th>
<th class="head"><p>Parameter Type</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Value Range</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>activation_quant_method</p></td>
<td><p>Optional</p></td>
<td><p>Activation quantization algorithm</p></td>
<td><p>String</p></td>
<td><p>MAX_MIN</p></td>
<td><p>KL, MAX_MIN, or RemovalOutlier.<br/>KL: quantizes and calibrates the data range based on <a class="reference external" href="http://on-demand.gputechconf.com/gtc/2017/presentation/s7310-8-bit-inference-with-tensorrt.pdf">KL divergence</a>.<br/>MAX_MIN: data quantization parameter computed based on the maximum and minimum values.<br/>RemovalOutlier: removes the maximum and minimum values of data based on a certain proportion and then calculates the quantization parameters.<br/>If the calibration dataset is consistent with the input data during actual inference, MAX_MIN is recommended. If the noise of the calibration dataset is large, KL or RemovalOutlier is recommended.</p></td>
</tr>
<tr class="row-odd"><td><p>bias_correction</p></td>
<td><p>Optional</p></td>
<td><p>Indicate whether to correct the quantization error.</p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>True or False. After this parameter is enabled, the accuracy of the converted model can be improved. You are advised to set this parameter to true.</p></td>
</tr>
<tr class="row-even"><td><p>per_channel</p></td>
<td><p>Optional</p></td>
<td><p>Select PerChannel or PerLayer quantization type.</p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>True or False. Set to false to enable Perlayer quantization.</p></td>
</tr>
<tr class="row-odd"><td><p>target_device</p></td>
<td><p>Optional</p></td>
<td><p>Full quantization supports multiple hardware backends. After setting the specific hardware, the converted quantization model  can execute the proprietry hardware quantization operator library. If not setting, universal quantization lib will be called.</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>NVGPU:  The quantized model can perform quantitative inference on the NVIDIA GPU. <br/>DSP:  The quantized model can perform quantitative inference on the DSP devices.</p></td>
</tr>
</tbody>
</table>
<p>The full quantization parameter (PerChannel quantization type) configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[full_quant_param]</span>
<span class="c1"># Activation quantized method supports MAX_MIN or KL or REMOVAL_OUTLIER</span>
<span class="na">activation_quant_method</span><span class="o">=</span><span class="s">MAX_MIN</span>
<span class="c1"># Whether to correct the quantization error. Recommended to set to true.</span>
<span class="na">bias_correction</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># If set to true, it will enable PerChannel quantization, or set to false to enable PerLayer quantization.</span>
<span class="na">per_channel</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
<p>The full quantization parameter (PerLayer quantization type) configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[full_quant_param]</span>
<span class="c1"># Activation quantized method supports MAX_MIN or KL or REMOVAL_OUTLIER</span>
<span class="na">activation_quant_method</span><span class="o">=</span><span class="s">MAX_MIN</span>
<span class="c1"># Whether to correct the quantization error. Recommended to set to true.</span>
<span class="na">bias_correction</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># If set to true, it will enable PerChannel quantization, or set to false to enable PerLayer quantization.</span>
<span class="na">per_channel</span><span class="o">=</span><span class="s">false</span>
</pre></div>
</div>
<p>NVIDIA GPU full quantization parameter configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[full_quant_param]</span>
<span class="c1"># Activation quantized method supports MAX_MIN or KL or REMOVAL_OUTLIER</span>
<span class="na">activation_quant_method</span><span class="o">=</span><span class="s">MAX_MIN</span>
<span class="c1"># Whether to correct the quantization error. Recommended to set to true.</span>
<span class="na">bias_correction</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># Whether to support PerChannel quantization strategy. Recommended to set to true.</span>
<span class="na">per_channel</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># Supports specific hardware backends</span>
<span class="na">target_device</span><span class="o">=</span><span class="s">NVGPU</span>
</pre></div>
</div>
<p>DSP full quantization parameter configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[full_quant_param]</span>
<span class="c1"># Activation quantized method supports MAX_MIN or KL or REMOVAL_OUTLIER</span>
<span class="na">activation_quant_method</span><span class="o">=</span><span class="s">MAX_MIN</span>
<span class="c1"># Whether to correct the quantization error.</span>
<span class="na">bias_correction</span><span class="o">=</span><span class="s">false</span>
<span class="c1"># Supports specific hardware backends</span>
<span class="na">target_device</span><span class="o">=</span><span class="s">DSP</span>
</pre></div>
</div>
</section>
<section id="data-preprocessing">
<h3>Data Preprocessing<a class="headerlink" href="#data-preprocessing" title="Permalink to this headline"></a></h3>
<p>Full quantization needs to provide 100-500 calibration data sets for pre-inference, which is used to calculate the quantization parameters of full quantization activation values. If there are multiple input Tensors, the calibration dataset for each input Tensor needs to be saved in a separate folder.</p>
<p>For the BIN calibration dataset, the <code class="docutils literal notranslate"><span class="pre">.bin</span></code> file stores the input data buffer, and the format of the input data needs to be consistent with the format of the input data during inference. For 4D data, the default is <code class="docutils literal notranslate"><span class="pre">NHWC</span></code>. If the command parameter <code class="docutils literal notranslate"><span class="pre">inputDataFormat</span></code> of the converter tool is configured, the format of the input Buffer needs to be consistent.</p>
<p>For the image calibration dataset, post training quantization provides data preprocessing functions such as channel conversion, normalization, resize, and center crop.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Attribute</p></th>
<th class="head"><p>Function Description</p></th>
<th class="head"><p>Parameter Type</p></th>
<th class="head"><p>Default Value</p></th>
<th class="head"><p>Value Range</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>calibrate_path</p></td>
<td><p>Mandatory</p></td>
<td><p>The directory where the calibration dataset is stored; if the model has multiple inputs, please fill in the directory where the corresponding data is located one by one, and separate the directory paths with <code class="docutils literal notranslate"><span class="pre">,</span></code></p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>input_name_1:/mnt/image/input_1_dir,input_name_2:input_2_dir</p></td>
</tr>
<tr class="row-odd"><td><p>calibrate_size</p></td>
<td><p>Mandatory</p></td>
<td><p>Calibration data size</p></td>
<td><p>Integer</p></td>
<td><p>-</p></td>
<td><p>[1, 65535]</p></td>
</tr>
<tr class="row-even"><td><p>input_type</p></td>
<td><p>Mandatory</p></td>
<td><p>Correction data file format type</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>IMAGE、BIN <br>IMAGE：image file data <br>BIN：binary <code class="docutils literal notranslate"><span class="pre">.bin</span></code> file data</p></td>
</tr>
<tr class="row-odd"><td><p>image_to_format</p></td>
<td><p>Optional</p></td>
<td><p>Image format conversion</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>RGB、GRAY、BGR</p></td>
</tr>
<tr class="row-even"><td><p>normalize_mean</p></td>
<td><p>Optional</p></td>
<td><p>Normalized mean<br/>dst = (src - mean) / std</p></td>
<td><p>Vector</p></td>
<td><p>-</p></td>
<td><p>Channel 3: [mean_1, mean_2, mean_3] <br/>Channel 1: [mean_1]</p></td>
</tr>
<tr class="row-odd"><td><p>normalize_std</p></td>
<td><p>Optional</p></td>
<td><p>Normalized standard deviation<br/>dst = (src - mean) / std</p></td>
<td><p>Vector</p></td>
<td><p>-</p></td>
<td><p>Channel 3: [std_1, std_2, std_3] <br/>Channel 1: [std_1]</p></td>
</tr>
<tr class="row-even"><td><p>resize_width</p></td>
<td><p>Optional</p></td>
<td><p>Resize width</p></td>
<td><p>Integer</p></td>
<td><p>-</p></td>
<td><p>[1, 65535]</p></td>
</tr>
<tr class="row-odd"><td><p>resize_height</p></td>
<td><p>Optional</p></td>
<td><p>Resize height</p></td>
<td><p>Integer</p></td>
<td><p>-</p></td>
<td><p>[1, 65535]</p></td>
</tr>
<tr class="row-even"><td><p>resize_method</p></td>
<td><p>Optional</p></td>
<td><p>Resize algorithm</p></td>
<td><p>String</p></td>
<td><p>-</p></td>
<td><p>LINEAR, NEAREST, CUBIC<br/>LINEAR：Bilinear interpolation<br/>NEARST：Nearest neighbor interpolation<br/>CUBIC：Bicubic interpolation</p></td>
</tr>
<tr class="row-odd"><td><p>center_crop_width</p></td>
<td><p>Optional</p></td>
<td><p>Center crop width</p></td>
<td><p>Integer</p></td>
<td><p>-</p></td>
<td><p>[1, 65535]</p></td>
</tr>
<tr class="row-even"><td><p>center_crop_height</p></td>
<td><p>Optional</p></td>
<td><p>Center crop height</p></td>
<td><p>Integer</p></td>
<td><p>-</p></td>
<td><p>[1, 65535]</p></td>
</tr>
</tbody>
</table>
<p>The data preprocessing parameter configuration is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[data_preprocess_param]</span>
<span class="c1"># Calibration dataset path, the format is input_name_1:input_1_dir,input_name_2:input_2_dir</span>
<span class="c1"># Full quantification must provide correction dataset</span>
<span class="na">calibrate_path</span><span class="o">=</span><span class="s">input_name_1:/mnt/image/input_1_dir,input_name_2:input_2_dir</span>
<span class="c1"># Calibration data size</span>
<span class="na">calibrate_size</span><span class="o">=</span><span class="s">100</span>
<span class="c1"># Input type supports IMAGE or BIN</span>
<span class="c1"># When set to IMAGE, the image data will be read</span>
<span class="c1"># When set to BIN, the `.bin` binary file will be read</span>
<span class="na">input_type</span><span class="o">=</span><span class="s">IMAGE</span>
<span class="c1"># The output format of the preprocessed image</span>
<span class="c1"># Supports RGB or GRAY or BGR</span>
<span class="na">image_to_format</span><span class="o">=</span><span class="s">RGB</span>
<span class="c1"># Image normalization</span>
<span class="c1"># dst = (src - mean) / std</span>
<span class="na">normalize_mean</span><span class="o">=</span><span class="s">[127.5, 127.5, 127.5]</span>
<span class="na">normalize_std</span><span class="o">=</span><span class="s">[127.5, 127.5, 127.5]</span>
<span class="c1"># Image resize</span>
<span class="na">resize_width</span><span class="o">=</span><span class="s">224</span>
<span class="na">resize_height</span><span class="o">=</span><span class="s">224</span>
<span class="c1"># Resize method supports LINEAR or NEAREST or CUBIC</span>
<span class="na">resize_method</span><span class="o">=</span><span class="s">LINEAR</span>
<span class="c1"># Image center crop</span>
<span class="na">center_crop_width</span><span class="o">=</span><span class="s">224</span>
<span class="na">center_crop_height</span><span class="o">=</span><span class="s">224</span>
</pre></div>
</div>
</section>
</section>
<section id="weight-quantization">
<h2>Weight Quantization<a class="headerlink" href="#weight-quantization" title="Permalink to this headline"></a></h2>
<p>Weight quantization supports mixed bit quantization, as well as fixed bit quantization between 1 and 16. The lower the number of bits, the greater the model compression rate, but the accuracy loss is usually larger. The following describes how to use weight quantization and its effects.</p>
<section id="mixed-bit-weight-quantization">
<h3>Mixed Bit Weight Quantization<a class="headerlink" href="#mixed-bit-weight-quantization" title="Permalink to this headline"></a></h3>
<p>Currently, weight quantization supports mixed bit quantization. According to the distribution of model parameters and the initial value of <code class="docutils literal notranslate"><span class="pre">init_scale</span></code> set by the user, the number of bits that is most suitable for the current layer will be automatically searched out. When the <code class="docutils literal notranslate"><span class="pre">bit_num</span></code> of the configuration parameter is set to 0, mixed bit quantization will be enabled.</p>
<p>The general form of the mixed bit weight requantization command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>ModelType<span class="w"> </span>--modelFile<span class="o">=</span>ModelFilePath<span class="w"> </span>--outputFile<span class="o">=</span>ConvertedModelPath<span class="w"> </span>--quantType<span class="o">=</span>WeightQuant<span class="w"> </span>--configFile<span class="o">=</span>/mindspore/lite/tools/converter/quantizer/config/mixed_bit_weight_quant.cfg
</pre></div>
</div>
<p>The mixed bit weight quantification configuration file is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">WEIGHT_QUANT</span>
<span class="c1"># Weight quantization support the number of bits [0,16], Set to 0 is mixed bit quantization, otherwise it is fixed bit quantization</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">0</span>
<span class="c1"># Layers with size of weights exceeds threshold `min_quant_weight_size` will be quantized.</span>
<span class="na">min_quant_weight_size</span><span class="o">=</span><span class="s">5000</span>
<span class="c1"># Layers with channel size of weights exceeds threshold `min_quant_weight_channel` will be quantized.</span>
<span class="na">min_quant_weight_channel</span><span class="o">=</span><span class="s">5</span>

<span class="k">[mixed_bit_weight_quant_param]</span>
<span class="c1"># Initialization scale in (0,1).</span>
<span class="c1"># A larger value can get a larger compression ratio, but it may also cause a larger error.</span>
<span class="na">init_scale</span><span class="o">=</span><span class="s">0.02</span>
</pre></div>
</div>
<p>Users can adjust the weighted parameters according to the model and their own needs.</p>
<blockquote>
<div><p>The init_scale default value is 0.02, and the compression rate is equivalent to the compression effect of 6-7 fixed bits quantization.</p>
<p>Mixed bits need to search for the best bit, and the waiting time may be longer. If you need to view the log, you can set export GLOG_v=1 before the execution to print the relevant Info level log.</p>
</div></blockquote>
</section>
<section id="fixed-bit-weight-quantization">
<h3>Fixed Bit Weight Quantization<a class="headerlink" href="#fixed-bit-weight-quantization" title="Permalink to this headline"></a></h3>
<p>Fixed-bit weighting supports fixed-bit quantization between 1 and 16, and users can adjust the weighting parameters according to the requirement.</p>
<p>The general form of the fixed bit weight quantization conversion command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>ModelType<span class="w"> </span>--modelFile<span class="o">=</span>ModelFilePath<span class="w"> </span>--outputFile<span class="o">=</span>ConvertedModelPath<span class="w"> </span>--configFile<span class="o">=</span>/mindspore/lite/tools/converter/quantizer/config/fixed_bit_weight_quant.cfg
</pre></div>
</div>
<p>The fixed bit weight quantization configuration file is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">WEIGHT_QUANT</span>
<span class="c1"># Weight quantization support the number of bits [0,16], Set to 0 is mixed bit quantization, otherwise it is fixed bit quantization</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">8</span>
<span class="c1"># Layers with size of weights exceeds threshold `min_quant_weight_size` will be quantized.</span>
<span class="na">min_quant_weight_size</span><span class="o">=</span><span class="s">0</span>
<span class="c1"># Layers with channel size of weights exceeds threshold `min_quant_weight_channel` will be quantized.</span>
<span class="na">min_quant_weight_channel</span><span class="o">=</span><span class="s">16</span>
</pre></div>
</div>
</section>
<section id="partial-model-accuracy-result">
<h3>Partial Model Accuracy Result<a class="headerlink" href="#partial-model-accuracy-result" title="Permalink to this headline"></a></h3>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Model</p></th>
<th class="head"><p>Test Dataset</p></th>
<th class="head"><p>FP32 Model Accuracy</p></th>
<th class="head"><p>Weight Quantization Accuracy (8 bits)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/tflite/model_zoo/upload_20180427/inception_v3_2018_04_27.tgz">Inception_V3</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>77.60%</p></td>
<td><p>77.53%</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_02_22/mobilenet_v1_1.0_224.tgz">Mobilenet_V1_1.0_224</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>70.96%</p></td>
<td><p>70.56%</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/tflite_11_05_08/mobilenet_v2_1.0_224.tgz">Mobilenet_V2_1.0_224</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>71.56%</p></td>
<td><p>71.53%</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>All the preceding results are obtained in the x86 environment.</p>
</div></blockquote>
</section>
</section>
<section id="full-quantization">
<h2>Full Quantization<a class="headerlink" href="#full-quantization" title="Permalink to this headline"></a></h2>
<p>In CV scenarios where the model running speed needs to be improved and the model running power consumption needs to be reduced, the full quantization after training can be used. The following describes how to use full quantization and its effects.</p>
<p>To calculate a quantization parameter of an activation value, you need to provide a calibration dataset. It is recommended that the calibration dataset be obtained from the actual inference scenario and can represent the actual input of a model. The number of data records is about 100 - 500.</p>
<p>For image data, currently supports channel pack, normalization, resize, center crop processing. The user can set the corresponding <a class="reference external" href="https://www.mindspore.cn/lite/docs/en/r2.0.0-alpha/use/post_training_quantization.html#data-preprocessing">parameter</a> according to the preprocessing operation requirements.</p>
<p>Note：</p>
<ul class="simple">
<li><p>The calibration dataset must have the same distribution as the training data. The calibration dataset is consistent with the format of the model inputs(e.g. NCHW、NHWC).</p></li>
</ul>
<p>The general form of the full quantization conversion command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>ModelType<span class="w"> </span>--modelFile<span class="o">=</span>ModelFilePath<span class="w"> </span>--outputFile<span class="o">=</span>ConvertedModelPath<span class="w"> </span>--configFile<span class="o">=</span>/mindspore/lite/tools/converter/quantizer/config/full_quant.cfg
</pre></div>
</div>
<p>The full quantization profile is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">FULL_QUANT</span>
<span class="c1"># Full quantization support 8bit</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">8</span>

<span class="k">[data_preprocess_param]</span>
<span class="c1"># Calibration dataset path, the format is input_name_1:input_1_dir,input_name_2:input_2_dir</span>
<span class="c1"># Full quantification must provide correction dataset</span>
<span class="na">calibrate_path</span><span class="o">=</span><span class="s">input_name_1:/mnt/image/input_1_dir,input_name_2:input_2_dir</span>
<span class="c1"># Calibration data size</span>
<span class="na">calibrate_size</span><span class="o">=</span><span class="s">100</span>
<span class="c1"># Input type supports IMAGE or BIN</span>
<span class="c1"># When set to IMAGE, the image data will be read</span>
<span class="c1"># When set to BIN, the `.bin` binary file will be read</span>
<span class="na">input_type</span><span class="o">=</span><span class="s">IMAGE</span>
<span class="c1"># The output format of the preprocessed image</span>
<span class="c1"># Supports RGB or GRAY or BGR</span>
<span class="na">image_to_format</span><span class="o">=</span><span class="s">RGB</span>
<span class="c1"># Image normalization</span>
<span class="c1"># dst = (src - mean) / std</span>
<span class="na">normalize_mean</span><span class="o">=</span><span class="s">[127.5, 127.5, 127.5]</span>
<span class="na">normalize_std</span><span class="o">=</span><span class="s">[127.5, 127.5, 127.5]</span>
<span class="c1"># Image resize</span>
<span class="na">resize_width</span><span class="o">=</span><span class="s">224</span>
<span class="na">resize_height</span><span class="o">=</span><span class="s">224</span>
<span class="c1"># Resize method supports LINEAR or NEAREST or CUBIC</span>
<span class="na">resize_method</span><span class="o">=</span><span class="s">LINEAR</span>
<span class="c1"># Image center crop</span>
<span class="na">center_crop_width</span><span class="o">=</span><span class="s">224</span>
<span class="na">center_crop_height</span><span class="o">=</span><span class="s">224</span>

<span class="k">[full_quant_param]</span>
<span class="c1"># Activation quantized method supports MAX_MIN or KL or REMOVAL_OUTLIER</span>
<span class="na">activation_quant_method</span><span class="o">=</span><span class="s">MAX_MIN</span>
<span class="c1"># Whether to correct the quantization error. Recommended to set to true.</span>
<span class="na">bias_correction</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
<blockquote>
<div><p>Full quantification needs to perform inference, and the waiting time may be longer. If you need to view the log, you can set export GLOG_v=1 before the execution to print the relevant Info level log.</p>
</div></blockquote>
<section id="partial-model-accuracy-result-1">
<h3>Partial Model Accuracy Result<a class="headerlink" href="#partial-model-accuracy-result-1" title="Permalink to this headline"></a></h3>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Model</p></th>
<th class="head"><p>Test Dataset</p></th>
<th class="head"><p>quant_method</p></th>
<th class="head"><p>FP32 Model Accuracy</p></th>
<th class="head"><p>Full Quantization Accuracy (8 bits)</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/tflite/model_zoo/upload_20180427/inception_v3_2018_04_27.tgz">Inception_V3</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>KL</p></td>
<td><p>77.60%</p></td>
<td><p>77.40%</p></td>
<td><p>Randomly select 100 images from the ImageNet Validation dataset as a calibration dataset.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_02_22/mobilenet_v1_1.0_224.tgz">Mobilenet_V1_1.0_224</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>KL</p></td>
<td><p>70.96%</p></td>
<td><p>70.31%</p></td>
<td><p>Randomly select 100 images from the ImageNet Validation dataset as a calibration dataset.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://storage.googleapis.com/download.tensorflow.org/models/tflite_11_05_08/mobilenet_v2_1.0_224.tgz">Mobilenet_V2_1.0_224</a></p></td>
<td><p><a class="reference external" href="http://image-net.org/">ImageNet</a></p></td>
<td><p>MAX_MIN</p></td>
<td><p>71.56%</p></td>
<td><p>71.16%</p></td>
<td><p>Randomly select 100 images from the ImageNet Validation dataset as a calibration dataset.</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>All the preceding results are obtained in the x86 environment.</p>
</div></blockquote>
</section>
</section>
<section id="dynamic-quantization">
<h2>Dynamic Quantization<a class="headerlink" href="#dynamic-quantization" title="Permalink to this headline"></a></h2>
<p>In NLP scenarios where the model running speed needs to be improved and the model running power consumption needs to be reduced, the dynamic quantization after training can be used. The following describes how to use dynamic quantization and its effects.</p>
<p>In Dynamic quantization, the weights are quantized at the convert, and the activation are quantized at the runtime. Compared to static quantization, no calibration dataset is required.</p>
<p>The general form of the dynamic quantization conversion command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>ModelType<span class="w"> </span>--modelFile<span class="o">=</span>ModelFilePath<span class="w"> </span>--outputFile<span class="o">=</span>ConvertedModelPath<span class="w"> </span>--configFile<span class="o">=</span>/mindspore/lite/tools/converter/quantizer/config/dynamic_quant.cfg
</pre></div>
</div>
<p>The dynamic quantization profile is as follows:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">DYNAMIC_QUANT</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">8</span>
</pre></div>
</div>
<blockquote>
<div><p>In order to ensure the quantization accuracy, the dynamic quantization does not support setting the FP16 mode .</p>
<p>The dynamic quantization will have a further acceleration effect on the ARM architecture that supports SDOT instructions.</p>
</div></blockquote>
<section id="partial-model-performance-results">
<h3>Partial model performance results<a class="headerlink" href="#partial-model-performance-results" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>tinybert_encoder</p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Model Type</p></th>
<th class="head"><p>Runtime Mode</p></th>
<th class="head"><p>Model Size(M)</p></th>
<th class="head"><p>RAM(K)</p></th>
<th class="head"><p>Latency(ms)</p></th>
<th class="head"><p>Cos-Similarity</p></th>
<th class="head"><p>Compression Ratio</p></th>
<th class="head"><p>Memory compared to FP32</p></th>
<th class="head"><p>Latency compared to FP32</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FP32</p></td>
<td><p>FP32</p></td>
<td><p>20</p></td>
<td><p>29,029</p></td>
<td><p>9.916</p></td>
<td><p>1</p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>FP32</p></td>
<td><p>FP16</p></td>
<td><p>20</p></td>
<td><p>18,208</p></td>
<td><p>5.75</p></td>
<td><p>0.99999</p></td>
<td><p>1</p></td>
<td><p>-37.28%</p></td>
<td><p>-42.01%</p></td>
</tr>
<tr class="row-even"><td><p>FP16</p></td>
<td><p>FP16</p></td>
<td><p>12</p></td>
<td><p>18,105</p></td>
<td><p>5.924</p></td>
<td><p>0.99999</p></td>
<td><p>1.66667</p></td>
<td><p>-37.63%</p></td>
<td><p>-40.26%</p></td>
</tr>
<tr class="row-odd"><td><p>Weight Quant(8 Bit)</p></td>
<td><p>FP16</p></td>
<td><p>5.3</p></td>
<td><p>19,324</p></td>
<td><p>5.764</p></td>
<td><p>0.99994</p></td>
<td><p>3.77358</p></td>
<td><p>-33.43%</p></td>
<td><p>-41.87%</p></td>
</tr>
<tr class="row-even"><td><p><strong>Dynamic Quant</strong></p></td>
<td><p><strong>INT8+FP32</strong></p></td>
<td><p><strong>5.2</strong></p></td>
<td><p><strong>15,709</strong></p></td>
<td><p><strong>4.517</strong></p></td>
<td><p><strong>0.99668</strong></p></td>
<td><p><strong>3.84615</strong></p></td>
<td><p><strong>-45.89%</strong></p></td>
<td><p><strong>-54.45%</strong></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>tinybert_decoder</p></li>
</ul>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Model Type</p></th>
<th class="head"><p>Runtime Mode</p></th>
<th class="head"><p>Model Size(M)</p></th>
<th class="head"><p>RAM(K)</p></th>
<th class="head"><p>Latency(ms)</p></th>
<th class="head"><p>Cos-Similarity</p></th>
<th class="head"><p>Compression Ratio</p></th>
<th class="head"><p>Memory compared to FP32</p></th>
<th class="head"><p>Latency compared to FP32</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FP32</p></td>
<td><p>FP32</p></td>
<td><p>43</p></td>
<td><p>51,355</p></td>
<td><p>4.161</p></td>
<td><p>1</p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>FP32</p></td>
<td><p>FP16</p></td>
<td><p>43</p></td>
<td><p>29,462</p></td>
<td><p>2.184</p></td>
<td><p>0.99999</p></td>
<td><p>1</p></td>
<td><p>-42.63%</p></td>
<td><p>-47.51%</p></td>
</tr>
<tr class="row-even"><td><p>FP16</p></td>
<td><p>FP16</p></td>
<td><p>22</p></td>
<td><p>29,440</p></td>
<td><p>2.264</p></td>
<td><p>0.99999</p></td>
<td><p>1.95455</p></td>
<td><p>-42.67%</p></td>
<td><p>-45.59%</p></td>
</tr>
<tr class="row-odd"><td><p>Weight Quant(8 Bit)</p></td>
<td><p>FP16</p></td>
<td><p>12</p></td>
<td><p>32,285</p></td>
<td><p>2.307</p></td>
<td><p>0.99998</p></td>
<td><p>3.58333</p></td>
<td><p>-37.13%</p></td>
<td><p>-44.56%</p></td>
</tr>
<tr class="row-even"><td><p><strong>Dynamic Quant</strong></p></td>
<td><p><strong>INT8+FP32</strong></p></td>
<td><p><strong>12</strong></p></td>
<td><p><strong>22,181</strong></p></td>
<td><p><strong>2.074</strong></p></td>
<td><p><strong>0.9993</strong></p></td>
<td><p><strong>3.58333</strong></p></td>
<td><p><strong>-56.81%</strong></p></td>
<td><p><strong>-50.16%</strong></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="quantization-debug">
<h2>Quantization Debug<a class="headerlink" href="#quantization-debug" title="Permalink to this headline"></a></h2>
<p>Turn on the quantization Debug function, you can get the data distribution statistics report, which is used to evaluate the quantization error and assist the decision-making model (operator) whether it is suitable for quantization. For full quantification, N data distribution statistics reports will be generated according to the number of correction datasets provided, that is, one report will be generated for each round; for weighting, only one data distribution statistics report will be generated.</p>
<p>When setting the <code class="docutils literal notranslate"><span class="pre">debug_info_save_path</span></code> parameter, the relevant debug report will be generated in the <code class="docutils literal notranslate"><span class="pre">/home/workspace/mindspore/debug_info_save_path</span></code> folder:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="na">debug_info_save_path</span><span class="o">=</span><span class="s">/home/workspace/mindspore/debug_info_save_path</span>
</pre></div>
</div>
<p>The quantized output summary report <code class="docutils literal notranslate"><span class="pre">output_summary.csv</span></code> contains the accuracy information of the output layer Tensor of the entire network. The related fields are as follows：</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Round</p></td>
<td><p>The calibration training round</p></td>
</tr>
<tr class="row-odd"><td><p>TensorName</p></td>
<td><p>The tensor name</p></td>
</tr>
<tr class="row-even"><td><p>CosineSimilarity</p></td>
<td><p>Cosine similarity compared with the original data</p></td>
</tr>
</tbody>
</table>
<p>The data distribution statistics report <code class="docutils literal notranslate"><span class="pre">report_*.csv</span></code>will count the original data distribution of each Tensor and the data distribution after dequantization of the quantized Tensor. The relevant fields of the data distribution statistics report are as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NodeName</p></td>
<td><p>The node name</p></td>
</tr>
<tr class="row-odd"><td><p>NodeType</p></td>
<td><p>The node type</p></td>
</tr>
<tr class="row-even"><td><p>TensorName</p></td>
<td><p>The tensor name</p></td>
</tr>
<tr class="row-odd"><td><p>InOutFlag</p></td>
<td><p>The input or output tensor</p></td>
</tr>
<tr class="row-even"><td><p>DataTypeFlag</p></td>
<td><p>The data type, use Origin for original model, use Dequant for quantization model</p></td>
</tr>
<tr class="row-odd"><td><p>TensorTypeFlag</p></td>
<td><p>The data types such as input and output, use Activation, and constants, etc., use Weight.</p></td>
</tr>
<tr class="row-even"><td><p>Min</p></td>
<td><p>The minimum value</p></td>
</tr>
<tr class="row-odd"><td><p>Q1</p></td>
<td><p>The 25% quantile</p></td>
</tr>
<tr class="row-even"><td><p>Median</p></td>
<td><p>The median</p></td>
</tr>
<tr class="row-odd"><td><p>Q3</p></td>
<td><p>The 75% quantile</p></td>
</tr>
<tr class="row-even"><td><p>MAX</p></td>
<td><p>The maximum</p></td>
</tr>
<tr class="row-odd"><td><p>Mean</p></td>
<td><p>The mean</p></td>
</tr>
<tr class="row-even"><td><p>Var</p></td>
<td><p>The var</p></td>
</tr>
<tr class="row-odd"><td><p>Sparsity</p></td>
<td><p>The sparsity</p></td>
</tr>
<tr class="row-even"><td><p>Clip</p></td>
<td><p>The Clip</p></td>
</tr>
<tr class="row-odd"><td><p>CosineSimilarity</p></td>
<td><p>Cosine similarity compared with the original data</p></td>
</tr>
</tbody>
</table>
<p>The quantization parameter report <code class="docutils literal notranslate"><span class="pre">quant_param.csv</span></code> contains the quantization parameter information of all quantized Tensors. The related fields of the quantization parameter are as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NodeName</p></td>
<td><p>The node name</p></td>
</tr>
<tr class="row-odd"><td><p>NodeType</p></td>
<td><p>The node type</p></td>
</tr>
<tr class="row-even"><td><p>TensorName</p></td>
<td><p>The tensor name</p></td>
</tr>
<tr class="row-odd"><td><p>ElementsNum</p></td>
<td><p>The Tensor elements num</p></td>
</tr>
<tr class="row-even"><td><p>Dims</p></td>
<td><p>The tensor dims</p></td>
</tr>
<tr class="row-odd"><td><p>Scale</p></td>
<td><p>The quantization parameter scale</p></td>
</tr>
<tr class="row-even"><td><p>ZeroPoint</p></td>
<td><p>The quantization parameter zeropoint</p></td>
</tr>
<tr class="row-odd"><td><p>Bits</p></td>
<td><p>The number of quantization bits</p></td>
</tr>
<tr class="row-even"><td><p>CorrectionVar</p></td>
<td><p>Bias correction coefficient-variance</p></td>
</tr>
<tr class="row-odd"><td><p>CorrectionMean</p></td>
<td><p>Bias correction coefficient-mean</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Mixed bit quantization is non-standard quantization, the quantization parameter file may not exist.</p>
</div></blockquote>
<section id="skip-quantization-node">
<h3>Skip Quantization Node<a class="headerlink" href="#skip-quantization-node" title="Permalink to this headline"></a></h3>
<p>Quantization is to convert the Float32 operator to the Int8 operator. The current quantization strategy is to quantify all the nodes contained in a certain type of operator that can be supported, but there are some nodes that are more sensitive and will cause larger errors after quantization. At the same time, the inference speed of some layers after quantization is much lower than that of Float16. It supports non-quantization of the specified layer, which can effectively improve the accuracy and inference speed.</p>
<p>Below is an example of <code class="docutils literal notranslate"><span class="pre">conv2d_1</span></code> <code class="docutils literal notranslate"><span class="pre">add_8</span></code> <code class="docutils literal notranslate"><span class="pre">concat_1</span></code> without quantifying the three nodes:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[common_quant_param]</span>
<span class="c1"># Supports WEIGHT_QUANT or FULL_QUANT</span>
<span class="na">quant_type</span><span class="o">=</span><span class="s">FULL_QUANT</span>
<span class="c1"># Weight quantization support the number of bits [0,16], Set to 0 is mixed bit quantization, otherwise it is fixed bit quantization</span>
<span class="c1"># Full quantization support 8bit</span>
<span class="na">bit_num</span><span class="o">=</span><span class="s">8</span>
<span class="c1"># Set the name of the operator that skips the quantization, and use `,` to split between multiple operators.</span>
<span class="na">skip_quant_node</span><span class="o">=</span><span class="s">conv2d_1,add_8,concat_1</span>
</pre></div>
</div>
</section>
<section id="recommendations">
<h3>Recommendations<a class="headerlink" href="#recommendations" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>By filtering <code class="docutils literal notranslate"><span class="pre">InOutFlag</span> <span class="pre">==</span> <span class="pre">Output</span> <span class="pre">&amp;&amp;</span> <span class="pre">DataTypeFlag</span> <span class="pre">==</span> <span class="pre">Dequant</span></code>, the output layer of all quantization operators can be filtered out, and the accuracy loss of the operator can be judged by looking at the quantized output <code class="docutils literal notranslate"><span class="pre">CosineSimilarity</span></code>, the closer to 1 the smaller the loss.</p></li>
<li><p>For merging operators such as Add and Concat, if the distribution of <code class="docutils literal notranslate"><span class="pre">min</span></code> and <code class="docutils literal notranslate"><span class="pre">max</span></code> between different input Tensors is quite different, which is likely to cause large errors, you can set <code class="docutils literal notranslate"><span class="pre">skip_quant_node</span></code> to not quantize them.</p></li>
<li><p>For operators with a higher cutoff rate <code class="docutils literal notranslate"><span class="pre">Clip</span></code>, you can set <code class="docutils literal notranslate"><span class="pre">skip_quant_node</span></code> to not quantize it.</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../quick_start/train_lenet_java.html" class="btn btn-neutral float-left" title="Implement Device Training Based On Java Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="data_preprocessing.html" class="btn btn-neutral float-right" title="Data Preprocessing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore Lite.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>