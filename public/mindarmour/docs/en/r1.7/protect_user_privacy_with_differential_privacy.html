

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Protecting User Privacy with Differential Privacy Mechanism &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Protecting User Privacy with Suppress Privacy" href="protect_user_privacy_with_suppress_privacy.html" />
    <link rel="prev" title="Using Membership Inference to Test Model Security" href="test_model_security_membership_inference.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindarmour_install.html">MindArmour Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">AI Security</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">Improving Model Security with NAD Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">Testing Model Security Using Fuzz Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">Using Membership Inference to Test Model Security</a></li>
</ul>
<p class="caption"><span class="caption-text">AI Privacy</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Protecting User Privacy with Differential Privacy Mechanism</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#importing-library-files">Importing Library Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-parameters">Configuring Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preprocessing-the-dataset">Preprocessing the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-model">Creating the Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#introducing-the-differential-privacy">Introducing the Differential Privacy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_suppress_privacy.html">Protecting User Privacy with Suppress Privacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_encrypt_protection.html">Model Encryption Protection</a></li>
</ul>
<p class="caption"><span class="caption-text">AI Reliability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="concept_drift_time_series.html">Implementing the Concept Drift Detection Application of Time Series Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="fault_injection.html">Implementing the Model Fault Injection and Evaluation</a></li>
</ul>
<p class="caption"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.html">mindarmour</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.adv_robustness.attacks.html">mindarmour.adv_robustness.attacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.adv_robustness.defenses.html">mindarmour.adv_robustness.defenses</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.adv_robustness.detectors.html">mindarmour.adv_robustness.detectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.adv_robustness.evaluations.html">mindarmour.adv_robustness.evaluations</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.fuzz_testing.html">mindarmour.fuzz_testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.privacy.diff_privacy.html">mindarmour.privacy.diff_privacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.privacy.evaluation.html">mindarmour.privacy.evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.privacy.sup_privacy.html">mindarmour.privacy.sup_privacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.reliability.html">mindarmour.reliability</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindarmour.utils.html">mindarmour.utils</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="design.html">Overall Security and Trustworthiness Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="differential_privacy_design.html">Differential Privacy Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="fuzzer_design.html">AI Model Security Testing Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_and_privacy.html">MindArmour Module Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Protecting User Privacy with Differential Privacy Mechanism</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/protect_user_privacy_with_differential_privacy.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="protecting-user-privacy-with-differential-privacy-mechanism">
<h1>Protecting User Privacy with Differential Privacy Mechanism<a class="headerlink" href="#protecting-user-privacy-with-differential-privacy-mechanism" title="Permalink to this headline">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.7/docs/mindarmour/docs/source_en/protect_user_privacy_with_differential_privacy.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_source_en.png"></a></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Differential privacy is a mechanism for protecting user data privacy. What is privacy? Privacy refers to the attributes of individual users. Common attributes shared by a group of users may not be considered as privacy. For example, if we say “smoking people have a higher probability of getting lung cancer”, it does not disclose privacy. However, if we say “Zhang San smokes and gets lung cancer”, it discloses the privacy of Zhang San. Assume that there are 100 patients in a hospital and 10 of them have lung cancer. If the information of any 99 patients are known, we can infer whether the remaining one has lung cancer. This behavior of stealing privacy is called differential attack. Differential privacy is a method for preventing differential attacks. By adding noise, the query results of two datasets with only one different record are nearly indistinguishable. In the above example, after differential privacy is used, the statistic information of the 100 patients achieved by the attacker is almost the same as that of the 99 patients. Therefore, the attacker can hardly infer the information of the remaining one patient.</p>
<p><strong>Differential privacy in machine learning:</strong></p>
<p>Machine learning algorithms usually update model parameters and learn data features based on a large amount of data. Ideally, these models can learn the common features of a class of entities and achieve good generalization, such as “smoking patients are more likely to get lung cancer” rather than models with individual features, such as “Zhang San is a smoker who gets lung cancer.” However, machine learning algorithms do not distinguish between general and individual features. The published machine learning models, especially the deep neural networks,  may unintentionally memorize and expose the features of individual entities in training data. This can be exploited by malicious attackers to reveal Zhang San’s privacy information from the published model. Therefore, it is necessary to use differential privacy to protect machine learning models from privacy leakage.</p>
<p><strong>Differential privacy definition</strong> [1]</p>
<p><span class="math notranslate nohighlight">\(Pr[\mathcal{K}(D)\in S] \le e^{\epsilon} Pr[\mathcal{K}(D') \in S]+\delta\)</span></p>
<p>For datasets <span class="math notranslate nohighlight">\(D\)</span> and <span class="math notranslate nohighlight">\(D'\)</span> that differ on only one record, the probability of obtaining the same result from <span class="math notranslate nohighlight">\(\mathcal{K}(D)\)</span> and <span class="math notranslate nohighlight">\(\mathcal{K}(D')\)</span> by using a randomized algorithm <span class="math notranslate nohighlight">\(\mathcal{K}\)</span> must meet the preceding formula. <span class="math notranslate nohighlight">\(\epsilon\)</span> indicates the differential privacy budget and <span class="math notranslate nohighlight">\(\delta\)</span> indicates the perturbation. The smaller the values of <span class="math notranslate nohighlight">\(\epsilon\)</span> and <span class="math notranslate nohighlight">\(\delta\)</span>, the closer the data distribution output by <span class="math notranslate nohighlight">\(\mathcal{K}\)</span> on <span class="math notranslate nohighlight">\(D\)</span> and <span class="math notranslate nohighlight">\(D'\)</span>.</p>
<p><strong>Differential privacy measurement:</strong></p>
<p>Differential privacy can be measured using <span class="math notranslate nohighlight">\(\epsilon\)</span> and <span class="math notranslate nohighlight">\(\delta\)</span>.</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\epsilon\)</span>: specifies the upper limit of the output probability that can be changed when a record is added to or deleted from the dataset. We usually hope that <span class="math notranslate nohighlight">\(\epsilon\)</span> is a small constant. A smaller value indicates stricter differential privacy conditions.</p></li>
<li><p><span class="math notranslate nohighlight">\(\delta\)</span>: limits the probability of arbitrary model behavior change. Generally, this parameter is set to a small constant. You are advised to set this parameter to a value less than the reciprocal of the size of a training dataset.</p></li>
</ul>
<p><strong>Differential privacy implemented by MindArmour:</strong></p>
<p>MindArmour differential privacy module Differential-Privacy implements the differential privacy optimizer. Currently, SGD, Momentum, and Adam are supported. They are differential privacy optimizers based on the Gaussian mechanism. Gaussian noise mechanism supports both non-adaptive policy and adaptive policy  The non-adaptive policy use a fixed noise parameter for each step while the adaptive policy changes the noise parameter along time or iteration step. An advantage of using the non-adaptive Gaussian noise is that a differential privacy budget <span class="math notranslate nohighlight">\(\epsilon\)</span> can be strictly controlled. However, a disadvantage is that in a model training process, the noise amount added in each step is fixed. In the later training stage, large noise makes the model convergence difficult, and even causes the performance to decrease greatly and the model usability to be poor. Adaptive noise can solve this problem. In the initial model training stage, the amount of added noise is large. As the model converges, the amount of noise decreases gradually, and the impact of noise on model availability decreases. The disadvantage is that the differential privacy budget cannot be strictly controlled. Under the same initial value, the <span class="math notranslate nohighlight">\(\epsilon\)</span> of the adaptive differential privacy is greater than that of the non-adaptive differential privacy. Rényi differential privacy (RDP) [2] is also provided to monitor differential privacy budgets.</p>
<p>The LeNet model and MNIST dataset are used as an example to describe how to use the differential privacy optimizer to train a neural network model on MindSpore.</p>
<blockquote>
<div><p>Because of the limit of CPU ops, differential privacy training can only run on GPU or Ascend, except for CPU. This example is for the Ascend 910 AI processor. You can download the complete sample code from <a class="reference external" href="https://gitee.com/mindspore/mindarmour/blob/r1.7/examples/privacy/diff_privacy/lenet5_dp.py">https://gitee.com/mindspore/mindarmour/blob/r1.7/examples/privacy/diff_privacy/lenet5_dp.py</a>.</p>
</div></blockquote>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="importing-library-files">
<h3>Importing Library Files<a class="headerlink" href="#importing-library-files" title="Permalink to this headline">¶</a></h3>
<p>The followings are the required public modules, MindSpore modules, and differential privacy feature modules.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">easydict</span> <span class="kn">import</span> <span class="n">EasyDict</span> <span class="k">as</span> <span class="n">edict</span>

<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">CheckpointConfig</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">LossMonitor</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">Accuracy</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision.c_transforms</span> <span class="k">as</span> <span class="nn">CV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.vision</span> <span class="kn">import</span> <span class="n">Inter</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>

<span class="kn">from</span> <span class="nn">mindarmour.privacy.diff_privacy</span> <span class="kn">import</span> <span class="n">DPModel</span>
<span class="kn">from</span> <span class="nn">mindarmour.privacy.diff_privacy</span> <span class="kn">import</span> <span class="n">PrivacyMonitorFactory</span>
<span class="kn">from</span> <span class="nn">mindarmour.privacy.diff_privacy</span> <span class="kn">import</span> <span class="n">NoiseMechanismsFactory</span>
<span class="kn">from</span> <span class="nn">mindarmour.privacy.diff_privacy</span> <span class="kn">import</span> <span class="n">ClipMechanismsFactory</span>
<span class="kn">from</span> <span class="nn">mindarmour.utils</span> <span class="kn">import</span> <span class="n">LogUtil</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogUtil</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
<span class="n">TAG</span> <span class="o">=</span> <span class="s1">&#39;Lenet5_train&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-parameters">
<h3>Configuring Parameters<a class="headerlink" href="#configuring-parameters" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Set the running environment, dataset path, model training parameters, checkpoint storage parameters, and differential privacy parameters. Replace ‘data_path’ with your data path. For more configurations, see <a class="reference external" href="https://gitee.com/mindspore/mindarmour/blob/r1.7/examples/privacy/diff_privacy/lenet5_config.py">https://gitee.com/mindspore/mindarmour/blob/r1.7/examples/privacy/diff_privacy/lenet5_config.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">edict</span><span class="p">({</span>
    <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># the number of classes of model&#39;s output</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># the learning rate of model&#39;s optimizer</span>
    <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>  <span class="c1"># the momentum value of model&#39;s optimizer</span>
    <span class="s1">&#39;epoch_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># training epochs</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>  <span class="c1"># batch size for training</span>
    <span class="s1">&#39;image_height&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># the height of training samples</span>
    <span class="s1">&#39;image_width&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># the width of training samples</span>
    <span class="s1">&#39;save_checkpoint_steps&#39;</span><span class="p">:</span> <span class="mi">234</span><span class="p">,</span>  <span class="c1"># the interval steps for saving checkpoint file of the model</span>
    <span class="s1">&#39;keep_checkpoint_max&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># the maximum number of checkpoint files would be saved</span>
    <span class="s1">&#39;device_target&#39;</span><span class="p">:</span> <span class="s1">&#39;Ascend&#39;</span><span class="p">,</span>  <span class="c1"># device used</span>
    <span class="s1">&#39;data_path&#39;</span><span class="p">:</span> <span class="s1">&#39;../../common/dataset/MNIST&#39;</span><span class="p">,</span>  <span class="c1"># the path of training and testing dataset</span>
    <span class="s1">&#39;dataset_sink_mode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># whether deliver all training data to device one time</span>
    <span class="s1">&#39;micro_batches&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># the number of small batches split from an original batch</span>
    <span class="s1">&#39;norm_bound&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># the clip bound of the gradients of model&#39;s training parameters</span>
    <span class="s1">&#39;initial_noise_multiplier&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># the initial multiplication coefficient of the noise added to training</span>
    <span class="c1"># parameters&#39; gradients</span>
    <span class="s1">&#39;noise_mechanisms&#39;</span><span class="p">:</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span>  <span class="c1"># the method of adding noise in gradients while training</span>
    <span class="s1">&#39;clip_mechanisms&#39;</span><span class="p">:</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span>  <span class="c1"># the method of adaptive clipping gradients while training</span>
    <span class="s1">&#39;clip_decay_policy&#39;</span><span class="p">:</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="c1"># Decay policy of adaptive clipping, decay_policy must be in [&#39;Linear&#39;, &#39;Geometric&#39;].</span>
    <span class="s1">&#39;clip_learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="c1"># Learning rate of update norm clip.</span>
    <span class="s1">&#39;target_unclipped_quantile&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="c1"># Target quantile of norm clip.</span>
    <span class="s1">&#39;fraction_stddev&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="c1"># The stddev of Gaussian normal which used in empirical_fraction.</span>
    <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="s1">&#39;Momentum&#39;</span>  <span class="c1"># the base optimizer used for Differential privacy training</span>
<span class="p">})</span>
</pre></div>
</div>
</li>
<li><p>Configure the necessary information, including the environment information and the execution mode.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">device_target</span><span class="p">)</span>
</pre></div>
</div>
<p>For details about the API configuration, see the <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="preprocessing-the-dataset">
<h3>Preprocessing the Dataset<a class="headerlink" href="#preprocessing-the-dataset" title="Permalink to this headline">¶</a></h3>
<p>Load the dataset and convert the dataset format to a MindSpore data format.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_mnist_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataset for training or testing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># define operation parameters</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># define map operations</span>
    <span class="n">resize_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">),</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="n">Inter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
    <span class="n">rescale_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">hwc2chw_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># apply map operations on images</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="p">:</span>
        <span class="n">one_hot_enco</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">OneHot</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">one_hot_enco</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                      <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
        <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">resize_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">hwc2chw_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>

    <span class="c1"># apply DatasetOps</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds1</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-model">
<h3>Creating the Model<a class="headerlink" href="#creating-the-model" title="Permalink to this headline">¶</a></h3>
<p>The LeNet model is used as an example. You can also create and train your own model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">TruncatedNormal</span>


<span class="k">def</span> <span class="nf">conv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span>
                     <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
                     <span class="n">weight_init</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">has_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fc_with_initialize</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">weight_variable</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TruncatedNormal</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LeNet5</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LeNet network</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeNet5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>Load the LeNet network, define the loss function, configure the checkpoint parameters, and load data by using the <code class="docutils literal notranslate"><span class="pre">generate_mnist_dataset</span></code> function defined in the preceding information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_checkpoint_steps</span><span class="p">,</span>
                             <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;checkpoint_lenet&quot;</span><span class="p">,</span>
                             <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./trained_ckpt_file/&#39;</span><span class="p">,</span>
                             <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>

<span class="c1"># get training dataset</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">generate_mnist_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span>
                                  <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="introducing-the-differential-privacy">
<h3>Introducing the Differential Privacy<a class="headerlink" href="#introducing-the-differential-privacy" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Set parameters of a differential privacy optimizer.</p>
<ul class="simple">
<li><p>Determine whether values of the <code class="docutils literal notranslate"><span class="pre">micro_batches</span></code> and <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> parameters meet the requirements. The value of <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> must be an integer multiple of <code class="docutils literal notranslate"><span class="pre">micro_batches</span></code>.</p></li>
<li><p>Instantiate a differential privacy factory class.</p></li>
<li><p>Set a noise mechanism for the differential privacy. Currently, the Gaussian noise mechanism with a fixed standard deviation (<code class="docutils literal notranslate"><span class="pre">Gaussian</span></code>) and the Gaussian noise mechanism with an adaptive standard deviation (<code class="docutils literal notranslate"><span class="pre">AdaGaussian</span></code>) are supported.</p></li>
<li><p>Set an optimizer type. Currently, <code class="docutils literal notranslate"><span class="pre">SGD</span></code>, <code class="docutils literal notranslate"><span class="pre">Momentum</span></code>, and <code class="docutils literal notranslate"><span class="pre">Adam</span></code> are supported.</p></li>
<li><p>Set up a differential privacy budget monitor RDP to observe changes in the differential privacy budget <span class="math notranslate nohighlight">\(\epsilon\)</span> in each step.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">micro_batches</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">micro_batches</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;Number of micro_batches should divide evenly batch_size&quot;</span><span class="p">)</span>
<span class="c1"># Create a factory class of DP noise mechanisms, this method is adding noise</span>
<span class="c1"># in gradients while training. Initial_noise_multiplier is suggested to be</span>
<span class="c1"># greater than 1.0, otherwise the privacy budget would be huge, which means</span>
<span class="c1"># that the privacy protection effect is weak. Mechanisms can be &#39;Gaussian&#39;</span>
<span class="c1"># or &#39;AdaGaussian&#39;, in which noise would be decayed with &#39;AdaGaussian&#39;</span>
<span class="c1"># mechanism while be constant with &#39;Gaussian&#39; mechanism.</span>
<span class="n">noise_mech</span> <span class="o">=</span> <span class="n">NoiseMechanismsFactory</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">noise_mechanisms</span><span class="p">,</span>
                                            <span class="n">norm_bound</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">norm_bound</span><span class="p">,</span>
                                            <span class="n">initial_noise_multiplier</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_noise_multiplier</span><span class="p">,</span>
                                            <span class="n">decay_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Create a factory class of clip mechanisms, this method is to adaptive clip</span>
<span class="c1"># gradients while training, decay_policy support &#39;Linear&#39; and &#39;Geometric&#39;,</span>
<span class="c1"># learning_rate is the learning rate to update clip_norm,</span>
<span class="c1"># target_unclipped_quantile is the target quantile of norm clip,</span>
<span class="c1"># fraction_stddev is the stddev of Gaussian normal which used in</span>
<span class="c1"># empirical_fraction, the formula is</span>
<span class="c1"># $empirical_fraction + N(0, fraction_stddev)$.</span>
<span class="n">clip_mech</span> <span class="o">=</span> <span class="n">ClipMechanismsFactory</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">clip_mechanisms</span><span class="p">,</span>
                                            <span class="n">decay_policy</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">clip_decay_policy</span><span class="p">,</span>
                                            <span class="n">learning_rate</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">clip_learning_rate</span><span class="p">,</span>
                                            <span class="n">target_unclipped_quantile</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">target_unclipped_quantile</span><span class="p">,</span>
                                            <span class="n">fraction_stddev</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">fraction_stddev</span><span class="p">)</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span>
<span class="c1"># Create a monitor for DP training. The function of the monitor is to</span>
<span class="c1"># compute and print the privacy budget(eps and delta) while training.</span>
<span class="n">rdp_monitor</span> <span class="o">=</span> <span class="n">PrivacyMonitorFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;rdp&#39;</span><span class="p">,</span>
                                            <span class="n">num_samples</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span>
                                            <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                            <span class="n">initial_noise_multiplier</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">initial_noise_multiplier</span><span class="p">,</span>
                                            <span class="n">per_print_times</span><span class="o">=</span><span class="mi">234</span><span class="p">,</span>
                                            <span class="n">noise_decay_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Pack the LeNet model as a differential privacy model by transferring the network to <code class="docutils literal notranslate"><span class="pre">DPModel</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the DP model for training.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DPModel</span><span class="p">(</span><span class="n">micro_batches</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">micro_batches</span><span class="p">,</span>
                <span class="n">norm_bound</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">norm_bound</span><span class="p">,</span>
                <span class="n">noise_mech</span><span class="o">=</span><span class="n">noise_mech</span><span class="p">,</span>
                <span class="n">clip_mech</span><span class="o">=</span><span class="n">clip_mech</span><span class="p">,</span>
                <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">net_loss</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">net_opt</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">()})</span>
</pre></div>
</div>
</li>
<li><p>Train and test the model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&quot;============== Starting Training ==============&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;epoch_size&#39;</span><span class="p">],</span> <span class="n">ds_train</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">,</span> <span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">rdp_monitor</span><span class="p">],</span>
            <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset_sink_mode</span><span class="p">)</span>

<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&quot;============== Starting Testing ==============&quot;</span><span class="p">)</span>
<span class="n">ckpt_file_name</span> <span class="o">=</span> <span class="s1">&#39;trained_ckpt_file/checkpoint_lenet-10_234.ckpt&#39;</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_file_name</span><span class="p">)</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">ds_eval</span> <span class="o">=</span> <span class="n">generate_mnist_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">),</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ds_eval</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&quot;============== Accuracy: </span><span class="si">%s</span><span class="s2">  ==============&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Run the following command to execute the script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python lenet5_dp.py
</pre></div>
</div>
<p>In the preceding command, replace <code class="docutils literal notranslate"><span class="pre">lenet5_dp.py</span></code> with the name of your script.</p>
</li>
<li><p>Display the result.</p>
<p>The accuracy of the LeNet model without differential privacy is 99%, and the accuracy of the LeNet model with Gaussian noise and adaptive clip differential privacy is mostly more than 95%.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>============== Starting Training ==============
...
============== Starting Testing ==============
...
============== Accuracy: 0.9698  ==============
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<p>[1] C. Dwork and J. Lei. Differential privacy and robust statistics. In STOC, pages 371–380. ACM, 2009.</p>
<p>[2] Ilya Mironov. Rényi diﬀerential privacy. In IEEE Computer Security Foundations Symposium, 2017.</p>
<p>[3] Abadi, M. e. a., 2016. <em>Deep learning with differential privacy.</em> s.l.:Proceedings of the 2016 ACM SIGSAC Conference on Computer and Communications Security.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="protect_user_privacy_with_suppress_privacy.html" class="btn btn-neutral float-right" title="Protecting User Privacy with Suppress Privacy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="test_model_security_membership_inference.html" class="btn btn-neutral float-left" title="Using Membership Inference to Test Model Security" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>