<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device-to-device Differentiable FDTD for Solving Electromagnetic Inverse Scattering &mdash; MindSpore master documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Visualizing Electromagnetic Simulation Results" href="visualization.html" />
    <link rel="prev" title="S-parameter Simulation of Patch Antenna Based on Differentiable FDTD" href="AD_FDTD_forward.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro_and_install.html">MindSpore Elec Introduction and Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="physics_driven.html">Physics Informed Deep Learning Method for Electromagnetic Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_driven.html">Data Driven Deep Learning Method for Electromagnetic Simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="AD_FDTD.html">Device-to-device differentiable FDTD method</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AD_FDTD_forward.html">S-parameter Simulation of Patch Antenna Based on Differentiable FDTD</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Device-to-device Differentiable FDTD for Solving Electromagnetic Inverse Scattering</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maxwell's-equations">Maxwell’s Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#import-dependencies">Import Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading-the-dataset">Loading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-excitation-source-location,-observation-point-location-and-solution-area">Defining the Excitation Source Location, Observation Point Location and Solution Area</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-excitation-source-time-domain-waveform">Defining the Excitation Source Time Domain Waveform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructing-the-differentiable-fdtd-network">Constructing the Differentiable FDTD Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-training">Model Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#evaluating-the-solution-results">Evaluating the Solution Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing Electromagnetic Simulation Results</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindelec.architecture.html">mindelec.architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.common.html">mindelec.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.data.html">mindelec.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.geometry.html">mindelec.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.loss.html">mindelec.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.operators.html">mindelec.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.solver.html">mindelec.solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.vision.html">mindelec.vision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="AD_FDTD.html">Device-to-device differentiable FDTD method</a> &raquo;</li>
      <li>Device-to-device Differentiable FDTD for Solving Electromagnetic Inverse Scattering</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/AD_FDTD_inverse.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="device-to-device-differentiable-fdtd-for-solving-electromagnetic-inverse-scattering">
<h1>Device-to-device Differentiable FDTD for Solving Electromagnetic Inverse Scattering<a class="headerlink" href="#device-to-device-differentiable-fdtd-for-solving-electromagnetic-inverse-scattering" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindelec/docs/source_en/AD_FDTD_inverse.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.png" /></a>  </p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This tutorial introduces the method for solving electromagnetic inverse problems provided by MindSpore Elec   based on device-to-device differentiable FDTD. The process of solving Maxwell’s equations by the finite-difference time-domain (FDTD) method is equivalent to a recurrent convolutional network (RCNN). The device-to-device differentiable FDTD can be obtained by rewriting the update process with the differentiable operator of MindSpore. Compared with the data-driven black-box model, the solution process of the differentiable FDTD method strictly satisfies the constraints of Maxwell’s equations. Using MindSpore gradient-ased optimizer, differentiable FDTD can solve various EM inverse problems.</p>
<blockquote>
<div><p>This example is for GPU processors and you can download the full sample code here:
<a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/master/MindElec/examples/AD_FDTD/fdtd_forward">https://gitee.com/mindspore/mindscience/tree/master/MindElec/examples/AD_FDTD/fdtd_forward</a></p>
</div></blockquote>
</section>
<section id="maxwell's-equations">
<h2>Maxwell’s Equations<a class="headerlink" href="#maxwell's-equations" title="Permalink to this headline"></a></h2>
<p>Active Maxwell’s equations are the classical control equations for electromagnetic simulation, which are a set of partial differential equations describing the relationship between electric and magnetic fields and charge density and current density, in the following form:</p>
<div class="math notranslate nohighlight">
\[
\nabla\times E=-\mu \dfrac{\partial H}{\partial t},
\]</div>
<div class="math notranslate nohighlight">
\[
\nabla\times H=\epsilon \dfrac{\partial E}{\partial t} + J(x, t)
\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon,\mu\)</span> are the absolute permittivity and absolute magnetic permeability respectively. <span class="math notranslate nohighlight">\(J(x, t)\)</span> is the excitation source in the electromagnetic simulation process, which is usually expressed in the form of a port pulse. This is approximated in a mathematical sense as the point source expressed in Dirac functional form, which can be expressed as:</p>
<div class="math notranslate nohighlight">
\[
J(x, t)=\delta(x - x_0)g(t)
\]</div>
<p>where <span class="math notranslate nohighlight">\(x_0\)</span> is the excitation source position and <span class="math notranslate nohighlight">\(g(t)\)</span> is the functional expression of the pulse signal.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>This case solves the electromagnetic inverse scattering in two-dimensional TM mode. The two plastids are located inside the rectangular area. Four excitation sources (red triangles) and eight observation points (green dots) are set on the outside of the solution area, as shown in the following figure:</p>
<p><img alt="Solution Area Setting" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindelec/docs/source_zh_cn/images/AD_FDTD/fdtd_inverse/inversion_problem_setup.png" /></p>
<p>The process that MindSpore Elec solves the problem is as follows:</p>
<ol class="arabic simple">
<li><p>Obtain the time domain electric field values at the observation points with traditional numerical methods to create training datasets and evaluation data.</p></li>
<li><p>Define the excitation source location, the observation point location and the solution area.</p></li>
<li><p>Define the time domain waveform of the excitation source.</p></li>
<li><p>Construct differentiable FDTD networks.</p></li>
<li><p>Train the network and evaluate the solution results.</p></li>
</ol>
</section>
<section id="import-dependencies">
<h2>Import Dependencies<a class="headerlink" href="#import-dependencies" title="Permalink to this headline"></a></h2>
<p>Import the modules and interfaces that this tutorial depends on:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">transverse_magnetic</span><span class="p">,</span> <span class="n">EMInverseSolver</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">vstack</span><span class="p">,</span> <span class="n">elu</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">Gaussian</span><span class="p">,</span> <span class="n">CFSParameters</span><span class="p">,</span> <span class="n">estimate_time_interval</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">BaseTopologyDesigner</span>
</pre></div>
</div>
</section>
<section id="loading-the-dataset">
<h2>Loading the Dataset<a class="headerlink" href="#loading-the-dataset" title="Permalink to this headline"></a></h2>
<p>Load the time-domain electric field values at each observation point calculated by conventional numerical methods (e.g., FDTD), as well as the true value of the relative dielectric constant.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load labels of Ez fields and epsr.</span>

<span class="sd">    Args:</span>
<span class="sd">        nt (int): Number of time steps.</span>
<span class="sd">        dataset_dir (str): Dataset directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        field_labels (Tensor, shape=(nt, ns, nr)): Ez at receivers.</span>
<span class="sd">        epsr_labels (Tensor, shape=(nx, ny)): Ground truth for epsr.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">field_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="s1">&#39;ez_labels.npy&#39;</span><span class="p">)</span>
    <span class="n">field_labels</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field_label_path</span><span class="p">))[:</span><span class="n">nt</span><span class="p">]</span>

    <span class="n">epsr_label_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="s1">&#39;epsr_labels.npy&#39;</span><span class="p">)</span>
    <span class="n">epsr_labels</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">epsr_label_path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">field_labels</span><span class="p">,</span> <span class="n">epsr_labels</span>
</pre></div>
</div>
</section>
<section id="defining-the-excitation-source-location,-observation-point-location-and-solution-area">
<h2>Defining the Excitation Source Location, Observation Point Location and Solution Area<a class="headerlink" href="#defining-the-excitation-source-location,-observation-point-location-and-solution-area" title="Permalink to this headline"></a></h2>
<p>Inheriting the <code class="docutils literal notranslate"><span class="pre">BaseTopologyDesiger</span></code> class, users can quickly define electromagnetic inverse scattering problems. Users can set the solution area, excitation source location and observation point location in the member functions <code class="docutils literal notranslate"><span class="pre">generate_object</span></code>, <code class="docutils literal notranslate"><span class="pre">update_sources</span></code> and <code class="docutils literal notranslate"><span class="pre">get_outputs_at_each_step</span></code>, respectively. Taking this problem as an example, we define the electromagnetic inverse scattering problem as follows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">InverseDomain</span><span class="p">(</span><span class="n">BaseTopologyDesigner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    InverseDomain with customized mapping and source locations for user-defined problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">generate_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate material tensors.</span>

<span class="sd">        Args:</span>
<span class="sd">            rho (Parameter): Parameters to be optimized in the inversion domain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            epsr (Tensor, shape=(self.cell_nunbers)): Relative permittivity in the whole domain.</span>
<span class="sd">            sige (Tensor, shape=(self.cell_nunbers)): Conductivity in the whole domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># generate background material tensors</span>
        <span class="n">epsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_epsr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">sige</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_sige</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="c1"># ---------------------------------------------</span>
        <span class="c1"># Customized Differentiable Mapping</span>
        <span class="c1"># ---------------------------------------------</span>
        <span class="n">epsr</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">70</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_epsr</span> <span class="o">+</span> <span class="n">elu</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">epsr</span><span class="p">,</span> <span class="n">sige</span>

    <span class="k">def</span> <span class="nf">update_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set locations of sources.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: arguments</span>

<span class="sd">        Returns:</span>
<span class="sd">            jz (Tensor, shape=(ns, 1, nx+1, ny+1)): Jz tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sources</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">waveform</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">jz</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">waveform</span>
        <span class="n">jz</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">waveform</span>
        <span class="n">jz</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">waveform</span>
        <span class="n">jz</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="n">waveform</span>
        <span class="k">return</span> <span class="n">jz</span>

    <span class="k">def</span> <span class="nf">get_outputs_at_each_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute output each step.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: arguments</span>

<span class="sd">        Returns:</span>
<span class="sd">            rx (Tensor, shape=(ns, nr)): Ez fields at receivers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ez</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
            <span class="n">ez</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">vstack</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span>
</pre></div>
</div>
<p>It should be noted that when mapping the variable to be optimized <code class="docutils literal notranslate"><span class="pre">rho</span></code>, to the relative permittivity <code class="docutils literal notranslate"><span class="pre">epsr</span></code> in <code class="docutils literal notranslate"><span class="pre">generate_object</span></code>, choosing the right mapping relationship can greatly speed up the solver convergence. The mapping relationship used in this case is <code class="docutils literal notranslate"><span class="pre">background_epsr</span> <span class="pre">+</span> <span class="pre">elu(rho,</span> <span class="pre">alpha=1e-2)</span></code>, which guarantees that no unphysical dielectric constant will appear during the solution.</p>
</section>
<section id="defining-the-excitation-source-time-domain-waveform">
<h2>Defining the Excitation Source Time Domain Waveform<a class="headerlink" href="#defining-the-excitation-source-time-domain-waveform" title="Permalink to this headline"></a></h2>
<p>The time domain waveform of the excitation source in this case is a Gaussian pulse. FDTD uses the leap-frog scheme to update the electric and magnetic fields separately, and the excitation source in this case is a voltage source, so the time domain waveform value of the excitation source on the half time step should be calculated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_waveform_t</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fmax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute waveforms at time t.</span>

<span class="sd">    Args:</span>
<span class="sd">        nt (int): Number of time steps.</span>
<span class="sd">        dt (float): Time interval.</span>
<span class="sd">        fmax (float): Maximum freuqency of Gaussian wave</span>

<span class="sd">    Returns:</span>
<span class="sd">        waveform_t (Tensor, shape=(nt, ns, nr)): Waveforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">Gaussian</span><span class="p">(</span><span class="n">fmax</span><span class="p">)</span>
    <span class="n">waveform_t</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">waveform_t</span>
</pre></div>
</div>
</section>
<section id="constructing-the-differentiable-fdtd-network">
<h2>Constructing the Differentiable FDTD Network<a class="headerlink" href="#constructing-the-differentiable-fdtd-network" title="Permalink to this headline"></a></h2>
<p>This case solves the electromagnetic inverse scattering problem in two-dimensional TM mode. The process of solving Maxwell’s equations by the finite-difference in time domain (FDTD) method is equivalent to a recurrent convolutional network (RCNN). When the CFS-PML is used to truncate the infinite region, the update process of the <span class="math notranslate nohighlight">\(n\)</span>th time step of the two-dimensional FDTD in TM mode is as follows:</p>
<p><img alt="FDTD Time-step Update Process" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindelec/docs/source_zh_cn/images/AD_FDTD/fdtd_inverse/FDTD_RCNN_Update_TM_Mode.png" /></p>
<p>The device-to-device differentiable FDTD is obtained by rewriting the update process of the FDTD with the differentiable operator of MindSpore. The computation process within each time step is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FDTDLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    One-step 2D TM-Mode FDTD.</span>

<span class="sd">    Args:</span>
<span class="sd">        cell_lengths (tuple): Lengths of Yee cells.</span>
<span class="sd">        cpmlx_e (Tensor): Updating coefficients for electric fields in the x-direction CPML.</span>
<span class="sd">        cpmlx_m (Tensor): Updating coefficients for magnetic fields in the x-direction CPML.</span>
<span class="sd">        cpmly_e (Tensor): Updating coefficients for electric fields in the y-direction CPML.</span>
<span class="sd">        cpmly_m (Tensor): Updating coefficients for magnetic fields in the y-direction CPML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cell_lengths</span><span class="p">,</span>
                 <span class="n">cpmlx_e</span><span class="p">,</span> <span class="n">cpmlx_m</span><span class="p">,</span>
                 <span class="n">cpmly_e</span><span class="p">,</span> <span class="n">cpmly_m</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FDTDLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">cell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">cell_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_e</span> <span class="o">=</span> <span class="n">cpmlx_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_m</span> <span class="o">=</span> <span class="n">cpmlx_m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_e</span> <span class="o">=</span> <span class="n">cpmly_e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_m</span> <span class="o">=</span> <span class="n">cpmly_m</span>
        <span class="c1"># operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_oper</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">out_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy_oper</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">out_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_wghts</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy_wghts</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_x</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span><span class="n">paddings</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_y</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span><span class="n">paddings</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jz_t</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">pezx</span><span class="p">,</span> <span class="n">pezy</span><span class="p">,</span> <span class="n">phxy</span><span class="p">,</span> <span class="n">phyx</span><span class="p">,</span>
                  <span class="n">ceze</span><span class="p">,</span> <span class="n">cezh</span><span class="p">,</span> <span class="n">chxh</span><span class="p">,</span> <span class="n">chxe</span><span class="p">,</span> <span class="n">chyh</span><span class="p">,</span> <span class="n">chye</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;One-step forward propagation</span>

<span class="sd">        Args:</span>
<span class="sd">            jz_t (Tensor): Source at time t + 0.5 * dt.</span>
<span class="sd">            ez, hx, hy (Tensor): Ez, Hx, Hy fields.</span>
<span class="sd">            pezx, pezy, phxy, phyx (Tensor): CPML auxiliary fields.</span>
<span class="sd">            ceze, cezh (Tensor): Updating coefficients for Ez fields.</span>
<span class="sd">            chxh, chxe (Tensor): Updating coefficients for Hx fields.</span>
<span class="sd">            chyh, chye (Tensor): Updating coefficients for Hy fields.</span>

<span class="sd">        Returns:</span>
<span class="sd">            hidden_states (tuple)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># -------------------------------------------------</span>
        <span class="c1"># Step 1: Update H&#39;s at n+1/2 step</span>
        <span class="c1"># -------------------------------------------------</span>
        <span class="c1"># compute curl E</span>
        <span class="n">dezdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_oper</span><span class="p">(</span><span class="n">ez</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_wghts</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dezdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy_oper</span><span class="p">(</span><span class="n">ez</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy_wghts</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># update auxiliary fields</span>
        <span class="n">phyx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">phyx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dezdx</span>
        <span class="n">phxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">phxy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dezdy</span>

        <span class="c1"># update H</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="n">chxh</span> <span class="o">*</span> <span class="n">hx</span> <span class="o">-</span> <span class="n">chxe</span> <span class="o">*</span> <span class="p">(</span><span class="n">dezdy</span> <span class="o">+</span> <span class="n">phxy</span><span class="p">)</span>
        <span class="n">hy</span> <span class="o">=</span> <span class="n">chyh</span> <span class="o">*</span> <span class="n">hy</span> <span class="o">+</span> <span class="n">chye</span> <span class="o">*</span> <span class="p">(</span><span class="n">dezdx</span> <span class="o">+</span> <span class="n">phyx</span><span class="p">)</span>

        <span class="c1"># -------------------------------------------------</span>
        <span class="c1"># Step 2: Update E&#39;s at n+1 step</span>
        <span class="c1"># -------------------------------------------------</span>
        <span class="c1"># compute curl H</span>
        <span class="n">dhydx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx_oper</span><span class="p">(</span><span class="n">hy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx_wghts</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dhxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy_oper</span><span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy_wghts</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># update auxiliary fields</span>
        <span class="n">pezx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pezx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmlx_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dhydx</span>
        <span class="n">pezy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pezy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpmly_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dhxdy</span>

        <span class="c1"># update E</span>
        <span class="n">ez</span> <span class="o">=</span> <span class="n">ceze</span> <span class="o">*</span> <span class="n">ez</span> <span class="o">+</span> <span class="n">cezh</span> <span class="o">*</span> <span class="p">((</span><span class="n">dhydx</span> <span class="o">+</span> <span class="n">pezx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">dhxdy</span> <span class="o">+</span> <span class="n">pezy</span><span class="p">)</span> <span class="o">-</span> <span class="n">jz_t</span><span class="p">)</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="p">(</span><span class="n">ez</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">pezx</span><span class="p">,</span> <span class="n">pezy</span><span class="p">,</span> <span class="n">phxy</span><span class="p">,</span> <span class="n">phyx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hidden_states</span>
</pre></div>
</div>
<p>The device-to-device differentiable FDTD network is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ADFDTD</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2D TM-Mode Differentiable FDTD Network.</span>

<span class="sd">    Args:</span>
<span class="sd">        cell_numbers (tuple): Number of Yee cells in (x, y) directions.</span>
<span class="sd">        cell_lengths (tuple): Lengths of Yee cells.</span>
<span class="sd">        nt (int): Number of time steps.</span>
<span class="sd">        dt (float): Time interval.</span>
<span class="sd">        ns (int): Number of sources.</span>
<span class="sd">        designer (BaseTopologyDesigner): Customized Topology designer.</span>
<span class="sd">        cfs_pml (CFSParameters): CFS parameter class.</span>
<span class="sd">        init_weights (Tensor): Initial weights.</span>

<span class="sd">    Returns:</span>
<span class="sd">        outputs (Tensor): Customized outputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cell_numbers</span><span class="p">,</span>
                 <span class="n">cell_lengths</span><span class="p">,</span>
                 <span class="n">nt</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
                 <span class="n">ns</span><span class="p">,</span>
                 <span class="n">designer</span><span class="p">,</span>
                 <span class="n">cfs_pml</span><span class="p">,</span>
                 <span class="n">init_weights</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ADFDTD</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">cell_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">cell_numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">cell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">cell_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">designer</span> <span class="o">=</span> <span class="n">designer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfs_pml</span> <span class="o">=</span> <span class="n">cfs_pml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">init_weights</span><span class="p">)</span> <span class="k">if</span> <span class="n">init_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mur</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigm</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfs_pml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># CFS-PML Coefficients</span>
            <span class="n">cpmlx_e</span><span class="p">,</span> <span class="n">cpmlx_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfs_pml</span><span class="o">.</span><span class="n">get_update_coefficients</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">background_epsr</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
            <span class="n">cpmly_e</span><span class="p">,</span> <span class="n">cpmly_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfs_pml</span><span class="o">.</span><span class="n">get_update_coefficients</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">background_epsr</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>

            <span class="n">cpmlx_e</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">cpmlx_e</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">cpmlx_m</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">cpmlx_m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">cpmly_e</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">cpmly_e</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">cpmly_m</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">cpmly_m</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># PEC boundary</span>
            <span class="n">cpmlx_e</span> <span class="o">=</span> <span class="n">cpmlx_m</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">cpmly_e</span> <span class="o">=</span> <span class="n">cpmly_m</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># FDTD layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdtd_layer</span> <span class="o">=</span> <span class="n">FDTDLayer</span><span class="p">(</span>
            <span class="n">cell_lengths</span><span class="p">,</span> <span class="n">cpmlx_e</span><span class="p">,</span> <span class="n">cpmlx_m</span><span class="p">,</span> <span class="n">cpmly_e</span><span class="p">,</span> <span class="n">cpmly_m</span><span class="p">)</span>

        <span class="c1"># auxiliary variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dte</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="n">epsilon0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtm</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="n">mu0</span><span class="p">)</span>

        <span class="c1"># material parameters smoother</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_oper</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
            <span class="n">out_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveform_t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ADFDTD-based forward propagation.</span>

<span class="sd">        Args:</span>
<span class="sd">            waveform_t (Tensor, shape=(nt,)): Time-domain waveforms.</span>

<span class="sd">        Returns:</span>
<span class="sd">            outputs (Tensor): Customized outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Initialization</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># constants</span>
        <span class="n">ns</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

        <span class="c1"># material grid</span>
        <span class="n">epsr</span><span class="p">,</span> <span class="n">sige</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">generate_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>

        <span class="c1"># delectric smoothing</span>
        <span class="n">epsrz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_oper</span><span class="p">(</span><span class="n">epsr</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel</span><span class="p">)</span>
        <span class="n">sigez</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_oper</span><span class="p">(</span><span class="n">sige</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel</span><span class="p">)</span>

        <span class="c1"># set materials on the interfaces</span>
        <span class="p">(</span><span class="n">epsrz</span><span class="p">,</span> <span class="n">sigez</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">modify_object</span><span class="p">(</span><span class="n">epsrz</span><span class="p">,</span> <span class="n">sigez</span><span class="p">)</span>

        <span class="c1"># non-magnetic &amp; magnetically lossless material</span>
        <span class="n">murx</span> <span class="o">=</span> <span class="n">mury</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mur</span>
        <span class="n">sigmx</span> <span class="o">=</span> <span class="n">sigmy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigm</span>

        <span class="c1"># updating coefficients</span>
        <span class="n">ceze</span><span class="p">,</span> <span class="n">cezh</span> <span class="o">=</span> <span class="n">fcmpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte</span><span class="p">,</span> <span class="n">epsrz</span><span class="p">,</span> <span class="n">sigez</span><span class="p">)</span>
        <span class="n">chxh</span><span class="p">,</span> <span class="n">chxe</span> <span class="o">=</span> <span class="n">fcmpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="n">murx</span><span class="p">,</span> <span class="n">sigmx</span><span class="p">)</span>
        <span class="n">chyh</span><span class="p">,</span> <span class="n">chye</span> <span class="o">=</span> <span class="n">fcmpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtm</span><span class="p">,</span> <span class="n">mury</span><span class="p">,</span> <span class="n">sigmy</span><span class="p">)</span>

        <span class="c1"># hidden states</span>
        <span class="n">ez</span> <span class="o">=</span> <span class="n">create_zero_tensor</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="n">create_zero_tensor</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
        <span class="n">hy</span> <span class="o">=</span> <span class="n">create_zero_tensor</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># CFS-PML auxiliary fields</span>
        <span class="n">pezx</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">pezy</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">phxy</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
        <span class="n">phyx</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">hy</span><span class="p">)</span>

        <span class="c1"># set source location</span>
        <span class="n">jz_t</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">ez</span><span class="p">)</span>

        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Update</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">nt</span><span class="p">:</span>

            <span class="n">jz_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">update_sources</span><span class="p">(</span>
                <span class="p">(</span><span class="n">jz_t</span><span class="p">,),</span> <span class="p">(</span><span class="n">ez</span><span class="p">,),</span> <span class="n">waveform_t</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>

            <span class="c1"># RNN-Style Update</span>
            <span class="p">(</span><span class="n">ez</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">pezx</span><span class="p">,</span> <span class="n">pezy</span><span class="p">,</span> <span class="n">phxy</span><span class="p">,</span> <span class="n">phyx</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdtd_layer</span><span class="p">(</span>
                <span class="n">jz_t</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">pezx</span><span class="p">,</span> <span class="n">pezy</span><span class="p">,</span> <span class="n">phxy</span><span class="p">,</span> <span class="n">phyx</span><span class="p">,</span>
                <span class="n">ceze</span><span class="p">,</span> <span class="n">cezh</span><span class="p">,</span> <span class="n">chxh</span><span class="p">,</span> <span class="n">chxe</span><span class="p">,</span> <span class="n">chyh</span><span class="p">,</span> <span class="n">chye</span><span class="p">)</span>

            <span class="c1"># Compute outputs</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">designer</span><span class="o">.</span><span class="n">get_outputs_at_each_step</span><span class="p">((</span><span class="n">ez</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)))</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
</section>
<section id="model-training">
<h2>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>Define the differentiable FDTD network, loss function, optimizer, iteration steps and learning rate, then define the electromagnetic inverse scattering solver object <code class="docutils literal notranslate"><span class="pre">solver</span></code> and call the <code class="docutils literal notranslate"><span class="pre">solve</span></code> interface for solving.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define fdtd network</span>
<span class="n">fdtd_net</span> <span class="o">=</span> <span class="n">transverse_magnetic</span><span class="o">.</span><span class="n">ADFDTD</span><span class="p">(</span>
    <span class="n">cell_numbers</span><span class="p">,</span> <span class="n">cell_lengths</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span>
    <span class="n">inverse_domain</span><span class="p">,</span> <span class="n">cpml</span><span class="p">,</span> <span class="n">rho_init</span><span class="p">)</span>

<span class="c1"># define sovler for inverse problem</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">epochs</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">lr</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">fdtd_net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">EMInverseSolver</span><span class="p">(</span><span class="n">fdtd_net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

<span class="c1"># solve</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">waveform_t</span><span class="p">,</span> <span class="n">field_labels</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="evaluating-the-solution-results">
<h2>Evaluating the Solution Results<a class="headerlink" href="#evaluating-the-solution-results" title="Permalink to this headline"></a></h2>
<p>After the solution is finished, the <code class="docutils literal notranslate"><span class="pre">eval</span></code> interface is called to evaluate the <code class="docutils literal notranslate"><span class="pre">PSNR</span></code> and <code class="docutils literal notranslate"><span class="pre">SSIM</span></code> of the inversion results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">epsr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">epsr_labels</span><span class="p">)</span>
</pre></div>
</div>
<p>The relative permittivity of <code class="docutils literal notranslate"><span class="pre">PSNR</span></code> and <code class="docutils literal notranslate"><span class="pre">SSIM</span></code> obtained by inversion based on the above method are:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[epsr] PSNR: 27.835317 dB, SSIM: 0.963564
</pre></div>
</div>
<p>The relative permittivity distribution obtained by the inversion is shown in the figure below:</p>
<p><img alt="inversion result" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindelec/docs/source_zh_cn/images/AD_FDTD/fdtd_inverse/epsr_reconstructed.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="AD_FDTD_forward.html" class="btn btn-neutral float-left" title="S-parameter Simulation of Patch Antenna Based on Differentiable FDTD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="visualization.html" class="btn btn-neutral float-right" title="Visualizing Electromagnetic Simulation Results" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>