<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Electromagnetic Simulation based on Point Cloud Method &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script><script src="_static/jquery.js"></script>
        <script src="_static/js/theme.js"></script><script src="_static/underscore.js"></script><script src="_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Device-to-device differentiable FDTD method" href="AD_FDTD.html" />
    <link rel="prev" title="AI Electromagnetic Simulation based on Parameterization Method" href="parameterization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro_and_install.html">MindSpore Elec Introduction and Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="physics_driven.html">Physics Informed Deep Learning Method for Electromagnetic Simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="data_driven.html">Data Driven Deep Learning Method for Electromagnetic Simulation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="parameterization.html">AI Electromagnetic Simulation based on Parameterization Method</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">AI Electromagnetic Simulation based on Point Cloud Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overall-process">Overall Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-the-geometric/material-information-from-a-cst-file">Exporting the Geometric/Material Information from a CST File</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#generating-the-point-cloud-data">Generating the Point Cloud Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-compression">Data compression</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#optional-compressing-model-training">(Optional) Compressing Model Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compressing-the-data">Compressing the data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#electromagnetic-simulation">Electromagnetic Simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#full-electromagnetic-simulation">Full Electromagnetic Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#s-parameters-simulation">S-parameters Simulation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="AD_FDTD.html">Device-to-device differentiable FDTD method</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing Electromagnetic Simulation Results</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindelec.architecture.html">mindelec.architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.common.html">mindelec.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.data.html">mindelec.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.geometry.html">mindelec.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.loss.html">mindelec.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.operators.html">mindelec.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.solver.html">mindelec.solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.vision.html">mindelec.vision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="data_driven.html">Data Driven Deep Learning Method for Electromagnetic Simulation</a> &raquo;</li>
      <li>AI Electromagnetic Simulation based on Point Cloud Method</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/point_cloud.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="ai-electromagnetic-simulation-based-on-point-cloud-method">
<h1>AI Electromagnetic Simulation based on Point Cloud Method<a class="headerlink" href="#ai-electromagnetic-simulation-based-on-point-cloud-method" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindelec/docs/source_en/point_cloud.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a>  </p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This tutorial describes the deep learning electromagnetic simulation method based on point cloud data, helping you quickly use MindSpore Elec.</p>
<p>Conventional electromagnetic simulation usually uses finite element or finite-difference methods to compute electromagnetic fields. These methods require complex mesh division and iterative computation, which is time-consuming and affects product R&amp;D efficiency. MindSpore Elec provides a new end-to-end electromagnetic field AI computation method. This method directly computes the electromagnetic field in the simulation area based on point cloud data without mesh division and iterative solution, greatly accelerating the overall simulation speed and facilitating efficient product R&amp;D.</p>
<blockquote>
<div><p>This current sample is for Ascend 910 AI processor. You can find the complete executable code at
<a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/master/MindElec/examples/data_driven/pointcloud">https://gitee.com/mindspore/mindscience/tree/master/MindElec/examples/data_driven/pointcloud</a></p>
</div></blockquote>
</section>
<section id="overall-process">
<h2>Overall Process<a class="headerlink" href="#overall-process" title="Permalink to this headline"></a></h2>
<p>The overall process of electromagnetic simulation based on point cloud data is as follows:</p>
<ol class="arabic simple">
<li><p>Export the geometric/material information from a CST file.</p></li>
<li><p>Generate the point cloud data.</p></li>
<li><p>Compress the data.</p></li>
<li><p>Electromagnetic simulation.</p></li>
</ol>
</section>
<section id="exporting-the-geometric/material-information-from-a-cst-file">
<h2>Exporting the Geometric/Material Information from a CST File<a class="headerlink" href="#exporting-the-geometric/material-information-from-a-cst-file" title="Permalink to this headline"></a></h2>
<p>MindSpore Elec provides two types of automatic execution scripts for converting CST files into STP files that can be read by Python. The scripts can be used to convert data in batches to implement large-scale electromagnetic simulation.</p>
<ul class="simple">
<li><p><strong>The CST VBA API automatically calls and exports the JSON and STP files</strong>: Open the VBA Macros Editor of the CST software, import the <code class="docutils literal notranslate"><span class="pre">export_stp.bas</span></code> file in the <code class="docutils literal notranslate"><span class="pre">generate_pointcloud</span></code> directory, change the paths of the JSON and STP files to the desired ones, and click <code class="docutils literal notranslate"><span class="pre">Run</span></code> to export the JSON and STP files. The JSON file contains the model port location and the material information corresponding to the STP file.</p></li>
<li><p><strong>For CST 2019 or later, you can use Python to directly call CST</strong>: Directly call the <code class="docutils literal notranslate"><span class="pre">export_stp.py</span></code> file in the <code class="docutils literal notranslate"><span class="pre">generate_pointcloud</span></code> directory.</p></li>
</ul>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>export_stp.py<span class="w"> </span>--cst_path<span class="w"> </span>CST_PATH
<span class="w">                     </span>--stp_path<span class="w"> </span>STP_PATH
<span class="w">                     </span>--json_path<span class="w"> </span>JSON_PATH
</pre></div>
</div>
<p>In the preceding command, <code class="docutils literal notranslate"><span class="pre">cst_path</span></code> specifies the path of the CST file to be exported as the STP file, and <code class="docutils literal notranslate"><span class="pre">stp_path</span></code> and <code class="docutils literal notranslate"><span class="pre">json_path</span></code> specify the paths for storing the exported STP and JSON files, respectively.</p>
</section>
</section>
<section id="generating-the-point-cloud-data">
<h2>Generating the Point Cloud Data<a class="headerlink" href="#generating-the-point-cloud-data" title="Permalink to this headline"></a></h2>
<p>The STP file cannot be directly used as the input of the neural network. It needs to be converted into regular tensor data. MindSpore Elec provides an API for efficiently converting the STP file into the point cloud tensor data. The <code class="docutils literal notranslate"><span class="pre">generate_cloud_point.py</span></code> file in the <code class="docutils literal notranslate"><span class="pre">generate_pointcloud</span></code> directory provides the API calling example.</p>
<p>When using this module, <code class="docutils literal notranslate"><span class="pre">stp_path</span></code> and <code class="docutils literal notranslate"><span class="pre">json_path</span></code> can be configured to specify the paths of the STP and JSON files used to generate the point cloud. <code class="docutils literal notranslate"><span class="pre">material_dir</span></code> specifies the path of the material information corresponding to the STP. The material information is directly exported from the CST software. <code class="docutils literal notranslate"><span class="pre">sample_nums</span></code> specifies the number of point cloud data records generated from the x, y, and z dimensions. <code class="docutils literal notranslate"><span class="pre">bbox_args</span></code> specifies the region where the point cloud data is generated, that is, (x_min, y_min, z_min, x_max, y_max, z_max).</p>
<p>The following is an example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>generate_cloud_point.py<span class="w"> </span>--stp_path<span class="w"> </span>STP_PATH
<span class="w">                               </span>--json_path<span class="w"> </span>JSON_PATH
<span class="w">                               </span>--material_dir<span class="w"> </span>MATERIAL_DIR
<span class="w">                               </span>--sample_nums<span class="w"> </span><span class="o">(</span><span class="m">500</span>,<span class="w"> </span><span class="m">2000</span>,<span class="w"> </span><span class="m">80</span><span class="o">)</span>
<span class="w">                               </span>--bbox_args<span class="w"> </span><span class="o">(</span>-40.,<span class="w"> </span>-80.,<span class="w"> </span>-5.,<span class="w"> </span><span class="m">40</span>.,<span class="w"> </span><span class="m">80</span>.,<span class="w"> </span><span class="m">5</span>.<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="data-compression">
<h2>Data compression<a class="headerlink" href="#data-compression" title="Permalink to this headline"></a></h2>
<p>If the point cloud resolution is set to a high value, the memory and computing consumption for subsequent processing of a single piece of point cloud data may be too high. Therefore, MindSpore Elec provides the data compression function. You can call the script in the <code class="docutils literal notranslate"><span class="pre">data_compression</span></code> directory to compress the original point cloud data, reducing the memory and computing consumption of subsequent processes. The compression process is divided into the following two steps:</p>
<ul class="simple">
<li><p>If you use the model for the first time, call <code class="docutils literal notranslate"><span class="pre">train.py</span></code> to train a compressing model. If compressing model checkpoints exist, skip this step.</p></li>
<li><p>After model training is complete, call <code class="docutils literal notranslate"><span class="pre">data_compress.py</span></code> to compress data.</p></li>
</ul>
<section id="optional-compressing-model-training">
<h3>(Optional) Compressing Model Training<a class="headerlink" href="#optional-compressing-model-training" title="Permalink to this headline"></a></h3>
<section id="preparing-the-training-data">
<h4>Preparing the Training Data<a class="headerlink" href="#preparing-the-training-data" title="Permalink to this headline"></a></h4>
<p>The training data used by the compressing model is the blocks of point cloud data. After the point cloud data is generated, the generate_data function in <code class="docutils literal notranslate"><span class="pre">data_compression/src/dataset.py</span></code> can be called to generate the data required for training and inference. The block size and data input and output paths are configured using the following parameters in the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PATCH_DIM</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span>
<span class="n">NUM_SAMPLE</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">INPUT_PATH</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">DATA_CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;./data_config.npy&quot;</span>
<span class="n">SAVE_DATA_PATH</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>
</pre></div>
</div>
<p>During the preparation and generation of training data, data is normalized. To ensure the validity of the model, the same normalization parameters need to be used during inference and compression. These parameters are saved in the <code class="docutils literal notranslate"><span class="pre">data_config.npy</span></code> file.</p>
</section>
<section id="building-a-compressing-model">
<h4>Building a compressing model<a class="headerlink" href="#building-a-compressing-model" title="Permalink to this headline"></a></h4>
<p>Build a compressing model by referring to <code class="docutils literal notranslate"><span class="pre">data_compression/src/model.py</span></code>. The model is trained in self-supervised learning mode. The model consists of an encoder and a decoder. During the training, the network needs to rebuild data (<code class="docutils literal notranslate"><span class="pre">decoding=True</span></code>). When the compressed data is inferred, the decompressor is omitted (<code class="docutils literal notranslate"><span class="pre">decoding=False</span></code>).</p>
<p>For different data block sizes, you need to modify some code of the encoder accordingly to ensure that the output space size of the encoder is <code class="docutils literal notranslate"><span class="pre">[1,1,1]</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EncoderDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">base_channels</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">decoding</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderDecoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoding</span> <span class="o">=</span> <span class="n">decoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">base_channels</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">base_channels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoding</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="model-training">
<h4>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h4>
<p>During compressing model training, initialize <code class="docutils literal notranslate"><span class="pre">EncoderDecoder</span></code> based on parameters defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, such as the number of input features, data block size, and number of basic features.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_net</span> <span class="o">=</span> <span class="n">EncoderDecoder</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_channels&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;patch_shape&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_channels&quot;</span><span class="p">],</span> <span class="n">ecoding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, call the MindSpore Elec data API to read a dataset. This API can automatically shuffle data and batch data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">input_path</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">train_input_path</span><span class="p">,</span>
                               <span class="n">label_path</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">train_input_path</span><span class="p">,</span>
                               <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
                               <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eval_dataset</span> <span class="o">...</span>
</pre></div>
</div>
<p>In order to improve model precision, set the learning rate decay policy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">milestones</span><span class="p">,</span> <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">step_lr_generator</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span>
                                               <span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span>
                                               <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
                                               <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lr_decay_milestones&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Then, call the training API <code class="docutils literal notranslate"><span class="pre">Solver</span></code> of MindSpore Elec to set training parameters, including the optimizer, metrics, and loss function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">train_input_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;train_input_data&#39;</span><span class="p">]},</span>
                <span class="n">test_input_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_input_data&#39;</span><span class="p">]},</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;evl_mrc&#39;</span><span class="p">:</span> <span class="n">evl_error_mrc</span><span class="p">,},</span>
                <span class="n">amp_level</span><span class="o">=</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_net</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, use <code class="docutils literal notranslate"><span class="pre">Solver.model.train</span></code> and <code class="docutils literal notranslate"><span class="pre">Solver.model.eval</span></code> to train and test the compressing model and periodically store the checkpoints of the compressing model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;eval_interval&quot;</span><span class="p">]):</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;eval_interval&quot;</span><span class="p">],</span>
                        <span class="n">train_dataset</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">()],</span>
                        <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res_test</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">error_mean_l1_error</span> <span class="o">=</span> <span class="n">res_test</span><span class="p">[</span><span class="s1">&#39;evl_mrc&#39;</span><span class="p">][</span><span class="s1">&#39;mean_l1_error&#39;</span><span class="p">]</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s1">&#39;model_last.ckpt&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="compressing-the-data">
<h3>Compressing the data<a class="headerlink" href="#compressing-the-data" title="Permalink to this headline"></a></h3>
<p>During data compression, you need to set the original point cloud path and the model checkpoint file, define the compressing model based on parameters defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, and import the model checkpoint.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">EncoderDecoder</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_channels&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;patch_shape&quot;</span><span class="p">],</span> <span class="n">decoding</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
</pre></div>
</div>
<p>The data compression script automatically divides the cloud data into data blocks that adapt to the compressing model and uses <code class="docutils literal notranslate"><span class="pre">data_config.npy</span></code> generated during training data preparation to normalize the data. After the division is complete, MindSpore inference is automatically called to compress the data. After the compression, the data block encoding result is rearranged based on the original block space position to obtain the final compression result.</p>
</section>
</section>
<section id="electromagnetic-simulation">
<h2>Electromagnetic Simulation<a class="headerlink" href="#electromagnetic-simulation" title="Permalink to this headline"></a></h2>
<p>After the point cloud data is prepared, the electromagnetic simulation models in the <code class="docutils literal notranslate"><span class="pre">full_em</span></code> and <code class="docutils literal notranslate"><span class="pre">S_parameter</span></code> directory of MindSpore Elec can be called to implement full electromagnetic and S-parameters simulation. Each simulation process can be divided into two steps:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">train.py</span></code> to train the simulation model.</p></li>
<li><p>After the model training is completed, use <code class="docutils literal notranslate"><span class="pre">eval.py</span></code> to compute the full electromagnetic or S-parameters simulation.</p></li>
</ul>
<section id="full-electromagnetic-simulation">
<h3>Full Electromagnetic Simulation<a class="headerlink" href="#full-electromagnetic-simulation" title="Permalink to this headline"></a></h3>
<section id="building-a-full-electromagnetic-simulation-model">
<h4>Building a Full Electromagnetic Simulation Model<a class="headerlink" href="#building-a-full-electromagnetic-simulation-model" title="Permalink to this headline"></a></h4>
<p>First, build an electromagnetic simulation model by referring to <code class="docutils literal notranslate"><span class="pre">full_em/src/maxwell_model.py</span></code>, and train the model in supervised learning mode. The model is divided into two parts: feature extraction and electromagnetic field computation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Maxwell3D</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;maxwell3d&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Maxwell3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">output_dim</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net0</span> <span class="o">=</span> <span class="n">ModelHead</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net1</span> <span class="o">=</span> <span class="n">ModelHead</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net2</span> <span class="o">=</span> <span class="n">ModelHead</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net3</span> <span class="o">=</span> <span class="n">ModelHead</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net4</span> <span class="o">=</span> <span class="n">ModelHead</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">width</span><span class="o">+</span><span class="mi">33</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">ModelOut</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;forward&quot;&quot;&quot;</span>
        <span class="n">x_location</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">x_media</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net0</span><span class="p">(</span><span class="n">x_location</span><span class="p">)</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net1</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x_location</span><span class="p">)</span>
        <span class="n">out3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net2</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">x_location</span><span class="p">)</span>
        <span class="n">out4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net3</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">x_location</span><span class="p">)</span>
        <span class="n">out5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net4</span><span class="p">(</span><span class="mf">16.0</span><span class="o">*</span><span class="n">x_location</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span> <span class="o">+</span> <span class="n">out4</span> <span class="o">+</span> <span class="n">out5</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">out</span><span class="p">,</span> <span class="n">x_media</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc0</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">ModelHead</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="model-training-1">
<h4>Model Training<a class="headerlink" href="#model-training-1" title="Permalink to this headline"></a></h4>
<p>During the training process of the electromagnetic simulation model, the prediction model is initialized using <code class="docutils literal notranslate"><span class="pre">Maxwell3D</span></code>. The network output is six dimensions, as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_net</span> <span class="o">=</span> <span class="n">Maxwell3D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, call the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function in <code class="docutils literal notranslate"><span class="pre">src/dataset</span></code> to load dataset. This function is implemented using the dataset utilities of MindSpore Elec and can automatically shuffle data and batch data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Set the learning rate decay policy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">get_lr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, call the training API <code class="docutils literal notranslate"><span class="pre">Solver</span></code> of MindSpore Elec to set training parameters, including the optimizer, metrics, and loss function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">,</span>
                <span class="n">amp_level</span><span class="o">=</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span>
                <span class="n">keep_batchnorm_fp32</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_net</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, use <code class="docutils literal notranslate"><span class="pre">Solver.model.train</span></code> and <code class="docutils literal notranslate"><span class="pre">Solver.model.eval</span></code> to train and test the model and periodically save the model checkpoint files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ckpt_config</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;save_checkpoint_epochs&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">step_size</span><span class="p">,</span>
                               <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keep_checkpoint_max&quot;</span><span class="p">])</span>
<span class="n">ckpt_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Maxwell3d&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">ckpt_config</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">(),</span> <span class="n">ckpt_cb</span><span class="p">],</span>
                   <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="model-inference">
<h4>Model Inference<a class="headerlink" href="#model-inference" title="Permalink to this headline"></a></h4>
<p>Set the path of the inference input data and model checkpoint file, define the model based on parameters defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, and import the model checkpoint.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_net</span> <span class="o">=</span> <span class="n">Maxwell3D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_path</span><span class="p">)</span>
</pre></div>
</div>
<p>The MindSpore Elec inference API can be called to implement automatic inference.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_net</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;evl_mrc&quot;</span><span class="p">:</span> <span class="n">evl_error_mrc</span><span class="p">})</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">l2_s11</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;evl_mrc&#39;</span><span class="p">][</span><span class="s1">&#39;l2_error&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_res:&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;l2_error: </span><span class="si">{</span><span class="n">l2_s11</span><span class="si">:</span><span class="s1">.10f</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Take the electromagnetic simulation of a mobile phone as an example. The following figure shows the electromagnetic field distribution and changes computed through this process.</p>
<p><img alt="result_ex" src="_images/result_e.gif" /></p>
</section>
</section>
<section id="s-parameters-simulation">
<h3>S-parameters Simulation<a class="headerlink" href="#s-parameters-simulation" title="Permalink to this headline"></a></h3>
<section id="building-a-s-parameters-simulation-model">
<h4>Building a S-parameters Simulation Model<a class="headerlink" href="#building-a-s-parameters-simulation-model" title="Permalink to this headline"></a></h4>
<p>First, build S-parameters simulation model by referring to <code class="docutils literal notranslate"><span class="pre">S_parameter/src/model.py</span></code>, and the model is also trained through supervised learning, which is divided into two parts: feature extraction and S-parameter calculation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S11Predictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;S11Predictor architecture for MindSpore Elec&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">S11Predictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv3d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down2</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down3</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_1_1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_1_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1536</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concat</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;forward&quot;&quot;&quot;</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_1_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_1_2</span><span class="p">(</span><span class="n">x_1</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">x_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_2</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</section>
<section id="model-training-2">
<h4>Model Training<a class="headerlink" href="#model-training-2" title="Permalink to this headline"></a></h4>
<p>During the training process of the S-parameters simulation model, the prediction model is initialized using <code class="docutils literal notranslate"><span class="pre">S11Predictor</span></code>. The network input tensor channel dimension is configured in <code class="docutils literal notranslate"><span class="pre">Config.py</span></code>, as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_net</span> <span class="o">=</span> <span class="n">S11Predictor</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_channels&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Then, call the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function in <code class="docutils literal notranslate"><span class="pre">src/dataset</span></code> to load dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">label_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Set the learning rate decay policy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">milestones</span><span class="p">,</span> <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">step_lr_generator</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">lr_decay_milestones</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, call the training API <code class="docutils literal notranslate"><span class="pre">Solver</span></code> of MindSpore Elec to set training parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">train_input_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;train_input_data&#39;</span><span class="p">]},</span>
                <span class="n">test_input_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_input_data&#39;</span><span class="p">]},</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">amp_level</span><span class="o">=</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_net</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, use <code class="docutils literal notranslate"><span class="pre">Solver.model.train</span></code> to train the model, and save the model checkpoint files after the training is completed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span>
                   <span class="n">train_dataset</span><span class="p">,</span>
                   <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">()],</span>
                   <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s1">&#39;model_best.ckpt&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="model-inference-1">
<h4>Model Inference<a class="headerlink" href="#model-inference-1" title="Permalink to this headline"></a></h4>
<p>Define the model based on parameters defined in <code class="docutils literal notranslate"><span class="pre">config.py</span></code> and import the model checkpoint file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_net</span> <span class="o">=</span> <span class="n">S11Predictor</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;input_channels&quot;</span><span class="p">])</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model_net</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">solver.model.eval</span></code> function to perform inference.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model_net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">),</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;eval_mrc&#39;</span><span class="p">:</span> <span class="n">eval_error_mrc</span><span class="p">},</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">())</span>

<span class="n">res_eval</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">valid_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">loss_mse</span><span class="p">,</span> <span class="n">l2_s11</span> <span class="o">=</span> <span class="n">res_eval</span><span class="p">[</span><span class="s2">&quot;eval_mrc&quot;</span><span class="p">][</span><span class="s2">&quot;loss_error&quot;</span><span class="p">],</span> <span class="n">res_eval</span><span class="p">[</span><span class="s2">&quot;eval_mrc&quot;</span><span class="p">][</span><span class="s2">&quot;l2_error&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss_mse: &#39;</span><span class="p">,</span> <span class="n">loss_mse</span><span class="p">,</span> <span class="s1">&#39; L2_S11: &#39;</span><span class="p">,</span> <span class="n">l2_s11</span><span class="p">)</span>
</pre></div>
</div>
<p>Take the mobile phone S-parameters as an example, the following figure shows S-parameters calculated through this process.</p>
<p><img alt="result_ex" src="_images/S11.JPG" /></p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parameterization.html" class="btn btn-neutral float-left" title="AI Electromagnetic Simulation based on Parameterization Method" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="AD_FDTD.html" class="btn btn-neutral float-right" title="Device-to-device differentiable FDTD method" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>