<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Electromagnetic Simulation based on Parameterization Method &mdash; MindSpore master documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="AI Electromagnetic Simulation based on Point Cloud Method" href="point_cloud.html" />
    <link rel="prev" title="Data Driven Deep Learning Method for Electromagnetic Simulation" href="data_driven.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro_and_install.html">MindElec Introduction and Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="physics_driven.html">Physics Informed Deep Learning Method for Electromagnetic Simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="data_driven.html">Data Driven Deep Learning Method for Electromagnetic Simulation</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">AI Electromagnetic Simulation based on Parameterization Method</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#target-scenario">Target Scenario</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bowtie-antenna">Bowtie Antenna</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dataset">Dataset</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#parameterized-electromagnetic-simulation">Parameterized Electromagnetic Simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dataset-loading">Dataset Loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-building">Model Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-training">Model Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-testing">Model Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#result-visualization">Result Visualization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="point_cloud.html">AI Electromagnetic Simulation based on Point Cloud Method</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing Electromagnetic Simulation Results</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindelec.architecture.html">mindelec.architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.common.html">mindelec.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.data.html">mindelec.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.geometry.html">mindelec.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.loss.html">mindelec.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.operators.html">mindelec.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.solver.html">mindelec.solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindelec.vision.html">mindelec.vision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="data_driven.html">Data Driven Deep Learning Method for Electromagnetic Simulation</a> &raquo;</li>
      <li>AI Electromagnetic Simulation based on Parameterization Method</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/parameterization.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="ai-electromagnetic-simulation-based-on-parameterization-method">
<h1>AI Electromagnetic Simulation based on Parameterization Method<a class="headerlink" href="#ai-electromagnetic-simulation-based-on-parameterization-method" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r2.0.0-alpha/docs/mindelec/docs/source_en/parameterization.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_source_en.png"></a>  </p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Electromagnetic simulation is widely used in the product design process of antennas, chips, and mobile phones to obtain the transmission characteristics (such as scattering parameters and electromagnetic fields) of the target to be simulated. The scattering parameters (S-parameters) are network parameters based on the input wave and the reflected wave. It is used to analyze a microwave circuit and describe a circuit network based on the strength of a reflected signal of a component port and the strength of a signal transmitted from a port to another port.</p>
<p>At present, products such as antennas and mobile phones are usually simulated using commercial simulation software (such as CST and HFS) to obtain results such as the S-parameters. Currently, commercial software simulation mainly uses numerical algorithms (such as FDTD) to compute S-parameters. The simulation process mainly includes two steps: semi-automatic/automatic mesh division and numerical solution of the Maxwell equations. The two steps are time-consuming and computing-consuming.</p>
<p>MindElec use AI model to directly obtain the S-parameters of the target to be simulated without the iterative calculation of traditional numerical methods, and this can greatly save simulation time. MindElec provides two data-driven electromagnetic simulation solutions: parameterization solution and point cloud solution. The two solutions have the following characteristics:</p>
<ul class="simple">
<li><p>The parameterization solution directly maps parameters to simulation results. For example, the antenna width and angle are used as the network input, and the network output are the S-parameters. The direct mapping and simple network are the advantage of the parameterization solution.</p></li>
<li><p>The point cloud solution implements the mapping from the sampling point cloud of the antenna/phone to the simulation result. In this solution, the structure file of the mobile phone is converted into the point cloud tensor data, and the convolutional neural network is used to extract the structure features. Then, the final simulation result (S-parameters) are obtained through the mapping of multiple full-connected layers. The advantage of this solution is that it is applicable to complex working conditions where the number or types of structural parameters may change.</p></li>
</ul>
<blockquote>
<div><p>This current sample is for Ascend 910 AI processor. You can find the complete executable code at
<a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/r0.2.0-alpha/MindElec/examples/data_driven/parameterization">https://gitee.com/mindspore/mindscience/tree/r0.2.0-alpha/MindElec/examples/data_driven/parameterization</a></p>
</div></blockquote>
</section>
<section id="target-scenario">
<h2>Target Scenario<a class="headerlink" href="#target-scenario" title="Permalink to this headline"></a></h2>
<p>In this tutorial, we use the parametric simulation method in the bowtie antenna scenario.</p>
<section id="bowtie-antenna">
<h3>Bowtie Antenna<a class="headerlink" href="#bowtie-antenna" title="Permalink to this headline"></a></h3>
<p>The following figure shows the structure of a bowtie antenna.</p>
<p><img alt="bow" src="_images/bow.jpg" /></p>
<p>The PEC metal plate is placed on a PCB cuboid with a certain thickness, presenting a left-right symmetrical butterfly shape. There is a gap between the two metal plates that are not completely in contact, and the excitation source (port) is located in the gap. Electromagnetic simulation is to add an excitation source to compute the electromagnetic field in the area and obtain the S-parameters (S11 is used in this tutorial because there is only one port).</p>
<p>During antenna design, the structure of the simulation object needs to be adjusted and optimized based on the simulation result. This tutorial also considers the generalization of the bowtie antenna structure. In this tutorial, the structural parameters changed by the bowtie antenna are the length (x) and height of the PEC plate, and thickness (z) of the PCB plate. The length ranges from 0 mm to 40 mm, the height ranges from 4 mm to 24 mm, and the thickness ranges from 2 mm to 18 mm.</p>
<p>In this tutorial, we will build the mapping of these structural parameters to S11 with MindElec, so that S11 can be quickly calculated based on the parameters of new structures.</p>
</section>
<section id="dataset">
<h3>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline"></a></h3>
<p>There are 495 pairs of parameter-S11 samples. The training set and testing set are randomly divided based on 9:1. The following shows some antenna and S11 sample pairs.</p>
<p><img alt="bow_s11" src="_images/bow_s11.jpg" /></p>
<p>The data have been provided as .npy files, which can be downloaded from the following address:</p>
<p><a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/r0.2.0-alpha/MindElec/examples/data_driven/parameterization/dataset">https://gitee.com/mindspore/mindscience/tree/r0.2.0-alpha/MindElec/examples/data_driven/parameterization/dataset</a></p>
</section>
</section>
<section id="parameterized-electromagnetic-simulation">
<h2>Parameterized Electromagnetic Simulation<a class="headerlink" href="#parameterized-electromagnetic-simulation" title="Permalink to this headline"></a></h2>
<p>The parameterized electromagnetic simulation consists of the following five steps:</p>
<ol class="arabic simple">
<li><p>Dataset Loading.</p></li>
<li><p>Model Building.</p></li>
<li><p>Model Training.</p></li>
<li><p>Model Testing.</p></li>
<li><p>Result Visualization.</p></li>
</ol>
<section id="dataset-loading">
<h3>Dataset Loading<a class="headerlink" href="#dataset-loading" title="Permalink to this headline"></a></h3>
<p>Use the MindElec dataset module to load the dataset of bowtie antennas. Currently, the parameterization solution supports local dataset training. You can use the <code class="docutils literal notranslate"><span class="pre">ExistedDataConfig</span></code> API to configure the dataset options. You need to specify the paths and types of the input and the S11 label dataset file.
Use the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> API to generate a dataset instance, and use the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function to build a data generator <code class="docutils literal notranslate"><span class="pre">dataloader</span></code> for model training and testing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_input_path</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">input_path</span>
    <span class="n">data_label_path</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">label_path</span>

    <span class="n">data_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">)</span>
    <span class="n">data_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_label_path</span><span class="p">)</span>

    <span class="n">frequency</span> <span class="o">=</span> <span class="n">data_label</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">data_label</span> <span class="o">=</span> <span class="n">data_label</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">data_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_label</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data load finish&quot;</span><span class="p">)</span>

    <span class="n">data_input</span> <span class="o">=</span> <span class="n">custom_normalize</span><span class="p">(</span><span class="n">data_input</span><span class="p">)</span>

    <span class="n">config_data_prepare</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">config_data_prepare</span><span class="p">[</span><span class="s2">&quot;scale_input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_input</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">config_data_prepare</span><span class="p">[</span><span class="s2">&quot;scale_S11&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_label</span><span class="p">))</span>

    <span class="n">data_input</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data_input</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">config_data_prepare</span><span class="p">[</span><span class="s2">&quot;scale_input&quot;</span><span class="p">]</span>
    <span class="n">data_label</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data_label</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">config_data_prepare</span><span class="p">[</span><span class="s2">&quot;scale_S11&quot;</span><span class="p">]</span>

    <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">data_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_input</span> <span class="o">=</span> <span class="n">data_input</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span>
    <span class="n">data_label</span> <span class="o">=</span> <span class="n">data_label</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">data_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">10</span>
    <span class="n">train_input</span><span class="p">,</span> <span class="n">train_label</span> <span class="o">=</span> <span class="n">data_input</span><span class="p">[</span><span class="n">length</span><span class="p">:],</span> <span class="n">data_label</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>
    <span class="n">eval_input</span><span class="p">,</span> <span class="n">eval_label</span> <span class="o">=</span> <span class="n">data_input</span><span class="p">[:</span><span class="n">length</span><span class="p">],</span> <span class="n">data_label</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">train_input</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">train_label</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">eval_input</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">eval_label</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;./data_prepare&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;./data_prepare&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;./data_prepare&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;./data_prepare&#39;</span><span class="p">)</span>

    <span class="n">train_input</span> <span class="o">=</span> <span class="n">train_input</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;./data_prepare/train_input&#39;</span><span class="p">,</span> <span class="n">train_input</span><span class="p">)</span>
    <span class="n">train_label</span> <span class="o">=</span> <span class="n">train_label</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;./data_prepare/train_label&#39;</span><span class="p">,</span> <span class="n">train_label</span><span class="p">)</span>
    <span class="n">eval_input</span> <span class="o">=</span> <span class="n">eval_input</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;./data_prepare/eval_input&#39;</span><span class="p">,</span> <span class="n">eval_input</span><span class="p">)</span>
    <span class="n">eval_label</span> <span class="o">=</span> <span class="n">eval_label</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;./data_prepare/eval_label&#39;</span><span class="p">,</span> <span class="n">eval_label</span><span class="p">)</span>

    <span class="n">electromagnetic_train</span> <span class="o">=</span> <span class="n">ExistedDataConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;electromagnetic_train&quot;</span><span class="p">,</span>
                                              <span class="n">data_dir</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;./data_prepare/train_input.npy&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;./data_prepare/train_label.npy&#39;</span><span class="p">],</span>
                                              <span class="n">columns_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
                                              <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;npy&quot;</span><span class="p">)</span>
    <span class="n">electromagnetic_eval</span> <span class="o">=</span> <span class="n">ExistedDataConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;electromagnetic_eval&quot;</span><span class="p">,</span>
                                             <span class="n">data_dir</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;./data_prepare/eval_input.npy&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;./data_prepare/eval_label.npy&#39;</span><span class="p">],</span>
                                             <span class="n">columns_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span>
                                             <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;npy&quot;</span><span class="p">)</span>
    <span class="n">train_batch_size</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="n">eval_batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_input</span><span class="p">)</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">existed_data_list</span><span class="o">=</span><span class="p">[</span><span class="n">electromagnetic_train</span><span class="p">])</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">existed_data_list</span><span class="o">=</span><span class="p">[</span><span class="n">electromagnetic_eval</span><span class="p">])</span>
    <span class="n">eval_loader</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">eval_batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_loader&quot;</span><span class="p">:</span> <span class="n">train_loader</span><span class="p">,</span>
        <span class="s2">&quot;eval_loader&quot;</span><span class="p">:</span> <span class="n">eval_loader</span><span class="p">,</span>

        <span class="s2">&quot;train_data&quot;</span><span class="p">:</span> <span class="n">train_input</span><span class="p">,</span>
        <span class="s2">&quot;train_label&quot;</span><span class="p">:</span> <span class="n">train_label</span><span class="p">,</span>
        <span class="s2">&quot;eval_data&quot;</span><span class="p">:</span> <span class="n">eval_input</span><span class="p">,</span>
        <span class="s2">&quot;eval_label&quot;</span><span class="p">:</span> <span class="n">eval_label</span><span class="p">,</span>

        <span class="s2">&quot;train_data_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_label</span><span class="p">),</span>
        <span class="s2">&quot;eval_data_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_label</span><span class="p">),</span>
        <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">config_data_prepare</span>
</pre></div>
</div>
</section>
<section id="model-building">
<h3>Model Building<a class="headerlink" href="#model-building" title="Permalink to this headline"></a></h3>
<p>The S11Predictor model is used as an example. This model is built using the MindSpore APIs, such as <code class="docutils literal notranslate"><span class="pre">nn.Dense</span></code> and <code class="docutils literal notranslate"><span class="pre">nn.Relu</span></code>. You can also build your own models.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">S11Predictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dimension</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">S11Predictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dimension</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc5</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc4</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span><span class="p">))</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc5</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span><span class="p">))</span>
        <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span> <span class="o">+</span> <span class="n">x6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</section>
<section id="model-training">
<h3>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h3>
<p>After the model is built, you can use the data generator <code class="docutils literal notranslate"><span class="pre">dataloader</span></code> defined in the preceding step to load data.</p>
<p>MindElec provides the Solver class for model training and testing. The input of the Solver class includes the optimizer, network, pattern, and loss function. In this tutorial, data-based supervised learning is used. Therefore, the mode is set to <code class="docutils literal notranslate"><span class="pre">Data</span></code>, and the network is trained using the mixed precision mode <code class="docutils literal notranslate"><span class="pre">solver.model.train</span></code>.</p>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">EvalMetric</span></code> defines the evaluation mode and metrics of the validation set in the training process. This method uses the <code class="docutils literal notranslate"><span class="pre">metric</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">Solver</span></code> to join the training, so that the metric changes can be monitored in real time during the training.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">milestones</span><span class="p">,</span> <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">get_lr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">optim</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model_net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">piecewise_constant_lr</span><span class="p">(</span><span class="n">milestones</span><span class="p">,</span> <span class="n">learning_rates</span><span class="p">))</span>

<span class="n">eval_error_mrc</span> <span class="o">=</span> <span class="n">EvalMetric</span><span class="p">(</span><span class="n">scale_s11</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;scale_S11&quot;</span><span class="p">],</span>
                            <span class="n">length</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eval_data_length&quot;</span><span class="p">],</span>
                            <span class="n">frequency</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span>
                            <span class="n">show_pic_number</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;./eval_res&#39;</span><span class="p">)</span>

<span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optim</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;eval_mrc&#39;</span><span class="p">:</span> <span class="n">eval_error_mrc</span><span class="p">},</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">())</span>

<span class="n">monitor_train</span> <span class="o">=</span> <span class="n">MonitorTrain</span><span class="p">(</span><span class="n">per_print_times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">summary_dir</span><span class="o">=</span><span class="s1">&#39;./summary_dir_train&#39;</span><span class="p">)</span>

<span class="n">monitor_eval</span> <span class="o">=</span> <span class="n">MonitorEval</span><span class="p">(</span><span class="n">summary_dir</span><span class="o">=</span><span class="s1">&#39;./summary_dir_eval&#39;</span><span class="p">,</span>
                           <span class="n">model</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
                           <span class="n">eval_ds</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eval_loader&quot;</span><span class="p">],</span>
                           <span class="n">eval_interval</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">print_interval</span><span class="p">,</span>
                           <span class="n">draw_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">time_monitor</span> <span class="o">=</span> <span class="n">TimeMonitor</span><span class="p">()</span>
<span class="n">callbacks_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">monitor_train</span><span class="p">,</span> <span class="n">time_monitor</span><span class="p">,</span> <span class="n">monitor_eval</span><span class="p">]</span>

<span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
                   <span class="n">train_dataset</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;train_loader&quot;</span><span class="p">],</span>
                   <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks_train</span><span class="p">,</span>
                   <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">)</span>
<span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s1">&#39;model.ckpt&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="model-testing">
<h3>Model Testing<a class="headerlink" href="#model-testing" title="Permalink to this headline"></a></h3>
<p>After the model training, the S11 parameters of the testing set can be obtained by the pretrained weight through the <code class="docutils literal notranslate"><span class="pre">solver.model.eval</span></code> interface.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">,</span> <span class="n">config_data</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

<span class="n">model_net</span> <span class="o">=</span> <span class="n">S11Predictor</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">input_dim</span><span class="p">)</span>
<span class="n">model_net</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s1">&#39;model.ckpt&#39;</span><span class="p">))</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">model_net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>

<span class="n">eval_error_mrc</span> <span class="o">=</span> <span class="n">EvalMetric</span><span class="p">(</span><span class="n">scale_s11</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;scale_S11&quot;</span><span class="p">],</span>
                            <span class="n">length</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eval_data_length&quot;</span><span class="p">],</span>
                            <span class="n">frequency</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span>
                            <span class="n">show_pic_number</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;./eval_result&#39;</span><span class="p">)</span>

<span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">model_net</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model_net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.001</span><span class="p">),</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;eval_mrc&#39;</span><span class="p">:</span> <span class="n">eval_error_mrc</span><span class="p">},</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">())</span>

<span class="n">res_eval</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">valid_dataset</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eval_loader&quot;</span><span class="p">],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">loss_mse</span><span class="p">,</span> <span class="n">l2_s11</span> <span class="o">=</span> <span class="n">res_eval</span><span class="p">[</span><span class="s2">&quot;eval_mrc&quot;</span><span class="p">][</span><span class="s2">&quot;loss_error&quot;</span><span class="p">],</span> <span class="n">res_eval</span><span class="p">[</span><span class="s2">&quot;eval_mrc&quot;</span><span class="p">][</span><span class="s2">&quot;l2_error&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss_mse: </span><span class="si">{</span><span class="n">loss_mse</span><span class="si">:</span><span class="s1">.10f</span><span class="si">}</span><span class="s1">  &#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;L2_S11: </span><span class="si">{</span><span class="n">l2_s11</span><span class="si">:</span><span class="s1">.10f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="result-visualization">
<h3>Result Visualization<a class="headerlink" href="#result-visualization" title="Permalink to this headline"></a></h3>
<p>During the training process, the <code class="docutils literal notranslate"><span class="pre">vision.MonitorTrain</span></code> and <code class="docutils literal notranslate"><span class="pre">vision.MonitorEval</span></code> modules in MindElec can be used to display the loss, relative error, and the comparison of the predicted and S11 values of the training set and testing set.</p>
<p>The following figure shows the loss and relative error.</p>
<p><img alt="train_test_loss" src="_images/train_test_loss.jpg" /></p>
<p>The following figure shows the comparison between the predicted and S11 values.</p>
<p><img alt="test_picture" src="_images/test_picture.JPG" /></p>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">vision.plot_s11</span></code> module in MindElec to draw the comparison chart of the predicted and true S11 values, as shown in the following figure.</p>
<p><img alt="S11_test_bow" src="_images/S11_test_bow.jpg" /></p>
<p>The orange dashed line indicates the simulation of the bowtie antenna using the commercial software CST, and the blue solid line indicates the prediction of the MindElec model. The relative error between the two is 1.02%. The resonance frequency points, corresponding S11 amplitudes and bandwidths of the two curves are basically the same.</p>
<p>MindElec can quickly obtain the S-parameters of different structures and materials while ensuring that the error between MindElec and commercial software is small.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data_driven.html" class="btn btn-neutral float-left" title="Data Driven Deep Learning Method for Electromagnetic Simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="point_cloud.html" class="btn btn-neutral float-right" title="AI Electromagnetic Simulation based on Point Cloud Method" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>