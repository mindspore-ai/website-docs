<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Industrial Flow Simulation Model (DongFang YuFeng) &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FNO for 1D Burgers" href="burgers_FNO1D.html" />
    <link rel="prev" title="inverse Navier-Stokes problem" href="../physics_driven/navier_stokes_inverse.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes_inverse.html">inverse Navier-Stokes problem</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">AI Industrial Flow Simulation Model (DongFang YuFeng)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction"><strong>Introduction</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#background"><strong>Background</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#technical-difficulties"><strong>Technical difficulties</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#technical-path"><strong>Technical Path</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation"><strong>Preparation</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#dongfang-·-yufeng-mindspore-flow-implementation"><strong>“DongFang · YuFeng” MindSpore Flow Implementation</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-network-and-training-parameters"><strong>Configure network and training parameters</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-and-loading-datasets">Creating and Loading Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-building"><strong>Model Building</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#loss-function-and-optimizer">Loss function and optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train-function">Train function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#result-visualization"><strong>Result visualization</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-inference">Model inference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>AI Industrial Flow Simulation Model (DongFang YuFeng)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_driven/2D_steady.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="ai-industrial-flow-simulation-model-dongfang-yufeng">
<h1>AI Industrial Flow Simulation Model (DongFang YuFeng)<a class="headerlink" href="#ai-industrial-flow-simulation-model-dongfang-yufeng" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindflow/en/data_driven/mindspore_2D_steady.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindflow/en/data_driven/mindspore_2D_steady.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindflow/docs/source_en/data_driven/2D_steady.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a></p>
<section id="introduction">
<h2><strong>Introduction</strong><a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p><strong>DongFang·YuFeng</strong> built based on Ascend AI, is an efficient and high-accuracy AI simulation model for forecasting flow fields over airfoils of the airliner. With the support of MindSpore, the ability to simulate complex flows has been effectively improved. The simulation time is shortened to 1/24 of that in traditional Computational Fluid Dynamics (CFD) and the number of wind tunnel tests is reduced.Additionally, “DongFang·YuFeng” is capable of predicting the areas with sharp changes in the
flow field accurately, and the averaged error of the whole flow field can be reduced to 1e-4 magnitude, reaching the industrial standard.</p>
<p><img alt="img-8.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_8.png" /></p>
<p>This tutorial will introduce the research background and technical path of “DongFang·YuFeng” and show how to use MindSpore Flow to realize the training and fast inference of the model, as well as visualized analysis of the flow field, so as to quickly obtain the physical information of the flow field.</p>
</section>
<section id="background">
<h2><strong>Background</strong><a class="headerlink" href="#background" title="Permalink to this headline"></a></h2>
<p>Civil aircraft aerodynamic design level directly determines the “four characteristics” of aircraft, namely safety, comfort, economy and environmental protection. Aerodynamic design of aircraft, as one of the most basic and core technologies in aircraft design, has different research needs and priorities in different stages of aircraft flight envelope (take-off, climb, cruise, descent, landing, etc.). For example, in the take-off phase, engineers will focus more on external noise and high
lift-drag ratio, while in the cruise phase they will focus on fuel and energy efficiency. The flow simulation technology is widely used in aircraft aerodynamic design. Its main purpose is to obtain the flow field characteristics (velocity, pressure, etc.) of the simulation target through numerical methods, and then analyze the aerodynamic performance parameters of the aircraft, so as to achieve the optimization design of the aerodynamic performance of the aircraft.</p>
<p><img alt="img-7.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_7.png" /></p>
<p>Currently, the aerodynamic simulation of aircraft usually uses commercial simulation software to solve the governing equations and obtain the corresponding aerodynamic performance parameters (lift and drag, pressure, velocity, etc.). However, regardless of the CFD-based simulation software, the following steps are involved:</p>
<ol class="arabic simple">
<li><p>Physical modeling. The physical problems are abstracted and simplified to model the 2D/3D fluid and solid computational domain of the related geometry.</p></li>
<li><p>Mesh partition. The computing domain is divided into face/volume units of corresponding size to resolve turbulence in different areas and different scales.</p></li>
<li><p>Numerical discretization. The integral, differential and partial derivative terms in the governing equation are discretized into algebraic form through different order numerical formats to form corresponding algebraic equations.</p></li>
<li><p>Solution of governing equation. Use the numerical methods (such as <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code>, <code class="docutils literal notranslate"><span class="pre">PISO</span></code> etc.) to solve the discrete governing equations iteratively, and calculate the numerical solutions at discrete time/space points.</p></li>
<li><p>Post-processing. After the solution, use the flow field post-processing software to conduct qualitative and quantitative analysis and visualization of the simulation results and verify the accuracy of the results.</p></li>
</ol>
<p><img alt="img-en.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_en.png" /></p>
<p>However, with the shortening of aircraft design and development cycle, the existing aerodynamic design methods have many limitations. Thus, in order to make the aerodynamic design level of airliner catch up with the two major aviation giants, Boeing and Airbus, it is necessary to develop advanced aerodynamic design means and combine advanced technologies such as artificial intelligence to establish fast aerodynamic design tools suitable for model design, thereby improving its simulation
capability for complex flows and reducing the number of wind tunnel tests, as well as reducing design and research and development costs.</p>
<p><img alt="img-11-en.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_11_en.png" /></p>
<p>In the design of aircraft, the drag distribution of the wing is about 52% of the overall flight drag. Therefore, the wing shape design is very important for the whole flight performance of the aircraft. However, the high-fidelity CFD simulation of 3D wing requires millions of computational grids, which consumes a lot of computational resources and takes a long computational cycle. To improve the efficiency of simulation design, the design optimization of the two-dimensional section of the 3D
wing is usually carried out first, and this process often requires repeated iterative CFD calculation for thousands of pairs of airfoils and their corresponding working conditions. Among these airfoils, the supercritical airfoil has an important application in high-speed cruise. Compared with the common airfoil, the supercritical airfoil has a fuller head, which reduces the peak negative pressure at the leading edge, and makes the airflow reach the sound velocity later, i.e. the critical Mach
number is increased. At the same time, the middle of the upper surface of supercritical airfoil is relatively flat, which effectively controls the further acceleration of the upper airfoil airflow, reduces the intensity and influence range of the shock wave, and delays the shock-induced boundary layer separation on the upper surface. Therefore, supercritical airfoils with higher critical Mach numbers must be considered in wing shapes, since they can significantly improve aerodynamic performance
in the transonic range, reduce drag and improve attitude controllability.</p>
<p><img alt="img-10-en.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_10_en.png" /></p>
<p>However, the aerodynamic design of two-dimensional supercritical airfoils needs to be simulated for different shapes and inflow parameters, and there are still a lot of iterative computations, which result in a long design cycle. Therefore, it is particularly important to use AI’s natural parallel inference capabilities to shorten the research and development cycle. Based on this, COMAC and Huawei jointly released the industry’s first AI industrial flow simulation model – <strong>“DongFang·YuFeng”</strong>,
which can detect changes in the geometry and flow parameters (angle of attack/Mach number) of the supercritical airfoil. The high-efficiency and high-precision inference of airfoil flow field of airliner is realized, and the flow field around airfoil and lift drag are predicted quickly and accurately.</p>
</section>
<section id="technical-difficulties">
<h2><strong>Technical difficulties</strong><a class="headerlink" href="#technical-difficulties" title="Permalink to this headline"></a></h2>
<p>In order to realize high-efficiency and high-precision flow field prediction of supercritical airfoil by AI, the following technical difficulties need to be overcome:</p>
<ul>
<li><p><strong>Airfoil meshes are uneven and flow feature extraction is difficult.</strong> O-type or C-type meshes are often used for fluid simulation of 2D airfoil computing domain. As shown in the figure, a typical O-shaped mesh is divided. In order to accurately calculate the flow boundary layer, the near-wall surface of the airfoil is meshed, while the far-field mesh is relatively sparse. This non-standard grid data structure increases the difficulty of extracting flow features.</p>
<p><img alt="img-12.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_12.png" /></p>
<p><img alt="img-13.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_13.png" /></p>
</li>
<li><p><strong>Flow characteristics change significantly when different aerodynamic parameters or airfoil shapes change.</strong> As shown in the figure, when the angle of attack of the airfoil changes, the flow field will change dramatically, especially when the angle of attack increases to a certain degree, shock wave phenomenon will occur: that is, there is obvious discontinuity in the flow field. The pressure, velocity and density of the fluid on the wavefront are obviously changed abruptly.</p>
<p><img alt="diff-aoa.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/diff_aoa.png" /></p>
</li>
<li><p><strong>The flow field in the shock region changes dramatically, and it is difficult to predict.</strong> Because the existence of shock wave has a significant impact on the flow field nearby, the flow field before and after shock wave changes dramatically, and the flow field changes are complex, making it difficult for AI to predict. The location of shock wave directly affects the aerodynamic performance design and load distribution of airfoil. Therefore, accurate capture of shock signals is very
important but challenging.</p></li>
</ul>
</section>
<section id="technical-path">
<h2><strong>Technical Path</strong><a class="headerlink" href="#technical-path" title="Permalink to this headline"></a></h2>
<p>Aiming at the technical difficulties mentioned above, we designed an AI model-based technology roadmap to construct the end-to-end mapping of airfoil geometry and its corresponding flow fields under different flow states, which mainly includes the following core steps:</p>
<ul class="simple">
<li><p>First, we design an efficient AI data conversion tool to realize feature extraction of complex boundary and non-standard data of airfoil flow field, as shown in the data preprocessing module. Firstly, the regularized AI tensor data is generated by the grid conversion program of curvilinear coordinate system, and then the geometric coding method is used to enhance the extraction of complex geometric boundary features.</p></li>
<li><p>Secondly, the neural network model is used to map the airfoil configuration and the physical parameters of the flow field under different flow states, as shown in Figure ViT-based encoder-decoder. The input of the model is airfoil geometry information and aerodynamic parameters generated after coordinate transformation. The output of the model is the physical information of the flow field, such as velocity and pressure.</p></li>
<li><p>Finally, the weights of the network are trained using the multilevel wavelet transform loss function. Perform further decomposition and learning on abrupt high-frequency signals in the flow field, so as to improve prediction accuracy of areas (such as shock waves) that change sharply in the flow field, as shown in a module corresponding to the loss function.</p></li>
</ul>
<p><img alt="img-1.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_1.png" /></p>
</section>
<section id="preparation">
<h2><strong>Preparation</strong><a class="headerlink" href="#preparation" title="Permalink to this headline"></a></h2>
<p>Before practice, ensure that MindSpore and MindSpore Flow of the latest versions have been correctly installed. If not, you can run the following command:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mindspore.cn/install">MindSpore installation page</a> Install MindSpore。</p></li>
<li><p><a class="reference external" href="https://www.mindspore.cn/mindflow/docs/zh-CN/master/mindflow_install.html">MindSpore Flow installation page</a> Install MindSpore Flow。</p></li>
</ul>
</section>
<section id="dongfang-·-yufeng-mindspore-flow-implementation">
<h2><strong>“DongFang · YuFeng” MindSpore Flow Implementation</strong><a class="headerlink" href="#dongfang-·-yufeng-mindspore-flow-implementation" title="Permalink to this headline"></a></h2>
<p>The implementation of “DongFang·YuFeng” <code class="docutils literal notranslate"><span class="pre">MindSpore</span> <span class="pre">Flow</span></code> consists of the following six steps:</p>
<ol class="arabic simple">
<li><p>Configure network and training parameters</p></li>
<li><p>Creating and Loading Datasets</p></li>
<li><p>Model building</p></li>
<li><p>Model training</p></li>
<li><p>Result visualization</p></li>
<li><p>Model inference</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">save_checkpoint</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">data_sink</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">mindflow.common</span> <span class="kn">import</span> <span class="n">get_warmup_cosine_annealing_lr</span>
<span class="kn">from</span> <span class="nn">mindflow.pde</span> <span class="kn">import</span> <span class="n">SteadyFlowWithLoss</span>
<span class="kn">from</span> <span class="nn">mindflow.loss</span> <span class="kn">import</span> <span class="n">WaveletTransformLoss</span>
<span class="kn">from</span> <span class="nn">mindflow.cell</span> <span class="kn">import</span> <span class="n">ViT</span>
<span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>
</pre></div>
</div>
</div>
<p>The following <code class="docutils literal notranslate"><span class="pre">src</span></code> pacakage can be downloaded in <a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/master/MindFlow/applications/data_driven/airfoil/2D_steady/src">applications/data_driven/airfoil/2D_steady/src</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">AirfoilDataset</span><span class="p">,</span> <span class="n">calculate_eval_error</span><span class="p">,</span> <span class="n">plot_u_and_cp</span><span class="p">,</span> <span class="n">get_ckpt_summ_dir</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span>
                    <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;Ascend&quot;</span><span class="p">,</span>
                    <span class="n">device_id</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">use_ascend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;device_target&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="configure-network-and-training-parameters">
<h2><strong>Configure network and training parameters</strong><a class="headerlink" href="#configure-network-and-training-parameters" title="Permalink to this headline"></a></h2>
<p>Read four types of parameters from the configuration file, which are model-related parameters (model), data-related parameters (data), optimizer-related parameters (optimizer), output-related parameters (ckpt) and validation-related parameters(eval).You can get these parameters from <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/master/MindFlow/applications/data_driven/airfoil/2D_steady/configs/vit.yaml">config</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
<span class="n">data_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">model_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
<span class="n">optimizer_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
<span class="n">ckpt_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ckpt&quot;</span><span class="p">]</span>
<span class="n">eval_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="creating-and-loading-datasets">
<h2>Creating and Loading Datasets<a class="headerlink" href="#creating-and-loading-datasets" title="Permalink to this headline"></a></h2>
<p>Download dataset link：<a class="reference external" href="https://download.mindspore.cn/mindscience/mindflow/dataset/applications/data_driven/airfoil/2D_steady/">data_driven/airfoil/2D_steady/dataset</a></p>
<p>The data is a mindrecord type file. The code for reading and viewing the data shape is as follows:</p>
<p>This file contains 2808 flow field data for 51 supercritical airfoils in the range of Ma=0.73 and different angles of attack (- 2.0 to 4.6). Where, the data dimensions of input are (13, 192, 384), 192, and 384 are the grid resolution after Jacobi conversion, and 13 are different feature dimensions, respectively (<span class="math notranslate nohighlight">\(AOA\)</span>, <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(x_{i,0}\)</span>, <span class="math notranslate nohighlight">\(y_{i,0}\)</span>, <span class="math notranslate nohighlight">\(\xi_x\)</span>, <span class="math notranslate nohighlight">\(\xi_y\)</span>, <span class="math notranslate nohighlight">\(\eta_x\)</span>, <span class="math notranslate nohighlight">\(\eta_y\)</span>, <span class="math notranslate nohighlight">\(x_\xi\)</span>, <span class="math notranslate nohighlight">\(x_\eta\)</span>, <span class="math notranslate nohighlight">\(y_\xi\)</span>,
<span class="math notranslate nohighlight">\(y_\eta\)</span>).</p>
<p>The data dimension of Label is (288, 768), which can be passed through the patchify function in <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/master/MindFlow/applications/data_driven/airfoil/2D_steady/src/utils.py">utils.py</a>(16 × 16). The flow field data (u, v, p) obtained after the operation can be restored to (3, 192, 384) through the unpatchify operation in <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/master/MindFlow/applications/data_driven/airfoil/2D_steady/src/utils.py">utils.py</a>.
Users can customize and select based on their own network input and output design.</p>
<p>First, convert the CFD dataset into tensor data, and then convert the tensor data into MindRecord. Design an AI data efficient conversion tool to achieve feature extraction of complex boundary and non-standard data of airfoil flow fields. The information of x, y, and u before and after conversion is shown in the following figure.</p>
<p><img alt="img-6.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_6.png" /></p>
<p>Currently, AI fluid simulation supports training using local datasets. You can use the <code class="docutils literal notranslate"><span class="pre">MindDataset</span></code> interface to configure dataset options. You need to specify the location of the MindRecord dataset file.</p>
<p>The default value of the train_size field in the config.yaml file is 0.8, indicating that the default ratio of the training set to the validation set is 4:1 in “train” mode. You can modify the value. The default value of finetune_size in the config.yaml file is 0.2, indicating that the default ratio of the training set to the validation set is 1:4 in “finetune” mode. You can modify the value. When the training mode is set to eval, all data sets are used as validation sets.</p>
<p>The min_value_list and min_value_list fields in the config.yaml file indicate the maximum and minimum values of the angle of attack, x information after geometric encoding, and y information after geometric encoding, respectively.</p>
<p>The “train_num_list” field and “test_num_list” field in the config.yaml file indicate the airfoil start number list corresponding to the training and validation data sets respectively. Each group of data contains 50 airfoil data. For example, if the value of the “train_num_list” field is [0], it indicates 50 pieces of airfoil data corresponding to the training set from 0 to 49.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mindrecord_name</span> <span class="o">=</span> <span class="s2">&quot;flowfiled_000_050.mind&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MindDataset</span><span class="p">(</span><span class="n">dataset_files</span><span class="o">=</span><span class="n">mindrecord_name</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">project</span><span class="p">([</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;samples:&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">(</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_numpy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">method</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">method</span><span class="p">,</span> <span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)])</span>
<span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">summary_dir</span> <span class="o">=</span> <span class="n">get_ckpt_summ_dir</span><span class="p">(</span><span class="n">ckpt_params</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
<span class="n">max_value_list</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;max_value_list&#39;</span><span class="p">]</span>
<span class="n">min_value_list</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;min_value_list&#39;</span><span class="p">]</span>
<span class="n">data_group_size</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;data_group_size&#39;</span><span class="p">]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">AirfoilDataset</span><span class="p">(</span><span class="n">max_value_list</span><span class="p">,</span> <span class="n">min_value_list</span><span class="p">,</span> <span class="n">data_group_size</span><span class="p">)</span>

<span class="n">train_list</span><span class="p">,</span> <span class="n">eval_list</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;train_num_list&#39;</span><span class="p">],</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;test_num_list&#39;</span><span class="p">]</span>
<span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;data_path&#39;</span><span class="p">],</span>
                                                     <span class="n">train_list</span><span class="p">,</span>
                                                     <span class="n">eval_list</span><span class="p">,</span>
                                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                                     <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
                                                     <span class="n">train_size</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;train_size&#39;</span><span class="p">],</span>
                                                     <span class="n">finetune_size</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;finetune_size&#39;</span><span class="p">],</span>
                                                     <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
model_name: ViT_exp_bs_32
summary_dir: ./summary_dir/summary_exp/ViT_exp_bs_32
ckpt_dir: ./summary_dir/summary_exp/ViT_exp_bs_32/ckpt_dir
total dataset : [0]
train dataset size: 2246
test dataset size: 562
train batch dataset size: 70
test batch dataset size: 17
</pre></div></div>
</div>
</section>
<section id="model-building">
<h2><strong>Model Building</strong><a class="headerlink" href="#model-building" title="Permalink to this headline"></a></h2>
<p>The following uses the ViT model as an example. The model is built through the ViT interface defined by the MindSpore Flow package. You need to specify the parameters of the ViT model. You can also build your own model.The most important parameters of the ViT model are the depth, embed_dim, and num_heads of the encoder and decoder, which respectively control the number of layers in the model, the length of the implicit vector, and the number of heads of the multi-head attention mechanism. The
default values of the parameters are as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
    <span class="n">compute_dtype</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">compute_dtype</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ViT</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="s1">&#39;input_dims&#39;</span><span class="p">],</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">],</span>
            <span class="n">encoder_depths</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;encoder_depth&#39;</span><span class="p">],</span>
            <span class="n">encoder_embed_dim</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;encoder_embed_dim&#39;</span><span class="p">],</span>
            <span class="n">encoder_num_heads</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;encoder_num_heads&#39;</span><span class="p">],</span>
            <span class="n">decoder_depths</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;decoder_depth&#39;</span><span class="p">],</span>
            <span class="n">decoder_embed_dim</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;decoder_embed_dim&#39;</span><span class="p">],</span>
            <span class="n">decoder_num_heads</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;decoder_num_heads&#39;</span><span class="p">],</span>
            <span class="n">compute_dtype</span><span class="o">=</span><span class="n">compute_dtype</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="loss-function-and-optimizer">
<h2>Loss function and optimizer<a class="headerlink" href="#loss-function-and-optimizer" title="Permalink to this headline"></a></h2>
<p>In order to improve the prediction accuracy of the high and low frequency information of the convection field, especially the error of the shock region, a multi-stage wavelet transform function wave_loss is used as the loss function, where wave_level can determine the number of wavelet series to be used. It is suggested that two or three levels of wavelet transforms can be used. In the process of network training, we chose Adam optimizer.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># prepare loss scaler</span>
<span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mindspore.amp</span> <span class="kn">import</span> <span class="n">DynamicLossScaler</span><span class="p">,</span> <span class="n">all_finite</span><span class="p">,</span> <span class="n">init_status</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="n">DynamicLossScaler</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">wave_loss</span> <span class="o">=</span> <span class="n">WaveletTransformLoss</span><span class="p">(</span><span class="n">wave_level</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;wave_level&#39;</span><span class="p">])</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">SteadyFlowWithLoss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">wave_loss</span><span class="p">)</span>
<span class="c1"># prepare optimizer</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">get_warmup_cosine_annealing_lr</span><span class="p">(</span><span class="n">lr_init</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
                                    <span class="n">last_epoch</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                                    <span class="n">warmup_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span> <span class="o">+</span> <span class="n">wave_loss</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="train-function">
<h2>Train function<a class="headerlink" href="#train-function" title="Permalink to this headline"></a></h2>
<p>With <strong>MindSpore&gt;= 2.0.0</strong>, you can train neural networks using functional programming paradigms, and single-step training functions are decorated with jit. The data_sink function is used to transfer the step-by-step training function and training dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">init_status</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">train_sink_process</span> <span class="o">=</span> <span class="n">data_sink</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">sink_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p><img alt="img-5.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/img_5.png" /></p>
</section>
<section id="model-training">
<h2>Model training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>During model training, inference is performed during model training. You can directly load the test data set and output the inference precision in the test set after n epochs are trained.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pid: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;use_ascend : </span><span class="si">{</span><span class="n">use_ascend</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;device_id: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">eval_interval</span> <span class="o">=</span> <span class="n">eval_params</span><span class="p">[</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">]</span>
<span class="n">plot_interval</span> <span class="o">=</span> <span class="n">eval_params</span><span class="p">[</span><span class="s1">&#39;plot_interval&#39;</span><span class="p">]</span>
<span class="n">save_ckt_interval</span> <span class="o">=</span> <span class="n">ckpt_params</span><span class="p">[</span><span class="s1">&#39;save_ckpt_interval&#39;</span><span class="p">]</span>
<span class="c1"># train process</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">epochs</span><span class="p">):</span>
    <span class="c1"># train</span>
    <span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">):</span>
        <span class="n">step_train_loss</span> <span class="o">=</span> <span class="n">train_sink_process</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> train loss: </span><span class="si">{</span><span class="n">step_train_loss</span><span class="si">}</span><span class="s2"> epoch time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="c1"># eval</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">eval_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">calculate_eval_error</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">plot_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plot_u_and_cp</span><span class="p">(</span><span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                      <span class="n">grid_path</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;grid_path&#39;</span><span class="p">],</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">summary_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">save_ckt_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ckpt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.ckpt&quot;</span>
        <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">ckpt_name</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ckpt_name</span><span class="si">}</span><span class="s1"> save success&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pid: 71126
use_ascend : True
device_id: 6
total dataset : [0]
train dataset size: 2246
test dataset size: 562
train batch dataset size: 70
test batch dataset size: 17
model_name: ViT_exp_bs_32
summary_dir: ./summary_dir/summary_exp/ViT_exp_bs_32
ckpt_dir: ./summary_dir/summary_exp/ViT_exp_bs_32/ckpt_dir
epoch: 1 train loss: 2.855625 time cost: 99.03s
epoch: 2 train loss: 2.7128317 time cost: 11.67s
epoch: 3 train loss: 2.5762033 time cost: 11.34s
epoch: 4 train loss: 2.4458356 time cost: 11.62s
epoch: 5 train loss: 2.3183048 time cost: 11.35s
...
epoch: 996 train loss: 0.07591154 time cost: 10.27s
epoch: 997 train loss: 0.07530779 time cost: 10.57s
epoch: 998 train loss: 0.07673213 time cost: 11.10s
epoch: 999 train loss: 0.07614599 time cost: 10.56s
epoch: 1000 train loss: 0.07557951 time cost: 10.25s
================================Start Evaluation================================
mean l1_error : 0.00028770750813076604, max l1_error : 0.09031612426042557, average l1_error : 0.015741700749512186, min l1_error : 0.002440142212435603, median l1_error : 0.010396258905529976
mean u_error : 0.0003678269739098409, max u_error : 0.1409306526184082, average u_error : 0.02444652929518591, min u_error : 0.002988457679748535, median u_error : 0.018000304698944092
mean v_error : 0.0001693408951670041, max v_error : 0.025479860603809357, average v_error : 0.0065298188753384985, min v_error : 0.0011983513832092285, median v_error : 0.005558336153626442
mean p_error : 0.0003259546544594581, max p_error : 0.11215704679489136, average p_error : 0.016248753842185524, min p_error : 0.0014863014221191406, median p_error : 0.009315729141235352
mean Cp_error : 0.0004100774693891735, max Cp_error : 0.052939414978027344, average Cp_error : 0.00430003712501596, min Cp_error : 0.0008158683776855469, median Cp_error : 0.0018098950386047363
=================================End Evaluation=================================
predict total time: 27.737457513809204 s
================================Start Plotting================================
./summary_dir/summary_exp/ViT_exp_bs_32/U_and_Cp_compare.png
================================End Plotting================================
Plot total time: 27.499852657318115 s
Train epoch time: 122863.384 ms, per step time: 1755.191 ms
epoch_1000.ckpt save success
</pre></div></div>
</div>
</section>
<section id="result-visualization">
<h2><strong>Result visualization</strong><a class="headerlink" href="#result-visualization" title="Permalink to this headline"></a></h2>
<p>Surface pressure distribution, flow field distribution and error statistics predicted by AI and CFD when airfoil geometry changes.</p>
<p><img alt="airfoil.gif" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/airfoil.gif" /></p>
<p>Surface pressure distribution, flow field distribution and error statistics predicted by AI and CFD when the angle of attack changes.</p>
<p><img alt="aoa-var.gif" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/aoa_var.gif" /></p>
<p>Surface pressure distribution, flow field distribution and error statistics predicted by AI and CFD when incoming flow Mach number changes.</p>
<p><img alt="Ma-var.gif" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/Ma_var.gif" /></p>
</section>
<section id="model-inference">
<h2>Model inference<a class="headerlink" href="#model-inference" title="Permalink to this headline"></a></h2>
<p>After model training is complete, you can call the train function in <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/master/MindFlow/applications/data_driven/airfoil/2D_steady/train.py">train.py</a>. If train_mode is set to “eval”, inference can be performed. If train_mode is set to “finetune”, transfer learning can be performed.</p>
<p>When designing a new airfoil, various initial boundary conditions (such as different angles of attack or Mach number) need to be considered for aerodynamic performance evaluation. In order to improve the generalization of the model and improve its utility in engineering scenarios, we can adopt the transfer learning mode. The method is as follows: pre-training the model in large-scale datasets, and fine-tuning the model in small datasets, so as to realize the inference generalization of the model
to the new working conditions. Considering the trade-off between precision and time consumption, we considered four different size datasets to obtain different pre-trained models. Compared with pre-training on smaller datasets, pre-training requires less time, but the prediction precision is lower. Pre-training on larger data sets can produce more accurate results, but requires more pre-training time.</p>
<p>The results of the transfer learning are shown in the following figure. When the model is pre-trained using tiny data sets, at least three new flow fields are required to achieve 4e-4 accuracy. In contrast, when the model is pre-trained using small, medium, or large data sets, only a new flow field is required and an accuracy of 1e-4 can be maintained. In addition, <span class="math notranslate nohighlight">\(l_{1\_avg}\)</span> can be reduced by at least 50% by transfer learning using five flow fields. The pre-trained model with large data
sets can predict the flow field with high precision in the case of zero-shot. The fine-tuning results obtained using datasets of different sizes and sizes are shown in the figure below. The fine-tuning takes much less time than the sample generation, and when the fine-tuning is complete, other operating conditions of the new airfoil can be quickly reasoned. Therefore, the fine-tuning technology based on transfer learning is of great value in engineering application.</p>
<p><img alt="finetune.png" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/finetune.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../physics_driven/navier_stokes_inverse.html" class="btn btn-neutral float-left" title="inverse Navier-Stokes problem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="burgers_FNO1D.html" class="btn btn-neutral float-right" title="FNO for 1D Burgers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>