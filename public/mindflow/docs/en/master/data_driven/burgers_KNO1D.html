<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KNO for 1D Burgers &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="KNO for 2D Navier-Stokes" href="navier_stokes_KNO2D.html" />
    <link rel="prev" title="FNO for 2D Navier-Stokes" href="navier_stokes_FNO2D.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes_inverse.html">inverse Navier-Stokes problem</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">KNO for 1D Burgers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#burgers’-equation">Burgers’ equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technology-path">Technology Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#koopman-neural-operator">Koopman Neural Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-dataset-construction">Training Dataset Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimizer-and-loss-function">Optimizer and Loss Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-evaluation-and-visualization">Model Evaluation and Visualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>KNO for 1D Burgers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_driven/burgers_KNO1D.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="kno-for-1d-burgers">
<h1>KNO for 1D Burgers<a class="headerlink" href="#kno-for-1d-burgers" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/master/mindflow/en/data_driven/mindspore_burgers_KNO1D.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/master/mindflow/en/data_driven/mindspore_burgers_KNO1D.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindflow/docs/source_en/data_driven/burgers_KNO1D.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Computational fluid dynamics is one of the most important techniques in the field of fluid mechanics in the 21st century. The flow analysis, prediction and control can be realized by solving the governing equations of fluid mechanics by numerical method. Traditional finite element method (FEM) and finite difference method (FDM) are inefficient because of the complex simulation process (physical modeling, meshing, numerical discretization, iterative solution, etc.) and high computing costs.
Therefore, it is necessary to improve the efficiency of fluid simulation with AI.</p>
<p>Machine learning methods provide a new paradigm for scientific computing by providing a fast solver similar to traditional methods. Classical neural networks learn mappings between finite dimensional spaces and can only learn solutions related to a specific discretization. Different from traditional neural networks, Fourier Neural Operator (FNO) is a new deep learning architecture that can learn mappings between infinite-dimensional function spaces. It directly learns mappings from arbitrary
function parameters to solutions to solve a class of partial differential equations. Therefore, it has a stronger generalization capability. More information can be found in the paper, <a class="reference external" href="https://arxiv.org/abs/2010.08895">Fourier Neural Operator for Parametric Partial Differential Equations</a>.</p>
<p>But these kinds of neural operator become less accurate and explainable while learning long-term behaviours of non-linear PDE families. Koopman neural operator (KNO), a new neural operator, overcome these challenges by formulating a non-linear dynamic system of equation solution. By approximating the Koopman operator, an infnite-dimensional linear operator governing all possible observations of the dynamic system, to act on the flow mapping of dynamic system, we can equivalently learn the
solution of an entire non-linear PDE family by solving simple linear prediction problems. More information can be found in these papers:</p>
<ul class="simple">
<li><p>“<a class="reference external" href="https://arxiv.org/abs/2301.10022">Koopman neural operator as a mesh-free solver of non-linear partial differential equations</a>.” arXiv preprint arXiv:2301.10022 (2023).</p></li>
<li><p>“<a class="reference external" href="https://arxiv.org/abs/2301.01104">KoopmanLab: machine learning for solving complex physics equations</a>.” arXiv preprint arXiv:2301.01104 (2023).</p></li>
</ul>
<p>This tutorial describes how to solve the 1-d Burgers’ equation using Koopman neural operator.</p>
</section>
<section id="burgers’-equation">
<h2>Burgers’ equation<a class="headerlink" href="#burgers’-equation" title="Permalink to this headline"></a></h2>
<p>The 1-d Burgers’ equation is a non-linear PDE with various applications including modeling the one dimensional flow of a viscous fluid. It takes the form</p>
<div class="math notranslate nohighlight">
\[\partial_t u(x, t)+\partial_x (u^2(x, t)/2)=\nu \partial_{xx} u(x, t), \quad x \in(0,1), t \in(0, 1]\]</div>
<div class="math notranslate nohighlight">
\[u(x, 0)=u_0(x), \quad x \in(0,1)\]</div>
<p>where <span class="math notranslate nohighlight">\(u\)</span> is the velocity field, <span class="math notranslate nohighlight">\(u_0\)</span> is the initial condition and <span class="math notranslate nohighlight">\(\nu\)</span> is the viscosity coefficient.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>We aim to learn the operator mapping the initial condition to the solution at time one:</p>
<div class="math notranslate nohighlight">
\[u_0 \mapsto u(\cdot, 1)\]</div>
</section>
<section id="technology-path">
<h2>Technology Path<a class="headerlink" href="#technology-path" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Training Dataset Construction.</p></li>
<li><p>Model Construction.</p></li>
<li><p>Optimizer and Loss Function.</p></li>
<li><p>Model Training.</p></li>
<li><p>Model Evaluation and Visualization.</p></li>
</ol>
</section>
<section id="koopman-neural-operator">
<h2>Koopman Neural Operator<a class="headerlink" href="#koopman-neural-operator" title="Permalink to this headline"></a></h2>
<p>The following figure shows the architecture of the Koopman Neural Operator, which contains the upper and lower main branches and corresponding outputs. In the figure, Input represents the initial vorticity. In the upper branch, the input vector is lifted to higher dimension channel space by the Encoding layer. Then the mapping result is used as the input of the Koopman layer to perform nonlinear transformation of the frequency domain information. Finally, the Decoding layer maps the
transformation result to the Prediction. At the same time, the lower branch does high-dimensional mapping of the input vector through the Encoding Layer, and then reconstructs the input through the Decoding Layer. The Encoding layers of the upper and lower branches share the weight, and the Decoding layers share the weight too. Prediction is used to calculate the prediction error with Label, and Reconstruction is used to calculate the reconstruction error with Input. The two errors together
guide the gradient calculation of the model.</p>
<p>The Koopman Neural Operator consists of the Encoding Layer, Koopman Layers, Decoding Layer and two branches.</p>
<p>The Koopman Layer is shown in the dotted box, which could be repeated. Start from input: apply the Fourier transform(FFT); apply a linear transformation on the lower Fourier modes and filters out the higher modes; then apply the inverse Fourier transform(iFFT). Then the output is added into input. Finally, the Koopman Layer output vector is obtained through the activation function.</p>
<p><img alt="Fourier Layer structure" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindflow/docs/source_en/data_driven/images/kno.jpg" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">mindspore.nn.loss</span> <span class="kn">import</span> <span class="n">MSELoss</span>

<span class="kn">from</span> <span class="nn">mindflow.cell</span> <span class="kn">import</span> <span class="n">KNO1D</span>
<span class="kn">from</span> <span class="nn">mindflow.common</span> <span class="kn">import</span> <span class="n">get_warmup_cosine_annealing_lr</span>
<span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>
</pre></div>
</div>
</div>
<p>The following <code class="docutils literal notranslate"><span class="pre">src</span></code> pacakage can be downloaded in <a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/master/MindFlow/applications/data_driven/burgers/kno1d/src">applications/data_driven/burgers/kno1d/src</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">create_training_dataset</span>
<span class="kn">from</span> <span class="nn">src.trainer</span> <span class="kn">import</span> <span class="n">BurgersWithLoss</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">visual</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pid:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s1">&#39;Ascend&#39;</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">use_ascend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">attr_key</span><span class="o">=</span><span class="s1">&#39;device_target&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pid: 9647
2023-03-04 08:03:20.885806
</pre></div></div>
</div>
<p>You can get hyperparameters of model, data and optimizer from <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/master/MindFlow/applications/data_driven/burgers/kno1d/configs/burgers1d.yaml">config</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s1">&#39;burgers1d.yaml&#39;</span><span class="p">)</span>
<span class="n">data_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">model_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
<span class="n">optimizer_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="training-dataset-construction">
<h2>Training Dataset Construction<a class="headerlink" href="#training-dataset-construction" title="Permalink to this headline"></a></h2>
<p>Download the training and test dataset: <a class="reference external" href="https://download.mindspore.cn/mindscience/mindflow/dataset/applications/data_driven/burgers/dataset/">data_driven/burgers/dataset</a> .</p>
<p>In this case, training datasets and test datasets are generated according to Zongyi Li’s dataset in <a class="reference external" href="https://arxiv.org/pdf/2010.08895.pdf">Fourier Neural Operator for Parametric Partial Differential Equations</a> . The settings are as follows:</p>
<p>the initial condition <span class="math notranslate nohighlight">\(u_0(x)\)</span> is generated according to periodic boundary conditions:</p>
<div class="math notranslate nohighlight">
\[u_0 \sim \mu, \mu=\mathcal{N}\left(0,625(-\Delta+25 I)^{-2}\right)\]</div>
<p>We set the viscosity to <span class="math notranslate nohighlight">\(\nu=0.1\)</span> and solve the equation using a split step method where the heat equation part is solved exactly in Fourier space then the non-linear part is advanced, again in Fourier space, using a very fine forward Euler method. The number of samples in the training set is 1000, and the number of samples in the test set is 200.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create training dataset</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">create_training_dataset</span><span class="p">(</span><span class="n">data_params</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create test dataset</span>
<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">create_training_dataset</span><span class="p">(</span>
    <span class="n">data_params</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data preparation finished
input_path:  (1000, 1024, 1)
label_path:  (1000, 1024)
Data preparation finished
input_path:  (200, 1024, 1)
label_path:  (200, 1024)
</pre></div></div>
</div>
</section>
<section id="model-construction">
<h2>Model Construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>The network is composed of 1 shared Encoding Layer, multiple Koopman Layers and 1 shared Decoding Layer:</p>
<ul class="simple">
<li><p>The Encoding Layer corresponds to the <code class="docutils literal notranslate"><span class="pre">KNO2D.enc</span></code> in the case, and maps the output data to the high dimension;</p></li>
<li><p>Koopman Layer corresponds to the <code class="docutils literal notranslate"><span class="pre">KNO2D.koopman_layer</span></code> in the case. Discrete Fourier transform is used to realize the conversion between time domain and frequency domain;</p></li>
<li><p>The Decoding Layer corresponds to <code class="docutils literal notranslate"><span class="pre">KNO2D.dec</span></code> in the case to obtain the final predictive value.</p></li>
</ul>
<p>Initialize the model based on the network above. Hyperparameters can be modified in config.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">KNO1D</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;in_channels&#39;</span><span class="p">],</span>
              <span class="n">channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">],</span>
              <span class="n">modes</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;modes&#39;</span><span class="p">],</span>
              <span class="n">depths</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
              <span class="n">resolution</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
              <span class="p">)</span>

<span class="n">model_params_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_params_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
name:KNO1D_channels:32_modes:64_depths:4_resolution:1024
</pre></div></div>
</div>
</section>
<section id="optimizer-and-loss-function">
<h2>Optimizer and Loss Function<a class="headerlink" href="#optimizer-and-loss-function" title="Permalink to this headline"></a></h2>
<p>Use the mean square error as the training loss function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_size</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">eval_size</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">get_warmup_cosine_annealing_lr</span><span class="p">(</span><span class="n">lr_init</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
                                    <span class="n">last_epoch</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span>
                                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">train_size</span><span class="p">,</span>
                                    <span class="n">warmup_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdamWeightDecay</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span>
                               <span class="n">learning_rate</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span>
                               <span class="n">weight_decay</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">()</span>
<span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mindspore.amp</span> <span class="kn">import</span> <span class="n">DynamicLossScaler</span><span class="p">,</span> <span class="n">auto_mixed_precision</span><span class="p">,</span> <span class="n">all_finite</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="n">DynamicLossScaler</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">auto_mixed_precision</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;O3&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</section>
<section id="model-training">
<h2>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>With <strong>MindSpore version &gt;= 2.0.0</strong>, we can use the functional programming for training neural networks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">problem</span> <span class="o">=</span> <span class="n">BurgersWithLoss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_params</span><span class="p">[</span><span class="s2">&quot;out_channels&quot;</span><span class="p">],</span> <span class="n">loss_fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">forward_fn</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span>

<span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">):</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span>

<span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_rel_loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="n">train_sink</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">data_sink</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">sink_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">eval_sink</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">data_sink</span><span class="p">(</span><span class="n">eval_step</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">sink_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">summary_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="n">model_name</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">summary_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_dir</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">l_recons_train</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">l_pred_train</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_size</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span> <span class="o">=</span> <span class="n">train_sink</span><span class="p">()</span>
        <span class="n">l_recons_train</span> <span class="o">+=</span> <span class="n">l_recons</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">l_pred_train</span> <span class="o">+=</span> <span class="n">l_pred</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">l_recons_train</span> <span class="o">=</span> <span class="n">l_recons_train</span> <span class="o">/</span> <span class="n">train_size</span>
    <span class="n">l_pred_train</span> <span class="o">=</span> <span class="n">l_pred_train</span> <span class="o">/</span> <span class="n">train_size</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, time cost: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;8f</span><span class="si">}</span><span class="s2">,&quot;</span>
          <span class="sa">f</span><span class="s2">&quot; recons loss: </span><span class="si">{</span><span class="n">l_recons_train</span><span class="si">:</span><span class="s2">&gt;8f</span><span class="si">}</span><span class="s2">, pred loss: </span><span class="si">{</span><span class="n">l_pred_train</span><span class="si">:</span><span class="s2">&gt;8f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">l_recons_eval</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">l_pred_eval</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------start evaluation-------------------------&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eval_size</span><span class="p">):</span>
            <span class="n">l_recons</span><span class="p">,</span> <span class="n">l_pred</span> <span class="o">=</span> <span class="n">eval_sink</span><span class="p">()</span>
            <span class="n">l_recons_eval</span> <span class="o">+=</span> <span class="n">l_recons</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
            <span class="n">l_pred_eval</span> <span class="o">+=</span> <span class="n">l_pred</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">l_recons_eval</span> <span class="o">=</span> <span class="n">l_recons_eval</span> <span class="o">/</span> <span class="n">eval_size</span>
        <span class="n">l_pred_eval</span> <span class="o">=</span> <span class="n">l_pred_eval</span> <span class="o">/</span> <span class="n">eval_size</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Eval epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, recons loss: </span><span class="si">{</span><span class="n">l_recons_eval</span><span class="si">}</span><span class="s1">,&#39;</span>
              <span class="sa">f</span><span class="s1">&#39; relative pred loss: </span><span class="si">{</span><span class="n">l_pred_eval</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------end evaluation---------------------------&quot;</span><span class="p">)</span>
        <span class="n">mindspore</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ckpt_file_name</span><span class="o">=</span><span class="n">summary_dir</span> <span class="o">+</span> <span class="s1">&#39;/save_model.ckpt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./summary_dir/name:KNO1D_channels:32_modes:64_depths:4_resolution:1024
epoch: 1, time cost: 18.375901, recons loss: 0.295517, pred loss: 0.085093
epoch: 2, time cost: 2.577698, recons loss: 0.161718, pred loss: 0.002227
epoch: 3, time cost: 2.564470, recons loss: 0.027144, pred loss: 0.000992
epoch: 4, time cost: 2.547690, recons loss: 0.000782, pred loss: 0.000511
epoch: 5, time cost: 2.532924, recons loss: 0.000057, pred loss: 0.000279
epoch: 6, time cost: 2.536904, recons loss: 0.000048, pred loss: 0.000241
epoch: 7, time cost: 2.527330, recons loss: 0.000048, pred loss: 0.000213
epoch: 8, time cost: 2.536032, recons loss: 0.000048, pred loss: 0.000227
epoch: 9, time cost: 2.462490, recons loss: 0.000048, pred loss: 0.000230
epoch: 10, time cost: 2.564090, recons loss: 0.000049, pred loss: 0.000229
---------------------------start evaluation-------------------------
Eval epoch: 10, recons loss: 4.7733558130858e-05, relative pred loss: 0.01156728882342577
---------------------------end evaluation---------------------------

...

epoch: 91, time cost: 2.662080, recons loss: 0.000042, pred loss: 0.000006
epoch: 92, time cost: 2.604443, recons loss: 0.000042, pred loss: 0.000007
epoch: 93, time cost: 2.576527, recons loss: 0.000042, pred loss: 0.000006
epoch: 94, time cost: 2.621569, recons loss: 0.000042, pred loss: 0.000006
epoch: 95, time cost: 2.578712, recons loss: 0.000042, pred loss: 0.000006
epoch: 96, time cost: 2.607216, recons loss: 0.000042, pred loss: 0.000006
epoch: 97, time cost: 2.588060, recons loss: 0.000042, pred loss: 0.000006
epoch: 98, time cost: 2.911451, recons loss: 0.000042, pred loss: 0.000006
epoch: 99, time cost: 2.542502, recons loss: 0.000042, pred loss: 0.000006
epoch: 100, time cost: 2.514851, recons loss: 0.000042, pred loss: 0.000006
---------------------------start evaluation-------------------------
Eval epoch: 100, recons loss: 4.17057997037773e-05, relative pred loss: 0.004054672718048095
---------------------------end evaluation---------------------------
</pre></div></div>
</div>
</section>
<section id="model-evaluation-and-visualization">
<h2>Model Evaluation and Visualization<a class="headerlink" href="#model-evaluation-and-visualization" title="Permalink to this headline"></a></h2>
<p>Take 6 samples, and do 10 consecutive steps of prediction. Visualize the prediction as follows.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Infer and plot some data.</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;test/inputs.npy&quot;</span><span class="p">))</span>  <span class="c1"># (200,1024,1)</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">BurgersWithLoss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">)</span>
<span class="n">visual</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/data_driven_burgers_KNO1D_20_0.png" src="../_images/data_driven_burgers_KNO1D_20_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="navier_stokes_FNO2D.html" class="btn btn-neutral float-left" title="FNO for 2D Navier-Stokes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="navier_stokes_KNO2D.html" class="btn btn-neutral float-right" title="KNO for 2D Navier-Stokes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>