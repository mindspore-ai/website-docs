<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reduced order model for three-dimensional unsteady flow &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FNO for 3D Navier-Stokes" href="navier_stokes_FNO3D.html" />
    <link rel="prev" title="Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)" href="2D_unsteady.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes_inverse.html">Inverse Navier-Stokes Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/boltzmannD1V3.html">Neural Representation Method for Boltzmann Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/kovasznay.html">PINNs for Kovasznay Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/periodic_hill.html">Raynold-averaged Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_point_source.html">PINNs for Point Source Poisson</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="2D_unsteady.html">Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Reduced order model for three-dimensional unsteady flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technology-path">Technology Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-structure">Model structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-environment">Training environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hyperparameter-configuration">Hyperparameter configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset-loading">Dataset loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#loss-functions-and-optimizers">Loss functions and optimizers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train-function-and-data-sink">Train function and data sink</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-inference">Model inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#result-visualization">Result visualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_FNO3D.html">FNO for 3D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn2d.html">PeRCNN for 2D burgers Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn3d.html">PeRCNN for 3D Reaction-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Reduced order model for three-dimensional unsteady flow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_driven/flow_around_sphere.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="reduced-order-model-for-three-dimensional-unsteady-flow">
<h1>Reduced order model for three-dimensional unsteady flow<a class="headerlink" href="#reduced-order-model-for-three-dimensional-unsteady-flow" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindflow/en/data_driven/mindspore_flow_around_sphere.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindflow/en/data_driven/mindspore_flow_around_sphere.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindflow/docs/source_en/data_driven/flow_around_sphere.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Three-dimensional complex flows are prevalent in practical engineering problems, and effectively capturing and analyzing the flow field poses significant challenges. The CFD simulation of 3D flow fields involving complex geometries demands substantial computing resources due to the increased mesh degrees of freedom. Consequently, this limitation hinders the progress of downstream tasks like interactive design and real-time optimal control.</p>
<p>While there has been extensive exploration of deep learning technology for flow field modeling in recent years, most of the focus has remained on two-dimensional shapes. As a result, there is still a noticeable gap when applying these models to real-world engineering scenarios. The stronger spatial coupling effect in 3D data compared to 2D data is a primary reason for this disparity. Additionally, training neural networks with a large number of model parameters requires robust computing power
and ample storage resources.</p>
<p>For 3D unsteady flow, the reduced-order model based on the fully convolutional neural network called “<strong>ResUnet3D</strong>” can quickly establish the nonlinear mapping between snapshots of the 3D flow field, offering a promising approach to tackle these challenges.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>Acquiring high-precision three-dimensional flow field data poses challenges for the industry. However, this model takes a different approach by not relying on a large number of historical flow field snapshots for support.Instead, it directly extracts the potential characteristics of the flow field from the current snapshot <span class="math notranslate nohighlight">\(F^t\)</span> at a single moment. Subsequently, two strategies for feature decoding are proposed:</p>
<ol class="arabic simple">
<li><p>Low-dimensional multi-scale features can be decoded into incremental flow fields <span class="math notranslate nohighlight">\(\Delta {F}^t\)</span> amplified by a certain factor <span class="math notranslate nohighlight">\(scale\)</span>, enabling long-term predictions of the three-dimensional non-stationary field through an iterative strategy:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[scale\cdot \Delta {F^t}=f\left( F^t \right)\]</div>
<div class="math notranslate nohighlight">
\[F^{t+1}=F^{t}+\Delta {F^t}\]</div>
<ol class="arabic simple" start="2">
<li><p>The other is to directly decode it into the flow field of the future moment, but the data often needs to be normalized. Similarly, long-term predictions need to be achieved through iteration:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[F^{t+1}=f\left( F^t \right)\]</div>
</section>
<section id="technology-path">
<h2>Technology Path<a class="headerlink" href="#technology-path" title="Permalink to this headline"></a></h2>
<p>The main technical approach for the above-mentioned problem mainly includes the following steps:</p>
<ol class="arabic simple">
<li><p>Dataset loading;</p></li>
<li><p>Model construction;</p></li>
<li><p>Optimizer and loss function;</p></li>
<li><p>Model training;</p></li>
<li><p>Model inference;</p></li>
<li><p>Result visualization.</p></li>
</ol>
</section>
<section id="model-structure">
<h2>Model structure<a class="headerlink" href="#model-structure" title="Permalink to this headline"></a></h2>
<p>The proposed neural network model follows the paradigm of an encoder-decoder architecture, which exhibits a symmetrical U-shaped structure. The main difference lies in the replacement of traditional convolutions with convolutional residual blocks.</p>
<p><img alt="Drawing" src="../_images/ResUnet3D.jpg" /></p>
<ul class="simple">
<li><p><strong>Encoder</strong>: The left side of the network, known as the contracting path, is responsible for hierarchically extracting the latent features of the high-dimensional flow field. The encoder consists of four downsampled residual blocks, as illustrated in Fig(a). Downsampling is accomplished by utilizing convolutional operations with a stride of 2 instead of pooling operations. Following each residual block operation, the number of feature channels is doubled while the size of the feature map is
halved.</p></li>
</ul>
<ul class="simple">
<li><p><strong>Decoder</strong>: On the right side of the network, referred to as the expansive path, the low-dimensional features are upsampled. Correspondingly, the decoding part also includes four upsampling residual blocks, with the structure of the upsampling residual block shown in Fig(b). The first step involves the application of deconvolution to increase the size of the original features by a factor of two while reducing the number of feature channels. It should be noted that the upsampling output block
(c) responsible for the final output of the model discards the identity connection part in the upsampling residual block.</p></li>
</ul>
<ul class="simple">
<li><p><strong>Residual Connect</strong>:  In addition to the residual connections within the residual blocks, we also introduced skip connections in our model, indicated by solid gray arrows in . The increased number of residual connections helps in capturing low-frequency features of the high-dimensional flow field, further enriching the details of the flow field prediction.</p></li>
</ul>
<p><img alt="Drawing" src="../_images/blocks.jpg" /></p>
</section>
<section id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline"></a></h2>
<p>The dataset is a multidimensional array of flow snapshots of three-dimensional flows around sphere：</p>
<ul class="simple">
<li><p>The viscous flow around a three-dimensional sphere is a fundamental problem in fluid mechanics, particularly in engineering applications. For this research, a Reynolds number of Re=300 is chosen. At this value, the sphere’s wake will periodically shed hairpin-shaped vortices, resulting in pronounced unsteady characteristics.</p></li>
<li><p>The flow configuration and calculation details for flow around a sphere are given in the <a class="reference external" href="https://arxiv.org/abs/2307.07323">paper</a>. The final flow data set obtained Cartesian uniform interpolation method in this paper by is denoted as <span class="math notranslate nohighlight">\(F\in {{\mathbb{R}}^{T\times C\times H\times W\times D}}\)</span> in 6D×6D×6D 3d space, where <span class="math notranslate nohighlight">\(T=400\)</span> represents the number of snapshots, <span class="math notranslate nohighlight">\(C=4\)</span> represents the number of channels, representing pressure, streamwise velocity, normal velocity, and
spanwise velocity information respectively. Additionally, <span class="math notranslate nohighlight">\(H=128\)</span>, <span class="math notranslate nohighlight">\(W=64\)</span>, and <span class="math notranslate nohighlight">\(D=64\)</span> correspond to the height, width, and depth of the snapshots, respectively.</p></li>
<li><p><a class="reference external" href="https://download.mindspore.cn/mindscience/mindflow/dataset/applications/data_driven/3d_unsteady_flow">download link</a></p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.amp</span> <span class="kn">import</span> <span class="n">DynamicLossScaler</span><span class="p">,</span> <span class="n">auto_mixed_precision</span><span class="p">,</span> <span class="n">all_finite</span>

<span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>
<span class="kn">from</span> <span class="nn">mindflow.common</span> <span class="kn">import</span> <span class="n">get_warmup_cosine_annealing_lr</span>

<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">ResUnet3D</span><span class="p">,</span> <span class="n">create_dataset</span><span class="p">,</span> <span class="n">UnsteadyFlow3D</span><span class="p">,</span> <span class="n">check_file_path</span><span class="p">,</span> <span class="n">calculate_metric</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="training-environment">
<h2>Training environment<a class="headerlink" href="#training-environment" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>The static GRAPH of MindSpore framework is adopted for training.</p></li>
<li><p>Training can be done on GPU (default) or Ascend (single card).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse input args&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;model train for 3d unsteady flow&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;GRAPH&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GRAPH&quot;</span><span class="p">,</span> <span class="s2">&quot;PYNATIVE&quot;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Context mode, support &#39;GRAPH&#39;, &#39;PYNATIVE&#39;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--save_graphs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to save intermediate compilation graphs&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--save_graphs_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./graphs&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_target&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="s2">&quot;Ascend&quot;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The target device to run, support &#39;Ascend&#39;, &#39;GPU&#39;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--device_id&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ID of the target device&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config_file_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./config.yaml&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--norm&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to perform data normalization on original data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--residual_mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use indirect prediction mode&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scale&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use indirect prediction mode&quot;</span><span class="p">)</span>
    <span class="n">input_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">input_args</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;GRAPH&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">,</span>
                    <span class="n">save_graphs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_graphs</span><span class="p">,</span>
                    <span class="n">save_graphs_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_graphs_path</span><span class="p">,</span>
                    <span class="n">device_target</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_target</span><span class="p">,</span>
                    <span class="n">device_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
<span class="n">use_ascend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">attr_key</span><span class="o">=</span><span class="s1">&#39;device_target&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="hyperparameter-configuration">
<h2>Hyperparameter configuration<a class="headerlink" href="#hyperparameter-configuration" title="Permalink to this headline"></a></h2>
<p>Read several types of parameters from the configuration file, which are related to data, model, optimizer, and summary.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_file_path</span><span class="p">)</span>
<span class="n">data_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">model_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
<span class="n">optimizer_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
<span class="n">summary_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="dataset-loading">
<h2>Dataset loading<a class="headerlink" href="#dataset-loading" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>The downloaded data is the original flow data (original_data_0.npy), where the index can be used to distinguish different flow states.</p></li>
<li><p>The first run of the program will generate training (train_data_0.npy), validation (eval_data_0.npy) and inference (infer_data_0) datasets according to the configuration requirements of regularization, division ratio, etc.</p></li>
<li><p>The size of the training dataset is (T, C, D, H, W) -&gt; (300, 4, 64, 128, 64), and then it will be converted to MindSpore’s dedicated DatasetGenerator.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># data for training</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">data_params</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">residual_mode</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_loader</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># data for evaluating</span>
<span class="n">eval_loader</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">data_params</span><span class="p">,</span> <span class="n">is_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">residual_mode</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_loader</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="model-construction">
<h2>Model construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>Build a suitable ResUnet3D model by configuring the number of input channels (in.dims), the number of output channels (out.dims), the number of hidden channels in the first layer (base), and the initialization method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ResUnet3D</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;in_dims&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;out_dims&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="loss-functions-and-optimizers">
<h2>Loss functions and optimizers<a class="headerlink" href="#loss-functions-and-optimizers" title="Permalink to this headline"></a></h2>
<p>To suppress error accumulation during inference, we add a gradient loss term with weak physical interpretability to the original strength loss function, where only the first derivative is computed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="n">DynamicLossScaler</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">auto_mixed_precision</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">loss_scaler</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># prepare optimizer and loss function</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">get_warmup_cosine_annealing_lr</span><span class="p">(</span><span class="n">lr_init</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;initial_lr&#39;</span><span class="p">],</span>
                                    <span class="n">last_epoch</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;train_epochs&#39;</span><span class="p">],</span>
                                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                                    <span class="n">warmup_epochs</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;warmup_epochs&#39;</span><span class="p">])</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>

<span class="n">problem</span> <span class="o">=</span> <span class="n">UnsteadyFlow3D</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;loss_fn&#39;</span><span class="p">],</span> <span class="n">metric_fn</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;metric_fn&#39;</span><span class="p">],</span>
                         <span class="n">loss_weight</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;loss_weight&#39;</span><span class="p">],</span> <span class="n">dynamic_flag</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;dynamic_flag&#39;</span><span class="p">],</span>
                         <span class="n">t_in</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;t_in&#39;</span><span class="p">],</span> <span class="n">t_out</span><span class="o">=</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;t_out&#39;</span><span class="p">],</span>
                         <span class="n">residual</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">residual_mode</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="train-function-and-data-sink">
<h2>Train function and data sink<a class="headerlink" href="#train-function-and-data-sink" title="Permalink to this headline"></a></h2>
<p>With MindSpore&gt;= 2.0.0, you can train neural networks using functional programming paradigms, and single-step training functions are decorated with jit. The data_sink function is used to transfer the step-by-step training function and training dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward_fn</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_label</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_label</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">is_finite</span> <span class="o">=</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_finite</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
        <span class="n">loss_scaler</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">is_finite</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sink_process</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">data_sink</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">sink_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">summary_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_params</span><span class="p">[</span><span class="s1">&#39;summary_dir&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;norm-</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">norm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s2">&quot;resi-</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">residual_mode</span><span class="si">}</span><span class="s2"> scale-</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;loss_fn&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_dir</span><span class="p">,</span> <span class="s2">&quot;ckpt&quot;</span><span class="p">)</span>
<span class="n">check_file_path</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="model-training">
<h2>Model training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pid:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running in </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> mode within </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">device_target</span><span class="si">}</span><span class="s2"> device, using device id: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">device_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">cur_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;train_epochs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">local_time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">):</span>
        <span class="n">cur_loss</span> <span class="o">=</span> <span class="n">sink_process</span><span class="p">()</span>

    <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">local_time_beg</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">cur_epoch</span><span class="si">:</span><span class="s2">-4d</span><span class="si">}</span><span class="s2">  loss: </span><span class="si">{</span><span class="n">cur_loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="s2">  epoch time: </span><span class="si">{</span><span class="n">epoch_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_epoch</span> <span class="o">%</span> <span class="n">summary_params</span><span class="p">[</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># A uniform metric than total loss is unified as the evaluation standard</span>
        <span class="n">calculate_metric</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">)</span>
        <span class="n">mindspore</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ckpt-</span><span class="si">{</span><span class="n">cur_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start-to-End total training time: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pid: 3184621
Running in GRAPH mode within GPU device, using device id: 0.
epoch:    1  loss: 4.42149210  epoch time: 93.07s
epoch:    2  loss: 3.66354370  epoch time: 80.61s
epoch:    3  loss: 3.45540905  epoch time: 80.62s
epoch:    4  loss: 3.41599178  epoch time: 80.57s
epoch:    5  loss: 3.40474415  epoch time: 80.62s
epoch:    6  loss: 3.39673615  epoch time: 80.59s
epoch:    7  loss: 3.39119720  epoch time: 80.59s
epoch:    8  loss: 3.37303853  epoch time: 80.82s
epoch:    9  loss: 3.31753325  epoch time: 80.71s
epoch:   10  loss: 3.14250851  epoch time: 80.70s
================================Start Evaluation================================
mean metric: 1.36825517  eval total time:6.76
=================================End Evaluation=================================
epoch:   11  loss: 2.76249218  epoch time: 82.83s
epoch:   12  loss: 2.37564182  epoch time: 81.61s
epoch:   13  loss: 2.13626671  epoch time: 81.59s
epoch:   14  loss: 2.00457954  epoch time: 81.75s
epoch:   15  loss: 1.85440254  epoch time: 82.10s
epoch:   16  loss: 1.85113728  epoch time: 80.90s
epoch:   17  loss: 1.90822351  epoch time: 80.51s
epoch:   18  loss: 1.78560519  epoch time: 80.52s
epoch:   19  loss: 1.86209464  epoch time: 80.57s
epoch:   20  loss: 1.79454994  epoch time: 80.61s
================================Start Evaluation================================
mean metric: 0.44466619  eval total time:5.47
=================================End Evaluation=================================
Start-to-End total training time: 1646.58s
</pre></div></div>
</div>
</section>
<section id="model-inference">
<h2>Model inference<a class="headerlink" href="#model-inference" title="Permalink to this headline"></a></h2>
<p>After completing the model training, run <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/r0.6/MindFlow/applications/data_driven/flow_around_sphere/eval.py">eval.py</a> to control the read model path through both the console and configuration files. This will enable you to efficiently and accurately infer the long-term 3D flow field in the future, based on the initial flow field at any given moment.</p>
</section>
<section id="result-visualization">
<h2>Result visualization<a class="headerlink" href="#result-visualization" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>The changes in the pressure contour map of the <code class="docutils literal notranslate"><span class="pre">Z=0</span></code> section during trained indirect model inference are as follows：</p></li>
</ul>
<p><img alt="Drawing" src="../_images/P.gif" /></p>
<p>The periodic flow characteristics of different physical quantities are quickly and faithfully predicted by the reduced-order model.</p>
<ul class="simple">
<li><p>A 3D vorticity isosurface (<span class="math notranslate nohighlight">\(Q=0.0005\)</span>) plot colored according to flow velocity after two cycles is shown below:</p></li>
</ul>
<p><img alt="Drawing" src="../_images/Q.png" /></p>
<p>The hairpin-like shape of the vortex is basically the same, but the result predicted by ResUnet3D is obviously rough.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="2D_unsteady.html" class="btn btn-neutral float-left" title="Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="navier_stokes_FNO3D.html" class="btn btn-neutral float-right" title="FNO for 3D Navier-Stokes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>