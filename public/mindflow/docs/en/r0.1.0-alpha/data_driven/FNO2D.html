<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FNO for 2D Navier-Stokes &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1D Lax Tube" href="../cfd/lax_tube.html" />
    <link rel="prev" title="FNO for 1D Burgers" href="FNO1D.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindFlow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_ring.html">2D Poisson on a Ring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/sympy_pde_definition.html">Definition of Symbolic PDE Based on MindFlow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="dfyf.html">AI Industrial Flow Simulation Model——DongFang·YuFeng</a></li>
<li class="toctree-l1"><a class="reference internal" href="FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FNO for 2D Navier-Stokes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#navier-stokes-equation">Navier-Stokes equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technology-path">Technology Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fourier-neural-operator">Fourier Neural Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-dataset-construction">Training Dataset Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimizer-and-loss-function">Optimizer and Loss Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-solver">Define Solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#define-callback">Define Callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model Training</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_plus_data_driven/pdenet.html">Solve Inverse Problems of Differential Equations with PDE-Net and Realize Long-Term Prediction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.solver.html">mindflow.solver</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FNO for 2D Navier-Stokes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_driven/FNO2D.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="fno-for-2d-navier-stokes">
<h1>FNO for 2D Navier-Stokes<a class="headerlink" href="#fno-for-2d-navier-stokes" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r2.0.0-alpha/mindflow/en/data_driven/mindspore_FNO2D.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_notebook_en.png" /></a> <a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r2.0.0-alpha/mindflow/en/data_driven/mindspore_FNO2D.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_download_code_en.png" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.0.0-alpha/docs/mindflow/docs/source_en/data_driven/FNO2D.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_source_en.png" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Computational fluid dynamics is one of the most important techniques in the field of fluid mechanics in the 21st century. The flow analysis, prediction and control can be realized by solving the governing equations of fluid mechanics by numerical method. Traditional finite element method (FEM) and finite difference method (FDM) are inefficient because of the complex simulation process (physical modeling, meshing, numerical discretization, iterative solution, etc.) and high computing costs.
Therefore, it is necessary to improve the efficiency of fluid simulation with AI.</p>
<p>Machine learning methods provide a new paradigm for scientific computing by providing a fast solver similar to traditional methods. Classical neural networks learn mappings between finite dimensional spaces and can only learn solutions related to specific discretizations. Different from traditional neural networks, Fourier Neural Operator (FNO) is a new deep learning architecture that can learn mappings between infinite-dimensional function spaces. It directly learns mappings from arbitrary
function parameters to solutions to solve a class of partial differential equations. Therefore, it has a stronger generalization capability. More information can be found in the paper, <a class="reference external" href="https://arxiv.org/abs/2010.08895">Fourier Neural Operator for Parametric Partial Differential Equations</a>.</p>
<p>This tutorial describes how to solve the Navier-Stokes equation using Fourier neural operator.</p>
</section>
<section id="navier-stokes-equation">
<h2>Navier-Stokes equation<a class="headerlink" href="#navier-stokes-equation" title="Permalink to this headline"></a></h2>
<p>Navier-Stokes equation is a classical equation in computational fluid dynamics. It is a set of partial differential equations describing the conservation of fluid momentum, called N-S equation for short. Its vorticity form in two-dimensional incompressible flows is as follows:</p>
<div class="math notranslate nohighlight">
\[\partial_t w(x, t)+u(x, t) \cdot \nabla w(x, t)=\nu \Delta w(x, t)+f(x), \quad x \in(0,1)^2, t \in(0, T]\]</div>
<div class="math notranslate nohighlight">
\[\nabla \cdot u(x, t)=0, \quad x \in(0,1)^2, t \in[0, T]\]</div>
<div class="math notranslate nohighlight">
\[w(x, 0)=w_0(x), \quad x \in(0,1)^2\]</div>
<p>where <span class="math notranslate nohighlight">\(u\)</span> is the velocity field, <span class="math notranslate nohighlight">\(w=\nabla \times u\)</span> is the vorticity, <span class="math notranslate nohighlight">\(w_0(x)\)</span> is the initial vorticity, <span class="math notranslate nohighlight">\(\nu\)</span> is the viscosity coefficient, <span class="math notranslate nohighlight">\(f(x)\)</span> is the forcing function.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>We aim to solve two-dimensional incompressible N-S equation by learning the operator mapping from each time step to the next time step:</p>
<div class="math notranslate nohighlight">
\[w_t \mapsto w(\cdot, t+1)\]</div>
</section>
<section id="technology-path">
<h2>Technology Path<a class="headerlink" href="#technology-path" title="Permalink to this headline"></a></h2>
<p>MindFlow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Training Dataset Construction.</p></li>
<li><p>Model Construction.</p></li>
<li><p>Optimizer and Loss Function.</p></li>
<li><p>Define Solver.</p></li>
<li><p>Define Callback.</p></li>
<li><p>Model Training.</p></li>
</ol>
</section>
<section id="fourier-neural-operator">
<h2>Fourier Neural Operator<a class="headerlink" href="#fourier-neural-operator" title="Permalink to this headline"></a></h2>
<p>The following figure shows the architecture of the Fourier Neural Operator model. In the figure, <span class="math notranslate nohighlight">\(w_0(x)\)</span> represents the initial vorticity. The input vector is lifted to higher dimension channel space by the lifting layer. Then the mapping result is used as the input of the Fourier layer to perform nonlinear transformation of the frequency domain information. Finally, the decoding layer maps the transformation result to the final prediction result <span class="math notranslate nohighlight">\(w_1(x)\)</span>.</p>
<p>The Fourier Neural Operator consists of the lifting Layer, Fourier Layers, and the decoding Layer.</p>
<p><img alt="Fourier Neural Operator model structure" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/docs/mindflow/docs/source_en/data_driven/images/FNO.png" /></p>
<p>Fourier layers: Start from input V. On top: apply the Fourier transform <span class="math notranslate nohighlight">\(\mathcal{F}\)</span>; a linear transform R on the lower Fourier modes and filters out the higher modes; then apply the inverse Fourier transform <span class="math notranslate nohighlight">\(\mathcal{F}^{-1}\)</span>. On the bottom: apply a local linear transform W. Finally, the Fourier Layer output vector is obtained through the activation function.</p>
<p><img alt="Fourier Layer structure" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/docs/mindflow/docs/source_en/data_driven/images/FNO-2.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">DynamicLossScaleManager</span><span class="p">,</span> <span class="n">LossMonitor</span><span class="p">,</span> <span class="n">TimeMonitor</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<br/></pre></div>
</div>
</div>
<p>The following <code class="docutils literal notranslate"><span class="pre">src</span></code> pacakage can be downloaded in <a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/r0.2.0-alpha/MindFlow/applications/data_driven/navier_stokes/src">applications/data_driven/navier_stokes/src</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindflow</span> <span class="kn">import</span> <span class="n">FNO2D</span><span class="p">,</span> <span class="n">RelativeRMSELoss</span><span class="p">,</span> <span class="n">Solver</span><span class="p">,</span> <span class="n">load_yaml_config</span><span class="p">,</span> <span class="n">get_warmup_cosine_annealing_lr</span>

<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">PredictCallback</span><span class="p">,</span> <span class="n">create_training_dataset</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s1">&#39;navier_stokes_2d.yaml&#39;</span><span class="p">)</span>
<span class="n">data_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">model_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
<span class="n">optimizer_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span>
<span class="n">callback_params</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="training-dataset-construction">
<h2>Training Dataset Construction<a class="headerlink" href="#training-dataset-construction" title="Permalink to this headline"></a></h2>
<p>Download the training and test dataset: <a class="reference external" href="https://download.mindspore.cn/mindscience/mindflow/dataset/applications/data_driven/navier_stokes/dataset/">data_driven/navier_stokes/dataset</a> .</p>
<p>In this case, training data sets and test data sets are generated according to Zongyi Li’s data set in <a class="reference external" href="https://arxiv.org/pdf/2010.08895.pdf">Fourier Neural Operator for Parametric Partial Differential Equations</a> . The settings are as follows:</p>
<p>The initial condition <span class="math notranslate nohighlight">\(w_0(x)\)</span> is generated according to periodic boundary conditions:</p>
<div class="math notranslate nohighlight">
\[w_0 \sim \mu, \mu=\mathcal{N}\left(0,7^{3 / 2}(-\Delta+49 I)^{-2.5}\right)\]</div>
<p>The forcing function is defined as:</p>
<div class="math notranslate nohighlight">
\[f(x)=0.1\left(\sin \left(2 \pi\left(x_1+x_2\right)\right)+\right.\cos(2 \pi(x_1+x_2)))\]</div>
<p>We use a time-step of 1e-4 for the Crank–Nicolson scheme in the data-generated process where we record the solution every t = 1 time units. All data are generated on a 256 × 256 grid and are downsampled to 64 × 64. In this case, the viscosity coefficient <span class="math notranslate nohighlight">\(\nu=1e-5\)</span>, the number of samples in the training set is 19000, and the number of samples in the test set is 3800.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">create_training_dataset</span><span class="p">(</span><span class="n">data_params</span><span class="p">,</span> <span class="n">input_resolution</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;input_resolution&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;test/inputs.npy&quot;</span><span class="p">))</span>
<span class="n">test_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;test/label.npy&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data preparation finished
</pre></div></div>
</div>
</section>
<section id="model-construction">
<h2>Model Construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>The network is composed of 1 lifting layer, multiple Fourier layers and 1 decoding layer:</p>
<ul class="simple">
<li><p>The Lifting layer corresponds to the <code class="docutils literal notranslate"><span class="pre">FNO2D.fc0</span></code> in the case, and maps the output data <span class="math notranslate nohighlight">\(x\)</span> to the high dimension;</p></li>
<li><p>Multi-layer Fourier Layer corresponds to the <code class="docutils literal notranslate"><span class="pre">FNO2D.fno_seq</span></code> in the case. Discrete Fourier transform is used to realize the conversion between time domain and frequency domain;</p></li>
<li><p>The Decoding layer corresponds to <code class="docutils literal notranslate"><span class="pre">FNO2D.fc1</span></code> and <code class="docutils literal notranslate"><span class="pre">FNO2D.fc2</span></code> in the case to obtain the final predictive value.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">FNO2D</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;in_channels&quot;</span><span class="p">],</span>
              <span class="n">out_channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;out_channels&quot;</span><span class="p">],</span>
              <span class="n">resolution</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;input_resolution&quot;</span><span class="p">],</span>
              <span class="n">modes</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;modes&quot;</span><span class="p">],</span>
              <span class="n">channels</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span>
              <span class="n">depth</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span>
              <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="optimizer-and-loss-function">
<h2>Optimizer and Loss Function<a class="headerlink" href="#optimizer-and-loss-function" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">get_warmup_cosine_annealing_lr</span><span class="p">(</span><span class="n">lr_init</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;initial_lr&quot;</span><span class="p">],</span>
                                    <span class="n">last_epoch</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;train_epochs&quot;</span><span class="p">],</span>
                                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                                    <span class="n">warmup_epochs</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;warmup_epochs&quot;</span><span class="p">])</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
<span class="n">loss_scale</span> <span class="o">=</span> <span class="n">DynamicLossScaleManager</span><span class="p">()</span>

<span class="c1"># prepare loss function</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">RelativeRMSELoss</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="define-solver">
<h2>Define Solver<a class="headerlink" href="#define-solver" title="Permalink to this headline"></a></h2>
<p>Solver class is the interface for model training and evaluation. Given the optimizer, network model, loss function, loss scaling strategy, etc. the solver object can be defined easily. Parameters of <code class="docutils literal notranslate"><span class="pre">optimizer_params</span></code> and <code class="docutils literal notranslate"><span class="pre">model_params</span></code> can be modified in <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/r0.2.0-alpha/MindFlow/applications/data_driven/navier_stokes/navier_stokes_2d.yaml">configuration file</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">,</span>
                <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="define-callback">
<h2>Define Callback<a class="headerlink" href="#define-callback" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">callback_params</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="s1">&#39;FNO2D&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_dir</span><span class="p">)</span>
<span class="n">pred_cb</span> <span class="o">=</span> <span class="n">PredictCallback</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                          <span class="n">inputs</span><span class="o">=</span><span class="n">test_input</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="n">test_label</span><span class="p">,</span>
                          <span class="n">config</span><span class="o">=</span><span class="n">callback_params</span><span class="p">,</span>
                          <span class="n">summary_dir</span><span class="o">=</span><span class="n">summary_dir</span><span class="p">)</span>

<span class="n">ckpt_config</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">callback_params</span><span class="p">[</span><span class="s2">&quot;save_checkpoint_steps&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">steps_per_epoch</span><span class="p">,</span>
                               <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">callback_params</span><span class="p">[</span><span class="s2">&quot;keep_checkpoint_max&quot;</span><span class="p">])</span>
<span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_dir</span><span class="p">,</span> <span class="s2">&quot;ckpt&quot;</span><span class="p">)</span>
<span class="n">ckpt_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                          <span class="n">directory</span><span class="o">=</span><span class="n">ckpt_dir</span><span class="p">,</span>
                          <span class="n">config</span><span class="o">=</span><span class="n">ckpt_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./FNO2D
check test dataset shape: (200, 19, 64, 64, 1), (200, 19, 64, 64, 1)
</pre></div></div>
</div>
</section>
<section id="model-training">
<h2>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>Invoke the Solver interface for model training and callback interface for evaluation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">[</span><span class="s2">&quot;train_epochs&quot;</span><span class="p">],</span>
             <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
             <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossMonitor</span><span class="p">(),</span> <span class="n">TimeMonitor</span><span class="p">(),</span> <span class="n">pred_cb</span><span class="p">,</span> <span class="n">ckpt_cb</span><span class="p">],</span>
             <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch: 1 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 2.07)
Train epoch time: 36526.785 ms, per step time: 36.527 ms
epoch: 2 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 2.00379)
Train epoch time: 29215.492 ms, per step time: 29.215 ms
epoch: 3 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.40253)
Train epoch time: 29217.016 ms, per step time: 29.217 ms
epoch: 4 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.79683)
Train epoch time: 29243.756 ms, per step time: 29.244 ms
epoch: 5 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.42917)
Train epoch time: 29197.400 ms, per step time: 29.197 ms
epoch: 6 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.24265)
Train epoch time: 29199.672 ms, per step time: 29.200 ms
epoch: 7 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.48525)
Train epoch time: 29193.341 ms, per step time: 29.193 ms
epoch: 8 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.2069)
Train epoch time: 29198.366 ms, per step time: 29.198 ms
epoch: 9 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.17752)
Train epoch time: 29210.540 ms, per step time: 29.211 ms
epoch: 10 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 1.25935)
Train epoch time: 29180.896 ms, per step time: 29.181 ms
================================Start Evaluation================================
mean rel_rmse_error: 0.14311510016862303
=================================End Evaluation=================================
predict total time: 16.270995616912842 s
...
epoch: 141 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.667819)
Train epoch time: 29181.800 ms, per step time: 29.182 ms
epoch: 142 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.610858)
Train epoch time: 29203.687 ms, per step time: 29.204 ms
epoch: 143 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.616083)
Train epoch time: 29199.107 ms, per step time: 29.199 ms
epoch: 144 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.609115)
Train epoch time: 29302.156 ms, per step time: 29.302 ms
epoch: 145 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.518936)
Train epoch time: 29234.649 ms, per step time: 29.235 ms
epoch: 146 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.822775)
Train epoch time: 29228.318 ms, per step time: 29.228 ms
epoch: 147 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.802282)
Train epoch time: 29231.589 ms, per step time: 29.232 ms
epoch: 148 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.669333)
Train epoch time: 29285.277 ms, per step time: 29.285 ms
epoch: 149 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.615759)
Train epoch time: 29311.589 ms, per step time: 29.312 ms
epoch: 150 step: 1000, loss is Tensor(shape=[], dtype=Float32, value= 0.75713)
Train epoch time: 29280.815 ms, per step time: 29.281 ms
================================Start Evaluation================================
mean rel_rmse_error: 0.06585168887209147
=================================End Evaluation=================================
predict total time: 12.599207639694214 s
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FNO1D.html" class="btn btn-neutral float-left" title="FNO for 1D Burgers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../cfd/lax_tube.html" class="btn btn-neutral float-right" title="1D Lax Tube" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>