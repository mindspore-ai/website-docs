<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDE-Net for Convection-Diffusion Equation &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PeRCNN for 2D burgers Equation" href="percnn2d.html" />
    <link rel="prev" title="FNO for 3D Navier-Stokes" href="../data_driven/navier_stokes_FNO3D.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes_inverse.html">Inverse Navier-Stokes Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/boltzmannD1V3.html">Neural Representation Method for Boltzmann Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/kovasznay.html">PINNs for Kovasznay Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/periodic_hill.html">Raynold-averaged Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_point_source.html">PINNs for Point Source Poisson</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_unsteady.html">Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/flow_around_sphere.html">Reduced order model for three-dimensional unsteady flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO3D.html">FNO for 3D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">PDE-Net for Convection-Diffusion Equation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#governing-equation">Governing Equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-structure-of-the-pde-net">Model Structure of the PDE-Net</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technology-path">Technology Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#single-step-training">Single Step Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multi-step-training">Multi-step Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-evaluation-and-visualization">Model Evaluation and Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plot-coefficient">Plot Coefficient</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-test-error">Plot Test Error</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-extrapolation-error">Plot Extrapolation Error</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="percnn2d.html">PeRCNN for 2D burgers Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="percnn3d.html">PeRCNN for 3D Reaction-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PDE-Net for Convection-Diffusion Equation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_mechanism_fusion/pde_net.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="pde-net-for-convection-diffusion-equation">
<h1>PDE-Net for Convection-Diffusion Equation<a class="headerlink" href="#pde-net-for-convection-diffusion-equation" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/data_mechanism_fusion/mindspore_pde_net.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/data_mechanism_fusion/mindspore_pde_net.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.2/docs/mindflow/docs/source_en/data_mechanism_fusion/pde_net.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>PDE-Net is a feedforward deep network proposed by Zichao Long et al. to learn partial differential equations from data, predict the dynamic characteristics of complex systems accurately and uncover potential PDE models. The basic idea of PDE-Net is to approximate differential operators by learning convolution kernels (filters). Neural networks or other machine learning methods are applied to fit unknown nonlinear responses. Numerical experiments show that the model can identify the observed
dynamical equations and predict the dynamical behavior over a relatively long period of time, even in noisy environments. More information can be found in <a class="reference external" href="https://arxiv.org/abs/1710.09668">PDE-Net: Learning PDEs from Data</a>.</p>
<p>This notebook requires <strong>MindSpore version &gt;= 2.0.0</strong> to support new APIs including: <em>mindspore.jit, mindspore.jit_class, mindspore.data_sink</em>.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>This case solves the inverse problem of convection-diffusion partial differential equations with variable parameters and realizes long-term prediction.</p>
</section>
<section id="governing-equation">
<h2>Governing Equation<a class="headerlink" href="#governing-equation" title="Permalink to this headline"></a></h2>
<p>In this case, the convection-diffusion equation is of the form:</p>
<div class="math notranslate nohighlight">
\[u_t = a(x,y) u_x + b(x,y) u_y + c u_{xx} + d u_{yy}, \quad (x,y) \in[0,2 \pi] \times[0,2 \pi]\]</div>
<div class="math notranslate nohighlight">
\[u|_{t=0} = u_0(x,y)\]</div>
<p>The coefficients of each derivative are:</p>
<div class="math notranslate nohighlight">
\[a(x,y)=0.5(cos(y)+x(2\pi-x)sin(x))+0.6 \quad
b(x,y)=2(cos(y)+sin(x))+0.8\]</div>
<div class="math notranslate nohighlight">
\[c=0.2 \quad
d=0.3\]</div>
</section>
<section id="model-structure-of-the-pde-net">
<h2>Model Structure of the PDE-Net<a class="headerlink" href="#model-structure-of-the-pde-net" title="Permalink to this headline"></a></h2>
<p>The PDE-Net consists of multiple <span class="math notranslate nohighlight">\(\delta T\)</span> Blocks in series to implement prediction of long sequence information. Each <span class="math notranslate nohighlight">\(\delta T\)</span> Block includes several moment matrixes of trainable parameters. The matrixes can be converted to convolution kernels according to a mapping relationship. Thereby the derivatives of the physical field can be obtained. After linearly combining the derivative and its corresponding physical quantity, the information of the next time step can be deduced by
using the forward Euler method.</p>
<p><img alt="Pdenet1" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/docs/mindflow/docs/source_en/data_mechanism_fusion/images/pdenet-1.jpg" /></p>
<p><img alt="Pdenet2" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/docs/mindflow/docs/source_en/data_mechanism_fusion/images/pdenet-2.jpg" /></p>
</section>
<section id="technology-path">
<h2>Technology Path<a class="headerlink" href="#technology-path" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Model Construction.</p></li>
<li><p>Single Step Training.</p></li>
<li><p>Multi-step Training.</p></li>
<li><p>Model Evaluation and Visualization.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore</span>
<span class="kn">from</span> <span class="nn">mindspore.common</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">mindspore.train.serialization</span> <span class="kn">import</span> <span class="n">load_param_into_net</span>
</pre></div>
</div>
</div>
<p>The following <code class="docutils literal notranslate"><span class="pre">src</span></code> pacakage can be downloaded in <a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/r0.6/MindFlow/applications/data_mechanism_fusion/pde_net/src">applications/data_mechanism_fusion/pde_net/src</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindflow.cell</span> <span class="kn">import</span> <span class="n">PDENet</span>
<span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>
<span class="kn">from</span> <span class="nn">mindflow.loss</span> <span class="kn">import</span> <span class="n">get_loss_metric</span><span class="p">,</span> <span class="n">RelativeRMSELoss</span>
<span class="kn">from</span> <span class="nn">mindflow.pde</span> <span class="kn">import</span> <span class="n">UnsteadyFlowWithLoss</span>

<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">init_model</span><span class="p">,</span> <span class="n">create_dataset</span><span class="p">,</span> <span class="n">calculate_lp_loss_error</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">make_dir</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">get_param_dic</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">plot_coe</span><span class="p">,</span> <span class="n">plot_extrapolation_error</span><span class="p">,</span> <span class="n">get_label_coe</span><span class="p">,</span> <span class="n">plot_test_error</span>
</pre></div>
</div>
</div>
<p>Parameter can be modified in <a class="reference external" href="https://gitee.com/mindspore/mindscience/blob/r0.6/MindFlow/applications/data_mechanism_fusion/pde_net/configs/pde_net.yaml">configuration file</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mindspore</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mindspore</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load configuration yaml</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s1">&#39;pde_net.yaml&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="model-construction">
<h2>Model Construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow provides the <code class="docutils literal notranslate"><span class="pre">PDENet</span></code> interface to directly create a PDE-Net model. You need to specify the width, height, data depth, boundary condition, and highest order of fitting.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PDENet</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">],</span>
                  <span class="n">width</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">],</span>
                  <span class="n">channels</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">],</span>
                  <span class="n">kernel_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;kernel_size&quot;</span><span class="p">],</span>
                  <span class="n">max_order</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_order&quot;</span><span class="p">],</span>
                  <span class="n">dx</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">],</span>
                  <span class="n">dy</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">],</span>
                  <span class="n">dt</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">],</span>
                  <span class="n">periodic</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;perodic_padding&quot;</span><span class="p">],</span>
                  <span class="n">enable_moment</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;enable_moment&quot;</span><span class="p">],</span>
                  <span class="n">if_fronzen</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;if_frozen&quot;</span><span class="p">],</span>
                  <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="single-step-training">
<h2>Single Step Training<a class="headerlink" href="#single-step-training" title="Permalink to this headline"></a></h2>
<p>The parameters of each <span class="math notranslate nohighlight">\(\delta T\)</span> block are shared. Therefore, the model is trained one by one based on the number of connected <span class="math notranslate nohighlight">\(\delta T\)</span> blocks. When step is 1, the model is in the warm-up phase. The moments of the PDE-Net are frozen. The parameters in the moments are not involved in training. Each time a <span class="math notranslate nohighlight">\(\delta T\)</span> block is added, the program generates data and reads data sets. After the model is initialized, the program loads the checkpoint trained in the previous step,
defines the optimizer, mode, and loss function. During training process, the model reflects the model performance in real time based on the callback function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_single_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;train PDE-Net with advancing steps&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current step for train loop: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">epoch</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>
    <span class="n">warm_up_epoch_scale</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">if_fronzen</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">warm_up_epoch_scale</span> <span class="o">*</span> <span class="n">epoch</span>
    <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">get_param_dic</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load pre-trained model successfully&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">get_param_dic</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load pre-trained model successfully&quot;</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">UnsteadyFlowWithLoss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">t_out</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">RelativeRMSELoss</span><span class="p">(),</span> <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;NTCHW&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward_fn</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">uT</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">uT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">uT</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">uT</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="n">sink_process</span> <span class="o">=</span> <span class="n">mindspore</span><span class="o">.</span><span class="n">data_sink</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">sink_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cur_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="n">local_time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">cur_loss</span> <span class="o">=</span> <span class="n">sink_process</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch: </span><span class="si">%s</span><span class="s2">, loss is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_loss</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">local_time_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">epoch_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_time_end</span> <span class="o">-</span> <span class="n">local_time_beg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">step_seconds</span> <span class="o">=</span> <span class="n">epoch_seconds</span> <span class="o">/</span> <span class="n">steps</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train epoch time: </span><span class="si">{:5.3f}</span><span class="s2"> ms, per step time: </span><span class="si">{:5.3f}</span><span class="s2"> ms&quot;</span><span class="o">.</span><span class="n">format</span>
              <span class="p">(</span><span class="n">epoch_seconds</span><span class="p">,</span> <span class="n">step_seconds</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cur_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;save_epoch_interval&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ckpt_file_name</span> <span class="o">=</span> <span class="s2">&quot;ckpt/step_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="n">ckpt_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">):</span>
                <span class="n">make_dir</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">)</span>
            <span class="n">ckpt_name</span> <span class="o">=</span> <span class="s2">&quot;pdenet-</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">mindspore</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">ckpt_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cur_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;eval_interval&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">calculate_lp_loss_error</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="multi-step-training">
<h2>Multi-step Training<a class="headerlink" href="#multi-step-training" title="Permalink to this headline"></a></h2>
<p>The PDE-Net is trained step by step. With <strong>MindSpore version &gt;= 2.0.0</strong>, we can use the functional programming for training neural networks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;multi_step&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;train_step</span><span class="si">{}</span><span class="s2">.mindrecord&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">])</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_train_dataset</span><span class="p">()</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">scheduler</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;multi_step&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;learning_rate_reduce_times&quot;</span><span class="p">]),</span> <span class="n">step</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
        <span class="n">train_single_step</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mindrecord_data_dir&quot;</span><span class="p">]):</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mindrecord_data_dir&quot;</span><span class="p">])</span>
<span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mindrecorder saved
Current step for train loop: 1
epoch: 1, loss is 313.45258
Train epoch time: 7294.444 ms, per step time: 7294.444 ms
epoch: 2, loss is 283.09055
Train epoch time: 15.857 ms, per step time: 15.857 ms
epoch: 3, loss is 292.2815
Train epoch time: 16.684 ms, per step time: 16.684 ms
epoch: 4, loss is 300.3354
Train epoch time: 18.559 ms, per step time: 18.559 ms
epoch: 5, loss is 295.53436
Train epoch time: 16.430 ms, per step time: 16.430 ms
epoch: 6, loss is 289.45068
Train epoch time: 8.752 ms, per step time: 8.752 ms
epoch: 7, loss is 297.86658
Train epoch time: 10.015 ms, per step time: 10.015 ms
epoch: 8, loss is 269.71762
Train epoch time: 9.050 ms, per step time: 9.050 ms
epoch: 9, loss is 298.23706
Train epoch time: 8.361 ms, per step time: 8.361 ms
epoch: 10, loss is 271.063
Train epoch time: 8.056 ms, per step time: 8.056 ms
================================Start Evaluation================================
LpLoss_error: 15.921201
=================================End Evaluation=================================
...
predict total time: 0.6082212924957275 s
epoch: 491, loss is 0.6402923
Train epoch time: 135.562 ms, per step time: 135.562 ms
epoch: 492, loss is 0.64142
Train epoch time: 115.278 ms, per step time: 115.278 ms
epoch: 493, loss is 0.61553574
Train epoch time: 119.042 ms, per step time: 119.042 ms
epoch: 494, loss is 0.644715
Train epoch time: 111.061 ms, per step time: 111.061 ms
epoch: 495, loss is 0.64503396
Train epoch time: 120.771 ms, per step time: 120.771 ms
epoch: 496, loss is 0.6481593
Train epoch time: 111.252 ms, per step time: 111.252 ms
epoch: 497, loss is 0.6493112
Train epoch time: 110.378 ms, per step time: 110.378 ms
epoch: 498, loss is 0.6368339
Train epoch time: 111.505 ms, per step time: 111.505 ms
epoch: 499, loss is 0.6521274
Train epoch time: 113.217 ms, per step time: 113.217 ms
epoch: 500, loss is 0.65510833
Train epoch time: 115.729 ms, per step time: 115.729 ms
================================Start Evaluation================================
LpLoss_error: 0.040348217
=================================End Evaluation=================================
predict total time: 0.6067502498626709 s
</pre></div></div>
</div>
</section>
<section id="model-evaluation-and-visualization">
<h2>Model Evaluation and Visualization<a class="headerlink" href="#model-evaluation-and-visualization" title="Permalink to this headline"></a></h2>
<p>After the model training is complete, the following figure shows the comparison between the prediction result and label.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">test_data_size</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">get_param_dic</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;multi_step&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">])</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<section id="plot-coefficient">
<h3>Plot Coefficient<a class="headerlink" href="#plot-coefficient" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coe_label</span> <span class="o">=</span> <span class="n">get_label_coe</span><span class="p">(</span><span class="n">max_order</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_order&quot;</span><span class="p">],</span> <span class="n">resolution</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">])</span>
<span class="n">coes_out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;figure_out_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;coes&quot;</span><span class="p">)</span>
<span class="n">plot_coe</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coe</span><span class="p">,</span> <span class="n">coes_out_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;coe_trained&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Coefficient Regression Results of the PDE&quot;</span><span class="p">)</span>
<span class="n">plot_coe</span><span class="p">(</span><span class="n">coe_label</span><span class="p">,</span> <span class="n">coes_out_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;coe_label&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Data Labels for the Coefficients of the PDE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/data_mechanism_fusion_pde_net_22_0.png" src="../_images/data_mechanism_fusion_pde_net_22_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/data_mechanism_fusion_pde_net_22_1.png" src="../_images/data_mechanism_fusion_pde_net_22_1.png" />
</div>
</div>
</section>
<section id="plot-test-error">
<h3>Plot Test Error<a class="headerlink" href="#plot-test-error" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;eval.mindrecord&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="o">=</span><span class="n">test_data_size</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_test_dataset</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
<span class="n">iterator_test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
<span class="n">final_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">iterator_test_dataset</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot_test_error</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">get_loss_metric</span><span class="p">(</span><span class="s2">&quot;mse&quot;</span><span class="p">),</span> <span class="n">final_item</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mesh_size&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;figure_out_dir&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mindrecorder saved
sample 20, MSE Loss 0.061236363
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/data_mechanism_fusion_pde_net_24_1.png" src="../_images/data_mechanism_fusion_pde_net_24_1.png" />
</div>
</div>
</section>
<section id="plot-extrapolation-error">
<h3>Plot Extrapolation Error<a class="headerlink" href="#plot-extrapolation-error" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_step</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">max_step</span><span class="p">,</span> <span class="s2">&quot;extrapolation.mindrecord&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
<span class="n">plot_extrapolation_error</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mindrecorder saved
step = 1, p25 = 0.06405, p75 = 0.08643
step = 2, p25 = 0.05012, p75 = 0.08393
step = 3, p25 = 0.06112, p75 = 0.10304
step = 4, p25 = 0.06977, p75 = 0.11740
step = 5, p25 = 0.07448, p75 = 0.12558
step = 6, p25 = 0.07964, p75 = 0.13329
step = 7, p25 = 0.08389, p75 = 0.14144
step = 8, p25 = 0.08721, p75 = 0.14411
step = 9, p25 = 0.08933, p75 = 0.14618
step = 10, p25 = 0.09413, p75 = 0.14660
step = 11, p25 = 0.09456, p75 = 0.14647
step = 12, p25 = 0.09532, p75 = 0.15166
step = 13, p25 = 0.09663, p75 = 0.15069
step = 14, p25 = 0.10087, p75 = 0.14878
step = 15, p25 = 0.10134, p75 = 0.14877
step = 16, p25 = 0.10700, p75 = 0.14848
step = 17, p25 = 0.10862, p75 = 0.15084
step = 18, p25 = 0.11188, p75 = 0.15105
step = 19, p25 = 0.11380, p75 = 0.15106
step = 20, p25 = 0.11437, p75 = 0.15068
step = 21, p25 = 0.11436, p75 = 0.15261
step = 22, p25 = 0.11572, p75 = 0.15087
step = 23, p25 = 0.11534, p75 = 0.15267
step = 24, p25 = 0.11588, p75 = 0.15540
step = 25, p25 = 0.11642, p75 = 0.15679
step = 26, p25 = 0.11598, p75 = 0.15700
step = 27, p25 = 0.11619, p75 = 0.15895
step = 28, p25 = 0.11611, p75 = 0.16042
step = 29, p25 = 0.11668, p75 = 0.16299
step = 30, p25 = 0.11663, p75 = 0.16413
step = 31, p25 = 0.11826, p75 = 0.16518
step = 32, p25 = 0.11898, p75 = 0.16673
step = 33, p25 = 0.11977, p75 = 0.16929
step = 34, p25 = 0.12110, p75 = 0.16919
step = 35, p25 = 0.12041, p75 = 0.17030
step = 36, p25 = 0.12223, p75 = 0.17150
step = 37, p25 = 0.12190, p75 = 0.17301
step = 38, p25 = 0.12270, p75 = 0.17389
step = 39, p25 = 0.12147, p75 = 0.17460
step = 40, p25 = 0.12005, p75 = 0.17384
step = 41, p25 = 0.12144, p75 = 0.17257
step = 42, p25 = 0.11986, p75 = 0.17334
step = 43, p25 = 0.11940, p75 = 0.17336
step = 44, p25 = 0.12085, p75 = 0.17301
step = 45, p25 = 0.11940, p75 = 0.17372
step = 46, p25 = 0.11919, p75 = 0.17274
step = 47, p25 = 0.12200, p75 = 0.17317
step = 48, p25 = 0.12044, p75 = 0.17336
step = 49, p25 = 0.12178, p75 = 0.17478
step = 50, p25 = 0.12355, p75 = 0.17511
step = 51, p25 = 0.12578, p75 = 0.17709
step = 52, p25 = 0.12434, p75 = 0.17895
step = 53, p25 = 0.12512, p75 = 0.18118
step = 54, p25 = 0.12532, p75 = 0.17828
step = 55, p25 = 0.12323, p75 = 0.18043
step = 56, p25 = 0.12300, p75 = 0.17973
step = 57, p25 = 0.12319, p75 = 0.17869
step = 58, p25 = 0.12315, p75 = 0.17695
step = 59, p25 = 0.12245, p75 = 0.17721
step = 60, p25 = 0.12120, p75 = 0.17679
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/data_mechanism_fusion_pde_net_26_1.png" src="../_images/data_mechanism_fusion_pde_net_26_1.png" />
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../data_driven/navier_stokes_FNO3D.html" class="btn btn-neutral float-left" title="FNO for 3D Navier-Stokes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="percnn2d.html" class="btn btn-neutral float-right" title="PeRCNN for 2D burgers Equation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>