<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PeRCNN for 3D Reaction-Diffusion Equation &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1D Lax Tube" href="../cfd_solver/lax_tube.html" />
    <link rel="prev" title="PeRCNN for 2D burgers Equation" href="percnn2d.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/navier_stokes_inverse.html">Inverse Navier-Stokes Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/boltzmannD1V3.html">Neural Representation Method for Boltzmann Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/kovasznay.html">PINNs for Kovasznay Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/periodic_hill.html">Raynold-averaged Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../physics_driven/poisson_point_source.html">PINNs for Point Source Poisson</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_unsteady.html">Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/flow_around_sphere.html">Reduced order model for three-dimensional unsteady flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO3D.html">FNO for 3D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="percnn2d.html">PeRCNN for 2D burgers Equation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PeRCNN for 3D Reaction-Diffusion Equation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#governing-equation">Governing Equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#technology-path">Technology Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimizer-and-one-step-training">Optimizer and One-step Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-evaluation-and-visualization">Model Evaluation and Visualization</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PeRCNN for 3D Reaction-Diffusion Equation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/data_mechanism_fusion/percnn3d.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="percnn-for-3d-reaction-diffusion-equation">
<h1>PeRCNN for 3D Reaction-Diffusion Equation<a class="headerlink" href="#percnn-for-3d-reaction-diffusion-equation" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/data_mechanism_fusion/mindspore_percnn3d.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/data_mechanism_fusion/mindspore_percnn3d.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.2/docs/mindflow/docs/source_en/data_mechanism_fusion/percnn3d.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>PDE equations occupy an important position in the modeling of physical systems. But many underlying PDEs have not yet been fully explored in epidemiology, meteorological science, fluid mechanics, and biology. However, for those known PDE equations, such as Naiver-Stokes equations, the exact numerical calculation of these equations requires huge computing power, which hinders the application of numerical simulation in large-scale systems. Recently, advances in machine learning provide a new way
for PDE solution and inversion.</p>
<p>Recently, Huawei and Professor Sun Hao’s team from Renmin University of China proposed Physics-encoded Recurrent Convolutional Neural Network, PeRCNN(<a class="reference external" href="https://www.nature.com/articles/s42256-023-00685-7">https://www.nature.com/articles/s42256-023-00685-7</a>) based on Ascend platform and MindSpore. Compared with physical information neural network, ConvLSTM, PDE-NET and other methods, generalization and noise resistance of PeRCNN are significantly improved. The long-term prediction accuracy is improved by more than 10 times. This method has broad
application prospects in aerospace, shipbuilding, weather forecasting and other fields. The results have been published in nature machine intelligence.</p>
</section>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>Reaction-diffusion equation is a partial derivative equation that is of great significance and has been broadly used in a variety of disciplines such as physics, chemistry and biology.</p>
</section>
<section id="governing-equation">
<h2>Governing Equation<a class="headerlink" href="#governing-equation" title="Permalink to this headline"></a></h2>
<p>In this research, RD equation is formulated as follow:</p>
<div class="math notranslate nohighlight">
\[u_t = \mu_u \Delta u - u{v*2} + F(1-v)\]</div>
<div class="math notranslate nohighlight">
\[v_t = \mu_v \Delta v + u{v*2} + (F+\kappa)v\]</div>
<p>where,</p>
<div class="math notranslate nohighlight">
\[\mu_v = 0.1, \mu_u = 0.2, F = 0.025, \kappa = 0.055\]</div>
<p>In this case, we will simulate the flow dynamics in 100 time steps (dt=0.5s) in a $ <span class="math">\Omega `:nbsphinx-math:</span>times <cite>:nbsphinx-math:</cite>tau <cite>= {[-50,50]}^3 :nbsphinx-math:</cite>times [0,500] <a href="#id1"><span class="problematic" id="id2">`</span></a>$ physical domain. The initial condition of the problem would go through gaussian noise and periodic BC is adpoted.</p>
</section>
<section id="technology-path">
<h2>Technology Path<a class="headerlink" href="#technology-path" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Optimizer and One-step Training</p></li>
<li><p>Model Construction</p></li>
<li><p>Model training</p></li>
<li><p>Model Evaluation and Visualization.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">save_checkpoint</span><span class="p">,</span> <span class="n">set_seed</span>
<span class="kn">import</span> <span class="nn">mindspore.common.dtype</span> <span class="k">as</span> <span class="nn">mstype</span>
<span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span><span class="p">,</span> <span class="n">print_log</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">RecurrentCnn</span><span class="p">,</span> <span class="n">post_process</span><span class="p">,</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">UpScaler</span><span class="p">,</span> <span class="n">count_params</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="optimizer-and-one-step-training">
<h2>Optimizer and One-step Training<a class="headerlink" href="#optimizer-and-one-step-training" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_stage</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">use_ascend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;train stage&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mindspore.amp</span> <span class="kn">import</span> <span class="n">DynamicLossScaler</span><span class="p">,</span> <span class="n">all_finite</span>
        <span class="n">loss_scaler</span> <span class="o">=</span> <span class="n">DynamicLossScaler</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;milestone_num&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">milestone</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">//</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;milestone_num&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;milestone_num&#39;</span><span class="p">])])</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">([</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
                                                           <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;milestone_num&#39;</span><span class="p">])]))</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">piecewise_constant_lr</span><span class="p">(</span><span class="n">milestone</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">upconv</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">upconv</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span> <span class="o">+</span> <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_cnn</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward_fn</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_ic_loss</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_loss</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span>
        <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">():</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">is_finite</span> <span class="o">=</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_finite</span><span class="p">:</span>
                <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
            <span class="n">loss_scaler</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">is_finite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="n">best_loss</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]):</span>
        <span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">upconv</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_cnn</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">:</span>
            <span class="n">step_train_loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">()</span>
            <span class="n">print_log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> train loss: </span><span class="si">{</span><span class="n">step_train_loss</span><span class="si">}</span><span class="s2"> epoch time: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="p">)</span><span class="w"> </span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">3800</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">loss_data</span><span class="p">,</span> <span class="n">loss_ic</span><span class="p">,</span> <span class="n">loss_phy</span><span class="p">,</span> <span class="n">loss_valid</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">()</span>
            <span class="n">print_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> train loss: </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">}</span><span class="s2"> ic_loss: </span><span class="si">{</span><span class="n">loss_ic</span><span class="si">}</span><span class="s2"> data_loss: </span><span class="si">{</span><span class="n">loss_data</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2"> phy_loss: </span><span class="si">{</span><span class="n">loss_phy</span><span class="si">}</span><span class="s2">  valid_loss: </span><span class="si">{</span><span class="n">loss_valid</span><span class="si">}</span><span class="s2"> epoch time: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="p">)</span><span class="si">:</span><span class="s2"> .3f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">epoch_loss</span> <span class="o">&lt;</span> <span class="n">best_loss</span><span class="p">:</span>
                <span class="n">best_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span>
                <span class="n">print_log</span><span class="p">(</span><span class="s1">&#39;best loss&#39;</span><span class="p">,</span> <span class="n">best_loss</span><span class="p">,</span> <span class="s1">&#39;save model&#39;</span><span class="p">)</span>
                <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">upconv</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="s2">&quot;train_upconv.ckpt&quot;</span><span class="p">))</span>
                <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_cnn</span><span class="p">,</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="s2">&quot;train_recurrent_cnn.ckpt&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="model-construction">
<h2>Model Construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>PeRCNN is composed of two networks which are UpSclaer for upscaling and recurrent CNN as a backbone.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;train&quot;&quot;&quot;</span>
    <span class="n">rd_config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s1">&#39;./configs/percnn_3d_rd.yaml&#39;</span><span class="p">)</span>
    <span class="n">data_config</span> <span class="o">=</span> <span class="n">rd_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">optim_config</span> <span class="o">=</span> <span class="n">rd_config</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span>
    <span class="n">summary_config</span> <span class="o">=</span> <span class="n">rd_config</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">rd_config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

    <span class="n">use_ascend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">attr_key</span><span class="o">=</span><span class="s1">&#39;device_target&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span>
    <span class="n">print_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use_ascend: </span><span class="si">{</span><span class="n">use_ascend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="n">compute_dtype</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compute_dtype</span> <span class="o">=</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span>

    <span class="n">upconv_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;upconv&#39;</span><span class="p">]</span>
    <span class="n">upconv</span> <span class="o">=</span> <span class="n">UpScaler</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">upconv_config</span><span class="p">[</span><span class="s1">&#39;in_channel&#39;</span><span class="p">],</span>
                      <span class="n">out_channels</span><span class="o">=</span><span class="n">upconv_config</span><span class="p">[</span><span class="s1">&#39;out_channel&#39;</span><span class="p">],</span>
                      <span class="n">hidden_channels</span><span class="o">=</span><span class="n">upconv_config</span><span class="p">[</span><span class="s1">&#39;hidden_channel&#39;</span><span class="p">],</span>
                      <span class="n">kernel_size</span><span class="o">=</span><span class="n">upconv_config</span><span class="p">[</span><span class="s1">&#39;kernel_size&#39;</span><span class="p">],</span>
                      <span class="n">stride</span><span class="o">=</span><span class="n">upconv_config</span><span class="p">[</span><span class="s1">&#39;stride&#39;</span><span class="p">],</span>
                      <span class="n">has_bais</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mindspore.amp</span> <span class="kn">import</span> <span class="n">auto_mixed_precision</span>
        <span class="n">auto_mixed_precision</span><span class="p">(</span><span class="n">upconv</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">)</span>

    <span class="n">rcnn_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;rcnn&#39;</span><span class="p">]</span>
    <span class="n">recurrent_cnn</span> <span class="o">=</span> <span class="n">RecurrentCnn</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="n">rcnn_config</span><span class="p">[</span><span class="s1">&#39;in_channel&#39;</span><span class="p">],</span>
                                 <span class="n">hidden_channels</span><span class="o">=</span><span class="n">rcnn_config</span><span class="p">[</span><span class="s1">&#39;hidden_channel&#39;</span><span class="p">],</span>
                                 <span class="n">kernel_size</span><span class="o">=</span><span class="n">rcnn_config</span><span class="p">[</span><span class="s1">&#39;kernel_size&#39;</span><span class="p">],</span>
                                 <span class="n">stride</span><span class="o">=</span><span class="n">rcnn_config</span><span class="p">[</span><span class="s1">&#39;stride&#39;</span><span class="p">],</span>
                                 <span class="n">compute_dtype</span><span class="o">=</span><span class="n">compute_dtype</span><span class="p">)</span>

    <span class="n">percnn_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">upconv</span><span class="o">=</span><span class="n">upconv</span><span class="p">,</span>
                             <span class="n">recurrent_cnn</span><span class="o">=</span><span class="n">recurrent_cnn</span><span class="p">,</span>
                             <span class="n">timesteps_for_train</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;rollout_steps&#39;</span><span class="p">],</span>
                             <span class="n">dx</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span>
                             <span class="n">grid_size</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;grid_size&#39;</span><span class="p">],</span>
                             <span class="n">dt</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span>
                             <span class="n">mu</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span>
                             <span class="n">data_path</span><span class="o">=</span><span class="n">data_config</span><span class="p">[</span><span class="s1">&#39;data_path&#39;</span><span class="p">],</span>
                             <span class="n">compute_dtype</span><span class="o">=</span><span class="n">compute_dtype</span><span class="p">)</span>

    <span class="n">total_params</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count_params</span><span class="p">(</span><span class="n">upconv</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())</span> <span class="o">+</span>
                       <span class="n">count_params</span><span class="p">(</span><span class="n">recurrent_cnn</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">total_params</span><span class="si">}</span><span class="s2"> parameters&quot;</span><span class="p">)</span>

    <span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">summary_config</span><span class="p">[</span><span class="s2">&quot;ckpt_dir&quot;</span><span class="p">]</span>
    <span class="n">fig_path</span> <span class="o">=</span> <span class="n">summary_config</span><span class="p">[</span><span class="s2">&quot;fig_save_path&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">)</span>

    <span class="n">train_stage</span><span class="p">(</span><span class="n">percnn_trainer</span><span class="p">,</span> <span class="s1">&#39;pretrain&#39;</span><span class="p">,</span>
                <span class="n">optim_config</span><span class="p">[</span><span class="s1">&#39;pretrain&#39;</span><span class="p">],</span> <span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">use_ascend</span><span class="p">)</span>
    <span class="n">train_stage</span><span class="p">(</span><span class="n">percnn_trainer</span><span class="p">,</span> <span class="s1">&#39;finetune&#39;</span><span class="p">,</span>
                <span class="n">optim_config</span><span class="p">[</span><span class="s1">&#39;finetune&#39;</span><span class="p">],</span> <span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">use_ascend</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">percnn_trainer</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output shape is &#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">post_process</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">fig_path</span><span class="p">,</span> <span class="n">is_u</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="model-training">
<h2>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>With <strong>MindSpore version &gt;= 2.0.0</strong>, we can use the functional programming for training neural networks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
use_ascend: False
shape of uv is  (3001, 2, 48, 48, 48)
shape of ic is  (1, 2, 48, 48, 48)
shape of init_state_low is  (1, 2, 24, 24, 24)
There are 10078 parameters
epoch: 1 train loss: 0.160835 epoch time: 5.545 s
epoch: 2 train loss: 104.36749 epoch time: 0.010 s
epoch: 3 train loss: 4.3207517 epoch time: 0.009 s
epoch: 4 train loss: 8.491383 epoch time: 0.009 s
epoch: 5 train loss: 23.683647 epoch time: 0.009 s
epoch: 6 train loss: 23.857117 epoch time: 0.010 s
epoch: 7 train loss: 16.037672 epoch time: 0.010 s
epoch: 8 train loss: 8.406443 epoch time: 0.009 s
epoch: 9 train loss: 3.527469 epoch time: 0.020 s
epoch: 10 train loss: 1.0823832 epoch time: 0.009 s
...
epoch: 9990 train loss: 8.7615306e-05 epoch time: 0.008 s
epoch: 9991 train loss: 8.76504e-05 epoch time: 0.008 s
epoch: 9992 train loss: 8.761823e-05 epoch time: 0.008 s
epoch: 9993 train loss: 8.7546505e-05 epoch time: 0.008 s
epoch: 9994 train loss: 8.7519744e-05 epoch time: 0.008 s
epoch: 9995 train loss: 8.753734e-05 epoch time: 0.008 s
epoch: 9996 train loss: 8.753101e-05 epoch time: 0.008 s
epoch: 9997 train loss: 8.748294e-05 epoch time: 0.008 s
epoch: 9998 train loss: 8.7443106e-05 epoch time: 0.008 s
epoch: 9999 train loss: 8.743979e-05 epoch time: 0.008 s
epoch: 10000 train loss: 8.744074e-05 epoch time: 0.008 s
epoch: 1 train loss: 61.754555 ic_loss: 8.7413886e-05 data_loss: 6.1754117  phy_loss: 2.6047118  valid_loss: 7.221066 truth_loss: 2.7125626 epoch time:  138.495 s
best loss 61.754555 save model
epoch: 2 train loss: 54.79151 ic_loss: 0.32984126 data_loss: 5.3142304  phy_loss: 52.50226  valid_loss: 6.812231 truth_loss: 2.7744124 epoch time:  1.342 s
best loss 54.79151 save model
epoch: 3 train loss: 46.904842 ic_loss: 0.12049961 data_loss: 4.6302347  phy_loss: 32.494545  valid_loss: 5.953037 truth_loss: 2.579268 epoch time:  1.262 s
best loss 46.904842 save model
epoch: 4 train loss: 40.674736 ic_loss: 0.031907484 data_loss: 4.05152  phy_loss: 11.360751  valid_loss: 5.08032 truth_loss: 2.3503494 epoch time:  1.233 s
best loss 40.674736 save model
epoch: 5 train loss: 36.910408 ic_loss: 0.10554239 data_loss: 3.6382694  phy_loss: 3.5776496  valid_loss: 4.4271708 truth_loss: 2.1671412 epoch time:  1.315 s
best loss 36.910408 save model
epoch: 6 train loss: 33.767193 ic_loss: 0.14396289 data_loss: 3.304738  phy_loss: 1.4308721  valid_loss: 3.954126 truth_loss: 2.0307255 epoch time:  1.322 s
best loss 33.767193 save model
epoch: 7 train loss: 30.495178 ic_loss: 0.09850004 data_loss: 3.0002677  phy_loss: 0.8241035  valid_loss: 3.586939 truth_loss: 1.9244627 epoch time:  1.178 s
best loss 30.495178 save model
epoch: 8 train loss: 27.448381 ic_loss: 0.03362463 data_loss: 2.728026  phy_loss: 0.6343211  valid_loss: 3.286183 truth_loss: 1.8369334 epoch time:  1.271 s
best loss 27.448381 save model
epoch: 9 train loss: 24.990078 ic_loss: 0.0024543565 data_loss: 2.4977806  phy_loss: 0.5740176  valid_loss: 3.0332325 truth_loss: 1.7619449 epoch time:  1.573 s
best loss 24.990078 save model
epoch: 10 train loss: 23.15583 ic_loss: 0.014634784 data_loss: 2.3082657  phy_loss: 0.5407104  valid_loss: 2.8156128 truth_loss: 1.6955423 epoch time:  1.351 s
best loss 23.15583 save model
...
epoch: 1657 train loss: 0.092819184 ic_loss: 0.00065381714 data_loss: 0.00895501  phy_loss: 0.00069560105  valid_loss: 0.011931514 truth_loss: 0.16052744 epoch time:  1.174 s
best loss 0.092819184 save model
epoch: 1658 train loss: 0.09269943 ic_loss: 0.0006537079 data_loss: 0.008943089  phy_loss: 0.0006945693  valid_loss: 0.011916851 truth_loss: 0.1604548 epoch time:  1.296 s
best loss 0.09269943 save model
epoch: 1659 train loss: 0.092579775 ic_loss: 0.00065359805 data_loss: 0.008931179  phy_loss: 0.0006935386  valid_loss: 0.0119022 truth_loss: 0.16038223 epoch time:  1.426 s
best loss 0.092579775 save model
epoch: 1660 train loss: 0.09246021 ic_loss: 0.0006534874 data_loss: 0.008919277  phy_loss: 0.00069250836  valid_loss: 0.011887563 truth_loss: 0.16030973 epoch time:  1.389 s
best loss 0.09246021 save model
</pre></div></div>
</div>
</section>
<section id="model-evaluation-and-visualization">
<h2>Model Evaluation and Visualization<a class="headerlink" href="#model-evaluation-and-visualization" title="Permalink to this headline"></a></h2>
<p>After training, all data points in the flow field can be inferred. And related results can be visualized.</p>
<p><img alt="image0" src="../_images/result-percnn3d.jpg" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="percnn2d.html" class="btn btn-neutral float-left" title="PeRCNN for 2D burgers Equation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../cfd_solver/lax_tube.html" class="btn btn-neutral float-right" title="1D Lax Tube" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>