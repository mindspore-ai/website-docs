<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neural Representation Method for Boltzmann Equation &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PINNs for Kovasznay Flow" href="kovasznay.html" />
    <link rel="prev" title="Inverse Navier-Stokes Problem" href="navier_stokes_inverse.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_inverse.html">Inverse Navier-Stokes Problem</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Neural Representation Method for Boltzmann Equation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#method">Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset-construction">Dataset Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-construction">Model Construction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boltzmannbgk">BoltzmannBGK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimizer">Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training">Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualization">Visualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="kovasznay.html">PINNs for Kovasznay Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="periodic_hill.html">Raynold-averaged Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="poisson_point_source.html">PINNs for Point Source Poisson</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_unsteady.html">Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/flow_around_sphere.html">Reduced order model for three-dimensional unsteady flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO3D.html">FNO for 3D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn2d.html">PeRCNN for 2D burgers Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn3d.html">PeRCNN for 3D Reaction-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Neural Representation Method for Boltzmann Equation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/physics_driven/boltzmann.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="neural-representation-method-for-boltzmann-equation">
<h1>Neural Representation Method for Boltzmann Equation<a class="headerlink" href="#neural-representation-method-for-boltzmann-equation" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/physics_driven/mindspore_boltzmann.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/physics_driven/mindspore_boltzmann.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.2/docs/mindflow/docs/source_en/physics_driven/boltzmann.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_source_en.svg" /></a></p>
<section id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>This case demonstrates how to solve the Boltzmann equation in 1+3 dimensions using neural networks. The Boltzmann equation is an equation for the gas density distribution function <span class="math notranslate nohighlight">\(f\)</span>, defined as</p>
<div class="math notranslate nohighlight">
\[\newcommand{\bm}[1]{\boldsymbol{#1}}
\begin{equation}
\label{eq:Boltzmann}
\frac{\partial f(\bm x,\bm v,t)}{\partial t}+\bm{v} \cdot\nabla_{\bm x} f(\bm x,\bm v,t)=\mathcal{Q}[f](\bm x, \bm v,t), \qquad  t \in \mathbb{R}^+, \quad \bm x \in  \mathbb{R}^3, \quad \bm v \in  \mathbb{R}^3,
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{Q}[f]\)</span> is the collision term operator. With <span class="math notranslate nohighlight">\(f\)</span>, we can obtain the macroscopic physical variables of the gas</p>
<div class="math notranslate nohighlight">
\[\begin{split}\require{braket}
\begin{equation}
    \begin{gathered}
   \rho(\bm x,t)=\int f d \bm v,\\
   \bm{m}(\bm x, t) \triangleq  \rho \bm u(\bm x,t)=\int f \bm v f d\bm v,\\
E(\bm x, t) \triangleq \frac{3}{2}\rho T(\bm x, t) + \frac{1}{2}\rho |\bm u|^2 = \frac{1}{2} \int \vert\bm v\vert^2 f d \bm v,
\end{gathered}
\end{equation}\end{split}\]</div>
<p>For simplified models such as the BGK model, the collision term operator is defined as</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
    \label{eq:BGK}
\mathcal{Q}^{\rm BGK}[f]=\frac{1}{\tau}(\mathcal{M}-f).
\end{equation}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
\label{eq:Maxwellian}
\mathcal{M}=\frac{\rho}{\sqrt{2\pi T}^3}\exp \left( -\frac{|\bm v-\bm u|^2}{2 T} \right).
\end{equation}\]</div>
<p>In this case, the Boltzmann-BGK equation with periodic boundary conditions in 1-dimensional physical space and 3-dimensional microscopic velocity space will be studied. Its initial value is</p>
<div class="math notranslate nohighlight">
\[\begin{equation}
\rho(x)=1+0.5\sin(2\pi x),\qquad
\bm{u}(x)=0,\qquad
T(x)=1+0.5\sin(2\pi x+0.2),
\end{equation}\]</div>
</section>
<section id="method">
<h2>Method<a class="headerlink" href="#method" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Creating the dataset.</p></li>
<li><p>Creating the neural network.</p></li>
<li><p>BoltzmannBGK</p></li>
<li><p>Creating the optimizer.</p></li>
<li><p>Model training.</p></li>
<li><p>Model evaluation.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">ops</span><span class="p">,</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.numpy</span> <span class="k">as</span> <span class="nn">mnp</span>

<span class="n">ms</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindflow.utils</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>

<span class="kn">from</span> <span class="nn">src.boltzmann</span> <span class="kn">import</span> <span class="n">BoltzmannBGK</span><span class="p">,</span> <span class="n">BGKKernel</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">get_vdis</span><span class="p">,</span> <span class="n">visual</span><span class="p">,</span> <span class="n">mesh_nd</span>
<span class="kn">from</span> <span class="nn">src.cells</span> <span class="kn">import</span> <span class="n">SplitNet</span><span class="p">,</span> <span class="n">MultiRes</span><span class="p">,</span> <span class="n">Maxwellian</span><span class="p">,</span> <span class="n">MtlLoss</span><span class="p">,</span> <span class="n">JacFwd</span><span class="p">,</span> <span class="n">RhoUTheta</span><span class="p">,</span> <span class="n">PrimNorm</span>
<span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">Wave1DDataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="s2">&quot;WaveD1V3.yaml&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="dataset-construction">
<h2>Dataset Construction<a class="headerlink" href="#dataset-construction" title="Permalink to this headline"></a></h2>
<p>The computational region of our selection is <span class="math notranslate nohighlight">\([-0.5,0.5]\times[0,0.1]\)</span> and we select 100 points in the initial value, 100 points in the boundary and 700 points in the interior of the region.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Wave1DDataset</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dataset for 1D wave problem&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;xtmesh&quot;</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;xtmesh&quot;</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vmesh&quot;</span><span class="p">][</span><span class="s2">&quot;nv&quot;</span><span class="p">]</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vmesh&quot;</span><span class="p">][</span><span class="s2">&quot;vmin&quot;</span><span class="p">]</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vmesh&quot;</span><span class="p">][</span><span class="s2">&quot;vmax&quot;</span><span class="p">]</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mesh_nd</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">nv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdis</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxwellian</span> <span class="o">=</span> <span class="n">Maxwellian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;iv_points&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bv_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;bv_points&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="s2">&quot;in_points&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uniform</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">UniformReal</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initial value points</span>
        <span class="n">iv_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniform</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span>
        <span class="n">iv_t</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">iv_x</span><span class="p">)</span>

        <span class="c1"># boundary value points</span>
        <span class="n">bv_x1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">mnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bv_points</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bv_t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniform</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bv_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">bv_x2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">mnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bv_points</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bv_t2</span> <span class="o">=</span> <span class="n">bv_t1</span>

        <span class="c1"># inner points</span>
        <span class="n">in_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniform</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">in_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">in_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniform</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">in_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.1</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">in_x</span><span class="p">,</span> <span class="n">in_t</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;iv&quot;</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">iv_x</span><span class="p">,</span> <span class="n">iv_t</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bv1&quot;</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bv_x1</span><span class="p">,</span> <span class="n">bv_t1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bv2&quot;</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bv_x2</span><span class="p">,</span> <span class="n">bv_t2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span>


<span class="n">dataset</span> <span class="o">=</span> <span class="n">Wave1DDataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="model-construction">
<h2>Model Construction<a class="headerlink" href="#model-construction" title="Permalink to this headline"></a></h2>
<p>This case uses a neural network structure with 6 layers and 80 neurons per layer. Our network consists of two parts, one part of the network is in the form of Maxwellian equilibrium state and the other part is in the form of discrete velocity distribution, such a structure helps in training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SplitNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;the network combined the maxwellian and non-maxwellian&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">neurons</span><span class="p">,</span> <span class="n">vdis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_eq</span> <span class="o">=</span> <span class="n">MultiRes</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">neurons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_neq</span> <span class="o">=</span> <span class="n">MultiRes</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">vdis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layers</span><span class="p">,</span> <span class="n">neurons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxwellian</span> <span class="o">=</span> <span class="n">Maxwellian</span><span class="p">(</span><span class="n">vdis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xt</span><span class="p">):</span>
        <span class="n">www</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_eq</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">www</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">www</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">www</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxwellian</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_neq</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>


<span class="n">vdis</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_vdis</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;vmesh&quot;</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SplitNet</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;layers&quot;</span><span class="p">],</span>
                 <span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;neurons&quot;</span><span class="p">],</span> <span class="n">vdis</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="boltzmannbgk">
<h2>BoltzmannBGK<a class="headerlink" href="#boltzmannbgk" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BoltzmannBGK</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Boltzmann BGK model&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">vconfig</span><span class="p">,</span> <span class="n">iv_weight</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bv_weight</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pde_weight</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kn</span> <span class="o">=</span> <span class="n">kn</span>

        <span class="n">vdis</span><span class="p">,</span> <span class="n">wdis</span> <span class="o">=</span> <span class="n">get_vdis</span><span class="p">(</span><span class="n">vconfig</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vdis</span> <span class="o">=</span> <span class="n">vdis</span>
        <span class="n">loss_num</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">vdis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vdis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtl</span> <span class="o">=</span> <span class="n">MtlLoss</span><span class="p">(</span><span class="n">loss_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jac</span> <span class="o">=</span> <span class="n">JacFwd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_weight</span> <span class="o">=</span> <span class="n">iv_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bv_weight</span> <span class="o">=</span> <span class="n">bv_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pde_weight</span> <span class="o">=</span> <span class="n">pde_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxwellian_nd</span> <span class="o">=</span> <span class="n">Maxwellian</span><span class="p">(</span><span class="n">vdis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_u_theta</span> <span class="o">=</span> <span class="n">RhoUTheta</span><span class="p">(</span><span class="n">vdis</span><span class="p">,</span> <span class="n">wdis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion_norm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ops</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prim_norm</span> <span class="o">=</span> <span class="n">PrimNorm</span><span class="p">(</span><span class="n">vdis</span><span class="p">,</span> <span class="n">wdis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collision</span> <span class="o">=</span> <span class="n">BGKKernel</span><span class="p">(</span>
            <span class="n">vconfig</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vconfig</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">],</span> <span class="n">vconfig</span><span class="p">[</span><span class="s2">&quot;nv&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">governing_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">fxft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">ft</span> <span class="o">=</span> <span class="n">fxft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fxft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pde</span> <span class="o">=</span> <span class="n">ft</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdis</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">fx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">collision</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pde</span>

    <span class="k">def</span> <span class="nf">boundary_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bv_points1</span><span class="p">,</span> <span class="n">bv_points2</span><span class="p">):</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">bv_points1</span><span class="p">)</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">bv_points2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">fr</span>

    <span class="k">def</span> <span class="nf">initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">iv_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">iv_x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rho_l</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">iv_x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">u_l</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">iv_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">theta_l</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">iv_x</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">iv_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxwellian_nd</span><span class="p">(</span><span class="n">rho_l</span><span class="p">,</span> <span class="n">u_l</span><span class="p">,</span> <span class="n">theta_l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">iv_pred</span> <span class="o">-</span> <span class="n">iv_truth</span>

    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;the loss function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_norm</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_norm</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain_points</span><span class="p">,</span> <span class="n">iv_points</span><span class="p">,</span> <span class="n">bv_points1</span><span class="p">,</span> <span class="n">bv_points2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;combined all loss function&quot;&quot;&quot;</span>
        <span class="n">pde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governing_equation</span><span class="p">(</span><span class="n">domain_points</span><span class="p">)</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_condition</span><span class="p">(</span><span class="n">iv_points</span><span class="p">)</span>
        <span class="n">bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">(</span><span class="n">bv_points1</span><span class="p">,</span> <span class="n">bv_points2</span><span class="p">)</span>

        <span class="n">loss_pde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pde_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_norm</span><span class="p">(</span><span class="n">pde</span><span class="p">)</span>
        <span class="n">loss_pde2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pde_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_norm</span><span class="p">(</span><span class="n">pde</span><span class="p">)</span>

        <span class="n">loss_bv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_norm</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span>
        <span class="n">loss_bv2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bv_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_norm</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span>

        <span class="n">loss_iv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_norm</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
        <span class="n">loss_iv2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_norm</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>

        <span class="n">loss_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtl</span><span class="p">(</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">loss_iv</span><span class="p">,</span> <span class="n">loss_iv2</span><span class="p">,</span> <span class="n">loss_bv</span><span class="p">,</span> <span class="n">loss_bv2</span><span class="p">,</span> <span class="n">loss_pde</span><span class="p">,</span> <span class="n">loss_pde2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_sum</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_iv</span><span class="p">,</span> <span class="n">loss_iv2</span><span class="p">,</span> <span class="n">loss_bv</span><span class="p">,</span> <span class="n">loss_bv2</span><span class="p">,</span> <span class="n">loss_pde</span><span class="p">,</span> <span class="n">loss_pde2</span><span class="p">)</span>


<span class="n">problem</span> <span class="o">=</span> <span class="n">BoltzmannBGK</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;kn&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;vmesh&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="optimizer">
<h2>Optimizer<a class="headerlink" href="#optimizer" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cosine_decay_lr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CosineDecayLR</span><span class="p">(</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optim&quot;</span><span class="p">][</span><span class="s2">&quot;lr_scheduler&quot;</span><span class="p">][</span><span class="s2">&quot;min_lr&quot;</span><span class="p">],</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optim&quot;</span><span class="p">][</span><span class="s2">&quot;lr_scheduler&quot;</span><span class="p">][</span><span class="s2">&quot;max_lr&quot;</span><span class="p">],</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optim&quot;</span><span class="p">][</span><span class="s2">&quot;Adam_steps&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="n">cosine_decay_lr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optim</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="nd">@ms</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">optim</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>


<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optim&quot;</span><span class="p">][</span><span class="s2">&quot;Adam_steps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">()</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e_sum</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> loss: </span><span class="si">{</span><span class="n">e_sum</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2"> epoch time: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
        <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End-to-End total time: </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
<span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;./model.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch: 500 loss: 2.396e-01 epoch time: 194.953 ms
epoch: 1000 loss: 3.136e-02 epoch time: 193.463 ms
epoch: 1500 loss: 1.583e-03 epoch time: 191.280 ms
epoch: 2000 loss: 2.064e-04 epoch time: 191.099 ms
epoch: 2500 loss: 1.434e-04 epoch time: 190.477 ms
epoch: 3000 loss: 1.589e-04 epoch time: 190.489 ms
epoch: 3500 loss: 9.694e-05 epoch time: 190.476 ms
epoch: 4000 loss: 8.251e-05 epoch time: 191.893 ms
epoch: 4500 loss: 7.238e-05 epoch time: 190.835 ms
epoch: 5000 loss: 5.705e-05 epoch time: 190.611 ms
epoch: 5500 loss: 4.932e-05 epoch time: 190.530 ms
epoch: 6000 loss: 4.321e-05 epoch time: 190.756 ms
epoch: 6500 loss: 4.205e-05 epoch time: 191.470 ms
epoch: 7000 loss: 3.941e-05 epoch time: 190.781 ms
epoch: 7500 loss: 3.328e-05 epoch time: 190.543 ms
epoch: 8000 loss: 3.113e-05 epoch time: 190.786 ms
epoch: 8500 loss: 2.995e-05 epoch time: 190.864 ms
epoch: 9000 loss: 2.875e-05 epoch time: 190.796 ms
epoch: 9500 loss: 2.806e-05 epoch time: 188.351 ms
epoch: 10000 loss: 2.814e-05 epoch time: 189.244 ms
End-to-End total time: 2151.8691852092743 s
</pre></div></div>
</div>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">visual</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;visual_resolution&quot;</span><span class="p">],</span> <span class="s2">&quot;result.png&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/physics_driven_boltzmann_16_0.png" src="../_images/physics_driven_boltzmann_16_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="navier_stokes_inverse.html" class="btn btn-neutral float-left" title="Inverse Navier-Stokes Problem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="kovasznay.html" class="btn btn-neutral float-right" title="PINNs for Kovasznay Flow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>
