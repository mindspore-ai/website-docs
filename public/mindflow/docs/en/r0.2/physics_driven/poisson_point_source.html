<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PINNs for Point Source Poisson &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="AI Industrial Flow Simulation Model (DongFang YuFeng)" href="../data_driven/2D_steady.html" />
    <link rel="prev" title="Raynold-averaged Navier-Stokes" href="periodic_hill.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">MindSpore Flow Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">Solving PINNs Based on MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics-driven</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="burgers1D.html">1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="darcy2D.html">2D stabilized Darcy Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes2D.html">2D Cylinder Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="poisson_geometry.html">2D &amp; 3D Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="taylor_green2D.html">Two-dimensional Taylor Green Vortex</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_inverse.html">Inverse Navier-Stokes Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="boltzmann.html">Neural Representation Method for Boltzmann Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="kovasznay.html">PINNs for Kovasznay Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="periodic_hill.html">Raynold-averaged Navier-Stokes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PINNs for Point Source Poisson</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#method">Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-the-dataset">Creating the dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-the-neural-network">Creating the neural network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pinns’-loss">PINNs’ loss</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-the-optimizer">Creating the optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-training">Model training</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-inference-and-visualization">Model inference and visualization</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data-driven</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_steady.html">AI Industrial Flow Simulation Model (DongFang YuFeng)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_FNO1D.html">FNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO2D.html">FNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_KNO1D.html">KNO for 1D Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_KNO2D.html">KNO for 2D Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_unsteady.html">Multi-timestep Complicated Flow Field Prediction with Transonic Airfoil under Data Driven Mode(with Two Kinds of Backbones: FNO2D and UNET2D)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/flow_around_sphere.html">Reduced order model for three-dimensional unsteady flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO3D.html">FNO for 3D Navier-Stokes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Mechanism Fusion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net for Convection-Diffusion Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn2d.html">PeRCNN for 2D burgers Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn3d.html">PeRCNN for 3D Reaction-Diffusion Equation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CFD-solver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">1D Lax Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">1D Sod Tube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">2D Couette Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">2D Riemann</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PINNs for Point Source Poisson</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/physics_driven/poisson_point_source.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="pinns-for-point-source-poisson">
<h1>PINNs for Point Source Poisson<a class="headerlink" href="#pinns-for-point-source-poisson" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/physics_driven/mindspore_poisson_point_source.ipynb"><img alt="DownloadNotebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_notebook_en.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/en/physics_driven/mindspore_poisson_point_source.py"><img alt="DownloadCode" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_download_code_en.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.2/docs/mindflow/docs/source_en/physics_driven/poisson_point_source.ipynb"><img alt="ViewSource" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_source_en.svg" /></a></p>
<section id="problem-description">
<h2>Problem description<a class="headerlink" href="#problem-description" title="Permalink to this headline"></a></h2>
<p>This example demonstrates how to use the PINNs method to solve the Poisson equation with a point source in two dimensions. The equation is defined by</p>
<div class="math notranslate nohighlight">
\[\Delta u = - \delta(x-x_{src})\delta(y-y_{src}),\]</div>
<p>where <span class="math notranslate nohighlight">\((x_{src}, y_{src})\)</span> is the coordinate corresponding to the point source position. he point source can be represented mathematically using the Dirac <span class="math notranslate nohighlight">\(\delta\)</span> function</p>
<div class="math notranslate nohighlight">
\[\begin{split}\delta(x) = \begin{cases}
+\infty, &amp; x = 0    \\
0,       &amp; x \neq 0
\end{cases}
\qquad
\int_{-\infty}^{+\infty}\delta(x)dx = 1.\end{split}\]</div>
<p>When the solution domain is <span class="math notranslate nohighlight">\(\Omega=[0,\pi]^2\)</span>, the analytical solution of this equation is</p>
<div class="math notranslate nohighlight">
\[u(x,y) = \frac{4}{\pi^2} \sum_{i=1}^{\infty} \sum_{j=1}^{\infty}\frac{\sin{(i x)}\sin{(i x_{src})}\sin{(j y)}\sin{(j y_{src})}}{i^2 + j^2}\]</div>
<p>The corresponding paper for this case is: <a class="reference external" href="https://www.ijcai.org/proceedings/2022/0533.pdf">Xiang Huang, Hongsheng Liu, Beiji Shi, Zidong Wang, Kang Yang, Yang Li, Min Wang, Haotian Chu, Jing Zhou, Fan Yu, Bei Hua, Bin Dong, Lei Chen. “A Universal PINNs Method for Solving Partial Differential Equations with a Point Source”. Thirty-First International Joint Conference on Artificial Intelligence (IJCAI 2022), Vienna, Austria, Jul, 2022, Pages 3839-3846.</a></p>
</section>
<section id="method">
<h2>Method<a class="headerlink" href="#method" title="Permalink to this headline"></a></h2>
<p>MindSpore Flow solves the problem as follows:</p>
<ol class="arabic simple">
<li><p>Creating the dataset.</p></li>
<li><p>Creating the neural network.</p></li>
<li><p>PINNs’ loss.</p></li>
<li><p>Creating the optimizer.</p></li>
<li><p>Model training.</p></li>
<li><p>Model inference and visualization.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">mindflow</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>

<span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">create_train_dataset</span><span class="p">,</span> <span class="n">create_test_dataset</span>
<span class="kn">from</span> <span class="nn">src.poisson</span> <span class="kn">import</span> <span class="n">Poisson</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">calculate_l2_error</span><span class="p">,</span> <span class="n">visual</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>

<span class="c1"># Load config</span>
<span class="n">file_cfg</span> <span class="o">=</span> <span class="s2">&quot;poisson_cfg.yaml&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="n">file_cfg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="creating-the-dataset">
<h2>Creating the dataset<a class="headerlink" href="#creating-the-dataset" title="Permalink to this headline"></a></h2>
<p>In this example, random sampling is performed in the solution domain, boundaries, and point source region (a rectangular area centered on the point source position) to generate the training dataset. See <a class="reference external" href="https://gitee.com/mindspore/mindscience/tree/r0.6/MindFlow/applications/physics_driven/poisson/point_source/src">src/dataset.py</a> for the implementation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the dataset</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_train_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="creating-the-neural-network">
<h2>Creating the neural network<a class="headerlink" href="#creating-the-neural-network" title="Permalink to this headline"></a></h2>
<p>This example uses a multiscale neural network combined with the sin activation function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindflow.cell</span> <span class="kn">import</span> <span class="n">MultiScaleFCSequential</span>

<span class="c1"># Create the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiScaleFCSequential</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;in_channels&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;out_channels&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;neurons&#39;</span><span class="p">],</span>
                               <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">act</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;activation&#39;</span><span class="p">],</span>
                               <span class="n">num_scales</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;num_scales&#39;</span><span class="p">],</span>
                               <span class="n">amp_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                               <span class="n">scale_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                               <span class="n">input_scale</span><span class="o">=</span><span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span>
                               <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="pinns’-loss">
<h2>PINNs’ loss<a class="headerlink" href="#pinns’-loss" title="Permalink to this headline"></a></h2>
<p>When using <code class="docutils literal notranslate"><span class="pre">mindflow</span></code> to solve PDEs, we need to write a subclass of <code class="docutils literal notranslate"><span class="pre">mindflow.PDEWithLloss</span></code> to define the loss function terms corresponding to the governing equation and boundary conditions (<code class="docutils literal notranslate"><span class="pre">loss_pde</span></code> and <code class="docutils literal notranslate"><span class="pre">loss_bc</span></code>, respectively). Since the point source region requires dense sampling points, we add an additional loss function term (<code class="docutils literal notranslate"><span class="pre">loss_src</span></code>).</p>
<p>When the PINNs method uses the residual of the governing equation as a loss function term to constrain the neural network, the singularity of the Dirac delta function makes it impossible for neural network training to converge. Therefore, we use the probability density function of two-dimensional Laplace distribution to approximate the Dirac <span class="math notranslate nohighlight">\(\delta\)</span> function:</p>
<div class="math notranslate nohighlight">
\[\eta_{\alpha}(x, y) = \frac{1}{4\alpha^2} exp({-\frac{|x-x_{src}|+|y-y_{src}|}{\alpha}}) \qquad \underrightarrow{approx} \qquad \delta(x-x_{src})\delta(y-y_{src})\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is the kernel width. In theory, as long as the kernel width <span class="math notranslate nohighlight">\(\alpha\)</span> is small enough, the above probability density function can approximate the Dirac <span class="math notranslate nohighlight">\(\delta\)</span> function very well. However, in practice, the selection of kernel width <span class="math notranslate nohighlight">\(\alpha\)</span> has an important impact on the approximation effect. When <span class="math notranslate nohighlight">\(\alpha\)</span> is too large, the approximation error between probability density function <span class="math notranslate nohighlight">\(\eta_{\alpha}(x, y)\)</span> and Dirac <span class="math notranslate nohighlight">\(\delta\)</span> function will
increase. But if <span class="math notranslate nohighlight">\(\alpha\)</span> is too small, the training process may not converge or the accuracy after convergence may be poor. Therefore, <span class="math notranslate nohighlight">\(\alpha\)</span> needs to be manually tuned. Here we determine it as <span class="math notranslate nohighlight">\(\alpha=0.01\)</span>.</p>
<p>L2 loss is used for solution domain, boundaries and point source region. The <code class="docutils literal notranslate"><span class="pre">MTLWeightedLoss</span></code> multi-objective loss function of <code class="docutils literal notranslate"><span class="pre">mindflow</span></code> is used to combine these three loss function terms.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">ms_np</span>
<span class="kn">from</span> <span class="nn">mindflow</span> <span class="kn">import</span> <span class="n">PDEWithLoss</span><span class="p">,</span> <span class="n">MTLWeightedLoss</span><span class="p">,</span> <span class="n">sympy_to_mindspore</span>

<span class="k">class</span> <span class="nc">Poisson</span><span class="p">(</span><span class="n">PDEWithLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define the loss of the Poisson equation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x y&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># kernel width</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Poisson</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_nodes</span> <span class="o">=</span> <span class="n">sympy_to_mindspore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">MTLWeightedLoss</span><span class="p">(</span><span class="n">num_losses</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the gonvering equation.&quot;&quot;&quot;</span>
        <span class="n">uu_xx</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">uu_yy</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Use Laplace probability density function to approximate the Dirac \delta function.</span>
        <span class="n">x_src</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_src</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">force_term</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sympy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_src</span><span class="p">)</span> <span class="o">+</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_src</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>

        <span class="n">poisson</span> <span class="o">=</span> <span class="n">uu_xx</span> <span class="o">+</span> <span class="n">uu_yy</span> <span class="o">+</span> <span class="n">force_term</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;poisson&quot;</span><span class="p">:</span> <span class="n">poisson</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">equations</span>

    <span class="k">def</span> <span class="nf">bc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the boundary condition.&quot;&quot;&quot;</span>
        <span class="n">bc_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>

        <span class="n">equations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bc&quot;</span><span class="p">:</span> <span class="n">bc_eq</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">equations</span>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the loss function.&quot;&quot;&quot;</span>
        <span class="n">res_pde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pde_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">pde_data</span><span class="p">)</span>
        <span class="n">res_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">bc_data</span><span class="p">)</span>
        <span class="n">res_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pde_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">src_data</span><span class="p">)</span>

        <span class="n">loss_pde</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_pde</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">loss_bc</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">loss_src</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">((</span><span class="n">loss_pde</span><span class="p">,</span> <span class="n">loss_bc</span><span class="p">,</span> <span class="n">loss_src</span><span class="p">))</span>

<span class="c1"># Create the problem and optimizer</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">Poisson</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="creating-the-optimizer">
<h2>Creating the optimizer<a class="headerlink" href="#creating-the-optimizer" title="Permalink to this headline"></a></h2>
<p>This example uses the <code class="docutils literal notranslate"><span class="pre">Adam</span></code> optimizer and the learning rate decays to 1/10, 1/100, and 1/1000 of the initial learning rate when training reaches 40%, 60%, and 80%, respectively.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">250</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span> <span class="o">+</span> <span class="n">problem</span><span class="o">.</span><span class="n">loss_fn</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">milestone</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">steps_per_epoch</span> <span class="o">*</span> <span class="n">n_epochs</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]]</span>
<span class="n">lr_init</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">][</span><span class="s2">&quot;initial_lr&quot;</span><span class="p">]</span>
<span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">lr_init</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="n">lr_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">piecewise_constant_lr</span><span class="p">(</span><span class="n">milestone</span><span class="p">,</span> <span class="n">learning_rates</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="model-training">
<h2>Model training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h2>
<p>With MindSpore version &gt;= 2.0.0, we can use the functional programming for training neural networks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">is_finite</span> <span class="o">=</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_finite</span><span class="p">:</span>
                <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
            <span class="n">loss_scaler</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">is_finite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">):</span>
        <span class="n">local_time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">i_epoch</span><span class="si">}</span><span class="s2"> train loss: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="sa">f</span><span class="s2">&quot; epoch time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">local_time_beg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_epochs</span><span class="p">):</span>
        <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">)</span>


<span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">train</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End-to-End total time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="model-inference-and-visualization">
<h2>Model inference and visualization<a class="headerlink" href="#model-inference-and-visualization" title="Permalink to this headline"></a></h2>
<p>Calculate the relative L2 error and draw a comparison graph between the reference solution and the model prediction results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">calculate_l2_error</span><span class="p">,</span> <span class="n">visual</span>

<span class="c1"># Create the dataset</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">create_test_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="n">calculate_l2_error</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">)</span>

<span class="c1"># Visual comparison of label and prediction</span>
<span class="n">visual</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="periodic_hill.html" class="btn btn-neutral float-left" title="Raynold-averaged Navier-Stokes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../data_driven/2D_steady.html" class="btn btn-neutral float-right" title="AI Industrial Flow Simulation Model (DongFang YuFeng)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>