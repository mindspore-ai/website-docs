<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>利用PINNs求解二维带点源泊松方程 &mdash; MindSpore master 文档</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script src="../_static/translations.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="AI工业流体仿真模型——东方御风" href="../data_driven/2D_steady.html" />
    <link rel="prev" title="雷诺平均Navier-Stokes方程求解周期山流动" href="periodic_hill.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow_install.html">安装MindSpore Flow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">特性</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/solve_pinns_by_mindflow.html">基于MindSpore Flow求解PINNs问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">物理驱动</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="burgers1D.html">一维Burgers问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="darcy2D.html">二维定常达西问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes2D.html">二维圆柱绕流</a></li>
<li class="toctree-l1"><a class="reference internal" href="poisson_geometry.html">二维&amp;三维Poisson问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="taylor_green2D.html">二维Taylor-Green涡流动</a></li>
<li class="toctree-l1"><a class="reference internal" href="navier_stokes_inverse.html">Navier-Stokes方程反问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="boltzmann.html">基于神经网络表示求解玻尔兹曼方程</a></li>
<li class="toctree-l1"><a class="reference internal" href="kovasznay.html">使用PINNs求解Kovasznay流问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="periodic_hill.html">雷诺平均Navier-Stokes方程求解周期山流动</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">利用PINNs求解二维带点源泊松方程</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#问题描述">问题描述</a></li>
<li class="toctree-l2"><a class="reference internal" href="#技术路径">技术路径</a></li>
<li class="toctree-l2"><a class="reference internal" href="#创建数据集">创建数据集</a></li>
<li class="toctree-l2"><a class="reference internal" href="#构建模型">构建模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="#约束">约束</a></li>
<li class="toctree-l2"><a class="reference internal" href="#优化器">优化器</a></li>
<li class="toctree-l2"><a class="reference internal" href="#模型训练">模型训练</a></li>
<li class="toctree-l2"><a class="reference internal" href="#模型推理及可视化">模型推理及可视化</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">数据驱动</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_steady.html">AI工业流体仿真模型——东方御风</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_FNO1D.html">基于FNO求解一维Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO2D.html">基于FNO求解二维Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/burgers_KNO1D.html">基于KNO求解一维Burgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_KNO2D.html">基于KNO求解二维Navier-Stokes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/2D_unsteady.html">数据驱动(FNO2D和UNET2D两种backbone)下跨声速翼型复杂流场的多时间步预测</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/flow_around_sphere.html">ResUnet3D-三维非定常流场预测</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_driven/navier_stokes_FNO3D.html">基于Fourier Neural Operator的Navier-Stokes equation求解</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">数据机理融合</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/pde_net.html">PDE-Net求解对流扩散方程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn2d.html">PeRCNN求解2D burgers方程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_mechanism_fusion/percnn3d.html">PeRCNN求解3D 反应扩散方程</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">可微分CFD求解器</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/lax_tube.html">一维Lax激波管</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/sod_tube.html">一维Sod激波管</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/couette.html">二维库埃特流</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cfd_solver/riemann2d.html">二维黎曼问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cell.html">mindflow.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.cfd.html">mindflow.cfd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.common.html">mindflow.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.data.html">mindflow.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.geometry.html">mindflow.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.loss.html">mindflow.loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.operators.html">mindflow.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mindflow.pde.html">mindflow.pde</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>利用PINNs求解二维带点源泊松方程</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/physics_driven/poisson_point_source.ipynb.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="利用pinns求解二维带点源泊松方程">
<h1>利用PINNs求解二维带点源泊松方程<a class="headerlink" href="#利用pinns求解二维带点源泊松方程" title="永久链接至标题"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/zh_cn/physics_driven/mindspore_poisson_point_source.ipynb"><img alt="下载Notebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_notebook.svg" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r2.2/mindflow/zh_cn/physics_driven/mindspore_poisson_point_source.py"><img alt="下载样例代码" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_download_code.svg" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.2/docs/mindflow/docs/source_zh_cn/physics_driven/mindspore_poisson_point_source.ipynb"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.2/resource/_static/logo_source.svg" /></a></p>
<section id="问题描述">
<h2>问题描述<a class="headerlink" href="#问题描述" title="永久链接至标题"></a></h2>
<p>本案例演示如何利用PINNs方法求解二维带点源的泊松方程：</p>
<div class="math notranslate nohighlight">
\[\Delta u = - \delta(x-x_{src})\delta(y-y_{src}).\]</div>
<p>其中 <span class="math notranslate nohighlight">\((x_{src}, y_{src})\)</span> 为点源位置对应的坐标。 点源在数学上可以用狄拉克 <span class="math notranslate nohighlight">\(\delta\)</span> 函数来表示：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\delta(x) = \begin{cases}
+\infty, &amp; x = 0    \\
0,       &amp; x \neq 0
\end{cases}
\qquad
\int_{-\infty}^{+\infty}\delta(x)dx = 1.\end{split}\]</div>
<p>当求解域 <span class="math notranslate nohighlight">\(\Omega=[0,\pi]^2\)</span> 时， 二维带点源的泊松方程的解析解为：</p>
<div class="math notranslate nohighlight">
\[u(x,y) = \frac{4}{\pi^2} \sum_{i=1}^{\infty} \sum_{j=1}^{\infty}\frac{\sin{(i x)}\sin{(i x_{src})}\sin{(j y)}\sin{(j y_{src})}}{i^2 + j^2}.\]</div>
<p>与该案例相对应的论文为： <a class="reference external" href="https://www.ijcai.org/proceedings/2022/0533.pdf">Xiang Huang, Hongsheng Liu, Beiji Shi, Zidong Wang, Kang Yang, Yang Li, Min Wang, Haotian Chu, Jing Zhou, Fan Yu, Bei Hua, Bin Dong, Lei Chen. “A Universal PINNs Method for Solving Partial Differential Equations with a Point Source”. Thirty-First International Joint Conference on Artificial Intelligence (IJCAI 2022), Vienna, Austria, Jul, 2022, Pages 3839-3846.</a></p>
</section>
<section id="技术路径">
<h2>技术路径<a class="headerlink" href="#技术路径" title="永久链接至标题"></a></h2>
<p>MindSpore Flow求解该问题的具体流程如下：</p>
<ol class="arabic simple">
<li><p>创建训练数据集。</p></li>
<li><p>构建模型。</p></li>
<li><p>优化器。</p></li>
<li><p>约束。</p></li>
<li><p>模型训练。</p></li>
<li><p>模型推理及可视化。</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">mindflow</span> <span class="kn">import</span> <span class="n">load_yaml_config</span>

<span class="kn">from</span> <span class="nn">src.dataset</span> <span class="kn">import</span> <span class="n">create_train_dataset</span><span class="p">,</span> <span class="n">create_test_dataset</span>
<span class="kn">from</span> <span class="nn">src.poisson</span> <span class="kn">import</span> <span class="n">Poisson</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">calculate_l2_error</span><span class="p">,</span> <span class="n">visual</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>

<span class="c1"># Load config</span>
<span class="n">file_cfg</span> <span class="o">=</span> <span class="s2">&quot;poisson_cfg.yaml&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_yaml_config</span><span class="p">(</span><span class="n">file_cfg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="创建数据集">
<h2>创建数据集<a class="headerlink" href="#创建数据集" title="永久链接至标题"></a></h2>
<p>本案例在求解域、边值条件、点源区域（以点源位置为中心的矩形区域）进行随机采样，生成训练数据集。具体方法见<code class="docutils literal notranslate"><span class="pre">src/dataset.py</span></code>。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the dataset</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_train_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="构建模型">
<h2>构建模型<a class="headerlink" href="#构建模型" title="永久链接至标题"></a></h2>
<p>本案例采用结合了sin激活函数的多尺度神经网络。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindflow.cell</span> <span class="kn">import</span> <span class="n">MultiScaleFCSequential</span>

<span class="c1"># Create the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiScaleFCSequential</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;in_channels&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;out_channels&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span>
                               <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;neurons&#39;</span><span class="p">],</span>
                               <span class="n">residual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">act</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;activation&#39;</span><span class="p">],</span>
                               <span class="n">num_scales</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;num_scales&#39;</span><span class="p">],</span>
                               <span class="n">amp_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                               <span class="n">scale_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                               <span class="n">input_scale</span><span class="o">=</span><span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span>
                               <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="约束">
<h2>约束<a class="headerlink" href="#约束" title="永久链接至标题"></a></h2>
<p>在利用<code class="docutils literal notranslate"><span class="pre">mindflow</span></code>求解PDE时，我们需要写一个<code class="docutils literal notranslate"><span class="pre">mindflow.PDEWithLloss</span></code>的子类来定义控制方程和边界条件分别对应的损失函数项（<code class="docutils literal notranslate"><span class="pre">loss_pde</span></code>和<code class="docutils literal notranslate"><span class="pre">loss_bc</span></code>）。因为点源区域需要加密采样点，所以我们额外增加了一个损失函数项（<code class="docutils literal notranslate"><span class="pre">loss_src</span></code>）。</p>
<p>当PINNs方法将控制方程的残差作为损失函数项来约束神经网络时，狄拉克<span class="math notranslate nohighlight">\(\delta\)</span>函数的奇异性使得神经网络的训练无法收敛，因此我们采用二维拉普拉斯分布的概率密度函数去近似狄拉克 <span class="math notranslate nohighlight">\(\delta\)</span> 函数，即：</p>
<div class="math notranslate nohighlight">
\[\eta_{\alpha}(x, y) = \frac{1}{4\alpha^2} exp({-\frac{|x-x_{src}|+|y-y_{src}|}{\alpha}}) \qquad \underrightarrow{approx} \qquad \delta(x-x_{src})\delta(y-y_{src}).\]</div>
<p>其中 <span class="math notranslate nohighlight">\(\alpha\)</span> 为核宽度。理论上来说，只要核宽度 <span class="math notranslate nohighlight">\(\alpha\)</span> 充分小，那么上述概率密度函数就能很好地近似狄拉克 <span class="math notranslate nohighlight">\(\delta\)</span> 函数。但是实际上核宽度 <span class="math notranslate nohighlight">\(\alpha\)</span> 的选取对于近似效果有着重要影响。当 <span class="math notranslate nohighlight">\(\alpha\)</span> 太大时，概率密度函数 <span class="math notranslate nohighlight">\(\eta_{\alpha}(x, y)\)</span> 与狄拉克 <span class="math notranslate nohighlight">\(\delta\)</span> 函数之间的近似误差会变大。但如果 <span class="math notranslate nohighlight">\(\alpha\)</span> 太小，训练过程可能不会收敛，或者收敛后的精度可能很差。因此，<span class="math notranslate nohighlight">\(\alpha\)</span> 需要进行手工调参。我们这里将其确定为 <span class="math notranslate nohighlight">\(\alpha=0.01\)</span>。</p>
<p>在求解区域内、边界、点源区域均采用L2损失，并利用<code class="docutils literal notranslate"><span class="pre">mindflow</span></code>的<code class="docutils literal notranslate"><span class="pre">MTLWeightedLoss</span></code>多目标损失函数将这三个损失函数项结合起来。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">ms_np</span>
<span class="kn">from</span> <span class="nn">mindflow</span> <span class="kn">import</span> <span class="n">PDEWithLoss</span><span class="p">,</span> <span class="n">MTLWeightedLoss</span><span class="p">,</span> <span class="n">sympy_to_mindspore</span>

<span class="k">class</span> <span class="nc">Poisson</span><span class="p">(</span><span class="n">PDEWithLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define the loss of the Poisson equation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x y&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># kernel width</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Poisson</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_nodes</span> <span class="o">=</span> <span class="n">sympy_to_mindspore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">MTLWeightedLoss</span><span class="p">(</span><span class="n">num_losses</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the gonvering equation.&quot;&quot;&quot;</span>
        <span class="n">uu_xx</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">uu_yy</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Use Laplace probability density function to approximate the Dirac \delta function.</span>
        <span class="n">x_src</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_src</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">force_term</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sympy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span>
            <span class="n">sympy</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_src</span><span class="p">)</span> <span class="o">+</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_src</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>

        <span class="n">poisson</span> <span class="o">=</span> <span class="n">uu_xx</span> <span class="o">+</span> <span class="n">uu_yy</span> <span class="o">+</span> <span class="n">force_term</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;poisson&quot;</span><span class="p">:</span> <span class="n">poisson</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">equations</span>

    <span class="k">def</span> <span class="nf">bc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the boundary condition.&quot;&quot;&quot;</span>
        <span class="n">bc_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>

        <span class="n">equations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bc&quot;</span><span class="p">:</span> <span class="n">bc_eq</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">equations</span>

    <span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the loss function.&quot;&quot;&quot;</span>
        <span class="n">res_pde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pde_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">pde_data</span><span class="p">)</span>
        <span class="n">res_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">bc_data</span><span class="p">)</span>
        <span class="n">res_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pde_nodes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">src_data</span><span class="p">)</span>

        <span class="n">loss_pde</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_pde</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">loss_bc</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">loss_src</span> <span class="o">=</span> <span class="n">ms_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">((</span><span class="n">loss_pde</span><span class="p">,</span> <span class="n">loss_bc</span><span class="p">,</span> <span class="n">loss_src</span><span class="p">))</span>

<span class="c1"># Create the problem and optimizer</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">Poisson</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
poisson: Derivative(u(x, y), (x, 2)) + Derivative(u(x, y), (y, 2)) + 2500.0*exp(-100.0*Abs(x - pi/2))*exp(-100.0*Abs(y - pi/2))
    Item numbers of current derivative formula nodes: 3
bc: u(x, y)
    Item numbers of current derivative formula nodes: 1
</pre></div></div>
</div>
</section>
<section id="优化器">
<h2>优化器<a class="headerlink" href="#优化器" title="永久链接至标题"></a></h2>
<p>本案例采用Adam优化器，并在训练进行到40%、60%、80%时，学习率衰减为初始学习率的1/10、1/100、1/1000。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">250</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span> <span class="o">+</span> <span class="n">problem</span><span class="o">.</span><span class="n">loss_fn</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">()</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">milestone</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">steps_per_epoch</span> <span class="o">*</span> <span class="n">n_epochs</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]]</span>
<span class="n">lr_init</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">][</span><span class="s2">&quot;initial_lr&quot;</span><span class="p">]</span>
<span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">lr_init</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="n">lr_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">piecewise_constant_lr</span><span class="p">(</span><span class="n">milestone</span><span class="p">,</span> <span class="n">learning_rates</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="模型训练">
<h2>模型训练<a class="headerlink" href="#模型训练" title="永久链接至标题"></a></h2>
<p>使用MindSpore&gt;= 2.0.0的版本，可以使用函数式编程范式训练神经网络。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">get_loss</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_ascend</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">is_finite</span> <span class="o">=</span> <span class="n">all_finite</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_finite</span><span class="p">:</span>
                <span class="n">grads</span> <span class="o">=</span> <span class="n">loss_scaler</span><span class="o">.</span><span class="n">unscale</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
            <span class="n">loss_scaler</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">is_finite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">):</span>
        <span class="n">local_time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">pde_data</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">i_epoch</span><span class="si">}</span><span class="s2"> train loss: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="sa">f</span><span class="s2">&quot; epoch time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">local_time_beg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_epochs</span><span class="p">):</span>
        <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">i_epoch</span><span class="p">)</span>

<span class="n">time_beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">train</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End-to-End total time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_beg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch: 1 train loss: 27463.34765625 epoch time: 21.84s
epoch: 2 train loss: 22351.10351562 epoch time: 12.35s
epoch: 3 train loss: 15621.81347656 epoch time: 12.36s
epoch: 4 train loss: 11910.88671875 epoch time: 12.41s
epoch: 5 train loss: 7340.56933594 epoch time: 12.45s
epoch: 6 train loss: 7032.89843750 epoch time: 12.44s
epoch: 7 train loss: 3993.34130859 epoch time: 12.46s
epoch: 8 train loss: 2885.75390625 epoch time: 12.43s
epoch: 9 train loss: 1879.61999512 epoch time: 12.40s
epoch: 10 train loss: 3002.69677734 epoch time: 12.36s
...
epoch: 241 train loss: 6.00261974 epoch time: 12.34s
epoch: 242 train loss: 6.08083344 epoch time: 12.38s
epoch: 243 train loss: 6.05793428 epoch time: 12.36s
epoch: 244 train loss: 6.05963135 epoch time: 12.36s
epoch: 245 train loss: 5.88465643 epoch time: 12.43s
epoch: 246 train loss: 6.06778002 epoch time: 12.36s
epoch: 247 train loss: 5.94315052 epoch time: 12.40s
epoch: 248 train loss: 6.28999186 epoch time: 12.44s
epoch: 249 train loss: 5.82442093 epoch time: 12.47s
epoch: 250 train loss: 5.86588335 epoch time: 12.44s
End-to-End total time: 3099.2 s
</pre></div></div>
</div>
</section>
<section id="模型推理及可视化">
<h2>模型推理及可视化<a class="headerlink" href="#模型推理及可视化" title="永久链接至标题"></a></h2>
<p>计算相对L2误差以及绘制参考解和模型预测结果的对比图。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">calculate_l2_error</span><span class="p">,</span> <span class="n">visual</span>

<span class="c1"># Create the dataset</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">create_test_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="n">calculate_l2_error</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">)</span>

<span class="c1"># Visual comparison of label and prediction</span>
<span class="n">visual</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Relative L2 error:   0.0154
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/physics_driven_poisson_point_source_14_1.png" src="../_images/physics_driven_poisson_point_source_14_1.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="periodic_hill.html" class="btn btn-neutral float-left" title="雷诺平均Navier-Stokes方程求解周期山流动" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../data_driven/2D_steady.html" class="btn btn-neutral float-right" title="AI工业流体仿真模型——东方御风" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>