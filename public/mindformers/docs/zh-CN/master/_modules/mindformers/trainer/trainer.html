

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mindformers.trainer.trainer &mdash; MindSpore master 文档</title>
  

  
   
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/translations.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers_install.html">确认系统环境信息</a></li>
</ul>
<p class="caption"><span class="caption-text">BERT微调</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers_bert_finetune.html">使用mindformers中的BERT微调</a></li>
</ul>
<p class="caption"><span class="caption-text">API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.html">mindformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.core.html">mindformers.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.dataset.html">mindformers.dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.models.html">mindformers.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.modules.html">mindformers.modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.pipeline.html">mindformers.pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.trainer.html">mindformers.trainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindformers.wrapper.html">mindformers.wrapper</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">模块代码</a> &raquo;</li>
        
      <li>mindformers.trainer.trainer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>mindformers.trainer.trainer 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2022 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;Trainer API For Import.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL.Image</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">TrainOneStepCell</span><span class="p">,</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">Cell</span>
<span class="kn">from</span> <span class="nn">mindspore.train</span> <span class="kn">import</span> <span class="n">Callback</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset</span> <span class="kn">import</span> <span class="n">GeneratorDataset</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.engine.datasets</span> <span class="kn">import</span> <span class="n">BatchDataset</span><span class="p">,</span> <span class="n">RepeatDataset</span>

<span class="kn">from</span> <span class="nn">mindformers.core.parallel_config</span> <span class="kn">import</span> <span class="n">build_parallel_config</span>
<span class="kn">from</span> <span class="nn">mindformers.dataset</span> <span class="kn">import</span> <span class="n">build_dataset</span><span class="p">,</span> <span class="n">build_dataset_loader</span><span class="p">,</span> \
    <span class="n">check_dataset_config</span><span class="p">,</span> <span class="n">BaseDataset</span>
<span class="kn">from</span> <span class="nn">mindformers.mindformer_book</span> <span class="kn">import</span> <span class="n">MindFormerBook</span>
<span class="kn">from</span> <span class="nn">mindformers.models</span> <span class="kn">import</span> <span class="n">build_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">BaseImageProcessor</span><span class="p">,</span> \
    <span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">BaseAudioProcessor</span>
<span class="kn">from</span> <span class="nn">mindformers.tools.cloud_adapter</span> <span class="kn">import</span> <span class="n">CFTS</span>
<span class="kn">from</span> <span class="nn">mindformers.tools.logger</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">mindformers.tools.register</span> <span class="kn">import</span> <span class="n">MindFormerConfig</span><span class="p">,</span> <span class="n">MindFormerRegister</span>
<span class="kn">from</span> <span class="nn">mindformers.tools.register.config</span> <span class="kn">import</span> <span class="n">ordered_yaml_dump</span>
<span class="kn">from</span> <span class="nn">.build_trainer</span> <span class="kn">import</span> <span class="n">build_trainer</span>
<span class="kn">from</span> <span class="nn">.config_args</span> <span class="kn">import</span> <span class="n">ConfigArguments</span>
<span class="kn">from</span> <span class="nn">.training_args</span> <span class="kn">import</span> <span class="n">TrainingArguments</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">check_train_data_loader_type</span><span class="p">,</span> <span class="n">check_eval_data_loader_type</span><span class="p">,</span> \
    <span class="n">check_optimizer_and_lr_type</span><span class="p">,</span> <span class="n">check_wrapper_config</span><span class="p">,</span> <span class="n">config2dict</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Trainer&#39;</span><span class="p">]</span>

<span class="n">SUPPORT_TASKS</span> <span class="o">=</span> <span class="n">MindFormerBook</span><span class="p">()</span><span class="o">.</span><span class="n">get_trainer_support_task_list</span><span class="p">()</span>
<span class="n">SUPPORT_MODEL_NAMES</span> <span class="o">=</span> <span class="n">MindFormerBook</span><span class="p">()</span><span class="o">.</span><span class="n">get_model_name_support_list</span><span class="p">()</span>
<span class="n">SUPPORT_PIPELINES</span> <span class="o">=</span> <span class="n">MindFormerBook</span><span class="p">()</span><span class="o">.</span><span class="n">get_pipeline_support_task_list</span><span class="p">()</span>
<span class="n">SUPPORT_PIPELINE_INPUT_DATA</span> <span class="o">=</span> <span class="n">MindFormerBook</span><span class="p">()</span><span class="o">.</span><span class="n">get_pipeline_support_input_data_list</span><span class="p">()</span>
<span class="n">CURRENT_PROJECT_PATH</span> <span class="o">=</span> <span class="n">MindFormerBook</span><span class="p">()</span><span class="o">.</span><span class="n">get_project_path</span><span class="p">()</span>
<span class="n">DEFAULT_CHECKPOINT_DIR</span> <span class="o">=</span> <span class="s1">&#39;checkpoint&#39;</span>
<span class="n">DEFAULT_CONFIG_DIR</span> <span class="o">=</span> <span class="s1">&#39;configs&#39;</span>


<div class="viewcode-block" id="Trainer"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer">[文档]</a><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trainer package to train\evaluate\predict class.</span>

<span class="sd">    The trainer interface is used to quickly start training, evaluation and predict</span>
<span class="sd">    for integrated tasks. It also allows users to customize the model, optimizer, dataset,</span>
<span class="sd">    tokenizer, processor, train_one_step, callback, and metric.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (Optional[Union[str, dict, ConfigArguments, TrainingArguments]]): The task config which is used to</span>
<span class="sd">            configure the dataset, the hyper-parameter, optimizer, etc. It support yaml path or</span>
<span class="sd">            config dict or ConfigArguments class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        task (str): The task name supported.</span>
<span class="sd">            Please refer to https://gitee.com/mindspore/transformer#%E4%BB%8B%E7%BB%8D.</span>
<span class="sd">            Default: &#39;general&#39;.</span>
<span class="sd">        model (Optional[Union[str, Cell, BaseModel]]): The network for trainer.</span>
<span class="sd">            It support model name supported or BaseModel or MindSpore Cell class.</span>
<span class="sd">            Supported model name can refer to https://gitee.com/mindspore/transformer#%E4%BB%8B%E7%BB%8D.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        train_dataset (Optional[Union[str, BaseDataset]]): The training dataset. It support real dataset path or</span>
<span class="sd">            BaseDateset class or MindSpore Dataset class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        eval_dataset (Optional[Union[str, BaseDataset]]): The evaluate dataset. It support real dataset path or</span>
<span class="sd">            BaseDateset class or MindSpore Dataset class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        tokenizer (Optional[BaseTokenizer]): The tokenizer for text preprocessing. It support BaseTokenizer class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        image_processor (Optional[BaseImageProcessor]): The processor for image preprocessing.</span>
<span class="sd">            It support BaseImageProcessor class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        audio_processor (Optional[BaseAudioProcessor]): The processor for audio preprocessing.</span>
<span class="sd">            It support BaseAudioProcessor class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        optimizers (Optional[Optimizer]): The training network&#39;s optimizer. It support Optimizer class of MindSpore.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        wrapper (Optional[TrainOneStepCell]): Wraps the `network` with the `optimizer`.</span>
<span class="sd">            It support TrainOneStepCell class of MindSpore.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        callbacks (Optional[Union[Callback, List[Callback]]]): The training callback function.</span>
<span class="sd">            It support CallBack or CallBack List of MindSpore.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        eval_callbacks (Optional[Union[Callback, List[Callback]]]): The evaluate callback function.</span>
<span class="sd">            It support CallBack or CallBack List of MindSpore.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        compute_metrics (Optional[Union[dict, set]]): The metric of evaluating.</span>
<span class="sd">            It support dict or set in MindSpore&#39;s Metric class.</span>
<span class="sd">            Default: None.</span>
<span class="sd">        save_config (bool): Save current the config of task. Default: False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If &#39;task&#39; or &#39;model&#39; not in supported trainer.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindformers import Trainer</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindspore.dataset import GeneratorDataset</span>
<span class="sd">        &gt;&gt;&gt; class MyDataLoader:</span>
<span class="sd">        ...    def __init__(self):</span>
<span class="sd">        ...        self._data = [np.zeros((3, 224, 224), np.float32) for _ in range(64)]</span>
<span class="sd">        ...</span>
<span class="sd">        ...    def __getitem__(self, index):</span>
<span class="sd">        ...        return self._data[index]</span>
<span class="sd">        ...</span>
<span class="sd">        ...    def __len__(self):</span>
<span class="sd">        ...        return len(self._data)</span>
<span class="sd">        &gt;&gt;&gt; #1) input task name and model name to init trainer</span>
<span class="sd">        &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">        ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">        ...                        train_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #2) input config to init trainer</span>
<span class="sd">        &gt;&gt;&gt; from mindformers.trainer.config_args import ConfigArguments, OptimizerConfig, \</span>
<span class="sd">        ...     RunnerConfig, LRConfig, WrapperConfig</span>
<span class="sd">        &gt;&gt;&gt; from mindspore.nn import AdamWeightDecay, WarmUpLR, \</span>
<span class="sd">        ...     DynamicLossScaleUpdateCell, TrainOneStepWithLossScaleCell</span>
<span class="sd">        &gt;&gt;&gt; from mindspore.train.callback import LossMonitor</span>
<span class="sd">        &gt;&gt;&gt; runner_config = RunnerConfig(epochs=10, batch_size=2, image_size=224)</span>
<span class="sd">        &gt;&gt;&gt; lr_schedule_config = LRConfig(lr_type=&#39;WarmUpLR&#39;, learning_rate=0.001, warmup_steps=10)</span>
<span class="sd">        &gt;&gt;&gt; optim_config = OptimizerConfig(optim_type=&#39;Adam&#39;, beta1=0.009, learning_rate=lr_schedule_config)</span>
<span class="sd">        &gt;&gt;&gt; loss_scale = DynamicLossScaleUpdateCell(loss_scale_value=2**12, scale_factor=2, scale_window=1000)</span>
<span class="sd">        &gt;&gt;&gt; wrapper_config = WrapperConfig(wrapper_type=&#39;TrainOneStepWithLossScaleCell&#39;, scale_sense=loss_scale)</span>
<span class="sd">        &gt;&gt;&gt; dataset = GeneratorDataset(source=MyDataLoader(), column_names=&#39;image&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dataset = dataset.batch(batch_size=2)</span>
<span class="sd">        &gt;&gt;&gt; config = ConfigArguments(seed=2022, runner_config=runner_config,</span>
<span class="sd">        ...                          optimizer=optim_config, runner_wrapper=wrapper_config)</span>
<span class="sd">        &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">        ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">        ...                        args=config, train_dataset=dataset)</span>
<span class="sd">        &gt;&gt;&gt; #3) input instance to init trainer</span>
<span class="sd">        &gt;&gt;&gt; from mindformers.models import ViTForImageClassification</span>
<span class="sd">        &gt;&gt;&gt; vit_model_with_loss = ViTForImageClassification()</span>
<span class="sd">        &gt;&gt;&gt; lr_schedule = WarmUpLR(learning_rate=0.001, warmup_steps=100)</span>
<span class="sd">        &gt;&gt;&gt; optimizer = AdamWeightDecay(beta1=0.009, beta2=0.999,</span>
<span class="sd">        ...                             learning_rate=lr_schedule,</span>
<span class="sd">        ...                             params=vit_model_with_loss.trainable_params())</span>
<span class="sd">        &gt;&gt;&gt; loss_cb = LossMonitor(per_print_times=2)</span>
<span class="sd">        &gt;&gt;&gt; callbacks = [loss_cb]</span>
<span class="sd">        &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">        ...                        model=vit_model_with_loss,</span>
<span class="sd">        ...                        args=config,</span>
<span class="sd">        ...                        optimizers=optimizer,</span>
<span class="sd">        ...                        train_dataset=dataset,</span>
<span class="sd">        ...                        callbacks=callbacks)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ConfigArguments</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;general&#39;</span><span class="p">,</span>
                 <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseTokenizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseImageProcessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">audio_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseAudioProcessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">optimizers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Optimizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">wrapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TrainOneStepCell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">callbacks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callback</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callback</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">eval_callbacks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callback</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callback</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">compute_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">save_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizers</span> <span class="o">=</span> <span class="n">optimizers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span> <span class="o">=</span> <span class="n">image_processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_processor</span> <span class="o">=</span> <span class="n">audio_processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_callbacks</span> <span class="o">=</span> <span class="n">eval_callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_checkpoint_name_or_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configs_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_DIR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_DIR</span><span class="p">)):</span>
            <span class="n">configs_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_DIR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CURRENT_PROJECT_PATH</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_DIR</span><span class="p">)):</span>
                <span class="n">mindformers_configs_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CURRENT_PROJECT_PATH</span><span class="p">,</span> <span class="n">DEFAULT_CONFIG_DIR</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">mindformers_configs_directory</span><span class="p">,</span> <span class="n">configs_directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;wrapper has existed, input model invalid, it should be include in wrapper.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimizers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;wrapper has existed, input optimizers invalid, it should be include in wrapper.&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">SUPPORT_TASKS</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
            <span class="sa">f</span><span class="s2">&quot;task name must be in </span><span class="si">{</span><span class="n">SUPPORT_TASKS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">, but get </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">SUPPORT_MODEL_NAMES</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s2">&quot;model must be in </span><span class="si">{</span><span class="n">SUPPORT_MODEL_NAMES</span><span class="si">}</span><span class="s2"> when model&#39;s type is string, but get </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;common&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">Cell</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The model instance has been entered, &quot;</span>
                        <span class="s2">&quot;and the model will not be created from model_config&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_model_instance</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_model_instance</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">task_config</span> <span class="o">=</span> <span class="n">MindFormerConfig</span><span class="p">(</span><span class="n">SUPPORT_TASKS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;common&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task_config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task_config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">task_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">task_config</span><span class="o">.</span><span class="n">merge_from_dict</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> \
                    <span class="sa">f</span><span class="s2">&quot;config path must be exist, but get </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">)),</span> \
                    <span class="sa">f</span><span class="s2">&quot;config file must be end with .yaml or .yml, but get </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">task_config</span> <span class="o">=</span> <span class="n">MindFormerConfig</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">ConfigArguments</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;train_dataset&#39;</span><span class="p">):</span>
                    <span class="n">check_train_data_loader_type</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">task_config</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;eval_dataset&#39;</span><span class="p">):</span>
                    <span class="n">check_eval_data_loader_type</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">task_config</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;optimizer&#39;</span><span class="p">):</span>
                    <span class="n">check_optimizer_and_lr_type</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">task_config</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;runner_wrapper&#39;</span><span class="p">):</span>
                    <span class="n">check_wrapper_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">task_config</span><span class="p">)</span>
                <span class="n">task_config</span><span class="o">.</span><span class="n">merge_from_dict</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;When using the TrainingArguments class, &quot;</span>
                    <span class="s2">&quot;its arguments will override the default config configuration,&quot;</span>
                    <span class="s2">&quot;so it is required to inherit the TrainingArguments configuration,&quot;</span>
                    <span class="s2">&quot;corresponding to the task and the complete training configuration of the model.&quot;</span>
                    <span class="s2">&quot;Otherwise, it will affect the default configuration parameters and cause training problems.&quot;</span>
                    <span class="s2">&quot;It is recommended to use the ConfigArguments class for training configuration.&quot;</span>
                <span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">convert_args_to_mindformers_config</span><span class="p">(</span><span class="n">task_config</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">task_config</span>

        <span class="k">if</span> <span class="n">save_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;save running config success of </span><span class="si">%s</span><span class="s2">_new.&quot;</span><span class="p">,</span> <span class="n">task_config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># check dataset config</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;train dataset path must be exist, but get </span><span class="si">{</span><span class="n">train_dataset</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">train_dataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;eval dataset path must be exist, but get </span><span class="si">{</span><span class="n">eval_dataset</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">eval_dataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="n">check_dataset_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># build parallel config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RANK_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RANK_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel</span>
        <span class="n">build_parallel_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># set cloud file transform for ModelArts.</span>
        <span class="n">cfts</span> <span class="o">=</span> <span class="n">CFTS</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">aicc_config</span><span class="p">)</span>
        <span class="n">MindFormerRegister</span><span class="o">.</span><span class="n">register_cls</span><span class="p">(</span><span class="n">cfts</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;cfts&#39;</span><span class="p">)</span>

        <span class="c1"># set seed</span>
        <span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># set output directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;LOCAL_DEFAULT_PATH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># pprint last config</span>
        <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># build task trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">build_trainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s2">&quot;config must be contain &#39;trainer&#39; key, but get None.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.train"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.train">[文档]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume_or_finetune_from_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">initial_epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">do_eval</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">do_finetune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Train task for Trainer.</span>
<span class="sd">        This function is used to train or fine-tune the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            resume_or_finetune_from_checkpoint (Optional[Union[str, bool]]):</span>
<span class="sd">                Used to restore training or fine-tune the weight of the network.</span>
<span class="sd">                It support real checkpoint path or valid model name of mindformers or bool value.</span>
<span class="sd">                if it&#39;s true, the last checkpoint file saved from the previous training round is automatically used.</span>
<span class="sd">                if do_finetune is true, this checkpoint will be used to finetune the network.</span>
<span class="sd">                Default: False.</span>
<span class="sd">            initial_epoch (int): Epoch at which to start train, it used for resuming a previous training run.</span>
<span class="sd">                Default: 0.</span>
<span class="sd">            do_eval (bool): Whether evaluations are performed during training. Default: False.</span>
<span class="sd">            do_finetune: Whether to finetune network. When it&#39;s true, resume_or_finetune_from_checkpoint must be input.</span>
<span class="sd">                Default: False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: if resume_or_finetune_from_checkpoint is not bool or str type.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">            ...                        train_dataset=&#39;data/imagenet/train&#39;,</span>
<span class="sd">            ...                        eval_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # 1) default train task to reproduce model.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.train()</span>
<span class="sd">            &gt;&gt;&gt; # 2) eval network when train task to reproduce model.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.train(do_eval=True)</span>
<span class="sd">            &gt;&gt;&gt; # 3) resume train task to auto load the last checkpoint, if training break after 10 epochs.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.train(resume_or_finetune_from_checkpoint=True, initial_epoch=10)</span>
<span class="sd">            &gt;&gt;&gt; # 4) resume train task according to checkpoint path, if training break after 10 epochs.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.train(</span>
<span class="sd">            ...     resume_or_finetune_from_checkpoint=&#39;./output/rank_0/checkpoint/mindformers.ckpt&#39;,</span>
<span class="sd">            ...     initial_epoch=10)</span>
<span class="sd">            &gt;&gt;&gt; # 5) finetune train task according to resume_or_finetune_from_checkpoint.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.train(resume_or_finetune_from_checkpoint=&#39;mae_vit_base_p16&#39;, do_finetune=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resume_or_finetune_from_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resume_or_finetune_from_checkpoint</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resume_or_finetune_from_checkpoint must be one of [None, string, bool], &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but get </span><span class="si">{</span><span class="n">resume_or_finetune_from_checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resume_or_finetune_from_checkpoint</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">resume_or_finetune_from_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">do_finetune</span> <span class="ow">and</span> <span class="n">resume_or_finetune_from_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;if do_finetune is true, &quot;</span>
                           <span class="s2">&quot;resume_or_finetune_from_checkpoint must be input and valid, &quot;</span>
                           <span class="s2">&quot;but it&#39;s None.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_eval</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">build_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset_task</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if do_eval is true, eval_dataset must be input, &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;the task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="si">}</span><span class="s2"> is not support eval now.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resume_or_finetune_from_checkpoint</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resume_or_finetune_checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_checkpoint</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resume_or_finetune_from_checkpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">do_finetune</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="n">resume_or_finetune_from_checkpoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resume_or_finetune_from_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">resume_or_finetune_checkpoint</span> <span class="o">=</span> <span class="n">resume_or_finetune_from_checkpoint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_checkpoint_name_or_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">initial_epoch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">runner_config</span><span class="o">.</span><span class="n">initial_epoch</span> <span class="o">=</span> <span class="n">initial_epoch</span>

        <span class="c1"># build network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_network</span><span class="p">(</span><span class="n">do_finetune</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizers</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="k">if</span> <span class="n">do_eval</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">wrapper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">is_full_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.evaluate"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.evaluate">[文档]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Evaluate task for Trainer.</span>
<span class="sd">        This function is used to evaluate the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            eval_checkpoint (Optional[Union[str, bool]]):</span>
<span class="sd">                Used to evaluate the weight of the network.</span>
<span class="sd">                It support real checkpoint path or valid model name of mindformers or bool value.</span>
<span class="sd">                if it&#39;s true, the last checkpoint file saved from the previous training round is automatically used.</span>
<span class="sd">                Default: False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: if eval_checkpoint is not bool or str type.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">            ...                        eval_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # 1) default evaluate task to test model.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.evaluate()</span>
<span class="sd">            &gt;&gt;&gt; # 2) evaluate task to auto load the last checkpoint.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.evaluate(eval_checkpoint=True)</span>
<span class="sd">            &gt;&gt;&gt; # 3) evaluate task according to checkpoint path.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.evaluate(eval_checkpoint=&#39;./output/rank_0/checkpoint/mindformers.ckpt&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eval_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_checkpoint</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;eval_checkpoint must be one of [None, string, bool], &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but get </span><span class="si">{</span><span class="n">eval_checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eval_checkpoint</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">eval_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_checkpoint_config</span><span class="p">(</span><span class="n">eval_checkpoint</span><span class="p">)</span>

        <span class="c1"># build network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_network</span><span class="p">(</span><span class="n">eval_checkpoint</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_callbacks</span><span class="p">,</span>
            <span class="n">is_full_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.predict"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.predict">[文档]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">predict_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">GeneratorDataset</span><span class="p">,</span>
                                           <span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Predict task for Trainer.</span>
<span class="sd">        This function is used to predict the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            predict_checkpoint (Optional[Union[str, bool]]):</span>
<span class="sd">                Used to predict the weight of the network.</span>
<span class="sd">                It support real checkpoint path or valid model name of mindformers or bool value.</span>
<span class="sd">                if it&#39;s true, the last checkpoint file saved from the previous training round is automatically used.</span>
<span class="sd">                Default: False.</span>
<span class="sd">            input_data (Optional[Union[Tensor, np.ndarray, Image, str, list]]): The predict data. Default: None.</span>

<span class="sd">        Return:</span>
<span class="sd">            predict result (dict).</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: if predict_checkpoint is not bool or str type.</span>
<span class="sd">            TypeError: if input_data is not Tensor or np.ndarray or Image or str or list.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;)</span>
<span class="sd">            &gt;&gt;&gt; input_data = &quot;./sunflower.png&quot;</span>
<span class="sd">            &gt;&gt;&gt; # 1) predict task to auto load the last checkpoint.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.predict(predict_checkpoint=True, input_data=input_data)</span>
<span class="sd">            &gt;&gt;&gt; # 2) predict task according to checkpoint path.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.predict(predict_checkpoint=&#39;./output/rank_0/checkpoint/mindformers.ckpt&#39;,</span>
<span class="sd">            ...                      input_data=input_data)</span>
<span class="sd">            &gt;&gt;&gt; # 3) download and auto load the checkpoint on obs and predict.</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.predict(input_data=input_data)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">predict_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predict_checkpoint</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;predict_checkpoint must be one of [None, string, bool], &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but get </span><span class="si">{</span><span class="n">predict_checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORT_PIPELINES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="si">}</span><span class="s2"> not support predict, &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;now this tasks </span><span class="si">{</span><span class="n">SUPPORT_PIPELINES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> is support predict.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predict_checkpoint</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">predict_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">build_dataset_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset</span><span class="o">.</span><span class="n">data_loader</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dataset by config is used as input_data.&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="p">(</span><span class="n">GeneratorDataset</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">,</span> <span class="n">RepeatDataset</span><span class="p">,</span> <span class="n">BatchDataset</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)),</span> \
            <span class="s2">&quot;Input data&#39;s type must be one of [GeneratorDataset,&quot;</span> \
            <span class="s2">&quot; str, ms.Tensor, np.ndarray, PIL.Image.Image]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_checkpoint_config</span><span class="p">(</span><span class="n">predict_checkpoint</span><span class="p">)</span>

        <span class="c1"># build network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_network</span><span class="p">(</span><span class="n">predict_checkpoint</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">image_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="p">,</span>
            <span class="n">audio_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_processor</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">is_full_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_result</span></div>

<div class="viewcode-block" id="Trainer.build_network"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.build_network">[文档]</a>    <span class="k">def</span> <span class="nf">build_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;build network for trainer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">!=</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;...........Start Init Network..........&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># set running mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="n">is_train</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;network will be create in </span><span class="si">%s</span><span class="s2"> task trainer class.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_model_instance</span> <span class="ow">and</span> <span class="n">input_checkpoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_model_checkpoint</span><span class="p">()</span></div>

<div class="viewcode-block" id="Trainer.set_parallel_config"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.set_parallel_config">[文档]</a>    <span class="k">def</span> <span class="nf">set_parallel_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">data_parallel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_parallel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expert_parallel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pipeline_stage</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">micro_batch_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimizer_shard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gradient_aggregation_group</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">vocab_emb_dp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set_parallel_config for the setting global data parallel, model parallel and fusion group.</span>
<span class="sd">        The parallel configure setting for Trainer.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_parallel (int): The data parallel way. The input data will be sliced into n parts for each layer</span>
<span class="sd">                according to the data parallel way. Default: 1.</span>
<span class="sd">            model_parallel (int): The model parallel way. The parameters of dense layers in MultiheadAttention and</span>
<span class="sd">                FeedForward layer will be sliced according to the model parallel way. Default: 1.</span>
<span class="sd">            expert_parallel (int): The expert parallel way. This is effective only when MoE (Mixture of Experts)</span>
<span class="sd">                is applied. This value specifies the number of partitions to split the experts into.</span>
<span class="sd">            pipeline_stage (int): The number of the pipeline stage. Should be a positive value. Default: 1.</span>
<span class="sd">            micro_batch_num (int): The micro size of the batches for the pipeline training. Default: 1.</span>
<span class="sd">            optimizer_shard (bool): Whether to enable optimizer shard. Default False.</span>
<span class="sd">            gradient_aggregation_group (int): The fusion group size of the optimizer state sharding. Default: 4.</span>
<span class="sd">            vocab_emb_dp (bool): Shard embedding in model parallel or data parallel. Default: True.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers.trainer import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">            ...                        train_dataset=&#39;data/imagenet/train&#39;,</span>
<span class="sd">            ...                        eval_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.set_parallel_config(data_parallel=2, model_parallel=2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">data_parallel</span> <span class="o">=</span> <span class="n">data_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">model_parallel</span> <span class="o">=</span> <span class="n">model_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">expert_parallel</span> <span class="o">=</span> <span class="n">expert_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">pipeline_stage</span> <span class="o">=</span> <span class="n">pipeline_stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">optimizer_shard</span> <span class="o">=</span> <span class="n">optimizer_shard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">micro_batch_num</span> <span class="o">=</span> <span class="n">micro_batch_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">vocab_emb_dp</span> <span class="o">=</span> <span class="n">vocab_emb_dp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parallel_config</span><span class="o">.</span><span class="n">gradient_aggregation_group</span> <span class="o">=</span> <span class="n">gradient_aggregation_group</span></div>

<div class="viewcode-block" id="Trainer.set_recompute_config"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.set_recompute_config">[文档]</a>    <span class="k">def</span> <span class="nf">set_recompute_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel_optimizer_comm_recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">mp_comm_recompute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recompute_slice_activation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set recompute config.</span>
<span class="sd">        TransformerRecomputeConfig for the setting recompute attributes for encoder/decoder layers.</span>

<span class="sd">        Args:</span>
<span class="sd">            recompute (bool): Enable recomputation of the transformer block or not. Default: False.</span>
<span class="sd">            parallel_optimizer_comm_recompute (bool): Specifies whether the communication operator allgathers</span>
<span class="sd">                introduced by optimizer shard are recomputed in auto parallel or semi auto parallel mode.</span>
<span class="sd">                Default: False.</span>
<span class="sd">            mp_comm_recompute (bool): Specifies whether the model parallel communication operators</span>
<span class="sd">                in the cell are recomputed in auto parallel or semi auto parallel mode. Default: True.</span>
<span class="sd">            recompute_slice_activation (bool): Slice the cell output which would remains in memory. Default: False.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers.trainer import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">            ...                        train_dataset=&#39;data/imagenet/train&#39;,</span>
<span class="sd">            ...                        eval_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.set_recompute_config(recompute=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recompute_config</span><span class="o">.</span><span class="n">recompute</span> <span class="o">=</span> <span class="n">recompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recompute_config</span><span class="o">.</span><span class="n">parallel_optimizer_comm_recompute</span> <span class="o">=</span> <span class="n">parallel_optimizer_comm_recompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recompute_config</span><span class="o">.</span><span class="n">mp_comm_recompute</span> <span class="o">=</span> <span class="n">mp_comm_recompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recompute_config</span><span class="o">.</span><span class="n">recompute_slice_activation</span> <span class="o">=</span> <span class="n">recompute_slice_activation</span></div>

<div class="viewcode-block" id="Trainer.set_moe_config"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.set_moe_config">[文档]</a>    <span class="k">def</span> <span class="nf">set_moe_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">expert_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">capacity_factor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                       <span class="n">aux_loss_factor</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">num_experts_chosen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">expert_group_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">group_wise_a2a</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">comp_comm_parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">comp_comm_parallel_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The configuration of MoE (Mixture of Expert).</span>

<span class="sd">        Args:</span>
<span class="sd">            expert_num (int): The number of experts employed. Default: 1</span>
<span class="sd">            capacity_factor (float): The factor is used to indicate how much to expand expert capacity,</span>
<span class="sd">                which is &gt;=1.0. Default: 1.1.</span>
<span class="sd">            aux_loss_factor (float): The factor is used to indicate how much the load balance loss (produced by the</span>
<span class="sd">                router) to be added to the entire model loss, which is &lt; 1.0. Default: 0.05.</span>
<span class="sd">            num_experts_chosen (int): The number of experts is chosen by each token and it should not be larger</span>
<span class="sd">                than expert_num. Default: 1.</span>
<span class="sd">            expert_group_size (int): The number of tokens in each data parallel group. Default: None. This parameter is</span>
<span class="sd">                effective only when in AUTO_PARALLEL mode, and NOT SHARDING_PROPAGATION.</span>
<span class="sd">            group_wise_a2a (bool): Whether to enable group-wise alltoall communication, which can reduce communication</span>
<span class="sd">                time by converting part of inter communication into intra communication. Default: False. This parameter</span>
<span class="sd">                is effective only when model parallel &gt; 1 and data_parallel equal to expert parallel.</span>
<span class="sd">            comp_comm_parallel (bool): Whether to enable ffn compute and communication parallel, which can reduce pure</span>
<span class="sd">                communicattion time by splitting and overlapping compute and communication. Default: False.</span>
<span class="sd">            comp_comm_parallel_degree (int): The split number of compute and communication. The larger the numbers,</span>
<span class="sd">                the more overlap there will be but will consume more memory. Default: 2. This parameter is effective</span>
<span class="sd">                only when comp_comm_parallel enable.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindformers.trainer import Trainer</span>
<span class="sd">            &gt;&gt;&gt; task_trainer = Trainer(task=&#39;image_classification&#39;,</span>
<span class="sd">            ...                        model=&#39;vit_base_p16&#39;,</span>
<span class="sd">            ...                        train_dataset=&#39;data/imagenet/train&#39;,</span>
<span class="sd">            ...                        eval_dataset=&#39;data/imagenet/train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; task_trainer.set_moe_config(expert_num=2, capacity_factor=1.2, aux_loss_factor=0.001)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">expert_num</span> <span class="o">=</span> <span class="n">expert_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">capacity_factor</span> <span class="o">=</span> <span class="n">capacity_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">aux_loss_factor</span> <span class="o">=</span> <span class="n">aux_loss_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">num_experts_chosen</span> <span class="o">=</span> <span class="n">num_experts_chosen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">expert_group_size</span> <span class="o">=</span> <span class="n">expert_group_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">group_wise_a2a</span> <span class="o">=</span> <span class="n">group_wise_a2a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">comp_comm_parallel</span> <span class="o">=</span> <span class="n">comp_comm_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">moe_config</span><span class="o">.</span><span class="n">comp_comm_parallel_degree</span> <span class="o">=</span> <span class="n">comp_comm_parallel_degree</span></div>

<div class="viewcode-block" id="Trainer.get_train_dataloader"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.get_train_dataloader">[文档]</a>    <span class="k">def</span> <span class="nf">get_train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get train dataloader of mindspore.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">build_dataset_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_loader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.get_eval_dataloader"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.get_eval_dataloader">[文档]</a>    <span class="k">def</span> <span class="nf">get_eval_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get eval dataloader of mindspore.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">build_dataset_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eval_dataset</span><span class="o">.</span><span class="n">data_loader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trainer.get_last_checkpoint"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.get_last_checkpoint">[文档]</a>    <span class="k">def</span> <span class="nf">get_last_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get last checkpoint for resuming or finetune.&quot;&quot;&quot;</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;rank_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_id</span><span class="p">),</span> <span class="n">DEFAULT_CHECKPOINT_DIR</span><span class="p">)</span>
        <span class="n">output_checkpoint_path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">checkpoint</span> <span class="k">for</span> <span class="n">checkpoint</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_checkpoint_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">output_checkpoint_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">output_checkpoint_path</span><span class="p">,</span>
                                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">output_checkpoint_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Trainer.save_config_to_yaml"><a class="viewcode-back" href="../../../trainer/mindformers.trainer.Trainer.html#mindformers.trainer.Trainer.save_config_to_yaml">[文档]</a>    <span class="k">def</span> <span class="nf">save_config_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;save now config file to yaml file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model_name</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">_reset_config_for_save</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configs_directory</span><span class="p">,</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_new&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">model_config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;model_config&#39;</span><span class="p">)</span>
        <span class="n">task_config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;task_config&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_config_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_config_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">task_config_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">task_config_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">model_config_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">model_config_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.yaml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
        <span class="n">dataset_config_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">task_config_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_dataset.yaml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
        <span class="n">runner_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task_config_dir</span><span class="p">,</span> <span class="s1">&#39;runner.yaml&#39;</span><span class="p">)</span>
        <span class="n">context_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">task_config_dir</span><span class="p">,</span> <span class="s1">&#39;context.yaml&#39;</span><span class="p">)</span>
        <span class="n">run_yaml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s1">&#39;run_</span><span class="si">{}</span><span class="s1">.yaml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

        <span class="n">_save_config_to_yaml</span><span class="p">(</span><span class="n">model_config_yaml_path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_config&#39;</span><span class="p">))</span>
        <span class="n">_save_config_to_yaml</span><span class="p">(</span><span class="n">dataset_config_yaml_path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">))</span>
        <span class="n">_save_config_to_yaml</span><span class="p">(</span><span class="n">runner_yaml_path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_config&#39;</span><span class="p">))</span>
        <span class="n">_save_config_to_yaml</span><span class="p">(</span><span class="n">context_yaml_path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_config&#39;</span><span class="p">))</span>
        <span class="n">_save_config_to_yaml</span><span class="p">(</span><span class="n">run_yaml_path</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run_config&#39;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_load_model_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load model checkpoint to network.&quot;&quot;&quot;</span>
        <span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span>
        <span class="k">if</span> <span class="n">checkpoint_name_or_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;checkpoint_name_or_path is None, not load input checkpoint.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint_name_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">is_exist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_name_or_path</span><span class="p">)</span>
            <span class="n">is_checkpoint_name</span> <span class="o">=</span> <span class="n">checkpoint_name_or_path</span> <span class="ow">in</span> <span class="n">SUPPORT_MODEL_NAMES</span>
            <span class="k">if</span> <span class="n">is_exist_path</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;now input valid checkpoint path, it will load to network.&quot;</span><span class="p">)</span>
                <span class="n">checkpoint_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">checkpoint_name_or_path</span><span class="p">)</span>
                <span class="n">not_load_params</span> <span class="o">=</span> <span class="n">load_param_into_net</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_dict</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;not load parameters is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">not_load_params</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">is_checkpoint_name</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;now input valid checkpoint name, it will load to network.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">Cell</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;model must be BaseModel or Cell type, but get </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;input checkpoint args is invalid, &quot;</span>
                               <span class="s2">&quot;it must be valid and real checkpoint path or a valid checkpoint name,&quot;</span>
                               <span class="s2">&quot;but get </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">checkpoint_name_or_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checkpoint_name_or_path type error, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;it should be one of [None, str], &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but get </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">checkpoint_name_or_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_checkpoint_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check checkpoint config.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_checkpoint</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="n">checkpoint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_checkpoint_name_or_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">checkpoint_name_or_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_checkpoint_name_or_path</span></div>


<span class="k">def</span> <span class="nf">_save_config_to_yaml</span><span class="p">(</span><span class="n">save_file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save Config to Yaml File.</span>

<span class="sd">    Args:</span>
<span class="sd">        save_file_path (str): The real path to save yaml file. Default: None.</span>
<span class="sd">        save_config (dict): The task config. Default: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_pointer</span><span class="p">:</span>
        <span class="n">file_pointer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">ordered_yaml_dump</span><span class="p">(</span>
                <span class="n">save_config</span><span class="p">,</span>
                <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">allow_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_reset_config_for_save</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;common&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Reset Config According to Yaml File Number.</span>
<span class="sd">    Args:</span>
<span class="sd">        config (dict): The task config. Default: None.</span>
<span class="sd">        model_name (str): The model name to save. Default: &#39;common&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_config&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
        <span class="s2">&quot;dataset_config&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
        <span class="s2">&quot;runner_config&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
        <span class="s2">&quot;context_config&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
        <span class="s2">&quot;run_config&quot;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;model_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processor&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">processor_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;processor&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;model_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;processor&#39;</span><span class="p">,</span> <span class="n">processor_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_dataset_task&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_dataset&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_dataset_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;train_dataset&#39;</span><span class="p">))</span>
        <span class="n">train_dataset_task_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;train_dataset_task&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;dataset_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;train_dataset&#39;</span><span class="p">,</span> <span class="n">train_dataset_config</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;dataset_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;train_dataset_task&#39;</span><span class="p">,</span> <span class="n">train_dataset_task_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_dataset_task&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_dataset&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eval_dataset_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;eval_dataset&#39;</span><span class="p">))</span>
        <span class="n">eval_dataset_task_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;eval_dataset_task&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;dataset_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;train_dataset&#39;</span><span class="p">,</span> <span class="n">eval_dataset_config</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;dataset_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;train_dataset_task&#39;</span><span class="p">,</span> <span class="n">eval_dataset_task_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">))</span>
        <span class="n">parallel_context_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;parallel&#39;</span><span class="p">))</span>
        <span class="n">moe_conifg</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;moe_config&#39;</span><span class="p">))</span>
        <span class="n">recompute_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recompute_config&#39;</span><span class="p">))</span>
        <span class="n">parallel_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;parallel_config&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;context_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="n">context_config</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;context_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="n">parallel_context_config</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;context_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;moe_conifg&#39;</span><span class="p">,</span> <span class="n">moe_conifg</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;context_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;recompute_config&#39;</span><span class="p">,</span> <span class="n">recompute_config</span><span class="p">)</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;context_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;parallel_config&#39;</span><span class="p">,</span> <span class="n">parallel_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_config&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">runner_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;runner_config&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;runner_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;runner_config&#39;</span><span class="p">,</span> <span class="n">runner_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_wrapper&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wrapper_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;runner_wrapper&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;runner_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;runner_wrapper&#39;</span><span class="p">,</span> <span class="n">wrapper_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optim_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;runner_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="n">optim_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lr_schedule&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lr_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lr_schedule&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;runner_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lr_schedule&#39;</span><span class="p">,</span> <span class="n">lr_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callbacks&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cb_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;callbacks&#39;</span><span class="p">))</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;runner_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;callbacks&#39;</span><span class="p">,</span> <span class="n">cb_config</span><span class="p">)</span>

    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;run_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;base_config&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;./task_config/context.yaml&#39;</span><span class="p">,</span>
        <span class="s1">&#39;./task_config/runner.yaml&#39;</span><span class="p">,</span>
        <span class="s1">&#39;./task_config/</span><span class="si">{}</span><span class="s1">_dataset.yaml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
        <span class="s1">&#39;./model_config/</span><span class="si">{}</span><span class="s1">.yaml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())])</span>

    <span class="n">run_config</span> <span class="o">=</span> <span class="n">config2dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">run_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;run_config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config_dict</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>