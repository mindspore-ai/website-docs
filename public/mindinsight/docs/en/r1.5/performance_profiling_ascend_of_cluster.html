<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cluster Performance Profiling (Ascend) &mdash; MindSpore master documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debugger" href="debugger.html" />
    <link rel="prev" title="Performance Profiling (GPU)" href="performance_profiling_gpu.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindinsight_install.html">MindInsight Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="summary_record.html">Collecting Summary Record</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboard.html">Viewing Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="lineage_and_scalars_comparison.html">Viewing Lineage and Scalars Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="hyper_parameters_auto_tuning.html">Use Mindoptimizer to Tune Hyperparameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_3rd_scripts_mindconverter.html">Migrating From Third Party Frameworks With MindConverter</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="performance_profiling.html">Performance Profiling</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="performance_profiling_ascend.html">Performance Profiling (Ascend)</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance_profiling_gpu.html">Performance Profiling (GPU)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Cluster Performance Profiling (Ascend)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operation-process">Operation Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distributed-training">Distributed Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#collect-cluster-performance-data">Collect Cluster Performance Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#launch-mindinsight">Launch MindInsight</a></li>
<li class="toctree-l3"><a class="reference internal" href="#training-performance">Training Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cluster-iterative-trajectory-analysis">Cluster Iterative Trajectory Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cluster-communication-and-computation-overlap-time-analysis">Cluster Communication and Computation Overlap Time Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cluster-communication-performance-analysis">Cluster Communication Performance Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#resource-utilization">Resource Utilization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cluster-memory-analysis">Cluster Memory Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cluster-flops-analysis">Cluster FLOPs Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#specifications">Specifications</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notices">Notices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debugger.html">Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_explanation.html">Explain Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindinsight_commands.html">MindInsight Commands</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="training_visual_design.html">Overall Design of Training Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="graph_visual_design.html">Computational Graph Visualization Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensor_visual_design.html">Tensor Visualization Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="profiler_design.html">Performance Profiling Design</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="performance_profiling.html">Performance Profiling</a> &raquo;</li>
      <li>Cluster Performance Profiling (Ascend)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/performance_profiling_ascend_of_cluster.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="cluster-performance-profiling-ascend">
<h1>Cluster Performance Profiling (Ascend)<a class="headerlink" href="#cluster-performance-profiling-ascend" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.5/docs/mindinsight/docs/source_en/performance_profiling_ascend_of_cluster.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.5/resource/_static/logo_source_en.png"></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This article describes how to use MindSpore Profiler for cluster performance debugging on Ascend AI processors.</p>
</section>
<section id="operation-process">
<h2>Operation Process<a class="headerlink" href="#operation-process" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Set up the distributed training environment, prepare a training script, add profiler APIs in the training script and run the training script.</p></li>
<li><p>Collect Cluster Performance Data.</p></li>
<li><p>Start MindInsight and specify the summary-base-dir using startup parameters, note that summary-base-dir is the parent directory of the directory created by Profiler. For example, the directory created by Profiler is <code class="docutils literal notranslate"><span class="pre">/home/user/code/data/</span></code>, the summary-base-dir should be <code class="docutils literal notranslate"><span class="pre">/home/user/code</span></code>. After MindInsight is started, access the visualization page based on the IP address and port number. The default access IP address is <code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:8080</span></code>.</p></li>
<li><p>Find the cluster training in the list, click the cluster performance profiling link and view the data on the web page.</p></li>
</ul>
</section>
<section id="distributed-training">
<h2>Distributed Training<a class="headerlink" href="#distributed-training" title="Permalink to this headline"></a></h2>
<p>For distributed training, please refer to <a class="reference external" href="https://www.mindspore.cn/docs/programming_guide/en/r1.5/distributed_training_ascend.html">Distributed Training</a>.</p>
</section>
<section id="collect-cluster-performance-data">
<h2>Collect Cluster Performance Data<a class="headerlink" href="#collect-cluster-performance-data" title="Permalink to this headline"></a></h2>
<p>In multi-server and multi-device training, after the cluster training, the performance data is distributed in each host node. To analyze the cluster performance, we need to collect the performance data of all host nodes to one host for analysis. Considering the complexity of the cluster running environment and the related permissions and login problems, a more reasonable way is to let users collect cluster performance data. The following is the process of using a script to collect performance data after a distributed cluster training. Users can refer to this script to collect cluster performance data.</p>
<p>Script program description: the script program first creates the cluster job folder, and then uses the SSHPass technology for non interactive remote copy (to avoid manual authentication, manually enter the password), copies the data of each host node in the cluster to the cluster job folder.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================================================&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Please run the script as: &quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;bash collect_cluster_profiler_data.sh&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;for example: bash collect_cluster_profiler_data.sh cluster_hccl_config_path cluster_account_config_path cluster_train_id host_train_id is_absolute_path&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==============================================================================================================&quot;</span>

<span class="nv">SSH</span><span class="o">=</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no&quot;</span>
<span class="nv">SCP</span><span class="o">=</span><span class="s2">&quot;scp -o StrictHostKeyChecking=no&quot;</span>

<span class="c1"># Get the node list in the cluster.</span>
get_cluster_list<span class="o">()</span>
<span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">cluster_config</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">        </span>cat<span class="w"> </span><span class="si">${</span><span class="nv">cluster_config</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import sys,json;[print(node) for node in json.load(sys.stdin)[&quot;cluster&quot;].keys()]&#39;</span>
<span class="o">}</span>

<span class="c1"># Get the account number of node.</span>
get_node_user<span class="o">()</span>
<span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">cluster_config</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">node</span><span class="o">=</span><span class="nv">$2</span>
<span class="w">        </span>cat<span class="w"> </span><span class="si">${</span><span class="nv">cluster_config</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import sys,json;print(json.load(sys.stdin)[&quot;cluster&quot;][&#39;</span><span class="se">\&quot;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1">&#39;][&quot;user&quot;])&#39;</span>
<span class="o">}</span>

<span class="c1"># Get the password of node.</span>
get_node_passwd<span class="o">()</span>
<span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">cluster_config</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">node</span><span class="o">=</span><span class="nv">$2</span>
<span class="w">        </span>cat<span class="w"> </span><span class="si">${</span><span class="nv">cluster_config</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import sys,json;print(json.load(sys.stdin)[&quot;cluster&quot;][&#39;</span><span class="se">\&quot;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1">&#39;][&quot;passwd&quot;])&#39;</span>
<span class="o">}</span>

<span class="c1"># Copy data from remote node to local node.</span>
rscp_pass<span class="o">()</span>
<span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">node</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">user</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">passwd</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">src</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">target</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$5</span><span class="s2">&quot;</span>
<span class="w">        </span>sshpass<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">passwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">SCP</span><span class="si">}</span><span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">&quot;</span>@<span class="s2">&quot;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2">&quot;</span>:<span class="s2">&quot;</span><span class="si">${</span><span class="nv">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">target</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="nv">cluster_hccl_config_path</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">cluster_account_config_path</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">cluster_train_id</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">host_train_id</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">is_absolute_path</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">node_list</span><span class="o">=</span><span class="k">$(</span>get_cluster_list<span class="w"> </span><span class="si">${</span><span class="nv">cluster_account_config_path</span><span class="si">}</span><span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;-----begin----&quot;</span>

<span class="nv">target_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">cluster_train_id</span><span class="si">}</span>/profiler/
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span>
<span class="k">fi</span>

<span class="k">for</span><span class="w"> </span>node<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">node_list</span><span class="si">}</span>
<span class="k">do</span>
<span class="w"> </span><span class="nv">user</span><span class="o">=</span><span class="k">$(</span>get_node_user<span class="w"> </span><span class="si">${</span><span class="nv">cluster_account_config_path</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="k">)</span>
<span class="w"> </span><span class="nv">passwd</span><span class="o">=</span><span class="k">$(</span>get_node_passwd<span class="w"> </span><span class="si">${</span><span class="nv">cluster_account_config_path</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="k">)</span>
<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;------------------</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2">---------------------&quot;</span>

<span class="w"> </span><span class="c1"># Eight devices data</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$is_absolute_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span>
<span class="w"> </span><span class="nv">device_regex</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$host_train_id</span><span class="k">))</span>
<span class="w"> </span><span class="nv">output</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$host_train_id</span><span class="k">)</span>
<span class="w"> </span><span class="nv">grandfather_host_train_id</span><span class="o">=</span><span class="k">$(</span>dirname<span class="w"> </span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$host_train_id</span><span class="k">))</span>
<span class="w"> </span><span class="k">for</span><span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span>i&lt;<span class="m">8</span><span class="p">;</span>i++<span class="o">))</span><span class="p">;</span>
<span class="w"> </span><span class="k">do</span>
<span class="w">   </span><span class="nv">src_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">grandfather_host_train_id</span><span class="si">}</span>/<span class="si">${</span><span class="nv">device_regex</span><span class="si">}${</span><span class="nv">i</span><span class="si">}</span>/<span class="si">${</span><span class="nv">output</span><span class="si">}</span>*/profiler/*.*
<span class="w">   </span><span class="k">$(</span>rscp_pass<span class="w"> </span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">passwd</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span><span class="k">)</span>
<span class="w"> </span><span class="k">done</span>
<span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$is_absolute_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span>
<span class="w"> </span><span class="nv">src_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">host_train_id</span><span class="si">}</span>/profiler/*.*
<span class="w"> </span><span class="k">for</span><span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span>i&lt;<span class="m">8</span><span class="p">;</span>i++<span class="o">))</span><span class="p">;</span>
<span class="w"> </span><span class="k">do</span>
<span class="w">   </span><span class="k">$(</span>rscp_pass<span class="w"> </span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">passwd</span><span class="si">}</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span><span class="k">)</span>
<span class="w"> </span><span class="k">done</span>
<span class="w"> </span><span class="k">else</span>
<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;The value of is_absolute_path can only be 0 or 1.&quot;</span>
<span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w"> </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Script Parameter Description:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">cluster_hccl_config_path</span></code> Network information file path in the multi-device environment. The content format is as follows：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;server_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;server_list&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;server_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.xxx.xxx.1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;device&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.1.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.2.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.3.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.4.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.1.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.2.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.3.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;7&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.4.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;7&quot;</span><span class="p">}],</span>
<span class="w">         </span><span class="nt">&quot;host_nic_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;reserve&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">],</span>
<span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cluster_account_config_path</span></code> Host node account password configuration file path, The content format is as follows：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;rank_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cluster&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;10.xxx.xxx.1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;passwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nt">&quot;10.xxx.xxx.2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;passwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cluster_train_id</span></code> Path to save cluster performance data summary. For example, <code class="docutils literal notranslate"><span class="pre">/home/summary/run1</span></code> and <code class="docutils literal notranslate"><span class="pre">/home/summary/run2</span></code>, where <code class="docutils literal notranslate"><span class="pre">run1</span></code> and <code class="docutils literal notranslate"><span class="pre">run2</span></code> respectively save the jobs of two cluster training.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host_train_id</span></code> In cluster training, the performance data saving path is set by the user. When the performance data save path is set to an absolute path, <code class="docutils literal notranslate"><span class="pre">host_train_id</span></code> is the value set by the user. For example, when the value is <code class="docutils literal notranslate"><span class="pre">/data/run</span></code>, multi devices performance data are saved in <code class="docutils literal notranslate"><span class="pre">/data/run/profiler</span></code> (<code class="docutils literal notranslate"><span class="pre">profiler</span></code>folder is automatically created by the program), the value of <code class="docutils literal notranslate"><span class="pre">host_train_id</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">/data/run</span></code>. When the performance data saving path is set as a relative path, multi card performance data may be saved in different folders, such as <code class="docutils literal notranslate"><span class="pre">/data/run/device0/data/profiler</span></code>, <code class="docutils literal notranslate"><span class="pre">/data/run/device1/data/profiler</span></code>. Their common path is <code class="docutils literal notranslate"><span class="pre">/data/run/device/data/profiler</span></code>, and the performance data storage path of each device is <code class="docutils literal notranslate"><span class="pre">/data/run/device{device_id}/data/profiler</span></code>. The value of <code class="docutils literal notranslate"><span class="pre">host_train_id</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">/data/run/device/data</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_absolute_path</span></code> In the cluster performance data to be collected, whether the single machine and multi devices data are saved in the same directory. If yes, set to 1; Not set to 0.</p></li>
</ul>
<blockquote>
<div><p>The collected cluster performance jobs need to conform to the directory structure, otherwise, they cannot be visualized with MindInsight. It must contain the networking information file (the file name is optional) and host_ips_mapping.txt File (file name and suffix are unique).</p>
</div></blockquote>
<p>The directory structure of cluster performance folder collected by script is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>|-- run
    |-- profiler
        |-- step_trace_raw_{rank_id}_detail_time.csv
</pre></div>
</div>
<blockquote>
<div><p>The format of cluster directory and single device performance directory are unified.</p>
</div></blockquote>
<p>In MindInsight r1.3 and earlier versions, the cluster directory structure is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>|-- run
    |-- hccl.json
    |-- host_ips_mapping.txt
    |-- cluster_profiler
        |-- 1
        |   |-- profiler
        |       |-- step_trace_raw_0_detail_time.csv
</pre></div>
</div>
<p>Through the data conversion script, you can convert the cluster performance directory created by users using MindInsight r1.3 and earlier versions into the currently supported cluster performance directory. You can download <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.5/docs/sample_code/transform_cluster_profiler_data.py">Cluster directory conversion script</a> from the official website.</p>
</section>
<section id="launch-mindinsight">
<h2>Launch MindInsight<a class="headerlink" href="#launch-mindinsight" title="Permalink to this headline"></a></h2>
<p>The MindInsight launch command can refer to <a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/r1.5/mindinsight_commands.html">MindInsight Commands</a>.</p>
</section>
<section id="training-performance">
<h2>Training Performance<a class="headerlink" href="#training-performance" title="Permalink to this headline"></a></h2>
<p>The user can select the specified training from the training list, click performance debugging, and click the “cluster” tab to display the performance data of this training from the cluster perspective. Cluster training performance includes cluster iterative trajectory analysis and cluster communication performance analysis.</p>
<p><img alt="cluster_summary.png" src="_images/cluster_summary.png" /></p>
<p>Figure 1: overview of cluster training performance</p>
<p>Figure 1 is the overview of cluster training performance, which is the overall presentation of cluster iterative trajectory component and cluster communication performance component. The display contents of each component are as follows:</p>
<ul class="simple">
<li><p>Cluster iteration trajectory: The iterative trajectory information of all devices in the cluster is displayed; The overview page shows the cluster iteration trajectory performance.</p></li>
<li><p>Cluster communication performance: Show the communication performance of all devices in the cluster and the link performance of the whole network; The overview page shows the cluster communication performance.</p></li>
</ul>
<section id="cluster-iterative-trajectory-analysis">
<h3>Cluster Iterative Trajectory Analysis<a class="headerlink" href="#cluster-iterative-trajectory-analysis" title="Permalink to this headline"></a></h3>
<p>Using the cluster iterative trajectory analysis component, we can find out the slow host and slow device in cluster training. Cluster iteration trajectory analysis component shows the iteration information of all devices, including step interval, forward and backward, iteration trailing, and supports sorting operation. The step interval reflects the speed of the data processing stage, and the step interval time of the device can reflect the speed of the corresponding host processing data. The forward and backward time of the device reflects the computing power of the device. Iterative tailing reflects all_reduce time and parallelism.</p>
<p><img alt="cluster_iterative_trajectory.png" src="_images/cluster_iterative_trajectory.png" /></p>
<p>Figure 2: cluster iteration trajectory analysis</p>
<p>Figure 2 shows the cluster iteration trajectory analysis page. By default, it shows the average performance of the device. It supports querying the iteration trajectory information of the device under a specific step. By clicking the details link in the single device, you can also jump to the detailed performance display page of the single device to query the detailed performance data of the single device.</p>
<p><img alt="single_car_performance_overall.png" src="_images/single_car_performance_overall.png" /></p>
<p>Figure 3: single device details</p>
<p>Figure 3 shows the performance information of a single device in the cluster. Please refer to <a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/r1.5/performance_profiling_ascend.html">single device performance information</a> for the performance information of a single device.</p>
</section>
<section id="cluster-communication-and-computation-overlap-time-analysis">
<h3>Cluster Communication and Computation Overlap Time Analysis<a class="headerlink" href="#cluster-communication-and-computation-overlap-time-analysis" title="Permalink to this headline"></a></h3>
<p>Cluster communication and computational overlap time analysis components are used in pipeline parallel and model parallel mode to identify slow hosts and slow devices in cluster training.</p>
<p>The cluster communication and computation overlap time analysis components add five new indicators: Communication Time(including the receive operator only), Stage Time, Communication Time, Computation Time, Communication Time(not including the receive operator).</p>
<ul class="simple">
<li><p>Communication Time(including the receive operator only): only the point-to-point(receive) communication operator is executed, and the calculation operator does not execute the time period. This time period reflects the asynchronous situation between the parallel stages of the pipeline.</p></li>
<li><p>Stage Time: the time-consuming duration of each stage. This value is the duration of the step minus the duration of the receive communication operator in the step. Through this indicator, you can see which stage takes the longest time.</p></li>
<li><p>Communication Time: the time period when only the communication operator is executed, and the calculation operator is not executed. If this part takes a long time, it means that the communication time-consuming has a greater impact on performance.</p></li>
<li><p>Computation Time: the total execution time of AI Core operator, used to judge whether there is a slow card. The longer the time, the slower the execution speed of the corresponding card.</p></li>
<li><p>Communication Time(not including the receive operator): only the time period during which other communication operators except the receive communication operators are executed, and the computation operators does not execute. When this time period accounts for a large proportion, you need to consider whether the segmentation strategy of the operators in the stage can be adjusted to reduce the time-consuming duration of this time period.</p></li>
</ul>
<p><img alt="cluster_pipeline-parallel_analyse.png" src="_images/cluster_pipeline-parallel_analyse_en.png" /></p>
<p>Figure 4: pipeline parallel mode analysis</p>
<p>Figure 4 shows the information in pipeline parallel scene, showing the average value of all step by default. The page shows step interval time, pure receive time, stage time, pure communication time, calculation time, pure collection communication time. Because the computation graph of the whole network is divided into subgraph of multiple stages, the stage time can be used to locate the slow stage, and the device of the same stage can be filtered out by selecting the stage number, and the idea of model parallel mode can be used to locate the bottleneck within the stage.</p>
<p><img alt="cluster_model-parallel_analyse.png" src="_images/cluster_model-parallel_analyse_en.png" /></p>
<p>Figure 5: model parallel mode analysis</p>
<p>Figure 5 shows the information in model parallel scene(here refers to the in-layer model parallel), showing the average value of all step by default. The page shows step interval time, pure communication time, and calculation time. Computation time can be used to locate slow devices. If there is no slow device, observe the communication time and computation time ratio, if the communication time is relatively large, consider whether there is a slow link.</p>
</section>
<section id="cluster-communication-performance-analysis">
<h3>Cluster Communication Performance Analysis<a class="headerlink" href="#cluster-communication-performance-analysis" title="Permalink to this headline"></a></h3>
<p>The cluster communication performance component displays the cluster communication performance information from two dimensions: device granularity and whole network link.</p>
<p><img alt="cluster_communication_info.png" src="_images/cluster_communication_info.png" /></p>
<p>Figure 6: cluster communication performance analysis</p>
<p>Figure 6 shows the analysis page of cluster communication performance, including the communication performance of logic device and the link information of the whole network (all logic device link information).</p>
<p>Logic device communication performance tab page is mainly used to show the communication performance of logic device, including communication time, waiting time, operator details, logic device link information.</p>
<ul class="simple">
<li><p>Communication time: Represents the communication time of the communication operator. If the communication time is too long, there may be a problem with a link, and the specific link can be located through the link bandwidth. The calculation method of communication time is to count the total communication operator time of SDMA link (intra server communication) and RDMA link (inter server communication). If it is the SDMA link, the total time of <code class="docutils literal notranslate"><span class="pre">Reduce</span> <span class="pre">inline</span></code> and <code class="docutils literal notranslate"><span class="pre">Memcpy</span></code> operators is taken as the communication time; If it is the RDMA link, the total time of three consecutive operators <code class="docutils literal notranslate"><span class="pre">RDMASendPayload</span></code>, <code class="docutils literal notranslate"><span class="pre">RDMASendNotify</span></code>, <code class="docutils literal notranslate"><span class="pre">Notify</span> <span class="pre">Wait</span></code> is taken as the communication time.</p></li>
<li><p>Waiting time: Also called synchronization time. Before communication between devices, synchronization will be carried out first to ensure that the two devices are synchronized before communication. The waiting time is calculated by counting the total time consumption of all <code class="docutils literal notranslate"><span class="pre">Notify</span> <span class="pre">wait</span></code> operators and subtracting the time consumption of <code class="docutils literal notranslate"><span class="pre">Notify</span> <span class="pre">wait</span></code> operator in the communication time of RDMA link.</p></li>
<li><p>Operator details: Display the communication performance with operator granularity, including the communication duration, waiting duration and link information of the communication operator.</p></li>
<li><p>Logic device link information: Display the link information of the source device or the destination device. Link information includes communication time, traffic, bandwidth (traffic divided by communication time) and link type. The link types include SDMA link (intra server communication link) and RDMA link (inter server communication link). Click the details and display them by pop-up window.</p></li>
</ul>
<p><img alt="operator_performance.png" src="_images/operator_performance.png" /></p>
<p>Figure 7: Operator performance information</p>
<p><img alt="rank_id_link_info.png" src="_images/rank_id_link_info.png" /></p>
<p>Figure 8: link information of logic device</p>
<p>The whole network link information tab page displays the link information of all logic devices, and provides the selection of source device, destination device and link type.</p>
<p><img alt="rank_ids_link_info.png" src="_images/rank_ids_link_info.png" /></p>
<p>Figure 9: link information of the whole network</p>
<p>By default, communication performance data is not collected. You need to use the <code class="docutils literal notranslate"><span class="pre">profile_communication</span></code> parameter in <code class="docutils literal notranslate"><span class="pre">mindspore.profiler.Profiler</span></code> like <code class="docutils literal notranslate"><span class="pre">Profiler(profile_communication=True)</span></code> to turn on the communication performance data switch. It should be noted that only multi devices training can generate communication operator performance data. Setting this parameter in single device training scenario does not work.</p>
<p>To use MindInsight to visualize communication performance data, you need to install the communication performance data parsing WHL package provided by the supporting software package of Ascend 910 AI processor. The WHL package is released with the supporting software package. Refer to the following command to complete the installation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>/usr/local/Ascend/tools/hccl_parser-<span class="o">{</span>version<span class="o">}</span>-py3-none-any.whl
</pre></div>
</div>
</section>
</section>
<section id="resource-utilization">
<h2>Resource Utilization<a class="headerlink" href="#resource-utilization" title="Permalink to this headline"></a></h2>
<section id="cluster-memory-analysis">
<h3>Cluster Memory Analysis<a class="headerlink" href="#cluster-memory-analysis" title="Permalink to this headline"></a></h3>
<p>This page shows the memory usage of the model on the <strong>device side</strong> in the parallel mode, which is an ideal prediction <strong>based on the theoretical value</strong>. The content of the page includes:</p>
<ul class="simple">
<li><p>The distribution of cluster devices, which servers and which devices are used.</p></li>
<li><p>The peak memory of cluster devices, which is the ratio of peak memory to available memory.</p></li>
<li><p>Click a device to jump to the memory details page of the device.</p></li>
</ul>
<blockquote>
<div><p>Memory analysis does not support heterogeneous training currently.</p>
</div></blockquote>
<p><img alt="cluster_memory.png" src="_images/cluster_memory.png" /></p>
<p>Figure 10: The page of cluster memory analysis</p>
</section>
<section id="cluster-flops-analysis">
<h3>Cluster FLOPs Analysis<a class="headerlink" href="#cluster-flops-analysis" title="Permalink to this headline"></a></h3>
<p>This page shows the FLOPs data for each device in the parallel mode. The content of the page includes:</p>
<ul class="simple">
<li><p>The distribution of cluster devices, which servers and which devices are used.</p></li>
<li><p>The relative size of FLOPs among cluster devices. The color of the corresponding rectangular block of each device represents the ratio of FLOPs of the current device to the maximum FLOPs of all devices.</p></li>
<li><p>Click on a device to jump to the operator time-consuming details page of the device, which contains detailed data for FLOPs.</p></li>
</ul>
<p><img alt="cluster_flops.png" src="_images/cluster_flops.png" /></p>
<p>Figure 11: The page of cluster FLOPs analysis</p>
</section>
</section>
<section id="specifications">
<h2>Specifications<a class="headerlink" href="#specifications" title="Permalink to this headline"></a></h2>
<ul>
<li><p>To limit the data size generated by the Profiler, MindInsight suggests that for large neural networks, the profiled steps should be less than 10.</p>
<blockquote>
<div><p>The number of steps can be controlled by controlling the size of training data set. For example, the <code class="docutils literal notranslate"><span class="pre">num_samples</span></code> parameter in <code class="docutils literal notranslate"><span class="pre">mindspore.dataset.MindDataset</span></code> can control the size of the data set. For details, please refer to:
<a class="reference external" href="https://www.mindspore.cn/docs/api/en/r1.5/api_python/dataset/mindspore.dataset.MindDataset.html">https://www.mindspore.cn/docs/api/en/r1.5/api_python/dataset/mindspore.dataset.MindDataset.html</a></p>
</div></blockquote>
</li>
<li><p>The parse of Timeline data is time consuming, and usually the data of a few steps is enough to analyze the results. In order to speed up the data parse and UI display, Profiler will show at most 20M data (Contain 10+ step information for large networks).</p></li>
</ul>
</section>
<section id="notices">
<h2>Notices<a class="headerlink" href="#notices" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Currently running in PyNative mode is not supported.</p></li>
<li><p>Currently the training and inference process does not support performance debugging, only individual training or inference is supported.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="performance_profiling_gpu.html" class="btn btn-neutral float-left" title="Performance Profiling (GPU)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debugger.html" class="btn btn-neutral float-right" title="Debugger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>