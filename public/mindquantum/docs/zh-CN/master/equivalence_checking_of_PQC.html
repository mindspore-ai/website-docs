<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>含参量子线路的等价性检查 &mdash; MindSpore master 文档</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script>
      <link rel="stylesheet" href="_static/nbsphinx-code-cells.css" type="text/css" /><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script><script src="_static/jquery.js"></script>
        <script src="_static/js/theme.js"></script><script src="_static/underscore.js"></script><script src="_static/doctools.js"></script><script src="_static/translations.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/mathjax/MathJax-3.2.2/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="量子相位估计算法" href="quantum_phase_estimation.html" />
    <link rel="prev" title="在量子化学计算中应用量子变分求解器" href="vqe_for_quantum_chemistry.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mindquantum_install.html">安装MindSpore Quantum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基础使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameterized_quantum_circuit.html">变分量子线路</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_simulator.html">量子模拟器</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial_experience_of_quantum_neural_network.html">量子神经网络初体验</a></li>
<li class="toctree-l1"><a class="reference internal" href="get_gradient_of_PQC_with_mindquantum.html">变分量子线路梯度计算进阶</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_operations_of_quantum_circuit.html">量子线路高阶操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_measurement.html">量子测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="noise.html">含噪声量子线路</a></li>
<li class="toctree-l1"><a class="reference internal" href="noise_simulator.html">噪声模拟器</a></li>
<li class="toctree-l1"><a class="reference internal" href="qubit_mapping.html">比特映射</a></li>
<li class="toctree-l1"><a class="reference internal" href="bloch_sphere.html">布洛赫球</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">变分量子算法</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="classification_of_iris_by_qnn.html">通过量子神经网络对鸢尾花进行分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_approximate_optimization_algorithm.html">量子近似优化算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="qnn_for_nlp.html">量子神经网络在自然语言处理中的应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="vqe_for_quantum_chemistry.html">在量子化学计算中应用量子变分求解器</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">含参量子线路的等价性检查</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#概述">概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="#第一步-准备量子线路">第一步：准备量子线路</a></li>
<li class="toctree-l2"><a class="reference internal" href="#第二步-将完整的量子线路转换成zx图">第二步：将完整的量子线路转换成ZX图</a></li>
<li class="toctree-l2"><a class="reference internal" href="#第三步-化简zx图">第三步：化简ZX图</a></li>
<li class="toctree-l2"><a class="reference internal" href="#第四步-若zx演算无法确定则实例化参数">第四步：若ZX演算无法确定则实例化参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="#最后-将以上过程合并成一个完整的功能">最后：将以上过程合并成一个完整的功能</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">通用量子算法</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quantum_phase_estimation.html">量子相位估计算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="grover_search_algorithm.html">基于MindSpore Quantum的Grover搜索算法和龙算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="shor_algorithm.html">基于MindSpore Quantum的Shor算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="hhl_algorithm.html">HHL 算法</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">总览</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.dtype.html">mindquantum.dtype</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.core.html">mindquantum.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.simulator.html">mindquantum.simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.framework.html">mindquantum.framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.algorithm.html">mindquantum.algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.device.html">mindquantum.device</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.io.html">mindquantum.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.engine.html">mindquantum.engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="mindquantum.utils.html">mindquantum.utils</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>含参量子线路的等价性检查</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/equivalence_checking_of_PQC.ipynb.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="含参量子线路的等价性检查">
<h1>含参量子线路的等价性检查<a class="headerlink" href="#含参量子线路的等价性检查" title="永久链接至标题"></a></h1>
<p><a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindquantum/zh_cn/mindspore_equivalence_checking_of_PQC.ipynb"><img alt="下载Notebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_notebook.svg" /></a>  <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/master/mindquantum/zh_cn/mindspore_equivalence_checking_of_PQC.py"><img alt="下载样例代码" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_download_code.svg" /></a>  <a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/mindquantum/docs/source_zh_cn/equivalence_checking_of_PQC.ipynb"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source.svg" /></a></p>
<section id="概述">
<h2>概述<a class="headerlink" href="#概述" title="永久链接至标题"></a></h2>
<p>在量子设备上运行含参量子线路之前，需要将其编译成由该设备支持的量子门集组成的新线路。于是，需要对编译前后的两个线路进行等价性检查。论文Equivalence Checking of Parameterized Quantum Circuits中提出了一种基于ZX演算的含参量子线路等价性检查方法，本文尝试在MindSpore Quantum架构中复现论文中的方法。</p>
<p>论文链接：<a class="reference external" href="https://doi.org/10.1145/3566097.3567932">https://doi.org/10.1145/3566097.3567932</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 引入相关库</span>
<span class="kn">from</span> <span class="nn">mindquantum.core.circuit</span> <span class="kn">import</span> <span class="n">Circuit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindquantum.core.gates</span> <span class="kn">import</span> <span class="n">H</span><span class="p">,</span> <span class="n">CNOT</span><span class="p">,</span> <span class="n">RX</span><span class="p">,</span> <span class="n">RZ</span>
<span class="kn">from</span> <span class="nn">mindquantum.core.circuit</span> <span class="kn">import</span> <span class="n">dagger</span>
</pre></div>
</div>
</div>
</section>
<section id="第一步-准备量子线路">
<h2>第一步：准备量子线路<a class="headerlink" href="#第一步-准备量子线路" title="永久链接至标题"></a></h2>
<p>以Qiskit线路库中的TwoLocal线路为例。TwoLocal线路是由旋转层和纠缠层交替组成的含参线路，旋转层即作用在所有量子比特上的单量子门，纠缠层根据纠缠策略使用双量子门将量子比特纠缠起来。</p>
<p>构造一个作用在127位量子比特上、由三组旋转层和纠缠层交替组成、纠缠策略为循环纠缠的TwoLocal线路，共包含508个参数。旋转层是作用在每一个量子比特上的含参RX门；循环纠缠层是由最后一个量子比特控制第一个量子比特的CNOT门，以及依次由前一个量子比特控制后一个量子比特的CNOT门。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 每一组旋转层和纠缠层的组合就是一层ansatz线路</span>
<span class="k">def</span> <span class="nf">build_ansatz</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>    <span class="c1"># 初始化量子线路</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
            <span class="n">circ</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">n_qubits</span><span class="o">+</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>    <span class="c1"># 每个量子比特上一个RX门</span>
        <span class="n">circ</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_qubits</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># 最后一个量子比特和第一个量子比特上一个CNOT门</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">circ</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>    <span class="c1"># 相邻两个量子比特上一个CNOT门，CNOT门作用在第j+1位，且受第j位控制</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
        <span class="n">circ</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="n">depth</span><span class="o">*</span><span class="n">n_qubits</span><span class="o">+</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>    <span class="c1"># 每个量子比特上一个RX门</span>

    <span class="k">return</span> <span class="n">circ</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 作用在3个量子比特上的一层ansatz线路示例</span>
<span class="n">build_ansatz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_4_0.svg" src="_images/equivalence_checking_of_PQC_4_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始线路共3层，作用在127个量子比特上</span>
<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">127</span>
<span class="n">depth</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">circ1</span> <span class="o">=</span> <span class="n">build_ansatz</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
<span class="n">circ1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>    <span class="c1"># 总结初始线路</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==============================================Circuit Summary==============================================
|Total number of gates  : 889.                                                                            |
|Parameter gates        : 508.                                                                            |
|with 508 parameters are:                                                                                 |
|theta0, theta1, theta2, theta3, theta4, theta5, theta6, theta7, theta8, theta9..                        .|
|Number qubit of circuit: 127                                                                             |
===========================================================================================================
</pre></div></div>
</div>
<p>接下来对初始量子线路进行编译。</p>
<p>假设编译前的量子门集为：H、CNOT、RZ、RX；编译后的量子门集为：H、CNOT、RZ。编译规则是H、CNOT、RZ门保持不变，将RX门编译成H、RZ、H的组合。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compile_circuit</span><span class="p">(</span><span class="n">circ</span><span class="p">):</span>
    <span class="n">circ_compiled</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">circ</span><span class="p">:</span>    <span class="c1"># 遍历初始线路中的量子门</span>
        <span class="c1"># H，CNOT，RZ门保持不变</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span> <span class="ow">or</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CNOT&#39;</span> <span class="ow">or</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RZ&#39;</span><span class="p">:</span>
            <span class="n">circ_compiled</span> <span class="o">+=</span> <span class="n">gate</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RX&#39;</span><span class="p">:</span>    <span class="c1"># RX门经过编译变成H*RZ*H</span>
            <span class="n">circ_compiled</span> <span class="o">+=</span> <span class="n">H</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">)</span>
            <span class="n">circ_compiled</span> <span class="o">+=</span> <span class="n">RZ</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">)</span>
            <span class="n">circ_compiled</span> <span class="o">+=</span> <span class="n">H</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">circ_compiled</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 一层ansatz线路编译后生成的线路示例，可以看到，所有RX门都根据编译规则发生了变化</span>
<span class="n">compile_circuit</span><span class="p">(</span><span class="n">build_ansatz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_8_0.svg" src="_images/equivalence_checking_of_PQC_8_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 编译初始线路</span>
<span class="n">circ2</span> <span class="o">=</span> <span class="n">compile_circuit</span><span class="p">(</span><span class="n">circ1</span><span class="p">)</span>
<span class="n">circ2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>    <span class="c1"># 总结编译线路</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==============================================Circuit Summary==============================================
|Total number of gates  : 1905.                                                                           |
|Parameter gates        : 508.                                                                            |
|with 508 parameters are:                                                                                 |
|theta0, theta1, theta2, theta3, theta4, theta5, theta6, theta7, theta8, theta9..                        .|
|Number qubit of circuit: 127                                                                             |
===========================================================================================================
</pre></div></div>
</div>
<p>最后构造完整的量子线路。</p>
<p>根据量子线路的可逆性可知，若两个线路功能等价，那么将一个线路作用到量子比特上，再将另一个线路的逆线路作用到量子比特上，最终得到的量子态与两次作用之前的量子态等价。于是，完整的量子线路由编译后的线路和初始线路的逆线路组成。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 完整线路</span>
<span class="n">circ1_inv</span> <span class="o">=</span> <span class="n">dagger</span><span class="p">(</span><span class="n">circ1</span><span class="p">)</span>    <span class="c1"># dagger()将量子线路左右逆转，得到初始线路的逆线路</span>
<span class="n">circ_all</span> <span class="o">=</span> <span class="n">circ1_inv</span> <span class="o">+</span> <span class="n">circ2</span>    <span class="c1"># 完整线路=初始线路的逆线路+编译后的线路</span>
<span class="n">circ_all</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>    <span class="c1"># 总结完整线路</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
========================================================Circuit Summary========================================================
|Total number of gates  : 2794.                                                                                               |
|Parameter gates        : 1016.                                                                                               |
|with 508 parameters are:                                                                                                     |
|theta507, theta506, theta505, theta504, theta503, theta502, theta501, theta500, theta499, theta498..                        .|
|Number qubit of circuit: 127                                                                                                 |
===============================================================================================================================
</pre></div></div>
</div>
</section>
<section id="第二步-将完整的量子线路转换成zx图">
<h2>第二步：将完整的量子线路转换成ZX图<a class="headerlink" href="#第二步-将完整的量子线路转换成zx图" title="永久链接至标题"></a></h2>
<p>含参量子线路等价性检查方法基于ZX演算实现，需要将量子线路转换成ZX图。</p>
<p>量子门是ZX图中的顶点，分为3种颜色，H门表示成黄色顶点，RX门表示成含参的红色顶点，RZ门表示成含参的绿色顶点，CNOT门的受控位表示成红色顶点，控制位表示成绿色顶点，受控位与控制位的顶点互为邻居。同一个量子比特上相邻两个量子门的顶点互为邻居。</p>
<p>先定义顶点类和图类。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 顶点类</span>
<span class="k">class</span> <span class="nc">Vertex</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>    <span class="c1"># 量子门顶点的序号</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>    <span class="c1"># 量子门顶点的颜色</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>   <span class="c1"># 含参量子门的参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubit</span> <span class="o">=</span> <span class="n">qubit</span>     <span class="c1"># 作用在哪个量子比特上</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbor</span> <span class="o">=</span> <span class="n">neighbor</span>    <span class="c1"># 顶点之间的邻居关系</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 图类</span>
<span class="k">class</span> <span class="nc">Graph</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># 初始图，空</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># 顶点总数，只增不减，也用于给新顶点命名</span>

    <span class="c1"># 新增边</span>
    <span class="k">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_vertex</span><span class="p">,</span> <span class="n">to_vertex</span><span class="p">):</span>    <span class="c1"># 添加一条从起点到终点的边</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">from_vertex</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_vertex</span><span class="p">)</span>

    <span class="c1"># 新增顶点</span>
    <span class="k">def</span> <span class="nf">add_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># 添加从新顶点到相邻顶点的边</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">:</span>    <span class="c1"># 再添加从相邻顶点到新顶点的边</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># 打印图信息</span>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==================graph message==================&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">neighbor</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># 删除自身的环</span>
    <span class="c1"># 省略了ZX图的无环规则（本文中，所有“无环”均指不存在单条边构成的环）</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                <span class="c1"># 将本顶点从自己的邻居中删除</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># 删除顶点</span>
    <span class="k">def</span> <span class="nf">delete_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>    <span class="c1"># 删除终点是该顶点的边</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>    <span class="c1"># 删除起点是该顶点的边</span>

    <span class="c1"># 两个电路是否等价</span>
    <span class="k">def</span> <span class="nf">equiv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>    <span class="c1"># 等价的两个电路，经过ZX演算化简后，图中无顶点</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equivalent!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not sure!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>接下来将量子线路绘制成ZX图。</p>
<p>遍历线路中的所有量子门，并依次将其绘制成ZX图中的顶点。若当前量子比特上暂无量子门，则当前的量子门暂无邻居；若当前量子比特上已有量子门，则当前的量子门与该量子比特上最后一个量子门互为邻居；CNOT门在绘制时就添加了控制位与受控位顶点之间的邻居关系。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_graph</span><span class="p">(</span><span class="n">circ</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>    <span class="c1"># 初始化一个空图</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">circ</span><span class="o">.</span><span class="n">n_qubits</span>    <span class="c1"># last_name保存每个量子比特上当前的最后一个顶点</span>
    <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">circ</span><span class="p">:</span>    <span class="c1"># 遍历线路中的所有量子门</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>    <span class="c1"># H门绘制成黄色顶点</span>
            <span class="k">if</span> <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>    <span class="c1"># 当前量子比特上已有顶点</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
            <span class="k">else</span><span class="p">:</span>    <span class="c1"># 当前量子比特上暂无顶点</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span>    <span class="c1"># 更新当前量子比特上最后一个顶点为新增顶点</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RX&#39;</span><span class="p">:</span>    <span class="c1"># RX门绘制成红色顶点</span>
            <span class="k">if</span> <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span> <span class="n">gate</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[],</span> <span class="n">gate</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;RZ&#39;</span><span class="p">:</span>    <span class="c1"># RZ门绘制成绿色顶点</span>
            <span class="k">if</span> <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span> <span class="n">gate</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[],</span> <span class="n">gate</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CNOT&#39;</span><span class="p">:</span>    <span class="c1"># CNOT门要分别绘制控制位顶点和受控位顶点</span>
            <span class="c1"># 绘制控制位顶点，绿色</span>
            <span class="k">if</span> <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[])</span>
            <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span>
            <span class="c1"># 绘制受控位顶点，红色</span>
            <span class="k">if</span> <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">last_name</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">obj_qubits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">g</span>
</pre></div>
</div>
</div>
<p>最后，将第一步构造好的完整量子线路绘制成ZX图。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">draw_graph</span><span class="p">(</span><span class="n">circ_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="第三步-化简zx图">
<h2>第三步：化简ZX图<a class="headerlink" href="#第三步-化简zx图" title="永久链接至标题"></a></h2>
<p>ZX演算由ZX图和化简规则组成，根据化简规则，对ZX图中的顶点和邻居关系进行化简。</p>
<p>以下列出部分规则，具体实现过程即图和顶点的相关操作，只举例说明，不再一一赘述。</p>
<p>规则1：不与其他量子比特上的顶点相邻的、参数为0的红色或绿色顶点可以删除。</p>
<p><img alt="equivalence checking of PQC rule 1" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindquantum/docs/source_zh_cn/images/equivalence_checking_of_PQC_rule_1.jpg" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rule_1</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">Graph</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>    <span class="c1"># ZX演算过程中，图中的顶点会发生增减，用list()获取最初的所有顶点</span>
        <span class="k">if</span> <span class="n">v1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>    <span class="c1"># 判断当前顶点在化简过程中有没有被删除</span>
            <span class="k">continue</span>    <span class="c1"># 已被删除，略过</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="c1"># 顶点参数为0</span>
        <span class="k">if</span> <span class="n">v1</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># 用于判断当前顶点是否与其他量子比特上的顶点相关，如果相关，暂时不能删除</span>
            <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v2</span><span class="o">.</span><span class="n">qubit</span> <span class="o">!=</span> <span class="n">v1</span><span class="o">.</span><span class="n">qubit</span><span class="p">:</span>    <span class="c1"># 与其他量子比特上的顶点相关</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>    <span class="c1"># 与其他量子比特上的顶点无关</span>
                <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                    <span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">)</span>    <span class="c1"># 将前一个顶点与后一个顶点相连，略过当前顶点</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>    <span class="c1"># 清除化简过程中可能产生的环</span>
                <span class="n">g</span><span class="o">.</span><span class="n">delete_vertex</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>    <span class="c1"># 删除该顶点</span>
</pre></div>
</div>
</div>
<p>规则2：相邻的、相同颜色的红色或绿色顶点可以合并。</p>
<p><img alt="equivalence checking of PQC rule 2" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindquantum/docs/source_zh_cn/images/equivalence_checking_of_PQC_rule_2.jpg" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rule_2</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">Graph</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">v1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">or</span> <span class="n">v1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>    <span class="c1"># 红色或绿色顶点</span>
            <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>    <span class="c1"># 相邻</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v2</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">v1</span><span class="o">.</span><span class="n">color</span><span class="p">:</span>    <span class="c1"># 相同颜色</span>
                    <span class="n">v2</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">v2</span><span class="o">.</span><span class="n">phase</span> <span class="o">+</span> <span class="n">v1</span><span class="o">.</span><span class="n">phase</span>    <span class="c1"># 参数相加</span>
                    <span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">)</span>    <span class="c1"># 合并两个顶点</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">v3</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>    <span class="c1"># 更新合并顶点后的邻居关系</span>
                        <span class="n">v3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v3</span><span class="p">]</span>
                        <span class="n">v3</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">delete_vertex</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>    <span class="c1"># 删除已被合并的顶点</span>
</pre></div>
</div>
</div>
<p>规则3：所有邻居都是黄色顶点的绿色顶点，可以变成红色顶点，并删除相邻的黄色顶点。</p>
<p><img alt="equivalence checking of PQC rule 3" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindquantum/docs/source_zh_cn/images/equivalence_checking_of_PQC_rule_3.jpg" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rule_3</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">Graph</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">v1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># 用于判断是否所有邻居都是黄色</span>
            <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v2</span><span class="o">.</span><span class="n">color</span> <span class="o">!=</span> <span class="s1">&#39;yellow&#39;</span><span class="p">:</span>    <span class="c1"># 不满足所有邻居都是黄色</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>    <span class="c1"># 所有邻居都是黄色</span>
                <span class="n">v1</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>    <span class="c1"># 变成红色</span>
                <span class="n">v1_neighbor</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1_neighbor</span><span class="p">:</span>    <span class="c1"># 删除这些黄色顶点</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                    <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">v3</span> <span class="ow">in</span> <span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                        <span class="n">v3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v3</span><span class="p">]</span>
                        <span class="n">v3</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">delete_vertex</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>规则 4：相邻的、存在两条边的红绿顶点，可以删除这两条边。</p>
<p><img alt="equivalence checking of PQC rule 4" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/docs/mindquantum/docs/source_zh_cn/images/equivalence_checking_of_PQC_rule_4.jpg" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rule_4</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">Graph</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">v1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span>
                <span class="c1"># 红绿顶点，且两顶点间有两条边</span>
                <span class="k">if</span> <span class="n">v2</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">and</span> <span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">v2</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>    <span class="c1"># 删除相连的边</span>
                        <span class="n">v1</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">while</span> <span class="n">v1</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">neighbor</span><span class="p">:</span>
                        <span class="n">v2</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>接下来利用以上规则对ZX图进行循环化简，若某轮循环中没有删除任何顶点，则认为化简结束。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">Graph</span><span class="p">):</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># 用于对比本轮循环是否有顶点被删除</span>
    <span class="k">while</span> <span class="n">temp</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>    <span class="c1"># 如果本轮循环没有删除任何顶点，则认为化简结束，退出循环</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">rule_3</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">rule_2</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">rule_4</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">rule_1</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>完整线路规模较大，可以先构造一个作用在三个量子比特上的单层线路进行测试。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_circ1</span> <span class="o">=</span> <span class="n">build_ansatz</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_circ1_inv</span> <span class="o">=</span> <span class="n">dagger</span><span class="p">(</span><span class="n">test_circ1</span><span class="p">)</span>
<span class="n">test_circ2</span> <span class="o">=</span> <span class="n">compile_circuit</span><span class="p">(</span><span class="n">test_circ1</span><span class="p">)</span>

<span class="n">test_circ_all</span> <span class="o">=</span> <span class="n">test_circ1_inv</span> <span class="o">+</span> <span class="n">test_circ2</span>

<span class="n">test_circ_all</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_30_0.svg" src="_images/equivalence_checking_of_PQC_30_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将测试线路绘制成ZX图</span>
<span class="n">test_g</span> <span class="o">=</span> <span class="n">draw_graph</span><span class="p">(</span><span class="n">test_circ_all</span><span class="p">)</span>
<span class="n">test_g</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================graph message==================
0        [4]     red     -theta5
1        [3]     red     -theta4
2        [5]     red     -theta3
3        [1, 4, 6]       green   0.0
4        [0, 3, 7]       red     0.0
5        [2, 6, 8]       green   0.0
6        [3, 5, 10]      red     0.0
7        [4, 8, 9]       green   0.0
8        [5, 7, 11]      red     0.0
9        [7, 18]         red     -theta2
10       [6, 15]         red     -theta1
11       [8, 12]         red     -theta0
12       [11, 13]        yellow          0.0
13       [12, 14]        green   theta0
14       [13, 22]        yellow          0.0
15       [10, 16]        yellow          0.0
16       [15, 17]        green   theta1
17       [16, 24]        yellow          0.0
18       [9, 19]         yellow          0.0
19       [18, 20]        green   theta2
20       [19, 21]        yellow          0.0
21       [20, 22, 26]    green   0.0
22       [14, 21, 23]    red     0.0
23       [22, 24, 27]    green   0.0
24       [17, 23, 25]    red     0.0
25       [24, 26, 30]    green   0.0
26       [21, 25, 33]    red     0.0
27       [23, 28]        yellow          0.0
28       [27, 29]        green   theta3
29       [28]    yellow          0.0
30       [25, 31]        yellow          0.0
31       [30, 32]        green   theta4
32       [31]    yellow          0.0
33       [26, 34]        yellow          0.0
34       [33, 35]        green   theta5
35       [34]    yellow          0.0


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 化简测试线路</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之前：&quot;</span><span class="p">)</span>
<span class="n">test_g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>

<span class="n">simplify</span><span class="p">(</span><span class="n">test_g</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之后：&quot;</span><span class="p">)</span>
<span class="n">test_g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
化简之前：
Not sure!
化简之后：
Equivalent!
</pre></div></div>
</div>
<p>化简功能测试通过，最后就可以化简完整线路的ZX图，化简结果显示编译前后的两个线路是等价的。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 化简完整线路</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之前：&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>

<span class="n">simplify</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>    <span class="c1"># 化简</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之后：&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
化简之前：
Not sure!
化简之后：
Equivalent!
</pre></div></div>
</div>
</section>
<section id="第四步-若zx演算无法确定则实例化参数">
<h2>第四步：若ZX演算无法确定则实例化参数<a class="headerlink" href="#第四步-若zx演算无法确定则实例化参数" title="永久链接至标题"></a></h2>
<p>对于两个不等价的线路，ZX演算不能直接给出不等价的判定结果。这时，需要对线路中的参数进行实例化，判断实例化之后的两个线路是否等价。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 构造反例线路：ZX演算化简后无法确定、实际上不等价的两个线路</span>
<span class="n">neq_circ1</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">H</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">RZ</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ1</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">neq_circ1</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_36_0.svg" src="_images/equivalence_checking_of_PQC_36_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neq_circ2</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">H</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">RZ</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">CNOT</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neq_circ2</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">neq_circ2</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_37_0.svg" src="_images/equivalence_checking_of_PQC_37_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neq_circ1_inv</span> <span class="o">=</span> <span class="n">dagger</span><span class="p">(</span><span class="n">neq_circ1</span><span class="p">)</span>
<span class="n">neq_circ_all</span> <span class="o">=</span> <span class="n">neq_circ1_inv</span> <span class="o">+</span> <span class="n">neq_circ2</span>    <span class="c1"># 构造完整反例线路</span>
<span class="n">neq_circ_all</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/equivalence_checking_of_PQC_38_0.svg" src="_images/equivalence_checking_of_PQC_38_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将反例线路绘制成ZX图并进行化简</span>
<span class="n">neq_g</span> <span class="o">=</span> <span class="n">draw_graph</span><span class="p">(</span><span class="n">neq_circ_all</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之前：&quot;</span><span class="p">)</span>
<span class="n">neq_g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>

<span class="n">simplify</span><span class="p">(</span><span class="n">neq_g</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之后：&quot;</span><span class="p">)</span>
<span class="n">neq_g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
化简之前：
Not sure!
化简之后：
Not sure!
</pre></div></div>
</div>
<p>对于反例线路，ZX演算化简之后，ZX图中仍有未删掉的顶点，于是ZX演算无法确定其等价性，需要实例化参数进行验证。</p>
<p>实例化参数步骤分为两步：</p>
<p>第一步，根据映射函数实例化参数，直接比较实例化之后两个线路的矩阵形式是否等价，若不等价则停止；</p>
<p>第二步，若映射函数实例化未得到不等价的结果，则随机实例化参数，再直接比较实例化之后两个线路的矩阵形式是否等价，若不等价则最终判定两个线路不等价，否则，最终判定两个线路等价。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 映射函数实例化参数</span>
<span class="k">def</span> <span class="nf">map_para</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">para</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">para</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">para</span>


<span class="c1"># 随机实例化参数</span>
<span class="k">def</span> <span class="nf">random_para</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">para</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">para</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;theta</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">para</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 实例化参数验证两个线路是否等价，验证r轮</span>
<span class="k">def</span> <span class="nf">verify_by_para</span><span class="p">(</span><span class="n">circ1</span><span class="p">,</span> <span class="n">circ2</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">circ1</span><span class="o">.</span><span class="n">params_name</span><span class="o">+</span><span class="n">circ2</span><span class="o">.</span><span class="n">params_name</span><span class="p">)))</span>    <span class="c1"># 线路中一共n个参数</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># 记录前r-1轮验证是否有结果</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>    <span class="c1"># 前r-1轮指定参数</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">map_para</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 直接比较两个实例化之后的线路的矩阵形式是否等价</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">circ1</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">para</span><span class="p">),</span> <span class="n">circ2</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">para</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not equivalent!&#39;</span><span class="p">)</span>    <span class="c1"># 在任一情况下两个线路的矩阵不等价，即表示这两个线路不等价</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># 验证已有结果，结束</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>    <span class="c1"># 前r-1轮没有结果，最后一轮随机参数</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">random_para</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">circ1</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">para</span><span class="p">),</span> <span class="n">circ2</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">para</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Equivalent!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not equivalent!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>用实例化参数的方法去验证两个反例线路的等价性，结果为不等价。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">verify_by_para</span><span class="p">(</span><span class="n">neq_circ1</span><span class="p">,</span> <span class="n">neq_circ2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Not equivalent!
</pre></div></div>
</div>
</section>
<section id="最后-将以上过程合并成一个完整的功能">
<h2>最后：将以上过程合并成一个完整的功能<a class="headerlink" href="#最后-将以上过程合并成一个完整的功能" title="永久链接至标题"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ZXcalculus</span><span class="p">(</span><span class="n">circ1</span><span class="p">,</span> <span class="n">circ2</span><span class="p">):</span>
    <span class="n">circ1_inv</span> <span class="o">=</span> <span class="n">dagger</span><span class="p">(</span><span class="n">circ1</span><span class="p">)</span>    <span class="c1"># 将原始线路左右逆转</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">circ1_inv</span> <span class="o">+</span> <span class="n">circ2</span>    <span class="c1"># 构造完整线路</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">draw_graph</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>    <span class="c1"># 将完整线路绘制成ZX图</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之前：&quot;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
    <span class="n">simplify</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>    <span class="c1"># 根据ZX演算规则进行化简</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;化简之后：&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>    <span class="c1"># 化简得到两个线路等价的结果</span>
        <span class="n">g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>    <span class="c1"># 化简未能得到结果，需要实例化参数进行验证</span>
        <span class="n">g</span><span class="o">.</span><span class="n">equiv</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;实例化参数验证：&quot;</span><span class="p">)</span>
        <span class="n">verify_by_para</span><span class="p">(</span><span class="n">circ1</span><span class="p">,</span> <span class="n">circ2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindquantum.utils.show_info</span> <span class="kn">import</span> <span class="n">InfoTable</span>

<span class="n">InfoTable</span><span class="p">(</span><span class="s1">&#39;mindquantum&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table border="1">
  <tr>
    <th>Software</th>
    <th>Version</th>
  </tr>
<tr><td>mindquantum</td><td>0.9.0</td></tr>
<tr><td>scipy</td><td>1.10.1</td></tr>
<tr><td>numpy</td><td>1.23.5</td></tr>
<tr>
    <th>System</th>
    <th>Info</th>
</tr>
<tr><td>Python</td><td>3.8.17</td></tr><tr><td>OS</td><td>Windows AMD64</td></tr><tr><td>Memory</td><td>8.39 GB</td></tr><tr><td>CPU Max Thread</td><td>8</td></tr><tr><td>Date</td><td>Mon Sep 18 11:07:00 2023</td></tr>
</table></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vqe_for_quantum_chemistry.html" class="btn btn-neutral float-left" title="在量子化学计算中应用量子变分求解器" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="quantum_phase_estimation.html" class="btn btn-neutral float-right" title="量子相位估计算法" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 MindSpore.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>