

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mindsponge.metrics.structure_violations &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
   
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Molecular Simulation Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/physics_driven.html">Physics Driven</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/data_driven.html">Data Driven</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/physics_plus_data_driven.html">Physics Data Fusion</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/simulation.html">Molecular Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/structure_prediction.html">Molecular Structure Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/property_prediction.html">Molecular Properties Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/design.html">Molecular Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/basic.html">Molecular Foundation Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mindsponge.cell.html">mindsponge.cell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindsponge.common.html">mindsponge.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindsponge.data.html">mindsponge.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindsponge.metrics.html">mindsponge.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../constant.html">Constants</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>mindsponge.metrics.structure_violations</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mindsponge.metrics.structure_violations</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2021 The AIMM Group at Shenzhen Bay Laboratory &amp; Peking University &amp; Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;Modules and utilities for the structure module.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">import</span> <span class="nn">mindspore.numpy</span> <span class="k">as</span> <span class="nn">mnp</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">operations</span> <span class="k">as</span> <span class="n">P</span>
<span class="kn">from</span> <span class="nn">mindsponge.common.geometry</span> <span class="kn">import</span> <span class="n">quaternion_from_tensor</span>
<span class="kn">from</span> <span class="nn">mindsponge.common.utils</span> <span class="kn">import</span> <span class="n">find_optimal_renaming</span>
<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">residue_constants</span>


<span class="n">VIOLATION_TOLERANCE_ACTOR</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="n">CLASH_OVERLAP_TOLERANCE</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="c1"># one hot encoding for C and N atoms (using atom14 representation)</span>
<span class="n">C_ONE_HOT</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">N_ONE_HOT</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># Van der Waals radii for each atom</span>
<span class="n">ATOMTYPE_RADIUS</span> <span class="o">=</span> \
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">residue_constants</span><span class="o">.</span><span class="n">van_der_waals_radius</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">atom_types</span><span class="p">])</span>
<span class="n">ATOMTYPE_RADIUS</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">ATOMTYPE_RADIUS</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">DISTS_MASK_I</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># lower bound and upper bound between each atoms used for clashes calculation</span>
<span class="n">LOWER_BOUND</span><span class="p">,</span> <span class="n">UPPER_BOUND</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
    <span class="n">residue_constants</span><span class="o">.</span><span class="n">make_atom14_dists_bounds</span><span class="p">(</span><span class="n">overlap_tolerance</span><span class="o">=</span><span class="n">CLASH_OVERLAP_TOLERANCE</span><span class="p">,</span>
                                               <span class="n">bond_length_tolerance_factor</span><span class="o">=</span><span class="n">VIOLATION_TOLERANCE_ACTOR</span><span class="p">)</span>
<span class="n">LOWER_BOUND</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">LOWER_BOUND</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">UPPER_BOUND</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">UPPER_BOUND</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">CYS_SG_IDX</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<div class="viewcode-block" id="between_residue_bond"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.between_residue_bond.html#mindsponge.metrics.between_residue_bond">[docs]</a><span class="k">def</span> <span class="nf">between_residue_bond</span><span class="p">(</span>
        <span class="n">pred_atom_positions</span><span class="p">,</span>
        <span class="n">pred_atom_mask</span><span class="p">,</span>
        <span class="n">residue_index</span><span class="p">,</span>
        <span class="n">aatype</span><span class="p">,</span>
        <span class="n">tolerance_factor_soft</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">tolerance_factor_hard</span><span class="o">=</span><span class="mf">12.0</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flat-bottom loss to penalize structural violations between residues. This is a loss penalizing any violation</span>
<span class="sd">    of the geometry around the peptide bond between consecutive amino acids.</span>

<span class="sd">    Args:</span>
<span class="sd">        pred_atom_positions (Tensor):   Atom positions in atom37/14 representation, shape :math:`(N_{res}, 37, 3)`.</span>
<span class="sd">                                        or shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        pred_atom_mask (Tensor):        Atom mask in atom37/14 representation. shape :math:`(N_{res}, 37)` or</span>
<span class="sd">                                        shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        residue_index (Tensor):         Residue index for given amino acid, this is assumed to be monotonically</span>
<span class="sd">                                        increasing. Range from 1 to :math:`N_{res}`. shape :math:`(N_{res}, )` .</span>
<span class="sd">        aatype (Tensor):                amino acid types. Range is :math:`[0,20]`. shape :math:`(N_{res}, )` .</span>
<span class="sd">        tolerance_factor_soft (float):  soft tolerance factor measured in standard deviations of pdb distributions.</span>
<span class="sd">                                        Default: ``12.0`` .</span>
<span class="sd">        tolerance_factor_hard (float):  hard tolerance factor measured in standard deviations of pdb distributions.</span>
<span class="sd">                                        Default: ``12.0`` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        - Tensor, c_n_loss_mean, loss for peptide bond length violations. shape is :math:`( )` .</span>
<span class="sd">        - Tensor, ca_c_n_loss_mean, loss for violations of bond angle around C spanned by CA, C, N.</span>
<span class="sd">          shape is :math:`( )` .</span>
<span class="sd">        - Tensor, c_n_ca_loss_mean, loss for violations of bond angle around N spanned by C, N, CA.</span>
<span class="sd">          shape is :math:`( )` .</span>
<span class="sd">        - Tensor, per_residue_loss_sum, sum of all losses of each residue. shape is :math:`(N_{res}, )` .</span>
<span class="sd">        - Tensor, per_residue_violation_mask, mask denoting all residues with violation present.</span>
<span class="sd">          shape is :math:`(N_{res}, )` .</span>

<span class="sd">    Symbol:</span>
<span class="sd">        :math:`N_{res}`, number of amino acids.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import between_residue_bond</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(1)</span>
<span class="sd">        &gt;&gt;&gt; pred_atom_positions = Tensor(np.random.random(size=(50,37,3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; pred_atom_mask = Tensor(np.random.randint(2,size=(50,37)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; residue_index = Tensor(np.array(range(50)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; aatype = Tensor(np.random.randint(20, size=(50,)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; tolerance_factor_soft = 12.0</span>
<span class="sd">        &gt;&gt;&gt; tolerance_factor_hard = 12.0</span>
<span class="sd">        &gt;&gt;&gt; result = between_residue_bond(pred_atom_positions, pred_atom_mask, residue_index, aatype,</span>
<span class="sd">        &gt;&gt;&gt;                              tolerance_factor_soft, tolerance_factor_hard)</span>
<span class="sd">        &gt;&gt;&gt; for x in result:</span>
<span class="sd">        &gt;&gt;&gt;    print(x)</span>
<span class="sd">        0.52967054</span>
<span class="sd">        0.6045412</span>
<span class="sd">        0.39251995</span>
<span class="sd">        [0.62809587 1.6770853  1.7221183  1.0325309  1.3417522  1.79882</span>
<span class="sd">         1.7718308  1.5092779  1.5653987  1.9564128  1.6804926  1.6051245</span>
<span class="sd">         1.5033073  1.5895741  2.1686926  2.126039   1.3837843  1.2554975</span>
<span class="sd">         1.8135165  2.1593785  1.9408598  1.7281027  1.8666006  1.9623451</span>
<span class="sd">         1.8177024  1.7543832  1.5969353  1.2150483  0.9833115  1.219868</span>
<span class="sd">         1.7008476  1.6968286  1.7648234  1.5584714  1.370602   1.8525059</span>
<span class="sd">         1.7938454  1.5313196  1.6940074  1.8512855  1.8222975  1.6600168</span>
<span class="sd">         1.9163743  1.7201058  1.6288358  1.6055745  1.521946   1.6553445</span>
<span class="sd">         1.6175683  0.894606 ]</span>
<span class="sd">         [1. 1. 0. 1. 1. 0. 0. 1. 1. 1. 1. 0. 0. 0. 0. 1. 1. 1. 1. 1. 0. 1. 1. 0.</span>
<span class="sd">          0. 1. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 1. 1. 1. 0.</span>
<span class="sd">          1. 1.]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the positions of the relevant backbone atoms.</span>
    <span class="n">this_ca_pos</span> <span class="o">=</span> <span class="n">pred_atom_positions</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">this_ca_mask</span> <span class="o">=</span> <span class="n">pred_atom_mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">this_c_pos</span> <span class="o">=</span> <span class="n">pred_atom_positions</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">this_c_mask</span> <span class="o">=</span> <span class="n">pred_atom_mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">next_n_pos</span> <span class="o">=</span> <span class="n">pred_atom_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">next_n_mask</span> <span class="o">=</span> <span class="n">pred_atom_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">next_ca_pos</span> <span class="o">=</span> <span class="n">pred_atom_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">next_ca_mask</span> <span class="o">=</span> <span class="n">pred_atom_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">has_no_gap_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">residue_index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">residue_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Compute loss for the C--N bond.</span>
    <span class="n">c_n_bond_length</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">this_c_pos</span> <span class="o">-</span> <span class="n">next_n_pos</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># The C-N bond to proline has slightly different length because of the ring.</span>
    <span class="n">next_is_proline</span> <span class="o">=</span> <span class="p">(</span><span class="n">aatype</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">resname_to_idx</span><span class="p">[</span><span class="s1">&#39;PRO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">gt_length</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">next_is_proline</span><span class="p">)</span> <span class="o">*</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_bond_length_c_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="o">+</span> <span class="n">next_is_proline</span> <span class="o">*</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_bond_length_c_n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">gt_stddev</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">next_is_proline</span><span class="p">)</span> <span class="o">*</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_bond_length_stddev_c_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                 <span class="n">next_is_proline</span> <span class="o">*</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_bond_length_stddev_c_n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">c_n_bond_length_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">c_n_bond_length</span> <span class="o">-</span> <span class="n">gt_length</span><span class="p">))</span>
    <span class="n">c_n_loss_per_residue</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">c_n_bond_length_error</span> <span class="o">-</span> <span class="n">tolerance_factor_soft</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">this_c_mask</span> <span class="o">*</span> <span class="n">next_n_mask</span> <span class="o">*</span> <span class="n">has_no_gap_mask</span>
    <span class="n">c_n_loss_mean</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">c_n_loss_per_residue</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">c_n_violation_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_n_bond_length_error</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tolerance_factor_hard</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">))</span>

    <span class="c1"># Compute loss for the angles.</span>
    <span class="n">ca_c_bond_length</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">this_ca_pos</span> <span class="o">-</span> <span class="n">this_c_pos</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">n_ca_bond_length</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">next_n_pos</span> <span class="o">-</span> <span class="n">next_ca_pos</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">c_ca_unit_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_ca_pos</span> <span class="o">-</span> <span class="n">this_c_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">ca_c_bond_length</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">c_n_unit_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_n_pos</span> <span class="o">-</span> <span class="n">this_c_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_n_bond_length</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">n_ca_unit_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_ca_pos</span> <span class="o">-</span> <span class="n">next_n_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_ca_bond_length</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">ca_c_n_cos_angle</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_ca_unit_vec</span> <span class="o">*</span> <span class="n">c_n_unit_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gt_angle</span> <span class="o">=</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_cos_angles_ca_c_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gt_stddev</span> <span class="o">=</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_cos_angles_ca_c_n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ca_c_n_cos_angle_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ca_c_n_cos_angle</span> <span class="o">-</span> <span class="n">gt_angle</span><span class="p">))</span>
    <span class="n">ca_c_n_loss_per_residue</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">ca_c_n_cos_angle_error</span> <span class="o">-</span> <span class="n">tolerance_factor_soft</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">this_ca_mask</span> <span class="o">*</span> <span class="n">this_c_mask</span> <span class="o">*</span> <span class="n">next_n_mask</span> <span class="o">*</span> <span class="n">has_no_gap_mask</span>
    <span class="n">ca_c_n_loss_mean</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">ca_c_n_loss_per_residue</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">ca_c_n_violation_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">ca_c_n_cos_angle_error</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tolerance_factor_hard</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">))</span>

    <span class="n">c_n_ca_cos_angle</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="o">-</span><span class="n">c_n_unit_vec</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_ca_unit_vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gt_angle</span> <span class="o">=</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_cos_angles_c_n_ca</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gt_stddev</span> <span class="o">=</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">between_res_cos_angles_c_n_ca</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">c_n_ca_cos_angle_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">c_n_ca_cos_angle</span> <span class="o">-</span> <span class="n">gt_angle</span><span class="p">))</span>
    <span class="n">c_n_ca_loss_per_residue</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">c_n_ca_cos_angle_error</span> <span class="o">-</span> <span class="n">tolerance_factor_soft</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">this_c_mask</span> <span class="o">*</span> <span class="n">next_n_mask</span> <span class="o">*</span> <span class="n">next_ca_mask</span> <span class="o">*</span> <span class="n">has_no_gap_mask</span>
    <span class="n">c_n_ca_loss_mean</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="n">c_n_ca_loss_per_residue</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">c_n_ca_violation_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_n_ca_cos_angle_error</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tolerance_factor_hard</span> <span class="o">*</span> <span class="n">gt_stddev</span><span class="p">))</span>

    <span class="c1"># Compute a per residue loss (equally distribute the loss to both neighbouring residues).</span>
    <span class="n">per_residue_loss_sum</span> <span class="o">=</span> <span class="n">c_n_loss_per_residue</span> <span class="o">+</span> <span class="n">ca_c_n_loss_per_residue</span> <span class="o">+</span> <span class="n">c_n_ca_loss_per_residue</span>
    <span class="n">per_residue_loss_sum</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">per_residue_loss_sum</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">per_residue_loss_sum</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]))</span>

    <span class="c1"># Compute hard violations.</span>
    <span class="n">per_residue_violation_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">c_n_violation_mask</span><span class="p">,</span> <span class="n">ca_c_n_violation_mask</span><span class="p">,</span> <span class="n">c_n_ca_violation_mask</span><span class="p">]),</span>
                                         <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">per_residue_violation_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">per_residue_violation_mask</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]),</span>
                                             <span class="n">mnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">per_residue_violation_mask</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]))</span>

    <span class="k">return</span> <span class="n">c_n_loss_mean</span><span class="p">,</span> <span class="n">ca_c_n_loss_mean</span><span class="p">,</span> <span class="n">c_n_ca_loss_mean</span><span class="p">,</span> <span class="n">per_residue_loss_sum</span><span class="p">,</span> <span class="n">per_residue_violation_mask</span></div>


<div class="viewcode-block" id="between_residue_clash"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.between_residue_clash.html#mindsponge.metrics.between_residue_clash">[docs]</a><span class="k">def</span> <span class="nf">between_residue_clash</span><span class="p">(</span>
        <span class="n">atom14_pred_positions</span><span class="p">,</span>
        <span class="n">atom14_atom_exists</span><span class="p">,</span>
        <span class="n">atom14_atom_radius</span><span class="p">,</span>
        <span class="n">residue_index</span><span class="p">,</span>
        <span class="n">c_one_hot</span><span class="p">,</span>
        <span class="n">n_one_hot</span><span class="p">,</span>
        <span class="n">overlap_tolerance_soft</span><span class="p">,</span>
        <span class="n">overlap_tolerance_hard</span><span class="p">,</span>
        <span class="n">cys_sg_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a loss penalizing any steric clashes due to non bonded atoms in different peptides coming too close.</span>

<span class="sd">    Args:</span>
<span class="sd">        atom14_pred_positions (Tensor): predicted positions of atoms in global prediction frame.</span>
<span class="sd">                                        shape is :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        atom14_atom_exists (Tensor):    mask denoting whether atom at positions exists for given amino acid type.</span>
<span class="sd">                                        shape is :math:`(N_{res}, 14)` .</span>
<span class="sd">        atom14_atom_radius (Tensor):    Van der Waals radius for each atom. shape is :math:`(N_{res}, 14)` .</span>
<span class="sd">        residue_index (Tensor):         Residue index for given amino acid. shape is :math:`(N_{res}, )` ,</span>
<span class="sd">                                        range from 1 to :math:`N_{res}` .</span>
<span class="sd">        c_one_hot (Tensor):             one hot encoding for C atoms (using atom14 representation). shape is (14, ) .</span>
<span class="sd">        n_one_hot (Tensor):             one hot encoding for N atoms (using atom14 representation). shape is (14, ) .</span>
<span class="sd">        overlap_tolerance_soft (float): soft tolerance factor. in default: ``12.0``.</span>
<span class="sd">        overlap_tolerance_hard (float): hard tolerance factor. in default: ``1.5``.</span>
<span class="sd">        cys_sg_idx (Tensor):            CYS amino acid index. Default: ``5``.</span>
<span class="sd">                                        see more at `mindsponge.common.residue_constants`. Shape: `()` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        - Tensor, mean_loss, average clash loss. Shape is `()` .</span>
<span class="sd">        - Tensor, per_atom_loss_sum, sum of all clash losses per atom, shape is :math:`(N_{res}, 14)` .</span>
<span class="sd">        - Tensor, per_atom_clash_mask, mask whether atom clashes with any other atom,</span>
<span class="sd">          shape is :math:`(N_{res}, 14)` .</span>

<span class="sd">    Symbol:</span>
<span class="sd">        :math:`N_{res}`, number of amino acids.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import between_residue_clash</span>
<span class="sd">        &gt;&gt;&gt; atom14_pred_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_atom_exists = Tensor(np.random.randint(2, size=(50, 14)))</span>
<span class="sd">        &gt;&gt;&gt; atom14_atom_radius = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; residue_index = Tensor(np.array(range(50)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; c_one_hot = Tensor(np.array([0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; n_one_hot = Tensor(np.array([1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; overlap_tolerance_soft = 12.0</span>
<span class="sd">        &gt;&gt;&gt; overlap_tolerance_hard = 1.5</span>
<span class="sd">        &gt;&gt;&gt; cys_sg_idx = Tensor(5, ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; mean_loss, per_atom_loss_sum, per_atom_clash_mask = between_residue_clash(atom14_pred_positions,</span>
<span class="sd">        ...                                                                           atom14_atom_exists,</span>
<span class="sd">        ...                                                                           atom14_atom_radius,</span>
<span class="sd">        ...                                                                           residue_index,</span>
<span class="sd">        ...                                                                           c_one_hot,</span>
<span class="sd">        ...                                                                           n_one_hot,</span>
<span class="sd">        ...                                                                           overlap_tolerance_soft,</span>
<span class="sd">        ...                                                                           overlap_tolerance_hard,</span>
<span class="sd">        ...                                                                           cys_sg_idx)</span>
<span class="sd">        &gt;&gt;&gt; print(mean_loss.shape, per_atom_loss_sum.shape, per_atom_clash_mask.shape)</span>
<span class="sd">        () (50,14) (50,14)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">atom14_pred_positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">atom14_pred_positions</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dists_mask</span> <span class="o">=</span> <span class="n">atom14_atom_exists</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">atom14_atom_exists</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">dists_mask</span> <span class="o">*=</span> <span class="p">(</span><span class="n">residue_index</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">residue_index</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="c1"># Backbone C--N bond between subsequent residues is no clash.</span>
    <span class="n">neighbour_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">residue_index</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">residue_index</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">c_n_bonds</span> <span class="o">=</span> <span class="n">neighbour_mask</span> <span class="o">*</span> <span class="n">c_one_hot</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_one_hot</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">dists_mask</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">c_n_bonds</span><span class="p">)</span>

    <span class="c1"># Disulfide bridge between two cysteines is no clash.</span>
    <span class="n">cys_sg_one_hot</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">OneHot</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">14</span><span class="p">)(</span><span class="n">cys_sg_idx</span><span class="p">)</span>
    <span class="n">disulfide_bonds</span> <span class="o">=</span> <span class="p">(</span><span class="n">cys_sg_one_hot</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">cys_sg_one_hot</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">dists_mask</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">disulfide_bonds</span><span class="p">)</span>

    <span class="n">dists_lower_bound</span> <span class="o">=</span> <span class="n">dists_mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">atom14_atom_radius</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">atom14_atom_radius</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">dists_to_low_error</span> <span class="o">=</span> <span class="n">dists_mask</span> <span class="o">*</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">dists_lower_bound</span> <span class="o">-</span> <span class="n">overlap_tolerance_soft</span> <span class="o">-</span> <span class="n">dists</span><span class="p">)</span>
    <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dists_to_low_error</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dists_mask</span><span class="p">))</span>
    <span class="n">per_atom_loss_sum</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">dists_to_low_error</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">dists_to_low_error</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">clash_mask</span> <span class="o">=</span> <span class="n">dists_mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">dists</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dists_lower_bound</span> <span class="o">-</span> <span class="n">overlap_tolerance_hard</span><span class="p">))</span>
    <span class="n">per_atom_clash_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clash_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clash_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">mean_loss</span><span class="p">,</span> <span class="n">per_atom_loss_sum</span><span class="p">,</span> <span class="n">per_atom_clash_mask</span></div>


<div class="viewcode-block" id="within_residue_violations"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.within_residue_violations.html#mindsponge.metrics.within_residue_violations">[docs]</a><span class="k">def</span> <span class="nf">within_residue_violations</span><span class="p">(</span>
        <span class="n">atom14_pred_positions</span><span class="p">,</span>
        <span class="n">atom14_atom_exists</span><span class="p">,</span>
        <span class="n">atom14_dists_lower_bound</span><span class="p">,</span>
        <span class="n">atom14_dists_upper_bound</span><span class="p">,</span>
        <span class="n">tighten_bounds_for_loss</span><span class="p">,</span>
        <span class="n">dists_mask_i</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loss to penalize steric clashes within residues.</span>
<span class="sd">    This is a loss penalizing any steric violations or clashes of non-bonded atoms in a given peptide.</span>

<span class="sd">    Args:</span>
<span class="sd">        atom14_pred_positions (Tensor):    predicted positions of atoms in global prediction frame.</span>
<span class="sd">                                           shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        atom14_atom_exists (Tensor):       mask denoting whether atom at positions exists for given amino acid type.</span>
<span class="sd">                                           shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        atom14_dists_lower_bound (Tensor): lower bond on allowed distances. shape :math:`(N_{res}, 14, 14)` .</span>
<span class="sd">        atom14_dists_upper_bound (Tensor): upper bond on allowed distances. shape :math:`(N_{res}, 14, 14)` .</span>
<span class="sd">        tighten_bounds_for_loss (float):  Extra factor to tighten loss. Default: ``0.0``.</span>
<span class="sd">        dists_mask_i (Tensor):             initial distants mask, shape: :math:`(14, 14)` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **per_atom_loss_sum** (Tensor) - sum of all clash losses per atom, shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        - **per_atom_violations** (Tensor) - violation per atom, shape :math:`(N_{res}, 14)` .</span>

<span class="sd">    Symbol:</span>
<span class="sd">        :math:`N_{res}`, number of amino acids.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import within_residue_violations</span>
<span class="sd">        &gt;&gt;&gt; atom14_pred_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_atom_exists = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_dists_lower_bound = Tensor(np.random.random(size=(50, 14, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_dists_upper_bound = Tensor(np.random.random(size=(50, 14, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; tighten_bounds_for_loss = 0.0</span>
<span class="sd">        &gt;&gt;&gt; dists_mask_i = Tensor(np.eye(14, 14), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; per_atom_loss_sum, per_atom_violations = within_residue_violations(atom14_pred_positions,</span>
<span class="sd">        ...                                                                   atom14_atom_exists,</span>
<span class="sd">        ...                                                                   atom14_dists_lower_bound,</span>
<span class="sd">        ...                                                                   atom14_dists_upper_bound,</span>
<span class="sd">        ...                                                                   tighten_bounds_for_loss,</span>
<span class="sd">        ...                                                                   dists_mask_i)</span>
<span class="sd">        &gt;&gt;&gt; print(per_atom_loss_sum.shape, per_atom_violations.shape)</span>
<span class="sd">        (50, 14) (50, 14)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dists_masks</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dists_mask_i</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">dists_masks</span> <span class="o">*=</span> <span class="p">(</span><span class="n">atom14_atom_exists</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">atom14_atom_exists</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">atom14_pred_positions</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">atom14_pred_positions</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">dists_to_low_error</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">atom14_dists_lower_bound</span> <span class="o">+</span> <span class="n">tighten_bounds_for_loss</span> <span class="o">-</span> <span class="n">dists</span><span class="p">)</span>
    <span class="n">dists_to_high_error</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">dists</span> <span class="o">-</span> <span class="p">(</span><span class="n">atom14_dists_upper_bound</span> <span class="o">-</span> <span class="n">tighten_bounds_for_loss</span><span class="p">))</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">dists_masks</span> <span class="o">*</span> <span class="p">(</span><span class="n">dists_to_low_error</span> <span class="o">+</span> <span class="n">dists_to_high_error</span><span class="p">)</span>
    <span class="n">per_atom_loss_sum</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">dists</span> <span class="o">&lt;</span> <span class="n">atom14_dists_lower_bound</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">dists</span> <span class="o">&gt;</span> <span class="n">atom14_dists_upper_bound</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">violations</span> <span class="o">=</span> <span class="n">dists_masks</span> <span class="o">*</span> <span class="p">((</span><span class="n">lower</span> <span class="o">+</span> <span class="n">high</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>

    <span class="n">per_atom_violations</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">per_atom_loss_sum</span><span class="p">,</span> <span class="n">per_atom_violations</span></div>


<div class="viewcode-block" id="get_structural_violations"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.get_structural_violations.html#mindsponge.metrics.get_structural_violations">[docs]</a><span class="k">def</span> <span class="nf">get_structural_violations</span><span class="p">(</span><span class="n">atom14_atom_exists</span><span class="p">,</span> <span class="n">residue_index</span><span class="p">,</span> <span class="n">aatype</span><span class="p">,</span> <span class="n">residx_atom14_to_atom37</span><span class="p">,</span>
                              <span class="n">atom14_pred_positions</span><span class="p">,</span> <span class="n">violation_tolerance_factor</span><span class="o">=</span><span class="n">VIOLATION_TOLERANCE_ACTOR</span><span class="p">,</span>
                              <span class="n">clash_overlap_tolerance</span><span class="o">=</span><span class="n">CLASH_OVERLAP_TOLERANCE</span><span class="p">,</span> <span class="n">lower_bound</span><span class="o">=</span><span class="n">LOWER_BOUND</span><span class="p">,</span>
                              <span class="n">upper_bound</span><span class="o">=</span><span class="n">UPPER_BOUND</span><span class="p">,</span> <span class="n">atomtype_radius</span><span class="o">=</span><span class="n">ATOMTYPE_RADIUS</span><span class="p">,</span>
                              <span class="n">c_one_hot</span><span class="o">=</span><span class="n">C_ONE_HOT</span><span class="p">,</span> <span class="n">n_one_hot</span><span class="o">=</span><span class="n">N_ONE_HOT</span><span class="p">,</span> <span class="n">dists_mask_i</span><span class="o">=</span><span class="n">DISTS_MASK_I</span><span class="p">,</span>
                              <span class="n">cys_sg_idx</span><span class="o">=</span><span class="n">CYS_SG_IDX</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes several checks for structural violations.</span>

<span class="sd">    Args:</span>
<span class="sd">        atom14_atom_exists (Tensor):        mask denoting whether atom at positions exists for given amino acid type.</span>
<span class="sd">                                            shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        residue_index (Tensor):             Residue index for given amino acid range from 0 to :math:`N_{res} - 1`.</span>
<span class="sd">                                            Shape :math:`(N_{res}, )` .</span>
<span class="sd">        aatype (Tensor):                    amino acid types. shape :math:`(N_{res}, )` . Range is  :math:`[0,20]` .</span>
<span class="sd">        residx_atom14_to_atom37 (Tensor):   mapping for (residx, atom14) --&gt; atom37. shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        atom14_pred_positions (Tensor):     predicted positions of atoms in global prediction frame.</span>
<span class="sd">                                            shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        violation_tolerance_factor (float): violation between amino acid tolerance factor. Default: ``12.0`` .</span>
<span class="sd">        clash_overlap_tolerance (float):    clash overlap tolerance factor. Default: ``1.5`` .</span>
<span class="sd">        lower_bound (Tensor):               lower bond on allowed distances. shape :math:`(N_{res}, 14, 14)` .</span>
<span class="sd">        upper_bound (Tensor):               upper bond on allowed distances. shape :math:`(N_{res}, 14, 14)` .</span>
<span class="sd">        atomtype_radius (Tensor):           Van der Waals radius for each amino acid. shape: :math:`(37, )` .</span>
<span class="sd">        c_one_hot (Tensor):                 one hot encoding for C atoms (using atom14 representation).</span>
<span class="sd">                                            shape: :math:`(14, )` .</span>
<span class="sd">        n_one_hot (Tensor):                 one hot encoding for N atoms (using atom14 representation).</span>
<span class="sd">                                            shape: :math:`(14, )` .</span>
<span class="sd">        dists_mask_i (Tensor):              initial distants mask, shape: :math:`(14, 14)` .</span>
<span class="sd">        cys_sg_idx (Tensor):                CYS amino acid index. Default: ``5`` .</span>
<span class="sd">                                            see more at `mindsponge.common.residue_constants`. shape: :math:`( )`</span>

<span class="sd">    Returns:</span>
<span class="sd">        - bonds_c_n_loss_mean (Tensor), loss for peptide bond length violations. shape is :math:`()`.</span>
<span class="sd">        - angles_ca_c_n_loss_mean (Tensor), loss for violations of bond angle around C spanned by CA, C, N.</span>
<span class="sd">          Shape is :math:`()`.</span>
<span class="sd">        - angles_c_n_ca_loss_mean (Tensor), loss for violations of bond angle around N spanned by C, N, CA.</span>
<span class="sd">          Shape is :math:`()`.</span>
<span class="sd">        - connections_per_residue_loss_sum (Tensor), sum of all losses of each residue. shape is :math:`(N_{res}, )` .</span>
<span class="sd">        - connections_per_residue_violation_mask (Tensor), mask denoting all residues with violation present.</span>
<span class="sd">          shape is :math:`(N_{res}, )` .</span>
<span class="sd">        - clashes_mean_loss (Tensor),  average clash loss. shape: :math:`()` .</span>
<span class="sd">        - clashes_per_atom_loss_sum (Tensor), sum of all clash losses per atom, shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        - clashes_per_atom_clash_mask (Tensor), mask whether atom clashes with any other atom.</span>
<span class="sd">          shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        - per_atom_loss_sum (Tensor), sum of all clash losses per atom, shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        - per_atom_violations (Tensor), violation per atom, shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        - total_per_residue_violations_mask (Tensor), violation masks for all residues, shape :math:`(N_{res}, )` .</span>
<span class="sd">        - structure_violation_loss (Tensor), total violations for all amino acids. shape is :math:`()` .</span>

<span class="sd">    Symbol:</span>
<span class="sd">        :math:`N_{res}`, number of amino acids.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import get_structural_violations</span>
<span class="sd">        &gt;&gt;&gt; atom14_atom_exists = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; residue_index = Tensor(np.array(range(50)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; aatype = Tensor(np.random.randint(20, size=(50,)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; residx_atom14_to_atom37 = Tensor(np.random.randint(2, size=(50, 14)), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_pred_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; violation_tolerance_factor = 12.0</span>
<span class="sd">        &gt;&gt;&gt; clash_overlap_tolerance = 1.5</span>
<span class="sd">        &gt;&gt;&gt; lower_bound = Tensor(np.random.random(size=(50, 14, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; upper_bound = Tensor(np.random.random(size=(50, 14, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atomtype_radius =Tensor([1.55, 1.7, 1.7, 1.7, 1.52, 1.7, 1.7, 1.7, 1.52, 1.52, 1.8,</span>
<span class="sd">        ...                          1.7, 1.7, 1.7, 1.55, 1.55, 1.52, 1.52, 1.8, 1.7, 1.7, 1.7,</span>
<span class="sd">        ...                          1.7, 1.55, 1.55, 1.55, 1.52, 1.52, 1.7, 1.55, 1.55, 1.52, 1.7,</span>
<span class="sd">        ...                          1.7, 1.7, 1.55, 1.52], ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; c_one_hot = Tensor(np.array([0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; n_one_hot = Tensor(np.array([1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; dists_mask_i = Tensor(np.eye(14, 14), ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; cys_sg_idx = Tensor(5, ms.int32)</span>
<span class="sd">        &gt;&gt;&gt; result = get_structural_violations(atom14_atom_exists, residue_index, aatype, residx_atom14_to_atom37,</span>
<span class="sd">        ...                                    atom14_pred_positions, violation_tolerance_factor,</span>
<span class="sd">        ...                                    clash_overlap_tolerance, lower_bound, upper_bound, atomtype_radius,</span>
<span class="sd">        ...                                    c_one_hot, n_one_hot, dists_mask_i,cys_sg_idx)</span>
<span class="sd">        &gt;&gt;&gt; for r in result:</span>
<span class="sd">        &gt;&gt;&gt;     print(r.shape)</span>
<span class="sd">        ()</span>
<span class="sd">        ()</span>
<span class="sd">        ()</span>
<span class="sd">        (50,)</span>
<span class="sd">        (50,)</span>
<span class="sd">        ()</span>
<span class="sd">        (50, 14)</span>
<span class="sd">        (50, 14)</span>
<span class="sd">        (50, 14)</span>
<span class="sd">        (50, 14)</span>
<span class="sd">        (50,)</span>
<span class="sd">        ()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute between residue backbone violations of bonds and angles.</span>
    <span class="n">c_n_loss_mean</span><span class="p">,</span> <span class="n">ca_c_n_loss_mean</span><span class="p">,</span> <span class="n">c_n_ca_loss_mean</span><span class="p">,</span> <span class="n">per_residue_loss_sum</span><span class="p">,</span> <span class="n">per_residue_violation_mask</span> <span class="o">=</span> \
        <span class="n">between_residue_bond</span><span class="p">(</span>
            <span class="n">pred_atom_positions</span><span class="o">=</span><span class="n">atom14_pred_positions</span><span class="p">,</span>
            <span class="n">pred_atom_mask</span><span class="o">=</span><span class="n">atom14_atom_exists</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">residue_index</span><span class="o">=</span><span class="n">residue_index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">aatype</span><span class="o">=</span><span class="n">aatype</span><span class="p">,</span>
            <span class="n">tolerance_factor_soft</span><span class="o">=</span><span class="n">violation_tolerance_factor</span><span class="p">,</span>
            <span class="n">tolerance_factor_hard</span><span class="o">=</span><span class="n">violation_tolerance_factor</span><span class="p">)</span>

    <span class="c1"># Compute the Van der Waals radius for every atom (the first letter of the atom name is the element type).</span>
    <span class="c1"># Shape: (N, 14).</span>
    <span class="n">atom14_atom_radius</span> <span class="o">=</span> <span class="n">atom14_atom_exists</span> <span class="o">*</span> <span class="n">P</span><span class="o">.</span><span class="n">Gather</span><span class="p">()(</span><span class="n">atomtype_radius</span><span class="p">,</span> <span class="n">residx_atom14_to_atom37</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Compute the between residue clash loss.</span>
    <span class="n">mean_loss</span><span class="p">,</span> <span class="n">clashes_per_atom_loss_sum</span><span class="p">,</span> <span class="n">per_atom_clash_mask</span> <span class="o">=</span> <span class="n">between_residue_clash</span><span class="p">(</span>
        <span class="n">atom14_pred_positions</span><span class="o">=</span><span class="n">atom14_pred_positions</span><span class="p">,</span>
        <span class="n">atom14_atom_exists</span><span class="o">=</span><span class="n">atom14_atom_exists</span><span class="p">,</span>
        <span class="n">atom14_atom_radius</span><span class="o">=</span><span class="n">atom14_atom_radius</span><span class="p">,</span>
        <span class="n">residue_index</span><span class="o">=</span><span class="n">residue_index</span><span class="p">,</span>
        <span class="n">c_one_hot</span><span class="o">=</span><span class="n">c_one_hot</span><span class="p">,</span>
        <span class="n">n_one_hot</span><span class="o">=</span><span class="n">n_one_hot</span><span class="p">,</span>
        <span class="n">overlap_tolerance_soft</span><span class="o">=</span><span class="n">clash_overlap_tolerance</span><span class="p">,</span>
        <span class="n">overlap_tolerance_hard</span><span class="o">=</span><span class="n">clash_overlap_tolerance</span><span class="p">,</span>
        <span class="n">cys_sg_idx</span><span class="o">=</span><span class="n">cys_sg_idx</span>
    <span class="p">)</span>

    <span class="c1"># Compute all within-residue violations (clashes,</span>
    <span class="c1"># bond length and angle violations).</span>
    <span class="n">atom14_dists_lower_bound</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Gather</span><span class="p">()(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">aatype</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">atom14_dists_upper_bound</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Gather</span><span class="p">()(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">aatype</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">per_atom_loss_sum</span><span class="p">,</span> <span class="n">per_atom_violations</span> <span class="o">=</span> <span class="n">within_residue_violations</span><span class="p">(</span>
        <span class="n">atom14_pred_positions</span><span class="o">=</span><span class="n">atom14_pred_positions</span><span class="p">,</span>
        <span class="n">atom14_atom_exists</span><span class="o">=</span><span class="n">atom14_atom_exists</span><span class="p">,</span>
        <span class="n">atom14_dists_lower_bound</span><span class="o">=</span><span class="n">atom14_dists_lower_bound</span><span class="p">,</span>
        <span class="n">atom14_dists_upper_bound</span><span class="o">=</span><span class="n">atom14_dists_upper_bound</span><span class="p">,</span>
        <span class="n">tighten_bounds_for_loss</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">dists_mask_i</span><span class="o">=</span><span class="n">dists_mask_i</span><span class="p">)</span>

    <span class="c1"># Combine them to a single per-residue violation mask (used later for LDDT).</span>
    <span class="n">per_residue_violations_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">per_residue_violation_mask</span><span class="p">,</span> <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">per_atom_clash_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                                                     <span class="n">mnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">per_atom_violations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bonds_c_n_loss_mean</span> <span class="o">=</span> <span class="n">c_n_loss_mean</span>
    <span class="n">angles_ca_c_n_loss_mean</span> <span class="o">=</span> <span class="n">ca_c_n_loss_mean</span>
    <span class="n">angles_c_n_ca_loss_mean</span> <span class="o">=</span> <span class="n">c_n_ca_loss_mean</span>
    <span class="n">connections_per_residue_loss_sum</span> <span class="o">=</span> <span class="n">per_residue_loss_sum</span>
    <span class="n">connections_per_residue_violation_mask</span> <span class="o">=</span> <span class="n">per_residue_violation_mask</span>
    <span class="n">clashes_mean_loss</span> <span class="o">=</span> <span class="n">mean_loss</span>
    <span class="n">clashes_per_atom_loss_sum</span> <span class="o">=</span> <span class="n">clashes_per_atom_loss_sum</span>
    <span class="n">clashes_per_atom_clash_mask</span> <span class="o">=</span> <span class="n">per_atom_clash_mask</span>
    <span class="n">per_atom_loss_sum</span> <span class="o">=</span> <span class="n">per_atom_loss_sum</span>
    <span class="n">per_atom_violations</span> <span class="o">=</span> <span class="n">per_atom_violations</span>
    <span class="n">total_per_residue_violations_mask</span> <span class="o">=</span> <span class="n">per_residue_violations_mask</span>
    <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">atom14_atom_exists</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">structure_violation_loss</span> <span class="o">=</span> <span class="n">bonds_c_n_loss_mean</span> <span class="o">+</span> <span class="n">angles_ca_c_n_loss_mean</span> <span class="o">+</span> <span class="n">angles_c_n_ca_loss_mean</span> <span class="o">+</span>\
                               <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">clashes_per_atom_loss_sum</span> <span class="o">+</span> <span class="n">per_atom_loss_sum</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-6</span> <span class="o">+</span> <span class="n">num_atoms</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bonds_c_n_loss_mean</span><span class="p">,</span> <span class="n">angles_ca_c_n_loss_mean</span><span class="p">,</span> <span class="n">angles_c_n_ca_loss_mean</span><span class="p">,</span> <span class="n">connections_per_residue_loss_sum</span><span class="p">,</span>
            <span class="n">connections_per_residue_violation_mask</span><span class="p">,</span> <span class="n">clashes_mean_loss</span><span class="p">,</span> <span class="n">clashes_per_atom_loss_sum</span><span class="p">,</span>
            <span class="n">clashes_per_atom_clash_mask</span><span class="p">,</span> <span class="n">per_atom_loss_sum</span><span class="p">,</span> <span class="n">per_atom_violations</span><span class="p">,</span> <span class="n">total_per_residue_violations_mask</span><span class="p">,</span>
            <span class="n">structure_violation_loss</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_renamed_ground_truth"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.compute_renamed_ground_truth.html#mindsponge.metrics.compute_renamed_ground_truth">[docs]</a><span class="k">def</span> <span class="nf">compute_renamed_ground_truth</span><span class="p">(</span><span class="n">atom14_gt_positions</span><span class="p">,</span>
                                 <span class="n">atom14_alt_gt_positions</span><span class="p">,</span>
                                 <span class="n">atom14_atom_is_ambiguous</span><span class="p">,</span>
                                 <span class="n">atom14_gt_exists</span><span class="p">,</span>
                                 <span class="n">atom14_pred_positions</span><span class="p">,</span>
                                 <span class="n">atom14_alt_gt_exists</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find optimal renaming of ground truth based on the predicted positions.</span>

<span class="sd">    Jumper et al. (2021) Suppl. Alg. 26 &quot;renameSymmetricGroundTruthAtoms&quot;</span>

<span class="sd">    This renamed ground truth is then used for all losses,</span>
<span class="sd">    such that each loss moves the atoms in the same direction.</span>
<span class="sd">    Shape (N).</span>

<span class="sd">    Args:</span>
<span class="sd">        atom14_gt_positions (Tensor):      Ground truth positions. shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        atom14_alt_gt_positions (Tensor):  Ground truth positions with renaming swaps. shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        atom14_atom_is_ambiguous (Tensor): 1.0 for atoms that are affected by renaming swaps.</span>
<span class="sd">                                           shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        atom14_gt_exists (Tensor):         Mask for which atoms exist in ground truth. shape :math:`(N_{res}, 14)` .</span>
<span class="sd">        atom14_pred_positions (Tensor):    Array of atom positions in global frame with shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        atom14_alt_gt_exists (Tensor):     Mask for which atoms exist in ground truth after renaming.</span>
<span class="sd">                                           shape :math:`(N_{res}, 14)` .</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **alt_naming_is_better** (Tensor) - Array with 1.0 where alternative swap is better.</span>
<span class="sd">          shape :math:`(N_{res}, )` .</span>
<span class="sd">        - **renamed_atom14_gt_positions** (Tensor) - Array of optimal ground truth positions after renaming swaps are</span>
<span class="sd">          performed. shape :math:`(N_{res}, 14, 3)` .</span>
<span class="sd">        - **renamed_atom14_gt_exists** (Tensor) - Mask after renaming swap is performed. shape :math:`(N_{res}, 14)` .</span>

<span class="sd">    Symbol:</span>
<span class="sd">        :math:`N_{res}`, number of amino acids.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import compute_renamed_ground_truth</span>
<span class="sd">        &gt;&gt;&gt; atom14_gt_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_alt_gt_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_atom_is_ambiguous = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_gt_exists = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_pred_positions = Tensor(np.random.random(size=(50, 14, 3)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; atom14_alt_gt_exists = Tensor(np.random.random(size=(50, 14)), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; alt_naming_is_better, renamed_atom14_gt_positions, renamed_atom14_gt_exists = \</span>
<span class="sd">        ...     compute_renamed_ground_truth(atom14_gt_positions, atom14_alt_gt_positions, atom14_atom_is_ambiguous,</span>
<span class="sd">        ...                                  atom14_gt_exists, atom14_pred_positions, atom14_alt_gt_exists)</span>
<span class="sd">        &gt;&gt;&gt; print(alt_naming_is_better.shape, renamed_atom14_gt_positions.shape, renamed_atom14_gt_exists.shape)</span>
<span class="sd">        (50,) (50, 14, 3) (50, 14)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">alt_naming_is_better</span> <span class="o">=</span> <span class="n">find_optimal_renaming</span><span class="p">(</span><span class="n">atom14_gt_positions</span><span class="p">,</span>
                                                 <span class="n">atom14_alt_gt_positions</span><span class="p">,</span>
                                                 <span class="n">atom14_atom_is_ambiguous</span><span class="p">,</span>
                                                 <span class="n">atom14_gt_exists</span><span class="p">,</span>
                                                 <span class="n">atom14_pred_positions</span><span class="p">)</span>

    <span class="n">renamed_atom14_gt_positions</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">atom14_gt_positions</span> <span class="o">+</span>
                                   <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">atom14_alt_gt_positions</span><span class="p">)</span>

    <span class="n">renamed_atom14_gt_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">atom14_gt_exists</span> <span class="o">+</span>
                              <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">atom14_alt_gt_exists</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_naming_is_better</span><span class="p">,</span> <span class="n">renamed_atom14_gt_positions</span><span class="p">,</span> <span class="n">renamed_atom14_gt_mask</span></div>


<div class="viewcode-block" id="frame_aligned_point_error_map"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.frame_aligned_point_error_map.html#mindsponge.metrics.frame_aligned_point_error_map">[docs]</a><span class="k">def</span> <span class="nf">frame_aligned_point_error_map</span><span class="p">(</span><span class="n">pred_frames</span><span class="p">,</span>
                                  <span class="n">target_frames</span><span class="p">,</span>
                                  <span class="n">frames_mask</span><span class="p">,</span>
                                  <span class="n">pred_positions</span><span class="p">,</span>
                                  <span class="n">target_positions</span><span class="p">,</span>
                                  <span class="n">positions_mask</span><span class="p">,</span>
                                  <span class="n">length_scale</span><span class="p">,</span>
                                  <span class="n">l1_clamp_distance</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Measure point error under different alignments which computes error between two</span>
<span class="sd">    structures with B points under A alignments derived from the given pairs of frames.</span>
<span class="sd">    Similar with the `frame_aligned_point_error` function. The difference is this is a</span>
<span class="sd">    batched version which return batch error for each group of local frames individually,</span>
<span class="sd">    this version considers only backbone frames :math:`C\alpha` .</span>

<span class="sd">    Args:</span>
<span class="sd">        pred_frames (list): The predicted backbone frames which is a 2-dimensional list,</span>
<span class="sd">            the first element of pred_frames is a list of 9 tensors which are the 9 components of</span>
<span class="sd">            rotation matrix; the second element of pred_frames is a list of 3 tensors are the 3</span>
<span class="sd">            component of translation matrix. All tensors are of shape :math:`(N_{recycle}, N_{res})`.</span>
<span class="sd">            with :math:`N_{recycle}` the recycle number of FoldIteration in Structure module, :math:`N_{res}` the</span>
<span class="sd">            number of residues in protein.</span>
<span class="sd">        target_frames (list): The ground truth backbone frames which is also a 2-dimensional</span>
<span class="sd">            list, the same as pred_frames except that the shape of tensors is :math:`(N_{res},)`.</span>
<span class="sd">        frames_mask (Tensor): The binary mask for frames of shape  :math:`(N_{res},)`.</span>
<span class="sd">        pred_positions (list):  The predicted :math:`C\alpha` atom positions which is a list of 3</span>
<span class="sd">            tensors of shape :math:`(N_{recycle}, N_{res},)`.</span>
<span class="sd">        target_positions (list):  The ground truth :math:`C\alpha` atom positions which is a list</span>
<span class="sd">            of 3 tensors of shape :math:`(N_{res},)`.</span>
<span class="sd">        positions_mask (Tensor): The binary mask for Ca atom positions of shape :math:`(N_{res},)`.</span>
<span class="sd">        length_scale (float): The unit distance which is used to scale distances.</span>
<span class="sd">        l1_clamp_distance (float): Distance cutoff on error beyond which gradients will</span>
<span class="sd">            be zero.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **error_clamp** (Tensor) - Backbone FAPE loss clamped with shape :math:`(N_{recycle},)`.</span>
<span class="sd">        - **error_no_clamp** (Tensor) - Backbone FAPE loss (not clamped) with shape :math:`(N_{recycle},)`.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import frame_aligned_point_error_map</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; rot_matrix = [[Tensor(np.random.rand(8, 256)).astype(mstype.float32) for _ in range(9)]]</span>
<span class="sd">        &gt;&gt;&gt; trans_matrix = [[Tensor(np.random.rand(8, 256)).astype(mstype.float32) for _ in range(3)]]</span>
<span class="sd">        &gt;&gt;&gt; pred_frames = rot_matrix + trans_matrix</span>
<span class="sd">        &gt;&gt;&gt; rot_matrix = [[Tensor(np.random.rand(256,)).astype(mstype.float32) for _ in range(9)]]</span>
<span class="sd">        &gt;&gt;&gt; trans_matrix = [[Tensor(np.random.rand(256,)).astype(mstype.float32) for _ in range(3)]]</span>
<span class="sd">        &gt;&gt;&gt; target_frames = rot_matrix + trans_matrix</span>
<span class="sd">        &gt;&gt;&gt; frames_mask = Tensor(np.random.rand(256,)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; positions_mask = Tensor(np.random.rand(256,)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; pred_positions = [Tensor(np.random.rand(8, 256)).astype(mstype.float32) for _ in range(3)]</span>
<span class="sd">        &gt;&gt;&gt; target_positions = [Tensor(np.random.rand(256,)).astype(mstype.float32) for _ in range(3)]</span>
<span class="sd">        &gt;&gt;&gt; length_scale = 10.0</span>
<span class="sd">        &gt;&gt;&gt; l1_clamp_distance = 10.0</span>
<span class="sd">        &gt;&gt;&gt; error, error_noclamp = frame_aligned_point_error_map(pred_frames, target_frames, frames_mask,</span>
<span class="sd">        ...                                                      pred_positions, target_positions, positions_mask,</span>
<span class="sd">        ...                                                      length_scale, l1_clamp_distance)</span>
<span class="sd">        &gt;&gt;&gt; print(error, error_noclamp)</span>
<span class="sd">        [0.0827449  0.08608595 0.09045469 0.08518302 0.08452212 0.08624027 0.08426301 0.08154671]</span>
<span class="sd">        [0.0827449  0.08608595 0.09045469 0.08518302 0.08452212 0.08624027 0.08426301 0.08154671]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute array of predicted positions in the predicted frames.</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">yz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">zx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">zy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">t0_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">v1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xx</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yx</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zx</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xy</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zy</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xz</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yz</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zz</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>

    <span class="n">local_pred_pos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v1</span><span class="p">[</span>
            <span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">xy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v2</span><span class="p">[</span>
            <span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">xz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v3</span><span class="p">[</span>
            <span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">xx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">yy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">yz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">zx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">zy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">zz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">t0_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t0_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">v1_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xx_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yx_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zx_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>
    <span class="n">v2_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xy_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yy_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zy_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>
    <span class="n">v3_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xz_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yz_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zz_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>

    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-4</span>

    <span class="n">local_target_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">yx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">zx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">v1_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">xy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">yy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">zy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">v2_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">xz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">yz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">zz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">v3_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]]</span>
    <span class="n">error_dist</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">normalization_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frames_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
                            <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">positions_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># fape with clamp</span>
    <span class="n">error_dist_clamp</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">error_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l1_clamp_distance</span><span class="p">)</span>
    <span class="n">normed_error_clamp</span> <span class="o">=</span> <span class="n">error_dist_clamp</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">normed_error_clamp</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">frames_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">normed_error_clamp</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">positions_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">error_clamp</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">normed_error_clamp</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">normalization_factor</span><span class="p">)</span>

    <span class="c1"># fape with no clamp</span>
    <span class="n">normed_error_no_clamp</span> <span class="o">=</span> <span class="n">error_dist</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">normed_error_no_clamp</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">frames_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">normed_error_no_clamp</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">positions_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">error_no_clamp</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">normed_error_no_clamp</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">normalization_factor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">error_clamp</span><span class="p">,</span> <span class="n">error_no_clamp</span></div>


<div class="viewcode-block" id="backbone"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.backbone.html#mindsponge.metrics.backbone">[docs]</a><span class="k">def</span> <span class="nf">backbone</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">backbone_affine_tensor</span><span class="p">,</span> <span class="n">backbone_affine_mask</span><span class="p">,</span> <span class="n">fape_clamp_distance</span><span class="p">,</span> <span class="n">fape_loss_unit_distance</span><span class="p">,</span>
             <span class="n">use_clamped_fape</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backbone FAPE Loss using `frame_aligned_point_error_map` function.</span>
<span class="sd">    `Jumper et al. (2021) Suppl. Alg. 20 &quot;StructureModule&quot; line 17</span>
<span class="sd">    &lt;https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-021-03819-2/</span>
<span class="sd">    MediaObjects/41586_2021_3819_MOESM1_ESM.pdf&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        traj (Tensor): The series of backbone frames(trajectory) generated by Structure</span>
<span class="sd">            module, the shape is :math:`(N_{recycle}, N_{res}, 7)` with :math:`N_{recycle}` the</span>
<span class="sd">            recycle number of recycle in Structure module, :math:`N_{res}` the number of residues</span>
<span class="sd">            in protein, for the last dimension, the first 4 elements are the affine tensor which</span>
<span class="sd">            contains the rotation information, the last 3 elements are the translations in space.</span>
<span class="sd">        backbone_affine_tensor (Tensor): The ground truth backbone frames of shape :math:`(N_{res}, 7)`.</span>
<span class="sd">        backbone_affine_mask (Tensor): The binary mask for backbone frames of shape :math:`(N_{res},)`.</span>
<span class="sd">        fape_clamp_distance (float):  Distance cutoff on error beyond which gradients will</span>
<span class="sd">            be zero.</span>
<span class="sd">        fape_loss_unit_distance (float): The unit distance of backbone FAPE loss, used to scale</span>
<span class="sd">            distances.</span>
<span class="sd">        use_clamped_fape (float): The indicator that if backbone FAPE loss is clamped,</span>
<span class="sd">            0 or 1, 1 means clamping.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **fape** (Tensor) - Backbone FAPE loss (clamped if use_clamped_fape is 1) of last recycle</span>
<span class="sd">          of Structure module with shape :math:`()` .</span>
<span class="sd">        - **loss** (Tensor) - Averaged Backbone FAPE loss (clamped if use_clamped_fape is 1) of all recycle of</span>
<span class="sd">          Structure module with shape :math:`()` .</span>
<span class="sd">        - **no_clamp** (Tensor) - Backbone FAPE loss of last recycle of Structure module with shape :math:`()` .</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import backbone</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; traj = Tensor(np.random.rand(8, 256, 7)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; backbone_affine_tensor = Tensor(np.random.rand(256, 7)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; backbone_affine_mask = Tensor(np.random.rand(256,)).astype(mstype.float16)</span>
<span class="sd">        &gt;&gt;&gt; fape_clamp_distance = 10.0</span>
<span class="sd">        &gt;&gt;&gt; fape_loss_unit_distance = 10.0</span>
<span class="sd">        &gt;&gt;&gt; use_clamped_fape = 1</span>
<span class="sd">        &gt;&gt;&gt; fape, loss, noclamp = backbone(traj, backbone_affine_tensor, backbone_affine_mask,</span>
<span class="sd">        ...                                fape_clamp_distance, fape_loss_unit_distance, use_clamped_fape)</span>
<span class="sd">        &gt;&gt;&gt; print(fape, loss, noclamp)</span>
<span class="sd">        0.12813742 0.12904957 0.12813742</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span> <span class="o">=</span> <span class="n">quaternion_from_tensor</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
    <span class="n">pred_frames</span> <span class="o">=</span> <span class="p">((</span><span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">rotation</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                    <span class="n">rotation</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
                   <span class="p">(</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">pred_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">rotation_gt</span><span class="p">,</span> <span class="n">translation_gt</span> <span class="o">=</span> <span class="n">quaternion_from_tensor</span><span class="p">(</span><span class="n">backbone_affine_tensor</span><span class="p">)</span>
    <span class="n">target_frames</span> <span class="o">=</span> <span class="p">((</span><span class="n">rotation_gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                      <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                      <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">rotation_gt</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
                     <span class="p">(</span><span class="n">translation_gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translation_gt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">translation_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">target_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">translation_gt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translation_gt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">translation_gt</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

    <span class="n">frames_mask</span> <span class="o">=</span> <span class="n">backbone_affine_mask</span>
    <span class="n">positions_mask</span> <span class="o">=</span> <span class="n">backbone_affine_mask</span>

    <span class="n">fape_loss_clamp</span><span class="p">,</span> <span class="n">fape_loss_no_clamp</span> <span class="o">=</span> <span class="n">frame_aligned_point_error_map</span><span class="p">(</span><span class="n">pred_frames</span><span class="p">,</span>
                                                                        <span class="n">target_frames</span><span class="p">,</span>
                                                                        <span class="n">frames_mask</span><span class="p">,</span>
                                                                        <span class="n">pred_positions</span><span class="p">,</span>
                                                                        <span class="n">target_positions</span><span class="p">,</span>
                                                                        <span class="n">positions_mask</span><span class="p">,</span>
                                                                        <span class="n">fape_clamp_distance</span><span class="p">,</span>
                                                                        <span class="n">fape_loss_unit_distance</span><span class="p">)</span>
    <span class="n">fape_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">fape_loss_clamp</span> <span class="o">*</span> <span class="n">use_clamped_fape</span> <span class="o">+</span> <span class="n">fape_loss_no_clamp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">use_clamped_fape</span><span class="p">))</span>
    <span class="n">no_clamp</span> <span class="o">=</span> <span class="n">fape_loss_no_clamp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fape</span> <span class="o">=</span> <span class="n">fape_loss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fape_loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fape</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">no_clamp</span></div>


<div class="viewcode-block" id="frame_aligned_point_error"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.frame_aligned_point_error.html#mindsponge.metrics.frame_aligned_point_error">[docs]</a><span class="k">def</span> <span class="nf">frame_aligned_point_error</span><span class="p">(</span><span class="n">pred_frames</span><span class="p">,</span>
                              <span class="n">target_frames</span><span class="p">,</span>
                              <span class="n">frames_mask</span><span class="p">,</span>
                              <span class="n">pred_positions</span><span class="p">,</span>
                              <span class="n">target_positions</span><span class="p">,</span>
                              <span class="n">positions_mask</span><span class="p">,</span>
                              <span class="n">length_scale</span><span class="p">,</span>
                              <span class="n">l1_clamp_distance</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Measure point error under different alignments which computes error between two</span>
<span class="sd">    structures with B points under A alignments derived from the given pairs of frames.</span>
<span class="sd">    `Jumper et al. (2021) Suppl. Alg. 28 &quot;computeFAPE&quot;</span>
<span class="sd">    &lt;https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-021-03819-2/</span>
<span class="sd">    MediaObjects/41586_2021_3819_MOESM1_ESM.pdf&gt;`_.</span>
<span class="sd">    This function considers all frames.</span>
<span class="sd">    First transform the predicted atom positions to different predicted local frames,</span>
<span class="sd">    :math:`\vec{x_{j\_pred}^{i}} = \mathcal{T}_{i\_{pred}} \circ \vec{x_{j\_pred}}`</span>
<span class="sd">    Then transform the true atom positions to different true local frames,</span>
<span class="sd">    :math:`\vec{x_{j\_gt}^{i}} = \mathcal{T}_{i\_{gt}} \circ \vec{x_{j\_gt}}`</span>
<span class="sd">    Then compute the L2 error of all atoms positions in all local frames.</span>
<span class="sd">    :math:`\sum_{i }^{N_{frames}}\sum_{j}^{N_{atoms}}(\parallel \vec{x_{j\_pred}^{i}} -</span>
<span class="sd">    \vec{x_{j\_gt}^{i}} \parallel )`</span>

<span class="sd">    Args:</span>
<span class="sd">        pred_frames (Tensor): The predicted frames of shape :math:`(12, N_{frames})` with</span>
<span class="sd">            :math:`N_{frames}` the number of pairs of frames. For the first dimension, the first</span>
<span class="sd">            9 elements are the 9 components of rotation matrix; the last 3 elements are</span>
<span class="sd">            the 3 component of translation matrix.</span>
<span class="sd">        target_frames (Tensor): The ground truth frames of same shape as pred_frames.</span>
<span class="sd">        frames_mask (Tensor): The binary mask for frames of shape :math:`(N_{frames},)`.</span>
<span class="sd">        pred_positions (Tensor):  The predicted atom positions tensor of shape</span>
<span class="sd">            :math:`(3, N_{atoms})` with :math:`N_{atoms}` the number of atoms.</span>
<span class="sd">        target_positions (Tensor): The ground truth atom positions of same shape as</span>
<span class="sd">            pred_positions.</span>
<span class="sd">        positions_mask (Tensor): The binary mask for atom positions of shape :math:`(N_{atoms},)`.</span>
<span class="sd">        length_scale (float): The unit distance which is used to scale distances.</span>
<span class="sd">        l1_clamp_distance (float): Distance cutoff on error beyond which gradients will</span>
<span class="sd">            be zero.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **error_clamp** (Tensor) - Backbone FAPE loss clamped with shape :math:`(N_{recycle},)`.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import frame_aligned_point_error</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; pred_frames = Tensor(np.random.rand(12, 256)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; target_frames = Tensor(np.random.rand(12, 256)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; frames_mask = Tensor(np.random.rand(256,)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; pred_positions = Tensor(np.random.rand(3, 1024)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; target_positions = Tensor(np.random.rand(3, 1024)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; positions_mask = Tensor(np.random.rand(1024,)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; length_scale = 10.0</span>
<span class="sd">        &gt;&gt;&gt; l1_clamp_distance = 10.0</span>
<span class="sd">        &gt;&gt;&gt; fape = frame_aligned_point_error(pred_frames, target_frames, frames_mask,</span>
<span class="sd">        &gt;&gt;&gt;                                  pred_positions, target_positions, positions_mask,</span>
<span class="sd">        &gt;&gt;&gt;                                  length_scale, l1_clamp_distance)</span>
<span class="sd">        &gt;&gt;&gt; print(fape)</span>
<span class="sd">        0.08747593</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute array of predicted positions in the predicted frames.</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">yz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">zx</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">zy</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">t0_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">t1_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">t2_p</span> <span class="o">=</span> <span class="n">pred_frames</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">pred_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">v1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xx</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yx</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zx</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xy</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zy</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xz</span> <span class="o">*</span> <span class="n">t0_p</span> <span class="o">+</span> <span class="n">yz</span> <span class="o">*</span> <span class="n">t1_p</span> <span class="o">+</span> <span class="n">zz</span> <span class="o">*</span> <span class="n">t2_p</span><span class="p">)</span>

    <span class="n">local_pred_pos</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">xy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">xz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">yz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">zz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">+</span> <span class="n">v3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">xx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">yx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">yy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">yz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">zx_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">zy_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">zz_gt</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">t0_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">t1_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">t2_t</span> <span class="o">=</span> <span class="n">target_frames</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">t0_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t1_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2_gt</span> <span class="o">=</span> <span class="n">target_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">v1_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xx_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yx_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zx_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>
    <span class="n">v2_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xy_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yy_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zy_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>
    <span class="n">v3_gt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xz_gt</span> <span class="o">*</span> <span class="n">t0_t</span> <span class="o">+</span> <span class="n">yz_gt</span> <span class="o">*</span> <span class="n">t1_t</span> <span class="o">+</span> <span class="n">zz_gt</span> <span class="o">*</span> <span class="n">t2_t</span><span class="p">)</span>

    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">local_target_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">yx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">zx_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">v1_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">xy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">yy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">zy_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">v2_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">xz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">yz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span>
                        <span class="n">zz_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2_gt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">v3_gt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]]</span>
    <span class="n">error_dist</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">local_pred_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l1_clamp_distance</span><span class="p">:</span>
        <span class="n">error_dist</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">error_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l1_clamp_distance</span><span class="p">)</span>

    <span class="n">normed_error</span> <span class="o">=</span> <span class="n">error_dist</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">normed_error</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">frames_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">normed_error</span> <span class="o">*=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">positions_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">normalization_factor</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frames_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">positions_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normed_error</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">normalization_factor</span><span class="p">)</span></div>


<div class="viewcode-block" id="sidechain"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.sidechain.html#mindsponge.metrics.sidechain">[docs]</a><span class="k">def</span> <span class="nf">sidechain</span><span class="p">(</span><span class="n">alt_naming_is_better</span><span class="p">,</span> <span class="n">rigidgroups_gt_frames</span><span class="p">,</span> <span class="n">rigidgroups_alt_gt_frames</span><span class="p">,</span> <span class="n">rigidgroups_gt_exists</span><span class="p">,</span>
              <span class="n">renamed_atom14_gt_positions</span><span class="p">,</span> <span class="n">renamed_atom14_gt_exists</span><span class="p">,</span> <span class="n">sidechain_atom_clamp_distance</span><span class="p">,</span>
              <span class="n">sidechain_length_scale</span><span class="p">,</span> <span class="n">pred_frames</span><span class="p">,</span> <span class="n">pred_positions</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sidechain FAPE Loss which take all local frames (side-chain, backbone) into consideration.</span>
<span class="sd">    `Jumper et al. (2021) Suppl. Alg. 20 &quot;StructureModule&quot; line 17</span>
<span class="sd">    &lt;https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-021-03819-2/</span>
<span class="sd">    MediaObjects/41586_2021_3819_MOESM1_ESM.pdf&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        alt_naming_is_better (Tensor): Tensor of shape :math:`(N_{res},)`, with value 1.0 where alternative</span>
<span class="sd">            swap is better.</span>
<span class="sd">        rigidgroups_gt_frames (Tensor): The ground truth locals frames of shape :math:`(N_{res}, 8, 12)`,</span>
<span class="sd">            with :math:`N_{res}` the number of residues in protein. For each residue, there are 1 backbone</span>
<span class="sd">            frame and 7 side-chain frames, 8 frames in total. For the last dimension, the first 9 elements</span>
<span class="sd">            are the 9 components of rotation matrix; the last 3 elements are the 3 component of</span>
<span class="sd">            translation matrix.</span>
<span class="sd">        rigidgroups_alt_gt_frames (Tensor): The alternative ground truth locals frames due to</span>
<span class="sd">            symmetry of amino acids. This tensor has the same shape as `rigidgroups_gt_frames`</span>
<span class="sd">        rigidgroups_gt_exists (Tensor): The binary mask for gt frames of shape :math:`(N_{res}, 8)`.</span>
<span class="sd">        renamed_atom14_gt_positions (Tensor): The mask for ground truth positions after renaming</span>
<span class="sd">            swaps are performed(swaps are needed for some amino acids due to symmetry</span>
<span class="sd">            `compute_renamed_ground_truth`), its shape is :math:`(N_{res}, 14, 3)`.It takes the 14-types</span>
<span class="sd">            atoms encoding.</span>
<span class="sd">        renamed_atom14_gt_exists (Tensor): The mask for ground truth positions after renaming</span>
<span class="sd">            swap is performed after renaming swaps are performed, its shape is :math:`(N_{res}, 14)`.</span>
<span class="sd">        sidechain_atom_clamp_distance (float): Distance cutoff on error beyond which gradients</span>
<span class="sd">            will be zero.</span>
<span class="sd">        sidechain_length_scale (float): The unit distance of sidechain FAPE loss, used to scale</span>
<span class="sd">            distances.</span>
<span class="sd">        pred_frames (Tensor): The predicted locals frames of shape :math:`(12, N_{recycle}, N_{res}, 8)`.</span>
<span class="sd">            :math:`N_{recycle}` is the recycle number of FoldIteration in Structure module. Only the frames of</span>
<span class="sd">            last recycle is used in side-chain FAPE loss. 12 has the same meaning as the third dimension of</span>
<span class="sd">            `rigidgroups_gt_frames`.</span>
<span class="sd">        pred_positions (Tensor): The predicted positions of shape :math:`(3, N_{recycle}, N_{res}, 14)`.</span>
<span class="sd">            Only the positions of last recycle is used in side-chain FAPE loss, encoded atom-14 encoding.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor, fape. Clamped side-chian FAPE loss with shape :math:`()`.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import sidechain</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; alt_naming_is_better = Tensor(np.zeros((256,))).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; rigidgroups_gt_frames = Tensor(np.random.rand(256, 8, 12)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; rigidgroups_alt_gt_frames = Tensor(np.random.rand(256, 8, 12)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; rigidgroups_gt_exists = Tensor(np.random.rand(256, 8)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; renamed_atom14_gt_positions = Tensor(np.random.rand(256, 14, 3)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; renamed_atom14_gt_exists = Tensor(np.random.rand(256, 14)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; sidechain_atom_clamp_distance = 10.0</span>
<span class="sd">        &gt;&gt;&gt; sidechain_length_scale = 10.0</span>
<span class="sd">        &gt;&gt;&gt; pred_frames = Tensor(np.random.rand(12, 8, 256, 8)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; pred_positions = Tensor(np.random.rand(3, 8, 256, 14)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; sidechain_loss = sidechain(alt_naming_is_better, rigidgroups_gt_frames, rigidgroups_alt_gt_frames,</span>
<span class="sd">        ...                            rigidgroups_gt_exists, renamed_atom14_gt_positions,</span>
<span class="sd">        ...                            renamed_atom14_gt_exists, sidechain_atom_clamp_distance,sidechain_length_scale,</span>
<span class="sd">        ...                            pred_frames, pred_positions)</span>
<span class="sd">        &gt;&gt;&gt; print(sidechain_loss)</span>
<span class="sd">        0.08569459</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Rename Frames</span>
    <span class="c1"># Jumper et al. (2021) Suppl. Alg. 26 &quot;renameSymmetricGroundTruthAtoms&quot; line 7</span>
    <span class="n">renamed_gt_frames</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">rigidgroups_gt_frames</span>
                         <span class="o">+</span> <span class="n">alt_naming_is_better</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">rigidgroups_alt_gt_frames</span><span class="p">)</span>
    <span class="n">flat_gt_frames</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">renamed_gt_frames</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">flat_frames_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rigidgroups_gt_exists</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">flat_gt_positions_t</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">renamed_atom14_gt_positions</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">flat_positions_mask</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">renamed_atom14_gt_exists</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Compute frame_aligned_point_error score for the final layer.</span>
    <span class="n">flat_pred_frames</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pred_frames</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">flat_pred_positions</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pred_positions</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># FAPE Loss on sidechains</span>
    <span class="n">fape</span> <span class="o">=</span> <span class="n">frame_aligned_point_error</span><span class="p">(</span>
        <span class="n">pred_frames</span><span class="o">=</span><span class="n">flat_pred_frames</span><span class="p">,</span>
        <span class="n">target_frames</span><span class="o">=</span><span class="n">flat_gt_frames</span><span class="p">,</span>
        <span class="n">frames_mask</span><span class="o">=</span><span class="n">flat_frames_mask</span><span class="p">,</span>
        <span class="n">pred_positions</span><span class="o">=</span><span class="n">flat_pred_positions</span><span class="p">,</span>
        <span class="n">target_positions</span><span class="o">=</span><span class="n">flat_gt_positions_t</span><span class="p">,</span>
        <span class="n">positions_mask</span><span class="o">=</span><span class="n">flat_positions_mask</span><span class="p">,</span>
        <span class="n">l1_clamp_distance</span><span class="o">=</span><span class="n">sidechain_atom_clamp_distance</span><span class="p">,</span>
        <span class="n">length_scale</span><span class="o">=</span><span class="n">sidechain_length_scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fape</span></div>


<div class="viewcode-block" id="supervised_chi"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.supervised_chi.html#mindsponge.metrics.supervised_chi">[docs]</a><span class="k">def</span> <span class="nf">supervised_chi</span><span class="p">(</span><span class="n">sequence_mask</span><span class="p">,</span> <span class="n">aatype</span><span class="p">,</span> <span class="n">sin_cos_true_chi</span><span class="p">,</span> <span class="n">torsion_angle_mask</span><span class="p">,</span> <span class="n">sin_cos_pred_chi</span><span class="p">,</span>
                   <span class="n">sin_cos_unnormalized_pred</span><span class="p">,</span> <span class="n">chi_weight</span><span class="p">,</span> <span class="n">angle_norm_weight</span><span class="p">,</span> <span class="n">chi_pi_periodic</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes loss for direct chi angle supervision. The torsion angles are represented by</span>
<span class="sd">    the sine and cosine value of the angle. This loss is composed of 2 items, the error of</span>
<span class="sd">    normalized predicted sine and cosine value, called chi angle difference loss; the other</span>
<span class="sd">    term is the difference between L2 norm of sine cosine value and 1, called angle norm loss.</span>
<span class="sd">    `Jumper et al. (2021) Suppl. Alg. 27 &quot;torsionAngleLoss&quot;</span>
<span class="sd">    &lt;https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-021-03819-2/</span>
<span class="sd">    MediaObjects/41586_2021_3819_MOESM1_ESM.pdf&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        sequence_mask (Tensor): The mask tensor for sequence of shape :math:`(N_{res},)`</span>
<span class="sd">            with :math:`N_{res}` the number of residues in protein.</span>
<span class="sd">        aatype (Tensor): The amino acid type tensor of shape :math:`(N_{res},)`.</span>
<span class="sd">        sin_cos_true_chi (Tensor): Tensor of shape :math:`(N_{res}, 14)` which is the sine</span>
<span class="sd">            and cosine value of torsion angles. There are 7 torsion angles per residue,</span>
<span class="sd">            3 for backbone and 4 for sidechain.</span>
<span class="sd">        torsion_angle_mask (Tensor): The binary mask for sidechain torsion angles of shape</span>
<span class="sd">            :math:`(N_{res}, 4)`</span>
<span class="sd">        sin_cos_pred_chi (Tensor): The predicted sine and cosine value (normalized)</span>
<span class="sd">            of torsion angles of shape :math:`(N_{res}, 4, 2)`.</span>
<span class="sd">        sin_cos_unnormalized_pred (Tensor): The predicted sine and cosine value (unnormalized)</span>
<span class="sd">            of torsion angles of shape :math:`(N_{recycle}, N_{res}, 7, 2)`  with :math:`N_{recycle}`</span>
<span class="sd">            is the recycle number of FoldIteration in Structure module.</span>
<span class="sd">        chi_weight (float): The weight of chi angle difference loss term, constant.</span>
<span class="sd">        angle_norm_weight (float): The weight of angle norm loss term, constant.</span>
<span class="sd">        chi_pi_periodic (Tensor): Chi angles that are pi periodic: they can be rotated</span>
<span class="sd">            by a multiple of pi without affecting the structure. Constants of residues of shape</span>
<span class="sd">            :math:`(21, 4)`, 20 types of amino acids + unknown.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **loss** (Tensor) - Supervised chi angle loss with shape :math:`()` .</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import supervised_chi</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.common import residue_constants</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; sequence_mask = Tensor(np.random.rand(256, )).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; aatype = Tensor(np.random.randint(0, 21, (256,) )).astype(mstype.int32)</span>
<span class="sd">        &gt;&gt;&gt; sin_cos_true_chi = Tensor(np.random.rand(256, 4, 2)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; torsion_angle_mask = Tensor(np.random.rand(256, 4)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; sin_cos_pred_chi = Tensor(np.random.rand(256, 14)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; sin_cos_unnormalized_pred = Tensor(np.random.rand(8, 256, 7, 2)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; chi_weight = 0.1</span>
<span class="sd">        &gt;&gt;&gt; angle_norm_weight = 0.2</span>
<span class="sd">        &gt;&gt;&gt; chi_pi_periodic = Tensor(residue_constants.chi_pi_periodic).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; chi_loss = supervised_chi(sequence_mask, aatype, sin_cos_true_chi, torsion_angle_mask, sin_cos_pred_chi,</span>
<span class="sd">        ...                           sin_cos_unnormalized_pred, chi_weight, angle_norm_weight, chi_pi_periodic)</span>
<span class="sd">        &gt;&gt;&gt; print(chi_loss)</span>
<span class="sd">        0.061829045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>

    <span class="n">num_res</span> <span class="o">=</span> <span class="n">sequence_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">chi_mask</span> <span class="o">=</span> <span class="n">torsion_angle_mask</span>
    <span class="n">pred_angles</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sin_cos_pred_chi</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_res</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">pred_angles</span> <span class="o">=</span> <span class="n">pred_angles</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:]</span>

    <span class="n">residue_type_one_hot</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">OneHot</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">21</span><span class="p">)(</span><span class="n">aatype</span><span class="p">)[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">chi_pi_periodic</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">residue_type_one_hot</span><span class="p">,</span> <span class="n">chi_pi_periodic</span><span class="p">)</span>

    <span class="c1"># This is -1 if chi is pi-periodic and +1 if it&#39;s 2pi-periodic</span>
    <span class="n">shifted_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chi_pi_periodic</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">sin_cos_true_chi_shifted</span> <span class="o">=</span> <span class="n">shifted_mask</span> <span class="o">*</span> <span class="n">sin_cos_true_chi</span>

    <span class="n">sq_chi_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sin_cos_true_chi</span> <span class="o">-</span> <span class="n">pred_angles</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sq_chi_error_shifted</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sin_cos_true_chi_shifted</span> <span class="o">-</span> <span class="n">pred_angles</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sq_chi_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sq_chi_error</span><span class="p">,</span> <span class="n">sq_chi_error_shifted</span><span class="p">)</span>

    <span class="n">sq_chi_loss</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">chi_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">sq_chi_error</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
                  <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">chi_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">chi_weight</span> <span class="o">*</span> <span class="n">sq_chi_loss</span>
    <span class="n">unnormed_angles</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sin_cos_unnormalized_pred</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_res</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">angle_norm</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">unnormed_angles</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">norm_error</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angle_norm</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">angle_norm_loss</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">sequence_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm_error</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
                      <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()(</span><span class="n">sequence_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">+=</span> <span class="n">angle_norm_weight</span> <span class="o">*</span> <span class="n">angle_norm_loss</span>
    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="local_distance_difference_test"><a class="viewcode-back" href="../../../metrics/mindsponge.metrics.local_distance_difference_test.html#mindsponge.metrics.local_distance_difference_test">[docs]</a><span class="k">def</span> <span class="nf">local_distance_difference_test</span><span class="p">(</span><span class="n">predicted_points</span><span class="p">,</span> <span class="n">true_points</span><span class="p">,</span> <span class="n">true_points_mask</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">per_residue</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute true and predicted distance matrices for  :math:`C\alpha`.</span>
<span class="sd">    First calculate the distance matrix of true and predicted :math:`C\alpha` atoms</span>
<span class="sd">    :math:`D = (((x[None,:] - x[:,None])^2).sum(-1))^{0.5}`</span>
<span class="sd">    then compute the rate that difference is smaller than fixed value:</span>
<span class="sd">    :math:`lddt = (rate(abs(D_{true} - D_{pred}) &lt; 0.5) + rate(abs(D_{true} - D_{pred}) &lt; 1.0)</span>
<span class="sd">    + rate(abs(D_{true} - D_{pred}) &lt; 2.0) + rate(abs(D_{true} - D_{pred}) &lt; 4.0))/4`</span>
<span class="sd">    `Jumper et al. (2021) Suppl. Alg. 29 &quot;predictPerResidueLDDT_Ca&quot;</span>
<span class="sd">    &lt;https://static-content.springer.com/esm/art%3A10.1038%2Fs41586-021-03819-2/</span>
<span class="sd">    MediaObjects/41586_2021_3819_MOESM1_ESM.pdf&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        predicted_points (Tensor): The prediction Ca atoms position tensor of shape</span>
<span class="sd">            :math:`(1, N_{res}, 3)` with :math:`N_{res}` the number of residues in protein.</span>
<span class="sd">        true_points (Tensor): The ground truth Ca atoms position tensor of shape</span>
<span class="sd">            :math:`(1, N_{res}, 3)`</span>
<span class="sd">        true_points_mask (Tensor): The binary mask for predicted_points of shape</span>
<span class="sd">            :math:`(1, N_{res}, 1)`</span>
<span class="sd">        cutoff (float): The cutoff value for lddt to stop gradient, Default: ``15``.</span>
<span class="sd">        per_residue (bool): The indicator if local distance difference is averaged,</span>
<span class="sd">            set True to return local distance difference per residue. Default: ``False``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - **score** (Tensor) - Local distance difference score, the shape is :math:`(1,)`</span>
<span class="sd">          if `per_residue` is set to ``False``, :math:`(1, N_{res})` otherwise.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; from mindsponge.metrics import local_distance_difference_test</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import dtype as mstype</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import Tensor</span>
<span class="sd">        &gt;&gt;&gt; predicted_points = Tensor(np.random.rand(1, 256, 3)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; true_points = Tensor(np.random.rand(1, 256, 3)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; true_points_mask = Tensor(np.random.rand(1, 256, 1)).astype(mstype.float32)</span>
<span class="sd">        &gt;&gt;&gt; lddt = local_distance_difference_test(predicted_points, true_points, true_points_mask,</span>
<span class="sd">        ...                                       cutoff=15, per_residue=False)</span>
<span class="sd">        &gt;&gt;&gt; print(lddt)</span>
<span class="sd">        [0.9554313]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dmat_true</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">true_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">true_points</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">dmat_predicted</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">predicted_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_points</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                                              <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">dists_to_score</span> <span class="o">=</span> <span class="p">((</span><span class="n">dmat_true</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">true_points_mask</span> <span class="o">*</span>
                      <span class="n">mnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">true_points_mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
                      <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">mnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">dmat_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Exclude self-interaction.</span>
                      <span class="p">)</span>

    <span class="c1"># Shift unscored distances to be far away.</span>
    <span class="n">dist_l1</span> <span class="o">=</span> <span class="n">mnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dmat_true</span> <span class="o">-</span> <span class="n">dmat_predicted</span><span class="p">)</span>

    <span class="c1"># True lDDT uses a number of fixed bins.</span>
    <span class="c1"># We ignore the physical plausibility correction to lDDT, though.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">((</span><span class="n">dist_l1</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">dist_l1</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">dist_l1</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">dist_l1</span> <span class="o">&lt;</span> <span class="mf">4.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">mnp</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="c1"># Normalize over the appropriate axes.</span>
    <span class="n">reduce_axes</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="k">if</span> <span class="n">per_residue</span> <span class="k">else</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dists_to_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">reduce_axes</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">mnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dists_to_score</span> <span class="o">*</span> <span class="n">score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">reduce_axes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">score</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
</body>
</html>