<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sciai.common.train_cell &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script><script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/js/theme.js"></script><script src="../../../_static/underscore.js"></script><script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">MindSpore SciAI Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Launching Instruction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../launch_with_scripts.html">Launching Model with Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../launch_with_api.html">Launching Model with API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../model_library.html">Model Library</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../build_model_with_sciai.html">Building Neural Networks with SciAI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sciai.architecture.html">sciai.architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sciai.common.html">sciai.common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sciai.context.html">sciai.context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sciai.operators.html">sciai.operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sciai.utils.html">sciai.utils</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RELEASE NOTES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../RELEASE.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>sciai.common.train_cell</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sciai.common.train_cell</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2023 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
<span class="sd">&quot;&quot;&quot;train_cell&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>

<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">amp</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">zeros_like</span><span class="p">,</span> <span class="n">ones_like</span>

<span class="kn">from</span> <span class="nn">sciai.utils</span> <span class="kn">import</span> <span class="n">time_second</span><span class="p">,</span> <span class="n">time_str</span><span class="p">,</span> <span class="n">print_log</span>
<span class="kn">from</span> <span class="nn">sciai.utils.check_utils</span> <span class="kn">import</span> <span class="n">to_tuple</span><span class="p">,</span> <span class="n">_batch_check_type</span><span class="p">,</span> <span class="n">_check_value_in</span>


<div class="viewcode-block" id="TrainCellWithCallBack"><a class="viewcode-back" href="../../../common/sciai.common.TrainCellWithCallBack.html#sciai.common.TrainCellWithCallBack">[docs]</a><span class="k">class</span> <span class="nc">TrainCellWithCallBack</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TrainOneStepCell with callbacks, which can handle multi-losses. Callbacks can be as follows:</span>

<span class="sd">    1.loss: print loss(es).</span>
<span class="sd">    2.time: print time spent during steps, and time spent from start.</span>
<span class="sd">    3.ckpt: save checkpoint.</span>

<span class="sd">    Args:</span>
<span class="sd">        network (Cell): The training network. The network supports multi-outputs.</span>
<span class="sd">        optimizer (Cell): Optimizer for updating the network parameters.</span>
<span class="sd">        loss_interval (int): Step interval to print loss. if 0, it wouldn&#39;t print loss. Default: 1.</span>
<span class="sd">        time_interval (int): Step interval to print time. if 0, it wouldn&#39;t print time. Default: 0.</span>
<span class="sd">        ckpt_interval (int): Epoch interval to save checkpoint, calculated according to batch_num. If 0,</span>
<span class="sd">            it wouldn&#39;t save checkpoint. Default: 0.</span>
<span class="sd">        loss_names (Union(str, tuple[str], list[str])): Loss names in order of network outputs. It can accept n or n+1</span>
<span class="sd">            strings, where n is the count of network outputs. If n, each string corresponds to the loss in the same</span>
<span class="sd">            position; if n + 1, the first loss name represents the sum of all outputs. Default:(&quot;loss&quot;,).</span>
<span class="sd">        batch_num (int): How many batches per epoch. Default: 1.</span>
<span class="sd">        grad_first (bool): If True, only the first output of the network would participate in the gradient</span>
<span class="sd">            descent. Otherwise, the sum of all outputs of the network would be taken into account. Default: False.</span>
<span class="sd">        amp_level (str): Mixed precision level, which supports [&quot;O0&quot;, &quot;O1&quot;, &quot;O2&quot;, &quot;O3&quot;]. Default: &quot;O0&quot;.</span>
<span class="sd">        ckpt_dir (str): Checkpoints saving path. Default: &quot;./checkpoints&quot;.</span>
<span class="sd">        clip_grad (bool): Whether clip grad or not. Default: False.</span>
<span class="sd">        clip_norm (Union(float, int)): The clipping ratio, it should be greater than 0. Only enabled when `clip_grad`</span>
<span class="sd">            is True. Default: 1e-3.</span>
<span class="sd">        model_name (str): Model name which influences the checkpoint filename.</span>

<span class="sd">    Inputs:</span>
<span class="sd">        - **\*args** (tuple[Tensor]) - Tuple of input tensors of the network.</span>

<span class="sd">    Outputs:</span>
<span class="sd">        Union[Tensor, tuple[Tensor]], Tensor(s) of the loss(es).</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the input parameters are not of required types.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``GPU`` ``CPU`` ``Ascend``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import mindspore as ms</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import nn, ops</span>
<span class="sd">        &gt;&gt;&gt; from sciai.common import TrainCellWithCallBack</span>
<span class="sd">        &gt;&gt;&gt; class LossNet(nn.Cell):</span>
<span class="sd">        &gt;&gt;&gt;     def __init__(self):</span>
<span class="sd">        &gt;&gt;&gt;         super().__init__()</span>
<span class="sd">        &gt;&gt;&gt;         self.dense1 = nn.Dense(2, 1)</span>
<span class="sd">        &gt;&gt;&gt;         self.dense2 = nn.Dense(2, 1)</span>
<span class="sd">        &gt;&gt;&gt;     def construct(self, x):</span>
<span class="sd">        &gt;&gt;&gt;         loss1 = self.dense1(x).sum()</span>
<span class="sd">        &gt;&gt;&gt;         loss2 = self.dense2(x).sum()</span>
<span class="sd">        &gt;&gt;&gt;         return loss1, loss2</span>
<span class="sd">        &gt;&gt;&gt; loss_net = LossNet()</span>
<span class="sd">        &gt;&gt;&gt; optimizer = nn.Adam(loss_net.trainable_params(), 1e-2)</span>
<span class="sd">        &gt;&gt;&gt; train_net = TrainCellWithCallBack(loss_net, optimizer, time_interval=3, loss_interval=1, ckpt_interval=5,</span>
<span class="sd">        &gt;&gt;&gt;                                   ckpt_dir=&#39;.&#39;, loss_names=(&quot;total loss&quot;, &quot;loss1&quot;, &quot;loss2&quot;))</span>
<span class="sd">        &gt;&gt;&gt; x = ops.ones((3, 2), ms.float32)</span>
<span class="sd">        &gt;&gt;&gt; for epoch in range(8):</span>
<span class="sd">        &gt;&gt;&gt;     loss1, loss2 = train_net(x)</span>
<span class="sd">        step: 0, loss1: 0.07256523, loss2: 0.010363013, interval: 3.132981061935425s, total: 3.132981061935425s,</span>
<span class="sd">            checkpoint saved at: ./model_iter_0_2000-12-31-23-59-59.ckpt</span>
<span class="sd">        step: 1, loss1: 0.06356523, loss2: 0.0013630127</span>
<span class="sd">        step: 2, loss1: 0.054565262, loss2: 0.007636956</span>
<span class="sd">        step: 3, loss1: 0.04556533, loss2: 0.00999487, interval: 0.01753377914428711s, total: 3.150514841079712s</span>
<span class="sd">        step: 4, loss1: 0.036565356, loss2: 0.0090501215</span>
<span class="sd">        step: 5, loss1: 0.027565379, loss2: 0.0061383317, checkpoint saved at: ./model_iter_5_2000-12-31-23-59-59.ckpt</span>
<span class="sd">        step: 6, loss1: 0.018565409, loss2: 0.0019272038, interval: 0.02319502830505371s, total: 3.1737098693847656s</span>
<span class="sd">        step: 7, loss1: 0.00956542, loss2: 0.0032018598</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckpt_interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">loss_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,),</span>
                 <span class="n">batch_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amp_level</span><span class="o">=</span><span class="s2">&quot;O0&quot;</span><span class="p">,</span> <span class="n">ckpt_dir</span><span class="o">=</span><span class="s2">&quot;./checkpoints&quot;</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">clip_norm</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">):</span>
        <span class="n">check_type_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">),</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">),</span>
            <span class="s2">&quot;loss_interval&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">loss_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;time_interval&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">time_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;ckpt_interval&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">ckpt_interval</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;loss_names&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">loss_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)),</span>
            <span class="s2">&quot;batch_num&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">batch_num</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;grad_first&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">grad_first</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
            <span class="s2">&quot;ckpt_dir&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;clip_grad&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">clip_grad</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
            <span class="s2">&quot;clip_norm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">clip_norm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span>
            <span class="s2">&quot;amp_level&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">amp_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">_batch_check_type</span><span class="p">(</span><span class="n">check_type_dict</span><span class="p">)</span>
        <span class="n">_check_value_in</span><span class="p">(</span><span class="n">amp_level</span><span class="p">,</span> <span class="s2">&quot;amp_level&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;O0&quot;</span><span class="p">,</span> <span class="s2">&quot;O1&quot;</span><span class="p">,</span> <span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="s2">&quot;O3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span> <span class="o">=</span> <span class="n">to_tuple</span><span class="p">(</span><span class="n">loss_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_first</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> \
            <span class="o">=</span> <span class="n">batch_num</span><span class="p">,</span> <span class="n">grad_first</span><span class="p">,</span> <span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">amp_level</span><span class="p">,</span> <span class="n">model_name</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">auto_mixed_precision</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">amp_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amp_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_cell</span> <span class="o">=</span> <span class="n">TrainStepCell</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">grad_first</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_first</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="n">clip_grad</span><span class="p">,</span>
                                        <span class="n">clip_norm</span><span class="o">=</span><span class="n">clip_norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_interval</span> <span class="o">=</span> <span class="n">loss_interval</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">ckpt_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_second</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_iter_print_prefix</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call train_cell with callbacks. See details in __init__.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args (tuple[Tensor]): Input parameters of train cell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union(Tensor, tuple[Tensor]), representation of loss(es) returned by train_cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_second</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_cell</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">loss_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">time_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_time</span><span class="p">()</span>
        <span class="n">ckpt_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_ckpt</span><span class="p">()</span>
        <span class="n">custom_print</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">loss_print</span><span class="p">,</span> <span class="n">time_print</span><span class="p">,</span> <span class="n">ckpt_print</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">custom_print</span><span class="p">:</span>
            <span class="n">print_log</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_print</span><span class="p">]</span> <span class="o">+</span> <span class="n">custom_print</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>

<div class="viewcode-block" id="TrainCellWithCallBack.calc_ckpt_name"><a class="viewcode-back" href="../../../common/sciai.common.TrainCellWithCallBack.html#sciai.common.TrainCellWithCallBack.calc_ckpt_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calc_ckpt_name</span><span class="p">(</span><span class="n">iter_str</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate checkpoint file name.</span>

<span class="sd">        Args:</span>
<span class="sd">            iter_str (Union[str]): Iteration number or epoch number.</span>
<span class="sd">            model_name (str): Model name.</span>
<span class="sd">            postfix (str): Filename postfix, generally can be the auto mixed precision level. Default: &quot;&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, Filename of checkpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;model_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">postfix</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">iter_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">time_str</span><span class="p">()</span><span class="si">}</span><span class="s2">.ckpt&quot;</span></div>

<div class="viewcode-block" id="TrainCellWithCallBack.calc_optim_ckpt_name"><a class="viewcode-back" href="../../../common/sciai.common.TrainCellWithCallBack.html#sciai.common.TrainCellWithCallBack.calc_optim_ckpt_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calc_optim_ckpt_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the latest checkpoint filename. For example, `Optimal_pinns_O2.ckpt`.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (str): Model name.</span>
<span class="sd">            postfix (str): Filename postfix. Default: &quot;&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, Filename of checkpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Optim_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">.ckpt&quot;</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_time_second</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Timestamp in second.</span>

<span class="sd">        Returns:</span>
<span class="sd">            long, Second timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time_second</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_print_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return string representation of loss(es) according to loss_names if loss_interval is set &gt; 0.</span>

<span class="sd">        Args:</span>
<span class="sd">            loss (Union[Tensor, tuple[Tensor]]): Loss(es) returned by train_cell.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, Representation of loss(es).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_first</span><span class="p">:</span>
                    <span class="n">loss_names</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">,</span> <span class="p">[</span><span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">))]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">):</span>
                    <span class="n">loss_names</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;total_loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">),</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss_names</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;loss</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loss</span><span class="p">))],</span> <span class="p">[</span><span class="n">loss_value</span> <span class="k">for</span> <span class="n">loss_value</span> <span class="ow">in</span> <span class="n">loss</span><span class="p">]</span>
                <span class="n">loss_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loss_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">loss_value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">loss_name</span><span class="p">,</span> <span class="n">loss_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loss_names</span><span class="p">,</span> <span class="n">losses</span><span class="p">)]</span>
                <span class="n">loss_print</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loss_tuples</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Number</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">loss_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unsupported loss type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">}</span><span class="s2">, value: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">loss_print</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_print_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print time if time_interval is set &gt; 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, Representation of time interval and time elapsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">this_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_second</span><span class="p">()</span>
            <span class="n">interval</span><span class="p">,</span> <span class="n">total_time</span> <span class="o">=</span> <span class="n">this_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span><span class="p">,</span> <span class="n">this_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">this_time</span>
            <span class="n">time_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;interval: </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">s, total: </span><span class="si">{</span><span class="n">total_time</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="k">return</span> <span class="n">time_print</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_save_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save checkpoint if time_interval is set &gt; 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, Checkpoint saving print string, or exception message when it encounters Exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">save_ckpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">iter_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">save_ckpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_interval</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">iter_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;iter_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">save_ckpt</span><span class="p">:</span>
                <span class="n">ckpt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_ckpt_name</span><span class="p">(</span><span class="n">iter_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp_level</span><span class="p">)</span>
                <span class="n">optim_ckpt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_optim_ckpt_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amp_level</span><span class="p">)</span>
                <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">ckpt_name</span><span class="p">)</span>
                <span class="n">optim_ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span><span class="p">,</span> <span class="n">optim_ckpt_name</span><span class="p">)</span>
                <span class="n">ckpt_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;checkpoint saved at: </span><span class="si">{</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s2">, latest checkpoint re-saved at </span><span class="si">{</span><span class="n">optim_ckpt_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cell</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">)</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cell</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">optim_ckpt_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                    <span class="n">ckpt_print</span> <span class="o">=</span> <span class="s2">&quot;error: failed to save checkpoint due to system error!&quot;</span>
                <span class="k">return</span> <span class="n">ckpt_print</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update step num and iter representation. When batch num is not 1, it clears step counter and increases the</span>
<span class="sd">            epoch counter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># clear step if an epoch is finished</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_iter_print_prefix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_iter_print_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate iteration printing prefix message, and store it in self.iter_print.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;epoch:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, step: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_print</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;step: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="TrainStepCell"><a class="viewcode-back" href="../../../common/sciai.common.TrainStepCell.html#sciai.common.TrainStepCell">[docs]</a><span class="k">class</span> <span class="nc">TrainStepCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cell with gradient descent, similar to nn.TrainOneStepCell, but can accept multi-losses return.</span>

<span class="sd">    Args:</span>
<span class="sd">        network (Cell): The training network. The network supports multi-outputs.</span>
<span class="sd">        optimizer (Union[Cell]): Optimizer for updating the network parameters.</span>
<span class="sd">        grad_first (bool): If True, only the first output of the network would participate in the gradient</span>
<span class="sd">            descent. Otherwise, the sum of all outputs of the network would be taken into account. Default: False.</span>
<span class="sd">        clip_grad (bool): Whether clip grad or not. Default: False.</span>
<span class="sd">        clip_norm (Union[float, int]): The clipping ratio, it should be greater than 0. Only enabled when `clip_grad`</span>
<span class="sd">            is True. Default: 1e-3.</span>

<span class="sd">    Inputs:</span>
<span class="sd">        - **\*inputs** (tuple[Tensor]) - Tuple of input tensors with shape :math:`(N, \ldots)`.</span>

<span class="sd">    Outputs:</span>
<span class="sd">        Union(Tensor, tuple[Tensor]), tensor(s) of the loss value(s), the shape of which is(are) usually :math:`()`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If `network` or `optimizer` is not of correct type.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU`` ``CPU``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">grad_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_norm</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">_batch_check_type</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">),</span>
             <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">),</span>
             <span class="s2">&quot;grad_first&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">grad_first</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
             <span class="s2">&quot;clip_grad&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">clip_grad</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
             <span class="s2">&quot;clip_norm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">clip_norm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">set_grad</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_fist</span> <span class="o">=</span> <span class="n">grad_first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">GradOperation</span><span class="p">(</span><span class="n">get_by_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_sens</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">GradOperation</span><span class="p">(</span><span class="n">get_by_list</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sens_param</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_grad</span> <span class="o">=</span> <span class="n">clip_grad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_norm</span> <span class="o">=</span> <span class="n">clip_norm</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;construct&quot;&quot;&quot;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_fist</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="p">[</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">loss</span><span class="p">]</span>
            <span class="n">sens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_sens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)(</span><span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sens</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_grad</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">clip_by_global_norm</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">clip_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>