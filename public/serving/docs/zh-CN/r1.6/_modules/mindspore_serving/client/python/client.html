<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mindspore_serving.client.python.client &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">安装部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_install.html">安装MindSpore Serving</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_example.html">基于MindSpore Serving部署推理服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_distributed_example.html">基于MindSpore Serving部署分布式推理服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_grpc.html">基于gRPC接口访问MindSpore Serving服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_restful.html">基于RESTful接口访问MindSpore Serving服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_model.html">通过配置模型提供Servable</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../serving_multi_subgraphs.html">实现多子图和有状态模型的服务部署</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../server.html">mindspore_serving.server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../client.html">mindspore_serving.client</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>mindspore_serving.client.python.client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mindspore_serving.client.python.client</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;MindSpore Serving Client&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore_serving.proto.ms_service_pb2</span> <span class="k">as</span> <span class="nn">ms_service_pb2</span>
<span class="kn">import</span> <span class="nn">mindspore_serving.proto.ms_service_pb2_grpc</span> <span class="k">as</span> <span class="nn">ms_service_pb2_grpc</span>


<span class="k">def</span> <span class="nf">_create_tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tensor from numpy data&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">Tensor</span><span class="p">()</span>

    <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dtype_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_BOOL</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT8</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT8</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT16</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT16</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT32</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT32</span><span class="p">,</span>

        <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT64</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT64</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT16</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT32</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT64</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dtype_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UNKNOWN</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown data type &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tensor</span>


<span class="k">def</span> <span class="nf">_create_scalar_tensor</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tensor from scalar data&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">_create_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">tensor</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_bytes_tensor</span><span class="p">(</span><span class="n">bytes_vals</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tensor from bytes data&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">Tensor</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bytes_vals</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">bytes_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes_vals</span><span class="p">,)</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">bytes_vals</span><span class="p">)])</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_BYTES</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">bytes_vals</span><span class="p">:</span>
        <span class="n">tensor</span><span class="o">.</span><span class="n">bytes_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tensor</span>


<span class="k">def</span> <span class="nf">_create_str_tensor</span><span class="p">(</span><span class="n">str_vals</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tensor from str data&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">Tensor</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_vals</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">str_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">str_vals</span><span class="p">,)</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">str_vals</span><span class="p">)])</span>
    <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_STRING</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_vals</span><span class="p">:</span>
        <span class="n">tensor</span><span class="o">.</span><span class="n">bytes_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tensor</span>


<span class="k">def</span> <span class="nf">_create_numpy_from_tensor</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create numpy from protobuf tensor&quot;&quot;&quot;</span>
    <span class="n">dtype_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_BOOL</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT8</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT8</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT32</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT32</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>

        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_INT64</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_UINT64</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT32</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_FLOAT64</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_STRING</span> <span class="ow">or</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_BYTES</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">bytes_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">MS_STRING</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype_map</span><span class="p">[</span><span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_check_str</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">str_val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the input parameters are reasonable str input&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be str, but actually </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">str_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">str_val</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should not be empty str&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_int</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">int_val</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the input parameters are reasonable int input&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">int_val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be int, but actually </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">int_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">int_val</span> <span class="o">&lt;</span> <span class="n">minimum</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">maximum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be in range [</span><span class="si">{</span><span class="n">minimum</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maximum</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be &gt;= </span><span class="si">{</span><span class="n">minimum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maximum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">int_val</span> <span class="o">&gt;</span> <span class="n">maximum</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be in range [</span><span class="si">{</span><span class="n">minimum</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maximum</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">&#39; should be &lt;= </span><span class="si">{</span><span class="n">maximum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SSLConfig"><a class="viewcode-back" href="../../../../client.html#mindspore_serving.client.SSLConfig">[docs]</a><span class="k">class</span> <span class="nc">SSLConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The client&#39;s ssl_config encapsulates grpc&#39;s ssl channel credentials for SSL-enabled connections.</span>

<span class="sd">    Args:</span>
<span class="sd">        certificate (str, optional): File holding the PEM-encoded certificate chain as a byte string to use or None if</span>
<span class="sd">            no certificate chain should be used. Default: None.</span>
<span class="sd">        private_key (str, optional): File holding the PEM-encoded private key as a byte string, or None if no private</span>
<span class="sd">            key should be used. Default: None.</span>
<span class="sd">        custom_ca (str, optional): File holding the PEM-encoded root certificates as a byte string, or None to retrieve</span>
<span class="sd">            them from a default location chosen by gRPC runtime. Default: None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: The type or value of the parameters is invalid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_ca</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">certificate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;certificate&quot;</span><span class="p">,</span> <span class="n">certificate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;private_key&quot;</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">custom_ca</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;custom_ca&quot;</span><span class="p">,</span> <span class="n">custom_ca</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_ca</span> <span class="o">=</span> <span class="n">custom_ca</span></div>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../../../client.html#mindspore_serving.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Client encapsulates the serving gRPC API, which can be used to create requests,</span>
<span class="sd">    access serving, and parse results.</span>

<span class="sd">    Note:</span>
<span class="sd">        The maximum amount of data that the client can send in one request is 512MB, and the maximum amount of data that</span>
<span class="sd">        the server can accept can be configured as 1~512MB, 100MB by default.</span>

<span class="sd">    Args:</span>
<span class="sd">        address (str): Serving address.</span>
<span class="sd">        servable_name (str): The name of servable supplied by Serving.</span>
<span class="sd">        method_name (str): The name of method supplied by servable.</span>
<span class="sd">        version_number (int, optional): The version number of servable, 0 means the maximum version number in all</span>
<span class="sd">            running -versions. Default: 0.</span>
<span class="sd">        ssl_config (mindspore_serving.client.SSLConfig, optional): The server&#39;s ssl_config, if None, disabled ssl.</span>
<span class="sd">            Default: None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: The type or value of the parameters are invalid, or other errors happened.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindspore_serving.client import Client</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; client = Client(&quot;localhost:5500&quot;, &quot;add&quot;, &quot;add_cast&quot;)</span>
<span class="sd">        &gt;&gt;&gt; instances = []</span>
<span class="sd">        &gt;&gt;&gt; x1 = np.ones((2, 2), np.int32)</span>
<span class="sd">        &gt;&gt;&gt; x2 = np.ones((2, 2), np.int32)</span>
<span class="sd">        &gt;&gt;&gt; instances.append({&quot;x1&quot;: x1, &quot;x2&quot;: x2})</span>
<span class="sd">        &gt;&gt;&gt; result = client.infer(instances)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">servable_name</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">version_number</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ssl_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
        <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;servable_name&quot;</span><span class="p">,</span> <span class="n">servable_name</span><span class="p">)</span>
        <span class="n">_check_str</span><span class="p">(</span><span class="s2">&quot;method_name&quot;</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
        <span class="n">_check_int</span><span class="p">(</span><span class="s2">&quot;version_number&quot;</span><span class="p">,</span> <span class="n">version_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servable_name</span> <span class="o">=</span> <span class="n">servable_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="n">method_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">=</span> <span class="n">version_number</span>

        <span class="n">msg_bytes_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 512MB</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;grpc.max_send_message_length&#39;</span><span class="p">,</span> <span class="n">msg_bytes_size</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grpc.max_receive_message_length&#39;</span><span class="p">,</span> <span class="n">msg_bytes_size</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">ssl_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_config</span><span class="p">,</span> <span class="n">SSLConfig</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The type of ssl_config should be type of SSLConfig&quot;</span><span class="p">)</span>
            <span class="n">rc_bytes</span> <span class="o">=</span> <span class="n">pk_bytes</span> <span class="o">=</span> <span class="n">c_bytes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ssl_config</span><span class="o">.</span><span class="n">certificate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ssl_config</span><span class="o">.</span><span class="n">certificate</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">c_fs</span><span class="p">:</span>
                    <span class="n">c_bytes</span> <span class="o">=</span> <span class="n">c_fs</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ssl_config</span><span class="o">.</span><span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ssl_config</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pk_fs</span><span class="p">:</span>
                    <span class="n">pk_bytes</span> <span class="o">=</span> <span class="n">pk_fs</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ssl_config</span><span class="o">.</span><span class="n">custom_ca</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ssl_config</span><span class="o">.</span><span class="n">custom_ca</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rc_fs</span><span class="p">:</span>
                    <span class="n">rc_bytes</span> <span class="o">=</span> <span class="n">rc_fs</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c_bytes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pk_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pk_bytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The certificate and private_key should be passed at the same time&quot;</span><span class="p">)</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ssl_channel_credentials</span><span class="p">(</span><span class="n">root_certificates</span><span class="o">=</span><span class="n">rc_bytes</span><span class="p">,</span>
                                                 <span class="n">private_key</span><span class="o">=</span><span class="n">pk_bytes</span><span class="p">,</span>
                                                 <span class="n">certificate_chain</span><span class="o">=</span><span class="n">c_bytes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">secure_channel</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stub</span> <span class="o">=</span> <span class="n">ms_service_pb2_grpc</span><span class="o">.</span><span class="n">MSServiceStub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

<div class="viewcode-block" id="Client.infer"><a class="viewcode-back" href="../../../../client.html#mindspore_serving.client.Client.infer">[docs]</a>    <span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to create requests, access serving service, and parse and return results.</span>

<span class="sd">        Args:</span>
<span class="sd">            instances (map, tuple of map): Instance or tuple of instances, every instance item is the inputs map.</span>
<span class="sd">                The map key is the input name, and the value is the input value, the type of value can be python int,</span>
<span class="sd">                float, bool, str, bytes, numpy number, or numpy array object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: The type or value of the parameters is invalid, or other errors happened.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindspore_serving.client import Client</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; client = Client(&quot;localhost:5500&quot;, &quot;add&quot;, &quot;add_cast&quot;)</span>
<span class="sd">            &gt;&gt;&gt; instances = []</span>
<span class="sd">            &gt;&gt;&gt; x1 = np.ones((2, 2), np.int32)</span>
<span class="sd">            &gt;&gt;&gt; x2 = np.ones((2, 2), np.int32)</span>
<span class="sd">            &gt;&gt;&gt; instances.append({&quot;x1&quot;: x1, &quot;x2&quot;: x2})</span>
<span class="sd">            &gt;&gt;&gt; result = client.infer(instances)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_request</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stub</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paser_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">status_code</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">status_code</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Grpc Error, </span><span class="si">{</span><span class="n">status_code</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="Client.infer_async"><a class="viewcode-back" href="../../../../client.html#mindspore_serving.client.Client.infer_async">[docs]</a>    <span class="k">def</span> <span class="nf">infer_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to create requests, async access serving.</span>

<span class="sd">        Args:</span>
<span class="sd">            instances (map, tuple of map): Instance or tuple of instances, every instance item is the inputs map.</span>
<span class="sd">                The map key is the input name, and the value is the input value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: The type or value of the parameters is invalid, or other errors happened.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; from mindspore_serving.client import Client</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; client = Client(&quot;localhost:5500&quot;, &quot;add&quot;, &quot;add_cast&quot;)</span>
<span class="sd">            &gt;&gt;&gt; instances = []</span>
<span class="sd">            &gt;&gt;&gt; x1 = np.ones((2, 2), np.int32)</span>
<span class="sd">            &gt;&gt;&gt; x2 = np.ones((2, 2), np.int32)</span>
<span class="sd">            &gt;&gt;&gt; instances.append({&quot;x1&quot;: x1, &quot;x2&quot;: x2})</span>
<span class="sd">            &gt;&gt;&gt; result_future = client.infer_async(instances)</span>
<span class="sd">            &gt;&gt;&gt; result = result_future.result()</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_request</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stub</span><span class="o">.</span><span class="n">Predict</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ClientGrpcAsyncResult</span><span class="p">(</span><span class="n">result_future</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">())</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">status_code</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">status_code</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ClientGrpcAsyncError</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Grpc Error, </span><span class="si">{</span><span class="n">status_code</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span></div>

    <span class="k">def</span> <span class="nf">_create_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to create request spec.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="p">(</span><span class="n">instances</span><span class="p">,)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">PredictRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">servable_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">servable_name</span>
        <span class="n">request</span><span class="o">.</span><span class="n">servable_spec</span><span class="o">.</span><span class="n">method_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span>
        <span class="n">request</span><span class="o">.</span><span class="n">servable_spec</span><span class="o">.</span><span class="n">version_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">request</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_instance</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;instance should be a map&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_instance</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to create gRPC instance.&quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">ms_service_pb2</span><span class="o">.</span><span class="n">Instance</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)):</span>
                <span class="n">_create_tensor</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_create_str_tensor</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">_create_scalar_tensor</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">_create_bytes_tensor</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not support value type &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_paser_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to parse result.&quot;&quot;&quot;</span>
        <span class="n">error_msg_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_msg_len</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">error_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)}</span>
        <span class="n">ret_val</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">instance_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_msg_len</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instance_len</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error msg result size </span><span class="si">{</span><span class="n">error_msg_len</span><span class="si">}</span><span class="s2"> not be 0, 1 or &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;length of instances </span><span class="si">{</span><span class="n">instance_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">instance_len</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_msg_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">instance_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">instance_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_create_numpy_from_tensor</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="n">ret_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_map</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret_val</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">ret_val</span></div>


<span class="k">class</span> <span class="nc">ClientGrpcAsyncResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When Client.infer_async invoke successfully, a ClientGrpcAsyncResult object is returned.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindspore_serving.client import Client</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; client = Client(&quot;localhost:5500&quot;, &quot;add&quot;, &quot;add_cast&quot;)</span>
<span class="sd">        &gt;&gt;&gt; instances = []</span>
<span class="sd">        &gt;&gt;&gt; x1 = np.ones((2, 2), np.int32)</span>
<span class="sd">        &gt;&gt;&gt; x2 = np.ones((2, 2), np.int32)</span>
<span class="sd">        &gt;&gt;&gt; instances.append({&quot;x1&quot;: x1, &quot;x2&quot;: x2})</span>
<span class="sd">        &gt;&gt;&gt; result_future = client.infer_async(instances)</span>
<span class="sd">        &gt;&gt;&gt; result = result_future.result()</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_future</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_future</span> <span class="o">=</span> <span class="n">result_future</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait and get result of inference result, the gRPC message will be parse to tuple of instances result.</span>
<span class="sd">        Every instance result is dict, and value could be numpy array/number, str or bytes according gRPC Tensor</span>
<span class="sd">        data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">_paser_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">ClientGrpcAsyncError</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;When gRPC failed happened when calling Client.infer_async, a ClientGrpcAsyncError object is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_error</span> <span class="o">=</span> <span class="n">result_error</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get gRPC error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_error</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>