

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Natural Language Processing (NLP) Application &mdash; MindSpore 0.2.0-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Customized Debugging Information" href="customized_debugging_information.html" />
    <link rel="prev" title="Computer Vision Applications" href="computer_vision_application.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">Implementing an Image Classification Application</a></li>
</ul>
<p class="caption"><span class="caption-text">Use</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation/data_preparation.html">Data Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/saving_and_loading_model_parameters.html">Saving and Loading Model Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/debugging_in_pynative_mode.html">Debugging in PyNative Mode</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Use</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">Training Process Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_precision.html">Mixed Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_training.html">Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision_application.html">Computer Vision Applications</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Natural Language Processing (NLP) Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation-and-design">Preparation and Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#downloading-the-dataset">Downloading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#determining-evaluation-criteria">Determining Evaluation Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="#determining-the-network-and-process">Determining the Network and Process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#importing-library-files">Importing Library Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-environment-information">Configuring Environment Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preprocessing-the-dataset">Preprocessing the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-network">Defining the Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-optimizer-and-loss-function">Defining the Optimizer and Loss Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#training-and-saving-the-model">Training and Saving the Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validating-the-model">Validating the Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#experiment-result">Experiment Result</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="customized_debugging_information.html">Customized Debugging Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="on_device_inference.html">On-Device Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_security.html">Model Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="community.html">Community</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Natural Language Processing (NLP) Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced_use/nlp_application.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="natural-language-processing-nlp-application">
<h1>Natural Language Processing (NLP) Application<a class="headerlink" href="#natural-language-processing-nlp-application" title="Permalink to this headline">¶</a></h1>
<!-- TOC --><ul class="simple">
<li><p><a class="reference external" href="#natural-language-processing-nlp-application">Natural Language Processing (NLP) Application</a></p>
<ul>
<li><p><a class="reference external" href="#overview">Overview</a></p></li>
<li><p><a class="reference external" href="#preparation-and-design">Preparation and Design</a></p>
<ul>
<li><p><a class="reference external" href="#downloading-the-dataset">Downloading the Dataset</a></p></li>
<li><p><a class="reference external" href="#determining-evaluation-criteria">Determining Evaluation Criteria</a></p></li>
<li><p><a class="reference external" href="#determining-the-network-and-process">Determining the Network and Process</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#implementation">Implementation</a></p>
<ul>
<li><p><a class="reference external" href="#importing-library-files">Importing Library Files</a></p></li>
<li><p><a class="reference external" href="#configuring-environment-information">Configuring Environment Information</a></p></li>
<li><p><a class="reference external" href="#preprocessing-the-dataset">Preprocessing the Dataset</a></p></li>
<li><p><a class="reference external" href="#defining-the-network">Defining the Network</a></p></li>
<li><p><a class="reference external" href="#defining-the-optimizer-and-loss-function">Defining the Optimizer and Loss Function</a></p></li>
<li><p><a class="reference external" href="#training-and-saving-the-model">Training and Saving the Model</a></p></li>
<li><p><a class="reference external" href="#validating-the-model">Validating the Model</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#experiment-result">Experiment Result</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC --><div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Sentiment classification is a subset of text classification in NLP, and is the most basic application of NLP. It is a process of analyzing and inferencing affective states and subjective information, that is, analyzing whether a person’s sentiment is positive or negative.</p>
<blockquote>
<div><p>Generally, sentiments are classified into three categories: positive, negative, and neutral. In most cases, only positive and negative sentiments are used for training regardless of the neutral sentiments. The following dataset is a good example.</p>
</div></blockquote>
<p><a class="reference external" href="http://qwone.com/~jason/20Newsgroups/">20 Newsgroups</a> is a typical reference dataset for traditional text classification. It is a collection of approximately 20,000 news documents partitioned across 20 different newsgroups.
Some of the newsgroups are very closely related to each other (such as comp.sys.ibm.pc.hardware and comp.sys.mac.hardware), while others are highly unrelated (such as misc.forsale and soc.religion.christian).</p>
<p>As far as the network itself is concerned, the network structure of text classification is roughly similar to that of sentiment classification. After mastering how to construct the sentiment classification network, it is easy to construct a similar network which can be used in a text classification task with some parameter adjustments.</p>
<p>In the service context, text classification is to analyze the objective content in the text discussion, but sentiment classification is to find a viewpoint from the text. For example, “Forrest Gump has a clear theme and smooth pacing, which is excellent.” In the text classification, this sentence is classified into a “movie” theme, but in the sentiment classification, this movie review is used to explore whether the sentiment is positive or negative.</p>
<p>Compared with traditional text classification, sentiment classification is simpler and more practical. High-quality datasets can be collected on common shopping websites and movie websites to benefit the business domains. For example, based on the domain context, the system can automatically analyze opinions of specific types of customers on the current product, analyze sentiments by subject and user type, and recommend products based on the analysis result, improving the conversion rate and bringing more business benefits.</p>
<p>In special fields, some non-polar words also fully express a sentimental tendency of a user. For example, when an app is downloaded and used, “the app is stuck” and “the download speed is so slow” express users’ negative sentiments. In the stock market, “bullish” and “bull market” express users’ positive sentiments. Therefore, in essence, we hope that the model can be used to mine special expressions in the vertical field as polarity words for the sentiment classification system.</p>
<p>Vertical polarity word = General polarity word + Domain-specific polarity word</p>
<p>According to the text processing granularity, sentiment analysis can be divided into word, phrase, sentence, paragraph, and chapter levels. A sentiment analysis at paragraph level is used as an example. The input is a paragraph, and the output is information about whether the movie review is positive or negative.</p>
</div>
<div class="section" id="preparation-and-design">
<h2>Preparation and Design<a class="headerlink" href="#preparation-and-design" title="Permalink to this headline">¶</a></h2>
<div class="section" id="downloading-the-dataset">
<h3>Downloading the Dataset<a class="headerlink" href="#downloading-the-dataset" title="Permalink to this headline">¶</a></h3>
<p>The IMDb movie review dataset is used as experimental data.</p>
<blockquote>
<div><p>Dataset download address: <a class="reference external" href="http://ai.stanford.edu/~amaas/data/sentiment/">http://ai.stanford.edu/~amaas/data/sentiment/</a></p>
</div></blockquote>
<p>The following are cases of negative and positive reviews.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Review</th>
<th>Label</th>
</tr>
</thead>
<tbody>
<tr>
<td>"Quitting" may be as much about exiting a pre-ordained identity as about drug withdrawal. As a rural guy coming to Beijing, class and success must have struck this young artist face on as an appeal to separate from his roots and far surpass his peasant parents' acting success. Troubles arise, however, when the new man is too new, when it demands too big a departure from family, history, nature, and personal identity. The ensuing splits, and confusion between the imaginary and the real and the dissonance between the ordinary and the heroic are the stuff of a gut check on the one hand or a complete escape from self on the other.</td>
<td>Negative</td>
</tr>
<tr>
<td>This movie is amazing because the fact that the real people portray themselves and their real life experience and do such a good job it's like they're almost living the past over again. Jia Hongsheng plays himself an actor who quit everything except music and drugs struggling with depression and searching for the meaning of life while being angry at everyone especially the people who care for him most.</td>
<td>Positive</td>
</tr>
</tbody>
</table><p>Download the GloVe file and add the following line at the beginning of the file, which means that a total of 400,000 words are read, and each word is represented by a word vector of 300 latitudes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">400000</span> <span class="mi">300</span>
</pre></div>
</div>
<p>GloVe file download address: <a class="reference external" href="http://nlp.stanford.edu/data/glove.6B.zip">http://nlp.stanford.edu/data/glove.6B.zip</a></p>
</div>
<div class="section" id="determining-evaluation-criteria">
<h3>Determining Evaluation Criteria<a class="headerlink" href="#determining-evaluation-criteria" title="Permalink to this headline">¶</a></h3>
<p>As a typical classification, the evaluation criteria of sentiment classification can be determined by referring to that of the common classification. For example, accuracy, precision, recall, and F_beta scores can be used as references.</p>
<p>Accuracy = Number of accurately classified samples/Total number of samples</p>
<p>Precision = True positives/(True positives + False positives)</p>
<p>Recall = True positives/(True positives + False negatives)</p>
<p>F1 score = (2 x Precision x Recall)/(Precision + Recall)</p>
<p>In the IMDb dataset, the number of positive and negative samples does not vary greatly. Accuracy can be used as the evaluation criterion of the classification system.</p>
</div>
<div class="section" id="determining-the-network-and-process">
<h3>Determining the Network and Process<a class="headerlink" href="#determining-the-network-and-process" title="Permalink to this headline">¶</a></h3>
<p>Currently, MindSpore GPU supports the long short-term memory (LSTM) network for NLP.</p>
<ol class="simple">
<li><p>Load the dataset in use and process data.</p></li>
<li><p>Use the LSTM network training data to generate a model.
Long short-term memory (LSTM) is an artificial recurrent neural network (RNN) architecture used for processing and predicting an important event with a long interval and delay in a time sequence. For details, refer to online documentation.</p></li>
<li><p>After the model is obtained, use the validation dataset to check the accuracy of model.</p></li>
</ol>
<blockquote>
<div><p>The current sample is for the Ascend 910 AI processor. You can find the complete executable sample code at：<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r0.2/tutorials/tutorial_code/lstm">https://gitee.com/mindspore/docs/tree/r0.2/tutorials/tutorial_code/lstm</a></p>
<ul class="simple">
<li><p>main.py: code file, including code for data preprocessing, network definition, and model training.</p></li>
<li><p>config.py: some configurations on the network, including the batch size and number of training epochs.</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="importing-library-files">
<h3>Importing Library Files<a class="headerlink" href="#importing-library-files" title="Permalink to this headline">¶</a></h3>
<p>The following are the required public modules and MindSpore modules and library files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">lstm_cfg</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="c1"># Install gensim with &#39;pip install gensim&#39;</span>
<span class="kn">import</span> <span class="nn">gensim</span>

<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.context</span> <span class="k">as</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">operations</span> <span class="k">as</span> <span class="n">P</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">initializer</span>
<span class="kn">from</span> <span class="nn">mindspore.common.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">mindspore.mindrecord</span> <span class="kn">import</span> <span class="n">FileWriter</span>
<span class="kn">from</span> <span class="nn">mindspore.train</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindspore.nn.metrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>
<span class="kn">from</span> <span class="nn">mindspore.train.serialization</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">LossMonitor</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-environment-information">
<h3>Configuring Environment Information<a class="headerlink" href="#configuring-environment-information" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>The <code class="docutils literal notranslate"><span class="pre">parser</span></code> module is used to transfer necessary information for running, such as storage paths of the dataset and the GloVe file. In this way, the frequently changed configurations can be entered during code running, which is more flexible.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;MindSpore LSTM Example&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--preprocess&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">],</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to perform data preprocessing&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mode&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;implement phase, set to train or test&#39;</span><span class="p">)</span>
<span class="c1"># Download dataset from &#39;http://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz&#39; and extract to &#39;aclimdb_path&#39;</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--aclimdb_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./aclImdb&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the dataset is store&#39;</span><span class="p">)</span>
<span class="c1"># Download GloVe from &#39;http://nlp.stanford.edu/data/glove.6B.zip&#39; and extract to &#39;glove_path&#39;</span>
<span class="c1"># Add a new line &#39;400000 300&#39; at the beginning of &#39;glove.6B.300d.txt&#39; with &#39;40000&#39; for total words and &#39;300&#39; for vector length</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--glove_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./glove&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the GloVe is store&#39;</span><span class="p">)</span>
<span class="c1"># Specify the path to save preprocessed data                </span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--preprocess_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./preprocess&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the pre-process data is store&#39;</span><span class="p">)</span>
<span class="c1"># Specify the path to save the CheckPoint file                    </span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ckpt_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./ckpt&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if mode is test, must provide</span><span class="se">\</span>
<span class="s1">                    path where the trained ckpt file&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Before implementing code, configure necessary information, including the environment information, execution mode, backend information, and hardware information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span>
    <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For details about the API configuration, see the <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="preprocessing-the-dataset">
<h3>Preprocessing the Dataset<a class="headerlink" href="#preprocessing-the-dataset" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Process the text dataset, including encoding, word segmentation, alignment, and processing the original GloVe data to adapt to the network structure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read data from the specified directory</span>
<span class="k">def</span> <span class="nf">read_imdb</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read imdb dataset &quot;&quot;&quot;</span>
    <span class="n">pos_or_neg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pos_or_neg</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
                <span class="n">review</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">review</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">review</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Split records into words with spaces as separators</span>
<span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>

<span class="c1"># Encode words into vectors</span>
<span class="k">def</span> <span class="nf">encode_samples</span><span class="p">(</span><span class="n">tokenized_samples</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; encode word to index &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">tokenized_samples</span><span class="p">:</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">word_to_idx</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Align the number of words in each record to 500 words</span>
<span class="k">def</span> <span class="nf">pad_samples</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; pad all features to the same length &quot;&quot;&quot;</span>
    <span class="n">padded_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxlen</span><span class="p">:</span>
            <span class="n">padded_feature</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[:</span><span class="n">maxlen</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padded_feature</span> <span class="o">=</span> <span class="n">feature</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_feature</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">:</span>
                <span class="n">padded_feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">padded_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">padded_features</span>

<span class="c1"># Crop GloVe raw data into a table which contains about 25,000 word vectors</span>
<span class="k">def</span> <span class="nf">collect_weight</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; collect weight &quot;&quot;&quot;</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">wvmodel</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">KeyedVectors</span><span class="o">.</span><span class="n">load_word2vec_format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="s1">&#39;glove.6B.300d.txt&#39;</span><span class="p">),</span>
                                                            <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">weight_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vocab_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">idx_to_word</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">word</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>
    <span class="n">idx_to_word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">word_to_idx</span><span class="p">[</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">weight_np</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wvmodel</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span>
            <span class="n">idx_to_word</span><span class="p">[</span><span class="n">word_to_idx</span><span class="p">[</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>
    <span class="k">return</span> <span class="n">weight_np</span>

<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; preprocess the train and test data &quot;&quot;&quot;</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="n">train_tokenized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_tokenized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">review</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
        <span class="n">train_tokenized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">review</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">review</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
        <span class="n">test_tokenized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">review</span><span class="p">))</span>

    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">train_tokenized</span><span class="p">))</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vocab_size: &quot;</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>

    <span class="n">word_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>
    <span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">train_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pad_samples</span><span class="p">(</span><span class="n">encode_samples</span><span class="p">(</span><span class="n">train_tokenized</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">test_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pad_samples</span><span class="p">(</span><span class="n">encode_samples</span><span class="p">(</span><span class="n">test_tokenized</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">test_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">weight_np</span> <span class="o">=</span> <span class="n">collect_weight</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">weight_np</span><span class="p">,</span> <span class="n">vocab_size</span>
</pre></div>
</div>
</li>
<li><p>Convert the dataset format to the <code class="docutils literal notranslate"><span class="pre">mindrecord</span></code> format for MindSpore to read.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_imdb_data</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="n">features_data</span><span class="p">):</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="n">features_data</span><span class="p">)):</span>
        <span class="n">data_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                    <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_list</span>

<span class="c1"># Convert the dataset to mindrecord dateset which is supported by MindSpore</span>
<span class="k">def</span> <span class="nf">convert_to_mindrecord</span><span class="p">(</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">proprocess_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; convert imdb dataset to mindrecord &quot;&quot;&quot;</span>
    <span class="n">num_shard</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">weight_np</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
        <span class="n">preprocess</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;weight.txt&#39;</span><span class="p">),</span> <span class="n">weight_np</span><span class="p">)</span>

    <span class="c1"># write mindrecord</span>
    <span class="n">schema_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">},</span>
                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}}</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_train.mindrecord&#39;</span><span class="p">),</span> <span class="n">num_shard</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_imdb_data</span><span class="p">(</span><span class="n">train_labels</span><span class="p">,</span> <span class="n">train_features</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">schema_json</span><span class="p">,</span> <span class="s2">&quot;nlp_schema&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_index</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_test.mindrecord&#39;</span><span class="p">),</span> <span class="n">num_shard</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_imdb_data</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">schema_json</span><span class="p">,</span> <span class="s2">&quot;nlp_schema&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_index</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Data Pre-processing ==============&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">)</span>
<span class="n">convert_to_mindrecord</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">glove_path</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Create a dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">is_train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create dataset for training.&quot;&quot;&quot;</span>
    <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">num_consumer</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_train.mindrecord0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_test.mindrecord0&#39;</span><span class="p">)</span>

    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MindDataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">columns_list</span><span class="p">,</span> <span class="n">num_consumer</span><span class="p">)</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">dtrain</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dtrain</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="defining-the-network">
<h3>Defining the Network<a class="headerlink" href="#defining-the-network" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Initialize network parameters and status.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_lstm_weight</span><span class="p">(</span>
        <span class="n">input_size</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">,</span>
        <span class="n">bidirectional</span><span class="p">,</span>
        <span class="n">has_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize lstm weight.&quot;&quot;&quot;</span>
    <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">weight_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gate_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">hidden_size</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_directions</span><span class="p">):</span>
            <span class="n">input_layer_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="n">num_directions</span>
            <span class="n">weight_size</span> <span class="o">+=</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="n">input_layer_size</span>
            <span class="n">weight_size</span> <span class="o">+=</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="n">hidden_size</span>
            <span class="k">if</span> <span class="n">has_bias</span><span class="p">:</span>
                <span class="n">weight_size</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gate_size</span>

    <span class="n">stdv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="n">w_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="p">(</span><span class="n">weight_size</span><span class="p">,</span>
                                        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
        <span class="n">initializer</span><span class="p">(</span>
            <span class="n">Tensor</span><span class="p">(</span><span class="n">w_np</span><span class="p">),</span> <span class="p">[</span>
                <span class="n">weight_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span>

<span class="c1"># Initialize short-term memory (h) and long-term memory (c) to 0</span>
<span class="k">def</span> <span class="nf">lstm_default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;init default input.&quot;&quot;&quot;</span>
    <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">num_directions</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">num_directions</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span>
</pre></div>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">cell</span></code> method to define the network structure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SentimentNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sentiment network structure.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">vocab_size</span><span class="p">,</span>
                <span class="n">embed_size</span><span class="p">,</span>
                <span class="n">num_hiddens</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="p">,</span>
                <span class="n">bidirectional</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">weight</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SentimentNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Mapp words to vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span>
                                    <span class="n">embed_size</span><span class="p">,</span>
                                    <span class="n">embedding_table</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embedding_table</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Transpose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">embed_size</span><span class="p">,</span>
                            <span class="n">hidden_size</span><span class="o">=</span><span class="n">num_hiddens</span><span class="p">,</span>
                            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
                            <span class="n">has_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span>
                            <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">w_init</span> <span class="o">=</span> <span class="n">init_lstm_weight</span><span class="p">(</span>
            <span class="n">embed_size</span><span class="p">,</span>
            <span class="n">num_hiddens</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="p">,</span>
            <span class="n">bidirectional</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">w_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">lstm_default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concat</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_hiddens</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_hiddens</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># input：(64,500,300)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perm</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
        <span class="c1"># states[i] size(64,200)  -&gt; encoding.size(64,400)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>


<span class="n">embedding_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="s2">&quot;weight.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">SentimentNet</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="n">embedding_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">embed_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span>
                <span class="n">num_hiddens</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                <span class="n">bidirectional</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">embedding_table</span><span class="p">),</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="defining-the-optimizer-and-loss-function">
<h3>Defining the Optimizer and Loss Function<a class="headerlink" href="#defining-the-optimizer-and-loss-function" title="Permalink to this headline">¶</a></h3>
<p>The sample code for defining the optimizer and loss function is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">is_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span>
<span class="n">loss_cb</span> <span class="o">=</span> <span class="n">LossMonitor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="training-and-saving-the-model">
<h3>Training and Saving the Model<a class="headerlink" href="#training-and-saving-the-model" title="Permalink to this headline">¶</a></h3>
<p>Load the corresponding dataset, configure the CheckPoint generation information, and train the model using the <code class="docutils literal notranslate"><span class="pre">model.train</span></code> API.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">()})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Training ==============&quot;</span><span class="p">)</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_checkpoint_steps</span><span class="p">,</span>
                                <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;lstm&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">,</span> <span class="n">loss_cb</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="validating-the-model">
<h3>Validating the Model<a class="headerlink" href="#validating-the-model" title="Permalink to this headline">¶</a></h3>
<p>Load the validation dataset and saved CheckPoint file, perform validation, and view the model quality.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Testing ==============&quot;</span><span class="p">)</span>
<span class="n">ds_eval</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">)</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ds_eval</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Accuracy:</span><span class="si">{}</span><span class="s2"> ==============&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="experiment-result">
<h2>Experiment Result<a class="headerlink" href="#experiment-result" title="Permalink to this headline">¶</a></h2>
<p>After 10 epochs, the accuracy on the training set converges to about 85%, and the accuracy on the test set is about 86%.</p>
<p><strong>Training Execution</strong></p>
<ol>
<li><p>Run the training code and view the running result.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python main.py --preprocess<span class="o">=</span><span class="nb">true</span> --mode<span class="o">=</span>train --ckpt_path<span class="o">=</span>./ckpt
</pre></div>
</div>
<p>As shown in the following output, the loss value decreases gradually with the training process and reaches about 0.249. That is, after 10 epochs of training, the accuracy of the current text analysis result is about 85%.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">==============</span> Starting Data Pre-processing <span class="o">==============</span>
vocab_size:  <span class="nv">252192</span>
<span class="o">==============</span> Starting <span class="nv">Training</span> <span class="o">==============</span>
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:29:02.785.484 <span class="o">[</span>mindspore/train/serialization.py:118<span class="o">]</span> Execute save checkpoint process.
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:29:03.658.733 <span class="o">[</span>mindspore/train/serialization.py:143<span class="o">]</span> Save checkpoint process finish.
epoch: <span class="m">1</span> step: <span class="m">390</span> , loss is <span class="m">0</span>.6926409
...
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:32:18.598.405 <span class="o">[</span>mindspore/train/serialization.py:118<span class="o">]</span> Execute save checkpoint process.
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:32:19.561.926 <span class="o">[</span>mindspore/train/serialization.py:143<span class="o">]</span> Save checkpoint process finish.
epoch: <span class="m">6</span> step: <span class="m">390</span> , loss is <span class="m">0</span>.222701
...
epoch: <span class="m">10</span> step: <span class="m">390</span> , loss is <span class="m">0</span>.22616856
epoch: <span class="m">10</span> step: <span class="m">390</span> , loss is <span class="m">0</span>.24914627
</pre></div>
</div>
</li>
<li><p>Check the saved CheckPoint files.</p>
<p>CheckPoint files (model files) are saved during the training. You can view all saved files in the file path.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ls ckpt/
</pre></div>
</div>
<p>The output is as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>lstm-10_390.ckpt  lstm-1_390.ckpt  lstm-2_390.ckpt  lstm-3_390.ckpt  lstm-4_390.ckpt  lstm-5_390.ckpt  lstm-6_390.ckpt  lstm-7_390.ckpt  lstm-8_390.ckpt  lstm-9_390.ckpt
</pre></div>
</div>
</li>
</ol>
<p><strong>Model Validation</strong></p>
<p>Use the last saved CheckPoint file to load and validate the dataset.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python main.py --mode<span class="o">=</span><span class="nb">test</span> --ckpt_path<span class="o">=</span>./ckpt/lstm-10_390.ckpt
</pre></div>
</div>
<p>As shown in the following output, the sentiment analysis accuracy of the text is about 86%, which is basically satisfactory.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>RegisterOperatorCreator:OperatorCreators <span class="nv">init</span>
<span class="o">==============</span> Starting <span class="nv">Testing</span> <span class="o">==============</span>
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:19.333.605 <span class="o">[</span>mindspore/train/serialization.py:169<span class="o">]</span> Execute load checkpoint process.
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.434.749 <span class="o">[</span>mindspore/train/serialization.py:200<span class="o">]</span> Load checkpoint process finish.
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.467.336 <span class="o">[</span>mindspore/train/serialization.py:233<span class="o">]</span> Execute parameter into net process.
<span class="o">[</span>INFO<span class="o">]</span> ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.467.649 <span class="o">[</span>mindspore/train/serialization.py:268<span class="o">]</span> Load parameter into net process finish.
<span class="o">==============</span> Accuracy:<span class="o">{</span><span class="s1">&#39;acc&#39;</span>: <span class="m">0</span>.8599358974358975<span class="o">}</span> <span class="o">==============</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="customized_debugging_information.html" class="btn btn-neutral float-right" title="Customized Debugging Information" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="computer_vision_application.html" class="btn btn-neutral float-left" title="Computer Vision Applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, MindSpore

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>