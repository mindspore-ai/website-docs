<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training a LeNet Model &mdash; MindSpore Lite r1.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/lite.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/lite.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Downloading MindSpore Lite" href="../use/downloads.html" />
    <link rel="prev" title="Implementing an Image Classification Application" href="quick_start.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore Lite
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Implementing an Image Classification Application</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Training a LeNet Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-preparing">Environment Preparing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dataset">DataSet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-mindspore">Install MindSpore</a></li>
<li class="toctree-l3"><a class="reference internal" href="#converter-and-runtime-tool">Converter and Runtime Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connect-android-device">Connect Android Device</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#train-and-eval">Train and Eval</a></li>
<li class="toctree-l2"><a class="reference internal" href="#details">Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-exporting">Model Exporting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-transferring">Model Transferring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-training">Model Training</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#load-model">Load Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dataset-processing">Dataset Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#execute-training">Execute Training</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Obtain MindSpore Lite</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/downloads.html">Downloading MindSpore Lite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/build.html">Building MindSpore Lite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Inference on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/converter_tool.html">Converting Models for Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/post_training_quantization.html">Optimizing the Model (Quantization After Training)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preprocessing.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/runtime.html">Executing Model Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/tools.html">Other Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training on Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/converter_train.html">Creating MindSpore Lite Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/runtime_train.html">Executing Model Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/tools_train.html">Other Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore Lite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Training a LeNet Model</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/quick_start/train_lenet.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="training-a-lenet-model">
<h1>Training a LeNet Model<a class="headerlink" href="#training-a-lenet-model" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Android</span></code> <code class="docutils literal notranslate"><span class="pre">Whole</span> <span class="pre">Process</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Export</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Converting</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Training</span></code> <code class="docutils literal notranslate"><span class="pre">Beginner</span></code> <code class="docutils literal notranslate"><span class="pre">Intermediate</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code></p>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.1/tutorials/lite/source_en/quick_start/train_lenet.md" target="_blank"><img src="../_static/logo_source.png"></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Here we will demonstrate the code that trains a LeNet model using MindSpore Training-on-Device infrastructure. The code segments that are given below are provided fully in <a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.1/mindspore/lite/examples/train_lenet/">MindSpore gitee</a>.</p>
<p>The completed training procedure is as follows:</p>
<ol class="arabic simple">
<li><p>Constructing your training model based on MindSpore Lite Architecture and Export it into <code class="docutils literal notranslate"><span class="pre">MindIR</span></code> model file.</p></li>
<li><p>Converting <code class="docutils literal notranslate"><span class="pre">MindIR</span></code> model file to the <code class="docutils literal notranslate"><span class="pre">MS</span></code> ToD model file by using MindSpore Lite <code class="docutils literal notranslate"><span class="pre">Converter</span></code> tool.</p></li>
<li><p>Loading <code class="docutils literal notranslate"><span class="pre">MS</span></code> model file and executing model training by calling MindSpore Lite training API.</p></li>
</ol>
<p>Details will be told after environment deployed and model training by running prepared shell scripts.</p>
</section>
<section id="environment-preparing">
<h2>Environment Preparing<a class="headerlink" href="#environment-preparing" title="Permalink to this headline"></a></h2>
<p>All the following operations are under PC, the Ubuntu 18.04 64-bit operating system on x86 platform is recommended.</p>
<section id="dataset">
<h3>DataSet<a class="headerlink" href="#dataset" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> dataset used in this example consists of 10 classes of 28 x 28 pixels grayscale images. It has a training set of 60,000 examples, and a test set of 10,000 examples.</p>
<blockquote>
<div><p>Download the MNIST dataset at <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>. This page provides four download links of dataset files. The first two links are for data training, and the last two links are for data test.</p>
</div></blockquote>
<p>Download the files, decompress them, and store them in the workspace directories <code class="docutils literal notranslate"><span class="pre">/PATH/MNIST_Data/train</span></code> and <code class="docutils literal notranslate"><span class="pre">/PATH/MNIST_Data/test</span></code>.</p>
<p>The directory structure is as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└─MNIST_Data
    ├─test
    │      t10k-images.idx3-ubyte
    │      t10k-labels.idx1-ubyte
    │
    └─train
            train-images.idx3-ubyte
            train-labels.idx1-ubyte
</pre></div>
</div>
</section>
<section id="install-mindspore">
<h3>Install MindSpore<a class="headerlink" href="#install-mindspore" title="Permalink to this headline"></a></h3>
<p>Please referring MindSpore <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.1/install/mindspore_cpu_install_pip_en.md#">installation</a> to install MindSpore CPU environment.</p>
</section>
<section id="converter-and-runtime-tool">
<h3>Converter and Runtime Tool<a class="headerlink" href="#converter-and-runtime-tool" title="Permalink to this headline"></a></h3>
<p>Acquire <code class="docutils literal notranslate"><span class="pre">train-converter-linux-x64</span></code> and <code class="docutils literal notranslate"><span class="pre">train-android-aarch64</span></code> tool-package based on MindSpore Lite architecture, refer to <a class="reference external" href="https://www.mindspore.cn/tutorial/lite/en/r1.1/use/build.html">source building</a> chapter, the command is shown below:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate converter tools and runtime package on x86</span>
bash<span class="w"> </span>build.sh<span class="w"> </span>-I<span class="w"> </span>x86_64<span class="w"> </span>-T<span class="w"> </span>on<span class="w"> </span>-e<span class="w"> </span>cpu<span class="w"> </span>-j8

<span class="c1"># generate runtime package on arm64</span>
bash<span class="w"> </span>build.sh<span class="w"> </span>-I<span class="w"> </span>arm64<span class="w"> </span>-T<span class="w"> </span>on<span class="w"> </span>-e<span class="w"> </span>cpu<span class="w"> </span>-j8
</pre></div>
</div>
<p>You could also directly <a class="reference external" href="https://www.mindspore.cn/tutorial/lite/en/r1.1/use/downloads.html">download MindSpore Lite</a> and store them in the <code class="docutils literal notranslate"><span class="pre">output</span></code> directory related to the MindSpore source code (if no <code class="docutils literal notranslate"><span class="pre">output</span></code> directory exists, please create it).</p>
</section>
<section id="connect-android-device">
<h3>Connect Android Device<a class="headerlink" href="#connect-android-device" title="Permalink to this headline"></a></h3>
<p>Turning on the ‘USB debugging’ mode of your Android device and connect it with your PC by using <code class="docutils literal notranslate"><span class="pre">adb</span></code> debugging tool (run<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">adb</span></code> in Ubuntu OS command line).</p>
</section>
</section>
<section id="train-and-eval">
<h2>Train and Eval<a class="headerlink" href="#train-and-eval" title="Permalink to this headline"></a></h2>
<p>Executing the bash command below under <code class="docutils literal notranslate"><span class="pre">./mindspore/lite/example/train_lenet</span></code> directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>prepare_and_run.sh<span class="w"> </span>-D<span class="w"> </span>/PATH/MNIST_Data<span class="w"> </span>-t<span class="w"> </span>arm64
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/PATH/MNIST_Data</span></code> is the absolute mnist dataset path in your machine, <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">arm64</span></code> represents that we will train and run the model on an Android device.</p>
<p>The model will be trained on your device and print training loss and accuracy value every 100 epochs. The trained model will be saved as ‘lenet_tod.ms’ file. The classification accuracy varies in devices.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Training<span class="w"> </span>on<span class="w"> </span>Device
<span class="m">100</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.853509<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.581739<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.674079
<span class="m">200</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.729228<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.350235<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.753305
<span class="m">300</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.379949<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.284498<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.847957
<span class="m">400</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.773617<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.186403<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.867788
<span class="m">500</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.477829<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.0688716<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.907051
<span class="m">600</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.333066<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.0688716<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.93099
<span class="m">700</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.197988<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.0549653<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.940905
<span class="m">800</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.128299<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.048147<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.946314
<span class="m">900</span>:<span class="w">    </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.43212<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.0427626<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.955729
<span class="m">1000</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.446575<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.033213<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.95643
<span class="m">1100</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.162593<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.025461<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.95643
<span class="m">1200</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.177662<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.0180249<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.95643
<span class="m">1300</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0425688<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00832943<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.95643
<span class="m">1400</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.270186<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00832943<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.963041
<span class="m">1500</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0340949<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00832943<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.963041
<span class="m">1600</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.205415<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00832943<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.969551
<span class="m">1700</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0269625<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00810314<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970152
<span class="m">1800</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.197761<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00680999<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970152
<span class="m">1900</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.19131<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00680999<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970152
<span class="m">2000</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.182704<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00680999<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970453
<span class="m">2100</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.375163<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970453
<span class="m">2200</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.296488<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970453
<span class="m">2300</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0556241<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.970453
<span class="m">2400</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0753383<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.973057
<span class="m">2500</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0732852<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.973057
<span class="m">2600</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.220644<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.973057
<span class="m">2700</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0159947<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00313038<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.973257
<span class="m">2800</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0800904<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00168969<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.973257
<span class="m">2900</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.0210299<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00168969<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.97476
<span class="m">3000</span>:<span class="w">   </span>Loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.256663<span class="w"> </span><span class="o">[</span><span class="nv">min</span><span class="o">=</span><span class="m">0</span>.00168969<span class="o">]</span><span class="w">  </span><span class="nv">max_acc</span><span class="o">=</span><span class="m">0</span>.97476
<span class="nv">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.970553

Load<span class="w"> </span>trained<span class="w"> </span>model<span class="w"> </span>and<span class="w"> </span>evaluate<span class="w"> </span>accuracy
<span class="nv">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.970553
</pre></div>
</div>
<blockquote>
<div><p>If the Android device is not available on your hand, you could also exectute <code class="docutils literal notranslate"><span class="pre">bash</span> <span class="pre">prepare_and_run.sh</span> <span class="pre">-D</span> <span class="pre">/PATH/MNIST_Data</span> <span class="pre">-t</span> <span class="pre">x86</span></code> and run it on the x86 platform.</p>
</div></blockquote>
</section>
<section id="details">
<h2>Details<a class="headerlink" href="#details" title="Permalink to this headline"></a></h2>
<p>The demo project folder structure:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>train_lenet/
<span class="w">  </span>├──<span class="w"> </span>model
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>lenet_export.py
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>prepare_model.sh
<span class="w">  </span>│<span class="w">   </span>└──<span class="w"> </span>train_utils.py
<span class="w">  </span>├──<span class="w"> </span>scripts
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>eval.sh
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>run_eval.sh
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>train.sh
<span class="w">  </span>│<span class="w">   </span>└──<span class="w"> </span>run_train.sh
<span class="w">  </span>│
<span class="w">  </span>├──<span class="w"> </span>src
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>dataset.cc
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>dataset.h
<span class="w">  </span>│<span class="w">   </span>├──<span class="w"> </span>net_runner.cc
<span class="w">  </span>│<span class="w">   </span>└──<span class="w"> </span>net_runner.h
<span class="w">  </span>│
<span class="w">  </span>├──<span class="w"> </span>README.md
<span class="w">  </span>└──<span class="w"> </span>prepare_and_run.sh
</pre></div>
</div>
<section id="model-exporting">
<h3>Model Exporting<a class="headerlink" href="#model-exporting" title="Permalink to this headline"></a></h3>
<p>Whether it is an off-the-shelf prepared model, or a custom written model, the model needs to be exported to a <code class="docutils literal notranslate"><span class="pre">.mindir</span></code> file. Here we use the already-implemented <a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.1/model_zoo/official/cv/lenet">LeNet model</a>.</p>
<p>Import and instantiate a LeNet5 model and set the model to train mode:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">export</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>
<span class="kn">from</span> <span class="nn">lenet</span> <span class="kn">import</span> <span class="n">LeNet5</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">train_utils</span> <span class="kn">import</span> <span class="n">TrainWrap</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./mindspore/model_zoo/official/cv/lenet/src/&#39;</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>
<span class="n">n</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Set MindSpore context and initialize the data and label tensors. In this case we use a MindSpore that was compiled for CPU. We define a batch size of 32 and initialize the tensors according to MNIST data – single channel 32x32 images.</p>
<p>The tensors does not need to be loaded with relevant data, but the shape and type must be correct. Note also, that this export code runs on the server, and in this case uses the CPU device. However, the Training on Device will run according to the <a class="reference external" href="https://www.mindspore.cn/tutorial/lite/en/r1.1/use/runtime_train_cpp.html#creating-contexts">context</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">TrainWrap</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>Wrapping the network with a loss layer and an optimizer and <code class="docutils literal notranslate"><span class="pre">export</span></code> it to a <code class="docutils literal notranslate"><span class="pre">MindIR</span></code> file. <code class="docutils literal notranslate"><span class="pre">TrainWrap</span></code> is provided in the example as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common.parameter</span> <span class="kn">import</span> <span class="n">ParameterTuple</span>

<span class="k">def</span> <span class="nf">TrainWrap</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">loss_fn</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">()</span>
  <span class="n">loss_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">WithLossCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">)</span>
  <span class="n">loss_net</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">weights</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">ParameterTuple</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())</span>
  <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
     <span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">use_locking</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_nesterov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">loss_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
  <span class="n">train_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">loss_net</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, exporting the defined model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">export</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;lenet_tod&quot;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finished exporting&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="model-transferring">
<h3>Model Transferring<a class="headerlink" href="#model-transferring" title="Permalink to this headline"></a></h3>
<p>To run this python code one must have an installed <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.1/README.md#installation">MindSpore environment</a>. In the example below we use a CPU-supported MindSpore environment installed on a docker with image name <code class="docutils literal notranslate"><span class="pre">${DOCKER_IMG}</span></code>. Please refer to <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.1/README.md#docker-image">MindSpore Docker Image Installation instructions</a>.</p>
<blockquote>
<div><p>MindSpore environment allows the developer to run MindSpore python code on server or PC. It differs from MindSpore Lite framework that allows to compile and run code on embedded devices.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="nv">$1</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;============Exporting==========&quot;</span>
docker<span class="w"> </span>run<span class="w"> </span>-w<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>--runtime<span class="o">=</span>nvidia<span class="w"> </span>-v<span class="w"> </span>/home/<span class="nv">$USER</span>:/home/<span class="nv">$USER</span><span class="w"> </span>--privileged<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span><span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;python transfer_learning_export.py; chmod 444 transfer_learning_tod.mindir&quot;</span>
</pre></div>
</div>
<p>If you don’t have docker environment, it will run locally.</p>
<p>To convert the model simply use the converter as explained in the <a class="reference external" href="https://www.mindspore.cn/tutorial/lite/en/r1.1/use/converter_train.html#creating-mindspore-tod-models">Convert Section</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./converter_lite<span class="w"> </span>--fmk<span class="o">=</span>MINDIR<span class="w"> </span>--trainModel<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--modelFile<span class="o">=</span>lenet_tod.mindir<span class="w"> </span>--outputFile<span class="o">=</span>lenet_tod
</pre></div>
</div>
</section>
<section id="model-training">
<h3>Model Training<a class="headerlink" href="#model-training" title="Permalink to this headline"></a></h3>
<p>In the <a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.1/mindspore/lite/examples/train_lenet/src">example c++ code</a> the executable has the following API:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Usage:<span class="w"> </span>net_runner<span class="w"> </span>-f<span class="w"> </span>&lt;.ms<span class="w"> </span>model<span class="w"> </span>file&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;data_dir&gt;<span class="w"> </span><span class="o">[</span>-c<span class="w"> </span>&lt;num<span class="w"> </span>of<span class="w"> </span>training<span class="w"> </span>cycles&gt;<span class="o">]</span>
<span class="w">                 </span><span class="o">[</span>-v<span class="w"> </span><span class="o">(</span>verbose<span class="w"> </span>mode<span class="o">)]</span><span class="w"> </span><span class="o">[</span>-s<span class="w"> </span>&lt;save<span class="w"> </span>checkpoint<span class="w"> </span>every<span class="w"> </span>X<span class="w"> </span>iterations&gt;<span class="o">]</span>
</pre></div>
</div>
<p>After parsing the input parameters the main code continues as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">NetRunner::Main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">InitAndFigureInputs</span><span class="p">();</span>

<span class="w">  </span><span class="n">InitDB</span><span class="p">();</span>

<span class="w">  </span><span class="n">TrainLoop</span><span class="p">();</span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CalculateAccuracy</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;accuracy = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cycles_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">trained_fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ms_file_</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ms_file_</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_trained_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">cycles_</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.ms&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">SaveToFile</span><span class="p">(</span><span class="n">trained_fn</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="load-model">
<h4>Load Model<a class="headerlink" href="#load-model" title="Permalink to this headline"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">InitAndFigureInputs</span></code> creates the TrainSession instance from the <code class="docutils literal notranslate"><span class="pre">.ms</span></code> file, then sets the input tensors indices for the <code class="docutils literal notranslate"><span class="pre">.ms</span></code> model.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">NetRunner::InitAndFigureInputs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mindspore</span><span class="o">::</span><span class="n">lite</span><span class="o">::</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">  </span><span class="n">context</span><span class="p">.</span><span class="n">device_list_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">device_info_</span><span class="p">.</span><span class="n">cpu_device_info_</span><span class="p">.</span><span class="n">cpu_bind_mode_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mindspore</span><span class="o">::</span><span class="n">lite</span><span class="o">::</span><span class="n">NO_BIND</span><span class="p">;</span>
<span class="w">  </span><span class="n">context</span><span class="p">.</span><span class="n">thread_num_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="n">session_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mindspore</span><span class="o">::</span><span class="n">session</span><span class="o">::</span><span class="n">TrainSession</span><span class="o">::</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">ms_file_</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="k">nullptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">session_</span><span class="p">);</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">GetInputs</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_index_</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">label_index_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">batch_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span><span class="p">[</span><span class="n">data_index_</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data_size_</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span><span class="p">[</span><span class="n">data_index_</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">;</span><span class="w">  </span><span class="c1">// in bytes</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">verbose_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;data size: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data_size_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">batch size: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">batch_size_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="dataset-processing">
<h4>Dataset Processing<a class="headerlink" href="#dataset-processing" title="Permalink to this headline"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">InitDB</span></code> initializes the MNIST dataset and loads it into the memory. We will not discuss this code here.
The user may refer to the <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.1/mindspore/lite/examples/train_lenet/src/dataset.cc">code in gitee</a>. In the next release, MindData framework will be integrated into this example.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">NetRunner::InitDB</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_size_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ds_</span><span class="p">.</span><span class="n">set_expected_data_size</span><span class="p">(</span><span class="n">data_size_</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">data_dir_</span><span class="p">,</span><span class="w"> </span><span class="n">DS_MNIST_BINARY</span><span class="p">);</span>
<span class="w">  </span><span class="n">num_of_classes_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_</span><span class="p">.</span><span class="n">num_of_classes</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ds_</span><span class="p">.</span><span class="n">test_data</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No relevant data was found in &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">data_dir_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">ds_</span><span class="p">.</span><span class="n">test_data</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="execute-training">
<h4>Execute Training<a class="headerlink" href="#execute-training" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">TrainLoop</span></code> method is the core of the training procedure. We first display its code then review it.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">NetRunner::TrainLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">Train</span><span class="p">();</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">min_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">max_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cycles_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FillInputData</span><span class="p">(</span><span class="n">ds_</span><span class="p">.</span><span class="n">train_data</span><span class="p">());</span>
<span class="w">    </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">RunGraph</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">verbose_</span><span class="o">?</span><span class="w"> </span><span class="n">after_callback</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetLoss</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">min_loss</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">loss</span><span class="p">)</span><span class="w"> </span><span class="n">min_loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loss</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_checkpoint_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">save_checkpoint_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">cpkt_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ms_file_</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ms_file_</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_trained_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.ms&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">SaveToFile</span><span class="p">(</span><span class="n">cpkt_file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CalculateAccuracy</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_acc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">acc</span><span class="p">)</span><span class="w"> </span><span class="n">max_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc</span><span class="p">;</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;:</span><span class="se">\t</span><span class="s">Loss is &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; [min=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">min_loss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; max_acc=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">max_acc</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Within this section of code the session is switched to train mode using the <code class="docutils literal notranslate"><span class="pre">Train()</span></code> method, then the main loop over all the training cycles takes place. In each cycle, the data is read from the training dataset and loaded into the input tensors. Both data and label are filled in.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">FillInputData</span><span class="p">(</span><span class="n">ds_</span><span class="p">.</span><span class="n">train_data</span><span class="p">());</span>
</pre></div>
</div>
<p>Then, <code class="docutils literal notranslate"><span class="pre">RunGraph</span></code> method is called. A debug callback that prints the input and output tensors is provided if program is launched in verbose mode.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">RunGraph</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">verbose_</span><span class="o">?</span><span class="w"> </span><span class="n">after_callback</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
</pre></div>
</div>
<p>Following the train cycle, the loss is <a class="reference external" href="https://www.mindspore.cn/tutorial/lite/en/r1.1/use/runtime_train_cpp.html#obtaining-output-tensors">extracted from the Output Tensors</a>.
It is advised to periodically save intermediate training results, i.e., checkpoint files. These files might be handy if the application or device crashes during the training process. The checkpoint files are practically <code class="docutils literal notranslate"><span class="pre">.ms</span></code> files that contain the updated weights, and the program may be relaunched with the checkpoint file as the <code class="docutils literal notranslate"><span class="pre">.ms</span></code> model file. Checkpoints are easily saved by calling the <code class="docutils literal notranslate"><span class="pre">SaveToFile</span></code> API, like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">SaveToFile</span><span class="p">(</span><span class="n">cpkt_file</span><span class="p">);</span>
</pre></div>
</div>
<p>To keep track of the model accuracy, the <code class="docutils literal notranslate"><span class="pre">CalculateAccuracy</span></code> method is being called. Within which, the model is switched to <code class="docutils literal notranslate"><span class="pre">Eval</span></code> mode, and the method runs a cycle of test tensors through the trained network to measure the current accuracy rate. Since this method is time consuming it is not advised to run it every train cycle.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="nf">NetRunner::CalculateAccuracy</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">max_tests</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DataLabelTuple</span><span class="o">&gt;</span><span class="w"> </span><span class="n">test_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_</span><span class="p">.</span><span class="n">test_data</span><span class="p">();</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_set</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max_tests</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_tests</span><span class="p">)</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_tests</span><span class="p">;</span>

<span class="w">  </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">Eval</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tests</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FillInputData</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">max_tests</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">));</span>
<span class="w">    </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">RunGraph</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">outputsv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SearchOutputsForSize</span><span class="p">(</span><span class="n">batch_size_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">num_of_classes_</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">outputsv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">scores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">outputsv</span><span class="o">-&gt;</span><span class="n">MutableData</span><span class="p">());</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">batch_size_</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">max_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scores</span><span class="p">[</span><span class="n">num_of_classes_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">];</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_of_classes_</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">num_of_classes_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_score</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">max_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scores</span><span class="p">[</span><span class="n">num_of_classes_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">];</span>
<span class="w">          </span><span class="n">max_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">max_idx</span><span class="p">)</span><span class="w"> </span><span class="n">accuracy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">session_</span><span class="o">-&gt;</span><span class="n">Train</span><span class="p">();</span>
<span class="w">  </span><span class="n">accuracy</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">batch_size_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tests</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">accuracy</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the given example, the program runs a fixed number of train cycles. The user may easily change the termination condition, e.g., run until a certain accuracy is reached, or run only at night time when device is connected to a power source.</p>
<p>Finally, when trainining is completed, the fully trained model needs to be saved. The <code class="docutils literal notranslate"><span class="pre">SaveToFile</span></code> method is used for this purpose.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quick_start.html" class="btn btn-neutral float-left" title="Implementing an Image Classification Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../use/downloads.html" class="btn btn-neutral float-right" title="Downloading MindSpore Lite" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore Lite.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>