<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ResNet-50 Second-Order Optimization Practice &mdash; MindSpore master documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Natural Language Processing" href="nlp.html" />
    <link rel="prev" title="Image Classification Using ResNet-50 Network" href="cv_resnet50.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">Implementing an Image Classification Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">Implementing Simple Linear Function Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">Hands-on Installation and Experience</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basic Use</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">Loading Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">Defining the Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">Saving Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">Loading a Model for Inference and Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">Publishing Models using MindSpore Hub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Process Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">Converting Dataset to MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">Optimizing Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Build Networks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">Custom Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_script.html">Migrating Training Scripts from Third Party Frameworks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">Debugging in PyNative Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">Custom Debugging Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">Training Process Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">Auto Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">Evaluating the Model during Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Performance Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">Enabling Mixed Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">Enabling Graph Kernel Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">Applying Gradient Accumulation Algorithm</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Compression</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">Applying Quantization Aware Training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">Improving Model Security with NAD Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">Protecting User Privacy with Differential Privacy Mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">Testing Model Security Using Fuzz Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="cv.html">Computer Vision</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cv_resnet50.html">Image Classification Using ResNet-50 Network</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">ResNet-50 Second-Order Optimization Practice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparation">Preparation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preparing-the-dataset">Preparing the Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-distributed-environment-variables">Configuring Distributed Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-the-dataset">Loading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-network">Defining the Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-loss-function-and-optimizer-thor">Defining the Loss Function and Optimizer THOR</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-loss-function">Defining the Loss Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-optimizer">Defining the Optimizer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#training-the-network">Training the Network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#saving-the-configured-model">Saving the Configured Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-the-network-training">Configuring the Network Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-script">Running the Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#model-inference">Model Inference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-inference-network">Defining the Inference Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inference">Inference</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">Natural Language Processing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="cv.html">Computer Vision</a> &raquo;</li>
      <li>ResNet-50 Second-Order Optimization Practice</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/advanced_use/cv_resnet50_second_order_optimizer.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="resnet-50-second-order-optimization-practice">
<h1>ResNet-50 Second-Order Optimization Practice<a class="headerlink" href="#resnet-50-second-order-optimization-practice" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Development</span></code> <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">Optimization</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code>
<a href="https://gitee.com/mindspore/docs/blob/r1.0/tutorials/training/source_en/advanced_use/cv_resnet50_second_order_optimizer.md" target="_blank"><img src="../_static/logo_source.png"></a>  </p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Common optimization algorithms are classified into the first-order and the second-order optimization algorithms. Typical first-order optimization algorithms, such as stochastic gradient descent (SGD), support a small amount of computation with high computation speed but a low convergence speed and require a large number of training steps. The second-order optimization algorithms use the second-order derivative of the objective function to accelerate convergence to the optimal value of a model, and require a small quantity of training steps. However, the second-order optimization algorithms have excessively high computation costs, an overall execution time of the second-order optimization algorithms is still slower than that of the first-order optimization algorithms. As a result, the second-order optimization algorithms are not widely used in deep neural network training. The main computation costs of the second-order optimization algorithms lie in the inverse operation of the second-order information matrices such as the Hessian matrix and the <a class="reference external" href="https://arxiv.org/pdf/1808.07172.pdf">Fisher information matrix (FIM)</a>. The time complexity is about $O(n^3)$.</p>
<p>Based on the existing natural gradient algorithm, MindSpore development team uses optimized acceleration methods such as approximation and sharding for the FIM, greatly reducing the computation complexity of the inverse matrix and developing the available second-order optimizer THOR. With eight Ascend 910 AI processors, THOR can complete the training of ResNet-50 v1.5 network and ImageNet dataset within 72 minutes, which is nearly twice the speed of SGD+Momentum.</p>
<p>This tutorial describes how to use the second-order optimizer THOR provided by MindSpore to train the ResNet-50 v1.5 network and ImageNet dataset on Ascend 910 and GPU.</p>
<blockquote>
<div><p>Download address of the complete code example:
<a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.0/model_zoo/official/cv/resnet_thor">https://gitee.com/mindspore/mindspore/tree/r1.0/model_zoo/official/cv/resnet_thor</a></p>
</div></blockquote>
<p>Directory Structure of Code Examples</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>├──<span class="w"> </span>resnet_thor
<span class="w">    </span>├──<span class="w"> </span>README.md
<span class="w">    </span>├──<span class="w"> </span>scripts<span class="w">                     </span>
<span class="w">        </span>├──<span class="w"> </span>run_distribute_train.sh<span class="w">         </span><span class="c1"># launch distributed training for Ascend 910</span>
<span class="w">        </span>└──<span class="w"> </span>run_eval.sh<span class="w">                     </span><span class="c1"># launch inference for Ascend 910</span>
<span class="w">        </span>├──<span class="w"> </span>run_distribute_train_gpu.sh<span class="w">     </span><span class="c1"># launch distributed training for GPU</span>
<span class="w">        </span>└──<span class="w"> </span>run_eval_gpu.sh<span class="w">                 </span><span class="c1"># launch inference for GPU</span>
<span class="w">    </span>├──<span class="w"> </span>src<span class="w">                                  </span>
<span class="w">        </span>├──<span class="w"> </span>crossentropy.py<span class="w">                 </span><span class="c1"># CrossEntropy loss function</span>
<span class="w">        </span>├──<span class="w"> </span>config.py<span class="w">                       </span><span class="c1"># parameter configuration</span>
<span class="w">        </span>├──<span class="w"> </span>dataset_helper.py<span class="w">               </span><span class="c1"># dataset helper for minddata dataset</span>
<span class="w">        </span>├──<span class="w"> </span>grad_reducer_thor.py<span class="w">            </span><span class="c1"># grad reduce for thor</span>
<span class="w">        </span>├──<span class="w"> </span>model_thor.py<span class="w">                   </span><span class="c1"># model for train</span>
<span class="w">        </span>├──<span class="w"> </span>resnet_thor.py<span class="w">                  </span><span class="c1"># resnet50_thor backone</span>
<span class="w">        </span>├──<span class="w"> </span>thor.py<span class="w">                         </span><span class="c1"># thor optimizer</span>
<span class="w">        </span>├──<span class="w"> </span>thor_layer.py<span class="w">                   </span><span class="c1"># thor layer</span>
<span class="w">        </span>└──<span class="w"> </span>dataset.py<span class="w">                      </span><span class="c1"># data preprocessing    </span>
<span class="w">    </span>├──<span class="w"> </span>eval.py<span class="w">                             </span><span class="c1"># infer script</span>
<span class="w">    </span>├──<span class="w"> </span>train.py<span class="w">                            </span><span class="c1"># train script</span>
<span class="w">    </span>├──<span class="w"> </span>export.py<span class="w">                           </span><span class="c1"># export checkpoint file into air file</span>
<span class="w">    </span>└──<span class="w"> </span>mindspore_hub_conf.py<span class="w">               </span><span class="c1"># config file for mindspore hub repository</span>
<span class="w">    </span>
</pre></div>
</div>
<p>The overall execution process is as follows:</p>
<ol class="arabic simple">
<li><p>Prepare the ImageNet dataset and process the required dataset.</p></li>
<li><p>Define the ResNet-50 network.</p></li>
<li><p>Define the loss function and the optimizer THOR.</p></li>
<li><p>Load the dataset and perform training. After the training is complete, check the result and save the model file.</p></li>
<li><p>Load the saved model for inference.</p></li>
</ol>
</section>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline"></a></h2>
<p>Ensure that MindSpore has been correctly installed. If not, install it by referring to <a class="reference external" href="https://www.mindspore.cn/install/en">Install</a>.</p>
<section id="preparing-the-dataset">
<h3>Preparing the Dataset<a class="headerlink" href="#preparing-the-dataset" title="Permalink to this headline"></a></h3>
<p>Download the complete ImageNet2012 dataset, decompress the dataset, and save it to the <code class="docutils literal notranslate"><span class="pre">ImageNet2012/ilsvrc</span></code> and <code class="docutils literal notranslate"><span class="pre">ImageNet2012/ilsvrc_eval</span></code> directories in the local workspace.</p>
<p>The directory structure is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>└─ImageNet2012
    ├─ilsvrc
    │      n03676483
    │      n04067472
    │      n01622779
    │      ......
    └─ilsvrc_eval
    │      n03018349
    │      n02504013
    │      n07871810
    │      ......

</pre></div>
</div>
</section>
<section id="configuring-distributed-environment-variables">
<h3>Configuring Distributed Environment Variables<a class="headerlink" href="#configuring-distributed-environment-variables" title="Permalink to this headline"></a></h3>
<section id="ascend-910">
<h4>Ascend 910<a class="headerlink" href="#ascend-910" title="Permalink to this headline"></a></h4>
<p>For details about how to configure the distributed environment variables of Ascend 910 AI processors, see <a class="reference external" href="https://www.mindspore.cn/tutorial/training/en/r1.0/advanced_use/distributed_training_ascend.html#configuring-distributed-environment-variables">Parallel Distributed Training (Ascend)</a>.</p>
</section>
<section id="gpu">
<h4>GPU<a class="headerlink" href="#gpu" title="Permalink to this headline"></a></h4>
<p>For details about how to configure the distributed environment of GPUs, see <a class="reference external" href="https://www.mindspore.cn/tutorial/training/en/r1.0/advanced_use/distributed_training_gpu.html#configuring-distributed-environment-variables">Parallel Distributed Training (GPU)</a>.</p>
</section>
</section>
</section>
<section id="loading-the-dataset">
<h2>Loading the Dataset<a class="headerlink" href="#loading-the-dataset" title="Permalink to this headline"></a></h2>
<p>During distributed training, load the dataset in parallel mode and process it through the data argumentation API provided by MindSpore. The <code class="docutils literal notranslate"><span class="pre">src/dataset.py</span></code> script in the source code is for loading and processing the dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.common.dtype</span> <span class="k">as</span> <span class="nn">mstype</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.engine</span> <span class="k">as</span> <span class="nn">de</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.vision.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">C2</span>
<span class="kn">from</span> <span class="nn">mindspore.communication.management</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span> <span class="n">get_rank</span><span class="p">,</span> <span class="n">get_group_size</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">do_train</span><span class="p">,</span> <span class="n">repeat_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;Ascend&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span><span class="p">:</span>
        <span class="n">device_num</span><span class="p">,</span> <span class="n">rank_id</span> <span class="o">=</span> <span class="n">_get_rank_info</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">init</span><span class="p">()</span>
        <span class="n">rank_id</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
        <span class="n">device_num</span> <span class="o">=</span> <span class="n">get_group_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">device_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">ImageFolderDatasetV2</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">ImageFolderDatasetV2</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">num_shards</span><span class="o">=</span><span class="n">device_num</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="n">rank_id</span><span class="p">)</span>

    <span class="n">image_size</span> <span class="o">=</span> <span class="mi">224</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.456</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.406</span> <span class="o">*</span> <span class="mi">255</span><span class="p">]</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.224</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.225</span> <span class="o">*</span> <span class="mi">255</span><span class="p">]</span>
    <span class="c1"># define map operations</span>
    <span class="k">if</span> <span class="n">do_train</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">C</span><span class="o">.</span><span class="n">RandomCropDecodeResize</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">ratio</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.333</span><span class="p">)),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">C</span><span class="o">.</span><span class="n">Decode</span><span class="p">(),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">image_size</span><span class="p">),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">),</span>
            <span class="n">C</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C2</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">)</span>

    <span class="c1"># apply batch operations</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># apply dataset repeat operation</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_num</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
<blockquote>
<div><p>MindSpore supports multiple data processing and augmentation operations, which are usually combined. For details, see <a class="reference external" href="https://www.mindspore.cn/tutorial/training/en/r1.0/use/data_preparation.html">Data Processing</a>.</p>
</div></blockquote>
</section>
<section id="defining-the-network">
<h2>Defining the Network<a class="headerlink" href="#defining-the-network" title="Permalink to this headline"></a></h2>
<p>Use the ResNet-50 v1.5 network model as an example. Define the <a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.0/model_zoo/official/cv/resnet/src/resnet.py">ResNet-50 network</a>, and replace the <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code> and <code class="docutils literal notranslate"><span class="pre">Dense</span></code> operators with the operators customized by the second-order optimizer.
The defined network model stores in the <code class="docutils literal notranslate"><span class="pre">src/resnet_thor.py</span></code> script in the source code, and the customized operators <code class="docutils literal notranslate"><span class="pre">Conv2d_thor</span></code> and <code class="docutils literal notranslate"><span class="pre">Dense_thor</span></code> store in the <code class="docutils literal notranslate"><span class="pre">src/thor_layer.py</span></code> script.</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Conv2d_thor</span></code> to replace <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code> in the original network model.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Dense_thor</span></code> to replace <code class="docutils literal notranslate"><span class="pre">Dense</span></code> in the original network model.</p></li>
</ul>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">Conv2d_thor</span></code> and <code class="docutils literal notranslate"><span class="pre">Dense_thor</span></code> operators customized by THOR are used to save the second-order matrix information in model training. The backbone of the newly defined network is the same as that of the original network model.</p>
</div></blockquote>
<p>After the network is built, call the defined ResNet-50 in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">src.resnet_thor</span> <span class="kn">import</span> <span class="n">resnet50</span>
<span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># define the net</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">class_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_num</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="n">damping</span><span class="p">,</span> <span class="n">loss_scale</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">,</span>
                   <span class="n">frequency</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="defining-the-loss-function-and-optimizer-thor">
<h2>Defining the Loss Function and Optimizer THOR<a class="headerlink" href="#defining-the-loss-function-and-optimizer-thor" title="Permalink to this headline"></a></h2>
<section id="defining-the-loss-function">
<h3>Defining the Loss Function<a class="headerlink" href="#defining-the-loss-function" title="Permalink to this headline"></a></h3>
<p>Loss functions supported by MindSpore include <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code>, <code class="docutils literal notranslate"><span class="pre">L1Loss</span></code>, and <code class="docutils literal notranslate"><span class="pre">MSELoss</span></code>. The <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code> loss function is required by THOR.</p>
<p>The implementation procedure of the loss function is in the <code class="docutils literal notranslate"><span class="pre">src/crossentropy.py</span></code> script. A common trick in deep network model training, label smoothing, is used to improve the model tolerance to error label classification by smoothing real labels, thereby improving the model generalization capability.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CrossEntropy</span><span class="p">(</span><span class="n">_Loss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CrossEntropy&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrossEntropy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onehot</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">OneHot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_value</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">smooth_factor</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">off_value</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">smooth_factor</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceMean</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logit</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">one_hot_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onehot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">logit</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_value</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">one_hot_label</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
<p>Call the defined loss function in the <code class="docutils literal notranslate"><span class="pre">__main__</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">src.crossentropy</span> <span class="kn">import</span> <span class="n">CrossEntropy</span>
<span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># define the loss function</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">use_label_smooth</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">label_smooth_factor</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">CrossEntropy</span><span class="p">(</span><span class="n">smooth_factor</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">label_smooth_factor</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_num</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="defining-the-optimizer">
<h3>Defining the Optimizer<a class="headerlink" href="#defining-the-optimizer" title="Permalink to this headline"></a></h3>
<p>The parameter update formula of THOR is as follows:</p>
<p>$$ \theta^{t+1} = \theta^t + \alpha F^{-1}\nabla E$$</p>
<p>The meanings of parameters in the formula are as follows:</p>
<ul class="simple">
<li><p>$\theta$: trainable parameters on the network</p></li>
<li><p>$t$: number of training steps</p></li>
<li><p>$\alpha$: learning rate, which is the parameter update value per step</p></li>
<li><p>$F^{-1}$: FIM obtained from the network computation</p></li>
<li><p>$\nabla E$: the first-order gradient value</p></li>
</ul>
<p>As shown in the parameter update formula, THOR needs to additionally compute an FIM of each layer, and the FIM of each layer is obtained through computation in the customized network model. The FIM can adaptively adjust the parameter update step and direction of each layer, accelerating convergence and reducing parameter optimization complexity.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="k">if</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">device_target</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">src.thor</span> <span class="kn">import</span> <span class="n">THOR</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">src.thor</span> <span class="kn">import</span> <span class="n">THOR_GPU</span> <span class="k">as</span> <span class="n">THOR</span>
<span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># learning rate setting</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">get_model_lr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">lr_init</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">lr_decay</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">lr_end_epoch</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">decay_epochs</span><span class="o">=</span><span class="mi">39</span><span class="p">)</span>
    <span class="c1"># define the optimizer</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">THOR</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span>
               <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;matrix_A&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span>
               <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;matrix_G&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span>
               <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;A_inv_max&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span>
               <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;G_inv_max&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span>
               <span class="n">config</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="training-the-network">
<h2>Training the Network<a class="headerlink" href="#training-the-network" title="Permalink to this headline"></a></h2>
<section id="saving-the-configured-model">
<h3>Saving the Configured Model<a class="headerlink" href="#saving-the-configured-model" title="Permalink to this headline"></a></h3>
<p>MindSpore provides the callback mechanism to execute customized logic during training. The <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code> function provided by the framework is used in this example.
<code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code> can save the network model and parameters for subsequent fine-tuning.
<code class="docutils literal notranslate"><span class="pre">TimeMonitor</span></code> and <code class="docutils literal notranslate"><span class="pre">LossMonitor</span></code> are callback functions provided by MindSpore. They can be used to monitor the single training step time and <code class="docutils literal notranslate"><span class="pre">loss</span></code> value changes during training, respectively.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">TimeMonitor</span><span class="p">,</span> <span class="n">LossMonitor</span>
<span class="o">...</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># define callbacks</span>
    <span class="n">time_cb</span> <span class="o">=</span> <span class="n">TimeMonitor</span><span class="p">(</span><span class="n">data_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>
    <span class="n">loss_cb</span> <span class="o">=</span> <span class="n">LossMonitor</span><span class="p">()</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cb</span><span class="p">,</span> <span class="n">loss_cb</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">:</span>
        <span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint_epochs</span> <span class="o">*</span> <span class="n">step_size</span><span class="p">,</span>
                                     <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
        <span class="n">ckpt_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;resnet&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">ckpt_save_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ckpt_cb</span><span class="p">]</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="configuring-the-network-training">
<h3>Configuring the Network Training<a class="headerlink" href="#configuring-the-network-training" title="Permalink to this headline"></a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">model.train</span></code> API provided by MindSpore to easily train the network. THOR reduces the computation workload and improves the computation speed by reducing the frequency of updating the second-order matrix. Therefore, the Model_Thor class is redefined to inherit the Model class provided by MindSpore. The parameter for controlling the frequency of updating the second-order matrix is added to the Model_Thor class. You can adjust this parameter to optimize the overall performance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">mindspore.train.loss_scale_manager</span> <span class="kn">import</span> <span class="n">FixedLossScaleManager</span>
<span class="kn">from</span> <span class="nn">src.model_thor</span> <span class="kn">import</span> <span class="n">Model_Thor</span> <span class="k">as</span> <span class="n">Model</span>
<span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">loss_scale</span> <span class="o">=</span> <span class="n">FixedLossScaleManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">drop_overflow_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">amp_level</span><span class="o">=</span><span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">,</span>
                      <span class="n">keep_batchnorm_fp32</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;acc&#39;</span><span class="p">},</span> <span class="n">frequency</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;acc&#39;</span><span class="p">},</span>
                      <span class="n">amp_level</span><span class="o">=</span><span class="s2">&quot;O2&quot;</span><span class="p">,</span> <span class="n">keep_batchnorm_fp32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="running-the-script">
<h3>Running the Script<a class="headerlink" href="#running-the-script" title="Permalink to this headline"></a></h3>
<p>After the training script is defined, call the shell script in the <code class="docutils literal notranslate"><span class="pre">scripts</span></code> directory to start the distributed training process.</p>
<section id="id1">
<h4>Ascend 910<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h4>
<p>Currently, MindSpore distributed execution on Ascend uses the single-device single-process running mode. That is, one process runs on a device, and the number of total processes is the same as the number of devices that are being used. For device 0, the corresponding process is executed in the foreground. For other devices, the corresponding processes are executed in the background. Create a directory named <code class="docutils literal notranslate"><span class="pre">train_parallel</span></code>+<code class="docutils literal notranslate"><span class="pre">device_id</span></code> for each process to store log information, operator compilation information, and training checkpoint files. The following takes the distributed training script for eight devices as an example to describe how to run the script:</p>
<p>Run the script.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">run_distribute_train</span><span class="o">.</span><span class="n">sh</span> <span class="p">[</span><span class="n">RANK_TABLE_FILE</span><span class="p">]</span> <span class="p">[</span><span class="n">DATASET_PATH</span><span class="p">]</span> <span class="p">[</span><span class="n">DEVICE_NUM</span><span class="p">]</span>
</pre></div>
</div>
<p>Variables <code class="docutils literal notranslate"><span class="pre">RANK_TABLE_FILE</span></code>, <code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>, and <code class="docutils literal notranslate"><span class="pre">DEVICE_NUM</span></code> need to be transferred to the script. The meanings of variables are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RANK_TABLE_FILE</span></code>: path for storing the networking information file (about the rank table file, you can refer to <a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.0/model_zoo/utils/hccl_tools">HCCL_TOOL</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>: training dataset path</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEVICE_NUM</span></code>: the actual number of running devices.
For details about other environment variables, see configuration items in the installation guide.</p></li>
</ul>
<p>The following is an example of loss values output during training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">4</span>.4182425
epoch:<span class="w"> </span><span class="m">2</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.740064
epoch:<span class="w"> </span><span class="m">3</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">4</span>.0546017
epoch:<span class="w"> </span><span class="m">4</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.7598825
epoch:<span class="w"> </span><span class="m">5</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.3744206
...
epoch:<span class="w"> </span><span class="m">40</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.6907625
epoch:<span class="w"> </span><span class="m">41</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.8217756
epoch:<span class="w"> </span><span class="m">42</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.6453942
...
</pre></div>
</div>
<p>After the training is complete, the checkpoint file generated by each device is stored in the training directory. The following is an example of the checkpoint file generated by <code class="docutils literal notranslate"><span class="pre">device_0</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>└─train_parallel0
<span class="w">    </span>├─resnet-1_5004.ckpt
<span class="w">    </span>├─resnet-2_5004.ckpt
<span class="w">    </span>│<span class="w">      </span>......
<span class="w">    </span>├─resnet-42_5004.ckpt
<span class="w">    </span>│<span class="w">      </span>......
</pre></div>
</div>
<p>In the preceding information,
<code class="docutils literal notranslate"><span class="pre">*.ckpt</span></code> indicates the saved model parameter file. The name of a checkpoint file is in the following format: <em>Network name</em>-<em>Number of epochs</em>_<em>Number of steps</em>.ckpt.</p>
</section>
<section id="id2">
<h4>GPU<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h4>
<p>On the GPU hardware platform, MindSpore uses <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> of OpenMPI to perform distributed training. The process creates a directory named <code class="docutils literal notranslate"><span class="pre">train_parallel</span></code> to store log information and training checkpoint files. The following takes the distributed training script for eight devices as an example to describe how to run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">run_distribute_train_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="p">[</span><span class="n">DATASET_PATH</span><span class="p">]</span> <span class="p">[</span><span class="n">DEVICE_NUM</span><span class="p">]</span>
</pre></div>
</div>
<p>Variables <code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">DEVICE_NUM</span></code> need to be transferred to the script. The meanings of variables are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>: training dataset path</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEVICE_NUM</span></code>: the actual number of running devices</p></li>
</ul>
<p>During GPU-based training, the <code class="docutils literal notranslate"><span class="pre">DEVICE_ID</span></code> environment variable is not required. Therefore, you do not need to call <code class="docutils literal notranslate"><span class="pre">int(os.getenv('DEVICE_ID'))</span></code> in the main training script to obtain the device ID or transfer <code class="docutils literal notranslate"><span class="pre">device_id</span></code> to <code class="docutils literal notranslate"><span class="pre">context</span></code>. You need to set <code class="docutils literal notranslate"><span class="pre">device_target</span></code> to <code class="docutils literal notranslate"><span class="pre">GPU</span></code> and call <code class="docutils literal notranslate"><span class="pre">init()</span></code> to enable the NCCL.</p>
<p>The following is an example of loss values output during training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">4</span>.2546034
epoch:<span class="w"> </span><span class="m">2</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">4</span>.0819564
epoch:<span class="w"> </span><span class="m">3</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.7005644
epoch:<span class="w"> </span><span class="m">4</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.2668946
epoch:<span class="w"> </span><span class="m">5</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">3</span>.023509
...
epoch:<span class="w"> </span><span class="m">36</span><span class="w"> </span>step:<span class="w"> </span><span class="m">5004</span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.645802
...
</pre></div>
</div>
<p>The following is an example of model files saved after training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>└─train_parallel
<span class="w">    </span>├─ckpt_0
<span class="w">        </span>├─resnet-1_5004.ckpt
<span class="w">        </span>├─resnet-2_5004.ckpt
<span class="w">    	</span>│<span class="w">      </span>......
<span class="w">        </span>├─resnet-36_5004.ckpt
<span class="w">        </span>│<span class="w">      </span>......
<span class="w">    </span>......
<span class="w">    </span>├─ckpt_7
<span class="w">        </span>├─resnet-1_5004.ckpt
<span class="w">        </span>├─resnet-2_5004.ckpt
<span class="w">        </span>│<span class="w">      </span>......
<span class="w">        </span>├─resnet-36_5004.ckpt
<span class="w">        </span>│<span class="w">      </span>......
</pre></div>
</div>
</section>
</section>
</section>
<section id="model-inference">
<h2>Model Inference<a class="headerlink" href="#model-inference" title="Permalink to this headline"></a></h2>
<p>Use the checkpoint files saved during training to perform inference and validate the model generalization capability. Load the model file using the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> API, call the <code class="docutils literal notranslate"><span class="pre">eval</span></code> API of the <code class="docutils literal notranslate"><span class="pre">Model</span></code> to predict the input image class, and compare the predicted class with the actual class of the input image to obtain the final prediction accuracy.</p>
<section id="defining-the-inference-network">
<h3>Defining the Inference Network<a class="headerlink" href="#defining-the-inference-network" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> API to load the model file.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">model.eval</span></code> API to read the test dataset for inference.</p></li>
<li><p>Compute the prediction accuracy.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">mindspore.train.serialization</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="c1"># define net</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">resnet</span><span class="p">(</span><span class="n">class_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_num</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add_flags_recursive</span><span class="p">(</span><span class="n">thor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># load checkpoint</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">checkpoint_path</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;damping&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># define model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;top_1_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;top_5_accuracy&#39;</span><span class="p">})</span>
	
    <span class="c1"># eval model</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;ckpt=&quot;</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">checkpoint_path</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inference">
<h3>Inference<a class="headerlink" href="#inference" title="Permalink to this headline"></a></h3>
<p>After the inference network is defined, the shell script in the <code class="docutils literal notranslate"><span class="pre">scripts</span></code> directory is called for inference.</p>
<section id="id3">
<h4>Ascend 910<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h4>
<p>On the Ascend 910 hardware platform, run the following inference command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">run_eval</span><span class="o">.</span><span class="n">sh</span> <span class="p">[</span><span class="n">DATASET_PATH</span><span class="p">]</span> <span class="p">[</span><span class="n">CHECKPOINT_PATH</span><span class="p">]</span>
</pre></div>
</div>
<p>Variables <code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECKPOINT_PATH</span></code> need to be transferred to the script. The meanings of variables are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>: inference dataset path</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CHECKPOINT_PATH</span></code>: path for storing the checkpoint file</p></li>
</ul>
<p>Currently, a single device (device 0 by default) is used for inference. The inference result is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;top_5_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.9295574583866837</span><span class="p">,</span> <span class="s1">&#39;top_1_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.761443661971831</span><span class="p">}</span> <span class="n">ckpt</span><span class="o">=</span><span class="n">train_parallel0</span><span class="o">/</span><span class="n">resnet</span><span class="o">-</span><span class="mf">42_5004.</span><span class="n">ckpt</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">top_5_accuracy</span></code>: For an input image, if the labels whose prediction probability ranks top 5 contain actual labels, the classification is correct.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_1_accuracy</span></code>: For an input image, if the label with the highest prediction probability is the same as the actual label, the classification is correct.</p></li>
</ul>
</section>
<section id="id4">
<h4>GPU<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h4>
<p>On the GPU hardware platform, run the following inference command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">run_eval_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="p">[</span><span class="n">DATASET_PATH</span><span class="p">]</span> <span class="p">[</span><span class="n">CHECKPOINT_PATH</span><span class="p">]</span>
</pre></div>
</div>
<p>Variables <code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECKPOINT_PATH</span></code> need to be transferred to the script. The meanings of variables are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DATASET_PATH</span></code>: inference dataset path</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CHECKPOINT_PATH</span></code>: path for storing the checkpoint file</p></li>
</ul>
<p>The inference result is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;top_5_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.9287972151088348</span><span class="p">,</span> <span class="s1">&#39;top_1_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.7597031049935979</span><span class="p">}</span> <span class="n">ckpt</span><span class="o">=</span><span class="n">train_parallel</span><span class="o">/</span><span class="n">resnet</span><span class="o">-</span><span class="mf">36_5004.</span><span class="n">ckpt</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cv_resnet50.html" class="btn btn-neutral float-left" title="Image Classification Using ResNet-50 Network" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="nlp.html" class="btn btn-neutral float-right" title="Natural Language Processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>