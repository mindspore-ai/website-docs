

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Implementing an Image Classification Application &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/training.css" type="text/css" />
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/training.js"></script>
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Implementing Simple Linear Function Fitting" href="linear_regression.html" />
    <link rel="prev" title="Train with MindSpore" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick Start</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementing an Image Classification Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparations">Preparations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#downloading-the-dataset">Downloading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#importing-python-libraries-and-modules">Importing Python Libraries and Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-the-running-information">Configuring the Running Information</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#processing-data">Processing Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-dataset-and-data-operations">Defining the Dataset and Data Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#viewing-enhanced-data">Viewing Enhanced Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-network">Defining the Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-callback-function-to-collect-the-model-loss-value-and-precision-value">Custom Callback Function to Collect the Model Loss Value and Precision Value</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-loss-function-and-optimizer">Defining the Loss Function and Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-the-network">Training the Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#checking-the-loss-value-of-the-model-with-the-change-of-training-steps">Checking the Loss Value of the Model with the Change of Training Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#validating-the-model">Validating the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inference-and-prediction">Inference and Prediction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="linear_regression.html">Implementing Simple Linear Function Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_video.html">Hands-on Installation and Experience</a></li>
</ul>
<p class="caption"><span class="caption-text">Basic Use</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">Loading Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">Defining the Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">Saving Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">Loading a Model for Inference and Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">Publishing Models using MindSpore Hub</a></li>
</ul>
<p class="caption"><span class="caption-text">Process Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/convert_dataset.html">Converting Dataset to MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/optimize_data_processing.html">Optimizing the Data Processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Build Networks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/custom_loss_function.html">Customizing and Using Loss Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/custom_operator.html">Custom Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/migrate_script.html">Migrating Training Scripts from Third Party Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/apply_deep_probability_programming.html">Deep Probabilistic Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/implement_high_order_differentiation.html">Implementing High-order Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/quantum_neural_network.html">Quantum Neural Network</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/debug_in_pynative_mode.html">Debugging in PyNative Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/dump_in_graph_mode.html">Using Dump in the Graph Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/custom_debugging_info.html">Custom Debugging Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/visualization_tutorials.html">Training Process Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/enable_auto_augmentation.html">Auto Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/evaluate_the_model_during_training.html">Evaluating the Model during Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/incremental_operator_build.html">Incremental Operator Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/distributed_training_tutorials.html">Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/enable_mixed_precision.html">Enabling Mixed Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/enable_graph_kernel_fusion.html">Enabling Graph Kernel Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/apply_gradient_accumulation.html">Applying a Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/enable_cache.html">Application of Single-Node Tensor Cache</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Compression</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/apply_quantization_aware_training.html">Applying Quantization Aware Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/apply_post_training_quantization.html">Applying Post Training Quantization</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Security and Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/improve_model_security_nad.html">Improving Model Security with NAD Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/protect_user_privacy_with_differential_privacy.html">Protecting User Privacy with Differential Privacy Mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/protect_user_privacy_with_suppress_privacy.html">Protecting User Privacy with Suppress Privacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/test_model_security_fuzzing.html">Testing Model Security Using Fuzz Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/test_model_security_membership_inference.html">Using Membership Inference to Test Model Security</a></li>
</ul>
<p class="caption"><span class="caption-text">Application</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/cv.html">Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/nlp.html">Natural Language Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/hpc.html">High Performance Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_use/use_on_the_cloud.html">Using MindSpore on the Cloud</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Implementing an Image Classification Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/quick_start/quick_start.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implementing-an-image-classification-application">
<h1>Implementing an Image Classification Application<a class="headerlink" href="#implementing-an-image-classification-application" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Windows</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">CPU</span></code> <code class="docutils literal notranslate"><span class="pre">Whole</span> <span class="pre">Process</span></code> <code class="docutils literal notranslate"><span class="pre">Beginner</span></code> <code class="docutils literal notranslate"><span class="pre">Intermediate</span></code> <code class="docutils literal notranslate"><span class="pre">Expert</span></code></p>
<!-- TOC -->
<ul class="simple">
<li><p><a class="reference external" href="#implementing-an-image-classification-application">Implementing an Image Classification Application</a></p>
<ul>
<li><p><a class="reference external" href="#overview">Overview</a></p></li>
<li><p><a class="reference external" href="#preparations">Preparations</a></p>
<ul>
<li><p><a class="reference external" href="#downloading-the-dataset">Downloading the Dataset</a></p></li>
<li><p><a class="reference external" href="#importing-python-libraries-and-modules">Importing Python Libraries and Modules</a></p></li>
<li><p><a class="reference external" href="#configuring-the-running-information">Configuring the Running Information</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#processing-data">Processing Data</a></p>
<ul>
<li><p><a class="reference external" href="#defining-the-dataset-and-data-operations">Defining the Dataset and Data Operations</a></p></li>
<li><p><a class="reference external" href="#viewing-enhanced-data">Viewing Enhanced Data</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#defining-the-network">Defining the Network</a></p></li>
<li><p><a class="reference external" href="#custom-callback-function-to-collect-the-model-loss-value-and-precision-value">Custom Callback Function to Collect the Model Loss Value and Precision Value</a></p></li>
<li><p><a class="reference external" href="#defining-the-loss-function-and-optimizer">Defining the Loss Function and Optimizer</a></p></li>
<li><p><a class="reference external" href="#training-the-network">Training the Network</a></p>
<ul>
<li><p><a class="reference external" href="#checking-the-loss-value-of-the-model-with-the-change-of-training-steps">Checking the Loss Value of the Model with the Change of Training Steps</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#validating-the-model">Validating the Model</a></p></li>
<li><p><a class="reference external" href="#inference-and-prediction">Inference and Prediction</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><a href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/training/source_en/quick_start/quick_start.md" target="_blank"><img src="../_static/logo_source.png"></a></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document uses a practice example to demonstrate the basic functions of MindSpore. For common users, it takes 20 to 30 minutes to complete the practice.</p>
<p>During the practice, a simple image classification function is implemented. The overall process is as follows:</p>
<ol class="simple">
<li><p>Process the required dataset. The MNIST dataset is used in this example.</p></li>
<li><p>Define a network. The LeNet network is used in this example.</p></li>
<li><p>The loss value and precision value of the model collected by the custom callback function.</p></li>
<li><p>Define the loss function and optimizer.</p></li>
<li><p>Load the dataset and perform training. After the training is complete, check the result and save the model file.</p></li>
<li><p>Load the saved model for inference.</p></li>
<li><p>Validate the model, load the test dataset and trained model, and validate the result accuracy.</p></li>
</ol>
<p>This is a simple and basic application process. Other advanced and complex applications can be extended based on this basic process.</p>
<blockquote>
<div><p>This document is applicable to CPU, GPU and Ascend environments.</p>
<p>You can find the complete executable sample code at <a class="reference external" href="https://gitee.com/mindspore/docs/tree/r1.2/tutorials/tutorial_code/lenet">https://gitee.com/mindspore/docs/tree/r1.2/tutorials/tutorial_code/lenet</a>.</p>
</div></blockquote>
</div>
<div class="section" id="preparations">
<h2>Preparations<a class="headerlink" href="#preparations" title="Permalink to this headline">¶</a></h2>
<p>Before you start, check whether MindSpore has been correctly installed. If not, install MindSpore on your computer by visiting <a class="reference external" href="https://www.mindspore.cn/install/en">MindSpore installation page</a>.</p>
<p>In addition, you shall have basic mathematical knowledge such as Python coding basics, probability, and matrix.</p>
<p>Start your MindSpore experience now.</p>
<div class="section" id="downloading-the-dataset">
<h3>Downloading the Dataset<a class="headerlink" href="#downloading-the-dataset" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> dataset used in this example consists of 10 classes of 28 x 28 pixels grayscale images. It has a training set of 60,000 examples, and a test set of 10,000 examples.</p>
<blockquote>
<div><p>Download the MNIST dataset at <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</a>. This page provides four download links of dataset files. The first two links are required for data training, and the last two links are required for data test.</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>!mkdir -p ./datasets/MNIST_Data/train ./datasets/MNIST_Data/test
!wget -NP ./datasets/MNIST_Data/train https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/train-labels-idx1-ubyte
!wget -NP ./datasets/MNIST_Data/train https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/train-images-idx3-ubyte
!wget -NP ./datasets/MNIST_Data/test https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/t10k-labels-idx1-ubyte
!wget -NP ./datasets/MNIST_Data/test https://mindspore-website.obs.myhuaweicloud.com/notebook/datasets/mnist/t10k-images-idx3-ubyte
!tree ./datasets/MNIST_Data
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>./datasets/MNIST_Data
├── test
│   ├── t10k-images-idx3-ubyte
│   └── t10k-labels-idx1-ubyte
└── train
    ├── train-images-idx3-ubyte
    └── train-labels-idx1-ubyte

2 directories, 4 files
</pre></div>
</div>
</div>
<div class="section" id="importing-python-libraries-and-modules">
<h3>Importing Python Libraries and Modules<a class="headerlink" href="#importing-python-libraries-and-modules" title="Permalink to this headline">¶</a></h3>
<p>Before start, you need to import Python libraries.</p>
<p>Currently, only the <code class="docutils literal notranslate"><span class="pre">os</span></code> library is required. Other libraries are not described here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<p>For details about MindSpore modules, search on the <a class="reference external" href="https://www.mindspore.cn/doc/api_python/en/r1.2/index.html">MindSpore API Page</a>.</p>
</div>
<div class="section" id="configuring-the-running-information">
<h3>Configuring the Running Information<a class="headerlink" href="#configuring-the-running-information" title="Permalink to this headline">¶</a></h3>
<p>Before compiling code, you need to learn basic information about the hardware and backend required for MindSpore running.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code> to configure the information required for running, such as the running mode, backend information, and hardware information.</p>
<p>Import the <code class="docutils literal notranslate"><span class="pre">context</span></code> module and configure the required information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This example runs in graph mode. You can configure hardware information based on actual requirements. For example, if the code runs on the Ascend AI processor, set <code class="docutils literal notranslate"><span class="pre">--device_target</span></code> to <code class="docutils literal notranslate"><span class="pre">Ascend</span></code>. This rule also applies to the code running on the CPU and GPU. For details about parameters, see the API description for <code class="docutils literal notranslate"><span class="pre">context.set_context</span></code>.</p>
</div>
</div>
<div class="section" id="processing-data">
<h2>Processing Data<a class="headerlink" href="#processing-data" title="Permalink to this headline">¶</a></h2>
<p>Datasets are important for training. A good dataset can effectively improve training accuracy and efficiency. Generally, before loading a dataset, you need to perform some operations on the dataset.</p>
<p>A convolutional neural network such as LeNet is used to train the dataset. During data training, the data format is required. Therefore, you need to check the data in the dataset first. In this way, a targeted data conversion function can be constructed to convert the data in the dataset into a data format that meets the training requirements.</p>
<p>Execute the following code to view the original dataset data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>

<span class="n">train_data_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data/train&quot;</span>
<span class="n">test_data_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data/test&quot;</span>
<span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">train_data_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The type of mnist_ds:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">mnist_ds</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of pictures contained in the mnist_ds：&quot;</span><span class="p">,</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>

<span class="n">dic_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
<span class="n">item</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dic_ds</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The item of mnist_ds:&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensor of image in item:&quot;</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The label of item:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;number:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The type of mnist_ds: &lt;class &#39;mindspore.dataset.engine.datasets.MnistDataset&#39;&gt;
Number of pictures contained in the mnist_ds： 60000
The item of mnist_ds: dict_keys([&#39;image&#39;, &#39;label&#39;])
Tensor of image in item: (28, 28, 1)
The label of item: 8
</pre></div>
</div>
<p><img alt="quick_start_quick_start_11_1" src="../_images/quick_start_quick_start_11_1.png" /></p>
<p>From the above operation, we can see that the training datasets <code class="docutils literal notranslate"><span class="pre">train-images-idx3-ubyte</span></code> and <code class="docutils literal notranslate"><span class="pre">train-labels-idx1-ubyte</span></code> correspond to 60,000 images and 60,000 digital labels. After loading the data, the dictionary data set is converted by <code class="docutils literal notranslate"><span class="pre">create_dict_iterator</span></code>. View one of the data, which is a dictionary with keys <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">label</span></code>. The tensor of <code class="docutils literal notranslate"><span class="pre">image</span></code> (height: 28; width: 28; channel: 1) and <code class="docutils literal notranslate"><span class="pre">label</span></code> are numbers corresponding to the image.</p>
<div class="section" id="defining-the-dataset-and-data-operations">
<h3>Defining the Dataset and Data Operations<a class="headerlink" href="#defining-the-dataset-and-data-operations" title="Permalink to this headline">¶</a></h3>
<p>Define the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function to create a dataset. In this function, define the data augmentation and processing operations to be performed.</p>
<ol class="simple">
<li><p>Define the dataset.</p></li>
<li><p>Define parameters required for data augmentation and processing.</p></li>
<li><p>Generate corresponding data augmentation operations according to the parameters.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">map</span></code> mapping function to apply data operations to the dataset.</p></li>
<li><p>Process the generated dataset.</p></li>
</ol>
<p>After the definition is completed, use <code class="docutils literal notranslate"><span class="pre">create_datasets</span></code> to perform data augmentation on the original data, and extract a <code class="docutils literal notranslate"><span class="pre">batch</span></code> of data to view the changes after data augmentation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset.vision.c_transforms</span> <span class="k">as</span> <span class="nn">CV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.vision</span> <span class="kn">import</span> <span class="n">Inter</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>


<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataset for train or test</span>

<span class="sd">    Args:</span>
<span class="sd">        data_path (str): Data path</span>
<span class="sd">        batch_size (int): The number of data records in each group</span>
<span class="sd">        repeat_size (int): The number of replicated data records</span>
<span class="sd">        num_parallel_workers (int): The number of parallel workers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># define some parameters needed for data enhancement and rough justification</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">rescale_nml</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.3081</span>
    <span class="n">shift_nml</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mf">0.1307</span> <span class="o">/</span> <span class="mf">0.3081</span>

    <span class="c1"># according to the parameters, generate the corresponding data enhancement method</span>
    <span class="n">resize_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">Inter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
    <span class="n">rescale_nml_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale_nml</span><span class="p">,</span> <span class="n">shift_nml</span><span class="p">)</span>
    <span class="n">rescale_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">hwc2chw_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># using map to apply operations to a dataset</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">resize_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_nml_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">hwc2chw_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>

    <span class="c1"># process the generated dataset</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="n">ms_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">train_data_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of groups in the dataset:&#39;</span><span class="p">,</span> <span class="n">ms_dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Number of groups in the dataset: 1875
</pre></div>
</div>
<p>After the data augmentation function is called, the dataset <code class="docutils literal notranslate"><span class="pre">size</span></code> changes from 60000 to 1875, which meets the expectations of the <code class="docutils literal notranslate"><span class="pre">mnist_ds.batch</span></code> operation in data augmentation (<span class="math notranslate nohighlight">\(60000/32=1875\)</span>).</p>
<p>In the preceding augmentation process:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">label</span></code> data enhancement operation in the dataset:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">C.TypeCast</span></code>: Convert the data type to <code class="docutils literal notranslate"><span class="pre">int32</span></code>.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">image</span></code> data enhancement operation in the dataset:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">datasets.MnistDataset</span></code>: Convert the dataset into MindSpore trainable data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.Resize</span></code>: Resize image data pixels to meet the data size requirements of the LeNet network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.Rescale</span></code>: Standardize and normalize image data so that the value of each pixel is in the range (0,1), which can improve training efficiency.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CV.HWC2CHW</span></code>: Transform the image data tensor, the tensor form is changed from <code class="docutils literal notranslate"><span class="pre">height</span> <span class="pre">x</span> <span class="pre">width</span> <span class="pre">x</span> <span class="pre">channel</span></code> (HWC) to <code class="docutils literal notranslate"><span class="pre">channel</span> <span class="pre">x</span> <span class="pre">height</span> <span class="pre">x</span> <span class="pre">width</span></code> (CHW), which is convenient for data training.</p></li>
</ul>
</li>
<li><p>Other enhancement operations:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.shuffle</span></code>: Randomly store data in a memory that can hold 10,000 images for shuffle.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.batch</span></code>: Extract 32 images from the shuffled 10,000 image addresses to form a <code class="docutils literal notranslate"><span class="pre">batch</span></code>, the parameter <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> indicates the number of data contained in each group, and each group is now set to contain 32 data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mnist_ds.repeat</span></code>: The <code class="docutils literal notranslate"><span class="pre">batch</span></code> data is replicated and enhanced. The parameter <code class="docutils literal notranslate"><span class="pre">repeat_size</span></code> indicates the number of replicated datasets.</p></li>
</ul>
</li>
</ul>
<p>Perform the <code class="docutils literal notranslate"><span class="pre">shuffle</span></code> and <code class="docutils literal notranslate"><span class="pre">batch</span></code> operations, and then perform the <code class="docutils literal notranslate"><span class="pre">repeat</span></code> operation to ensure that data is unique during one <code class="docutils literal notranslate"><span class="pre">epoch</span></code>.</p>
<blockquote>
<div><p>MindSpore supports multiple data processing and augmentation operations, which are usually used in combined. For details, see section <a class="reference external" href="https://www.mindspore.cn/tutorial/training/en/r1.2/use/data_preparation.html">Data Processing</a> and <a class="reference external" href="https://www.mindspore.cn/doc/programming_guide/en/r1.2/augmentation.html">Data Augmentation</a> in the MindSpore tutorials.</p>
</div></blockquote>
</div>
<div class="section" id="viewing-enhanced-data">
<h3>Viewing Enhanced Data<a class="headerlink" href="#viewing-enhanced-data" title="Permalink to this headline">¶</a></h3>
<p>Obtain a group of data from the 1875 groups of data and view the data tensor and <code class="docutils literal notranslate"><span class="pre">label</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ms_dataset</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">(</span><span class="n">output_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tensor of image:&#39;</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Tensor of image: (32, 1, 32, 32)
Labels: [9 8 5 5 1 2 3 5 7 0 6 1 0 3 8 1 2 1 5 1 5 2 8 4 4 6 4 5 5 5 7 8]
</pre></div>
</div>
<p>Visualize the tensor data and the value corresponding to <code class="docutils literal notranslate"><span class="pre">label</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;num:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">labels</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="quick_start_quick_start_21_0" src="../_images/quick_start_quick_start_21_0.png" /></p>
<p>Through the above query operation, you can see the transformed images. The dataset is divided into 1875 groups of data. Each group of data contains 32 images. The resolution of each image is 32 x 32. After all the data is prepared, you can proceed to the next step of data training.</p>
</div>
</div>
<div class="section" id="defining-the-network">
<h2>Defining the Network<a class="headerlink" href="#defining-the-network" title="Permalink to this headline">¶</a></h2>
<p>The LeNet network is relatively simple. In addition to the input layer, the LeNet network has seven layers, including two convolutional layers, two down-sample layers (pooling layers), and three full connection layers. Each layer contains different numbers of training parameters, as shown in the following figure:</p>
<p><img alt="LeNet-5" src="../_images/LeNet_5.jpg" /></p>
<blockquote>
<div><p>For details about the LeNet network, visit <a class="reference external" href="http://yann.lecun.com/exdb/lenet/">http://yann.lecun.com/exdb/lenet/</a>.</p>
</div></blockquote>
<p>You can initialize the full connection layers and convolutional layers by <code class="docutils literal notranslate"><span class="pre">Normal</span></code>.</p>
<p>MindSpore supports multiple parameter initialization methods, such as <code class="docutils literal notranslate"><span class="pre">TruncatedNormal</span></code>, <code class="docutils literal notranslate"><span class="pre">Normal</span></code>, and <code class="docutils literal notranslate"><span class="pre">Uniform</span></code>, default value is <code class="docutils literal notranslate"><span class="pre">Normal</span></code>. For details, see the description of the <code class="docutils literal notranslate"><span class="pre">mindspore.common.initializer</span></code> module in the MindSpore API.</p>
<p>To use MindSpore for neural network definition, inherit <code class="docutils literal notranslate"><span class="pre">mindspore.nn.Cell</span></code>. <code class="docutils literal notranslate"><span class="pre">Cell</span></code> is the base class of all neural networks (such as <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code>).</p>
<p>Define each layer of a neural network in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method in advance, and then define the <code class="docutils literal notranslate"><span class="pre">construct</span></code> method to complete the forward construction of the neural network. According to the structure of the LeNet network, define the network layers as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">Normal</span>

<span class="k">class</span> <span class="nc">LeNet5</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lenet network structure.&quot;&quot;&quot;</span>
    <span class="c1"># define the operator required</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeNet5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="n">num_class</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>

    <span class="c1"># use the preceding operators to construct networks</span>
    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;layer conv1:&quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">conv1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;layer fc1:&quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">fc1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>layer conv1: Conv2d&lt;input_channels=1, output_channels=6, kernel_size=(5, 5),stride=(1, 1),  pad_mode=valid, padding=0, dilation=(1, 1), group=1, has_bias=Falseweight_init=normal, bias_init=zeros, format=NCHW&gt;
****************************************
layer fc1: Dense&lt;input_channels=400, output_channels=120, has_bias=True&gt;
</pre></div>
</div>
<p>After the construction is completed, you can use <code class="docutils literal notranslate"><span class="pre">print(LeNet5())</span></code> to print out all the parameters of each layer in the neural network, or use <code class="docutils literal notranslate"><span class="pre">LeNet().{layer</span> <span class="pre">name}</span></code> to print the corresponding parameter information. This example chooses to print the corresponding parameters of the first convolutional layer and the first fully connected layer.</p>
</div>
<div class="section" id="custom-callback-function-to-collect-the-model-loss-value-and-precision-value">
<h2>Custom Callback Function to Collect the Model Loss Value and Precision Value<a class="headerlink" href="#custom-callback-function-to-collect-the-model-loss-value-and-precision-value" title="Permalink to this headline">¶</a></h2>
<p>Customize a data collection callback class <code class="docutils literal notranslate"><span class="pre">StepLossAccInfo</span></code>, it is used to collect two types of information:</p>
<ol class="simple">
<li><p>Information about the relationship between <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">loss</span></code> values during training;</p></li>
<li><p>Information of each 125 training <code class="docutils literal notranslate"><span class="pre">step</span></code> and corresponding model accuracy value <code class="docutils literal notranslate"><span class="pre">accuracy</span></code>.</p></li>
</ol>
<p>This class inherits the <code class="docutils literal notranslate"><span class="pre">Callback</span></code> class. You can customize operations during training. After the training is completed, the data can be drawn into a graph to view the changes in <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">loss</span></code>, as well as the <code class="docutils literal notranslate"><span class="pre">step</span></code> and <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> changes.</p>
<p>The following code will be used as a callback function to be called in the model training function <code class="docutils literal notranslate"><span class="pre">model.train</span></code>. The following visualizes the information collected during the model verification stage.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">Callback</span>

<span class="c1"># custom callback function</span>
<span class="k">class</span> <span class="nc">StepLossAccInfo</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">steps_loss</span><span class="p">,</span> <span class="n">steps_eval</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span> <span class="o">=</span> <span class="n">steps_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span> <span class="o">=</span> <span class="n">steps_eval</span>

    <span class="k">def</span> <span class="nf">step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="n">cb_params</span> <span class="o">=</span> <span class="n">run_context</span><span class="o">.</span><span class="n">original_args</span><span class="p">()</span>
        <span class="n">cur_epoch</span> <span class="o">=</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_epoch_num</span>
        <span class="n">cur_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1875</span> <span class="o">+</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_step_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;loss_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cb_params</span><span class="o">.</span><span class="n">net_outputs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_step</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cur_step</span> <span class="o">%</span> <span class="mi">125</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: computational graph model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eval_dataset</span></code>: validation dataset.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steps_loss</span></code>: Collect the relationship between step and loss value, the data format is <code class="docutils literal notranslate"><span class="pre">{&quot;step&quot;:</span> <span class="pre">[],</span> <span class="pre">&quot;loss_value&quot;:</span> <span class="pre">[]}</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steps_eval</span></code>: Collect information about the model accuracy value <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> corresponding to step, the data format is <code class="docutils literal notranslate"><span class="pre">{&quot;step&quot;:</span> <span class="pre">[],</span> <span class="pre">&quot;acc&quot;:</span> <span class="pre">[]}</span></code>.</p></li>
</ul>
</div>
<div class="section" id="defining-the-loss-function-and-optimizer">
<h2>Defining the Loss Function and Optimizer<a class="headerlink" href="#defining-the-loss-function-and-optimizer" title="Permalink to this headline">¶</a></h2>
<p>Before definition, this section briefly describes concepts of loss function and optimizer.</p>
<ul class="simple">
<li><p>Loss function: It is also called objective function and is used to measure the difference between a predicted value and an actual value. Deep learning reduces the value of the loss function by continuous iteration. Defining a good loss function can effectively improve the model performance.</p></li>
<li><p>Optimizer: It is used to minimize the loss function, improving the model during training.</p></li>
</ul>
<p>After the loss function is defined, the weight-related gradient of the loss function can be obtained. The gradient is used to indicate the weight optimization direction for the optimizer, improving model performance.</p>
<p>Loss functions supported by MindSpore include <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code>, <code class="docutils literal notranslate"><span class="pre">L1Loss</span></code>, <code class="docutils literal notranslate"><span class="pre">MSELoss</span></code>. The loss function <code class="docutils literal notranslate"><span class="pre">SoftmaxCrossEntropyWithLogits</span></code> is used in this example.</p>
<p>The optimizers supported by MindSpore include <code class="docutils literal notranslate"><span class="pre">Adam</span></code>, <code class="docutils literal notranslate"><span class="pre">AdamWeightDecay</span></code>, <code class="docutils literal notranslate"><span class="pre">Momentum</span></code>, etc. The popular <code class="docutils literal notranslate"><span class="pre">Momentum</span></code> optimizer is used here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">SoftmaxCrossEntropyWithLogits</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span>

<span class="c1"># create the network</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>

<span class="c1"># define the optimizer</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="p">)</span>

<span class="c1"># define the loss function</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="training-the-network">
<h2>Training the Network<a class="headerlink" href="#training-the-network" title="Permalink to this headline">¶</a></h2>
<p>After completing the construction of the neural network, you can start network training. The network training can be conveniently performed through the <code class="docutils literal notranslate"><span class="pre">Model.train</span></code> interface provided by MindSpore. The parameters mainly include:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">epoch_size</span></code>: specifies the number of batches of images that need to be traversed by each epoch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ds_train</span></code>: specifies the training dataset.</p></li>
<li><p>MindSpore-provided callback mechanism. The callback function <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> contains <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code>, <code class="docutils literal notranslate"><span class="pre">LossMonitor</span></code>, and <code class="docutils literal notranslate"><span class="pre">Callback</span></code> arguments, where <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code> is used to save network models and parameters for performing fine-tuning.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dataset_sink_mode</span></code>: specifies the dataset sink mode. The default value <code class="docutils literal notranslate"><span class="pre">True</span></code> needs to be  set to <code class="docutils literal notranslate"><span class="pre">False</span></code> because this mode does not support the CPU computing platform.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">LossMonitor</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">Accuracy</span>

<span class="n">epoch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">mnist_path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/MNIST_Data&quot;</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;./models/ckpt/mindspore_quick_start/&quot;</span>

<span class="n">repeat_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="p">)</span>
<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># clean up old run files before in Linux</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -f </span><span class="si">{0}</span><span class="s1">*.ckpt </span><span class="si">{0}</span><span class="s1">*.meta </span><span class="si">{0}</span><span class="s1">*.pb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

<span class="c1"># define the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">net_loss</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">()}</span> <span class="p">)</span>

<span class="c1"># save the network model and parameters for subsequence fine-tuning</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span> <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="c1"># group layers into an object with training and evaluation features</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;checkpoint_lenet&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>

<span class="n">steps_loss</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;loss_value&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">steps_eval</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;acc&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="c1"># collect the steps,loss and accuracy information</span>
<span class="n">step_loss_acc_info</span> <span class="o">=</span> <span class="n">StepLossAccInfo</span><span class="p">(</span><span class="n">model</span> <span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">steps_loss</span><span class="p">,</span> <span class="n">steps_eval</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">,</span> <span class="n">LossMonitor</span><span class="p">(</span><span class="mi">125</span><span class="p">),</span> <span class="n">step_loss_acc_info</span><span class="p">],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>epoch: 1 step: 125, loss is 2.2961428
epoch: 1 step: 250, loss is 2.2972755
epoch: 1 step: 375, loss is 2.2992194
epoch: 1 step: 500, loss is 2.3089285
epoch: 1 step: 625, loss is 2.304193
epoch: 1 step: 750, loss is 2.3023324
epoch: 1 step: 875, loss is 0.69262105
epoch: 1 step: 1000, loss is 0.23356618
epoch: 1 step: 1125, loss is 0.35567114
epoch: 1 step: 1250, loss is 0.2065609
epoch: 1 step: 1375, loss is 0.19551893
epoch: 1 step: 1500, loss is 0.1836512
epoch: 1 step: 1625, loss is 0.028234977
epoch: 1 step: 1750, loss is 0.1124336
epoch: 1 step: 1875, loss is 0.026502304
</pre></div>
</div>
<p>After training, multiple model files will be generated and saved under the pre-set directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>!tree <span class="nv">$model_path</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>./models/ckpt/mindspore_quick_start/
├── checkpoint_lenet-1_1125.ckpt
├── checkpoint_lenet-1_1500.ckpt
├── checkpoint_lenet-1_1875.ckpt
├── checkpoint_lenet-1_375.ckpt
├── checkpoint_lenet-1_750.ckpt
└── checkpoint_lenet-graph.meta

    0 directories, 6 files
</pre></div>
</div>
<p>The meaning of the file name: <code class="docutils literal notranslate"><span class="pre">{Customized</span> <span class="pre">name</span> <span class="pre">configured</span> <span class="pre">in</span> <span class="pre">ModelCheckpoint}-{The</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">epoch}-{The</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">step}</span></code>.</p>
<blockquote>
<div><p>To use free control loop iterations, traversing data sets, etc., you can refer to the “Customizing a Training Cycle” part of the official website programming guide “<a class="reference external" href="https://www.mindspore.cn/doc/programming_guide/en/r1.2/train.html#customizing-a-training-cycle">Training</a>”.</p>
</div></blockquote>
<div class="section" id="checking-the-loss-value-of-the-model-with-the-change-of-training-steps">
<h3>Checking the Loss Value of the Model with the Change of Training Steps<a class="headerlink" href="#checking-the-loss-value-of-the-model-with-the-change-of-training-steps" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
<span class="n">loss_value</span> <span class="o">=</span> <span class="n">steps_loss</span><span class="p">[</span><span class="s2">&quot;loss_value&quot;</span><span class="p">]</span>
<span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">steps</span><span class="p">))</span>
<span class="n">loss_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">loss_value</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">loss_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Steps&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss_value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Change chart of model loss value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="quick_start_quick_start_45_0" src="../_images/quick_start_quick_start_45_0.png" /></p>
<p>Judging from the above, it can be divided into three stages:</p>
<p>Stage 1: When the training starts, the loss value is around 2.2, which indicates that the training performance is not satisfied.</p>
<p>Stage 2: When the training arrives at a certain point, the loss value decreases sharply and the training performance is greatly improved.</p>
<p>Stage 3: After the loss value converges to a small value, it tends to get close to 0. At this point, the training performance is steady and cannot be further improved, leading to the result that the training is terminated.</p>
</div>
</div>
<div class="section" id="validating-the-model">
<h2>Validating the Model<a class="headerlink" href="#validating-the-model" title="Permalink to this headline">¶</a></h2>
<p>After obtaining the model file, validate the model generalization capability.</p>
<p>The process of building a network for verification is as follows:</p>
<ol class="simple">
<li><p>Load the model by reading the parameter <code class="docutils literal notranslate"><span class="pre">param_dict</span></code> in the <code class="docutils literal notranslate"><span class="pre">.ckpt</span></code> file.</p></li>
<li><p>Load the parameter <code class="docutils literal notranslate"><span class="pre">param_dict</span></code> to the neural network, Lenet.</p></li>
<li><p>Load the test dataset.</p></li>
<li><p>Call the function, <code class="docutils literal notranslate"><span class="pre">model.eval</span></code>, to transfer the parameters of the test dataset, <code class="docutils literal notranslate"><span class="pre">ds_eval</span></code>. Compute the accuracy of <code class="docutils literal notranslate"><span class="pre">checkpoint_lenet-{epoch}_1875.ckpt</span></code></p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>

<span class="c1"># testing relate modules</span>
<span class="k">def</span> <span class="nf">test_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mnist_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define the evaluation method.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Testing ==============&quot;</span><span class="p">)</span>
    <span class="c1"># load the saved model for evaluation</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;./models/ckpt/mindspore_quick_start/checkpoint_lenet-1_1875.ckpt&quot;</span><span class="p">)</span>
    <span class="c1"># load parameter to the network</span>
    <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="c1"># load testing dataset</span>
    <span class="n">ds_eval</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mnist_path</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">))</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ds_eval</span><span class="p">,</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Accuracy:</span><span class="si">{}</span><span class="s2"> ==============&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>

<span class="n">test_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mnist_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>============== Starting Testing ==============
============== Accuracy:{&#39;Accuracy&#39;: 0.9697516025641025} ==============
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>：This API is used to load the CheckPoint model parameter file and return a parameter dictionary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_lenet-1_1875.ckpt</span></code>：name of the saved CheckPoint model file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>：This API is used to load parameters to the network.</p></li>
</ul>
<p>When the training step reaches 1875, the accuracy of the model is over 95%, meaning the model performance is good.</p>
<p>We can check the change of the model accuracy as the training step changes.</p>
<p><code class="docutils literal notranslate"><span class="pre">eval_show</span></code> draws the line chart of model accuracy every 25 <code class="docutils literal notranslate"><span class="pre">step</span></code>. In particular, <code class="docutils literal notranslate"><span class="pre">steps_eval</span></code> stores the training step of the model and the corresponding accuracy information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_show</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step number&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Model accuracy&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model accuracy variation chart&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span> <span class="n">steps_eval</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">],</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">eval_show</span><span class="p">(</span><span class="n">steps_eval</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="quick_start_quick_start_52_0" src="../_images/quick_start_quick_start_52_0.png" /></p>
<p>In the figure, it can be seen that the change of the model accuracy can be divided in three stages:</p>
<p>Stage 1: When the training starts, the model accuracy rises slowly.</p>
<p>Stage 2: At a certain point, the model accuracy rises sharply.</p>
<p>Stage 3: The model accuracy nearly comes to 1 without reaching.</p>
<p>During the training process, as the training data increases, it will have a positive correlation with the model accuracy, but as the accuracy reaches a certain level, the training gains will decrease.</p>
</div>
<div class="section" id="inference-and-prediction">
<h2>Inference and Prediction<a class="headerlink" href="#inference-and-prediction" title="Permalink to this headline">¶</a></h2>
<p>Apply the trained model to predict a single image or a set of images. The procedure is as follows:</p>
<ol class="simple">
<li><p>Transform the test data to the data that fits LeNet.</p></li>
<li><p>Extract the <code class="docutils literal notranslate"><span class="pre">image</span></code> data.</p></li>
<li><p>Call the function, <code class="docutils literal notranslate"><span class="pre">model.predict</span></code>, to predict the corresponding digit in each <code class="docutils literal notranslate"><span class="pre">image</span></code>. To be noted, <code class="docutils literal notranslate"><span class="pre">predict</span></code> will returns the probability of predicting 0 to 9 for each <code class="docutils literal notranslate"><span class="pre">image</span></code>.</p></li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">plot_pie</span></code> function to display the probability of predictions. Negative probabilities will be removed and not be displayed.</p></li>
</ol>
<p>Load the dataset to be predicted and call the <code class="docutils literal notranslate"><span class="pre">create_dataset</span></code> function to transform the test dataset into required formats. Select a set of 32 images for inference and prediction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds_test</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">test_data_path</span><span class="p">)</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]))</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">err_num</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;pre:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Row </span><span class="si">{}</span><span class="s2">, column </span><span class="si">{}</span><span class="s2"> is incorrectly identified as </span><span class="si">{}</span><span class="s2">, the correct value should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="mi">8</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">index</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All the figures in this group are predicted correctly!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s2">&quot;&lt;--Predicted figures&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="s2">&quot;&lt;--The right number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Row 1, column 2 is incorrectly identified as 8, the correct value should be 2

Row 3, column 7 is incorrectly identified as 9, the correct value should be 4

[5 8 0 2 7 4 1 7 8 6 6 8 7 9 5 8 7 2 0 4 5 9 9 3 9 1 3 9 7 6 3 4] &lt;--Predicted figures
[5 2 0 2 7 4 1 7 8 6 6 8 7 9 5 8 7 2 0 4 5 9 4 3 9 1 3 9 7 6 3 4] &lt;--The right number
</pre></div>
</div>
<p><img alt="quick_start_quick_start_58_1" src="../_images/quick_start_quick_start_58_1.png" /></p>
<p>Draw a pie chart for probability analysis. In this example, it displays a pie chart for the current <code class="docutils literal notranslate"><span class="pre">batch</span></code> in the first image.</p>
<p><code class="docutils literal notranslate"><span class="pre">prb</span></code> stores the preceding 32 prediction numbers and corresponding output results. The classification result <code class="docutils literal notranslate"><span class="pre">prb[0]</span></code> corresponding to the first image is obtained, and the sigmol formula <span class="math notranslate nohighlight">\(\frac{1}{1+e^{-x}}\)</span> is used to obtain the probability of [0-9] corresponding to the image. The number whose probability value is greater than 0.5 is analyzed in the pie chart.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># define the pie drawing function of probability analysis</span>

<span class="n">prb</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_pie</span><span class="p">(</span><span class="n">prbs</span><span class="p">):</span>
    <span class="n">dict1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># remove the negative number and build the dictionary dict1. The key is the number and the value is the probability value</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dict1</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span> <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%1.1f%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">pctdistance</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image classification&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The probability of corresponding numbers [0-9] in Figure 1:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)),</span> <span class="n">prb</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="n">plot_pie</span><span class="p">(</span><span class="n">prb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The probability of corresponding numbers [0-9] in Figure 1:
[0.16316024637045334, 0.04876983802517727, 0.02261393383191808, 0.9963960715325838, 0.037634749376478496, 0.998856840107891, 0.1612087582052347, 0.08714517716531343, 0.6207903209907534, 0.9653037548477632]
</pre></div>
</div>
<p><img alt="quick_start_quick_start_60_1" src="../_images/quick_start_quick_start_60_1.png" /></p>
<p>That’s the whole experience of the handwritten number classification application.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="linear_regression.html" class="btn btn-neutral float-right" title="Implementing Simple Linear Function Fitting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../index.html" class="btn btn-neutral float-left" title="Train with MindSpore" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>