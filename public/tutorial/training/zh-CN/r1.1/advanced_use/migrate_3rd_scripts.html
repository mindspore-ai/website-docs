

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>迁移第三方框架训练脚本 &mdash; MindSpore r1.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/training.css" type="text/css" />

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/training.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="深度概率编程" href="apply_deep_probability_programming.html" />
    <link rel="prev" title="使用工具迁移第三方框架脚本" href="migrate_3rd_scripts_mindconverter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">实现简单线性函数拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption"><span class="caption-text">基础使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">加载数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">保存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">加载模型用于推理或迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">发布模型</a></li>
</ul>
<p class="caption"><span class="caption-text">处理数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">转换数据集为MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">优化数据处理</a></li>
</ul>
<p class="caption"><span class="caption-text">构建网络</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">自定义算子</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="migrate_script.html">迁移第三方框架训练脚本</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="migrate_3rd_scripts_mindconverter.html">使用工具迁移第三方框架脚本</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">迁移第三方框架训练脚本</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">准备环节</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">算子评估</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">软硬件环境准备</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#e2e">E2E迁移网络</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">训练阶段</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">推理阶段</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">样例参考</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="apply_deep_probability_programming.html">深度概率编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="achieve_high_order_differentiation.html">实现高阶自动微分</a></li>
</ul>
<p class="caption"><span class="caption-text">调试网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">使用可视化组件MindInsight</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">应用自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">训练时验证模型</a></li>
</ul>
<p class="caption"><span class="caption-text">优化训练性能</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">使能自动混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">应用梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_cache.html">应用单节点数据缓存</a></li>
</ul>
<p class="caption"><span class="caption-text">压缩模型</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">应用感知量化训练</a></li>
</ul>
<p class="caption"><span class="caption-text">模型安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">使用NAD算法提升模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">应用差分隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">使用fuzz testing模块测试模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">使用成员推理测试模型安全性</a></li>
</ul>
<p class="caption"><span class="caption-text">应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cv.html">机器视觉</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">高性能计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="migrate_script.html">迁移第三方框架训练脚本</a> &raquo;</li>
        
      <li>迁移第三方框架训练脚本</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced_use/migrate_3rd_scripts.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>迁移第三方框架训练脚本<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">CPU</span></code> <code class="docutils literal notranslate"><span class="pre">全流程</span></code> <code class="docutils literal notranslate"><span class="pre">初级</span></code> <code class="docutils literal notranslate"><span class="pre">中级</span></code> <code class="docutils literal notranslate"><span class="pre">高级</span></code></p>
<!-- TOC --><ul class="simple">
<li><p><a class="reference external" href="#%E8%BF%81%E7%A7%BB%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6%E8%AE%AD%E7%BB%83%E8%84%9A%E6%9C%AC">迁移第三方框架训练脚本</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%A6%82%E8%BF%B0">概述</a></p></li>
<li><p><a class="reference external" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E8%8A%82">准备环节</a></p>
<ul>
<li><p><a class="reference external" href="#%E7%AE%97%E5%AD%90%E8%AF%84%E4%BC%B0">算子评估</a></p></li>
<li><p><a class="reference external" href="#%E8%BD%AF%E7%A1%AC%E4%BB%B6%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">软硬件环境准备</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#e2e%E8%BF%81%E7%A7%BB%E7%BD%91%E7%BB%9C">E2E迁移网络</a></p>
<ul>
<li><p><a class="reference external" href="#%E8%AE%AD%E7%BB%83%E9%98%B6%E6%AE%B5">训练阶段</a></p>
<ul>
<li><p><a class="reference external" href="#%E8%84%9A%E6%9C%AC%E8%BF%81%E7%A7%BB">脚本迁移</a></p></li>
<li><p><a class="reference external" href="#%E7%B2%BE%E5%BA%A6%E8%B0%83%E8%AF%95">精度调试</a></p></li>
<li><p><a class="reference external" href="#%E4%BA%91%E4%B8%8A%E9%9B%86%E6%88%90">云上集成</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E6%8E%A8%E7%90%86%E9%98%B6%E6%AE%B5">推理阶段</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E6%A0%B7%E4%BE%8B%E5%8F%82%E8%80%83">样例参考</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC --><p><a href="https://gitee.com/mindspore/docs/blob/r1.1/tutorials/training/source_zh_cn/advanced_use/migrate_3rd_scripts.md" target="_blank"><img src="../_static/logo_source.png"></a></p>
<div class="section" id="id2">
<h2>概述<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>你可能已经编写过TensorFlow、PyTorch等框架的脚本，本教程介绍如何将已有的TensorFlow、PyTorch等的网络迁移到MindSpore，包括主要步骤和操作建议，帮助你快速进行网络迁移。</p>
</div>
<div class="section" id="id3">
<h2>准备环节<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>在动手改造你的脚本前，请先做好算子评估和软硬件环境准备，确保MindSpore可以支持你希望迁移的网络。</p>
<div class="section" id="id4">
<h3>算子评估<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>分析待迁移的网络中所包含的算子，结合<a class="reference external" href="https://www.mindspore.cn/doc/note/zh-CN/r1.1/operator_list_ms.html">MindSpore算子支持列表</a>，梳理出MindSpore对这些算子的支持程度。</p>
<p>以ResNet-50为例，<a class="reference external" href="https://www.mindspore.cn/doc/api_python/zh-CN/r1.1/mindspore/nn/mindspore.nn.Conv2d.html">Conv</a>和<a class="reference external" href="https://www.mindspore.cn/doc/api_python/zh-CN/r1.1/mindspore/nn/mindspore.nn.BatchNorm2d.html">BatchNorm</a>是其中最主要的两个算子，它们已在MindSpore支持的算子列表中。</p>
<p>如果发现没有对应算子，建议：</p>
<ul class="simple">
<li><p>使用其他算子替换：分析算子实现公式，审视是否可以采用MindSpore现有算子叠加达到预期目标。</p></li>
<li><p>临时替代方案：比如不支持某个Loss，是否可以替换为同类已支持的Loss算子；又比如当前的网络结构，是否可以替换为其他同类主流网络等。</p></li>
</ul>
<p>如果发现支持的算子存在功能不全，建议：</p>
<ul class="simple">
<li><p>非必要功能：可删除。</p></li>
<li><p>必要功能：寻找替代方案。</p></li>
</ul>
<p>如果上述仍不能满足你的要求，你可以在<a class="reference external" href="https://gitee.com/mindspore/mindspore">MindSpore代码仓</a>提出诉求。</p>
</div>
<div class="section" id="id5">
<h3>软硬件环境准备<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>准备好硬件环境，查看与你环境对应平台的<a class="reference external" href="https://www.mindspore.cn/install">安装指南</a>，完成MindSpore的安装。</p>
</div>
</div>
<div class="section" id="e2e">
<h2>E2E迁移网络<a class="headerlink" href="#e2e" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id6">
<h3>训练阶段<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id7">
<h4>脚本迁移<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>MindSpore与TensorFlow、PyTorch在网络结构组织方式上，存在一定差别，迁移前需要对原脚本有较为清晰的了解，明确地知道每一层的shape等信息。</p>
<blockquote>
<div><p>你也可以使用<a class="reference external" href="https://gitee.com/mindspore/mindinsight/tree/r1.1/mindinsight/mindconverter">MindConverter工具</a>实现PyTorch网络定义脚本到MindSpore网络定义脚本的自动转换。</p>
</div></blockquote>
<p>下面，我们以ResNet-50的迁移，并在Ascend 910上训练为例：</p>
<ol>
<li><p>导入MindSpore模块。</p>
<p>根据所需使用的接口，导入相应的MindSpore模块，模块列表详见<a class="reference external" href="https://www.mindspore.cn/doc/api_python/zh-CN/r1.1/index.html">https://www.mindspore.cn/doc/api_python/zh-CN/r1.1/index.html</a>。</p>
</li>
<li><p>加载数据集和预处理。</p>
<p>使用MindSpore构造你需要使用的数据集。目前MindSpore已支持常见数据集，你可以通过原始格式、<code class="docutils literal notranslate"><span class="pre">MindRecord</span></code>、<code class="docutils literal notranslate"><span class="pre">TFRecord</span></code>等多种接口调用，同时还支持数据处理以及数据增强等相关功能，具体用法可参考<a class="reference external" href="https://www.mindspore.cn/tutorial/training/zh-CN/r1.1/use/data_preparation.html">准备数据教程</a>。</p>
<p>本例中加载了Cifar-10数据集，可同时支持单卡和多卡的场景。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">device_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">num_shards</span><span class="o">=</span><span class="n">device_num</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="n">rank_id</span><span class="p">)</span>
</pre></div>
</div>
<p>然后对数据进行了数据增强、数据清洗和批处理等操作。代码详见<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.1/model_zoo/official/cv/resnet/src/dataset.py">https://gitee.com/mindspore/mindspore/blob/r1.1/model_zoo/official/cv/resnet/src/dataset.py</a>。</p>
</li>
<li><p>构建网络。</p>
<p>与TensorFlow相比，MindSpore对于卷积的最大差异在于数据格式。MindSpore整网默认使用<code class="docutils literal notranslate"><span class="pre">NCHW</span></code>的格式，与常见的TensorFlow所使用的<code class="docutils literal notranslate"><span class="pre">NHWC</span></code>不同。</p>
<p>以batch_size=32的ResNet-50网络中第一层卷积为例:</p>
<ul>
<li><p>在TensorFlow中，输入feature的格式为[32, 224, 224, 3]，卷积核大小为[7, 7, 3, 64]。</p></li>
<li><p>在MindSpore中，输入feature的格式为[32, 3, 224, 224]，卷积核大小为[64, 3, 7, 7]。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_conv7x7</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">weight_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_channel</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">_weight_variable</span><span class="p">(</span><span class="n">weight_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">weight_init</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_bn</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                        <span class="n">gamma_init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta_init</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moving_mean_init</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">moving_var_init</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>构造子网。</p>
<p>MindSpore中使用<code class="docutils literal notranslate"><span class="pre">nn.Cell</span></code>来构造一个子网结构。子网内遵循先定义后使用的原则来搭建网络结构。每一个需要使用的算子需先定义在Cell的<code class="docutils literal notranslate"><span class="pre">__init__</span></code>函数内，然后在<code class="docutils literal notranslate"><span class="pre">construct</span></code>函数内将定义好的算子连接起来，最后将子网的输出通过<code class="docutils literal notranslate"><span class="pre">return</span></code>返回。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResidualBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ResNet V1 residual block definition.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_channel (int): Input channel.</span>
<span class="sd">        out_channel (int): Output channel.</span>
<span class="sd">        stride (int): Stride size for the first convolutional layer. Default: 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor, output tensor.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; ResidualBlock(3, 256, stride=2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">in_channel</span><span class="p">,</span>
                <span class="n">out_channel</span><span class="p">,</span>
                <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResidualBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="n">out_channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">_conv1x1</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">_bn</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">_conv3x3</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">_bn</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">_conv1x1</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">_bn_last</span><span class="p">(</span><span class="n">out_channel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">in_channel</span> <span class="o">!=</span> <span class="n">out_channel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_sample_layer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down_sample_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">([</span><span class="n">_conv1x1</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span>
                                                        <span class="n">_bn</span><span class="p">(</span><span class="n">out_channel</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Add</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample_layer</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</li>
<li><p>定义串联结构。</p>
<p>ResNet-50网络中有大量的重复结构，TensorFlow中可以使用for循环调用函数的方式来减少重复代码。MindSpore中，我们定义的每一个Cell对象都是独立的，尤其对于内部存在权重参数的子网，定义的Cell是不能重复使用的，如果出现大量重复串联结构，可以使用循环构造多个Cell实例并通过<code class="docutils literal notranslate"><span class="pre">SequentialCell</span></code>来串联。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_make_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">layer_num</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make stage network of ResNet.</span>

<span class="sd">    Args:</span>
<span class="sd">        block (Cell): Resnet block.</span>
<span class="sd">        layer_num (int): Layer number.</span>
<span class="sd">        in_channel (int): Input channel.</span>
<span class="sd">        out_channel (int): Output channel.</span>
<span class="sd">        stride (int): Stride size for the first convolutional layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SequentialCell, the output layer.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; _make_layer(ResidualBlock, 3, 128, 256, 2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">resnet_block</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resnet_block</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">layer_num</span><span class="p">):</span>
        <span class="n">resnet_block</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">out_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resnet_block</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>构造整网。</p>
<p>将定义好的多个子网连接起来就是整个<a class="reference external" href="https://gitee.com/mindspore/mindspore/blob/r1.1/model_zoo/official/cv/resnet/src/resnet.py">ResNet-50</a>网络的结构了。同样遵循先定义后使用的原则，在<code class="docutils literal notranslate"><span class="pre">__init__</span></code>中定义所有用到的子网，在<code class="docutils literal notranslate"><span class="pre">construct</span></code>中连接子网。</p>
</li>
<li><p>定义损失函数和优化器。</p>
<p>定义好网络后，还需要相应地定义损失函数和优化器。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>构造模型。</p>
<p>类似于TensorFlow的<code class="docutils literal notranslate"><span class="pre">Estimator</span></code>接口，将定义好的网络原型、损失函数、优化器传入MindSpore的<code class="docutils literal notranslate"><span class="pre">Model</span></code>接口，内部会自动将其组合成一个可用于训练的网络。</p>
<p>如果需要在训练中使用Loss Scale，则可以单独定义一个<code class="docutils literal notranslate"><span class="pre">loss_scale_manager</span></code>，一同传入<code class="docutils literal notranslate"><span class="pre">Model</span></code>接口。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss_scale</span> <span class="o">=</span> <span class="n">FixedLossScaleManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">drop_overflow_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>如果希望使用<code class="docutils literal notranslate"><span class="pre">Model</span></code>内置的评估方法，则可以使用<a class="reference external" href="https://www.mindspore.cn/tutorial/training/zh-CN/r1.1/advanced_use/custom_debugging_info.html#mindspore-metrics">metrics</a>属性设置希望使用的评估方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss_scale_manager</span><span class="o">=</span><span class="n">loss_scale</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;acc&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>类似于TensorFlow的<code class="docutils literal notranslate"><span class="pre">estimator.train</span></code>，可以通过调用<code class="docutils literal notranslate"><span class="pre">model.train</span></code>接口来进行训练。CheckPoint和中间结果打印等功能，可通过<code class="docutils literal notranslate"><span class="pre">Callback</span></code>的方式定义到<code class="docutils literal notranslate"><span class="pre">model.train</span></code>接口上。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time_cb</span> <span class="o">=</span> <span class="n">TimeMonitor</span><span class="p">(</span><span class="n">data_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>
<span class="n">loss_cb</span> <span class="o">=</span> <span class="n">LossMonitor</span><span class="p">()</span>
<span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cb</span><span class="p">,</span> <span class="n">loss_cb</span><span class="p">]</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">:</span>
    <span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint_steps</span><span class="p">,</span>
                                    <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
    <span class="n">ckpt_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;resnet&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ckpt_cb</span><span class="p">]</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="id8">
<h4>精度调试<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>精度调优过程建议如下两点：</p>
<ol class="simple">
<li><p>单卡精度验证时，建议先采用小数据集进行训练。验证达标后，多卡精度验证时，再采用全量数据集。这样可以帮助提升调试效率。</p></li>
<li><p>首先删减脚本中的不必要技巧（如优化器中的增强配置、动态Loss Scale等），验证达标后，在此基础上逐个叠加新增功能，待当前新增功能确认正常后，再叠加下一个功能。这样可以帮助快速定位问题。</p></li>
</ol>
</div>
<div class="section" id="id9">
<h4>云上集成<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>请参考<a class="reference external" href="https://www.mindspore.cn/tutorial/training/zh-CN/r1.1/advanced_use/use_on_the_cloud.html">在云上使用MindSpore</a>，将你的脚本运行在ModelArts。</p>
</div>
</div>
<div class="section" id="id10">
<h3>推理阶段<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>在Ascend 910 AI处理器上训练后的模型，支持在不同的硬件平台上执行推理。详细步骤可参考<a class="reference external" href="https://www.mindspore.cn/tutorial/inference/zh-CN/r1.1/multi_platform_inference.html">多平台推理教程</a>。</p>
</div>
</div>
<div class="section" id="id11">
<h2>样例参考<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="https://www.mindspore.cn/doc/programming_guide/zh-CN/r1.1/dataset_loading.html">常用数据集读取样例</a></p></li>
<li><p><a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.1/model_zoo">Model Zoo</a></p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="apply_deep_probability_programming.html" class="btn btn-neutral float-right" title="深度概率编程" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="migrate_3rd_scripts_mindconverter.html" class="btn btn-neutral float-left" title="使用工具迁移第三方框架脚本" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, MindSpore

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>