

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>使用工具迁移第三方框架脚本 &mdash; MindSpore r1.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/training.css" type="text/css" />

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/training.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="迁移第三方框架训练脚本" href="migrate_3rd_scripts.html" />
    <link rel="prev" title="迁移第三方框架训练脚本" href="migrate_script.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">实现简单线性函数拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption"><span class="caption-text">基础使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">加载数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">保存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">加载模型用于推理或迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">发布模型</a></li>
</ul>
<p class="caption"><span class="caption-text">处理数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">转换数据集为MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">优化数据处理</a></li>
</ul>
<p class="caption"><span class="caption-text">构建网络</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">自定义算子</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="migrate_script.html">迁移第三方框架训练脚本</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用工具迁移第三方框架脚本</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">用法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pytorch">PyTorch模型脚本迁移</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tensorflow">TensorFlow模型脚本迁移</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">使用场景</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">使用示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ast">基于AST的脚本转换示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">基于图结构的脚本生成示例</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">注意事项</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="migrate_3rd_scripts.html">迁移第三方框架训练脚本</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="apply_deep_probability_programming.html">深度概率编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="achieve_high_order_differentiation.html">实现高阶自动微分</a></li>
</ul>
<p class="caption"><span class="caption-text">调试网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">使用可视化组件MindInsight</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">应用自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">训练时验证模型</a></li>
</ul>
<p class="caption"><span class="caption-text">优化训练性能</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">使能自动混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">应用梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_cache.html">应用单节点数据缓存</a></li>
</ul>
<p class="caption"><span class="caption-text">压缩模型</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">应用感知量化训练</a></li>
</ul>
<p class="caption"><span class="caption-text">模型安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">使用NAD算法提升模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">应用差分隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">使用fuzz testing模块测试模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">使用成员推理测试模型安全性</a></li>
</ul>
<p class="caption"><span class="caption-text">应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cv.html">机器视觉</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">高性能计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="migrate_script.html">迁移第三方框架训练脚本</a> &raquo;</li>
        
      <li>使用工具迁移第三方框架脚本</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced_use/migrate_3rd_scripts_mindconverter.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>使用工具迁移第三方框架脚本<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">模型开发</span></code> <code class="docutils literal notranslate"><span class="pre">初级</span></code></p>
<!-- TOC --><ul class="simple">
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E8%BF%81%E7%A7%BB%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6%E8%84%9A%E6%9C%AC">使用工具迁移第三方框架脚本</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%A6%82%E8%BF%B0">概述</a></p></li>
<li><p><a class="reference external" href="#%E5%AE%89%E8%A3%85">安装</a></p></li>
<li><p><a class="reference external" href="#%E7%94%A8%E6%B3%95">用法</a></p>
<ul>
<li><p><a class="reference external" href="#pytorch%E6%A8%A1%E5%9E%8B%E8%84%9A%E6%9C%AC%E8%BF%81%E7%A7%BB">PyTorch模型脚本迁移</a></p></li>
<li><p><a class="reference external" href="#tensorflow%E6%A8%A1%E5%9E%8B%E8%84%9A%E6%9C%AC%E8%BF%81%E7%A7%BB">TensorFlow模型脚本迁移</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a></p></li>
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">使用示例</a></p>
<ul>
<li><p><a class="reference external" href="#%E5%9F%BA%E4%BA%8East%E7%9A%84%E8%84%9A%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%A4%BA%E4%BE%8B">基于AST的脚本转换示例</a></p></li>
<li><p><a class="reference external" href="#%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%BB%93%E6%9E%84%E7%9A%84%E8%84%9A%E6%9C%AC%E7%94%9F%E6%88%90%E7%A4%BA%E4%BE%8B">基于图结构的脚本生成示例</a></p>
<ul>
<li><p><a class="reference external" href="#pytorch%E6%A8%A1%E5%9E%8B%E8%84%9A%E6%9C%AC%E7%94%9F%E6%88%90%E7%A4%BA%E4%BE%8B">PyTorch模型脚本生成示例</a></p></li>
<li><p><a class="reference external" href="#tensorflow%E6%A8%A1%E5%9E%8B%E8%84%9A%E6%9C%AC%E7%94%9F%E6%88%90%E7%A4%BA%E4%BE%8B">TensorFlow模型脚本生成示例</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a></p></li>
</ul>
</li>
</ul>
<!-- /TOC --><p><a href="https://gitee.com/mindspore/docs/blob/r1.1/tutorials/training/source_zh_cn/advanced_use/migrate_3rd_scripts_mindconverter.md" target="_blank"><img src="../_static/logo_source.png"></a></p>
<div class="section" id="id2">
<h2>概述<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>MindConverter是一款用于将PyTorch、TensorFlow脚本转换到MindSpore脚本的工具。结合转换报告的信息，用户只需对转换后的脚本进行微小的改动，即可快速将PyTorch、TensorFlow框架的模型脚本迁移到MindSpore。</p>
</div>
<div class="section" id="id3">
<h2>安装<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>此工具为MindInsight的子模块，安装MindInsight后，即可使用MindConverter，MindInsight安装请参考该<a class="reference external" href="https://gitee.com/mindspore/mindinsight/blob/r1.1/README_CN.md#">安装文档</a>。</p>
</div>
<div class="section" id="id4">
<h2>用法<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>MindConverter提供命令行（Command-line interface, CLI）的使用方式，命令如下。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>usage: mindconverter <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--version<span class="o">]</span> <span class="o">[</span>--in_file IN_FILE<span class="o">]</span>
                     <span class="o">[</span>--model_file MODEL_FILE<span class="o">]</span> <span class="o">[</span>--shape SHAPE<span class="o">]</span>
                     <span class="o">[</span>--input_nodes INPUT_NODES<span class="o">]</span> <span class="o">[</span>--output_nodes OUTPUT_NODES<span class="o">]</span>
                     <span class="o">[</span>--output OUTPUT<span class="o">]</span> <span class="o">[</span>--report REPORT<span class="o">]</span>
                     <span class="o">[</span>--project_path PROJECT_PATH<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  --version             show program version number and <span class="nb">exit</span>
  --in_file IN_FILE     Specify path <span class="k">for</span> script file to use AST schema to <span class="k">do</span>
                        script conversation.
  --model_file MODEL_FILE
                        PyTorch .pth or TensorFlow .pb model file path to use
                        graph based schema to <span class="k">do</span> script generation. When
                        <span class="sb">`</span>--in_file<span class="sb">`</span> and <span class="sb">`</span>--model_file<span class="sb">`</span> are both provided, use
                        AST schema as default.
  --shape SHAPE         Optional, expected input tensor shape of
                        <span class="sb">`</span>--model_file<span class="sb">`</span>. It is required when use graph based
                        schema. Usage: --shape <span class="m">1</span>,3,244,244
  --input_nodes INPUT_NODES
                        Optional, input node<span class="o">(</span>s<span class="o">)</span> name of <span class="sb">`</span>--model_file<span class="sb">`</span>. It is
                        required when use TensorFlow model. Usage:
                        --input_nodes input_1:0,input_2:0
  --output_nodes OUTPUT_NODES
                        Optional, output node<span class="o">(</span>s<span class="o">)</span> name of <span class="sb">`</span>--model_file<span class="sb">`</span>. It is
                        required when use TensorFlow model. Usage:
                        --output_nodes output_1:0,output_2:0
  --output OUTPUT       Optional, specify path <span class="k">for</span> converted script file
                        directory. Default output directory is <span class="sb">`</span>output<span class="sb">`</span> folder
                        in the current working directory.
  --report REPORT       Optional, specify report directory. Default is
                        converted script directory.
  --project_path PROJECT_PATH
                        Optional, PyTorch scripts project path. If PyTorch
                        project is not in PYTHONPATH, please assign
                        <span class="sb">`</span>--project_path<span class="sb">`</span> when use graph based schema. Usage:
                        --project_path ~/script_file/
</pre></div>
</div>
<div class="section" id="pytorch">
<h3>PyTorch模型脚本迁移<a class="headerlink" href="#pytorch" title="Permalink to this headline">¶</a></h3>
<p>MindConverter提供两种PyTorch模型脚本迁移方案：</p>
<ol class="simple">
<li><p><strong>基于抽象语法树(Abstract syntax tree, AST)的脚本转换</strong>：指定<code class="docutils literal notranslate"><span class="pre">--in_file</span></code>的值，将使用基于AST的脚本转换方案；</p></li>
<li><p><strong>基于图结构的脚本生成</strong>：指定<code class="docutils literal notranslate"><span class="pre">--model_file</span></code>与<code class="docutils literal notranslate"><span class="pre">--shape</span></code>将使用基于图结构的脚本生成方案。</p></li>
</ol>
<blockquote>
<div><p>若同时指定了<code class="docutils literal notranslate"><span class="pre">--in_file</span></code>，<code class="docutils literal notranslate"><span class="pre">--model_file</span></code>将默认使用AST方案进行脚本迁移。</p>
</div></blockquote>
<p>当使用基于图结构的脚本生成方案时，要求必须指定<code class="docutils literal notranslate"><span class="pre">--shape</span></code>的值；当使用基于AST的脚本转换方案时，<code class="docutils literal notranslate"><span class="pre">--shape</span></code>会被忽略。</p>
<p>其中，<code class="docutils literal notranslate"><span class="pre">--output</span></code>与<code class="docutils literal notranslate"><span class="pre">--report</span></code>参数可省略。若省略，MindConverter将在当前工作目录（Working directory）下自动创建<code class="docutils literal notranslate"><span class="pre">output</span></code>目录，将生成的脚本、转换报告输出至该目录。</p>
<p>另外，当使用基于图结构的脚本生成方案时，请确保原PyTorch项目已在Python包搜索路径中，可通过CLI进入Python交互式命令行，通过import的方式判断是否已满足；若未加入，可通过<code class="docutils literal notranslate"><span class="pre">--project_path</span></code>命令手动将项目路径传入，以确保MindConverter可引用到原PyTorch脚本。</p>
<blockquote>
<div><p>假设用户项目目录为<code class="docutils literal notranslate"><span class="pre">/home/user/project/model_training</span></code>，用户可通过如下命令手动将项目目录添加至包搜索路径中：<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PYTHONPATH=/home/user/project/model_training:$PYTHONPATH</span></code>
此处MindConverter需要引用原PyTorch脚本，是因为PyTorch模型反向序列化过程中会引用原脚本。</p>
</div></blockquote>
</div>
<div class="section" id="tensorflow">
<h3>TensorFlow模型脚本迁移<a class="headerlink" href="#tensorflow" title="Permalink to this headline">¶</a></h3>
<p><strong>MindConverter提供基于图结构的脚本生成方案</strong>：指定<code class="docutils literal notranslate"><span class="pre">--model_file</span></code>、<code class="docutils literal notranslate"><span class="pre">--shape</span></code>、<code class="docutils literal notranslate"><span class="pre">--input_nodes</span></code>、<code class="docutils literal notranslate"><span class="pre">--output_nodes</span></code>进行脚本迁移。</p>
<blockquote>
<div><p>AST方案不支持TensorFlow模型脚本迁移，TensorFlow脚本迁移仅支持基于图结构的方案。</p>
</div></blockquote>
</div>
</div>
<div class="section" id="id5">
<h2>使用场景<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>MindConverter提供两种技术方案，以应对不同脚本迁移场景：</p>
<ol class="simple">
<li><p>用户希望迁移后脚本保持原脚本结构（包括变量、函数、类命名等与原脚本保持一致）；</p></li>
<li><p>用户希望迁移后脚本保持较高的转换率，尽量少的修改、甚至不需要修改，即可实现迁移后模型脚本的执行。</p></li>
</ol>
<p>对于上述第一种场景，推荐用户使用基于AST的方案进行转换（AST方案仅支持PyTorch脚本转换），AST方案通过对原PyTorch脚本的抽象语法树进行解析、编辑，将其替换为MindSpore的抽象语法树，再利用抽象语法树生成代码。理论上，AST方案支持任意模型脚本迁移，但语法树解析操作受原脚本用户编码风格影响，可能导致同一模型的不同脚本最终的转换率存在一定差异。</p>
<p>对于上述第二种场景，推荐用户使用基于图结构的脚本生成方案，计算图作为一种标准的模型描述语言，可以消除用户代码风格多样导致的脚本转换率不稳定的问题。在已支持算子的情况下，该方案可提供优于AST方案的转换率。</p>
<p>目前已基于计算机视觉领域典型模型对图结构的脚本转换方案进行测试。</p>
<blockquote>
<div><ol class="simple">
<li><p>基于图结构的脚本生成方案，目前仅支持单输入、单输出模型，对于多输入模型暂不支持；</p></li>
<li><p>基于图结构的脚本生成方案，由于要加载PyTorch、TensorFlow模型，会导致转换后网络中Dropout算子丢失，需要用户手动补齐；</p></li>
<li><p>基于图结构的脚本生成方案持续优化中。</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id6">
<h2>使用示例<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ast">
<h3>基于AST的脚本转换示例<a class="headerlink" href="#ast" title="Permalink to this headline">¶</a></h3>
<p>若用户希望使用基于AST的方案进行脚本迁移，假设原PyTorch脚本路径为<code class="docutils literal notranslate"><span class="pre">/home/user/model.py</span></code>，希望将脚本输出至<code class="docutils literal notranslate"><span class="pre">/home/user/output</span></code>，转换报告输出至<code class="docutils literal notranslate"><span class="pre">/home/user/output/report</span></code>，则脚本转换命令为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mindconverter --in_file /home/user/model.py <span class="se">\</span>
              --output /home/user/output <span class="se">\</span>
              --report /home/user/output/report
</pre></div>
</div>
<p>转换报告中，对于未转换的代码行形式为如下，其中x, y指明的是原PyTorch脚本中代码的行、列号。对于未成功转换的算子，可参考<a class="reference external" href="https://www.mindspore.cn/doc/note/zh-CN/r1.1/index.html#operator_api">MindSporeAPI映射查询功能</a> 手动对代码进行迁移。对于工具无法迁移的算子，会保留原脚本中的代码。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>line x:y: [UnConvert] &#39;operator&#39; didn&#39;t convert. ...
</pre></div>
</div>
<p>转换报告示例如下所示：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> [Start Convert]
 [Insert] &#39;import mindspore.ops.operations as P&#39; is inserted to the converted file.
 line 1:0: [Convert] &#39;import torch&#39; is converted to &#39;import mindspore&#39;.
 ...
 line 157:23: [UnConvert] &#39;nn.AdaptiveAvgPool2d&#39; didn&#39;t convert. Maybe could convert to mindspore.ops.operations.ReduceMean.
 ...
 [Convert Over]
</pre></div>
</div>
<p>对于部分未成功转换的算子，报告中会提供修改建议，如<code class="docutils literal notranslate"><span class="pre">line</span> <span class="pre">157:23</span></code>，MindConverter建议将<code class="docutils literal notranslate"><span class="pre">torch.nn.AdaptiveAvgPool2d</span></code>替换为<code class="docutils literal notranslate"><span class="pre">mindspore.ops.operations.ReduceMean</span></code>。</p>
</div>
<div class="section" id="id7">
<h3>基于图结构的脚本生成示例<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id8">
<h4>PyTorch模型脚本生成示例<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>若用户已将PyTorch模型保存为.pth格式，假设模型绝对路径为<code class="docutils literal notranslate"><span class="pre">/home/user/model.pth</span></code>，该模型期望的输入shape为(1, 3, 224, 224)，原PyTorch脚本位于<code class="docutils literal notranslate"><span class="pre">/home/user/project/model_training</span></code>，希望将脚本输出至<code class="docutils literal notranslate"><span class="pre">/home/user/output</span></code>，转换报告输出至<code class="docutils literal notranslate"><span class="pre">/home/user/output/report</span></code>，则脚本生成命令为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mindconverter --model_file /home/user/model.pth --shape <span class="m">1</span>,3,224,224 <span class="se">\</span>
              --output /home/user/output <span class="se">\</span>
              --report /home/user/output/report <span class="se">\</span>
              --project_path /home/user/project/model_training
</pre></div>
</div>
<p>执行该命令，MindSpore代码文件、转换报告生成至相应目录。</p>
<p>基于图结构的脚本生成方案产生的转换报告格式与AST方案相同。然而，由于基于图结构方案属于生成式方法，转换过程中未参考原PyTorch脚本，因此生成的转换报告中涉及的代码行、列号均指生成后脚本。</p>
<p>另外对于未成功转换的算子，在代码中会相应的标识该节点输入、输出Tensor的shape（以<code class="docutils literal notranslate"><span class="pre">input_shape</span></code>, <code class="docutils literal notranslate"><span class="pre">output_shape</span></code>标识），便于用户手动修改。以Reshape算子为例（暂不支持Reshape），将生成如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Classifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1280</span><span class="p">))</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># Suppose input of `reshape` is x.</span>
        <span class="n">reshape_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>通过<code class="docutils literal notranslate"><span class="pre">input_shape</span></code>、<code class="docutils literal notranslate"><span class="pre">output_shape</span></code>参数，用户可以十分便捷地完成算子替换，替换结果如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Classifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1280</span><span class="p">))</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># Suppose input of `reshape` is x.</span>
        <span class="n">reshape_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1280</span><span class="p">))</span>
        <span class="o">...</span>
</pre></div>
</div>
<blockquote>
<div><p>其中<code class="docutils literal notranslate"><span class="pre">--output</span></code>与<code class="docutils literal notranslate"><span class="pre">--report</span></code>参数可省略，若省略，该命令将在当前工作目录（Working directory）下自动创建<code class="docutils literal notranslate"><span class="pre">output</span></code>目录，将生成的脚本、转换报告输出至该目录。</p>
</div></blockquote>
</div>
<div class="section" id="id9">
<h4>TensorFlow模型脚本生成示例<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>使用TensorFlow模型脚本迁移，需要先将TensorFlow模型导出为pb格式（Frozen graph），并且获取模型输入节点、输出节点名称。pb模型导出示例，请参考<a class="reference external" href="https://gitee.com/mindspore/mindinsight/blob/r1.1/mindinsight/mindconverter/README_CN.md#tensorflow-pb%E6%A8%A1%E5%9E%8B%E5%AF%BC%E5%87%BA">MindConverter使用文档</a>。</p>
<p>假设，模型被保存至<code class="docutils literal notranslate"><span class="pre">/home/user/xxx/frozen_model.pb</span></code>，输入节点名称为<code class="docutils literal notranslate"><span class="pre">input_1:0</span></code>，输出节点名称为<code class="docutils literal notranslate"><span class="pre">predictions/Softmax:0</span></code>，模型输入样本尺寸为<code class="docutils literal notranslate"><span class="pre">1,224,224,3</span></code>，则可使用如下命令进行脚本生成：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mindconverter --model_file /home/user/xxx/frozen_model.pb --shape <span class="m">1</span>,224,224,3 <span class="se">\</span>
              --input_nodes input_1:0 <span class="se">\</span>
              --output_nodes predictions/Softmax:0 <span class="se">\</span>
              --output /home/user/output <span class="se">\</span>
              --report /home/user/output/report
</pre></div>
</div>
<p>执行该命令，MindSpore代码文件、转换报告生成至相应目录。</p>
<p>基于图结构的脚本生成方案产生的转换报告格式与AST方案相同。然而，由于基于图结构方案属于生成式方法，转换过程中未参考原TensorFlow脚本，因此生成的转换报告中涉及的代码行、列号均指生成后脚本。</p>
<p>另外，对于未成功转换的算子，在代码中会相应的标识该节点输入、输出Tensor的shape（以<code class="docutils literal notranslate"><span class="pre">input_shape</span></code>、<code class="docutils literal notranslate"><span class="pre">output_shape</span></code>标识），便于用户手动修改，示例见<strong>PyTorch模型脚本生成示例</strong>章节中手动修改代码示例。</p>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>注意事项<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>PyTorch、TensorFlow、TF2ONNX（&gt;=1.7.1）、ONNX（&gt;=1.8.0）、ONNXRUNTIME（&gt;=1.5.2）不作为MindInsight明确声明的依赖库。若想使用基于图结构的脚本生成工具，需要用户手动安装与生成PyTorch模型版本一致的PyTorch库（MindConverter推荐使用PyTorch 1.4.0或PyTorch 1.6.0进行脚本生成），或TensorFlow（MindConverter推荐使用TensorFlow 1.15.x版本）；</p></li>
<li><p>脚本转换工具本质上为算子驱动，对于MindConverter未维护的PyTorch或ONNX算子与MindSpore算子映射，将会出现相应的算子无法转换的问题，对于该类算子，用户可手动修改，或基于MindConverter实现映射关系，向MindInsight仓库贡献；</p></li>
<li><p>MindConverter仅保证转换后模型脚本在输入数据尺寸与<code class="docutils literal notranslate"><span class="pre">--shape</span></code>一致的情况下，可达到无需人工修改或少量修改（<code class="docutils literal notranslate"><span class="pre">--shape</span></code>中batch size维度不受限）。</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="migrate_3rd_scripts.html" class="btn btn-neutral float-right" title="迁移第三方框架训练脚本" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="migrate_script.html" class="btn btn-neutral float-left" title="迁移第三方框架训练脚本" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, MindSpore

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>