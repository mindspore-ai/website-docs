

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>使用MobileNetV2网络实现微调（Fine Tune） &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/training.css" type="text/css" />
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/training.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="自然语言处理" href="nlp.html" />
    <link rel="prev" title="在ResNet-50网络上应用二阶优化实践" href="cv_resnet50_second_order_optimizer.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">实现简单线性函数拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption"><span class="caption-text">基础使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">加载数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">保存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">加载模型用于推理或迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">发布模型</a></li>
</ul>
<p class="caption"><span class="caption-text">处理数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">转换数据集为MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">优化数据处理</a></li>
</ul>
<p class="caption"><span class="caption-text">构建网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="custom_loss_function.html">定义与使用损失函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">自定义算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_script.html">迁移第三方框架训练脚本</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_deep_probability_programming.html">深度概率编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="implement_high_order_differentiation.html">实现高阶自动微分</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_neural_network.html">量子神经网络</a></li>
</ul>
<p class="caption"><span class="caption-text">调试网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="dump_in_graph_mode.html">使用Dump功能在Graph模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">使用可视化组件MindInsight</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">应用自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">训练时验证模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_operator_build.html">算子增量编译</a></li>
</ul>
<p class="caption"><span class="caption-text">优化训练性能</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">使能自动混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">应用梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_cache.html">应用单节点数据缓存</a></li>
</ul>
<p class="caption"><span class="caption-text">压缩模型</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">应用感知量化训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_post_training_quantization.html">应用训练后量化</a></li>
</ul>
<p class="caption"><span class="caption-text">模型安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">使用NAD算法提升模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">应用差分隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_suppress_privacy.html">应用抑制隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">使用fuzz testing模块测试模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">使用成员推理测试模型安全性</a></li>
</ul>
<p class="caption"><span class="caption-text">应用实践</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="cv.html">机器视觉</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cv_resnet50.html">使用ResNet-50网络实现图像分类</a></li>
<li class="toctree-l2"><a class="reference internal" href="cv_resnet50_second_order_optimizer.html">在ResNet-50网络上应用二阶优化实践</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用MobileNetV2网络实现微调（Fine Tune）</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">任务描述及准备</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">环境配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">下载代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">准备预训练模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">准备数据</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">预训练模型加载代码详解</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">参数简介</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python">运行Python文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shell">运行Shell脚本</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id9">加载微调训练</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cpu">CPU加载训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpu">GPU加载训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ascend">Ascend加载训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">微调训练结果</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">验证微调训练模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id12">验证模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">验证结果</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">高性能计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="cv.html">机器视觉</a> &raquo;</li>
        
      <li>使用MobileNetV2网络实现微调（Fine Tune）</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/advanced_use/cv_mobilenetv2_fine_tune.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="mobilenetv2-fine-tune">
<h1>使用MobileNetV2网络实现微调（Fine Tune）<a class="headerlink" href="#mobilenetv2-fine-tune" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">Windows</span></code> <code class="docutils literal notranslate"><span class="pre">Ascend</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">CPU</span></code> <code class="docutils literal notranslate"><span class="pre">模型开发</span></code> <code class="docutils literal notranslate"><span class="pre">中级</span></code> <code class="docutils literal notranslate"><span class="pre">高级</span></code></p>
<!-- TOC -->
<ul class="simple">
<li><p><a class="reference external" href="#%E4%BD%BF%E7%94%A8mobilenetv2%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E5%BE%AE%E8%B0%83fine-tune">使用MobileNetV2网络实现微调（Fine Tune）</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%A6%82%E8%BF%B0">概述</a></p></li>
<li><p><a class="reference external" href="#%E4%BB%BB%E5%8A%A1%E6%8F%8F%E8%BF%B0%E5%8F%8A%E5%87%86%E5%A4%87">任务描述及准备</a></p>
<ul>
<li><p><a class="reference external" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</a></p></li>
<li><p><a class="reference external" href="#%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81">下载代码</a></p></li>
<li><p><a class="reference external" href="#%E5%87%86%E5%A4%87%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">准备预训练模型</a></p></li>
<li><p><a class="reference external" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE">准备数据</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3">预训练模型加载代码详解</a></p></li>
<li><p><a class="reference external" href="#%E5%8F%82%E6%95%B0%E7%AE%80%E4%BB%8B">参数简介</a></p>
<ul>
<li><p><a class="reference external" href="#%E8%BF%90%E8%A1%8Cpython%E6%96%87%E4%BB%B6">运行Python文件</a></p></li>
<li><p><a class="reference external" href="#%E8%BF%90%E8%A1%8Cshell%E8%84%9A%E6%9C%AC">运行Shell脚本</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E5%8A%A0%E8%BD%BD%E5%BE%AE%E8%B0%83%E8%AE%AD%E7%BB%83">加载微调训练</a></p>
<ul>
<li><p><a class="reference external" href="#cpu%E5%8A%A0%E8%BD%BD%E8%AE%AD%E7%BB%83">CPU加载训练</a></p></li>
<li><p><a class="reference external" href="#gpu%E5%8A%A0%E8%BD%BD%E8%AE%AD%E7%BB%83">GPU加载训练</a></p></li>
<li><p><a class="reference external" href="#ascend%E5%8A%A0%E8%BD%BD%E8%AE%AD%E7%BB%83">Ascend加载训练</a></p></li>
<li><p><a class="reference external" href="#%E5%BE%AE%E8%B0%83%E8%AE%AD%E7%BB%83%E7%BB%93%E6%9E%9C">微调训练结果</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E9%AA%8C%E8%AF%81%E5%BE%AE%E8%B0%83%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">验证微调训练模型</a></p>
<ul>
<li><p><a class="reference external" href="#%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%9E%8B">验证模型</a></p></li>
<li><p><a class="reference external" href="#%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">验证结果</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><a href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/training/source_zh_cn/advanced_use/cv_mobilenetv2_fine_tune.md" target="_blank"><img src="../_static/logo_source.png"></a>  </p>
<div class="section" id="id1">
<h2>概述<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>计算机视觉任务中，从头开始训练一个网络耗时巨大，需要大量计算能力。预训练模型选择的常见的OpenImage、ImageNet、VOC、COCO等公开大型数据集，规模达到几十万甚至超过上百万张。大部分任务数据规模较大，训练网络模型时，如果不使用预训练模型，从头开始训练网络，需要消耗大量的时间与计算能力，模型容易陷入局部极小值和过拟合。因此大部分任务都会选择预训练模型，在其上做微调（也称为Fine Tune）。</p>
<p>MindSpore是一个多元化的机器学习框架。既可以在手机等端侧和PC等设备上运行，也可以在云上的服务器集群上运行。目前MobileNetV2支持在Windows、EulerOS和Ubuntu系统中使用单个CPU做微调，也可以使用单个或者多个Ascend AI处理器或GPU做微调，本教程将会介绍如何在不同系统与处理器下的MindSpore框架中做微调的训练与验证。</p>
<p>目前，Window上暂只支持支持CPU，Ubuntu与EulerOS上支持CPU、GPU与Ascend AI处理器三种处理器。</p>
<blockquote>
<div><p>你可以在这里找到完整可运行的样例代码：<a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.2/model_zoo/official/cv/mobilenetv2">https://gitee.com/mindspore/mindspore/tree/r1.2/model_zoo/official/cv/mobilenetv2</a></p>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>任务描述及准备<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>环境配置<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>若在本地环境运行，需要安装MindSpore框架，配置CPU、GPU或Ascend AI处理器。若在华为云环境上运行，不需要安装MindSpore框架，不需要配置Ascend AI处理器、CPU与GPU，可以跳过本小节。</p>
<p>Windows操作系统中使用<code class="docutils literal notranslate"><span class="pre">\</span></code>，Linux操作系统中使用<code class="docutils literal notranslate"><span class="pre">/</span></code>分割路径地址中不同层级目录，下文中默认使用<code class="docutils literal notranslate"><span class="pre">/</span></code>，若用户使用Windows操作系统，路径地址中<code class="docutils literal notranslate"><span class="pre">/</span></code>需自行更改为<code class="docutils literal notranslate"><span class="pre">\</span></code>。</p>
<ol>
<li><p>安装MindSpore框架
在EulerOS、Ubuntu或者Windows等系统上需要根据系统和处理器架构<a class="reference external" href="https://www.mindspore.cn/install">安装对应版本MindSpore框架</a>。</p></li>
<li><p>配置CPU环境<br />
使用CPU时，在代码中，需要在调用CPU开始训练或测试前，按照如下代码设置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;CPU&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> \
        <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>配置GPU环境<br />
使用GPU时，在代码中，需要在调用GPU开始训练或测试前，按照如下代码设置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;GPU&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">run_distribute</span><span class="p">:</span>
        <span class="n">init</span><span class="p">(</span><span class="s2">&quot;nccl&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">device_num</span><span class="o">=</span><span class="n">get_group_size</span><span class="p">(),</span>
                                          <span class="n">parallel_mode</span><span class="o">=</span><span class="n">ParallelMode</span><span class="o">.</span><span class="n">DATA_PARALLEL</span><span class="p">,</span>
                                          <span class="n">gradients_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>配置Ascend环境<br />
以Ascend 910 AI处理器为例，1个8个处理器环境的json配置文件<code class="docutils literal notranslate"><span class="pre">hccl_config.json</span></code>示例如下。单/多处理器环境可以根据以下示例调整<code class="docutils literal notranslate"><span class="pre">&quot;server_count&quot;</span></code>与<code class="docutils literal notranslate"><span class="pre">device</span></code>：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_count&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_list&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;server_id&quot;</span><span class="p">:</span> <span class="s2">&quot;10.155.111.140&quot;</span><span class="p">,</span>
            <span class="nt">&quot;device&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.1.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.2.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.3.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.4.27.6&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.1.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.2.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.3.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;6&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="nt">&quot;device_id&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span><span class="nt">&quot;device_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.4.27.7&quot;</span><span class="p">,</span><span class="nt">&quot;rank_id&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">}],</span>
            <span class="nt">&quot;host_nic_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;reserve&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>使用Ascend AI处理器时，在代码中，需要在调用Ascend AI处理器开始训练或测试前，按照如下代码设置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;Ascend&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
                        <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">run_distribute</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">device_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">rank_size</span><span class="p">,</span>
                                          <span class="n">parallel_mode</span><span class="o">=</span><span class="n">ParallelMode</span><span class="o">.</span><span class="n">DATA_PARALLEL</span><span class="p">,</span>
                                          <span class="n">gradients_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">all_reduce_fusion_config</span><span class="o">=</span><span class="p">[</span><span class="mi">140</span><span class="p">])</span>
        <span class="n">init</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="id4">
<h3>下载代码<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>在Gitee中克隆<a class="reference external" href="https://gitee.com/mindspore/mindspore.git">MindSpore开源项目仓库</a>，进入<code class="docutils literal notranslate"><span class="pre">./model_zoo/official/cv/mobilenetv2/</span></code>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://gitee.com/mindspore/mindspore.git -b r1.2
<span class="nb">cd</span> ./mindspore/model_zoo/official/cv/mobilenetv2
</pre></div>
</div>
<p>代码结构如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>├─MobileNetV2
    ├─README.md     <span class="c1"># descriptions about MobileNetV2</span>
    ├─scripts
    │   run_train.sh   <span class="c1"># Shell script for train with Ascend or GPU</span>
    │   run_eval.sh    <span class="c1"># Shell script for evaluation with Ascend or GPU</span>
    ├─src
    │   config.py      <span class="c1"># parameter configuration</span>
    │   dataset.py     <span class="c1"># creating dataset</span>
    │   launch.py      <span class="c1"># start Python script</span>
    │   lr_generator.py     <span class="c1"># learning rate config</span>
    │   mobilenetV2.py      <span class="c1"># MobileNetV2 architecture</span>
    │   mobilenetV2_fusion.py      <span class="c1"># MobileNetV2 fusion architecture</span>
    │   models.py        <span class="c1"># net utils to load ckpt_file, define_net...</span>
    │   utils.py        <span class="c1"># net utils to switch precision, set_context and so on</span>
    ├─train.py      <span class="c1"># training script</span>
    └─eval.py       <span class="c1">#  evaluation script</span>
</pre></div>
</div>
<p>运行微调训练与测试时，Windows、Ubuntu与EulersOS上可以使用Python文件<code class="docutils literal notranslate"><span class="pre">train.py</span></code>与<code class="docutils literal notranslate"><span class="pre">eval.py</span></code>，Ubuntu与EulerOS上还可以使用Shell脚本文件<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>与<code class="docutils literal notranslate"><span class="pre">run_eval.sh</span></code>。</p>
<p>使用脚本文件<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>时，该文件会将运行<code class="docutils literal notranslate"><span class="pre">launch.py</span></code>并且将参数传入<code class="docutils literal notranslate"><span class="pre">launch.py</span></code>，<code class="docutils literal notranslate"><span class="pre">launch.py</span></code>根据分配的CPU、GPU或Ascend AI处理器数量，启动单个/多个进程运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>，每一个进程分配对应的一个处理器。</p>
</div>
<div class="section" id="id5">
<h3>准备预训练模型<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>用户需要根据不同处理器种类<a class="reference external" href="https://download.mindspore.cn/model_zoo/official/lite/mobilenetv2_openimage_lite/mobilenetv2_cpu_gpu.ckpt">下载CPU/GPU预训练模型</a>或<a class="reference external" href="https://download.mindspore.cn/model_zoo/official/lite/mobilenetv2_openimage_lite/mobilenetv2_ascend.ckpt">下载Ascend预训练模型</a>到以下目录：<br />
<code class="docutils literal notranslate"><span class="pre">./pretrain_checkpoint/</span></code></p>
<ul>
<li><p>CPU/GPU 处理器</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir pretrain_checkpoint
wget -P ./pretrain_checkpoint https://download.mindspore.cn/model_zoo/official/lite/mobilenetv2_openimage_lite/mobilenetv2_cpu_gpu.ckpt
</pre></div>
</div>
</li>
<li><p>Ascend AI处理器</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir pretrain_checkpoint
wget -P ./pretrain_checkpoint https://download.mindspore.cn/model_zoo/official/lite/mobilenetv2_openimage_lite/mobilenetv2_ascend.ckpt
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id6">
<h3>准备数据<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>准备ImageFolder格式管理的数据集，运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>时加入<code class="docutils literal notranslate"><span class="pre">&lt;dataset_path&gt;</span></code>参数，运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>时加入<code class="docutils literal notranslate"><span class="pre">--dataset_path</span> <span class="pre">&lt;dataset_path&gt;</span></code>参数：</p>
<p>数据集结构如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>└─ImageFolder
    ├─train
    │   class1Folder
    │   class2Folder
    │   ......
    └─eval
        class1Folder
        class2Folder
        ......
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>预训练模型加载代码详解<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>在微调时，需要加载预训练模型。不同数据集和任务中特征提取层（卷积层）分布趋于一致，但是特征向量的组合（全连接层）不相同，分类数量（全连接层output_size）通常也不一致。在微调时，只加载与训练特征提取层参数，不加载与训练全连接层参数；在微调与初始训练时，加载与训练特征提取层参数与全连接层参数。</p>
<p>在训练与测试之前，首先按照代码第1行，构建MobileNetV2的backbone网络，head网络，并且构建包含这两个子网络的MobileNetV2网络。代码第3-10行展示了如何定义<code class="docutils literal notranslate"><span class="pre">backbone_net</span></code>与<code class="docutils literal notranslate"><span class="pre">head_net</span></code>，以及将两个子网络置入<code class="docutils literal notranslate"><span class="pre">mobilenet_v2</span></code>中。代码第12-23行，展示了在微调训练模式下，需要将预训练模型加载<code class="docutils literal notranslate"><span class="pre">入backbone_net</span></code>子网络，并且冻结<code class="docutils literal notranslate"><span class="pre">backbone_net</span></code>中的参数，不参与训练。代码第21-23行展示了如何冻结网络参数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="mi">1</span><span class="p">:</span>  <span class="n">backbone_net</span><span class="p">,</span> <span class="n">head_net</span><span class="p">,</span> <span class="n">net</span> <span class="o">=</span> <span class="n">define_net</span><span class="p">(</span><span class="n">args_opt</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
 <span class="mi">2</span><span class="p">:</span>  <span class="o">...</span>
 <span class="mi">3</span><span class="p">:</span>  <span class="k">def</span> <span class="nf">define_net</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">is_training</span><span class="p">):</span>
 <span class="mi">4</span><span class="p">:</span>      <span class="n">backbone_net</span> <span class="o">=</span> <span class="n">MobileNetV2Backbone</span><span class="p">()</span>
 <span class="mi">5</span><span class="p">:</span>      <span class="n">activation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">activation</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_training</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
 <span class="mi">6</span><span class="p">:</span>      <span class="n">head_net</span> <span class="o">=</span> <span class="n">MobileNetV2Head</span><span class="p">(</span><span class="n">input_channel</span><span class="o">=</span><span class="n">backbone_net</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span>
 <span class="mi">7</span><span class="p">:</span>                                 <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span>
 <span class="mi">8</span><span class="p">:</span>                                 <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span>
 <span class="mi">9</span><span class="p">:</span>      <span class="n">net</span> <span class="o">=</span> <span class="n">mobilenet_v2</span><span class="p">(</span><span class="n">backbone_net</span><span class="p">,</span> <span class="n">head_net</span><span class="p">)</span>
<span class="mi">10</span><span class="p">:</span>      <span class="k">return</span> <span class="n">backbone_net</span><span class="p">,</span> <span class="n">head_net</span><span class="p">,</span> <span class="n">net</span>
<span class="mi">11</span><span class="p">:</span>  <span class="o">...</span>
<span class="mi">12</span><span class="p">:</span>  <span class="k">if</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">pretrain_ckpt</span> <span class="ow">and</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">freeze_layer</span> <span class="o">==</span> <span class="s2">&quot;backbone&quot;</span><span class="p">:</span>
<span class="mi">13</span><span class="p">:</span>     <span class="n">load_ckpt</span><span class="p">(</span><span class="n">backbone_net</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">pretrain_ckpt</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="mi">14</span><span class="p">:</span>  <span class="o">...</span>
<span class="mi">15</span><span class="p">:</span>  <span class="k">def</span> <span class="nf">load_ckpt</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">pretrain_ckpt_path</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="mi">16</span><span class="p">:</span>      <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">17:      train the param weight or not</span>
<span class="s2">18:      &quot;&quot;&quot;</span>
<span class="mi">19</span><span class="p">:</span>      <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">pretrain_ckpt_path</span><span class="p">)</span>
<span class="mi">20</span><span class="p">:</span>      <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="mi">21</span><span class="p">:</span>      <span class="k">if</span> <span class="ow">not</span> <span class="n">trainable</span><span class="p">:</span>
<span class="mi">22</span><span class="p">:</span>          <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">():</span>
<span class="mi">23</span><span class="p">:</span>              <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h2>参数简介<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>每个参数需要用户根据自己本地的处理器类型、数据地址与预训练模型地址等修改为相应的值。</p>
<div class="section" id="python">
<h3>运行Python文件<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
<p>在Windows与Linux系统上训练时，运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>时需要传入<code class="docutils literal notranslate"><span class="pre">dataset_path</span></code>、<code class="docutils literal notranslate"><span class="pre">platform</span></code>、<code class="docutils literal notranslate"><span class="pre">pretrain_ckpt</span></code>与<code class="docutils literal notranslate"><span class="pre">freeze_layer</span></code>四个参数。验证时，运行<code class="docutils literal notranslate"><span class="pre">eval.py</span></code>并且传入<code class="docutils literal notranslate"><span class="pre">dataset_path</span></code>、<code class="docutils literal notranslate"><span class="pre">platform</span></code>、<code class="docutils literal notranslate"><span class="pre">pretrain_ckpt</span></code>三个参数。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows/Linux train with Python file</span>
python train.py --platform <span class="o">[</span>PLATFORM<span class="o">]</span> --dataset_path &lt;DATASET_PATH&gt;  --pretrain_ckpt <span class="o">[</span>PRETRAIN_CHECKPOINT_PATH<span class="o">]</span> --freeze_layer<span class="o">[(</span><span class="s2">&quot;none&quot;</span>, <span class="s2">&quot;backbone&quot;</span><span class="o">)]</span>

<span class="c1"># Windows/Linux eval with Python file</span>
python eval.py --platform <span class="o">[</span>PLATFORM<span class="o">]</span> --dataset_path &lt;DATASET_PATH&gt; --pretrain_ckpt &lt;PRETRAIN_CHECKPOINT_PATH&gt;
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--dataset_path</span></code>：训练与验证数据集地址，无默认值，用户训练/验证时必须输入。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--platform</span></code>：处理器类型，默认为“Ascend”，可以设置为“CPU”或”GPU”。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pretrain_ckpt</span></code>：增量训练或调优时，需要传入pretrain_checkpoint文件路径以加载预训练好的模型参数权重。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--freeze_layer</span></code>：冻结网络层，输入“none”、”backbone”其中一个。</p></li>
</ul>
</div>
<div class="section" id="shell">
<h3>运行Shell脚本<a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h3>
<p>在Linux系统上时，可以选择运行Shell脚本文件<code class="docutils literal notranslate"><span class="pre">./scripts/run_train.sh</span></code>与<code class="docutils literal notranslate"><span class="pre">./scripts/run_eval.sh</span></code>。运行时需要在交互界面中同时传入参数。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows doesn&#39;t support Shell</span>
<span class="c1"># Linux train with Shell script</span>
sh run_train.sh &lt;PLATFORM&gt; &lt;DEVICE_NUM&gt; &lt;VISIABLE_DEVICES<span class="o">(</span><span class="m">0</span>,1,2,3,4,5,6,7<span class="o">)</span>&gt; &lt;RANK_TABLE_FILE&gt; &lt;DATASET_PATH&gt; &lt;CKPT_PATH&gt; <span class="o">[</span>FREEZE_LAYER<span class="o">]</span>

<span class="c1"># Linux eval with Shell script for fine tune</span>
sh run_eval.sh &lt;PLATFORM&gt; &lt;DATASET_PATH&gt; &lt;PRETRAIN_CKPT_PATH&gt;
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;PLATFORM&gt;</span></code>：处理器类型，默认为“Ascend”，可以设置为“GPU”。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;DEVICE_NUM&gt;</span></code>：每个节点（一台服务器/PC相当于一个节点）进程数量，建议设置为机器上Ascend AI处理器数量或GPU数量。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;VISIABLE_DEVICES(0,1,2,3,4,5,6,7)&gt;</span></code>：字符串格式的设备ID，训练将会根据<code class="docutils literal notranslate"><span class="pre">&lt;VISIABLE_DEVICES&gt;</span></code>将进程绑定到对应ID的设备上，多个设备ID之间使用’,’分隔，建议ID数量与进程数量相同。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;RANK_TABLE_FILE&gt;</span></code>：platform选择Ascend时，需要配置Ascend的配置Json文件,。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;DATASET_PATH&gt;</span></code>：训练与验证数据集地址，无默认值，用户训练/验证时必须输入。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;CKPT_PATH&gt;</span></code>：增量训练或调优时，需要传入checkpoint文件路径以加载预训练好的模型参数权重</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[FREEZE_LAYER]</span></code>：针对微调的模型做验证时，需要选择不冻结网络或者冻结backbone。</p></li>
</ul>
</div>
</div>
<div class="section" id="id9">
<h2>加载微调训练<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Windows系统上，MobileNetV2做微调训练时，只能运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>。Linux系统上，使用MobileNetV2做微调训练时，可以选择运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>， 并在运行Shell脚本文件时传入<a class="reference external" href="https://www.mindspore.cn/tutorial/training/zh-CN/r1.2/advanced_use/cv_mobilenetv2_fine_tune.html#id8">参数</a>。</p>
<p>Windows系统输出信息到交互式命令行，Linux系统环境下运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>时，命令行结尾使用<code class="docutils literal notranslate"><span class="pre">&amp;&gt;</span> <span class="pre">&lt;log_file_path&gt;</span></code>将标准输出与错误输出写入log文件。微调成功开始训练，<code class="docutils literal notranslate"><span class="pre">./train/rank*/log*.log</span></code>中会持续写入每一个epoch的训练时间与Loss等信息。若未成功，上述log文件会写入失败报错信息。</p>
<div class="section" id="cpu">
<h3>CPU加载训练<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>设置节点数量</p>
<p>目前运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>时仅支持单处理器，不需要调整处理器数量。运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>文件时，<code class="docutils literal notranslate"><span class="pre">CPU</span></code>设备默认为单处理器，目前暂不支持修改CPU数量。</p>
</li>
<li><p>开始增量训练</p>
<p>使用样例1：通过Python文件调用1个CPU处理器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows or Linux with Python</span>
python train.py --platform CPU --dataset_path &lt;TRAIN_DATASET_PATH&gt;  --pretrain_ckpt ./pretrain_checkpoint/mobilenetv2_cpu_gpu.ckpt --freeze_layer backbone
</pre></div>
</div>
<p>使用样例2：通过Shell文件调用1个CPU处理器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linux with Shell</span>
sh run_train.sh CPU &lt;TRAIN_DATASET_PATH&gt; ../pretrain_checkpoint/mobilenetV2_cpu_gpu.ckpt backbone
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="gpu">
<h3>GPU加载训练<a class="headerlink" href="#gpu" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>设置节点数量</p>
<p>目前运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>时仅支持单处理器，不需要调整节点数量。运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>文件时，设置<code class="docutils literal notranslate"><span class="pre">&lt;nproc_per_node&gt;</span></code>为GPU数量， <code class="docutils literal notranslate"><span class="pre">&lt;visible_devices&gt;</span></code>为可使用的处理器编号，即GPU的ID，可以选择一个或多个设备ID，使用<code class="docutils literal notranslate"><span class="pre">,</span></code>隔开。</p>
</li>
<li><p>开始增量训练</p>
<ul>
<li><p>使用样例1：通过Python文件调用1个GPU处理器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows or Linux with Python</span>
python train.py --platform GPU --dataset_path &lt;TRAIN_DATASET_PATH&gt; --pretrain_ckpt ./pretrain_checkpoint/mobilenetv2_cpu_gpu.ckpt --freeze_layer backbone
</pre></div>
</div>
</li>
<li><p>使用样例2：通过Shell脚本调用1个GPU处理器，设备ID为<code class="docutils literal notranslate"><span class="pre">“0”</span></code>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linux with Shell</span>
sh run_train.sh GPU <span class="m">1</span> <span class="m">0</span> &lt;TRAIN_DATASET_PATH&gt; ../pretrain_checkpoint/mobilenetv2_cpu_gpu.ckpt backbone
</pre></div>
</div>
</li>
<li><p>使用样例3：通过Shell脚本调用8个GPU处理器，设备ID为<code class="docutils literal notranslate"><span class="pre">“0,1,2,3,4,5,6,7”</span></code>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linux with Shell</span>
sh run_train.sh GPU <span class="m">8</span> <span class="m">0</span>,1,2,3,4,5,6,7 <span class="s">&lt;&lt;TRAIN_DAT</span>ASET_PATH&gt; ../pretrain_checkpoint/mobilenetv2_cpu_gpu.ckpt backbone
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ascend">
<h3>Ascend加载训练<a class="headerlink" href="#ascend" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>设置节点数量</p>
<p>目前运行<code class="docutils literal notranslate"><span class="pre">train.py</span></code>时仅支持单处理器，不需要调整节点数量。运行<code class="docutils literal notranslate"><span class="pre">run_train.sh</span></code>文件时，设置<code class="docutils literal notranslate"><span class="pre">&lt;nproc_per_node&gt;</span></code>为Ascend AI处理器数量， <code class="docutils literal notranslate"><span class="pre">&lt;visible_devices&gt;</span></code>为可使用的处理器编号，即Ascend AI处理器的ID，8卡服务器可以选择0-7中一个或多个设备ID，使用<code class="docutils literal notranslate"><span class="pre">,</span></code>隔开。Ascend节点处理器数量目前只能设置为1或者8。</p>
</li>
<li><p>开始增量训练</p>
<ul>
<li><p>使用样例1：通过Python文件调用1个Ascend处理器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows or Linux with Python</span>
python train.py --platform Ascend --dataset_path &lt;TRAIN_DATASET_PATH&gt;  --pretrain_ckpt  ./pretrain_checkpoint mobilenetv2_ascend.ckpt --freeze_layer backbone
</pre></div>
</div>
</li>
<li><p>使用样例2：通过Shell脚本调用1个Ascend AI处理器，设备ID为“0”。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linux with Shell</span>
sh run_train.sh Ascend <span class="m">1</span> <span class="m">0</span> ~/rank_table.json &lt;TRAIN_DATASET_PATH&gt; ../pretrain_checkpoint/mobilenetv2_ascend.ckpt backbone
</pre></div>
</div>
</li>
<li><p>使用样例3：通过Shell脚本调用8个Ascend AI处理器，设备ID为”0,1,2,3,4,5,6,7“。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Linux with Shell</span>
sh run_train.sh Ascend <span class="m">8</span> <span class="m">0</span>,1,2,3,4,5,6,7 ~/rank_table.json &lt;TRAIN_DATASET_PATH&gt; ../pretrain_checkpoint/mobilenetv2_ascend.ckpt backbone
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id10">
<h3>微调训练结果<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>查看运行结果。</p>
<ul>
<li><p>运行Python文件时在交互式命令行中查看打印信息，<code class="docutils literal notranslate"><span class="pre">Linux</span></code>上运行Shell脚本运行后使用<code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">./train/rank0/log0.log</span></code>中查看打印信息，输出结果如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>train args: Namespace<span class="o">(</span><span class="nv">dataset_path</span><span class="o">=</span><span class="s1">&#39;./dataset/train&#39;</span>, <span class="nv">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span>, <span class="se">\</span>
<span class="nv">pretrain_ckpt</span><span class="o">=</span><span class="s1">&#39;./pretrain_checkpoint/mobilenetv2_cpu_gpu.ckpt&#39;</span>, <span class="nv">freeze_layer</span><span class="o">=</span><span class="s1">&#39;backbone&#39;</span><span class="o">)</span>
cfg: <span class="o">{</span><span class="s1">&#39;num_classes&#39;</span>: <span class="m">26</span>, <span class="s1">&#39;image_height&#39;</span>: <span class="m">224</span>, <span class="s1">&#39;image_width&#39;</span>: <span class="m">224</span>, <span class="s1">&#39;batch_size&#39;</span>: <span class="m">150</span>, <span class="se">\</span>
<span class="s1">&#39;epoch_size&#39;</span>: <span class="m">200</span>, <span class="s1">&#39;warmup_epochs&#39;</span>: <span class="m">0</span>, <span class="s1">&#39;lr_max&#39;</span>: <span class="m">0</span>.03, <span class="s1">&#39;lr_end&#39;</span>: <span class="m">0</span>.03, <span class="s1">&#39;momentum&#39;</span>: <span class="m">0</span>.9, <span class="se">\</span>
<span class="s1">&#39;weight_decay&#39;</span>: 4e-05, <span class="s1">&#39;label_smooth&#39;</span>: <span class="m">0</span>.1, <span class="s1">&#39;loss_scale&#39;</span>: <span class="m">1024</span>, <span class="s1">&#39;save_checkpoint&#39;</span>: True, <span class="se">\</span>
<span class="s1">&#39;save_checkpoint_epochs&#39;</span>: <span class="m">1</span>, <span class="s1">&#39;keep_checkpoint_max&#39;</span>: <span class="m">20</span>, <span class="s1">&#39;save_checkpoint_path&#39;</span>: <span class="s1">&#39;./&#39;</span>, <span class="se">\</span>
<span class="s1">&#39;platform&#39;</span>: <span class="s1">&#39;CPU&#39;</span><span class="o">}</span>
Processing batch: <span class="m">16</span>: <span class="m">100</span>%<span class="p">|</span>███████████████████████████████████████████ █████████████████████<span class="p">|</span> <span class="m">16</span>/16 <span class="o">[</span><span class="m">00</span>:00&lt;?, ?it/s<span class="o">]</span>
epoch<span class="o">[</span><span class="m">200</span><span class="o">]</span>, iter<span class="o">[</span><span class="m">16</span><span class="o">]</span> cost: <span class="m">256</span>.030, per step time: <span class="m">256</span>.030, avg loss: <span class="m">1</span>.775total cos <span class="m">7</span>.2574 s
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>查看保存的checkpoint文件。</p>
<ul>
<li><p>Windows上使用<code class="docutils literal notranslate"><span class="pre">dir</span> <span class="pre">checkpoint</span></code>查看保存的模型文件：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dir ckpt_0
<span class="m">2020</span>//0814 <span class="m">11</span>:20        <span class="m">267</span>,727 mobilenetv2_1.ckpt
<span class="m">2020</span>//0814 <span class="m">11</span>:21        <span class="m">267</span>,727 mobilenetv2_10.ckpt
<span class="m">2020</span>//0814 <span class="m">11</span>:21        <span class="m">267</span>,727 mobilenetv2_11.ckpt
...
<span class="m">2020</span>//0814 <span class="m">11</span>:21        <span class="m">267</span>,727 mobilenetv2_7.ckpt
<span class="m">2020</span>//0814 <span class="m">11</span>:21        <span class="m">267</span>,727 mobilenetv2_8.ckpt
<span class="m">2020</span>//0814 <span class="m">11</span>:21        <span class="m">267</span>,727 mobilenetv2_9.ckpt
</pre></div>
</div>
</li>
<li><p>Linux上使用<code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">./checkpoint</span></code>查看保存的模型文件：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls ./ckpt_0/
mobilenetv2_1.ckpt  mobilenetv2_2.ckpt
mobilenetv2_3.ckpt  mobilenetv2_4.ckpt
...
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="id11">
<h2>验证微调训练模型<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3>验证模型<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>使用验证集测试模型性能，需要输入必要<a class="reference external" href="https://www.mindspore.cn/tutorial/training/zh-CN/r1.2/advanced_use/cv_mobilenetv2_fine_tune.html#id8">参数</a>，<code class="docutils literal notranslate"><span class="pre">--platform</span></code>默认为“Ascend”，可自行设置为”CPU”或”GPU”。最终在交互式命令行中展示标准输出与错误输出，或者将其写入<code class="docutils literal notranslate"><span class="pre">eval.log</span></code>文件。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Windows/Linux with Python</span>
python eval.py --platform CPU --dataset_path &lt;VAL_DATASET_PATH&gt; --pretrain_ckpt ./ckpt_0/mobilenetv2_15.ckpt

<span class="c1"># Linux with Shell</span>
sh run_eval.sh CPU &lt;VAL_DATASET_PATH&gt; ../ckpt_0/mobilenetv2_15.ckpt
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>验证结果<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>运行Python文件时在交互式命令行中输出验证结果，Shell脚本将把这些信息写入<code class="docutils literal notranslate"><span class="pre">./eval.log</span></code>中，需要使用<code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">./eval.log</span></code>查看，结果如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>result:<span class="o">{</span><span class="s1">&#39;acc&#39;</span>: <span class="m">0</span>.9466666666666666666667<span class="o">}</span>
<span class="nv">pretrain_ckpt</span> <span class="o">=</span> ./ckpt_0/mobilenetv2_15.ckpt
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="nlp.html" class="btn btn-neutral float-right" title="自然语言处理" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="cv_resnet50_second_order_optimizer.html" class="btn btn-neutral float-left" title="在ResNet-50网络上应用二阶优化实践" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>