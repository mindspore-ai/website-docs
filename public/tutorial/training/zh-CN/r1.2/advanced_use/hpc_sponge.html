<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPONGE分子模拟实践 &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script>
      
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="在云上使用MindSpore" href="use_on_the_cloud.html" />
    <link rel="prev" title="实现区域海洋模型GOMO" href="hpc_gomo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">实现简单线性函数拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基础使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">加载数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">保存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">加载模型用于推理或迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">发布模型</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">处理数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">转换数据集为MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">优化数据处理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">构建网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="custom_loss_function.html">定义与使用损失函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">自定义算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_script.html">迁移第三方框架训练脚本</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_deep_probability_programming.html">深度概率编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="implement_high_order_differentiation.html">实现高阶自动微分</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantum_neural_network.html">量子神经网络</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">调试网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="dump_in_graph_mode.html">使用Dump功能在Graph模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">使用可视化组件MindInsight</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">应用自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">训练时验证模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_operator_build.html">算子增量编译</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">优化训练性能</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">使能自动混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">应用梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_cache.html">应用单节点数据缓存</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">压缩模型</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">应用感知量化训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_post_training_quantization.html">应用训练后量化</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">使用NAD算法提升模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">应用差分隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_suppress_privacy.html">应用抑制隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">使用fuzz testing模块测试模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">使用成员推理测试模型安全性</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用实践</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="cv.html">机器视觉</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="hpc.html">高性能计算</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hpc_gomo.html">实现区域海洋模型GOMO</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">SPONGE分子模拟实践</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">整体执行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">准备环节</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">模拟多肽水溶液体系示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">准备输入文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">加载数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">构建模拟流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">运行脚本</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">运行结果</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="hpc.html">高性能计算</a> &raquo;</li>
      <li>SPONGE分子模拟实践</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/advanced_use/hpc_sponge.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="sponge">
<h1>SPONGE分子模拟实践<a class="headerlink" href="#sponge" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">GPU</span></code> <code class="docutils literal notranslate"><span class="pre">模型开发</span></code> <code class="docutils literal notranslate"><span class="pre">高级</span></code>
<a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/training/source_zh_cn/advanced_use/hpc_sponge.md"><img alt="查看源文件" src="../_images/logo_source.png" /></a>  </p>
<section id="id1">
<h2>概述<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<p>分子模拟是指利用计算机以原子水平的分子模型来模拟分子结构与行为，进而模拟分子体系的各种物理、化学性质的方法。它是在实验基础上，通过基本原理，构筑起一套模型和算法，从而计算出合理的分子结构与分子行为。</p>
<p>近年来，分子模拟技术发展迅速并且在多个学科领域得到了广泛的应用。在药物设计领域，可用于研究病毒、药物的作用机理等；在生物科学领域，可用于表征蛋白质的多级结构与性质；在材料学领域，可用于研究结构与力学性能、材料的优化设计等；在化学领域，可用于研究表面催化及机理；在石油化工领域，可用于分子筛催化剂结构表征、合成设计、吸附扩散，可构建和表征高分子链以及晶态或非晶态本体聚合物的结构，预测包括共混行为、机械性质、扩散、内聚等重要性质。</p>
<p>MindSpore版的SPONGE是北大和深圳湾实验室高毅勤课题组与华为MindSpore团队联合开发的分子模拟库，具有高性能、模块化等特性。基于MindSpore自动并行、图算融合等特性，SPONGE可高效地完成传统分子模拟过程。SPONGE利用MindSpore自动微分的特性，可以将神经网络等AI方法与传统分子模拟进行结合。</p>
<p>本篇教程将主要介绍如何在GPU上，使用MindSpore内置的SPONGE进行高性能分子模拟。</p>
<blockquote>
<div><p>你可以在这里下载完整的示例代码：<a class="reference external" href="https://gitee.com/mindspore/mindspore/tree/r1.2/model_zoo/research/hpc/sponge">https://gitee.com/mindspore/mindspore/tree/r1.2/model_zoo/research/hpc/sponge</a>。</p>
</div></blockquote>
</section>
<section id="id2">
<h2>整体执行<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>准备分子模拟输入文件，加载数据，确定计算的分子体系；</p></li>
<li><p>定义 SPONGE 模块并初始化，确定计算流程；</p></li>
<li><p>运行训练脚本，输出模拟的热力学信息文件，并查看结果；</p></li>
</ol>
</section>
<section id="id3">
<h2>准备环节<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<p>实践前，确保已经正确安装MindSpore。如果没有，可以通过<a class="reference external" href="https://www.mindspore.cn/install">MindSpore安装页面</a>安装MindSpore。</p>
</section>
<section id="id4">
<h2>模拟多肽水溶液体系示例<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h2>
<p>SPONGE具有高性能及易用的优势，本教程使用SPONGE模拟多肽水溶液体系。模拟体系为丙氨酸三肽水溶液体系。</p>
<section id="id5">
<h3>准备输入文件<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<p>本教程模拟体系中需要加载三个输入文件，分别是：</p>
<ul class="simple">
<li><p>属性文件（后缀为<code class="docutils literal notranslate"><span class="pre">.in</span></code>的文件），声明模拟的基本条件，对整个模拟过程进行参数控制。</p></li>
<li><p>拓扑文件（后缀为<code class="docutils literal notranslate"><span class="pre">.param7</span></code>的文件），拓扑文件描述的是体系内部分子的拓扑关系及各种参数。</p></li>
<li><p>坐标文件（后缀为<code class="docutils literal notranslate"><span class="pre">.rst7</span></code>的文件），坐标文件描述的是每个原子在体系中的初始时刻的坐标。</p></li>
</ul>
<p>拓扑文件和坐标文件可以通过建模过程由AmberTools中自带的tleap工具（下载地址<a class="reference external" href="http://ambermd.org/GetAmber.php">http://ambermd.org/GetAmber.php</a>， 遵守GPL协议）建模完成。建模过程如下：</p>
<ul>
<li><p>打开tleap</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tleap
</pre></div>
</div>
</li>
<li><p>加载tleap自带的ff14SB力场</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span><span class="nb">source</span><span class="w"> </span>leaprc.protein.ff14SB
</pre></div>
</div>
</li>
<li><p>搭建丙氨酸三肽模型</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span><span class="nv">ala</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sequence<span class="w"> </span><span class="o">{</span>ALA<span class="w"> </span>ALA<span class="w"> </span>ALA<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p>利用tleap加载其自带的tip3p力场</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span><span class="nb">source</span><span class="w"> </span>leaprc.water.tip3p
</pre></div>
</div>
</li>
<li><p>利用tleap中的<code class="docutils literal notranslate"><span class="pre">slovatebox</span></code>溶解丙氨酸三肽链， 完成体系构建。<code class="docutils literal notranslate"><span class="pre">10.0</span></code>代表加入的水距离我们溶解的分子及体系边界至少在<code class="docutils literal notranslate"><span class="pre">10.0</span></code>埃以上</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>solvatebox<span class="w"> </span>ala<span class="w"> </span>TIP3PBOX<span class="w"> </span><span class="m">10</span>.0
</pre></div>
</div>
</li>
<li><p>将建好的体系保存成<code class="docutils literal notranslate"><span class="pre">parm7</span></code>及<code class="docutils literal notranslate"><span class="pre">rst7</span></code>文件</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>saveamberparm<span class="w"> </span>ala<span class="w"> </span>ala.parm7<span class="w"> </span>ala_350_cool_290.rst7
</pre></div>
</div>
</li>
</ul>
<p>通过tleap构建了所需要的拓扑文件（<code class="docutils literal notranslate"><span class="pre">WATER_ALA.parm7</span></code>）和坐标文件（<code class="docutils literal notranslate"><span class="pre">WATER_ALA_350_cool_290.rst7</span></code>）后，需要通过属性文件声明模拟的基本条件，对整个模拟过程进行参数控制。以本教程中的属性文件<code class="docutils literal notranslate"><span class="pre">NVT_290_10ns.in</span></code>为例，其文件内容如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>NVT 290k
   mode = 1,                              # Simulation mode ; mode=1 for NVT ensemble
   dt= 0.001,                             # Time step in picoseconds (ps). The time length of each MD step
   step_limit = 1,                        # Total step limit, number of MD steps run
   thermostat=1,                          # Thermostat for temperature ; thermostat=0 for Langevin thermostat
   langevin_gamma=1.0,                    # Gamma_ln for Langevin thermostat represents coupling strength between thermostat and system
   target_temperature=290,               # Target temperature
   write_information_interval=1000,       # Output frequency
   amber_irest=1,                         # Input style ;  amber_irest=1 for using amber style input &amp; rst7 file contains veclocity
   cut=10.0,                              # Nonbonded cutoff distance in Angstroms
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code>，分子动力学（MD）模式，<code class="docutils literal notranslate"><span class="pre">1</span></code>表示模拟采用<code class="docutils literal notranslate"><span class="pre">NVT</span></code>系综。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dt</span></code>，表示模拟步长。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">step_limit</span></code>，表示模拟总步数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thermostat</span></code>，表示控温方法，<code class="docutils literal notranslate"><span class="pre">1</span></code>表示采用的是<code class="docutils literal notranslate"><span class="pre">Liujian-Langevin</span></code>方法。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">langevin_gamma</span></code>，表示控温器中的<code class="docutils literal notranslate"><span class="pre">Gamma_ln</span></code>参数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_temperature</span></code>，表示目标温度。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">amber_irest</span></code>，表示输入方式，<code class="docutils literal notranslate"><span class="pre">1</span></code>表示使用amber方式输入，并且<code class="docutils literal notranslate"><span class="pre">rst7</span></code>文件中包含<code class="docutils literal notranslate"><span class="pre">veclocity</span></code>属性。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cut</span></code>，表示非键相互作用的距离。</p></li>
</ul>
</section>
<section id="id6">
<h3>加载数据<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<p>完成输入文件的构建后，将文件存放在本地工作区的<code class="docutils literal notranslate"><span class="pre">sponge_in</span></code>路径下，其目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└─sponge
    ├─sponge_in
    │      NVT_290_10ns.in                 # specific MD simulation setting
    │      WATER_ALA.parm7                 # topology file include atom &amp; residue &amp; bond &amp; nonbond information
    │      WATER_ALA_350_cool_290.rst7     # restart file record atom coordinate &amp; velocity and box information
</pre></div>
</div>
<p>从三个输入文件中，读取模拟体系需要的参数，用于MindSpore的计算。加载代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Sponge Controller&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--i&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input file&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--amber_parm&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;paramter file in AMBER type&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--c&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;initial coordinates file&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--r&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;restrt&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--x&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mdcrd&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--o&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mdout&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--box&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;mdbox&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device_id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">args_opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="n">args_opt</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span> <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>构建模拟流程<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h3>
<p>使用SPONGE中定义的计算力模块和计算能量模块，通过多次迭代进行分子动力学过程演化，使得体系达到我们所需要的平衡态，并记录每一个模拟步骤中得到的能量等数据。为了方便起见，本教程的计算迭代次数设置为<code class="docutils literal notranslate"><span class="pre">1</span></code>，其模拟流程构建代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.simulation_initial</span> <span class="kn">import</span> <span class="n">Simulation</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">args_opt</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">o</span>
    <span class="k">for</span> <span class="n">steps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">md_info</span><span class="o">.</span><span class="n">step_limit</span><span class="p">):</span>
        <span class="n">print_step</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">simulation</span><span class="o">.</span><span class="n">ntwx</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="n">simulation</span><span class="o">.</span><span class="n">md_info</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">print_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temperature</span><span class="p">,</span> <span class="n">total_potential_energy</span><span class="p">,</span> <span class="n">sigma_of_bond_ene</span><span class="p">,</span> <span class="n">sigma_of_angle_ene</span><span class="p">,</span> <span class="n">sigma_of_dihedral_ene</span><span class="p">,</span> \
        <span class="n">nb14_lj_energy_sum</span><span class="p">,</span> <span class="n">nb14_cf_energy_sum</span><span class="p">,</span> <span class="n">LJ_energy_sum</span><span class="p">,</span> <span class="n">ee_ene</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">simulation</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">print_step</span><span class="p">))</span>
        <span class="c1"># compute energy and temperature</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>运行脚本<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h3>
<p>执行以下命令，启动训练脚本<code class="docutils literal notranslate"><span class="pre">main.py</span></code>进行训练：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>python main.py --i /path/NVT_290_10ns.in \
               --amber_parm /path/WATER_ALA.parm7 \
               --c /path/WATER_ALA_350_cool_290.rst7 \
               --o /path/ala_NVT_290_10ns.out
</pre></div>
</div>
<ul class="simple">
<li><p>-<code class="docutils literal notranslate"><span class="pre">i</span></code> 为MD模拟的属性文件，控制模拟过程</p></li>
<li><p>-<code class="docutils literal notranslate"><span class="pre">amber_parm</span></code> 为MD模拟体系的拓扑文件</p></li>
<li><p>-<code class="docutils literal notranslate"><span class="pre">c</span></code> 为我们输入的初始坐标文件</p></li>
<li><p>-<code class="docutils literal notranslate"><span class="pre">o</span></code> 为我们模拟输出的记录文件，其记录了输出每步的能量等信息</p></li>
<li><p>-<code class="docutils literal notranslate"><span class="pre">path</span></code> 为文件所在的路径，在本教程中为<code class="docutils literal notranslate"><span class="pre">sponge_in</span></code></p></li>
</ul>
<p>训练过程中，使用属性文件（后缀为<code class="docutils literal notranslate"><span class="pre">.in</span></code>的文件）、拓扑文件（后缀为<code class="docutils literal notranslate"><span class="pre">.param7</span></code>的文件）以及坐标文件（后缀为<code class="docutils literal notranslate"><span class="pre">.rst7</span></code>的文件），通过在指定温度下进行模拟，计算力和能量，进行分子动力学过程演化。</p>
</section>
<section id="id9">
<h3>运行结果<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h3>
<p>训练结束后，可以得到输出文件<code class="docutils literal notranslate"><span class="pre">ala_NVT_290_10ns.out</span></code>，体系能量变化被记录在了该文件中，可以查看模拟体系的热力学信息。查看<code class="docutils literal notranslate"><span class="pre">ala_NVT_290_10ns.out</span></code>可以看到如下内容：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>_steps_ _TEMP_ _TOT_POT_ENE_ _BOND_ENE_ _ANGLE_ENE_ _DIHEDRAL_ENE_ _14LJ_ENE_ _14CF_ENE_ _LJ_ENE_ _CF_PME_ENE_
      1 293.105   -6117.709   1204.406       7.096          4.491      3.456     44.018 1372.488    -8753.664
   ...
</pre></div>
</div>
<p>其中记录了模拟过程中输出的各类能量， 分别是迭代次数（<em>steps</em>），温度（<em>TEMP</em>），总能量（<em>TOT_POT_E</em>），键长（<em>BOND_ENE</em>），键角（<em>ANGLE_ENE</em>），二面角相互作用（<em>DIHEDRAL_ENE</em>），非键相互作用，其包含静电力及Leonard-Jones相互作用。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="hpc_gomo.html" class="btn btn-neutral float-left" title="实现区域海洋模型GOMO" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="use_on_the_cloud.html" class="btn btn-neutral float-right" title="在云上使用MindSpore" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>