<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>量子神经网络在自然语言处理中的应用 &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script>
      <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/training.css" type="text/css" /><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script src="../_static/js/training.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script><script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script><script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="使用PyNative模式调试" href="debug_in_pynative_mode.html" />
    <link rel="prev" title="参数化量子线路" href="parameterized_quantum_circuit.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/linear_regression.html">实现简单线性函数拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">基础使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation.html">加载数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/save_model.html">保存模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/load_model_for_inference_and_transfer.html">加载模型用于推理或迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/publish_model.html">发布模型</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">处理数据</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="convert_dataset.html">转换数据集为MindRecord</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_data_processing.html">优化数据处理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">构建网络</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="custom_loss_function.html">定义与使用损失函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_operator.html">自定义算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_script.html">迁移第三方框架训练脚本</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_deep_probability_programming.html">深度概率编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="implement_high_order_differentiation.html">实现高阶自动微分</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="quantum_neural_network.html">量子神经网络</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="parameterized_quantum_circuit.html">参数化量子线路</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">量子神经网络在自然语言处理中的应用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#概述">概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#环境准备">环境准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#数据预处理">数据预处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#编码线路">编码线路</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Ansatz线路">Ansatz线路</a></li>
<li class="toctree-l3"><a class="reference internal" href="#测量">测量</a></li>
<li class="toctree-l3"><a class="reference internal" href="#量子版词向量嵌入层">量子版词向量嵌入层</a></li>
<li class="toctree-l3"><a class="reference internal" href="#经典版词向量嵌入层">经典版词向量嵌入层</a></li>
<li class="toctree-l3"><a class="reference internal" href="#参考文献">参考文献</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">调试网络</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debug_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="dump_in_graph_mode.html">使用Dump功能在Graph模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_debugging_info.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">使用可视化组件MindInsight</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_auto_augmentation.html">应用自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluate_the_model_during_training.html">训练时验证模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="incremental_operator_build.html">算子增量编译</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">优化训练性能</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_mixed_precision.html">使能自动混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_graph_kernel_fusion.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_gradient_accumulation.html">应用梯度累积算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_cache.html">应用单节点数据缓存</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">压缩模型</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apply_quantization_aware_training.html">应用感知量化训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="apply_post_training_quantization.html">应用训练后量化</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improve_model_security_nad.html">使用NAD算法提升模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_differential_privacy.html">应用差分隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="protect_user_privacy_with_suppress_privacy.html">应用抑制隐私机制保护用户隐私</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_fuzzing.html">使用fuzz testing模块测试模型安全性</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_model_security_membership_inference.html">使用成员推理测试模型安全性</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用实践</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cv.html">机器视觉</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">高性能计算</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="quantum_neural_network.html">量子神经网络</a> &raquo;</li>
      <li>量子神经网络在自然语言处理中的应用</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/advanced_use/qnn_for_nlp.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="量子神经网络在自然语言处理中的应用">
<h1>量子神经网络在自然语言处理中的应用<a class="headerlink" href="#量子神经网络在自然语言处理中的应用" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Linux</span></code> <code class="docutils literal notranslate"><span class="pre">CPU</span></code> <code class="docutils literal notranslate"><span class="pre">全流程</span></code> <code class="docutils literal notranslate"><span class="pre">初级</span></code> <code class="docutils literal notranslate"><span class="pre">中级</span></code> <code class="docutils literal notranslate"><span class="pre">高级</span></code></p>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/training/source_zh_cn/advanced_use/qnn_for_nlp.ipynb"><img alt="image0" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/_static/logo_source.png" /></a></p>
<section id="概述">
<h2>概述<a class="headerlink" href="#概述" title="Permalink to this headline"></a></h2>
<p>在自然语言处理过程中，词嵌入（Word embedding）是其中的重要步骤，它是一个将高维度空间的词向量嵌入到一个维数更低的连续向量空间的过程。当给予神经网络的语料信息不断增加时，网络的训练过程将越来越困难。利用量子力学的态叠加和纠缠等特性，我们可以利用量子神经网络来处理这些经典语料信息，加入其训练过程，并提高收敛精度。下面，我们将简单地搭建一个量子经典混合神经网络来完成一个词嵌入任务。</p>
</section>
<section id="环境准备">
<h2>环境准备<a class="headerlink" href="#环境准备" title="Permalink to this headline"></a></h2>
<p>导入本教程所依赖模块</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">projectq.ops</span> <span class="kn">import</span> <span class="n">QubitOperator</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">LossMonitor</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindquantum.nn</span> <span class="kn">import</span> <span class="n">MindQuantumLayer</span>
<span class="kn">from</span> <span class="nn">mindquantum</span> <span class="kn">import</span> <span class="n">Hamiltonian</span><span class="p">,</span> <span class="n">Circuit</span><span class="p">,</span> <span class="n">RX</span><span class="p">,</span> <span class="n">RY</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">UN</span>
</pre></div>
</div>
</div>
<p>本教程实现的是一个<a class="reference external" href="https://blog.csdn.net/u010665216/article/details/78724856">CBOW模型</a>，即利用某个词所处的环境来预测该词。例如对于“I love natural language processing”这句话，我们可以将其切分为5个词，[“I”, “love”, “natural”, “language”, “processing”]，在所选窗口为2时，我们要处理的问题是利用[“I”, “love”, “language”, “processing”]来预测出目标词汇“natural”。这里我们以窗口为2为例，搭建如下的量子神经网络，来完成词嵌入任务。</p>
<p><img alt="quantum word embedding" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/advanced_use/images/qcbow.png" /></p>
<p>这里，编码线路会将“I”、“love”、“language”和“processing”的编码信息编码到量子线路中，待训练的量子线路由四个Ansatz线路构成，最后我们在量子线路末端对量子比特做<span class="math notranslate nohighlight">\(\text{Z}\)</span>基矢上的测量，具体所需测量的比特的个数由所需嵌入空间的维数确定。</p>
</section>
<section id="数据预处理">
<h2>数据预处理<a class="headerlink" href="#数据预处理" title="Permalink to this headline"></a></h2>
<p>我们对所需要处理的语句进行处理，生成关于该句子的词典，并根据窗口大小来生成样本点。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GenerateWordDictAndSample</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">all_words</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">word_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_words</span><span class="p">))</span>
    <span class="n">word_set</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">word_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">word_set</span><span class="p">)}</span>
    <span class="n">sampling</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_words</span><span class="p">[</span><span class="n">window</span><span class="p">:</span><span class="o">-</span><span class="n">window</span><span class="p">]):</span>
        <span class="n">around</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">window</span><span class="p">:</span>
                <span class="n">around</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_words</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">sampling</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">around</span><span class="p">,</span><span class="n">all_words</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">window</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">word_dict</span><span class="p">,</span> <span class="n">sampling</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">word_dict</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">GenerateWordDictAndSample</span><span class="p">(</span><span class="s2">&quot;I love natural language processing&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">word_dict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;word dict size: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_dict</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;samples: &#39;</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of samples: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;I&#39;: 0, &#39;language&#39;: 1, &#39;love&#39;: 2, &#39;natural&#39;: 3, &#39;processing&#39;: 4}
word dict size:  5
samples:  [[[&#39;I&#39;, &#39;love&#39;, &#39;language&#39;, &#39;processing&#39;], &#39;natural&#39;]]
number of samples:  1
</pre></div></div>
</div>
<p>根据如上信息，我们得到该句子的词典大小为5，能够产生一个样本点。</p>
</section>
<section id="编码线路">
<h2>编码线路<a class="headerlink" href="#编码线路" title="Permalink to this headline"></a></h2>
<p>为了简单起见，我们使用的编码线路由<span class="math notranslate nohighlight">\(\text{RX}\)</span>旋转门构成，结构如下。</p>
<p><img alt="encoder circuit" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/advanced_use/images/encoder.png" /></p>
<p>我们对每个量子门都作用一个<span class="math notranslate nohighlight">\(\text{RX}\)</span>旋转门。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GenerateEncoderCircuit</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
        <span class="n">circ</span> <span class="o">+=</span> <span class="n">RX</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circ</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GenerateEncoderCircuit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RX(e_0|0)
RX(e_1|1)
RX(e_2|2)
</pre></div></div>
</div>
<p>我们通常用<span class="math notranslate nohighlight">\(\left|0\right&gt;\)</span>和<span class="math notranslate nohighlight">\(\left|1\right&gt;\)</span>来标记二能级量子比特的两个状态，由态叠加原理，量子比特还可以处于这两个状态的叠加态：</p>
<div class="math notranslate nohighlight">
\[\left|\psi\right&gt;=\alpha\left|0\right&gt;+\beta\left|1\right&gt;\]</div>
<p>对于<span class="math notranslate nohighlight">\(n\)</span>比特的量子态，其将处于<span class="math notranslate nohighlight">\(2^n\)</span>维的希尔伯特空间中。对于上面由5个词构成的词典，我们只需要<span class="math notranslate nohighlight">\(\lceil \log_2 5 \rceil=3\)</span>个量子比特即可完成编码，这也体现出量子计算的优越性。</p>
<p>例如对于上面词典中的“love”，其对应的标签为2，2的二进制表示为<code class="docutils literal notranslate"><span class="pre">010</span></code>，我们只需将编码线路中的<code class="docutils literal notranslate"><span class="pre">e_0</span></code>、<code class="docutils literal notranslate"><span class="pre">e_1</span></code>和<code class="docutils literal notranslate"><span class="pre">e_2</span></code>分别设为<span class="math notranslate nohighlight">\(0\)</span>、<span class="math notranslate nohighlight">\(\pi\)</span>和<span class="math notranslate nohighlight">\(0\)</span>即可。下面我们通过<code class="docutils literal notranslate"><span class="pre">Evolution</span></code>算子来验证以下。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindquantum.nn</span> <span class="kn">import</span> <span class="n">generate_evolution_operator</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="n">n_qubits</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># number of qubits of this quantum circuit</span>
<span class="n">label</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># label need to encode</span>
<span class="n">label_bin</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">label</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># binary form of label</span>
<span class="n">label_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">label_bin</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># parameter value of encoder</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">GenerateEncoderCircuit</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="c1"># encoder circuit</span>
<span class="n">encoder_para_names</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">parameter_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">para_name</span> <span class="c1"># parameter names of encoder</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Label is: &quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Binary label is: &quot;</span><span class="p">,</span> <span class="n">label_bin</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters of encoder is: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">label_array</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encoder circuit is: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encoder parameter names are: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoder_para_names</span><span class="p">)</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="c1"># quantum state evolution operator</span>
<span class="n">evol</span> <span class="o">=</span> <span class="n">generate_evolution_operator</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="n">encoder_para_names</span><span class="p">,</span> <span class="n">circuit</span><span class="o">=</span><span class="n">encoder</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">evol</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">label_array</span><span class="p">))</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">quantum_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">state</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">quantum_state</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amplitude of quantum state is: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">amp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Label in quantum state is: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Label is:  2
Binary label is:  010
Parameters of encoder is:
 [0.      3.14159 0.     ]
Encoder circuit is:
 RX(e_0|0)
RX(e_1|1)
RX(e_2|2)
Encoder parameter names are:
 [&#39;e_0&#39;, &#39;e_1&#39;, &#39;e_2&#39;]
Amplitude of quantum state is:
 [0. 0. 1. 0. 0. 0. 0. 0.]
Label in quantum state is:  2
</pre></div></div>
</div>
<p>通过上面的验证，我们发现，对于标签为2的数据，最后得到量子态的振幅最大的位置也是2，因此得到的量子态正是对输入标签的编码。我们将对数据编码生成参数数值的过程总结成如下函数。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GenerateTrainData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">word_dict</span><span class="p">):</span>
    <span class="n">n_qubits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">word_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
    <span class="n">data_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">around</span><span class="p">,</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
        <span class="n">data_x</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">around</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">word_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="n">label_bin</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">label</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="n">label_array</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">label_bin</span><span class="p">]</span>
            <span class="n">data_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">label_array</span><span class="p">)</span>
        <span class="n">data_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_dict</span><span class="p">[</span><span class="n">center</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GenerateTrainData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">word_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([[0.       , 0.       , 0.       , 0.       , 3.1415927, 0.       ,
         3.1415927, 0.       , 0.       , 0.       , 0.       , 3.1415927]],
       dtype=float32),
 array([3], dtype=int32))
</pre></div></div>
</div>
<p>根据上面的结果，我们将4个输入的词编码的信息合并为一个更长向量，便于后续神经网络调用。</p>
</section>
<section id="Ansatz线路">
<h2>Ansatz线路<a class="headerlink" href="#Ansatz线路" title="Permalink to this headline"></a></h2>
<p>Ansatz线路的选择多种多样，我们选择如下的量子线路作为Ansatz线路，它的一个单元由一层<span class="math notranslate nohighlight">\(\text{RY}\)</span>门和一层<span class="math notranslate nohighlight">\(\text{CNOT}\)</span>门构成，对此单元重复<span class="math notranslate nohighlight">\(p\)</span>次构成整个Ansatz线路。</p>
<p><img alt="ansatz circuit" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/advanced_use/images/ansatz.png" /></p>
<p>定义如下函数生成Ansatz线路。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GenerateAnsatzCircuit</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">):</span>
            <span class="n">circ</span> <span class="o">+=</span> <span class="n">RY</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_qubits</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n_qubits</span><span class="p">:</span>
                <span class="n">circ</span> <span class="o">+=</span> <span class="n">X</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circ</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GenerateAnsatzCircuit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RY(a_0_0|0)
RY(a_0_1|1)
RY(a_0_2|2)
RY(a_0_3|3)
RY(a_0_4|4)
X(1 &lt;-: 0)
X(3 &lt;-: 2)
RY(a_1_0|0)
RY(a_1_1|1)
RY(a_1_2|2)
RY(a_1_3|3)
RY(a_1_4|4)
X(2 &lt;-: 1)
X(4 &lt;-: 3)
</pre></div></div>
</div>
</section>
<section id="测量">
<h2>测量<a class="headerlink" href="#测量" title="Permalink to this headline"></a></h2>
<p>我们把对不同比特位上的测量结果作为降维后的数据。具体过程与比特编码类似，例如当我们想将词向量降维为5维向量时，对于第3维的数据可以如下产生：</p>
<ul class="simple">
<li><p>3对应的二进制为<code class="docutils literal notranslate"><span class="pre">00011</span></code>。</p></li>
<li><p>测量量子线路末态对<span class="math notranslate nohighlight">\(Z_0Z_1\)</span>哈密顿量的期望值。</p></li>
</ul>
<p>下面函数将给出产生各个维度上数据所需的哈密顿量（hams），其中<code class="docutils literal notranslate"><span class="pre">n_qubits</span></code>表示线路的比特数，<code class="docutils literal notranslate"><span class="pre">dims</span></code>表示词嵌入的维度：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GenerateEmbeddingHamiltonian</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">):</span>
    <span class="n">hams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="n">hams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hamiltonian</span><span class="p">(</span><span class="n">QubitOperator</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">hams</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GenerateEmbeddingHamiltonian</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.0 Z0, 1.0 Z1, 1.0 Z0 Z1, 1.0 Z2, 1.0 Z0 Z2]
</pre></div></div>
</div>
</section>
<section id="量子版词向量嵌入层">
<h2>量子版词向量嵌入层<a class="headerlink" href="#量子版词向量嵌入层" title="Permalink to this headline"></a></h2>
<p>量子版词向量嵌入层结合前面的编码量子线路和待训练量子线路，以及测量哈密顿量，将<code class="docutils literal notranslate"><span class="pre">num_embedding</span></code>个词嵌入为<code class="docutils literal notranslate"><span class="pre">embedding_dim</span></code>维的词向量。这里我们还在量子线路的最开始加上了Hadamard门，将初态制备为均匀叠加态，用以提高量子神经网络的表达能力。</p>
<p>下面，我们定义量子嵌入层，它将返回一个量子线路模拟算子。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">QEmbedding</span><span class="p">(</span><span class="n">num_embedding</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">):</span>
    <span class="n">n_qubits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">num_embedding</span><span class="p">)))</span>
    <span class="n">hams</span> <span class="o">=</span> <span class="n">GenerateEmbeddingHamiltonian</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
    <span class="n">circ</span> <span class="o">=</span> <span class="n">UN</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">n_qubits</span><span class="p">)</span>
    <span class="n">encoder_param_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ansatz_param_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">GenerateEncoderCircuit</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="s1">&#39;Encoder_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="n">ansatz</span> <span class="o">=</span> <span class="n">GenerateAnsatzCircuit</span><span class="p">(</span><span class="n">n_qubits</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="s1">&#39;Ansatz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
        <span class="n">circ</span> <span class="o">+=</span> <span class="n">encoder</span>
        <span class="n">circ</span> <span class="o">+=</span> <span class="n">ansatz</span>
        <span class="n">encoder_param_name</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameter_resolver</span><span class="p">()))</span>
        <span class="n">ansatz_param_name</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ansatz</span><span class="o">.</span><span class="n">parameter_resolver</span><span class="p">()))</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">MindQuantumLayer</span><span class="p">(</span><span class="n">encoder_param_name</span><span class="p">,</span>
                           <span class="n">ansatz_param_name</span><span class="p">,</span>
                           <span class="n">circ</span><span class="p">,</span>
                           <span class="n">hams</span><span class="p">,</span>
                           <span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">net</span>
</pre></div>
</div>
</div>
<p>整个训练模型跟经典网络类似，由一个嵌入层和两个全连通层构成，然而此处的嵌入层是由量子神经网络构成。下面定义量子神经网络CBOW。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CBOW</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_embedding</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">,</span>
                 <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBOW</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">QEmbedding</span><span class="p">(</span><span class="n">num_embedding</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                    <span class="n">layers</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_embedding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">embed</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
<p>下面我们对一个稍长的句子来进行训练。首先定义<code class="docutils literal notranslate"><span class="pre">LossMonitorWithCollection</span></code>用于监督收敛过程，并搜集收敛过程的损失。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LossMonitorWithCollection</span><span class="p">(</span><span class="n">LossMonitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_print_times</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LossMonitorWithCollection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">per_print_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time used: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_begin_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="n">cb_params</span> <span class="o">=</span> <span class="n">run_context</span><span class="o">.</span><span class="n">original_args</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_per_print_times</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_per_print_times</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_context</span><span class="p">):</span>
        <span class="n">cb_params</span> <span class="o">=</span> <span class="n">run_context</span><span class="o">.</span><span class="n">original_args</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">net_outputs</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>

        <span class="n">cur_step_in_epoch</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_params</span><span class="o">.</span><span class="n">cur_step_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">batch_num</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">loss</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;epoch: </span><span class="si">{}</span><span class="s2"> step: </span><span class="si">{}</span><span class="s2">. Invalid loss, terminating training.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_epoch_num</span><span class="p">,</span> <span class="n">cur_step_in_epoch</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_per_print_times</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cb_params</span><span class="o">.</span><span class="n">cur_step_num</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_per_print_times</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">epoch: </span><span class="si">%+3s</span><span class="s2"> step: </span><span class="si">%+3s</span><span class="s2"> time: </span><span class="si">%5.5s</span><span class="s2">, loss is </span><span class="si">%5.5s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cb_params</span><span class="o">.</span><span class="n">cur_epoch_num</span><span class="p">,</span> <span class="n">cur_step_in_epoch</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_begin_time</span><span class="p">,</span> <span class="n">loss</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>接下来，利用量子版本的<code class="docutils literal notranslate"><span class="pre">CBOW</span></code>来对一个长句进行词嵌入。运行之前请在终端运行<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">OMP_NUM_THREADS=4</span></code>，将量子模拟器的线程数设置为4个，当所需模拟的量子系统比特数较多时，可设置更多的线程数来提高模拟效率。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;We are about to study the idea of a computational process.</span>
<span class="s2">Computational processes are abstract beings that inhabit computers.</span>
<span class="s2">As they evolve, processes manipulate other abstract things called data.</span>
<span class="s2">The evolution of a process is directed by a pattern of rules</span>
<span class="s2">called a program. People create programs to direct processes. In effect,</span>
<span class="s2">we conjure the spirits of the computer with our spells.&quot;&quot;&quot;</span>

<span class="n">ms</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">word_dict</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">GenerateWordDictAndSample</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
<span class="n">train_x</span><span class="p">,</span><span class="n">train_y</span> <span class="o">=</span> <span class="n">GenerateTrainData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">word_dict</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">NumpySlicesDataset</span><span class="p">({</span>
    <span class="s2">&quot;around&quot;</span><span class="p">:</span> <span class="n">train_x</span><span class="p">,</span>
    <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="n">train_y</span>
<span class="p">},</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">CBOW</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_dict</span><span class="p">),</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">loss_monitor</span> <span class="o">=</span> <span class="n">LossMonitorWithCollection</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net_loss</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">loss_monitor</span><span class="p">],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch:  25 step:  20 time: 0.592, loss is 3.154
epoch:  50 step:  20 time: 0.614, loss is 2.944
epoch:  75 step:  20 time: 0.572, loss is 0.224
epoch: 100 step:  20 time: 0.562, loss is 0.015
epoch: 125 step:  20 time: 0.545, loss is 0.009
epoch: 150 step:  20 time: 0.599, loss is 0.003
epoch: 175 step:  20 time: 0.586, loss is 0.002
epoch: 200 step:  20 time: 0.552, loss is 0.045
epoch: 225 step:  20 time: 0.590, loss is 0.001
epoch: 250 step:  20 time: 0.643, loss is 0.001
epoch: 275 step:  20 time: 0.562, loss is 0.001
epoch: 300 step:  20 time: 0.584, loss is 0.001
epoch: 325 step:  20 time: 0.566, loss is 0.000
epoch: 350 step:  20 time: 0.578, loss is 0.000
Total time used: 206.29734826087952
</pre></div></div>
</div>
<p>打印收敛过程中的损失函数值：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_monitor</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>得到收敛图为</p>
<p><img alt="nlp loss" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/advanced_use/images/nlp_loss.png" /></p>
<p>通过如下方法打印量子嵌入层的量子线路中的参数：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 1.52044818e-01,  1.71521559e-01,  2.35021308e-01, -3.95286232e-01,
       -3.71680595e-03,  7.96886325e-01, -4.04954888e-02,  1.55393332e-01,
        4.11805660e-02,  7.79824018e-01,  2.96543002e-01, -2.21819162e-01,
       -4.67430688e-02,  4.66759771e-01,  2.75283188e-01,  1.35858059e-01,
       -3.23841363e-01, -2.31937021e-01, -4.68942285e-01, -1.96520030e-01,
        2.16065589e-02,  1.23866223e-01, -9.68078300e-02,  1.69127151e-01,
       -8.90062153e-01,  2.56734312e-01,  8.37369189e-02, -1.15734830e-01,
       -1.34410933e-01, -3.12207133e-01, -8.90189946e-01,  1.97006428e+00,
       -2.49193460e-02,  2.25960299e-01, -3.90179232e-02, -3.03875893e-01,
        2.02030335e-02, -7.07065910e-02, -4.81521547e-01,  5.04257262e-01,
       -1.32081115e+00,  2.83502758e-01,  2.80248702e-01,  1.63375765e-01,
       -6.91465080e-01,  6.82975233e-01, -2.67829001e-01,  2.29658693e-01,
        2.78859794e-01, -1.04206935e-01, -5.57148576e-01,  4.41706657e-01,
       -6.76973104e-01,  2.47751385e-01, -2.96468334e-03, -1.66827604e-01,
       -3.47717047e-01, -9.04396921e-03, -7.69433856e-01,  4.33617719e-02,
       -2.09145937e-02, -1.55236557e-01, -2.16777384e-01, -2.26556376e-01,
       -6.16374731e-01,  2.05871137e-03, -3.08128931e-02, -1.63372140e-02,
        1.46710426e-01,  2.31793106e-01,  4.16066934e-04, -9.28813033e-03],
      dtype=float32)
</pre></div></div>
</div>
</section>
<section id="经典版词向量嵌入层">
<h2>经典版词向量嵌入层<a class="headerlink" href="#经典版词向量嵌入层" title="Permalink to this headline"></a></h2>
<p>这里我们利用经典的词向量嵌入层来搭建一个经典的CBOW神经网络，并与量子版本进行对比。</p>
<p>首先，搭建经典的CBOW神经网络，其中的参数跟量子版本的类似。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CBOWClassical</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_embedding</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBOWClassical</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">window</span> <span class="o">*</span> <span class="n">embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embedding</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_embedding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Reshape</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">embed</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">embed</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
<p>生成适用于经典CBOW神经网络的数据集。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_x</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
    <span class="n">around</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">train_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_dict</span><span class="p">[</span><span class="n">center</span><span class="p">])</span>
    <span class="n">train_x</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">around</span><span class="p">:</span>
        <span class="n">train_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_dict</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="n">train_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_x shape: &quot;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_y shape: &quot;</span><span class="p">,</span> <span class="n">train_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
train_x shape:  (58, 4)
train_y shape:  (58,)
</pre></div></div>
</div>
<p>我们对经典CBOW网络进行训练。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">NumpySlicesDataset</span><span class="p">({</span>
    <span class="s2">&quot;around&quot;</span><span class="p">:</span> <span class="n">train_x</span><span class="p">,</span>
    <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="n">train_y</span>
<span class="p">},</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">CBOWClassical</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_dict</span><span class="p">),</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="n">loss_monitor</span> <span class="o">=</span> <span class="n">LossMonitorWithCollection</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">net_loss</span><span class="p">,</span> <span class="n">net_opt</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">loss_monitor</span><span class="p">],</span> <span class="n">dataset_sink_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch:  25 step:  20 time: 0.008, loss is 3.155
epoch:  50 step:  20 time: 0.026, loss is 3.027
epoch:  75 step:  20 time: 0.010, loss is 3.010
epoch: 100 step:  20 time: 0.009, loss is 2.955
epoch: 125 step:  20 time: 0.008, loss is 0.630
epoch: 150 step:  20 time: 0.008, loss is 0.059
epoch: 175 step:  20 time: 0.009, loss is 0.008
epoch: 200 step:  20 time: 0.008, loss is 0.003
epoch: 225 step:  20 time: 0.017, loss is 0.001
epoch: 250 step:  20 time: 0.008, loss is 0.001
epoch: 275 step:  20 time: 0.016, loss is 0.000
epoch: 300 step:  20 time: 0.008, loss is 0.000
epoch: 325 step:  20 time: 0.016, loss is 0.000
epoch: 350 step:  20 time: 0.008, loss is 0.000
Total time used: 5.06074857711792
</pre></div></div>
</div>
<p>打印收敛过程中的损失函数值：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_monitor</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>得到收敛图为</p>
<p><img alt="classical nlp loss" src="https://gitee.com/mindspore/docs/raw/r1.2/tutorials/training/source_zh_cn/advanced_use/images/classical_nlp_loss.png" /></p>
<p>由上可知，通过量子模拟得到的量子版词嵌入模型也能很好的完成嵌入任务。当数据集大到经典计算机算力难以承受时，量子计算机将能够轻松处理这类问题。</p>
</section>
<section id="参考文献">
<h2>参考文献<a class="headerlink" href="#参考文献" title="Permalink to this headline"></a></h2>
<p>[1] Tomas Mikolov, Kai Chen, Greg Corrado, Jeffrey Dean. <a class="reference external" href="https://arxiv.org/pdf/1301.3781.pdf">Efficient Estimation of Word Representations in Vector Space</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parameterized_quantum_circuit.html" class="btn btn-neutral float-left" title="参数化量子线路" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debug_in_pynative_mode.html" class="btn btn-neutral float-right" title="使用PyNative模式调试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>