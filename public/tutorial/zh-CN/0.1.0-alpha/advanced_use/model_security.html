

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>模型安全 &mdash; MindSpore 0.1.0-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="如何参与社区" href="community.html" />
    <link rel="prev" title="端侧推理" href="on_device_inference.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
</ul>
<p class="caption"><span class="caption-text">使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation/data_preparation.html">准备数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/saving_and_loading_model_parameters.html">模型参数的保存和加载</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/debugging_in_pynative_mode.html">使用PyNative模式调试</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶使用</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">训练过程可视</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_precision.html">混合精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_training.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision_application.html">计算机视觉应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="nlp_application.html">自然语言处理应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="customized_debugging_information.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="on_device_inference.html">端侧推理</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">模型安全</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">建立被攻击模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">引入相关包</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">加载数据集</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">建立模型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">对抗性攻击</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">对抗性防御</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">防御实现</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">防御效果</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="community.html">如何参与社区</a></li>
</ul>
<p class="caption"><span class="caption-text">声明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../statement/legal_statement.html">法律声明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../statement/privacy_policy.html">个人信息保护政策</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>模型安全</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced_use/model_security.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>模型安全<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<!-- TOC --><ul class="simple">
<li><p><a class="reference external" href="#%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8">模型安全</a></p>
<ul>
<li><p><a class="reference external" href="#%E6%A6%82%E8%BF%B0">概述</a></p></li>
<li><p><a class="reference external" href="#%E5%BB%BA%E7%AB%8B%E8%A2%AB%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9E%8B">建立被攻击模型</a></p>
<ul>
<li><p><a class="reference external" href="#%E5%BC%95%E5%85%A5%E7%9B%B8%E5%85%B3%E5%8C%85">引入相关包</a></p></li>
<li><p><a class="reference external" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E9%9B%86">加载数据集</a></p></li>
<li><p><a class="reference external" href="#%E5%BB%BA%E7%AB%8B%E6%A8%A1%E5%9E%8B">建立模型</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#%E5%AF%B9%E6%8A%97%E6%80%A7%E6%94%BB%E5%87%BB">对抗性攻击</a></p></li>
<li><p><a class="reference external" href="#%E5%AF%B9%E6%8A%97%E6%80%A7%E9%98%B2%E5%BE%A1">对抗性防御</a></p>
<ul>
<li><p><a class="reference external" href="#%E9%98%B2%E5%BE%A1%E5%AE%9E%E7%8E%B0">防御实现</a></p></li>
<li><p><a class="reference external" href="#%E9%98%B2%E5%BE%A1%E6%95%88%E6%9E%9C">防御效果</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC --><div class="section" id="id2">
<h2>概述<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>本教程介绍MindArmour提供的模型安全防护手段，引导您快速使用MindArmour，为您的AI模型提供一定的安全防护能力。</p>
<p>AI算法设计之初普遍未考虑相关的安全威胁，使得AI算法的判断结果容易被恶意攻击者影响，导致AI系统判断失准。攻击者在原始样本处加入人类不易察觉的微小扰动，导致深度学习模型误判，称为对抗样本攻击。MindArmour模型安全提供对抗样本生成、对抗样本检测、模型防御、攻防效果评估等功能，为AI模型安全研究和AI应用安全提供重要支撑。</p>
<ul class="simple">
<li><p>对抗样本生成模块支持安全工程师快速高效地生成对抗样本，用于攻击AI模型。</p></li>
<li><p>对抗样本检测、防御模块支持用户检测过滤对抗样本、增强AI模型对于对抗样本的鲁棒性。</p></li>
<li><p>评估模块提供多种指标全面评估对抗样本攻防性能。</p></li>
</ul>
<p>这里通过图像分类任务上的对抗性攻防，以攻击算法FGSM和防御算法NAD为例，介绍MindArmour在对抗攻防上的使用方法。</p>
<blockquote>
<div><p>你可以在这里找到完整可运行的样例代码：
攻击代码：<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r0.1/tutorials/tutorial_code/model_safety/mnist_attack_fgsm.py">https://gitee.com/mindspore/docs/tree/r0.1/tutorials/tutorial_code/model_safety/mnist_attack_fgsm.py</a>
防御代码：<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r0.1/tutorials/tutorial_code/model_safety/mnist_defense_nad.py">https://gitee.com/mindspore/docs/tree/r0.1/tutorials/tutorial_code/model_safety/mnist_defense_nad.py</a></p>
</div></blockquote>
</div>
<div class="section" id="id3">
<h2>建立被攻击模型<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>以MNIST为示范数据集，自定义的简单模型作为被攻击模型。</p>
<div class="section" id="id4">
<h3>引入相关包<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">softmax</span>

<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dataset</span> <span class="k">as</span> <span class="n">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.common.dtype</span> <span class="k">as</span> <span class="nn">mstype</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.vision.c_transforms</span> <span class="k">as</span> <span class="nn">CV</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.transforms.vision</span> <span class="kn">import</span> <span class="n">Inter</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.ops.operations</span> <span class="k">as</span> <span class="nn">P</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">TruncatedNormal</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore.train.serialization</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>

<span class="kn">from</span> <span class="nn">mindarmour.attacks.gradient_method</span> <span class="kn">import</span> <span class="n">FastGradientSignMethod</span>
<span class="kn">from</span> <span class="nn">mindarmour.utils.logger</span> <span class="kn">import</span> <span class="n">LogUtil</span>
<span class="kn">from</span> <span class="nn">mindarmour.evaluations.attack_evaluation</span> <span class="kn">import</span> <span class="n">AttackEvaluate</span>

<span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span> <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;Ascend&quot;</span><span class="p">)</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LogUtil</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
<span class="n">TAG</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>加载数据集<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>利用MindSpore的dataset提供的MnistDataset接口加载MNIST数据集。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate training data</span>
<span class="k">def</span> <span class="nf">generate_mnist_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataset for training or testing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define dataset</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># define operation parameters</span>
    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># define map operations</span>
    <span class="n">resize_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">),</span>
                         <span class="n">interpolation</span><span class="o">=</span><span class="n">Inter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
    <span class="n">rescale_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">hwc2chw_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">one_hot_enco</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">OneHot</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># apply map operations on images</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="p">:</span>
        <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">one_hot_enco</span><span class="p">,</span>
                      <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
        <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">resize_op</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">rescale_op</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">=</span><span class="n">hwc2chw_op</span><span class="p">,</span>
                  <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>

    <span class="c1"># apply DatasetOps</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ds1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds1</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>建立模型<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>这里以LeNet模型为例，您也可以建立训练自己的模型。</p>
<ol>
<li><p>定义LeNet模型网络。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">conv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span>
                     <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
                     <span class="n">weight_init</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">has_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fc_with_initialize</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">weight_variable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">weight_variable</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TruncatedNormal</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LeNet5</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lenet network</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeNet5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">fc_with_initialize</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Reshape</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</li>
<li><p>加载预训练的LeNet模型，您也可以训练并保存自己的MNIST模型，参考快速入门。利用上面定义的数据加载函数<code class="docutils literal notranslate"><span class="pre">generate_mnist_dataset</span></code>载入数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ckpt_name</span> <span class="o">=</span> <span class="s1">&#39;./trained_ckpt_file/checkpoint_lenet-10_1875.ckpt&#39;</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">()</span>
<span class="n">load_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_name</span><span class="p">)</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">load_dict</span><span class="p">)</span>

<span class="c1"># get test data</span>
<span class="n">data_list</span> <span class="o">=</span> <span class="s2">&quot;./MNIST_unzip/test&quot;</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">generate_mnist_dataset</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>测试模型。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># prediction accuracy before attack</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="n">batch_num</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># the number of batches of attacking samples</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">predict_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">():</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">test_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">test_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">images</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">predict_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">batch_num</span><span class="p">:</span>
        <span class="k">break</span>
<span class="n">predict_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">predict_labels</span><span class="p">)</span>
<span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">predict_labels</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">))</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&quot;prediction accuracy before attacking is : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
</div>
<p>测试结果中分类精度达到了98%。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">prediction</span> <span class="n">accuracy</span> <span class="n">before</span> <span class="n">attacking</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.9895833333333334</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="id7">
<h2>对抗性攻击<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>调用MindArmour提供的FGSM接口（FastGradientSignMethod）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># attacking</span>
<span class="n">attack</span> <span class="o">=</span> <span class="n">FastGradientSignMethod</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
<span class="n">adv_data</span> <span class="o">=</span> <span class="n">attack</span><span class="o">.</span><span class="n">batch_generate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_images</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;./adv_data&#39;</span><span class="p">,</span> <span class="n">adv_data</span><span class="p">)</span>
<span class="n">pred_logits_adv</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">adv_data</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="c1"># rescale predict confidences into (0, 1).</span>
<span class="n">pred_logits_adv</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">pred_logits_adv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pred_labels_adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred_logits_adv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">accuracy_adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">pred_labels_adv</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">))</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&quot;prediction accuracy after attacking is : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">accuracy_adv</span><span class="p">)</span>
<span class="n">attack_evaluate</span> <span class="o">=</span> <span class="n">AttackEvaluate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span>
                                 <span class="n">adv_data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="n">pred_logits_adv</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;mis-classification rate of adversaries is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">mis_classification_rate</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average confidence of adversarial class is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_conf_adv_class</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average confidence of true class is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_conf_true_class</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average distance (l0, l2, linf) between original &#39;</span>
            <span class="s1">&#39;samples and adversarial samples are: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_lp_distance</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average structural similarity between original &#39;</span>
            <span class="s1">&#39;samples and adversarial samples are: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_ssim</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average costing time is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">batch_num</span><span class="o">*</span><span class="n">batch_size</span><span class="p">))</span>
</pre></div>
</div>
<p>攻击结果如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">prediction</span> <span class="n">accuracy</span> <span class="n">after</span> <span class="n">attacking</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.052083</span>
<span class="n">mis</span><span class="o">-</span><span class="n">classification</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">adversaries</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.947917</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">confidence</span> <span class="n">of</span> <span class="n">adversarial</span> <span class="k">class</span> <span class="nc">is</span> <span class="p">:</span> <span class="mf">0.419824</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">confidence</span> <span class="n">of</span> <span class="n">true</span> <span class="k">class</span> <span class="nc">is</span> <span class="p">:</span> <span class="mf">0.070650</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">distance</span> <span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span> <span class="n">between</span> <span class="n">original</span> <span class="n">samples</span> <span class="ow">and</span> <span class="n">adversarial</span> <span class="n">samples</span> <span class="n">are</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.698870</span><span class="p">,</span> <span class="mf">0.465888</span><span class="p">,</span> <span class="mf">0.300000</span><span class="p">)</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">structural</span> <span class="n">similarity</span> <span class="n">between</span> <span class="n">original</span> <span class="n">samples</span> <span class="ow">and</span> <span class="n">adversarial</span> <span class="n">samples</span> <span class="n">are</span><span class="p">:</span> <span class="mf">0.332538</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">costing</span> <span class="n">time</span> <span class="ow">is</span> <span class="mf">0.003125</span>
</pre></div>
</div>
<p>对模型进行FGSM无目标攻击后，模型精度由98.9%降到5.2%，误分类率高达95%，成功攻击的对抗样本的预测类别的平均置信度（ACAC）为 0.419824，成功攻击的对抗样本的真实类别的平均置信度（ACTC）为 0.070650，同时给出了生成的对抗样本与原始样本的零范数距离、二范数距离和无穷范数距离，平均每个对抗样本与原始样本间的结构相似性为0.332538，平均每生成一张对抗样本所需时间为0.003125s。</p>
<p>攻击前后效果如下图，左侧为原始样本，右侧为FGSM无目标攻击后生成的对抗样本。从视觉角度而言，右侧图片与左侧图片几乎没有明显变化，但是均成功误导了模型，使模型将其误分类为其他非正确类别。</p>
<p><img alt="adv_attack_result" src="../_images/adv_attack_result.png" /></p>
</div>
<div class="section" id="id8">
<h2>对抗性防御<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>NaturalAdversarialDefense（NAD）是一种简单有效的对抗样本防御方法，使用对抗训练的方式，在模型训练的过程中构建对抗样本，并将对抗样本与原始样本混合，一起训练模型。随着训练次数的增加，模型在训练的过程中提升对于对抗样本的鲁棒性。NAD算法使用FGSM作为攻击算法，构建对抗样本。</p>
<div class="section" id="id9">
<h3>防御实现<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>调用MindArmour提供的NAD防御接口（NaturalAdversarialDefense）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">SoftmaxCrossEntropyWithLogits</span>
<span class="kn">from</span> <span class="nn">mindarmour.defenses</span> <span class="kn">import</span> <span class="n">NaturalAdversarialDefense</span>

<span class="n">loss</span> <span class="o">=</span> <span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">is_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">)</span>

<span class="n">nad</span> <span class="o">=</span> <span class="n">NaturalAdversarialDefense</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                                <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
<span class="n">nad</span><span class="o">.</span><span class="n">batch_defense</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_images</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># get accuracy of test data on defensed model</span>
<span class="n">net</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">acc_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pred_logits_adv</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_num</span><span class="p">):</span>
    <span class="n">batch_inputs</span> <span class="o">=</span> <span class="n">test_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">batch_labels</span> <span class="o">=</span> <span class="n">test_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">batch_inputs</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">pred_logits_adv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
    <span class="n">label_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">batch_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">label_pred</span><span class="p">))</span>
<span class="n">pred_logits_adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pred_logits_adv</span><span class="p">)</span>
<span class="n">pred_logits_adv</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">pred_logits_adv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;accuracy of TEST data on defensed model is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc_list</span><span class="p">))</span>
<span class="n">acc_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_num</span><span class="p">):</span>
    <span class="n">batch_inputs</span> <span class="o">=</span> <span class="n">adv_data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">]</span>
    <span class="n">batch_labels</span> <span class="o">=</span> <span class="n">test_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">batch_inputs</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">label_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">batch_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">label_pred</span><span class="p">))</span>

<span class="n">attack_evaluate</span> <span class="o">=</span> <span class="n">AttackEvaluate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_images</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">test_labels</span><span class="p">),</span>
                                 <span class="n">adv_data</span><span class="p">,</span>
                                 <span class="n">pred_logits_adv</span><span class="p">)</span>

<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;accuracy of adv data on defensed model is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc_list</span><span class="p">))</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;defense mis-classification rate of adversaries is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">mis_classification_rate</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average confidence of adversarial class is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_conf_adv_class</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average confidence of true class is : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_conf_true_class</span><span class="p">())</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s1">&#39;The average distance (l0, l2, linf) between original &#39;</span>
            <span class="s1">&#39;samples and adversarial samples are: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">attack_evaluate</span><span class="o">.</span><span class="n">avg_lp_distance</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>防御效果<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">accuracy</span> <span class="n">of</span> <span class="n">TEST</span> <span class="n">data</span> <span class="n">on</span> <span class="n">defensed</span> <span class="n">model</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.973958</span>
<span class="n">accuracy</span> <span class="n">of</span> <span class="n">adv</span> <span class="n">data</span> <span class="n">on</span> <span class="n">defensed</span> <span class="n">model</span> <span class="ow">is</span> <span class="p">:</span>  <span class="mf">0.521835</span>
<span class="n">defense</span> <span class="n">mis</span><span class="o">-</span><span class="n">classification</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">adversaries</span> <span class="ow">is</span> <span class="p">:</span> <span class="mf">0.026042</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">confidence</span> <span class="n">of</span> <span class="n">adversarial</span> <span class="k">class</span> <span class="nc">is</span> <span class="p">:</span> <span class="mf">0.67979</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">confidence</span> <span class="n">of</span> <span class="n">true</span> <span class="k">class</span> <span class="nc">is</span> <span class="p">:</span> <span class="mf">0.19144624</span>
<span class="n">The</span> <span class="n">average</span> <span class="n">distance</span> <span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">linf</span><span class="p">)</span> <span class="n">between</span> <span class="n">original</span> <span class="n">samples</span> <span class="ow">and</span> <span class="n">adversarial</span> <span class="n">samples</span> <span class="n">are</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.544365</span><span class="p">,</span> <span class="mf">0.439001</span><span class="p">,</span> <span class="mf">0.300000</span><span class="p">)</span>
</pre></div>
</div>
<p>使用NAD进行对抗样本防御后，模型对于对抗样本的误分类率从95%降至48%，模型有效地防御了对抗样本。同时，模型对于原来测试数据集的分类精度达97%，使用NAD防御功能，并未降低模型的分类精度。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="community.html" class="btn btn-neutral float-right" title="如何参与社区" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="on_device_inference.html" class="btn btn-neutral float-left" title="端侧推理" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, MindSpore

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>