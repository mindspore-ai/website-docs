<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>自然语言处理应用 &mdash; MindSpore 0.3.0-alpha documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="使用PyNative模式调试" href="debugging_in_pynative_mode.html" />
    <link rel="prev" title="计算机视觉应用" href="computer_vision_application.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_start.html">实现一个图片分类应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/quick_video.html">手把手安装和体验</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use/data_preparation/data_preparation.html">准备数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/defining_the_network.html">定义网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/saving_and_loading_model_parameters.html">模型参数的保存和加载</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/multi_platform_inference.html">多平台推理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">应用实践</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="computer_vision_application.html">计算机视觉应用</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">自然语言处理应用</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">准备及设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">下载数据集</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">确定评价标准</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">确定网络及流程</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">实现阶段</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">导入需要的库文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">配置环境信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">预处理数据集</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">定义网络</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">定义优化器及损失函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">训练并保存模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">模型验证</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id15">实验结果</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型调优</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="debugging_in_pynative_mode.html">使用PyNative模式调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="customized_debugging_information.html">自定义调试信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization_tutorials.html">训练过程可视</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">性能优化</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorials.html">分布式并行训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_precision.html">混合精度</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">端云使用</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="use_on_the_cloud.html">在云上使用MindSpore</a></li>
<li class="toctree-l1"><a class="reference internal" href="on_device_inference.html">端侧推理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">网络迁移</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="network_migration.html">网络迁移</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AI安全和隐私</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="model_security.html">模型安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="differential_privacy.html">机器学习中的差分隐私</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>自然语言处理应用</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/advanced_use/nlp_application.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>自然语言处理应用<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r0.3/tutorials/source_zh_cn/advanced_use/nlp_application.md" target="_blank"><img src="../_static/logo_source.png"></a></p>
<section id="id2">
<h2>概述<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<p>情感分类是自然语言处理中文本分类问题的子集，属于自然语言处理最基础的应用。它是对带有感情色彩的主观性文本进行分析和推理的过程，即分析说话人的态度，是倾向正面还是反面。</p>
<blockquote>
<div><p>通常情况下，我们会把情感类别分为正面、反面和中性三类。虽然“面无表情”的评论也有不少；不过，大部分时候会只采用正面和反面的案例进行训练，下面这个数据集就是很好的例子。</p>
</div></blockquote>
<p>传统的文本主题分类问题的典型参考数据集为<a class="reference external" href="http://qwone.com/~jason/20Newsgroups/">20 Newsgroups</a>，该数据集由20组新闻数据组成，包含约20000个新闻文档。
其主题列表中有些类别的数据比较相似，例如comp.sys.ibm.pc.hardware和comp.sys.mac.hardware都是和电脑系统硬件相关的题目，相似度比较高。而有些主题类别的数据相对来说就毫无关联，例如misc.forsale和soc.religion.christian。</p>
<p>就网络本身而言，文本主题分类的网络结构和情感分类的网络结构大致相似。在掌握了情感分类网络如何构造之后，很容易可以构造一个类似的网络，稍作调参即可用于文本主题分类任务。</p>
<p>但在业务上下文侧，文本主题分类是分析文本讨论的客观内容，而情感分类是要从文本中得到它是否支持某种观点的信息。比如，“《阿甘正传》真是好看极了，影片主题明确，节奏流畅。”这句话，在文本主题分类是要将其归为类别为“电影”主题，而情感分类则要挖掘出这一影评的态度是正面还是负面。</p>
<p>相对于传统的文本主题分类，情感分类较为简单，实用性也较强。常见的购物网站、电影网站都可以采集到相对高质量的数据集，也很容易给业务领域带来收益。例如，可以结合领域上下文，自动分析特定类型客户对当前产品的意见，可以分主题分用户类型对情感进行分析，以作针对性的处理，甚至基于此进一步推荐产品，提高转化率，带来更高的商业收益。</p>
<p>特殊领域中，某些非极性词也充分表达了用户的情感倾向，比如下载使用APP时，“卡死了”、“下载太慢了”就表达了用户的负面情感倾向；股票领域中，“看涨”、“牛市”表达的就是用户的正面情感倾向。所以，本质上，我们希望模型能够在垂直领域中，挖掘出一些特殊的表达，作为极性词给情感分类系统使用：</p>
<p><span class="math notranslate nohighlight">\(垂直极性词 = 通用极性词 + 领域特有极性词\)</span></p>
<p>按照处理文本的粒度不同，情感分析可分为词语级、短语级、句子级、段落级以及篇章级等几个研究层次。这里以“段落级”为例，输入为一个段落，输出为影评是正面还是负面的信息。</p>
</section>
<section id="id3">
<h2>准备及设计<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<section id="id4">
<h3>下载数据集<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<p>采用IMDB影评数据集作为实验数据。</p>
<blockquote>
<div><p>数据集下载地址：<a class="reference external" href="http://ai.stanford.edu/~amaas/data/sentiment/">http://ai.stanford.edu/~amaas/data/sentiment/</a></p>
</div></blockquote>
<p>以下是负面影评（Negative）和正面影评（Positive）的案例。</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Review</p></th>
<th class="head"><p>Label</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>“Quitting” may be as much about exiting a pre-ordained identity as about drug withdrawal. As a rural guy coming to Beijing, class and success must have struck this young artist face on as an appeal to separate from his roots and far surpass his peasant parents’ acting success. Troubles arise, however, when the new man is too new, when it demands too big a departure from family, history, nature, and personal identity. The ensuing splits, and confusion between the imaginary and the real and the dissonance between the ordinary and the heroic are the stuff of a gut check on the one hand or a complete escape from self on the other.</p></td>
<td><p>Negative</p></td>
</tr>
<tr class="row-odd"><td><p>This movie is amazing because the fact that the real people portray themselves and their real life experience and do such a good job it’s like they’re almost living the past over again. Jia Hongsheng plays himself an actor who quit everything except music and drugs struggling with depression and searching for the meaning of life while being angry at everyone especially the people who care for him most.</p></td>
<td><p>Positive</p></td>
</tr>
</tbody>
</table>
<p>同时，我们要下载GloVe文件，并在文件开头处添加新的一行，意思是总共读取400000个单词，每个单词用300纬度的词向量表示。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">400000</span> <span class="mi">300</span>
</pre></div>
</div>
<p>GloVe文件下载地址：<a class="reference external" href="http://nlp.stanford.edu/data/glove.6B.zip">http://nlp.stanford.edu/data/glove.6B.zip</a>。</p>
</section>
<section id="id5">
<h3>确定评价标准<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<p>作为典型的分类问题，情感分类的评价标准可以比照普通的分类问题处理。常见的精度（Accuracy）、精准度（Precision）、召回率（Recall）和F_beta分数都可以作为参考。</p>
<p><span class="math notranslate nohighlight">\(精度（Accuracy）= 分类正确的样本数目 / 总样本数目\)</span></p>
<p><span class="math notranslate nohighlight">\(精准度（Precision）= 真阳性样本数目 / 所有预测类别为阳性的样本数目\)</span></p>
<p><span class="math notranslate nohighlight">\(召回率（Recall）= 真阳性样本数目 / 所有真实类别为阳性的样本数目\)</span></p>
<p><span class="math notranslate nohighlight">\(F1分数 = (2 * Precision * Recall) / (Precision + Recall)\)</span></p>
<p>在IMDB这个数据集中，正负样本数差别不大，可以简单地用精度（accuracy）作为分类器的衡量标准。</p>
</section>
<section id="id6">
<h3>确定网络及流程<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<p>我们使用LSTM网络进行自然语言处理。</p>
<ol class="arabic">
<li><p>加载使用的数据集，并进行必要的数据处理。</p></li>
<li><p>使用LSTM网络训练数据，生成模型。</p>
<blockquote>
<div><p>LSTM（Long short-term memory，长短期记忆）网络是一种时间循环神经网络，适合于处理和预测时间序列中间隔和延迟非常长的重要事件。具体介绍可参考网上资料，在此不再赘述。</p>
</div></blockquote>
</li>
<li><p>得到模型之后，使用验证数据集，查看模型精度情况。</p></li>
</ol>
<blockquote>
<div><p>本例面向GPU硬件平台，你可以在这里下载完整的样例代码：<a class="reference external" href="https://gitee.com/mindspore/docs/tree/r0.3/tutorials/tutorial_code/lstm">https://gitee.com/mindspore/docs/tree/r0.3/tutorials/tutorial_code/lstm</a></p>
<ul class="simple">
<li><p>main.py：代码文件，包括数据预处理、网络定义、模型训练等代码。</p></li>
<li><p>config.py：网络中的一些配置，包括batch size、进行几次epoch训练等。</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="id7">
<h2>实现阶段<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h2>
<section id="id8">
<h3>导入需要的库文件<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h3>
<p>下列是我们所需要的公共模块及MindSpore的模块及库文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">lstm_cfg</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="c1"># Install gensim with &#39;pip install gensim&#39;</span>
<span class="kn">import</span> <span class="nn">gensim</span>

<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.context</span> <span class="k">as</span> <span class="nn">context</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">operations</span> <span class="k">as</span> <span class="n">P</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">initializer</span>
<span class="kn">from</span> <span class="nn">mindspore.common.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">mindspore.mindrecord</span> <span class="kn">import</span> <span class="n">FileWriter</span>
<span class="kn">from</span> <span class="nn">mindspore.train</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindspore.nn.metrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>
<span class="kn">from</span> <span class="nn">mindspore.train.serialization</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span><span class="p">,</span> <span class="n">LossMonitor</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>配置环境信息<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>使用<code class="docutils literal notranslate"><span class="pre">parser</span></code>模块，传入运行必要的信息，如数据集存放路径，GloVe存放路径，这样的好处是，对于经常变化的配置，可以在运行代码时输入，使用更加灵活。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;MindSpore LSTM Example&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--preprocess&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">],</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to perform data preprocessing&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mode&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;implement phase, set to train or test&#39;</span><span class="p">)</span>
<span class="c1"># Download dataset from &#39;http://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz&#39; and extract to &#39;aclimdb_path&#39;</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--aclimdb_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./aclImdb&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the dataset is store&#39;</span><span class="p">)</span>
<span class="c1"># Download GloVe from &#39;http://nlp.stanford.edu/data/glove.6B.zip&#39; and extract to &#39;glove_path&#39;</span>
<span class="c1"># Add a new line &#39;400000 300&#39; at the beginning of &#39;glove.6B.300d.txt&#39; with &#39;40000&#39; for total words and &#39;300&#39; for vector length</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--glove_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./glove&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the GloVe is store&#39;</span><span class="p">)</span>
<span class="c1"># Specify the path to save preprocessed data</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--preprocess_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./preprocess&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where the pre-process data is store&#39;</span><span class="p">)</span>
<span class="c1"># Specify the path to save the CheckPoint file</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ckpt_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./ckpt&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;if mode is test, must provide</span><span class="se">\</span>
<span class="s1">                    path where the trained ckpt file&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>实现代码前，需要配置必要的信息，包括环境信息、执行的模式、后端信息及硬件信息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span>
    <span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>详细的接口配置信息，请参见<code class="docutils literal notranslate"><span class="pre">context.set_context</span></code>接口说明。</p>
</li>
</ol>
</section>
<section id="id10">
<h3>预处理数据集<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>对文本数据集进行处理，包括编码、分词、对齐、处理GloVe原始数据，使之能够适应网络结构。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read data from the specified directory</span>
<span class="k">def</span> <span class="nf">read_imdb</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; read imdb dataset &quot;&quot;&quot;</span>
    <span class="n">pos_or_neg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pos_or_neg</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
                <span class="n">review</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">review</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">review</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Split records into words with spaces as separators</span>
<span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>

<span class="c1"># Encode words into vectors</span>
<span class="k">def</span> <span class="nf">encode_samples</span><span class="p">(</span><span class="n">tokenized_samples</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; encode word to index &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">tokenized_samples</span><span class="p">:</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">word_to_idx</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Align the number of words in each record to 500 words</span>
<span class="k">def</span> <span class="nf">pad_samples</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; pad all features to the same length &quot;&quot;&quot;</span>
    <span class="n">padded_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxlen</span><span class="p">:</span>
            <span class="n">padded_feature</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[:</span><span class="n">maxlen</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padded_feature</span> <span class="o">=</span> <span class="n">feature</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_feature</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">:</span>
                <span class="n">padded_feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">padded_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_feature</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">padded_features</span>

<span class="c1"># Crop GloVe raw data into a table which contains about 25,000 word vectors</span>
<span class="k">def</span> <span class="nf">collect_weight</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; collect weight &quot;&quot;&quot;</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">wvmodel</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">KeyedVectors</span><span class="o">.</span><span class="n">load_word2vec_format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="s1">&#39;glove.6B.300d.txt&#39;</span><span class="p">),</span>
                                                            <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">weight_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vocab_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">idx_to_word</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">word</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>
    <span class="n">idx_to_word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">word_to_idx</span><span class="p">[</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">weight_np</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wvmodel</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span>
            <span class="n">idx_to_word</span><span class="p">[</span><span class="n">word_to_idx</span><span class="p">[</span><span class="n">wvmodel</span><span class="o">.</span><span class="n">index2word</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>
    <span class="k">return</span> <span class="n">weight_np</span>

<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; preprocess the train and test data &quot;&quot;&quot;</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">read_imdb</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="n">train_tokenized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_tokenized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">review</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
        <span class="n">train_tokenized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">review</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">review</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
        <span class="n">test_tokenized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">review</span><span class="p">))</span>

    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">train_tokenized</span><span class="p">))</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vocab_size: &quot;</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>

    <span class="n">word_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>
    <span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">train_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pad_samples</span><span class="p">(</span><span class="n">encode_samples</span><span class="p">(</span><span class="n">train_tokenized</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">test_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pad_samples</span><span class="p">(</span><span class="n">encode_samples</span><span class="p">(</span><span class="n">test_tokenized</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">test_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">score</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">weight_np</span> <span class="o">=</span> <span class="n">collect_weight</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">weight_np</span><span class="p">,</span> <span class="n">vocab_size</span>

</pre></div>
</div>
</li>
<li><p>将数据集格式转化为<code class="docutils literal notranslate"><span class="pre">mindrecord</span></code>格式，便于MindSpore读取。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_imdb_data</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="n">features_data</span><span class="p">):</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels_data</span><span class="p">,</span> <span class="n">features_data</span><span class="p">)):</span>
        <span class="n">data_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                    <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_list</span>

<span class="c1"># Convert the dataset to mindrecord dateset which is supported by MindSpore</span>
<span class="k">def</span> <span class="nf">convert_to_mindrecord</span><span class="p">(</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">proprocess_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; convert imdb dataset to mindrecord &quot;&quot;&quot;</span>
    <span class="n">num_shard</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">weight_np</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
        <span class="n">preprocess</span><span class="p">(</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">glove_path</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;weight.txt&#39;</span><span class="p">),</span> <span class="n">weight_np</span><span class="p">)</span>

    <span class="c1"># write mindrecord</span>
    <span class="n">schema_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">},</span>
                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}}</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_train.mindrecord&#39;</span><span class="p">),</span> <span class="n">num_shard</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_imdb_data</span><span class="p">(</span><span class="n">train_labels</span><span class="p">,</span> <span class="n">train_features</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">schema_json</span><span class="p">,</span> <span class="s2">&quot;nlp_schema&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_index</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proprocess_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_test.mindrecord&#39;</span><span class="p">),</span> <span class="n">num_shard</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_imdb_data</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">test_features</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">schema_json</span><span class="p">,</span> <span class="s2">&quot;nlp_schema&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_index</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_raw_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Data Pre-processing ==============&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">)</span>
<span class="n">convert_to_mindrecord</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">aclimdb_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">glove_path</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>创建数据集。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">is_train</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create dataset for training.&quot;&quot;&quot;</span>
    <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">num_consumer</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_train.mindrecord0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;aclImdb_test.mindrecord0&#39;</span><span class="p">)</span>

    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MindDataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">columns_list</span><span class="p">,</span> <span class="n">num_consumer</span><span class="p">)</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">dtrain</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">dtrain</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dtrain</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id11">
<h3>定义网络<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>初始化网络参数及网络状态。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_lstm_weight</span><span class="p">(</span>
        <span class="n">input_size</span><span class="p">,</span>
        <span class="n">hidden_size</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">,</span>
        <span class="n">bidirectional</span><span class="p">,</span>
        <span class="n">has_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize lstm weight.&quot;&quot;&quot;</span>
    <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">weight_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gate_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">hidden_size</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_directions</span><span class="p">):</span>
            <span class="n">input_layer_size</span> <span class="o">=</span> <span class="n">input_size</span> <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="n">num_directions</span>
            <span class="n">weight_size</span> <span class="o">+=</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="n">input_layer_size</span>
            <span class="n">weight_size</span> <span class="o">+=</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="n">hidden_size</span>
            <span class="k">if</span> <span class="n">has_bias</span><span class="p">:</span>
                <span class="n">weight_size</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gate_size</span>

    <span class="n">stdv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="n">w_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="p">(</span><span class="n">weight_size</span><span class="p">,</span>
                                        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
        <span class="n">initializer</span><span class="p">(</span>
            <span class="n">Tensor</span><span class="p">(</span><span class="n">w_np</span><span class="p">),</span> <span class="p">[</span>
                <span class="n">weight_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span>

<span class="c1"># Initialize short-term memory (h) and long-term memory (c) to 0</span>
<span class="k">def</span> <span class="nf">lstm_default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;init default input.&quot;&quot;&quot;</span>
    <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">num_directions</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">num_directions</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">num_directions</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span>
</pre></div>
</div>
</li>
<li><p>使用<code class="docutils literal notranslate"><span class="pre">cell</span></code>方法，定义网络结构。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SentimentNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sentiment network structure.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">vocab_size</span><span class="p">,</span>
                <span class="n">embed_size</span><span class="p">,</span>
                <span class="n">num_hiddens</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="p">,</span>
                <span class="n">bidirectional</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="p">,</span>
                <span class="n">weight</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SentimentNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Mapp words to vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span>
                                    <span class="n">embed_size</span><span class="p">,</span>
                                    <span class="n">embedding_table</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embedding_table</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Transpose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">embed_size</span><span class="p">,</span>
                            <span class="n">hidden_size</span><span class="o">=</span><span class="n">num_hiddens</span><span class="p">,</span>
                            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
                            <span class="n">has_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span>
                            <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">w_init</span> <span class="o">=</span> <span class="n">init_lstm_weight</span><span class="p">(</span>
            <span class="n">embed_size</span><span class="p">,</span>
            <span class="n">num_hiddens</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="p">,</span>
            <span class="n">bidirectional</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">w_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">lstm_default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_hiddens</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">bidirectional</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concat</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_hiddens</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_hiddens</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># input：(64,500,300)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perm</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">))</span>
        <span class="c1"># states[i] size(64,200)  -&gt; encoding.size(64,400)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>


<span class="n">embedding_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="s2">&quot;weight.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">SentimentNet</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="n">embedding_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">embed_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">embed_size</span><span class="p">,</span>
                <span class="n">num_hiddens</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_hiddens</span><span class="p">,</span>
                <span class="n">num_layers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                <span class="n">bidirectional</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">,</span>
                <span class="n">num_classes</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">Tensor</span><span class="p">(</span><span class="n">embedding_table</span><span class="p">),</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id12">
<h3>定义优化器及损失函数<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h3>
<p>定义优化器及损失函数的示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">is_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span>
<span class="n">loss_cb</span> <span class="o">=</span> <span class="n">LossMonitor</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3>训练并保存模型<a class="headerlink" href="#id13" title="Permalink to this headline"></a></h3>
<p>加载对应数据集并配置好CheckPoint生成信息，然后使用<code class="docutils literal notranslate"><span class="pre">model.train</span></code>接口，进行模型训练。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">Accuracy</span><span class="p">()})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Training ==============&quot;</span><span class="p">)</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_checkpoint_steps</span><span class="p">,</span>
                                <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;lstm&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_ck</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">,</span> <span class="n">loss_cb</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3>模型验证<a class="headerlink" href="#id14" title="Permalink to this headline"></a></h3>
<p>加载验证数据集及保存的CheckPoint文件，进行验证，查看模型质量。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Starting Testing ==============&quot;</span><span class="p">)</span>
<span class="n">ds_eval</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preprocess_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ckpt_path</span><span class="p">)</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ds_eval</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== Accuracy:</span><span class="si">{}</span><span class="s2"> ==============&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="id15">
<h2>实验结果<a class="headerlink" href="#id15" title="Permalink to this headline"></a></h2>
<p>在经历了10轮epoch之后，在训练集上的精度收敛到约85%，在测试集上的精度约为86%。</p>
<p><strong>执行训练</strong></p>
<ol class="arabic">
<li><p>运行训练代码，查看运行结果。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--preprocess<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--mode<span class="o">=</span>train<span class="w"> </span>--ckpt_path<span class="o">=</span>./ckpt
</pre></div>
</div>
<p>输出如下，可以看到loss值随着训练逐步降低，最后达到0.249左右，即经过10个epoch的训练，对当前文本分析的结果正确率在85%左右：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">==============</span><span class="w"> </span>Starting<span class="w"> </span>Data<span class="w"> </span>Pre-processing<span class="w"> </span><span class="o">==============</span>
vocab_size:<span class="w">  </span><span class="nv">252192</span>
<span class="o">==============</span><span class="w"> </span>Starting<span class="w"> </span><span class="nv">Training</span><span class="w"> </span><span class="o">==============</span>
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:29:02.785.484<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:118<span class="o">]</span><span class="w"> </span>Execute<span class="w"> </span>save<span class="w"> </span>checkpoint<span class="w"> </span>process.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:29:03.658.733<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:143<span class="o">]</span><span class="w"> </span>Save<span class="w"> </span>checkpoint<span class="w"> </span>process<span class="w"> </span>finish.
epoch:<span class="w"> </span><span class="m">1</span><span class="w"> </span>step:<span class="w"> </span><span class="m">390</span><span class="w"> </span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.6926409
...
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:32:18.598.405<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:118<span class="o">]</span><span class="w"> </span>Execute<span class="w"> </span>save<span class="w"> </span>checkpoint<span class="w"> </span>process.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">15831</span>:140036161672960,MainProcess<span class="o">)</span>:2020-03-09-16:32:19.561.926<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:143<span class="o">]</span><span class="w"> </span>Save<span class="w"> </span>checkpoint<span class="w"> </span>process<span class="w"> </span>finish.
epoch:<span class="w"> </span><span class="m">6</span><span class="w"> </span>step:<span class="w"> </span><span class="m">390</span><span class="w"> </span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.222701
...
epoch:<span class="w"> </span><span class="m">10</span><span class="w"> </span>step:<span class="w"> </span><span class="m">390</span><span class="w"> </span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.22616856
epoch:<span class="w"> </span><span class="m">10</span><span class="w"> </span>step:<span class="w"> </span><span class="m">390</span><span class="w"> </span>,<span class="w"> </span>loss<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.24914627
</pre></div>
</div>
</li>
<li><p>查看保存的CheckPoint文件。</p>
<p>训练过程中保存了CheckPoint文件，即模型文件，我们可以查看文件保存的路径下的所有保存文件。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ls<span class="w"> </span>ckpt/
</pre></div>
</div>
<p>输出如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>lstm-10_390.ckpt<span class="w">  </span>lstm-1_390.ckpt<span class="w">  </span>lstm-2_390.ckpt<span class="w">  </span>lstm-3_390.ckpt<span class="w">  </span>lstm-4_390.ckpt<span class="w">  </span>lstm-5_390.ckpt<span class="w">  </span>lstm-6_390.ckpt<span class="w">  </span>lstm-7_390.ckpt<span class="w">  </span>lstm-8_390.ckpt<span class="w">  </span>lstm-9_390.ckpt
</pre></div>
</div>
</li>
</ol>
<p><strong>验证模型</strong></p>
<p>使用最后保存的CheckPoint文件，加载验证数据集，进行验证。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--mode<span class="o">=</span><span class="nb">test</span><span class="w"> </span>--ckpt_path<span class="o">=</span>./ckpt/lstm-10_390.ckpt
</pre></div>
</div>
<p>输出如下，可以看到使用验证的数据集，对文本的情感分析正确率在86%左右，达到一个基本满意的结果。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>RegisterOperatorCreator:OperatorCreators<span class="w"> </span><span class="nv">init</span>
<span class="o">==============</span><span class="w"> </span>Starting<span class="w"> </span><span class="nv">Testing</span><span class="w"> </span><span class="o">==============</span>
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:19.333.605<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:169<span class="o">]</span><span class="w"> </span>Execute<span class="w"> </span>load<span class="w"> </span>checkpoint<span class="w"> </span>process.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.434.749<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:200<span class="o">]</span><span class="w"> </span>Load<span class="w"> </span>checkpoint<span class="w"> </span>process<span class="w"> </span>finish.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.467.336<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:233<span class="o">]</span><span class="w"> </span>Execute<span class="w"> </span>parameter<span class="w"> </span>into<span class="w"> </span>net<span class="w"> </span>process.
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>ME<span class="o">(</span><span class="m">29963</span>:140462460516096,MainProcess<span class="o">)</span>:2020-03-09-16:37:20.467.649<span class="w"> </span><span class="o">[</span>mindspore/train/serialization.py:268<span class="o">]</span><span class="w"> </span>Load<span class="w"> </span>parameter<span class="w"> </span>into<span class="w"> </span>net<span class="w"> </span>process<span class="w"> </span>finish.
<span class="o">==============</span><span class="w"> </span>Accuracy:<span class="o">{</span><span class="s1">&#39;acc&#39;</span>:<span class="w"> </span><span class="m">0</span>.8599358974358975<span class="o">}</span><span class="w"> </span><span class="o">==============</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="computer_vision_application.html" class="btn btn-neutral float-left" title="计算机视觉应用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="debugging_in_pynative_mode.html" class="btn btn-neutral float-right" title="使用PyNative模式调试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
        <script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>