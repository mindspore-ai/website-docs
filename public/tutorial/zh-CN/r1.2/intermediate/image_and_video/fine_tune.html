<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>图像分割模型微调 &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="图像分类迁移学习" href="transfer_learning.html" />
    <link rel="prev" title="图像处理" href="../../image_and_video.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">入门教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">基本介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">初学入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor.html">张量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">数据加载及处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">建立神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autograd.html">自动微分</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization.html">优化模型参数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../save_load_model.html">保存及加载模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inference.html">推理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">进阶教程</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../custom.html">自定义</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../image_and_video.html">图像处理</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">图像分割模型微调</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">数据处理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#coco">COCO数据集说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">编写自定义数据集</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">定义模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">将预训练模型用于微调</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">执行训练</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="transfer_learning.html">图像分类迁移学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="adversarial_example_generation.html">对抗示例生成</a></li>
<li class="toctree-l2"><a class="reference internal" href="dcgan.html">深度卷积对抗生成网络</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../text.html">自然语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pynative_mode_and_graph_mode.html">动态图与静态图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_training.html">分布式训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inference_and_deploy.html">推理与部署</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../image_and_video.html">图像处理</a> &raquo;</li>
      <li>图像分割模型微调</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/intermediate/image_and_video/fine_tune.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="id1">
<h1>图像分割模型微调<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/source_zh_cn/intermediate/image_and_video/fine_tune.md" target="_blank"><img src="https://gitee.com/mindspore/docs/raw/r1.2/resource/_static/logo_source.png"></a></p>
<p>在本教程中，我们将使用COCO数据集当中book分类下的部分图片，对Mask R-CNN模型进行微调，最终实现图像分割的效果。教程通过终端运行，点击下载<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/source-codes/FineTune.zip">代码与数据集</a>。</p>
<blockquote>
<div><p>本篇基于MindSpore v1.2.0，Ascend环境运行。</p>
<p>运行本案例需要安装以下依赖项：</p>
<p>Cython</p>
<p>pycocotools</p>
<p>mmcv==0.2.14</p>
<p>可通过<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code>命令执行代码文件夹中的<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>完成。</p>
</div></blockquote>
<p>图像分割功能可以定位图片中的物体，识别物体的边界轮廓。实际效果大致如下图所示：</p>
<p><img alt="bookmask" src="../../_images/maskrcnn_seg1.png" /></p>
<blockquote>
<div><p>图片来源于<a class="reference external" href="https://cocodataset.org/#home">COCO数据集</a>。</p>
</div></blockquote>
<section id="id2">
<h2>数据处理<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<section id="coco">
<h3>COCO数据集说明<a class="headerlink" href="#coco" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://cocodataset.org/#home">COCO数据集</a>可以用于图片分类、目标检测、图像分割等场景，是一个评估视觉类模型的业界标准数据集。教程中会使用COCO2017版本对模型进行训练，在正式开始执行代码之前先介绍COCO2017的一些基本信息，以便于用户理解整个数据处理的过程。</p>
<p>COCO2017数据集的结构如下，其中<code class="docutils literal notranslate"><span class="pre">annotations</span></code>文件夹为标注信息json文件，<code class="docutils literal notranslate"><span class="pre">train2017</span></code>等文件夹存储了大量图片：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>├── annotations # 储存图片标注信息，分为三种类型
│   ├── captions_train2017.json             # 看图说话，描述图片的内容
│   ├── captions_val2017.json
│   ├── instances_train2017.json            # 目标实例，为本例中使用的类型
│   ├── instances_val2017.json
│   ├── person_keypoints_train2017.json     # 人体关键点检测
│   └── person_keypoints_val2017.json
├── train2017                               # 用于训练的图片
├── test2017                                # 用于测试的图片
├── val2017                                 # 用于验证的图片
</pre></div>
</div>
<p>现在进一步说明实验中用到的<code class="docutils literal notranslate"><span class="pre">instance</span></code>类型标注。COCO数据集标注信息内容较多，下面一步步从大类拆解到细节。总体上，一张图片的标注结构如下所示：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{
    &quot;info&quot;: info,                   # 储存图片版本、创建日期等基本信息
    &quot;licenses&quot;: [license],          # 图片的id、name等license信息
    &quot;images&quot;: [image],              # 图片的id、width、height等形状信息
    &quot;annotations&quot;: [annotation],    # 图片的标注信息
    &quot;categories&quot;: [category]        # 图片的分类信息
}
</pre></div>
</div>
<p>为了实现图片分割的效果，需要解析上面提到的<code class="docutils literal notranslate"><span class="pre">annotations</span></code>字段。<code class="docutils literal notranslate"><span class="pre">annotations</span></code>包含的内容有：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>annotation{
&quot;id&quot; : int,                         # 序号
&quot;image_id&quot; : int,                   # 图片的id，与数据集中的真实图片相对应
&quot;category_id&quot; : int,                # 所属的图片类别
&quot;segmentation&quot; : RLE or [polygon],  # 使用RLE或polygon格式存储图片
&quot;area&quot; : float,                     # 标注区域的面积
&quot;bbox&quot; : [x,y,width,height],        # 物体边界框
&quot;iscrowd&quot; : 0 or 1,                 # 值为0：采用polygon格式；值为1：采用RLE格式
}
</pre></div>
</div>
<p>在数据处理的过程中，会一步步提取出图片、bbox、图片的mask等信息，用于训练Mask R-CNN模型。</p>
</section>
<section id="id3">
<h3>编写自定义数据集<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<p>数据集由180张包含书籍的图片组成，图像与标注均来自于COCO。案例中采用自定义数据集的方式加载，完整数据处理代码可参考<code class="docutils literal notranslate"><span class="pre">src/dataset.py</span></code>。</p>
<p>案例中，构造的自定义数据集类为<code class="docutils literal notranslate"><span class="pre">COCOSubDataset</span></code>，在训练过程中会通过<code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code>接口加载并访问数据集。</p>
<p><code class="docutils literal notranslate"><span class="pre">COCOSubDataset</span></code>包含三部分。首先，在类函数<code class="docutils literal notranslate"><span class="pre">__init__</span></code>中完成数据初始化，并且一步步解析出COCO数据集的图像，以及json中储存的bbox、mask、iscrowd等信息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">COCOSubDataset</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coco_root</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train_data_type</span>

        <span class="c1"># 调用COCO数据集的接口读取数据</span>
        <span class="n">anno_json</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coco_root</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">instance_set</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span>
        <span class="n">coco</span> <span class="o">=</span> <span class="n">COCO</span><span class="p">(</span><span class="n">anno_json</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_anno_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_shape</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 读取分类的类别信息</span>
        <span class="n">train_cls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">coco_classes</span>
        <span class="n">train_cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_cls</span><span class="p">):</span>
            <span class="n">train_cls_dict</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">classs_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cat_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">loadCats</span><span class="p">(</span><span class="n">coco</span><span class="o">.</span><span class="n">getCatIds</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_ids</span><span class="p">:</span>
            <span class="n">classs_dict</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="c1"># 读取数据集中的图像、mask、mask_shape</span>
        <span class="n">image_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">getImgIds</span><span class="p">()</span>
        <span class="n">images_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_ids</span><span class="p">):</span>
            <span class="n">image_info</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">loadImgs</span><span class="p">(</span><span class="n">img_id</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">image_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span>
            <span class="n">anno_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">getAnnIds</span><span class="p">(</span><span class="n">imgIds</span><span class="o">=</span><span class="n">img_id</span><span class="p">,</span> <span class="n">iscrowd</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">anno</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">loadAnns</span><span class="p">(</span><span class="n">anno_ids</span><span class="p">)</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coco_root</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="n">annos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">instance_masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">image_height</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
            <span class="n">image_width</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>

            <span class="c1"># 进一步处理，获取图像的mask、box、iscrowd和分类信息</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">anno</span><span class="p">:</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="n">classs_dict</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">train_cls</span><span class="p">:</span>
                    <span class="c1"># 获取二进制的coco mask</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">annToMask</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;all black mask!!!!&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># 根据对象是单个还是一组处理mask数据</span>
                    <span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="s1">&#39;iscrowd&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">image_height</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">image_width</span><span class="p">):</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                    <span class="n">instance_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

                    <span class="c1"># 获取coco数据集中的bounding box</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">annos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">train_cls_dict</span><span class="p">[</span><span class="n">class_name</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not in classes: &quot;</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

                <span class="c1"># 获取图像、标注信息、mask与mask shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_anno_dict</span><span class="p">[</span><span class="n">image_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annos</span><span class="p">)</span>
                <span class="n">instance_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">instance_masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">image_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instance_masks</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">masks_shape</span><span class="p">[</span><span class="n">image_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">instance_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
</div>
<p>然后在<code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>方法中，返回单个图像和与图像关联的分割信息，返回值包括：</p>
<ul class="simple">
<li><p>img：图像</p></li>
<li><p>annos：图像的bbox、所属分类和iscrowd信息</p></li>
<li><p>mask：二进制的图像分割蒙版</p></li>
<li><p>mask_shape：图像分割蒙版shape</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">annos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_anno_dict</span><span class="p">[</span><span class="n">image_name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">image_name</span><span class="p">]</span>
    <span class="n">mask_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_shape</span><span class="p">[</span><span class="n">image_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">annos</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_shape</span>
</pre></div>
</div>
<p>最后，<code class="docutils literal notranslate"><span class="pre">__len__</span></code>返回数据集的大小。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">)</span>
</pre></div>
</div>
<p>在数据集加载过程中，通过<code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code>接口调用自定义的数据集，并完成<code class="docutils literal notranslate"><span class="pre">map</span></code>操作处理数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_new_dataset</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;创建用于训练的数据集&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">setNumThreads</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">de</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_prefetch_size</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="c1"># 读取自定义数据集</span>
    <span class="n">subcoco_dataset</span> <span class="o">=</span> <span class="n">COCOSubDataset</span><span class="p">(</span><span class="n">coco_root</span><span class="o">=</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="n">is_training</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">dataset_column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;annotation&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;mask_shape&quot;</span><span class="p">]</span>

    <span class="c1"># 完成自定义数据集加载</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">de</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">subcoco_dataset</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="n">dataset_column_names</span><span class="p">,</span>
                             <span class="n">num_shards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">is_training</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 解码图像</span>
    <span class="n">decode</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">Decode</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">decode</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span>

    <span class="c1"># 通过map完成数据的过程处理，标注图像的label、box、valid_num</span>
    <span class="n">compose_map_func</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">image</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_shape</span><span class="p">:</span>
                        <span class="n">preprocess_fn</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_shape</span><span class="p">,</span> <span class="n">is_training</span><span class="p">))</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">compose_map_func</span><span class="p">,</span>
                <span class="n">input_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;annotation&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;mask_shape&quot;</span><span class="p">],</span>
                <span class="n">output_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_num&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">],</span>
                <span class="n">column_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_num&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">],</span>
                <span class="n">python_multiprocessing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_parallel_workers</span><span class="o">=</span><span class="n">num_parallel_workers</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pad_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">max_instance_count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="mi">0</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">ds</span>

</pre></div>
</div>
</section>
</section>
<section id="id4">
<h2>定义模型<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h2>
<p>Mask R-CNN网络可以完成图片中实例的分类、定位和分割，教程中的网络实现部分位于<code class="docutils literal notranslate"><span class="pre">FineTune/src/maskrcnn</span></code>文件夹下，用户可以打开代码查看。下面我们先介绍一些Mask R-CNN的基本信息。</p>
<p>Mask R-CNN包括三个主要的子网络：</p>
<p><img alt="model" src="../../_images/maskrcnn_model.png" /></p>
<blockquote>
<div><p>图片及模型解析来源于<a class="reference external" href="https://bbs.huaweicloud.com/blogs/114705">Mask R-CNN模型解析</a>。</p>
</div></blockquote>
<ul>
<li><p>backbone网络:</p>
<p>Mask R-CNN的骨干网，主要实现图像的特征提取，这里包括ResNet与FPN(Feature Pyramid Network，图像特征金字塔)。ResNet通过加入残差模块来避免网络层数太多时带来的退化问题，FPN保留卷积过程中的阶段性结果，解决小物体识别困难的问题。ResNet结合FPN生成的特征图可用作后续两个模型的输入。</p>
</li>
<li><p>RPN网络：</p>
<p>RPN(region proposal network)主要用于生成Proposal，即带有前景、背景、包围框信息的区域。在backbone生成特征图之后，PRN会对特征图上的像素生成Anchor，由Anchor与Ground Truth Box的重叠程度可以判断区域内的图像是前景还是背景。训练之后，也可以由多个Anchor组合得到与Ground Truth box最相配的区域，即RoI(Region of Interest)。由RoI生成head网络所需要的数据：RoI中物体的分类，RoI与Ground Truth box的偏移量，RoI的mask信息。我们将带有这些信息的RoI称为Proposal，并将其输入到RoI Align层，经过池化操作之后，就得到了head网络的训练数据。</p>
<p><img alt="Anchor" src="../../_images/maskrcnn_anchor.png" /></p>
</li>
<li><p>head网络：</p>
<p>head网络输出物体的分类信息、定位信息和遮罩mask，实现图像分类、图像定位和图像分割。</p>
</li>
</ul>
<p>整体上，Mask R-CNN通过backbone网络、RPN网络、head网络依次实现特征提取、Proposal生成、mask生成，最终完成图像分割的目的。</p>
<section id="id5">
<h3>将预训练模型用于微调<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<p>在实现过程中，我们下载已经预训练好的<a class="reference external" href="https://download.mindspore.cn/model_zoo/r1.2/resnet50_ascend_v120_imagenet2012_official_cv_bs256_acc76/resnet50_ascend_v120_imagenet2012_official_cv_bs256_acc76.ckpt">ResNet50模型</a>，针对书籍分类对Mask R-CNN进行微调。</p>
<p>首先需要将下载好的模型放置在<code class="docutils literal notranslate"><span class="pre">FineTune/</span></code>文件夹路径下，并重命名为<code class="docutils literal notranslate"><span class="pre">resnet50.ckpt</span></code>，然后运行<code class="docutils literal notranslate"><span class="pre">FineTune/convert_checkpoint.py</span></code>。在该脚本中提取了ResNet50的主干作为backbone用于后面的训练：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">load_weights</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">use_fp16_weight</span><span class="p">):</span>
    <span class="n">ms_ckpt</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">ms_ckpt</span><span class="p">:</span>
        <span class="c1"># 提取主干网络</span>
        <span class="k">if</span> <span class="n">msname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;layer&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;conv1&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bn&quot;</span><span class="p">):</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="s2">&quot;backbone.&quot;</span> <span class="o">+</span> <span class="n">msname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="n">msname</span>

        <span class="c1"># 使用新层替换原网络</span>
        <span class="k">if</span> <span class="s2">&quot;down_sample_layer.0&quot;</span> <span class="ow">in</span> <span class="n">param_name</span><span class="p">:</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="n">param_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;down_sample_layer.0&quot;</span><span class="p">,</span> <span class="s2">&quot;conv_down_sample&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;down_sample_layer.1&quot;</span> <span class="ow">in</span> <span class="n">param_name</span><span class="p">:</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="n">param_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;down_sample_layer.1&quot;</span><span class="p">,</span> <span class="s2">&quot;bn_down_sample&quot;</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms_ckpt</span><span class="p">[</span><span class="n">msname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

    <span class="n">parameter_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 提取parameter</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
        <span class="n">parameter_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">dtype</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameter_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">param_list</span>
</pre></div>
</div>
<p>运行成功后在原目录下会得到用于重训的<code class="docutils literal notranslate"><span class="pre">resnet50_backbone.ckpt</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parameter_list</span> <span class="o">=</span> <span class="n">load_weights</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">ckpt_file</span><span class="p">,</span> <span class="n">use_fp16_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">parameter_list</span><span class="p">,</span> <span class="s2">&quot;resnet50_backbone.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>执行训练<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h2>
<p>现在，我们执行<code class="docutils literal notranslate"><span class="pre">FineTune/train.py</span></code>文件，利用之前获取的backbone和数据集，完成训练过程。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">device_num</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># 调用接口进行数据处理</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_new_dataset</span><span class="p">(</span><span class="n">image_dir</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">coco_root</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">dataset_size</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total images num: &quot;</span><span class="p">,</span> <span class="n">dataset_size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Create dataset done!&quot;</span><span class="p">)</span>

    <span class="c1"># 实例化网络</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">Mask_Rcnn_Resnet50</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>

    <span class="c1"># 加载预训练模型</span>
    <span class="n">load_path</span> <span class="o">=</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">pre_trained</span>
    <span class="k">if</span> <span class="n">load_path</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="n">load_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">pretrain_epoch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rcnn_mask&#39;</span><span class="p">)):</span>
                    <span class="n">param_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>

    <span class="c1"># 设定损失函数、学习率、优化器</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">LossNet</span><span class="p">()</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span>
                   <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span> <span class="n">loss_scale</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">)</span>

    <span class="c1"># 包装损失函数</span>
    <span class="n">net_with_loss</span> <span class="o">=</span> <span class="n">WithLossCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>

    <span class="c1"># 通过TrainOneStepCell自定义训练过程</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net_with_loss</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">loss_scale</span><span class="p">)</span>

    <span class="c1"># 监控训练过程</span>
    <span class="n">time_cb</span> <span class="o">=</span> <span class="n">TimeMonitor</span><span class="p">(</span><span class="n">data_size</span><span class="o">=</span><span class="n">dataset_size</span><span class="p">)</span>
    <span class="n">loss_cb</span> <span class="o">=</span> <span class="n">LossCallBack</span><span class="p">(</span><span class="n">rank_id</span><span class="o">=</span><span class="n">rank</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cb</span><span class="p">,</span> <span class="n">loss_cb</span><span class="p">]</span>

    <span class="c1"># 保存训练后的模型</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">:</span>
        <span class="c1"># 设置模型保存参数</span>
        <span class="n">ckptconfig</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint_epochs</span> <span class="o">*</span> <span class="n">dataset_size</span><span class="p">,</span>
                                      <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">keep_checkpoint_max</span><span class="p">)</span>
        <span class="n">save_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">save_checkpoint_path</span><span class="p">,</span> <span class="s1">&#39;ckpt_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># 应用模型保存参数</span>
        <span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;mask_rcnn&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">save_checkpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">ckptconfig</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ckpoint_cb</span><span class="p">]</span>

    <span class="c1"># 进行训练</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epoch_size</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span> <span class="n">dataset_sink_mode</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>在7个epoch的训练过程中，可以获得如下输出：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>total loss is： 1.3203125
total loss is： 0.88623046875
total loss is： 0.794921875
total loss is： 0.7216796875
total loss is： 0.67138671875
epoch time: 133629.138 ms, per step time: 26725.828 ms
total loss is： 0.65625
total loss is： 0.646484375
total loss is： 0.5712890625
total loss is： 0.56982421875
total loss is： 0.5732421875
epoch time: 4547.359 ms, per step time: 909.472 ms
total loss is： 0.5595703125
total loss is： 0.5166015625
total loss is： 0.8193359375
total loss is： 0.389892578125
total loss is： 0.44970703125
epoch time: 4639.649 ms, per step time: 927.930 ms
total loss is： 0.360107421875
total loss is： 0.25830078125
total loss is： 0.30224609375
total loss is： 0.2236328125
total loss is： 0.1971435546875
epoch time: 4851.436 ms, per step time: 970.287 ms
total loss is： 0.2021484375
total loss is： 0.36376953125
total loss is： 0.1787109375
total loss is： 0.56884765625
total loss is： 0.1864013671875
epoch time: 4904.663 ms, per step time: 980.933 ms
total loss is： 0.184326171875
total loss is： 0.1395263671875
total loss is： 0.301025390625
total loss is： 0.1458740234375
total loss is： 0.36376953125
epoch time: 4838.346 ms, per step time: 967.669 ms
total loss is： 0.1260986328125
total loss is： 0.08843994140625
total loss is： 0.10125732421875
total loss is： 0.09942626953125
total loss is： 0.162109375
epoch time: 5143.703 ms, per step time: 1028.741 ms
</pre></div>
</div>
<p>经过训练的模型可以分割图片中的书本：</p>
<p>原图：</p>
<p><img alt="bookmask" src="../../_images/maskrcnn_ori.png" /></p>
<p>物体分割：</p>
<p><img alt="bookmask" src="../../_images/maskrcnn_seg1.png" /></p>
<p>分离物体与背景：</p>
<p><img alt="bookmask" src="../../_images/maskrcnn_seg2.jpg" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../image_and_video.html" class="btn btn-neutral float-left" title="图像处理" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="transfer_learning.html" class="btn btn-neutral float-right" title="图像分类迁移学习" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>