<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastText实现文本分类 &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="序列到序列（seq2seq）模型实现文本翻译" href="text_translation_gru_tutorial.html" />
    <link rel="prev" title="使用字符级RNN生成名称" href="rnn_generation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">入门教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">基本介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">初学入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor.html">张量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">数据加载及处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">建立神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autograd.html">自动微分</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization.html">优化模型参数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../save_load_model.html">保存及加载模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inference.html">推理</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">进阶教程</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../custom.html">自定义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image_and_video.html">图像处理</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../text.html">自然语言</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="rnn_classification.html">使用字符级RNN分类名称</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnn_generation.html">使用字符级RNN生成名称</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">FastText实现文本分类</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#数据处理">数据处理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#配置环境">配置环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="#读取数据">读取数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#生成预处理数据">生成预处理数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#完成MindRecord转换">完成MindRecord转换</a></li>
<li class="toctree-l4"><a class="reference internal" href="#生成统一数据集">生成统一数据集</a></li>
<li class="toctree-l4"><a class="reference internal" href="#生成训练数据">生成训练数据</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#定义模型">定义模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#启动实例">启动实例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#模型训练">模型训练</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#提供FastTextloss计算">提供FastTextloss计算</a></li>
<li class="toctree-l4"><a class="reference internal" href="#创建网络计算loss值">创建网络计算loss值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#设置学习率和优化器">设置学习率和优化器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#定义训练pipeline">定义训练pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#定义梯度">定义梯度</a></li>
<li class="toctree-l4"><a class="reference internal" href="#进行模型训练">进行模型训练</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#使用测试数据集评估模型">使用测试数据集评估模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#读取验证集">读取验证集</a></li>
<li class="toctree-l4"><a class="reference internal" href="#生成测速数据">生成测速数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#定义验证方法">定义验证方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#读取数据并推理模型">读取数据并推理模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#评估模型">评估模型</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="text_translation_gru_tutorial.html">序列到序列（seq2seq）模型实现文本翻译</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pynative_mode_and_graph_mode.html">动态图与静态图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_training.html">分布式训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inference_and_deploy.html">推理与部署</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../text.html">自然语言</a> &raquo;</li>
      <li>FastText实现文本分类</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/intermediate/text/text_sentiment_ngrams_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="FastText实现文本分类">
<h1>FastText实现文本分类<a class="headerlink" href="#FastText实现文本分类" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.2/tutorials/source_zh_cn/intermediate/text/text_sentiment_ngrams_tutorial.ipynb"><img alt="image0" src="https://gitee.com/mindspore/docs/raw/r1.2/resource/_static/logo_source.png" /></a> <a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/r1.2/quick_start/mindspore_text_sentiment_ngrams_tutorial.ipynb"><img alt="image1" src="https://gitee.com/mindspore/docs/raw/r1.2/resource/_static/logo_notebook.png" /></a> <a class="reference external" href="https://authoring-modelarts-cnnorth4.huaweicloud.com/console/lab?share-url-b64=aHR0cHM6Ly9taW5kc3BvcmUtd2Vic2l0ZS5vYnMuY24tbm9ydGgtNC5teWh1YXdlaWNsb3VkLmNvbS9ub3RlYm9vay9tb2RlbGFydHMvcXVpY2tfc3RhcnQvbWluZHNwb3JlX3RleHRfc2VudGltZW50X25ncmFtc190dXRvcmlhbC5pcHluYg==&amp;imageid=59a6e9f5-93c0-44dd-85b0-82f390c5d53b"><img alt="image2" src="https://gitee.com/mindspore/docs/raw/r1.2/resource/_static/logo_modelarts.png" /></a></p>
<p>在本教程中，我们将在MindSpore中使用<code class="docutils literal notranslate"><span class="pre">MindRecord</span></code>加载并构建文本数据集，用户可以从教程中了解到如何：</p>
<ul class="simple">
<li><p>创建迭代数据集</p></li>
<li><p>将文本转换为向量</p></li>
<li><p>对数据进行shuffle等操作</p></li>
</ul>
<p>此外，本教程使用N-Gram，即N元语法模型来判断语句单词的构成顺序。N-Gram可以按照字节顺序，将文本内容进行大小为N的划窗操作，最终形成长度为N的字节片段序列。实践中经常使用二元或三元模型，本例通过将<code class="docutils literal notranslate"><span class="pre">ngram</span></code>参数设定为2，将二元模型应用在文本分类案例中。</p>
<blockquote>
<div><p>注意：该教程环境为MindSpore1.2.0版本。</p>
</div></blockquote>
<section id="数据处理">
<h2>数据处理<a class="headerlink" href="#数据处理" title="Permalink to this headline"></a></h2>
<p>本教程采用了AG_NEWS数据集，该数据集拥有超过 100 万篇新闻文章，该数据集仅采用了标题和描述字段，每一条数据有三列，第一列为标签（label），第二列为题目（title），第三列为内容（content），每种类别均拥有 30000 个训练样本和 1900 个测试样本。</p>
<p>点击下载<a class="reference external" href="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/intermediate/ag_news_csv.tgz">文本分类AG_NEWS数据集</a> ，在教程的同级目录下新建<code class="docutils literal notranslate"><span class="pre">data</span></code>文件夹，将下载好的数据集存放在<code class="docutils literal notranslate"><span class="pre">data</span></code>中。</p>
<p>目录如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>project
│  text_sentiment_ngrams_tutorial.ipynb
└─data
   │   train.csv
   │   test.csv
</pre></div>
</div>
<p>在进行其他操作之前，需要先安装<code class="docutils literal notranslate"><span class="pre">sklearn</span></code>和<code class="docutils literal notranslate"><span class="pre">spacy</span></code>工具包，并导入所需要的库并进行参数设置。</p>
<p>可在Jupyter Notebook中执行以下代码，完成工具包的安装及数据集的下载：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>sklearn<span class="w"> </span>spacy<span class="w"> </span>-i<span class="w"> </span>https://pypi.tuna.tsinghua.edu.cn/simple
<span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>./data
<span class="o">!</span>wget<span class="w"> </span>-N<span class="w"> </span>https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/intermediate/ag_news_csv.tgz
<span class="o">!</span>tar<span class="w"> </span>-zxvf<span class="w"> </span>ag_news_csv.tgz
<span class="o">!</span>mv<span class="w"> </span>./ag_news_csv/*<span class="w"> </span>./data
</pre></div>
</div>
</div>
<section id="配置环境">
<h3>配置环境<a class="headerlink" href="#配置环境" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">html</span>

<span class="kn">import</span> <span class="nn">mindspore.common.dtype</span> <span class="k">as</span> <span class="nn">mstype</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms.c_transforms</span> <span class="k">as</span> <span class="nn">deC</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dataset</span> <span class="k">as</span> <span class="n">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.ops.operations</span> <span class="k">as</span> <span class="nn">P</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">composite</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span> <span class="nn">mindspore.ops</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">mindspore.mindrecord</span> <span class="kn">import</span> <span class="n">FileWriter</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ParameterTuple</span>
<span class="kn">from</span> <span class="nn">mindspore.context</span> <span class="kn">import</span> <span class="n">ParallelMode</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">XavierUniform</span>

<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">FeatureHasher</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span>
</pre></div>
</div>
</div>
<p>本教程我们在GPU环境下，使用图模式运行实验。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">device_target</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="读取数据">
<h3>读取数据<a class="headerlink" href="#读取数据" title="Permalink to this headline"></a></h3>
<p>定义<code class="docutils literal notranslate"><span class="pre">_get_bucket_length</span></code>和<code class="docutils literal notranslate"><span class="pre">generate_gram</span></code>函数，分别实现如下功能：</p>
<ul class="simple">
<li><p>_get_bucket_length：将对应长度词句分类到相应的词句桶中。</p></li>
<li><p>generate_gram：为词句提供分词功能，此教程中取值为2。</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_bucket_length</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bts</span><span class="p">):</span>
    <span class="c1"># 返回词句对应的长度</span>
    <span class="n">x_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bts</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">bts</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_len</span> <span class="o">&lt;=</span> <span class="n">bts</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">bts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">generate_gram</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># 生成步长为2的词</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">num</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<p>在开始处理数据前，需要先定义填词的标志位，同时也需要创建保存向量和单词相互转换的两个字典。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">word2vec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">vec2words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">word2vec</span><span class="p">[</span><span class="s1">&#39;PAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vec2words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PAD&#39;</span>
<span class="n">word2vec</span><span class="p">[</span><span class="s1">&#39;UNK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">vec2words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;UNK&#39;</span>
</pre></div>
</div>
</div>
<p>定义<code class="docutils literal notranslate"><span class="pre">input_preprocess</span></code>函数，首先将需要处理的文本拼接在一起，然后拼接的文本通过<code class="docutils literal notranslate"><span class="pre">spacy_nlp</span></code>来对词进行标注，然后通过实例化<code class="docutils literal notranslate"><span class="pre">generate_gram</span></code>将词条按照步长切分为词语，最后返回词语转为向量的列表。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">input_preprocess</span><span class="p">(</span><span class="n">src_text1</span><span class="p">,</span> <span class="n">src_text2</span><span class="p">,</span> <span class="n">spacy_nlp</span><span class="p">,</span> <span class="n">train_mode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;数据处理函数&quot;&quot;&quot;</span>
    <span class="n">non_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span>
    <span class="n">end_string</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">]</span>
    <span class="n">str_html</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]+&gt;&#39;</span><span class="p">)</span>
    <span class="n">src_text1</span> <span class="o">=</span> <span class="n">src_text1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">text_greater</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span>
    <span class="n">text_less</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>

    <span class="c1"># 拼接文本</span>
    <span class="k">if</span> <span class="n">src_text1</span> <span class="ow">and</span> <span class="n">src_text1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">end_string</span><span class="p">:</span>
        <span class="n">src_text1</span> <span class="o">=</span> <span class="n">src_text1</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>

    <span class="k">if</span> <span class="n">src_text2</span><span class="p">:</span>
        <span class="n">src_text2</span> <span class="o">=</span> <span class="n">src_text2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">sent_describe</span> <span class="o">=</span> <span class="n">src_text1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">src_text2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sent_describe</span> <span class="o">=</span> <span class="n">src_text1</span>
    <span class="k">if</span> <span class="n">non_str</span> <span class="ow">in</span> <span class="n">sent_describe</span><span class="p">:</span>
        <span class="n">sent_describe</span> <span class="o">=</span> <span class="n">sent_describe</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">non_str</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">sent_describe</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">sent_describe</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">text_less</span> <span class="ow">in</span> <span class="n">sent_describe</span> <span class="ow">and</span> <span class="n">text_greater</span> <span class="ow">in</span> <span class="n">sent_describe</span><span class="p">:</span>
        <span class="n">sent_describe</span> <span class="o">=</span> <span class="n">str_html</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sent_describe</span><span class="p">)</span>

    <span class="c1"># 转换词向量</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">spacy_nlp</span><span class="p">(</span><span class="n">sent_describe</span><span class="p">)</span>
    <span class="n">bows_token</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tagged_sent_desc</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &lt;/s&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &lt;/p&gt;&#39;</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">tagged_sent_desc</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt; &#39;</span> <span class="o">+</span> <span class="n">sent_describe</span> <span class="o">+</span> <span class="s1">&#39; &lt;/p&gt;&#39;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">spacy_nlp</span><span class="p">(</span><span class="n">tagged_sent_desc</span><span class="p">)</span>
    <span class="n">ngrams</span> <span class="o">=</span> <span class="n">generate_gram</span><span class="p">([</span><span class="n">token</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bo_ngrams</span> <span class="o">=</span> <span class="n">bows_token</span> <span class="o">+</span> <span class="n">ngrams</span>

    <span class="k">if</span> <span class="n">train_mode</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ngms</span> <span class="ow">in</span> <span class="n">bo_ngrams</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">word2vec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ngms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2vec</span><span class="p">)</span>
                <span class="n">word2vec</span><span class="p">[</span><span class="n">ngms</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">vec2words</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngms</span>

    <span class="c1"># 返回转为向量后的列表</span>
    <span class="n">processed_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">word2vec</span><span class="p">[</span><span class="n">ng</span><span class="p">]</span> <span class="k">if</span> <span class="n">ng</span> <span class="ow">in</span> <span class="n">word2vec</span> <span class="k">else</span> <span class="n">word2vec</span><span class="p">[</span><span class="s1">&#39;UNK&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ng</span> <span class="ow">in</span> <span class="n">bo_ngrams</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">processed_out</span>
</pre></div>
</div>
</div>
<p>定义<code class="docutils literal notranslate"><span class="pre">common_block</span></code>函数来完成以下功能： - 读取每条新闻信息的标签（label）。 - 根据每条新闻信息的长度分别进行相对应的处理。 - 获取<code class="docutils literal notranslate"><span class="pre">input_preprocess</span></code>函数得到的token长度。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">common_block</span><span class="p">(</span><span class="n">_pair_sen</span><span class="p">,</span> <span class="n">spacy_nlp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;新闻信息处理函数&quot;&quot;&quot;</span>
    <span class="n">label_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_pair_sen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># 根据不同文本长度来处理数据</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pair_sen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">input_preprocess</span><span class="p">(</span><span class="n">src_text1</span><span class="o">=</span><span class="n">_pair_sen</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">src_text2</span><span class="o">=</span><span class="n">_pair_sen</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                      <span class="n">spacy_nlp</span><span class="o">=</span><span class="n">spacy_nlp</span><span class="p">,</span>
                                      <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_tokens_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pair_sen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">input_preprocess</span><span class="p">(</span><span class="n">src_text1</span><span class="o">=</span><span class="n">_pair_sen</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">src_text2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">spacy_nlp</span><span class="o">=</span><span class="n">spacy_nlp</span><span class="p">,</span>
                                      <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_tokens_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pair_sen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># 判断是否有三个文本，如果有的话先拼接前两个文本</span>
        <span class="k">if</span> <span class="n">_pair_sen</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">sen_o_t</span> <span class="o">=</span> <span class="n">_pair_sen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">_pair_sen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sen_o_t</span> <span class="o">=</span> <span class="n">_pair_sen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">input_preprocess</span><span class="p">(</span><span class="n">src_text1</span><span class="o">=</span><span class="n">sen_o_t</span><span class="p">,</span>
                                      <span class="n">src_text2</span><span class="o">=</span><span class="n">_pair_sen</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="n">spacy_nlp</span><span class="o">=</span><span class="n">spacy_nlp</span><span class="p">,</span>
                                      <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_tokens_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">,</span> <span class="n">label_idx</span>
</pre></div>
</div>
</div>
<p>最后来定义<code class="docutils literal notranslate"><span class="pre">load</span></code>函数来形成数据处理流，包括如下步骤： 1. 首先将处理后的数据集文件以列表的形式保存。 2. 根据前面数据分箱后的长度来将不足的长度进行填充。 3. 将处理后的数据保存为列表返回。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">test_path</span><span class="p">,</span> <span class="n">train_feature_dict</span><span class="p">,</span> <span class="n">test_feature_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;数据读取&quot;&quot;&quot;</span>
    <span class="n">train_dataset_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_dataset_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spacy_nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en_core_web_sm&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">,</span> <span class="s1">&#39;tagger&#39;</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">,</span> <span class="s1">&#39;lemmatizer&#39;</span><span class="p">])</span>
    <span class="n">spacy_nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s1">&#39;sentencizer&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_file</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;开始处理训练数据&quot;</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">src_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_pair_sen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
            <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">,</span> <span class="n">label_idx</span> <span class="o">=</span> <span class="n">common_block</span><span class="p">(</span><span class="n">_pair_sen</span><span class="o">=</span><span class="n">_pair_sen</span><span class="p">,</span>
                                                                    <span class="n">spacy_nlp</span><span class="o">=</span><span class="n">spacy_nlp</span><span class="p">)</span>
            <span class="n">train_dataset_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">test_file</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;开始处理测试数据&quot;</span><span class="p">)</span>
        <span class="n">reader2</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_test_sen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader2</span><span class="p">):</span>
            <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">,</span> <span class="n">label_idx</span> <span class="o">=</span> <span class="n">common_block</span><span class="p">(</span><span class="n">_pair_sen</span><span class="o">=</span><span class="n">_test_sen</span><span class="p">,</span>
                                                                    <span class="n">spacy_nlp</span><span class="o">=</span><span class="n">spacy_nlp</span><span class="p">)</span>
            <span class="n">test_dataset_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">])</span>

    <span class="n">train_dataset_list_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset_list</span><span class="p">)</span>
    <span class="n">test_dataset_list_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset_list</span><span class="p">)</span>

    <span class="c1"># 用定义的word2vec[&#39;PAD&#39;]为训练数据填充0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_dataset_list_length</span><span class="p">):</span>
        <span class="n">bucket_length</span> <span class="o">=</span> <span class="n">_get_bucket_length</span><span class="p">(</span><span class="n">train_dataset_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">bucket_length</span><span class="p">:</span>
            <span class="n">train_dataset_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2vec</span><span class="p">[</span><span class="s1">&#39;PAD&#39;</span><span class="p">])</span>
        <span class="n">train_dataset_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset_list</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># 用定义的word2vec[&#39;PAD&#39;]为测试数据填充0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_dataset_list_length</span><span class="p">):</span>
        <span class="n">test_bucket_length</span> <span class="o">=</span> <span class="n">_get_bucket_length</span><span class="p">(</span><span class="n">test_dataset_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">test_bucket_length</span><span class="p">:</span>
            <span class="n">test_dataset_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2vec</span><span class="p">[</span><span class="s1">&#39;PAD&#39;</span><span class="p">])</span>
        <span class="n">test_dataset_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">train_example_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_example_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 将训练样例以字典的方式存入</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_dataset_list_length</span><span class="p">):</span>
        <span class="n">train_example_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;src_tokens&quot;</span><span class="p">:</span> <span class="n">train_dataset_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;src_tokens_length&quot;</span><span class="p">:</span> <span class="n">train_dataset_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;label_idx&quot;</span><span class="p">:</span> <span class="n">train_dataset_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_feature_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">train_example_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;src_tokens_length&#39;</span><span class="p">]:</span>
                <span class="n">train_feature_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_example_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="c1">#将测试样例以字典的方式存入</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_dataset_list_length</span><span class="p">):</span>
        <span class="n">test_example_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;src_tokens&quot;</span><span class="p">:</span> <span class="n">test_dataset_list</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;src_tokens_length&quot;</span><span class="p">:</span> <span class="n">test_dataset_list</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;label_idx&quot;</span><span class="p">:</span> <span class="n">test_dataset_list</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">test_feature_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">test_example_data</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="s1">&#39;src_tokens_length&#39;</span><span class="p">]:</span>
                <span class="n">test_feature_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_example_data</span><span class="p">[</span><span class="n">h</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train vocab size is &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2vec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">train_feature_dict</span><span class="p">,</span> <span class="n">test_feature_dict</span>
</pre></div>
</div>
</div>
</section>
<section id="生成预处理数据">
<h3>生成预处理数据<a class="headerlink" href="#生成预处理数据" title="Permalink to this headline"></a></h3>
<p>现在调用上一步定义好的<code class="docutils literal notranslate"><span class="pre">load</span></code>函数，获取训练与测试的预处理数据，以便于下一步使用<code class="docutils literal notranslate"><span class="pre">mindspore.dataset.MindRecord</span></code>接口进一步转换数据格式。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_feature_dicts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># 通过循环将bucket中的长度都加载到空字典</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">]:</span>
    <span class="n">train_feature_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_feature_dicts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">]:</span>
    <span class="n">test_feature_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;./data/&quot;</span>
<span class="c1"># 读取bucket的test和train数据进行处理</span>
<span class="n">train_data_example</span><span class="p">,</span> <span class="n">test_data_example</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">train_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;train.csv&quot;</span><span class="p">),</span>
                                             <span class="n">test_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;test.csv&quot;</span><span class="p">),</span>
                                            <span class="n">train_feature_dict</span> <span class="o">=</span> <span class="n">train_feature_dicts</span><span class="p">,</span>
                                            <span class="n">test_feature_dict</span> <span class="o">=</span> <span class="n">test_feature_dicts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
开始处理训练数据
开始处理测试数据
train vocab size is  1071957
</pre></div></div>
</div>
</section>
<section id="完成MindRecord转换">
<h3>完成MindRecord转换<a class="headerlink" href="#完成MindRecord转换" title="Permalink to this headline"></a></h3>
<p>接下来我们通过定义<code class="docutils literal notranslate"><span class="pre">write_to_mindrecord</span></code>方法来将预处理后的基本数据转换为MindRecord格式，该方法提供两个参数：</p>
<ul class="simple">
<li><p>data：AG_NEWS数据集的路径。</p></li>
<li><p>path：定义生成MindRecord格式文件路径。</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_to_mindrecord</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">shared_num</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;生成MindRecord&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">shared_num</span><span class="p">)</span>
    <span class="n">data_schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;src_tokens&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]},</span>
        <span class="s2">&quot;src_tokens_length&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]},</span>
        <span class="s2">&quot;label_idx&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
    <span class="p">}</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">data_schema</span><span class="p">,</span> <span class="s2">&quot;fasttext&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_tokens_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;src_tokens_length&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;label_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;label_idx&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write_raw_data</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>遍历原始数据集，将所有数据全部写为MindRecord数据格式。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 通过循环来将文件转换成拼接的MindRecord文件</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing train data to MindRecord file.....&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">]:</span>
    <span class="n">write_to_mindrecord</span><span class="p">(</span><span class="n">train_data_example</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;./train/train_dataset_bs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mindrecord&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing test data to MindRecord file.....&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">]:</span>
    <span class="n">write_to_mindrecord</span><span class="p">(</span><span class="n">test_data_example</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;./test/test_dataset_bs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mindrecord&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Writing train data to MindRecord file.....
Writing test data to MindRecord file.....
</pre></div></div>
</div>
</section>
<section id="生成统一数据集">
<h3>生成统一数据集<a class="headerlink" href="#生成统一数据集" title="Permalink to this headline"></a></h3>
<p>经过<code class="docutils literal notranslate"><span class="pre">write_to_mindrecord</span></code>，现在我们已经得到了全部数据的MindRecord格式的数据集，接下来进一步调用<code class="docutils literal notranslate"><span class="pre">batch_per_bucket</span></code>将所有数据合并到统一数据集。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_per_bucket</span><span class="p">(</span><span class="n">bucket_length</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
    <span class="c1"># 拼接MindRecord文件</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">input_file</span> <span class="o">+</span> <span class="s1">&#39;train/train_dataset_bs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bucket_length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mindrecord&#39;</span>
    <span class="c1"># 判断是否存在文件</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;input file parameter must not be empty.&quot;</span><span class="p">)</span>

    <span class="c1"># 按照文件格式读取文件数据</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MindDataset</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span>
                              <span class="n">columns_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;src_tokens_length&#39;</span><span class="p">,</span> <span class="s1">&#39;label_idx&#39;</span><span class="p">],</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">num_shards</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 返回文件数据</span>
    <span class="n">ori_dataset_size</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset size: </span><span class="si">{</span><span class="n">ori_dataset_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">repeat_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;src_tokens_length&#39;</span><span class="p">,</span> <span class="s1">&#39;label_idx&#39;</span><span class="p">],</span>
                               <span class="n">output_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src_token_text&#39;</span><span class="p">,</span> <span class="s1">&#39;src_tokens_text_length&#39;</span><span class="p">,</span> <span class="s1">&#39;label_idx_tag&#39;</span><span class="p">])</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat_count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_set</span>
</pre></div>
</div>
</div>
</section>
<section id="生成训练数据">
<h3>生成训练数据<a class="headerlink" href="#生成训练数据" title="Permalink to this headline"></a></h3>
<p>通过循环方式来遍历所有MindRecord文件，最后完成训练数据集的收集。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bucket</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">467</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
    <span class="n">bucket_len</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ds_per</span> <span class="o">=</span> <span class="n">batch_per_bucket</span><span class="p">(</span><span class="n">bucket_len</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># 判断次序来拼接数据</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data_set</span> <span class="o">=</span> <span class="n">ds_per</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span> <span class="o">+</span> <span class="n">ds_per</span>

<span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data_set</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">())</span>
<span class="n">data_set</span><span class="o">.</span><span class="n">channel_name</span> <span class="o">=</span> <span class="s1">&#39;fasttext&#39;</span>
<span class="n">preprocessed_data</span> <span class="o">=</span> <span class="n">data_set</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dataset size: 4780
Dataset size: 73255
Dataset size: 6706
</pre></div></div>
</div>
</section>
</section>
<section id="定义模型">
<h2>定义模型<a class="headerlink" href="#定义模型" title="Permalink to this headline"></a></h2>
<p>论文<a class="reference external" href="https://arxiv.org/pdf/1607.01759.pdf">Bag of Tricks for Efficient Text Classification</a>中详细阐述了FastText模型的实现原理，模型结构如图所示：</p>
<p><img alt="fasttext" src="../../_images/fasttext.png" /></p>
<blockquote>
<div><p>图片出处：<a class="reference external" href="https://arxiv.org/pdf/1607.01759.pdf">https://arxiv.org/pdf/1607.01759.pdf</a> 。</p>
</div></blockquote>
<p>可以看到，FastText模型只有三层：输入层、隐藏层（hidden层）、输出层，输入是多个向量表示的单词，输出是一个特定的target，隐藏层（hidden层）是对多个词向量的叠加平均。 &gt; FastText在输入时，将单词的字符级别的n-gram向量作为额外的特征；在输出时，FastText采用了分层Softmax，大大降低了模型训练时间。</p>
<p>下面定义FastText网络。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FastText</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dims</span><span class="p">,</span> <span class="n">num_class</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;定义FastText网络&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FastText</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embeding_dims</span> <span class="o">=</span> <span class="n">embedding_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_class</span> <span class="o">=</span> <span class="n">num_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embeding_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
                                          <span class="n">embedding_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embeding_dims</span><span class="p">,</span>
                                          <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">embedding_table</span><span class="o">=</span><span class="s1">&#39;Zeros&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeding_dims</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_class</span><span class="p">,</span>
                           <span class="n">weight_init</span><span class="o">=</span><span class="n">XavierUniform</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reducesum</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ReduceSum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cast</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Cast</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realdiv</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">RealDiv</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_token_length</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; FastText网络构建 &quot;&quot;&quot;</span>
        <span class="n">src_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeding_func</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">)</span>
        <span class="n">embeding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducesum</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">embeding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">realdiv</span><span class="p">(</span><span class="n">embeding</span><span class="p">,</span> <span class="n">src_token_length</span><span class="p">)</span>
        <span class="n">embeding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">embeding</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">embeding</span><span class="p">)</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classifier</span>
</pre></div>
</div>
</div>
</section>
<section id="启动实例">
<h2>启动实例<a class="headerlink" href="#启动实例" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">AG_NEWS</span></code>数据集具有四个标签，因此类别数是四个。</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="p">:</span> <span class="n">World</span>
<span class="mi">2</span> <span class="p">:</span> <span class="n">Sports</span>
<span class="mi">3</span> <span class="p">:</span> <span class="n">Business</span>
<span class="mi">4</span> <span class="p">:</span> <span class="n">Sci</span><span class="o">/</span><span class="n">Tec</span>
</pre></div>
</div>
<p>在网络中，<code class="docutils literal notranslate"><span class="pre">vocab_size</span></code>为词汇数据的长度，其中包括单个单词和N元组。类的数量等于标签的数量，在<code class="docutils literal notranslate"><span class="pre">AG_NEWS</span></code>情况下为4。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fast_text_net</span> <span class="o">=</span> <span class="n">FastText</span><span class="p">(</span><span class="mi">1383812</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="模型训练">
<h2>模型训练<a class="headerlink" href="#模型训练" title="Permalink to this headline"></a></h2>
<p>我们在此处使用MindSpore数据集接口<code class="docutils literal notranslate"><span class="pre">MindDataset</span></code>加载<code class="docutils literal notranslate"><span class="pre">AG_NEWS</span></code>数据集，并将其发送到模型以进行训练/验证。</p>
<section id="提供FastTextloss计算">
<h3>提供FastTextloss计算<a class="headerlink" href="#提供FastTextloss计算" title="Permalink to this headline"></a></h3>
<p>我们已经在前面定义了一个完整的<code class="docutils literal notranslate"><span class="pre">FastText</span></code>网络，现在需要来为网络提供一个计算loss值的方法，这一过程由<code class="docutils literal notranslate"><span class="pre">FastTextNetWithLoss</span></code>类来实现。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FastTextNetWithLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    提供FastText的loss运算</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dims</span><span class="p">,</span> <span class="n">num_class</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FastTextNetWithLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fasttext</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Print</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_lengths</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        带有loss的FastText网络</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predict_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fasttext</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_lengths</span><span class="p">)</span>
        <span class="n">label_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">label_idx</span><span class="p">)</span>
        <span class="n">predict_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">predict_score</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predict_score</span>
</pre></div>
</div>
</div>
</section>
<section id="创建网络计算loss值">
<h3>创建网络计算loss值<a class="headerlink" href="#创建网络计算loss值" title="Permalink to this headline"></a></h3>
<p>在这一步中实例化<code class="docutils literal notranslate"><span class="pre">FastTextNetWithLoss</span></code>类。将定义好的网络<code class="docutils literal notranslate"><span class="pre">FastTextNet</span></code>、vocab的大小、embedding的数量和类别数放入到实例中。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net_with_loss</span> <span class="o">=</span> <span class="n">FastTextNetWithLoss</span><span class="p">(</span><span class="n">fast_text_net</span><span class="p">,</span> <span class="mi">1383812</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">net_with_loss</span><span class="o">.</span><span class="n">init_parameters_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{Parameter (name=fasttext.embeding_func.embedding_table, shape=(1383812, 16), dtype=Float32, requires_grad=True): Parameter (name=fasttext.embeding_func.embedding_table, shape=(1383812, 16), dtype=Float32, requires_grad=True),
 Parameter (name=fasttext.fc.weight, shape=(4, 16), dtype=Float32, requires_grad=True): Parameter (name=fasttext.fc.weight, shape=(4, 16), dtype=Float32, requires_grad=True),
 Parameter (name=fasttext.fc.bias, shape=(4,), dtype=Float32, requires_grad=True): Parameter (name=fasttext.fc.bias, shape=(4,), dtype=Float32, requires_grad=True)}
</pre></div></div>
</div>
</section>
<section id="设置学习率和优化器">
<h3>设置学习率和优化器<a class="headerlink" href="#设置学习率和优化器" title="Permalink to this headline"></a></h3>
<p>现在我们需要为<code class="docutils literal notranslate"><span class="pre">mindspore.nn.Adam</span></code>优化器来定义一个学习率变化方式，以此来为优化器提供所需学习率参数。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">piecewise_constant_lr</span>

<span class="c1"># 定义学习率和学习率变化曲线</span>
<span class="n">learn_rate</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">min_lr</span> <span class="o">=</span> <span class="mf">0.000001</span>
<span class="n">decay_steps</span> <span class="o">=</span> <span class="n">preprocessed_data</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">update_steps</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">preprocessed_data</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="n">lr_step</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">update_steps</span><span class="p">)]</span>
<span class="n">lr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">learn_rate</span> <span class="o">-</span> <span class="n">min_lr</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">update_steps</span><span class="p">)]</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">piecewise_constant_lr</span><span class="p">(</span><span class="n">lr_step</span><span class="p">,</span><span class="n">lr_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>

<span class="c1"># 实例化优化器</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">net_with_loss</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">lr</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;mindspore.common.tensor.Tensor&#39;&gt;
</pre></div></div>
</div>
</section>
<section id="定义训练pipeline">
<h3>定义训练pipeline<a class="headerlink" href="#定义训练pipeline" title="Permalink to this headline"></a></h3>
<p>当所有准备完毕后，我们要规划一次训练所需要的pipeline，于是定义了<code class="docutils literal notranslate"><span class="pre">TrainOneStepCell</span></code>类，该类主要实现以下方法：</p>
<p>set_sens：将获取值转为sens类型方便后续传入<code class="docutils literal notranslate"><span class="pre">tuple_to_array</span></code>转换。</p>
<p>construct：定义一次训练结算所需要的流程。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FastTextTrainOneStepCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">sens</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FastTextTrainOneStepCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">ParameterTuple</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">GradOperation</span><span class="p">(</span><span class="n">get_by_list</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sens_param</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sens</span> <span class="o">=</span> <span class="n">sens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reducer_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;parallel_mode&quot;</span><span class="p">)</span>

        <span class="c1"># 判断计算模式合理性</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ParallelMode</span><span class="o">.</span><span class="n">MODE_LIST</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parallel mode does not support: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ParallelMode</span><span class="o">.</span><span class="n">DATA_PARALLEL</span><span class="p">,</span> <span class="n">ParallelMode</span><span class="o">.</span><span class="n">HYBRID_PARALLEL</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reducer_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_reducer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 如果递减成立，则自动检索所需模式</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer_flag</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_auto_parallel_context</span><span class="p">(</span><span class="s2">&quot;gradients_mean&quot;</span><span class="p">)</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="n">get_group_size</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_reducer</span> <span class="o">=</span> <span class="n">DistributedGradReducer</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>
        <span class="c1"># 将算子应用到每个网络序列中</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyper_map</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">HyperMap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cast</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">Cast</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_sens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sens</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">src_token_text</span><span class="p">,</span>
                  <span class="n">src_tokens_text_length</span><span class="p">,</span>
                  <span class="n">label_idx_tag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;定义执行运算.&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">src_token_text</span><span class="p">,</span>
                            <span class="n">src_tokens_text_length</span><span class="p">,</span>
                            <span class="n">label_idx_tag</span><span class="p">)</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">weights</span><span class="p">)(</span><span class="n">src_token_text</span><span class="p">,</span>
                                                 <span class="n">src_tokens_text_length</span><span class="p">,</span>
                                                 <span class="n">label_idx_tag</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">tuple_to_array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sens</span><span class="p">,)),</span>
                                                           <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyper_map</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">clip_grad</span><span class="p">,</span> <span class="n">GRADIENT_CLIP_TYPE</span><span class="p">,</span> <span class="n">GRADIENT_CLIP_VALUE</span><span class="p">),</span> <span class="n">grads</span><span class="p">)</span>

        <span class="c1"># 实现梯度消除</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer_flag</span><span class="p">:</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_reducer</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>

        <span class="n">succ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">Depend</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">succ</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="定义梯度">
<h3>定义梯度<a class="headerlink" href="#定义梯度" title="Permalink to this headline"></a></h3>
<p>因为本次梯度所需格式的不同，需要通过<code class="docutils literal notranslate"><span class="pre">clip_grad</span></code>修饰器重新定义<code class="docutils literal notranslate"><span class="pre">_clip_grad</span></code>传入参数的类型，如下所示：</p>
<ul class="simple">
<li><p>clip_type为数字类型。</p></li>
<li><p>clip_value为数字类型。</p></li>
<li><p>grad为张量类型。</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GRADIENT_CLIP_TYPE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">GRADIENT_CLIP_VALUE</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># 生成clip_grad的重载函数</span>
<span class="n">clip_grad</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">MultitypeFuncGraph</span><span class="p">(</span><span class="s2">&quot;clip_grad&quot;</span><span class="p">)</span>


<span class="nd">@clip_grad</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_clip_grad</span><span class="p">(</span><span class="n">clip_type</span><span class="p">,</span> <span class="n">clip_value</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
    <span class="c1"># 如果梯度不在范围内直接返回梯度</span>
    <span class="k">if</span> <span class="n">clip_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">grad</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>

    <span class="c1"># 如果梯度为0，则计算新的梯度</span>
    <span class="k">if</span> <span class="n">clip_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">new_grad</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">tuple_to_array</span><span class="p">((</span><span class="o">-</span><span class="n">clip_value</span><span class="p">,)),</span> <span class="n">dt</span><span class="p">),</span>
                                   <span class="n">F</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">tuple_to_array</span><span class="p">((</span><span class="n">clip_value</span><span class="p">,)),</span> <span class="n">dt</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_grad</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ClipByNorm</span><span class="p">()(</span><span class="n">grad</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">tuple_to_array</span><span class="p">((</span><span class="n">clip_value</span><span class="p">,)),</span> <span class="n">dt</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_grad</span>
</pre></div>
</div>
</div>
</section>
<section id="进行模型训练">
<h3>进行模型训练<a class="headerlink" href="#进行模型训练" title="Permalink to this headline"></a></h3>
<p>调用之前设定的<code class="docutils literal notranslate"><span class="pre">FastTextTrainOneStepCell</span></code>并迭代数据集，完成模型训练。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net_with_grads</span> <span class="o">=</span> <span class="n">FastTextTrainOneStepCell</span><span class="p">(</span><span class="n">net_with_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
<span class="n">net_with_grads</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FastTextTrainOneStepCell&lt;
  (network): FastTextNetWithLoss&lt;
    (fasttext): FastText&lt;
      (embeding_func): Embedding&lt;vocab_size=1383812, embedding_size=16, use_one_hot=False, embedding_table=Parameter (name=fasttext.embeding_func.embedding_table, shape=(1383812, 16), dtype=Float32, requires_grad=True), dtype=Float32, padding_idx=0&gt;
      (fc): Dense&lt;input_channels=16, output_channels=4, has_bias=True&gt;
      (log_softmax): LogSoftmax&lt;&gt;
      &gt;
    (loss_func): SoftmaxCrossEntropyWithLogits&lt;&gt;
    &gt;
  (optimizer): Adam&lt;
    (learning_rate): _IteratorLearningRate&lt;&gt;
    &gt;
  &gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 进行epoch训练</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">preprocessed_data</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">():</span>
        <span class="n">net_with_grads</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;src_token_text&quot;</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;src_token_text&quot;</span><span class="p">]),</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;label_idx_tag&quot;</span><span class="p">])</span>
        <span class="c1"># 输出loss值</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">net_with_loss</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;src_token_text&quot;</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;src_token_text&quot;</span><span class="p">]),</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;label_idx_tag&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.3239299
1.2918508
1.236133
1.1651388
1.074889
1.1294309
0.9561551
0.9522176
0.91801494
0.8881521
0.80080545
0.7337659
0.6696707
0.63573897
0.5883118
0.23005332
0.4515081
0.20126605
0.4553006
0.21953695
0.15097088
0.22751673
0.299681
0.23459665
0.17367001
0.32614958
0.24170385
0.18644962
0.14626658
0.18693896
0.22911525
0.30018106
0.28360566
0.22088502
0.21194872
0.17272016
0.21119592
0.21003135
0.17690946
0.18701789
0.22161637
0.18359481
0.25332585
0.1607348
0.18905574
0.21450931
0.4525343
0.048400477
0.06543859
0.04598104
0.046952773
0.05878158
0.05802965
0.021141667
0.016563205
0.0599133
0.03379585
0.020350233
0.033926312
0.10194215
0.034460913
0.055590115
0.014893334
0.060085252
0.028355705
0.056327038
0.024952719
0.032113466
0.023740696
0.01511923
0.034571428
0.037790537
0.07907674
0.032159526
0.046872605
0.028533353
0.0076825884
0.0077427584
0.040141877
0.013469651
0.029853245
1.1512634
0.010118321
0.025405075
0.026934445
0.031721305
0.042373456
0.0452683
0.07718848
0.06898584
0.06665465
0.030750485
0.039185237
0.017627863
0.04209162
0.020786878
0.021398135
0.018585052
0.018579647
0.012931412
0.018248955
0.019529575
0.0103960065
0.018511338
0.014498311
0.015237848
0.0048193294
0.012299601
0.0012418798
0.0017256059
0.017027915
0.010947452
0.0053985277
0.005133066
</pre></div></div>
</div>
</section>
</section>
<section id="使用测试数据集评估模型">
<h2>使用测试数据集评估模型<a class="headerlink" href="#使用测试数据集评估模型" title="Permalink to this headline"></a></h2>
<section id="读取验证集">
<h3>读取验证集<a class="headerlink" href="#读取验证集" title="Permalink to this headline"></a></h3>
<p>如同读取训练数据集一样，这里定义<code class="docutils literal notranslate"><span class="pre">batch_per_bucket</span></code>方法来读取测试数据集，其中入参分别为：</p>
<p>batch_size：测试集中的batch数量。</p>
<p>bucket_len：箱的长度。</p>
<p>input_file：MindRecord文件路径。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_per_bucket</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">bucket_length</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">input_file</span> <span class="o">+</span> <span class="s1">&#39;test/test_dataset_bs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bucket_length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.mindrecord&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_file</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;input file parameter must not be empty.&quot;</span><span class="p">)</span>

    <span class="n">data_set</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MindDataset</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span>
                              <span class="n">columns_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;src_tokens_length&#39;</span><span class="p">,</span> <span class="s1">&#39;label_idx&#39;</span><span class="p">])</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">deC</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;src_tokens&quot;</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;src_tokens_length&quot;</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label_idx&quot;</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_set</span>
</pre></div>
</div>
</div>
</section>
<section id="生成测速数据">
<h3>生成测速数据<a class="headerlink" href="#生成测速数据" title="Permalink to this headline"></a></h3>
<p>通过循环方式来遍历所有MindRecord文件，最后完成数据集的收集。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bucket</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">467</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
    <span class="n">bucket_len</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ds_per</span> <span class="o">=</span> <span class="n">batch_per_bucket</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">bucket_len</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">load_test_data</span> <span class="o">=</span> <span class="n">ds_per</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">load_test_data</span> <span class="o">=</span> <span class="n">load_test_data</span> <span class="o">+</span> <span class="n">ds_per</span>
</pre></div>
</div>
</div>
</section>
<section id="定义验证方法">
<h3>定义验证方法<a class="headerlink" href="#定义验证方法" title="Permalink to this headline"></a></h3>
<p>现在传入训练后的网络<code class="docutils literal notranslate"><span class="pre">network</span></code>，通过<code class="docutils literal notranslate"><span class="pre">FastTextInferCell</span></code>来完成我们的验证流程。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FastTextInferCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FastTextInferCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ArgMaxWithValue</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_lengths</span><span class="p">):</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_lengths</span><span class="p">)</span>
        <span class="n">predicted_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
        <span class="n">predicted_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predicted_idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predicted_idx</span>
</pre></div>
</div>
</div>
</section>
<section id="读取数据并推理模型">
<h3>读取数据并推理模型<a class="headerlink" href="#读取数据并推理模型" title="Permalink to this headline"></a></h3>
<p>最后，实例化<code class="docutils literal notranslate"><span class="pre">load_infer_dataset</span></code>和<code class="docutils literal notranslate"><span class="pre">FastTextInferCell</span></code>来模型推理：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_test_data</span> <span class="o">=</span> <span class="n">load_infer_dataset</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                     <span class="n">datafile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                     <span class="n">bucket</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">467</span><span class="p">])</span>
<span class="c1"># 创建测试pepiline</span>
<span class="n">ft_infer</span> <span class="o">=</span> <span class="n">FastTextInferCell</span><span class="p">(</span><span class="n">fast_text_net</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">target_sens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">ft_infer</span><span class="p">)</span>

<span class="c1"># 计算每组测试批量的acc值</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">load_test_data</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">(</span><span class="n">output_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">target_sens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;label_idx&#39;</span><span class="p">])</span>
    <span class="n">src_tokens</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;src_tokens&#39;</span><span class="p">],</span> <span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">src_tokens_length</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;src_tokens_length&#39;</span><span class="p">],</span> <span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">predicted_idx</span> <span class="o">=</span> <span class="n">ft_infer</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_tokens_length</span><span class="p">)</span>
    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_idx</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
</section>
<section id="评估模型">
<h3>评估模型<a class="headerlink" href="#评估模型" title="Permalink to this headline"></a></h3>
<p>计算模型的预测值与真实值之前的误差，输出模型的每个batch精度。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">merge_predictions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 调整输出格式</span>
<span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
    <span class="n">merge_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">prediction</span><span class="p">])</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">merge_predictions</span>
<span class="n">target_sens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_sens</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">merge_target_sens</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 放入到测试列表中</span>
<span class="k">for</span> <span class="n">target_sen</span> <span class="ow">in</span> <span class="n">target_sens</span><span class="p">:</span>
    <span class="n">merge_target_sens</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">target_sen</span><span class="p">])</span>
<span class="n">target_sens</span> <span class="o">=</span> <span class="n">merge_target_sens</span>

<span class="c1"># 输出每组batch对应的acc值</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_sens</span><span class="p">)):</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">target_sens</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy: &quot;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy:  0.8404494382022472
Accuracy:  0.9140625
Accuracy:  0.912109375
Accuracy:  0.91796875
Accuracy:  0.923828125
Accuracy:  0.93359375
Accuracy:  0.9453125
Accuracy:  0.923828125
Accuracy:  0.90625
Accuracy:  0.9140625
Accuracy:  0.9375
Accuracy:  0.91796875
Accuracy:  0.923828125
Accuracy:  0.9050772626931567
Accuracy:  0.912109375
Accuracy:  0.9347826086956522
</pre></div></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="rnn_generation.html" class="btn btn-neutral float-left" title="使用字符级RNN生成名称" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="text_translation_gru_tutorial.html" class="btn btn-neutral float-right" title="序列到序列（seq2seq）模型实现文本翻译" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
        <script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>