

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ResNet-50 for Image Classification &mdash; MindSpore master documentation</title>
  

  
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Image Classification Transfer Learning" href="transfer_learning.html" />
    <link rel="prev" title="Application" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">CV</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">ResNet-50 for Image Classification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-resnet">Introduction to ResNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-and-loading-datasets">Preparing and Loading Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-network">Building a Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-a-residual-network">Building a Residual Network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-block">Building Block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bottleneck">Bottleneck</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-a-resnet-50-network">Building a ResNet-50 Network</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-training-and-evaluation">Model Training and Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualizing-model-prediction-results">Visualizing Model Prediction Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="transfer_learning.html">Image Classification Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="fgsm.html">Model Adversarial Attack</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcgan.html">Generating Cartoon Head Portrait via DCGAN</a></li>
</ul>
<p class="caption"><span class="caption-text">NLP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nlp/sentiment_analysis.html">Sentiment Classification Implemented by RNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/sequence_labeling.html">LSTM+CRF Sequence Labeling</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>ResNet-50 for Image Classification</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/cv/resnet50.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="resnet-50-for-image-classification">
<h1>ResNet-50 for Image Classification<a class="headerlink" href="#resnet-50-for-image-classification" title="Permalink to this headline">¶</a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r1.8/tutorials/application/source_en/cv/resnet50.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/resource/_static/logo_source_en.png"></a></p>
<p>Image classification is the most basic computer vision application and belongs to the supervised learning category. For example, we can determine the category to which an image (such as an image of a cat, a dog, an airplane, or a car) belongs. The following describes how to use ResNet-50 to classify the CIFAR-10 dataset.</p>
<div class="section" id="introduction-to-resnet">
<h2>Introduction to ResNet<a class="headerlink" href="#introduction-to-resnet" title="Permalink to this headline">¶</a></h2>
<p>ResNet-50 was proposed by He Kaiming of Microsoft Research in 2015 and won the championship in the 2015 ILSVRC. Before ResNet was proposed, a convolutional neural network was obtained by stacking a series of convolutional layers and pooling layers. However, when the network was stacked to a specific depth, a degradation problem occurred. The following figures show the training error and test error of a 56-layer network and a 20-layer network on the CIFAR-10 dataset. The data in the figures shows that the training error and test error of the 56-layer network are greater than those of the 20-layer network. As the network depth increases, the errors do not decrease as expected.</p>
<p><img alt="resnet-1" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_1.png" /></p>
<p>In ResNet, a residual network is proposed to alleviate the degradation problem, and a relatively deep network (with more than 1,000 layers) can be built by using ResNet. The following figure shows the training error and test error of ResNet on the CIFAR-10 dataset. In the figure, the dotted lines indicate the training errors, and the solid lines indicate the test errors. As shown in the figure, a deeper ResNet indicates a smaller training error and a smaller test error.</p>
<p><img alt="resnet-4" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_4.png" /></p>
<blockquote>
<div><p>For more details about ResNet, see <a class="reference external" href="https://arxiv.org/pdf/1512.03385.pdf"><em>Deep Residual Learning for Image Recognition</em></a>.</p>
</div></blockquote>
</div>
<div class="section" id="preparing-and-loading-datasets">
<h2>Preparing and Loading Datasets<a class="headerlink" href="#preparing-and-loading-datasets" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.cs.toronto.edu/~kriz/cifar.html">The CIFAR-10 dataset</a> contains 60,000 32 x 32 color images in 10 classes, with 6,000 images per class. There are 50,000 training images and 10,000 test images. The following example uses the <code class="docutils literal notranslate"><span class="pre">mindvision.classification.dataset.Cifar10</span></code> API to download and load the CIFAR-10 dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindvision.classification.dataset</span> <span class="kn">import</span> <span class="n">Cifar10</span>

<span class="c1"># Dataset root directory</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;./datasets&quot;</span>

<span class="c1"># Download, decompress, and load the CIFAR-10 training dataset.</span>
<span class="n">dataset_train</span> <span class="o">=</span> <span class="n">Cifar10</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">dataset_train</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="c1"># Download, decompress, and load the CIFAR-10 test dataset.</span>
<span class="n">dataset_val</span> <span class="o">=</span> <span class="n">Cifar10</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_val</span> <span class="o">=</span> <span class="n">dataset_val</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The directory structure of the CIFAR-10 dataset file is as follows:</p>
<div class="highlight-Text notranslate"><div class="highlight"><pre><span></span>datasets/
├── cifar-10-batches-py
│   ├── batches.meta
│   ├── data_batch_1
│   ├── data_batch_2
│   ├── data_batch_3
│   ├── data_batch_4
│   ├── data_batch_5
│   ├── readme.html
│   └── test_batch
└── cifar-10-python.tar.gz
</pre></div>
</div>
<p>Visualize the CIFAR-10 training dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ds_train</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">())</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image shape: </span><span class="si">{</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Label: </span><span class="si">{</span><span class="n">labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">image_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">])</span>
    <span class="n">image_trans</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">image_trans</span> <span class="o">+</span> <span class="n">mean</span>
    <span class="n">image_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image_trans</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_train</span><span class="o">.</span><span class="n">index2label</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_trans</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">Image</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">Label</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span> <span class="mi">4</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_3_1.png" /></p>
</div>
<div class="section" id="building-a-network">
<h2>Building a Network<a class="headerlink" href="#building-a-network" title="Permalink to this headline">¶</a></h2>
<p>The residual network is a main highlight of ResNet, with which the degradation problem can be effectively alleviated, a deeper network can be designed, and the network training accuracy can be improved. The following describes how to build a residual network and then build a ResNet-50 network by stacking residual networks.</p>
<div class="section" id="building-a-residual-network">
<h3>Building a Residual Network<a class="headerlink" href="#building-a-residual-network" title="Permalink to this headline">¶</a></h3>
<p>The following figure shows the structure of a residual network. The residual network consists of two parts: main body and a shortcut (see the arc in the figure). The main body is obtained by stacking a series of convolution operations. The shortcut is directly from input to output. <span class="math notranslate nohighlight">\(F(x)+x\)</span> is obtained by adding the feature matrix <span class="math notranslate nohighlight">\(F(x)\)</span> output by the main body to the feature matrix <span class="math notranslate nohighlight">\(x\)</span> output by the shortcut. After the ReLU activation function is used, the final output of the residual network is obtained.</p>
<p><img alt="residual" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_3.png" /></p>
<p>There are two residual network structures. One is the building block, which is applicable to shallow ResNet, such as ResNet-18 and ResNet-34. The other is the bottleneck, which is applicable to deep ResNet, such as ResNet-50, ResNet-101, and ResNet-152.</p>
<div class="section" id="building-block">
<h4>Building Block<a class="headerlink" href="#building-block" title="Permalink to this headline">¶</a></h4>
<p>The following figure shows the structure of the building block. The main body has two convolutional layers.</p>
<ul class="simple">
<li><p>On the first-layer network of the main body. 64 input channels are used. Then, 64 output channels are obtained through the <span class="math notranslate nohighlight">\(3\times3\)</span> convolutional layer, the Batch Normalization layer, and the ReLU activation function layer.</p></li>
<li><p>On the second-layer network of the main body, 64 input channels are also used. Then, 64 output channels are obtained through the <span class="math notranslate nohighlight">\(3\times3\)</span> convolutional layer, the Batch Normalization layer, and the ReLU activation function layer.</p></li>
</ul>
<p>Finally, the feature matrix output by the main body is added to the feature matrix output by the shortcut. After the ReLU activation function is used, the final output of the building block is obtained.</p>
<p><img alt="building-block-5" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_5.png" /></p>
<p>When adding the feature matrix output by the main body to that output by the shortcut, ensure that the shape of the feature matrix output by the main body is the same as that of the feature matrix output by the shortcut. If the shapes are different, for example, when the number of output channels is twice that of input channels, the number of convolution kernels used by the shortcut for convolution operations is the same as that of the output channels and the size is <span class="math notranslate nohighlight">\(1\times1\)</span>. If the size of the output image is half of that of the input image, <code class="docutils literal notranslate"><span class="pre">stride</span></code> in the convolution operation of the shortcut must be set to <strong>2</strong>, and <code class="docutils literal notranslate"><span class="pre">stride</span></code> in the first-layer convolution operation of the main body must also be set to <strong>2</strong>.</p>
<p>The following code defines the <code class="docutils literal notranslate"><span class="pre">ResidualBlockBase</span></code> class to implement the building block structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models.blocks</span> <span class="kn">import</span> <span class="n">ConvNormActivation</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>


<span class="k">class</span> <span class="nc">ResidualBlockBase</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="n">expansion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># The number of convolution kernels at the last layer is the same as that of convolution kernels at the first layer.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">down_sample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResidualBlockBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">norm</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span>
                                        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">out_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span>
                                        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span> <span class="o">=</span> <span class="n">down_sample</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ResidualBlockBase construct.&quot;&quot;&quot;</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># shortcut</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># First layer of the main body: 3 x 3 convolutional layer</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># Second layer of the main body: 3 x 3 convolutional layer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">identity</span>  <span class="c1"># The output is the sum of the main body and the shortcut.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
<div class="section" id="bottleneck">
<h4>Bottleneck<a class="headerlink" href="#bottleneck" title="Permalink to this headline">¶</a></h4>
<p>The following figure shows the bottleneck structure. With the same input, the bottleneck structure has fewer parameters than the building block structure. Therefore, the bottleneck structure is more suitable for a deep network. The residual structure used by ResNet-50 is bottleneck. The main body of this structure has three convolutional layers, namely, <span class="math notranslate nohighlight">\(1\times1\)</span>, <span class="math notranslate nohighlight">\(3\times3\)</span>, and <span class="math notranslate nohighlight">\(1\times1\)</span>. <span class="math notranslate nohighlight">\(1\times1\)</span> is used for dimension reduction and dimension rollup.</p>
<ul class="simple">
<li><p>On the first-layer network of the main body, 256 input channels are used. Dimension reduction is performed by using 64 convolution kernels with a size of <span class="math notranslate nohighlight">\(1\times1\)</span>. Then, 64 output channels are obtained through the Batch Normalization layer and the ReLU activation function layer.</p></li>
<li><p>On the second-layer network of the main body, features are extracted by using 64 convolution kernels with a size of <span class="math notranslate nohighlight">\(3\times3\)</span>. Then, 64 output channels are obtained through the Batch Normalization layer and the ReLU activation function layer.</p></li>
<li><p>On the third-layer network of the main body, dimension rollup is performed by using 256 convolution kernels with a size of <span class="math notranslate nohighlight">\(1\times1\)</span>. Then, 256 output channels are obtained through the Batch Normalization layer.</p></li>
</ul>
<p>Finally, the feature matrix output by the main body is added to the feature matrix output by the shortcut. After the ReLU activation function is used, the final output of the bottleneck is obtained.</p>
<p><img alt="building-block-6" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_6.png" /></p>
<p>When adding the feature matrix output by the main body to that output by the shortcut, ensure that the shape of the feature matrix output by the main body is the same as that of the feature matrix output by the shortcut. If the shapes are different, for example, when the number of output channels is twice that of input channels, the number of convolution kernels used by the shortcut for convolution operations is the same as that of the output channels and the size is <span class="math notranslate nohighlight">\(1\times1\)</span>. If the size of the output image is half of that of the input image, <code class="docutils literal notranslate"><span class="pre">stride</span></code> in the convolution operation of the shortcut must be set to <strong>2</strong>, and <code class="docutils literal notranslate"><span class="pre">stride</span></code> in the second-layer convolution operation of the main body must also be set to <strong>2</strong>.</p>
<p>The following code defines the <code class="docutils literal notranslate"><span class="pre">ResidualBlock</span></code> class to implement the bottleneck structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResidualBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># The number of convolution kernels at the last layer is four times that of convolution kernels at the first layer.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">down_sample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResidualBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">norm</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span>
                                        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">out_channel</span><span class="p">,</span> <span class="n">out_channel</span><span class="p">,</span>
                                        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">out_channel</span><span class="p">,</span> <span class="n">out_channel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span>
                                        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span> <span class="o">=</span> <span class="n">down_sample</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># shortcut</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># First layer of the main body: 1 x 1 convolutional layer</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># Second layer of the main body: 3 x 3 convolutional layer</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># Third layer of the main body: 1 x 1 convolutional layer</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">:</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_sample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">identity</span>  <span class="c1"># The output is the sum of the main body and the shortcut.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
<div class="section" id="building-a-resnet-50-network">
<h4>Building a ResNet-50 Network<a class="headerlink" href="#building-a-resnet-50-network" title="Permalink to this headline">¶</a></h4>
<p>The following figure shows the structure of ResNet. Take the input color image <span class="math notranslate nohighlight">\(224\times224\)</span> as an example. 64 conv1 whose size is <span class="math notranslate nohighlight">\(7\times7\)</span> and whose stride is 2 are used. The output image size at this layer is <span class="math notranslate nohighlight">\(112\times112\)</span>, and the number of the output channels is 64. Then, a maximum downsampling pooling layer with a size of <span class="math notranslate nohighlight">\(3\times3\)</span> is used. The output image size at this layer is <span class="math notranslate nohighlight">\(56\times56\)</span>, and the number of output channels is 64. Four residual network blocks (conv2_x, conv3_x, conv4_x, and conv5_x) are stacked. In this case, the size of the output image is <span class="math notranslate nohighlight">\(7\times7\)</span>, and the number of the output channels is 2048. Finally, the classification probability is obtained through an average pooling layer, a fully-connected layer, and softmax.</p>
<p><img alt="resnet-layer" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.8/tutorials/application/source_zh_cn/cv/images/resnet_2.png" /></p>
<p>For each residual network block, conv2_x in ResNet-50 is used as an example. The residual network block is formed by stacking three bottleneck structures, and each bottleneck structure has 64 input channels and 256 output channels.</p>
<p>The following example defines <code class="docutils literal notranslate"><span class="pre">make_layer</span></code> to build residual blocks. The parameters are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">last_out_channel</span></code>: number of output channels of the previous residual network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block</span></code>: residual network type. The value can be <code class="docutils literal notranslate"><span class="pre">ResidualBlockBase</span></code> or <code class="docutils literal notranslate"><span class="pre">ResidualBlock</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">channel</span></code>: number of input channels of the residual network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block_nums</span></code>: number of stacked residual network blocks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stride</span></code>: stride of the convolution movement</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_layer</span><span class="p">(</span><span class="n">last_out_channel</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ResidualBlockBase</span><span class="p">,</span> <span class="n">ResidualBlock</span><span class="p">]],</span>
               <span class="n">channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_nums</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">down_sample</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># shortcut</span>

    <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">last_out_channel</span> <span class="o">!=</span> <span class="n">channel</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">:</span>
        <span class="n">down_sample</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="n">last_out_channel</span><span class="p">,</span> <span class="n">channel</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span>
                                         <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">(</span><span class="n">last_out_channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">down_sample</span><span class="o">=</span><span class="n">down_sample</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">))</span>

    <span class="n">in_channel</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span>
    <span class="c1"># Stack residual networks.</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">block_nums</span><span class="p">):</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">(</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
</pre></div>
</div>
<p>ResNet-50 has five convolution structures, one average pooling layer, and one fully-connected layer. The following uses the CIFAR-10 dataset as an example:</p>
<ul class="simple">
<li><p><strong>conv1</strong>: The size of the input image is <span class="math notranslate nohighlight">\(32\times32\)</span>, and the number of the input channels is 3. A convolutional layer with 64 convolution kernels, a size of <span class="math notranslate nohighlight">\(7\times7\)</span> size, and a stride of 2, a Batch Normalization layer, and a ReLU activation function are used. The size of the output feature map at this layer is <span class="math notranslate nohighlight">\(16\times16\)</span>, and the number of the output channels is 64.</p></li>
<li><p><strong>conv2_x</strong>: The size of the input feature map is <span class="math notranslate nohighlight">\(16\times16\)</span>, and the number of the input channels is 64. First, a maximum downsampling pooling operation with a size of <span class="math notranslate nohighlight">\(3\times3\)</span> and a stride of 2 is performed. Then, three bottlenecks with the <span class="math notranslate nohighlight">\([1\times1, 64; 3\times3, 64; 1\times1, 256]\)</span> structure are stacked. The size of the output feature map at this layer is <span class="math notranslate nohighlight">\(8\times8\)</span>, and the number of the output channels is 256.</p></li>
<li><p><strong>conv3_x</strong>: The size of the input feature map is <span class="math notranslate nohighlight">\(8\times8\)</span>, and the number of the input channels is 256. Four bottlenecks with the [1 x 1, 128; 3 x 3, 128; 1 x 1, 512] structure are stacked at this layer. The size of the output feature map at this layer is <span class="math notranslate nohighlight">\(4\times4\)</span>, and the number of the output channels is 512.</p></li>
<li><p><strong>conv4_x</strong>: The size of the input feature map is <span class="math notranslate nohighlight">\(4\times4\)</span>, and the number of the input channels is 512. Six bottlenecks with the [1 x 1, 256; 3 x 3, 256; 1 x 1, 1024] structure are stacked at this layer. The size of the output feature map at this layer is <span class="math notranslate nohighlight">\(2\times2\)</span>, and the number of the output channels is 1024.</p></li>
<li><p><strong>conv5_x</strong>: The size of the input feature map is <span class="math notranslate nohighlight">\(2\times2\)</span>, and the number of the input channels is 1024. Three bottlenecks with the [1 x 1, 512; 3 x 3, 512; 1 x 1, 2048] structure are stacked at this layer. The size of the output feature map at this layer is <span class="math notranslate nohighlight">\(1\times1\)</span>, and the number of the output channels is 2048.</p></li>
<li><p><strong>average pool &amp; fc</strong>: The number of the input channels is 2048, and the number of the output channels is the number of classes.</p></li>
</ul>
<p>The following sample code is used to build a ResNet-50 model. You can call the <code class="docutils literal notranslate"><span class="pre">resnet50</span></code> function to build a ResNet-50 model. The parameters of the <code class="docutils literal notranslate"><span class="pre">resnet50</span></code> function are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_classes</span></code>: number of classes. The default value is <strong>1000</strong>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pretrained</span></code>: Used to download the corresponding training model and load the parameters in the pre-trained model to the network.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindvision.classification.models.classifiers</span> <span class="kn">import</span> <span class="n">BaseClassifier</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models.head</span> <span class="kn">import</span> <span class="n">DenseHead</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models.neck</span> <span class="kn">import</span> <span class="n">GlobalAvgPooling</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.utils.model_urls</span> <span class="kn">import</span> <span class="n">model_urls</span>
<span class="kn">from</span> <span class="nn">mindvision.utils.load_pretrained_model</span> <span class="kn">import</span> <span class="n">LoadPretrainedModel</span>


<span class="k">class</span> <span class="nc">ResNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ResidualBlockBase</span><span class="p">,</span> <span class="n">ResidualBlock</span><span class="p">]],</span>
                 <span class="n">layer_nums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">norm</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span>
        <span class="c1"># At the first convolutional layer, the number of the input channels is 3 (color image) and that of the output channels is 64.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">ConvNormActivation</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="c1"># Maximum pooling layer, reducing the image size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="c1"># Definition of each residual network structure block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">make_layer</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">layer_nums</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">make_layer</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">layer_nums</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="n">make_layer</span><span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">layer_nums</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer4</span> <span class="o">=</span> <span class="n">make_layer</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">layer_nums</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_resnet</span><span class="p">(</span><span class="n">arch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ResidualBlockBase</span><span class="p">,</span> <span class="n">ResidualBlock</span><span class="p">]],</span>
            <span class="n">layers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">input_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">backbone</span> <span class="o">=</span> <span class="n">ResNet</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
    <span class="n">neck</span> <span class="o">=</span> <span class="n">GlobalAvgPooling</span><span class="p">()</span>  <span class="c1"># Average pooling layer</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">DenseHead</span><span class="p">(</span><span class="n">input_channel</span><span class="o">=</span><span class="n">input_channel</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># Fully-connected layer</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BaseClassifier</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">neck</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>  <span class="c1"># Connect the backbone layer, neck layer, and head layer.</span>

    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
        <span class="c1"># Download and load the pre-trained model.</span>
        <span class="n">LoadPretrainedModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_urls</span><span class="p">[</span><span class="n">arch</span><span class="p">])</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">resnet50</span><span class="p">(</span><span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;ResNet-50 model&quot;</span>
    <span class="k">return</span> <span class="n">_resnet</span><span class="p">(</span><span class="s2">&quot;resnet50&quot;</span><span class="p">,</span> <span class="n">ResidualBlock</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">pretrained</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-training-and-evaluation">
<h2>Model Training and Evaluation<a class="headerlink" href="#model-training-and-evaluation" title="Permalink to this headline">¶</a></h2>
<p>In this part, <a class="reference external" href="https://download.mindspore.cn/vision/classification/resnet50_224.ckpt">a ResNet-50 pre-trained model</a> is used for fine-tuning. Call <code class="docutils literal notranslate"><span class="pre">resnet50</span></code> to build a ResNet-50 model and set <code class="docutils literal notranslate"><span class="pre">pretrained</span></code> to <strong>True</strong>. The ResNet-50 pre-trained model is automatically downloaded and the parameters of the pre-trained model are loaded to the network. Define an optimizer and a loss function, train the network by using the <code class="docutils literal notranslate"><span class="pre">model.train</span></code> API, and transfer the <code class="docutils literal notranslate"><span class="pre">mindvision.engine.callback.ValAccMonitor</span></code> API in MindSpore Vision to the callback function. The loss value and evaluation accuracy of the training are printed, and the CKPT file (<strong>best.ckpt</strong>) with the highest evaluation accuracy is saved to the current directory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mindvision.engine.callback</span> <span class="kn">import</span> <span class="n">ValAccMonitor</span>

<span class="c1"># Define the ResNet-50 network.</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Size of the input layer of the fully-connected layer</span>
<span class="n">in_channel</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">dense</span><span class="o">.</span><span class="n">in_channels</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">DenseHead</span><span class="p">(</span><span class="n">input_channel</span><span class="o">=</span><span class="n">in_channel</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># Reset the fully-connected layer.</span>
<span class="n">network</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span>
<span class="c1"># Set the learning rate.</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">cosine_decay_lr</span><span class="p">(</span><span class="n">min_lr</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">total_step</span><span class="o">=</span><span class="n">step_size</span> <span class="o">*</span> <span class="n">num_epochs</span><span class="p">,</span>
                        <span class="n">step_per_epoch</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">decay_epoch</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">)</span>
<span class="c1"># Define an optimizer and a loss function.</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="c1"># Instantiate the model.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()})</span>
<span class="c1"># Perform model training.</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">,</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ValAccMonitor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds_val</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-Text notranslate"><div class="highlight"><pre><span></span>--------------------
Epoch: [  0 /  40], Train Loss: [2.733], Accuracy:  0.274
--------------------
Epoch: [  1 /  40], Train Loss: [2.877], Accuracy:  0.319
--------------------
Epoch: [  2 /  40], Train Loss: [2.438], Accuracy:  0.249
--------------------
Epoch: [  3 /  40], Train Loss: [1.532], Accuracy:  0.386

······

Epoch: [ 37 /  40], Train Loss: [1.142], Accuracy:  0.738
--------------------
Epoch: [ 38 /  40], Train Loss: [0.402], Accuracy:  0.727
--------------------
Epoch: [ 39 /  40], Train Loss: [2.031], Accuracy:  0.735
--------------------
Epoch: [ 40 /  40], Train Loss: [0.582], Accuracy:  0.745
================================================================================
End of validation the best Accuracy is:  0.754, save the best ckpt file in ./best.ckpt
</pre></div>
</div>
</div>
<div class="section" id="visualizing-model-prediction-results">
<h2>Visualizing Model Prediction Results<a class="headerlink" href="#visualizing-model-prediction-results" title="Permalink to this headline">¶</a></h2>
<p>Define the <code class="docutils literal notranslate"><span class="pre">visualize_model</span></code> function, use the model with the highest validation accuracy described above to predict the CIFAR-10 dataset, and visualize the prediction result. If the prediction result is in blue, the prediction is correct. If the prediction result is in red, the prediction is incorrect.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>


<span class="k">def</span> <span class="nf">visualize_model</span><span class="p">(</span><span class="n">best_ckpt_path</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">):</span>
    <span class="n">num_class</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Perform binary classification on wolf and dog images.</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">num_class</span><span class="p">)</span>
    <span class="c1"># Load model parameters.</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">best_ckpt_path</span><span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="c1"># Load the validation dataset.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">val_ds</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">())</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="c1"># Predict the image type.</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]))</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Display the image and the predicted value of the image.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># If the prediction is correct, the color is blue. If the prediction is incorrect, the color is red.</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="n">pred</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;predict:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_val</span><span class="o">.</span><span class="n">index2label</span><span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">picture_show</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">])</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">])</span>
        <span class="n">picture_show</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">picture_show</span> <span class="o">+</span> <span class="n">mean</span>
        <span class="n">picture_show</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">picture_show</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">picture_show</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Use the test dataset for validation.</span>
<span class="n">visualize_model</span><span class="p">(</span><span class="s1">&#39;best.ckpt&#39;</span><span class="p">,</span> <span class="n">ds_val</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_161_0.png" /></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="transfer_learning.html" class="btn btn-neutral float-right" title="Image Classification Transfer Learning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../index.html" class="btn btn-neutral float-left" title="Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>