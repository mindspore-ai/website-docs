

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>GAN图像生成 &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
   
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DCGAN生成漫画头像" href="dcgan.html" />
    <link rel="prev" title="LSTM+CRF序列标注" href="../nlp/sequence_labeling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">计算机视觉</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cv/resnet50.html">ResNet50图像分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/transfer_learning.html">ResNet50迁移学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/fgsm.html">FGSM网络对抗攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/vit.html">Vision Transformer图像分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/cnnctc.html">CNN+CTC图像文本识别</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/fcn8s.html">FCN图像语义分割</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/shufflenet.html">ShuffleNet图像分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cv/ssd.html">SSD目标检测</a></li>
</ul>
<p class="caption"><span class="caption-text">自然语言处理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nlp/sentiment_analysis.html">RNN实现情感分类</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nlp/sequence_labeling.html">LSTM+CRF序列标注</a></li>
</ul>
<p class="caption"><span class="caption-text">生成式</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">GAN图像生成</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#模型简介">模型简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#数据集">数据集</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#数据集简介">数据集简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#数据集下载">数据集下载</a></li>
<li class="toctree-l3"><a class="reference internal" href="#数据加载">数据加载</a></li>
<li class="toctree-l3"><a class="reference internal" href="#数据集可视化">数据集可视化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#隐码构造">隐码构造</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#模型构建">模型构建</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#生成器">生成器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#判别器">判别器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#损失函数和优化器">损失函数和优化器</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#模型训练">模型训练</a></li>
<li class="toctree-l2"><a class="reference internal" href="#效果展示">效果展示</a></li>
<li class="toctree-l2"><a class="reference internal" href="#模型推理">模型推理</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dcgan.html">DCGAN生成漫画头像</a></li>
<li class="toctree-l1"><a class="reference internal" href="pix2pix.html">Pix2Pix实现图像转换</a></li>
<li class="toctree-l1"><a class="reference internal" href="cyclegan.html">CycleGAN图像风格迁移互换</a></li>
<li class="toctree-l1"><a class="reference internal" href="diffusion.html">Diffusion扩散模型</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>GAN图像生成</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/generative/gan.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gan图像生成">
<h1>GAN图像生成<a class="headerlink" href="#gan图像生成" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r2.0/tutorials/application/zh_cn/generative/mindspore_gan.ipynb"><img alt="下载Notebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_notebook.png" /></a> <a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r2.0/tutorials/application/zh_cn/generative/mindspore_gan.py"><img alt="下载样例代码" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_download_code.png" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.0/tutorials/application/source_zh_cn/generative/gan.ipynb"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/resource/_static/logo_source.png" /></a></p>
<div class="section" id="模型简介">
<h2>模型简介<a class="headerlink" href="#模型简介" title="Permalink to this headline">¶</a></h2>
<p>生成式对抗网络(Generative Adversarial Networks，GAN)是一种生成式机器学习模型，是近年来复杂分布上无监督学习最具前景的方法之一。</p>
<p>最初，GAN由Ian J. Goodfellow于2014年发明，并在论文<a class="reference external" href="https://papers.nips.cc/paper/5423-generative-adversarial-nets.pdf">Generative Adversarial Nets</a>中首次进行了描述，其主要由两个不同的模型共同组成——生成器(Enerative Model)和判别器(Discriminative Model)：</p>
<ul class="simple">
<li><p>生成器的任务是生成看起来像训练图像的“假”图像；</p></li>
<li><p>判别器需要判断从生成器输出的图像是真实的训练图像还是虚假的图像。</p></li>
</ul>
<p>GAN通过设计生成模型和判别模型这两个模块，使其互相博弈学习产生了相当好的输出。</p>
<p>GAN模型的核心在于提出了通过对抗过程来估计生成模型这一全新框架。在这个框架中，将会同时训练两个模型——捕捉数据分布的生成模型 <span class="math notranslate nohighlight">\(G\)</span> 和估计样本是否来自训练数据的判别模型 <span class="math notranslate nohighlight">\(D\)</span> 。</p>
<p>在训练过程中，生成器会不断尝试通过生成更好的假图像来骗过判别器，而判别器在这过程中也会逐步提升判别能力。这种博弈的平衡点是，当生成器生成的假图像和训练数据图像的分布完全一致时，判别器拥有50%的真假判断置信度。</p>
<p>用 <span class="math notranslate nohighlight">\(x\)</span> 代表图像数据，用 <span class="math notranslate nohighlight">\(D(x)\)</span>表示判别器网络给出图像判定为真实图像的概率。在判别过程中，<span class="math notranslate nohighlight">\(D(x)\)</span> 需要处理作为二进制文件的大小为 <span class="math notranslate nohighlight">\(1\times 28\times 28\)</span> 的图像数据。当 <span class="math notranslate nohighlight">\(x\)</span> 来自训练数据时，<span class="math notranslate nohighlight">\(D(x)\)</span> 数值应该趋近于 <span class="math notranslate nohighlight">\(1\)</span> ；而当 <span class="math notranslate nohighlight">\(x\)</span> 来自生成器时，<span class="math notranslate nohighlight">\(D(x)\)</span> 数值应该趋近于 <span class="math notranslate nohighlight">\(0\)</span> 。因此 <span class="math notranslate nohighlight">\(D(x)\)</span> 也可以被认为是传统的二分类器。</p>
<p>用 <span class="math notranslate nohighlight">\(z\)</span> 代表标准正态分布中提取出的隐码(隐向量)，用 <span class="math notranslate nohighlight">\(G(z)\)</span>：表示将隐码(隐向量) <span class="math notranslate nohighlight">\(z\)</span> 映射到数据空间的生成器函数。函数 <span class="math notranslate nohighlight">\(G(z)\)</span> 的目标是将服从高斯分布的随机噪声 <span class="math notranslate nohighlight">\(z\)</span> 通过生成网络变换为近似于真实分布 <span class="math notranslate nohighlight">\(p_{data}(x)\)</span> 的数据分布，我们希望找到 <span class="math notranslate nohighlight">\(θ\)</span> 使得 <span class="math notranslate nohighlight">\(p_{G}(x;\theta)\)</span> 和 <span class="math notranslate nohighlight">\(p_{data}(x)\)</span> 尽可能的接近，其中 <span class="math notranslate nohighlight">\(\theta\)</span> 代表网络参数。</p>
<p><span class="math notranslate nohighlight">\(D(G(z))\)</span> 表示生成器 <span class="math notranslate nohighlight">\(G\)</span> 生成的假图像被判定为真实图像的概率，如<a class="reference external" href="https://papers.nips.cc/paper/5423-generative-adversarial-nets.pdf">Generative Adversarial Nets</a>中所述，<span class="math notranslate nohighlight">\(D\)</span> 和 <span class="math notranslate nohighlight">\(G\)</span> 在进行一场博弈，<span class="math notranslate nohighlight">\(D\)</span> 想要最大程度的正确分类真图像与假图像，也就是参数 <span class="math notranslate nohighlight">\(\log D(x)\)</span>；而 <span class="math notranslate nohighlight">\(G\)</span> 试图欺骗 <span class="math notranslate nohighlight">\(D\)</span> 来最小化假图像被识别到的概率，也就是参数 <span class="math notranslate nohighlight">\(\log(1−D(G(z)))\)</span>。因此GAN的损失函数为：</p>
<div class="math notranslate nohighlight">
\[\min\limits_{G}\max\limits_{D} V(D,G)=E_{x\sim p_{data}\;\,(x)}[\log D(x)]+E_{z\sim p_{z}\,(z)}[\log (1-D(G(z)))]\]</div>
<p>从理论上讲，此博弈游戏的平衡点是<span class="math notranslate nohighlight">\(p_{G}(x;\theta) = p_{data}(x)\)</span>，此时判别器会随机猜测输入是真图像还是假图像。下面我们简要说明生成器和判别器的博弈过程：</p>
<ol class="arabic simple">
<li><p>在训练刚开始的时候，生成器和判别器的质量都比较差，生成器会随机生成一个数据分布。</p></li>
<li><p>判别器通过求取梯度和损失函数对网络进行优化，将靠近真实数据分布的数据判定为1，将靠近生成器生成出来数据分布的数据判定为0。</p></li>
<li><p>生成器通过优化，生成出更加贴近真实数据分布的数据。</p></li>
<li><p>生成器所生成的数据和真实数据达到相同的分布，此时判别器的输出为1/2。</p></li>
</ol>
<p><img alt="gan" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/tutorials/application/source_zh_cn/cv/images/gan_image.png" /></p>
<p>在上图中，蓝色虚线表示判别器，黑色虚线表示真实数据分布，绿色实线表示生成器生成的虚假数据分布，<span class="math notranslate nohighlight">\(z\)</span> 表示隐码，<span class="math notranslate nohighlight">\(x\)</span> 表示生成的虚假图像 <span class="math notranslate nohighlight">\(G(z)\)</span>。该图片来源于<a class="reference external" href="https://papers.nips.cc/paper/5423-generative-adversarial-nets.pdf">Generative Adversarial Nets</a>。详细的训练方法介绍见原论文。</p>
</div>
<div class="section" id="数据集">
<h2>数据集<a class="headerlink" href="#数据集" title="Permalink to this headline">¶</a></h2>
<div class="section" id="数据集简介">
<h3>数据集简介<a class="headerlink" href="#数据集简介" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://yann.lecun.com/exdb/mnist/">MNIST手写数字数据集</a>是NIST数据集的子集，共有70000张手写数字图片，包含60000张训练样本和10000张测试样本，数字图片为二进制文件，图片大小为28*28，单通道。图片已经预先进行了尺寸归一化和中心化处理。</p>
<p>本案例将使用MNIST手写数字数据集来训练一个生成式对抗网络，使用该网络模拟生成手写数字图片。</p>
</div>
<div class="section" id="数据集下载">
<h3>数据集下载<a class="headerlink" href="#数据集下载" title="Permalink to this headline">¶</a></h3>
<p>使用<code class="docutils literal notranslate"><span class="pre">download</span></code>接口下载数据集，并将下载后的数据集自动解压到当前目录下。数据下载之前需要使用<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">download</span></code>安装<code class="docutils literal notranslate"><span class="pre">download</span></code>包。</p>
<p>下载解压后的数据集目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>./MNIST_Data/
├─ train
│ ├─ train-images-idx3-ubyte
│ └─ train-labels-idx1-ubyte
└─ test
   ├─ t10k-images-idx3-ubyte
   └─ t10k-labels-idx1-ubyte
</pre></div>
</div>
<p>数据下载的代码如下：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 数据下载</span>
<span class="kn">from</span> <span class="nn">download</span> <span class="kn">import</span> <span class="n">download</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/MNIST_Data.zip&quot;</span>
<span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Downloading data from https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/MNIST_Data.zip (10.3 MB)

file_sizes: 100%|███████████████████████████| 10.8M/10.8M [00:23&lt;00:00, 455kB/s]
Extracting zip file...
Successfully downloaded / unzipped to .
</pre></div></div>
</div>
</div>
<div class="section" id="数据加载">
<h3>数据加载<a class="headerlink" href="#数据加载" title="Permalink to this headline">¶</a></h3>
<p>使用MindSpore自己的<code class="docutils literal notranslate"><span class="pre">MnistDatase</span></code>接口，读取和解析MNIST数据集的源文件构建数据集。然后对数据进行一些前处理。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">latent_size</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 隐码的长度</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="s1">&#39;./MNIST_Data/train&#39;</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">=</span><span class="s1">&#39;./MNIST_Data/test&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">data_load</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">dataset1</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">python_multiprocessing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 数据增强</span>
    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">dataset1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">operations</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">10000</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">latent_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
            <span class="n">output_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_code&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">dataset1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">operations</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">latent_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)),</span>
            <span class="n">output_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_code&quot;</span><span class="p">])</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">project</span><span class="p">([</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_code&quot;</span><span class="p">])</span>

    <span class="c1"># 批量操作</span>
    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size_valid</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mnist_ds</span>

<span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">data_load</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

<span class="n">iter_size</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">get_dataset_size</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iter size： </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">iter_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iter size： 468
</pre></div></div>
</div>
</div>
<div class="section" id="数据集可视化">
<h3>数据集可视化<a class="headerlink" href="#数据集可视化" title="Permalink to this headline">¶</a></h3>
<p>通过<code class="docutils literal notranslate"><span class="pre">create_dict_iterator</span></code>函数将数据转换成字典迭代器，然后使用<code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>模块可视化部分训练数据。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">data_iter</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">mnist_ds</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">(</span><span class="n">output_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span> <span class="o">*</span> <span class="n">rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">data_iter</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/generative_gan_6_0.png" src="../_images/generative_gan_6_0.png" />
</div>
</div>
</div>
<div class="section" id="隐码构造">
<h3>隐码构造<a class="headerlink" href="#隐码构造" title="Permalink to this headline">¶</a></h3>
<p>为了跟踪生成器的学习进度，我们在训练的过程中的每轮迭代结束后，将一组固定的遵循高斯分布的隐码<code class="docutils literal notranslate"><span class="pre">test_noise</span></code>输入到生成器中，通过固定隐码所生成的图像效果来评估生成器的好坏。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore.common</span> <span class="kn">import</span> <span class="n">dtype</span>

<span class="c1"># 利用随机种子创建一批隐码</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2323</span><span class="p">)</span>
<span class="n">test_noise</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">test_noise</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="模型构建">
<h2>模型构建<a class="headerlink" href="#模型构建" title="Permalink to this headline">¶</a></h2>
<p>本案例实现中所搭建的 GAN 模型结构与原论文中提出的 GAN 结构大致相同，但由于所用数据集 MNIST 为单通道小尺寸图片，可识别参数少，便于训练，我们在判别器和生成器中采用全连接网络架构和 <code class="docutils literal notranslate"><span class="pre">ReLU</span></code> 激活函数即可达到令人满意的效果，且省略了原论文中用于减少参数的 <code class="docutils literal notranslate"><span class="pre">Dropout</span></code> 策略和可学习激活函数 <code class="docutils literal notranslate"><span class="pre">Maxout</span></code>。</p>
<div class="section" id="生成器">
<h3>生成器<a class="headerlink" href="#生成器" title="Permalink to this headline">¶</a></h3>
<p>生成器 <code class="docutils literal notranslate"><span class="pre">Generator</span></code> 的功能是将隐码映射到数据空间。由于数据是图像，这一过程也会创建与真实图像大小相同的灰度图像(或 RGB 彩色图像)。在本案例演示中，该功能通过五层 <code class="docutils literal notranslate"><span class="pre">Dense</span></code> 全连接层来完成的，每层都与 <code class="docutils literal notranslate"><span class="pre">BatchNorm1d</span></code> 批归一化层和 <code class="docutils literal notranslate"><span class="pre">ReLU</span></code> 激活层配对，输出数据会经过 <code class="docutils literal notranslate"><span class="pre">Tanh</span></code> 函数，使其返回 [-1,1] 的数据范围内。注意实例化生成器之后需要修改参数的名称，不然静态图模式下会报错。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>

<span class="n">img_size</span> <span class="o">=</span> <span class="mi">28</span>  <span class="c1"># 训练图像长（宽）</span>

<span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_size</span><span class="p">,</span> <span class="n">auto_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Generator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="n">auto_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">()</span>
        <span class="c1"># [N, 100] -&gt; [N, 128]</span>
        <span class="c1"># 输入一个100维的0～1之间的高斯分布，然后通过第一层线性变换将其映射到256维</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">latent_size</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
        <span class="c1"># [N, 128] -&gt; [N, 256]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
        <span class="c1"># [N, 256] -&gt; [N, 512]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
        <span class="c1"># [N, 512] -&gt; [N, 1024]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
        <span class="c1"># [N, 1024] -&gt; [N, 784]</span>
        <span class="c1"># 经过线性变换将其变成784维</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">*</span> <span class="n">img_size</span><span class="p">))</span>
        <span class="c1"># 经过Tanh激活函数是希望生成的假的图片数据分布能够在-1～1之间</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>

<span class="n">net_g</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">latent_size</span><span class="p">)</span>
<span class="n">net_g</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">(</span><span class="s1">&#39;generator&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="判别器">
<h3>判别器<a class="headerlink" href="#判别器" title="Permalink to this headline">¶</a></h3>
<p>如前所述，判别器 <code class="docutils literal notranslate"><span class="pre">Discriminator</span></code> 是一个二分类网络模型，输出判定该图像为真实图的概率。主要通过一系列的 <code class="docutils literal notranslate"><span class="pre">Dense</span></code> 层和 <code class="docutils literal notranslate"><span class="pre">LeakyReLU</span></code> 层对其进行处理，最后通过 <code class="docutils literal notranslate"><span class="pre">Sigmoid</span></code> 激活函数，使其返回 [0, 1] 的数据范围内，得到最终概率。注意实例化判别器之后需要修改参数的名称，不然静态图模式下会报错。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> <span class="c1"># 判别器</span>
<span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">auto_prefix</span><span class="o">=</span><span class="n">auto_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SequentialCell</span><span class="p">()</span>
        <span class="c1"># [N, 784] -&gt; [N, 512]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">img_size</span> <span class="o">*</span> <span class="n">img_size</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>  <span class="c1"># 输入特征数为784，输出为512</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">())</span>  <span class="c1"># 默认斜率为0.2的非线性映射激活函数</span>
        <span class="c1"># [N, 512] -&gt; [N, 256]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>  <span class="c1"># 进行一个线性映射</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">())</span>
        <span class="c1"># [N, 256] -&gt; [N, 1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">())</span>  <span class="c1"># 二分类激活函数，将实数映射到[0,1]</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x_flat</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_size</span> <span class="o">*</span> <span class="n">img_size</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x_flat</span><span class="p">)</span>

<span class="n">net_d</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">()</span>
<span class="n">net_d</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">(</span><span class="s1">&#39;discriminator&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="损失函数和优化器">
<h3>损失函数和优化器<a class="headerlink" href="#损失函数和优化器" title="Permalink to this headline">¶</a></h3>
<p>定义了 <code class="docutils literal notranslate"><span class="pre">Generator</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Discriminator</span></code> 后，损失函数使用MindSpore中二进制交叉熵损失函数<code class="docutils literal notranslate"><span class="pre">BCELoss</span></code> ；这里生成器和判别器都是使用<code class="docutils literal notranslate"><span class="pre">Adam</span></code>优化器，但是需要构建两个不同名称的优化器，分别用于更新两个模型的参数，详情见下文代码。注意优化器的参数名称也需要修改。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0002</span>  <span class="c1"># 学习率</span>

<span class="c1"># 损失函数</span>
<span class="n">adversarial_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

<span class="c1"># 优化器</span>
<span class="n">optimizer_d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net_d</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
<span class="n">optimizer_g</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net_g</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
<span class="n">optimizer_g</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">(</span><span class="s1">&#39;optim_g&#39;</span><span class="p">)</span>
<span class="n">optimizer_d</span><span class="o">.</span><span class="n">update_parameters_name</span><span class="p">(</span><span class="s1">&#39;optim_d&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="模型训练">
<h2>模型训练<a class="headerlink" href="#模型训练" title="Permalink to this headline">¶</a></h2>
<p>训练分为两个主要部分。</p>
<p>第一部分是训练判别器。训练判别器的目的是最大程度地提高判别图像真伪的概率。按照原论文的方法，通过提高其随机梯度来更新判别器，最大化 <span class="math notranslate nohighlight">\(log D(x) + log(1 - D(G(z))\)</span> 的值。</p>
<p>第二部分是训练生成器。如论文所述，最小化 <span class="math notranslate nohighlight">\(log(1 - D(G(z)))\)</span> 来训练生成器，以产生更好的虚假图像。</p>
<p>在这两个部分中，分别获取训练过程中的损失，并在每轮迭代结束时进行测试，将隐码批量推送到生成器中，以直观地跟踪生成器 <code class="docutils literal notranslate"><span class="pre">Generator</span></code> 的训练效果。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">save_checkpoint</span>

<span class="n">total_epoch</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># 训练周期数</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># 用于训练的训练集批量大小</span>

<span class="c1"># 加载预训练模型的参数</span>
<span class="n">pred_trained</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">pred_trained_g</span> <span class="o">=</span> <span class="s1">&#39;./result/checkpoints/Generator99.ckpt&#39;</span>
<span class="n">pred_trained_d</span> <span class="o">=</span> <span class="s1">&#39;./result/checkpoints/Discriminator99.ckpt&#39;</span>

<span class="n">checkpoints_path</span> <span class="o">=</span> <span class="s2">&quot;./result/checkpoints&quot;</span>  <span class="c1"># 结果保存路径</span>
<span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;./result/images&quot;</span>  <span class="c1"># 测试结果保存路径</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 生成器计算损失过程</span>
<span class="k">def</span> <span class="nf">generator_forward</span><span class="p">(</span><span class="n">test_noises</span><span class="p">):</span>
    <span class="n">fake_data</span> <span class="o">=</span> <span class="n">net_g</span><span class="p">(</span><span class="n">test_noises</span><span class="p">)</span>
    <span class="n">fake_out</span> <span class="o">=</span> <span class="n">net_d</span><span class="p">(</span><span class="n">fake_data</span><span class="p">)</span>
    <span class="n">loss_g</span> <span class="o">=</span> <span class="n">adversarial_loss</span><span class="p">(</span><span class="n">fake_out</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fake_out</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss_g</span>

<span class="c1"># 判别器计算损失过程</span>
<span class="k">def</span> <span class="nf">discriminator_forward</span><span class="p">(</span><span class="n">real_data</span><span class="p">,</span> <span class="n">test_noises</span><span class="p">):</span>
    <span class="n">fake_data</span> <span class="o">=</span> <span class="n">net_g</span><span class="p">(</span><span class="n">test_noises</span><span class="p">)</span>
    <span class="n">fake_out</span> <span class="o">=</span> <span class="n">net_d</span><span class="p">(</span><span class="n">fake_data</span><span class="p">)</span>
    <span class="n">real_out</span> <span class="o">=</span> <span class="n">net_d</span><span class="p">(</span><span class="n">real_data</span><span class="p">)</span>
    <span class="n">real_loss</span> <span class="o">=</span> <span class="n">adversarial_loss</span><span class="p">(</span><span class="n">real_out</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">real_out</span><span class="p">))</span>
    <span class="n">fake_loss</span> <span class="o">=</span> <span class="n">adversarial_loss</span><span class="p">(</span><span class="n">fake_out</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fake_out</span><span class="p">))</span>
    <span class="n">loss_d</span> <span class="o">=</span> <span class="n">real_loss</span> <span class="o">+</span> <span class="n">fake_loss</span>
    <span class="k">return</span> <span class="n">loss_d</span>

<span class="c1"># 梯度方法</span>
<span class="n">grad_g</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">generator_forward</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">net_g</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())</span>
<span class="n">grad_d</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">discriminator_forward</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">net_d</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">real_data</span><span class="p">,</span> <span class="n">latent_code</span><span class="p">):</span>
    <span class="c1"># 计算判别器损失和梯度</span>
    <span class="n">loss_d</span><span class="p">,</span> <span class="n">grads_d</span> <span class="o">=</span> <span class="n">grad_d</span><span class="p">(</span><span class="n">real_data</span><span class="p">,</span> <span class="n">latent_code</span><span class="p">)</span>
    <span class="n">optimizer_d</span><span class="p">(</span><span class="n">grads_d</span><span class="p">)</span>
    <span class="n">loss_g</span><span class="p">,</span> <span class="n">grads_g</span> <span class="o">=</span> <span class="n">grad_g</span><span class="p">(</span><span class="n">latent_code</span><span class="p">)</span>
    <span class="n">optimizer_g</span><span class="p">(</span><span class="n">grads_g</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss_d</span><span class="p">,</span> <span class="n">loss_g</span>

<span class="c1"># 保存生成的test图像</span>
<span class="k">def</span> <span class="nf">save_imgs</span><span class="p">(</span><span class="n">gen_imgs1</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gen_imgs1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gen_imgs1</span><span class="p">[</span><span class="n">i3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">image_path</span> <span class="o">+</span> <span class="s2">&quot;/test_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="c1"># 设置参数保存路径</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checkpoints_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 设置中间过程生成图片保存路径</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">net_g</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>
<span class="n">net_d</span><span class="o">.</span><span class="n">set_train</span><span class="p">()</span>

<span class="c1"># 储存生成器和判别器loss</span>
<span class="n">losses_g</span><span class="p">,</span> <span class="n">losses_d</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_epoch</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mnist_ds</span><span class="p">):</span>
        <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">latent_code</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>  <span class="c1"># [0, 255] -&gt; [-1, 1]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">d_loss</span><span class="p">,</span> <span class="n">g_loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">latent_code</span><span class="p">)</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch:[</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;3d</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">total_epoch</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;3d</span><span class="si">}</span><span class="s2">], &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;step:[</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;4d</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">iter_size</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;4d</span><span class="si">}</span><span class="s2">], &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;loss_d:</span><span class="si">{</span><span class="n">d_loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;4f</span><span class="si">}</span><span class="s2"> , &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;loss_g:</span><span class="si">{</span><span class="n">g_loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;4f</span><span class="si">}</span><span class="s2"> , &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;time:</span><span class="si">{</span><span class="p">(</span><span class="n">end1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start1</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;3f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;lr:</span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">&gt;6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time of epoch </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

    <span class="n">losses_d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
    <span class="n">losses_g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>

    <span class="c1"># 每个epoch结束后，使用生成器生成一组图片</span>
    <span class="n">gen_imgs</span> <span class="o">=</span> <span class="n">net_g</span><span class="p">(</span><span class="n">test_noise</span><span class="p">)</span>
    <span class="n">save_imgs</span><span class="p">(</span><span class="n">gen_imgs</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">epoch</span><span class="p">)</span>

    <span class="c1"># 根据epoch保存模型权重文件</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">net_g</span><span class="p">,</span> <span class="n">checkpoints_path</span> <span class="o">+</span> <span class="s2">&quot;/Generator</span><span class="si">%d</span><span class="s2">.ckpt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">net_d</span><span class="p">,</span> <span class="n">checkpoints_path</span> <span class="o">+</span> <span class="s2">&quot;/Discriminator</span><span class="si">%d</span><span class="s2">.ckpt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch:[  0/200], step:[   0/ 468], loss_d:1.383930 , loss_g:0.693423 , time:0.864688s, lr:0.000200
Epoch:[  0/200], step:[  10/ 468], loss_d:1.356453 , loss_g:0.548430 , time:0.122673s, lr:0.000200
Epoch:[  0/200], step:[  20/ 468], loss_d:1.386923 , loss_g:0.628228 , time:0.120677s, lr:0.000200
Epoch:[  0/200], step:[  30/ 468], loss_d:1.385639 , loss_g:0.649491 , time:0.124667s, lr:0.000200
Epoch:[  0/200], step:[  40/ 468], loss_d:1.365866 , loss_g:0.683650 , time:0.122672s, lr:0.000200
...
Epoch:[ 99/200], step:[ 440/ 468], loss_d:1.170306 , loss_g:0.954169 , time:0.113697s, lr:0.000200
Epoch:[ 99/200], step:[ 450/ 468], loss_d:1.187954 , loss_g:0.970897 , time:0.113697s, lr:0.000200
Epoch:[ 99/200], step:[ 460/ 468], loss_d:1.277891 , loss_g:0.930688 , time:0.116688s, lr:0.000200
time of epoch 100 is 61.76s
Epoch:[100/200], step:[   0/ 468], loss_d:1.197745 , loss_g:0.951075 , time:0.134640s, lr:0.000200
Epoch:[100/200], step:[  10/ 468], loss_d:1.241353 , loss_g:0.939583 , time:0.131648s, lr:0.000200
Epoch:[100/200], step:[  20/ 468], loss_d:1.222481 , loss_g:0.900680 , time:0.129653s, lr:0.000200
...
Epoch:[199/200], step:[ 420/ 468], loss_d:1.215858 , loss_g:1.071604 , time:0.151593s, lr:0.000200
Epoch:[199/200], step:[ 430/ 468], loss_d:1.238803 , loss_g:0.920928 , time:0.135638s, lr:0.000200
Epoch:[199/200], step:[ 440/ 468], loss_d:1.212080 , loss_g:0.954983 , time:0.134640s, lr:0.000200
Epoch:[199/200], step:[ 450/ 468], loss_d:1.236587 , loss_g:0.897825 , time:0.133643s, lr:0.000200
Epoch:[199/200], step:[ 460/ 468], loss_d:1.214701 , loss_g:0.939405 , time:0.135638s, lr:0.000200
time of epoch 200 is 71.98s
</pre></div></div>
</div>
</div>
<div class="section" id="效果展示">
<h2>效果展示<a class="headerlink" href="#效果展示" title="Permalink to this headline">¶</a></h2>
<p>运行下面代码，描绘<code class="docutils literal notranslate"><span class="pre">D</span></code>和<code class="docutils literal notranslate"><span class="pre">G</span></code>损失与训练迭代的关系图：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Generator and Discriminator Loss During Training&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses_g</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses_d</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">220</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/generative_gan_20_0.png" src="../_images/generative_gan_20_0.png" />
</div>
</div>
<p>可视化训练过程中通过隐向量生成的图像。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>

<span class="c1"># 将训练过程中生成的测试图转为动态图</span>
<span class="n">image_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_epoch</span><span class="p">):</span>
    <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_path</span> <span class="o">+</span> <span class="s2">&quot;/test_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">))</span>
<span class="n">show_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">),</span> <span class="mi">5</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">show_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_list</span><span class="p">[</span><span class="n">epoch</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)])</span>

<span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">show_list</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">repeat_delay</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;train_test.gif&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p><img alt="训练过程测试动态图" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0/tutorials/application/source_zh_cn/generative/images/train_test.gif" /></p>
<p>从上面的图像可以看出，随着训练次数的增多，图像质量也越来越好。如果增大训练周期数，当 <code class="docutils literal notranslate"><span class="pre">epoch</span></code> 达到100以上时，生成的手写数字图片与数据集中的较为相似。下面我们通过加载生成器网络模型参数文件来生成图像，代码如下：</p>
</div>
<div class="section" id="模型推理">
<h2>模型推理<a class="headerlink" href="#模型推理" title="Permalink to this headline">¶</a></h2>
<p>下面我们通过加载生成器网络模型参数文件来生成图像，代码如下：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="n">test_ckpt</span> <span class="o">=</span> <span class="s1">&#39;./result/checkpoints/Generator199.ckpt&#39;</span>

<span class="n">parameter</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">test_ckpt</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net_g</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>
<span class="c1"># 模型生成结果</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">net_g</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
<span class="c1"># 结果展示</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/generative_gan_25_0.png" src="../_images/generative_gan_25_0.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="dcgan.html" class="btn btn-neutral float-right" title="DCGAN生成漫画头像" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../nlp/sequence_labeling.html" class="btn btn-neutral float-left" title="LSTM+CRF序列标注" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>