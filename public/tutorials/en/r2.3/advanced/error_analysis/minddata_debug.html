<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Processing Debugging Methods and Common Errors Analysis &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script><script src="../../_static/jquery.js"></script>
        <script src="../../_static/js/theme.js"></script><script src="../../_static/underscore.js"></script><script src="../../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Network Construction and Training Error Analysis" href="mindrt_debug.html" />
    <link rel="prev" title="Error Analysis" href="error_scenario_analysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/tensor.html">Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/dataset.html">Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/transforms.html">Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/model.html">Building a Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/autograd.html">Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/train.html">Model Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/save_load.html">Saving and Loading the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/accelerate_with_static_graph.html">Accelerating with Static Graphs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../model.html">Advanced Encapsulation: Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Model Module Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset.html">Advanced Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../derivation.html">Advanced Automatic Differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../static_graph_expert_programming.html">Advanced Programming Techniques for Static Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixed_precision.html">Automatic Mix Precision</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../error_analysis.html">Error Reporting Analysis</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="error_scenario_analysis.html">Error Analysis</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Data Processing Debugging Methods and Common Errors Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="mindrt_debug.html">Network Construction and Training Error Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="cann_error_cases.html">CANN Common Error Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="mindir.html">IR File Analysis</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../error_analysis.html">Error Reporting Analysis</a> &raquo;</li>
      <li>Data Processing Debugging Methods and Common Errors Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/advanced/error_analysis/minddata_debug.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="data-processing-debugging-methods-and-common-errors-analysis">
<h1>Data Processing Debugging Methods and Common Errors Analysis<a class="headerlink" href="#data-processing-debugging-methods-and-common-errors-analysis" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r2.3/tutorials/source_en/advanced/error_analysis/minddata_debug.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.3/resource/_static/logo_source_en.svg" /></a>  </p>
<section id="data-processing-debugging-methods">
<h2>Data Processing Debugging Methods<a class="headerlink" href="#data-processing-debugging-methods" title="Permalink to this headline"></a></h2>
<section id="method-1-errors-in-data-processing-execution,-print-logs-or-add-debug-points-to-code-debugging">
<h3>Method 1: Errors in Data Processing Execution, Print Logs or Add Debug Points to Code Debugging<a class="headerlink" href="#method-1-errors-in-data-processing-execution,-print-logs-or-add-debug-points-to-code-debugging" title="Permalink to this headline"></a></h3>
<p>When using <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> or <code class="docutils literal notranslate"><span class="pre">map</span></code> to load/process data, there may be syntax errors, calculation overflow and other issues that cause data errors, you can generally follow the steps below to troubleshoot and debug:</p>
<ol class="arabic simple">
<li><p>Observe the error stack information and locate the error code block from the error stack information.</p></li>
<li><p>Add a print or debugging point near the block of code where the error occurred, to further debugging.</p></li>
</ol>
<p>The following shows a data pipeline with syntax/value problems and how to fix the errors according to the above scheme.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>

<span class="k">class</span> <span class="nc">Loader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dividend</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dividend</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="n">dataloader</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">Loader</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>After running the error reported as follows, you can observe that the error message is divided into three blocks:</p>
<ul class="simple">
<li><p>Dataset Pipeline Error Message: error summary, here suggests that due to the Python code execution error caused by the error exit.</p></li>
<li><p>Python Call Stack: Call information from the Python code, showing the call stack before the Python exception was generated.</p></li>
<li><p>C++ Call Stack：C++ code call information for framework developers to debug.</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>------------------------------------------------------------------
- Python Call Stack:
------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/.../mindspore/dataset/engine/datasets_user_defined.py&quot;, line 99, in _cpp_sampler_fn
    val = dataset[i]
  File &quot;test_cv.py&quot;, line 11, in __getitem__
    return a / b
ZeroDivisionError: division by zero

------------------------------------------------------------------
- Dataset Pipeline Error Message:
------------------------------------------------------------------
[ERROR] Execute user Python code failed, check &#39;Python Call Stack&#39; above.

------------------------------------------------------------------
- C++ Call Stack: (For framework developers)
------------------------------------------------------------------
mindspore/ccsrc/minddata/dataset/engine/datasetops/source/generator_op.cc(247).
</pre></div>
</div>
<p>Dataset Pipeline Error Message suggests that there is an exception in running the user’s Python script, add continue to check the Python Call Stack.
According to the Python Stack information, the exception is thrown from the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> function and suggests related code near <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">a</span> <span class="pre">/</span> <span class="pre">b</span></code>. Therefore, add a print or debug point to the log near the code that prompts the error report.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>

<span class="k">class</span> <span class="nc">Loader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dividend</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: come into __getitem__&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dividend</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: a is&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: b is&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exception occurred&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">pdb</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="c1"># do anything you want to check variable</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="n">dataloader</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">Loader</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<span class="c1"># Make the pipeline single-threaded before you run it</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_num_parallel_workers</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data count&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>Rerun the data pipeline with the relevant debugging information to see that the exception was caught and the pdb debugger was entered.
At this point, you can print the relevant variables as needed (following pdb syntax) and debug, and find the 1/0 error that caused the divide-by-zero error.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; debug: come into __getitem__
&gt;&gt;&gt; debug: a is 1
&gt;&gt;&gt; debug: b is 2
&gt;&gt;&gt; debug: come into __getitem__
data count 0
&gt;&gt;&gt; debug: a is 1
&gt;&gt;&gt; debug: b is 0
exception occurred division by zero
--Return--
&gt; /test_cv.py(19)__getitem__()-&gt;None
-&gt; pdb.set_trace()
(Pdb)
</pre></div>
</div>
</section>
<section id="method-2-data-enhanced-map-operation-error,-testing-the-each-data-processing-operator-in-the-map-operation">
<h3>Method 2: Data-enhanced Map Operation Error, Testing the Each Data Processing Operator in the Map Operation<a class="headerlink" href="#method-2-data-enhanced-map-operation-error,-testing-the-each-data-processing-operator-in-the-map-operation" title="Permalink to this headline"></a></h3>
<p>Embedding data augmentation transformations into the <code class="docutils literal notranslate"><span class="pre">map</span></code> operation of a data pipeline can sometimes result in errors that are not easily debugged.
The following example shows an example of embedding a <code class="docutils literal notranslate"><span class="pre">RandomResize</span></code> and <code class="docutils literal notranslate"><span class="pre">Crop</span></code> enhancements into a <code class="docutils literal notranslate"><span class="pre">map</span></code> operation to crop data,
but an error is reported due to an error in the transformed shape of the input object.</p>
<section id="way-one-debugging-through-the-execution-of-individual-operators">
<h4>Way One: Debugging Through the Execution of Individual Operators<a class="headerlink" href="#way-one-debugging-through-the-execution-of-individual-operators" title="Permalink to this headline"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">vision</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))]</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<span class="n">transforms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vision</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">vision</span><span class="o">.</span><span class="n">Crop</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">transforms_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>When executing the above example you get the following error, but based on the error message it is more difficult to get what the input object is and what the shape is.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>------------------------------------------------------------------
- Dataset Pipeline Error Message:
------------------------------------------------------------------
[ERROR] map operation: [Crop] failed. Crop: Crop height dimension: 8 exceeds image height: 3.

------------------------------------------------------------------
- C++ Call Stack: (For framework developers)
------------------------------------------------------------------
mindspore/ccsrc/minddata/dataset/kernels/image/crop_op.cc(33).
</pre></div>
</div>
<p>From the Dataset Pipeline Error Message, we can see that the error is thrown by <code class="docutils literal notranslate"><span class="pre">Crop</span></code> during the calculation. So you can rewrite the dataset pipeline a bit to print the input and output of <code class="docutils literal notranslate"><span class="pre">Crop</span></code> and add printing for debugging.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">vision</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">MyWrapper</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">transforms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vision</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">vision</span><span class="o">.</span><span class="n">Crop</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">transforms</span> <span class="ow">in</span> <span class="n">transforms_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: apply transforms: &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">transforms</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: before apply transforms, data shape&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; debug: after apply transforms, data shape&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">MyWrapper</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_num_parallel_workers</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>Running it again yields the following.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.RandomResize&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (32, 32, 3)
&gt;&gt;&gt; debug: after apply transforms, data shape (3, 16, 3)
&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.Crop&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (3, 16, 3)

RuntimeError: Exception thrown from user defined Python function in dataset.

------------------------------------------------------------------
- Dataset Pipeline Error Message:
------------------------------------------------------------------
[ERROR] Crop: Crop height dimension: 8 exceeds image height: 3.

------------------------------------------------------------------
- C++ Call Stack: (For framework developers)
------------------------------------------------------------------
mindspore/ccsrc/minddata/dataset/kernels/image/crop_op.cc(33).
</pre></div>
</div>
<p>According to the printed information you can see that <code class="docutils literal notranslate"><span class="pre">Crop</span></code> processed the first sample and reported an error. The shape of the first sample (32, 32, 3), was transformed by <code class="docutils literal notranslate"><span class="pre">RandomResize</span></code> to (3, 16, 3), but the shape transformed by <code class="docutils literal notranslate"><span class="pre">Crop</span></code> did not printed and then an error is reported. So it is the fact that the shape cannot be processed by <code class="docutils literal notranslate"><span class="pre">Crop</span></code> that causes the error. Further, according to the Dataset Pipeline Error Message, the input sample has a height of only 3, but is expected to be cropped to a region with a high dimension of 8, hence the error is reported.</p>
<p>Checking the <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.3/api_python/dataset_vision/mindspore.dataset.vision.Crop.html">API description</a> of <code class="docutils literal notranslate"><span class="pre">Crop</span></code> , <code class="docutils literal notranslate"><span class="pre">Crop</span></code> requires the input sample to be in shape &lt;H, W&gt; or &lt;H, W, C&gt;, so <code class="docutils literal notranslate"><span class="pre">Crop</span></code> treats (3, 48, 48) as &lt;H, W, C&gt;, and naturally it can’t crop out the region with H=8, W=8 when H=3, W=48, C=48.</p>
<p>To quickly fix this, We just need to change the parameter size of <code class="docutils literal notranslate"><span class="pre">RandomResize</span></code> from (3, 16) to (16, 16), and run it again to find that the use case passes.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.RandomResize&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (32, 32, 3)
&gt;&gt;&gt; debug: after apply transforms, data shape (16, 16, 3)
&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.Crop&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (16, 16, 3)
&gt;&gt;&gt; debug: after apply transforms, data shape (8, 8, 3)
data (8, 8, 3)
&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.RandomResize&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (3, 48, 48)
&gt;&gt;&gt; debug: after apply transforms, data shape (16, 16, 48)
&gt;&gt;&gt; debug: apply transforms:  &lt;class &#39;mindspore.dataset.vision.transforms.Crop&#39;&gt;
&gt;&gt;&gt; debug: before apply transforms, data shape (16, 16, 48)
&gt;&gt;&gt; debug: after apply transforms, data shape (8, 8, 48)
data (8, 8, 48)
</pre></div>
</div>
</section>
<section id="way-two-debugging-map-operation-through-data-pipline-debugging-mode">
<h4>Way Two: Debugging Map Operation Through Data Pipline Debugging Mode<a class="headerlink" href="#way-two-debugging-map-operation-through-data-pipline-debugging-mode" title="Permalink to this headline"></a></h4>
<p>We can also turn on the dataset pipline debug mode by calling the <a class="reference external" href="https://mindspore.cn/docs/en/r2.3/api_python/dataset/mindspore.dataset.config.set_debug_mode.html">set_debug_mode</a> .
When debug mode is enabled, the random seed is set to 1 if it is not already set, so that executing the dataset pipeline in debug mode can yield deterministic results.</p>
<p>The process is as follows:</p>
<ol class="arabic simple">
<li><p>Print the shape and type of the input and output data for each transform op in the <code class="docutils literal notranslate"><span class="pre">map</span></code> operator.</p></li>
<li><p>Enable the dataset pipeline debug mode and use either a predefined debug hook provided by MindData or a user-defined debug hook. It must define the class inherited from <a class="reference external" href="https://mindspore.cn/docs/en/r2.3/api_python/dataset/mindspore.dataset.debug.DebugHook.html">DebugHook</a>.</p></li>
</ol>
<p>The following is a modification of the <code class="docutils literal notranslate"><span class="pre">Way</span> <span class="pre">One</span></code> use case, using the predefined debug hooks provided by MindData.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.debug</span> <span class="k">as</span> <span class="nn">debug</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">vision</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="c1"># Enable dataset pipeline debug mode and use pre-defined debug hook provided by MindData.</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_debug_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define dataset pipeline</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>

<span class="n">transforms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vision</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">vision</span><span class="o">.</span><span class="n">Crop</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">transforms_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data count&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>Running it yields the following correlation.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Dataset debugger] Print the [INPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(32, 32, 3)].
[Dataset debugger] Print the [OUTPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(3, 16, 3)].
    ......
E           RuntimeError: Exception thrown from dataset pipeline. Refer to &#39;Dataset Pipeline Error Message&#39;.
E
E           ------------------------------------------------------------------
E           - Dataset Pipeline Error Message:
E           ------------------------------------------------------------------
E           [ERROR] map operation: [Crop] failed. Crop: Crop height dimension: 8 exceeds image height: 3.
E
E           ------------------------------------------------------------------
E           - C++ Call Stack: (For framework developers)
E           ------------------------------------------------------------------
E           mindspore/ccsrc/minddata/dataset/kernels/image/crop_op.cc(33).
</pre></div>
</div>
<p>Based on the printed information, we can clearly see that <code class="docutils literal notranslate"><span class="pre">Crop</span></code> is getting an error when processing the input shape of
(3, 16, 3). Refer to <code class="docutils literal notranslate"><span class="pre">Crop</span></code>’s <a class="reference external" href="https://www.mindspore.cn/docs/en/r2.3/api_python/dataset_vision/mindspore.dataset.vision.Crop.html">API description</a>, and we just need to change the parameter size of <code class="docutils literal notranslate"><span class="pre">RandomResize</span></code> from (3, 16) to (16, 16), and run it again to see that the use case passes.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Dataset debugger] Print the [INPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(32, 32, 3)].
[Dataset debugger] Print the [OUTPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(16, 16, 3)].
[Dataset debugger] Print the [OUTPUT] of the operation [Crop].
Column 0. The dtype is [float64]. The shape is [(8, 8, 3)].
******data count 0
[Dataset debugger] Print the [INPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(3, 48, 48)].
[Dataset debugger] Print the [OUTPUT] of the operation [RandomResize].
Column 0. The dtype is [float64]. The shape is [(16, 16, 48)].
[Dataset debugger] Print the [OUTPUT] of the operation [Crop].
Column 0. The dtype is [float64]. The shape is [(8, 8, 48)].
******data count 1
</pre></div>
</div>
<p>Alternatively, you can use a custom debug hook to manually insert, add breakpoints to the <code class="docutils literal notranslate"><span class="pre">compute</span></code> function of the <code class="docutils literal notranslate"><span class="pre">MyHook</span></code> class, and print a log to see the type and shape of the data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.debug</span> <span class="k">as</span> <span class="nn">debug</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">vision</span>

<span class="c1"># Enable dataset pipeline debug mode and use user-defined debug hook. It must define a</span>
<span class="c1"># class inherited from DebugHook.</span>
<span class="k">class</span> <span class="nc">MyHook</span><span class="p">(</span><span class="n">debug</span><span class="o">.</span><span class="n">DebugHook</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;come into my hook function, block with pdb&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pdb</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the input shape is: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">args</span>


<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="c1"># Enable dataset pipeline debug mode and use pre-defined debug hook provided by MindData.</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_debug_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_hook_list</span><span class="o">=</span><span class="p">[</span><span class="n">MyHook</span><span class="p">()])</span>

<span class="c1"># Define dataset pipeline.</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">(),</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>

<span class="c1"># Insert debug hook before `Crop` operation.</span>
<span class="n">transforms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vision</span><span class="o">.</span><span class="n">RandomResize</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">MyHook</span><span class="p">(),</span> <span class="n">vision</span><span class="o">.</span><span class="n">Crop</span><span class="p">(</span><span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">transforms_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data count&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>As above, the problem can be localized by looking at the input shape step-by-step, and next you can start your debugging:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Dataset debugger] Print the [INPUT] of the operation [RandomResize].
come into my hook function, block with pdb
the input shape is:  (3, 48, 48)

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;PDB set_trace&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt; /test_demo.py(18)compute
-&gt; return args
(Pdb)
</pre></div>
</div>
</section>
</section>
<section id="method-3-testing-data-processing-performance">
<h3>Method 3: Testing Data Processing Performance<a class="headerlink" href="#method-3-testing-data-processing-performance" title="Permalink to this headline"></a></h3>
<p>When training is initiated using MindSpore and the training log keeps printing with many entries, it is likely that there is a problem with slower data processing.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[WARNING] MD(90635,fffdf0ff91e0,python):2023-03-25-15:29:14.801.601 [mindspore/ccsrc/minddata/dataset/engine/datasetops/source/generator_op.cc:220] operator()] Bad performance attention,
it takes more than 25 seconds to generator.__next__ new row, which might cause `GetNext` timeout problem when sink_mode=True.
You can increase the parameter num_parallel_workers in GeneratorDataset / optimize the efficiency of obtaining samples in the user-defined generator function.
</pre></div>
</div>
<p>Here is a way to debug the performance of the dataset, even if the above WARNING message does not appear, as a reference
Construct a simple lenet training network with a little bit of deliberate tinkering with the code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision</span> <span class="k">as</span> <span class="nn">CV</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.common</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset.vision</span> <span class="kn">import</span> <span class="n">Inter</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">num_parallel_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">mnist</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">udf</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">(</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="o">.</span><span class="fm">__next__</span><span class="p">())</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1000</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>


    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">udf</span><span class="p">(</span><span class="n">mnist</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>

    <span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">rescale_nml</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.3081</span>
    <span class="n">shift_nml</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mf">0.1307</span> <span class="o">/</span> <span class="mf">0.3081</span>

    <span class="c1"># define map operations</span>
    <span class="n">resize_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_height</span><span class="p">,</span> <span class="n">resize_width</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">Inter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
    <span class="n">rescale_nml_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="n">rescale_nml</span> <span class="o">*</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">shift_nml</span><span class="p">)</span>
    <span class="n">hwc2chw_op</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="n">type_cast_op</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># use map operations on images</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">type_cast_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">resize_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">rescale_nml_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="n">hwc2chw_op</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="n">mnist_ds</span> <span class="o">=</span> <span class="n">mnist_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnist_ds</span>


<span class="k">class</span> <span class="nc">LeNet5</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeNet5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">num_channel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="n">num_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="n">dataset_train</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;mnist/train&quot;</span><span class="p">)</span>

<span class="n">ms</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">)</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">LeNet5</span><span class="p">(</span><span class="n">num_class</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">net_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyWithLogits</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">net_opt</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Momentum</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">net_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">net_opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">})</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dataset_train</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">LossMonitor</span><span class="p">()])</span>
</pre></div>
</div>
<p>While training, we will get very many WARNINGs suggesting that our dataset performance is slow, but observe that there are Epoch time, per step time messages, so the training is actually going on, just slower.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[WARNING] MD(90635,fffdf0ff91e0,python):2023-03-25-15:29:14.801.601 [mindspore/ccsrc/minddata/dataset/engine/datasetops/source/generator_op.cc:220] operator()] Bad performance attention, it takes more than 25 seconds to generator.__next__ new row, which might cause `GetNext` timeout problem when sink_mode=True. You can increase the parameter num_parallel_workers in GeneratorDataset / optimize the efficiency of obtaining samples in the user-defined generator function.
[WARNING] MD(90635,fffd72ffd1e0,python):2023-03-25-15:29:14.802.398 [mindspore/ccsrc/minddata/dataset/engine/datasetops/data_queue_op.cc:903] DetectPerBatchTime] Bad performance attention, it takes more than 25 seconds to fetch a batch of data from dataset pipeline, which might result `GetNext` timeout problem. You may test dataset processing performance(with creating dataset iterator) and optimize it.
Epoch time: 60059.685 ms, per step time: 30029.843 ms, avg loss: 2.301
</pre></div>
</div>
<p>At this point, it is possible to iterate through the dataset individually and see the processing time for each piece of data to determine how well the dataset is performing:
After <code class="docutils literal notranslate"><span class="pre">dataset_train</span> <span class="pre">=</span> <span class="pre">create_dataset(&quot;mnist/train&quot;)</span></code> in the above code, the following code can be added to debug the dataset</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_train</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data step&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;, time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
<p>After adding the code and running it again, you will see the processing time of the dataset:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>data step 0 , time 0.0055468082427978516
data step 1 , time 60.034635634525
data step 2 , time 480.046234134121
data step 3 , time 480.023415324343
data step 4 , time 480.051423635473
</pre></div>
</div>
<p>As you can see, from the 2nd data, each data actually has to wait for more than 60s before processing is completed, for the above “tampered with code” is actually a good solution, check the code will find that</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

</pre></div>
</div>
<p>From the 7th piece of data, every piece of data will sleep 60 seconds before output, and it is here that the data processing slows down. Because the batch size is 4, so the first batch contains only the first 4 data (0,1,2,3), natural processing time is not a problem, and then to the second batch, because it contains (4,5,6,7) 4 data, so the seventh piece of data will wait an additional 60s before output, which causes that in the second batch, the data time is extended to 60s. Same for the third and fourth batch after that. So you only need to remove the logic of sleep to bring the data processing back to the normal level.</p>
<p>In real training scenarios, there are different reasons for slow network training, but the analysis method is similar. We can iterate through the data individually to determine if the slow data processing is the cause of the low training performance.</p>
</section>
<section id="method-4-checking-for-exception-data-in-data-processing">
<h3>Method 4: Checking For Exception Data In Data Processing<a class="headerlink" href="#method-4-checking-for-exception-data-in-data-processing" title="Permalink to this headline"></a></h3>
<p>In the process of processing data, abnormal result values may be generated due to computational errors, numerical overflow, etc., which can lead to problems such as operator computation overflow and abnormal weight updates when training the network. This scheme describes how to debug and check abnormal data behavior/data results.</p>
<section id="turning-off-shuffling-and-fixing-random-seeds-to-ensure-reproductivity">
<h4>Turning Off Shuffling and Fixing Random Seeds to Ensure Reproductivity<a class="headerlink" href="#turning-off-shuffling-and-fixing-random-seeds-to-ensure-reproductivity" title="Permalink to this headline"></a></h4>
<p>In some data processing scenarios, we use randomized functions as part of data operations. Due to the nature of the random operation itself, the data results are not the same in every run, so that this will most likely result in abnormal values in the results of the previous run, but in the next run, the abnormal values are not checked, then it is likely because of the effect of the random index/random computation. In this case, it is possible to turn off the shuffling option for the dataset and fix a different random seeds to look for possible introduction of random problems through multiple runs.</p>
<p>The following example treats a random value as a divisor, which by chance will divide by zero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="k">class</span> <span class="nc">Gen</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="n">dataset</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">Gen</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Setting the random seed with <code class="docutils literal notranslate"><span class="pre">set_seed</span></code> to produce a fixed random number to achieve a deterministic result allows further troubleshooting of the code to see if the randomization is working as expected.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">Loader</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The results are consistent across multiple runs, as can be seen by the division by zero results that occur for the 1st and 3rd data. Indirectly, it can be shown that there is an anomaly in the computation of the 1st and 3rd data that leads to the value of inf.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Tensor(shape=[], dtype=Float64, value= inf)]
[Tensor(shape=[], dtype=Float64, value= 1)]
[Tensor(shape=[], dtype=Float64, value= inf)]
</pre></div>
</div>
</section>
<section id="a-quick-check-of-the-results-using-a-tool-such-as-numpy">
<h4>A Quick Check of the Results Using a Tool Such as NumPy<a class="headerlink" href="#a-quick-check-of-the-results-using-a-tool-such-as-numpy" title="Permalink to this headline"></a></h4>
<p>In the previous example, the amount of data is small enough that you can basically check the code to find out where the anomalies are. For some large high-dimensional arrays, it is less convenient to check the code or print the values. At this time, you can configure MindSpoer’s dataset to return data in the form of NumPy, and use some of NumPy’s commonly used means of checking the contents of the array to check whether there are abnormal values in the array.</p>
<p>The following example constructs a large, high-dimensional array and performs random operations on the values in it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="k">class</span> <span class="nc">Gen</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">16</span>


<span class="n">dataset</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">GeneratorDataset</span><span class="p">(</span><span class="n">Gen</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>To check for the presence of unusual values such as nan, inf, etc. during data operations, you can specify the output of the dataset object to be of type NumPy when traversing it.</p>
<p>After specifying the output type, each element of the printed data object is of NumPy type, based on which you can use some very convenient functions in NumPy to check whether the values are abnormal or not.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data_index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">(</span><span class="n">output_numpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>             <span class="c1"># Checking for inf values</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;np.isinf index: &quot;</span><span class="p">,</span> <span class="n">data_index</span><span class="p">)</span> <span class="c1"># Prints the index of the sample if there is an inf value</span>
    <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>             <span class="c1"># Checking for nan values</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;np.isinf index: &quot;</span><span class="p">,</span> <span class="n">data_index</span><span class="p">)</span> <span class="c1"># Prints an index of samples with nan values</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="analyzing-common-data-processing-problems">
<h2>Analyzing Common Data Processing Problems<a class="headerlink" href="#analyzing-common-data-processing-problems" title="Permalink to this headline"></a></h2>
<section id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline"></a></h3>
<p>Common errors you may encounter in the data preparation phase include dataset path and MindRecord file errors when you read or save data from or to a path or when you read or write a MindRecord file.</p>
<section id="the-dataset-path-contains-chinese-characters">
<h4>The Dataset Path Contains Chinese Characters<a class="headerlink" href="#the-dataset-path-contains-chinese-characters" title="Permalink to this headline"></a></h4>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Unexpected error. Failed to open file, file path E:\深度学习\models-master\official\cv\ssd\MindRecord_COCO\test.mindrecord
</pre></div>
</div>
<p>Two solutions are available:</p>
<ol class="arabic simple">
<li><p>Specify the output path of the MindRecord dataset to a path containing only English characters.</p></li>
<li><p>Upgrade MindSpore to a version later than 1.6.0.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107679243990127-1-1.html">MindRecord Data Preparation - Unexpected error. Failed to open file_MindSpore</a></p>
</section>
<section id="mindrecord-file-error">
<h4>MindRecord File Error<a class="headerlink" href="#mindrecord-file-error" title="Permalink to this headline"></a></h4>
<ul>
<li><p>The Duplicate File Is Not Deleted</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>MRMOpenError: [MRMOpenError]: MindRecord File could not open successfully.
</pre></div>
</div>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>Add the file deletion logic to the code to ensure that the MindRecord file with the same name in the directory is deleted before the file is saved.</p></li>
<li><p>In versions later than MindSpore 1.6.0, when defining the <code class="docutils literal notranslate"><span class="pre">FileWriter</span></code> object, add <code class="docutils literal notranslate"><span class="pre">overwrite=True</span></code> to implement overwriting.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107679243990127-1-1.html">MindSpore Data Preparation - MindRecord File could not open successfully</a></p>
</li>
<li><p>The File Is Moved</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Thread ID 1 Unexpected error. Fail to open ./data/cora
RuntimeError: Unexpected error. Invalid file, DB file can not match file
</pre></div>
</div>
<p>When MindSpore 1.4 or an earlier version is used, in the Windows environment, after a MindRecord dataset file is generated and moved, the file cannot be loaded to MindSpore.</p>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>Do not move the MindRecord file generated in the Windows environment.</p></li>
<li><p>Upgrade MindSpore to 1.5.0 or a later version and regenerate a MindRecord dataset. Then, the dataset can be copied and moved properly.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0229106992212728097-1-1.html">MindSpore Data Preparation - Invalid file,DB file can not match_MindSpore</a></p>
</li>
<li><p>The User-defined Data Type Is Incorrect</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Unexpected error. Invalid data, the number of schema should be positive but got: 0. Please check the input schema.
</pre></div>
</div>
<p>Solution:</p>
<p>Modify the input data type to ensure that it is consistent with the type definition in the script.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107678315400125-1-1.html">MindSpore Data Preparation - Unexpected error. Invalid data</a></p>
</li>
</ul>
</section>
</section>
<section id="data-loading">
<h3>Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this headline"></a></h3>
<p>In the data loading phase, errors may be reported in resource configuration, <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code>, and iterators.</p>
<section id="resource-configuration">
<h4>Resource Configuration<a class="headerlink" href="#resource-configuration" title="Permalink to this headline"></a></h4>
<ul>
<li><p>Incorrect Number of CPU Cores</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Thread ID 140706176251712 Unexpected error. GeneratorDataset&#39;s num_workers=8, this value is not within the required range of [1, cpu_thread_cnt=2].
</pre></div>
</div>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>Add the following code to manually configure the number of CPU cores: <code class="docutils literal notranslate"><span class="pre">ds.config.set_num_parallel_workers()</span></code></p></li>
<li><p>Upgrade to MindSpore 1.6.0, which automatically adapts to the number of CPU cores in the hardware to prevent errors caused by insufficient CPU cores.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0215121940801939033-1-1.html">MindSpore Data Loading - Unexpected error. GeneratorDataset’s num_workers=8, this value is not within the required range of</a></p>
</li>
<li><p>Incorrect PageSize Setting</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Syntax error. Invalid data, Page size: 1048576 is too small to save a blob row.
</pre></div>
</div>
<p>Solution:</p>
<p>Call the set_page_size API to set pagesize to a larger value. The setting method is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.mindrecord</span> <span class="kn">import</span> <span class="n">FileWriter</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;test.mindrecord&quot;</span><span class="p">,</span> <span class="n">shard_num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">set_page_size</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="c1"># 128MB</span>
</pre></div>
</div>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107680001698128-1-1.html">MindSpore Data Loading - Invalid data,Page size is too small”</a></p>
</li>
</ul>
</section>
<section id="generatordataset">
<h4><code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code><a class="headerlink" href="#generatordataset" title="Permalink to this headline"></a></h4>
<ul>
<li><p>Suspended <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> Thread</p>
<p>No error log is generated, and the thread is suspended.</p>
<p>During customized data processing, the <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> and <code class="docutils literal notranslate"><span class="pre">mindspore.Tensor</span></code> data type are mixed and the <code class="docutils literal notranslate"><span class="pre">numpy.array(Tensor)</span></code> type is incorrectly used for conversion. As a result, the global interpreter lock (GIL) cannot be released and the <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> cannot work properly.</p>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>When defining the first input parameter <code class="docutils literal notranslate"><span class="pre">source</span></code> of <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code>, use the <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> data type if a Python function needs to be invoked.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">Tensor.asnumpy()</span></code> method to convert <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> to <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code>.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0232106992052900089-1-1.html">MindSpore Data Loading - Suspended GeneratorDataset Thread</a></p>
</li>
<li><p>Incorrect User-defined Return Type</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Unexpected</span> <span class="n">error</span><span class="o">.</span> <span class="n">Invalid</span> <span class="n">data</span> <span class="nb">type</span><span class="o">.</span>
</pre></div>
</div>
<p>Error description:</p>
<p>A user-defined <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> or <code class="docutils literal notranslate"><span class="pre">map</span></code> operation returns data of the dict type, not a numpy array or a tuple consisting of numpy arrays. Data types (such as dict and object) other than numpy array or a tuple consisting of numpy arrays are not controllable and the data storage mode is unclear. As a result, the <code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">type</span></code> error is reported.</p>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>Check the return type of the customized data processing. The return type must be numpy array or a tuple consisting of numpy arrays.</p></li>
<li><p>Check the return type of the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> function during customized data loading. The return type must be a tuple consisting of numpy arrays.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107678315400125-1-1.html">MindSpore Dataset Loading - Unexpected error. Invalid data type_MindSpore</a></p>
</li>
<li><p>User-defined Sampler Initialization Error</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>AttributeError: &#39;IdentitySampler&#39; object has no attribute &#39;child_sampler&#39;
</pre></div>
</div>
<p>Solution:</p>
<p>In the user-defined sampler initialization method ‘__init__()’, use ‘super().__init__()’ to invoke the constructor of the parent class.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0229107679386960150-1-1.html">MindSpore Dataset Loading - ‘IdentitySampler’ has no attribute child_sampler</a></p>
</li>
<li><p>Repeated Access Definition</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">For</span> <span class="s1">&#39;Tensor&#39;</span><span class="p">,</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">of</span> <span class="s2">&quot;input_data&quot;</span> <span class="n">should</span> <span class="n">be</span> <span class="n">one</span> <span class="n">of</span> <span class="o">...</span>
</pre></div>
</div>
<p>Solution:</p>
<p>Select a proper data input method: random access (<code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>) or sequential access (iter, next).</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0229107683010760153-1-1.html">MindSpore Dataset Loading - the type of <code class="docutils literal notranslate"><span class="pre">input_data</span></code> should be one of</a></p>
</li>
<li><p>Inconsistency Between the Fields Returned by the User-defined Data and the Defined Fields</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Exception thrown from PyFunc. Invalid python function, the &#39;source&#39; of &#39;GeneratorDataset&#39; should return same number of NumPy arrays as specified in column_names
</pre></div>
</div>
<p>Solution:</p>
<p>Check whether the fields returned by <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> are the same as those defined in <code class="docutils literal notranslate"><span class="pre">columns</span></code>.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0232107680321371137-1-1.html">MindSpore Dataset Loading -Exception thrown from PyFunc</a></p>
</li>
<li><p>Incorrect User Script</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TypeError: parse() missing 1 required positionnal argument: &#39;self&#39;
</pre></div>
</div>
<p>Solution:</p>
<p>Debug the code step by step and check the syntax in the script to see whether ‘()’ is missing.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0235121940704650030-1-1.html">MindSpore Dataset Loading - parse() missing 1 required positional</a></p>
</li>
<li><p>Incorrect Use of Tensor Operations or Operators in Custom Datasets</p>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Exception thrown from PyFunc. RuntimeError: mindspore/ccsrc/pipeline/pynative/pynative_execute.cc:1116 GetOpOutput] : The pointer[cnode] is null.
</pre></div>
</div>
<p>Error description:</p>
<p>Tensor operations or operators are used in custom datasets. Because data processing is performed in multi-thread parallel mode and tensor operations or operators do not support multi-thread parallel execution, an error is reported.</p>
<p>Solution:</p>
<p>In the user-defined Pyfunc, do not use MindSpore tensor operations or operators in <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> in the dataset. You are advised to convert the input parameters to the Numpy type and then perform Numpy operations to implement related functions.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0230106992306834091-1-1.html">MindSpore Dataset Loading - The pointer[cnode] is null</a></p>
</li>
<li><p>Index Out of Range Due to Incorrect Iteration Initialization</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span> <span class="n">index</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
</pre></div>
</div>
<p>Solution:</p>
<p>Remove unnecessary <code class="docutils literal notranslate"><span class="pre">index</span></code> member variables, or set <code class="docutils literal notranslate"><span class="pre">index</span></code> to 0 before each iteration to perform the reset operation.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0232107679694236136-1-1.html">MindSpore Dataset Loading - list index out of range</a></p>
</li>
<li><p>No Iteration Initialization</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Unable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">GeneratorDataset</span><span class="p">,</span> <span class="k">try</span> <span class="n">iterate</span> <span class="n">the</span> <span class="n">source</span> <span class="n">function</span> <span class="n">of</span> <span class="n">GeneratorDataset</span> <span class="ow">or</span> <span class="n">check</span> <span class="n">value</span> <span class="n">of</span> <span class="n">num_epochs</span> <span class="n">when</span> <span class="n">create</span> <span class="n">iterator</span><span class="o">.</span>
</pre></div>
</div>
<p>The value of <code class="docutils literal notranslate"><span class="pre">len</span></code> is inconsistent with that of <code class="docutils literal notranslate"><span class="pre">iter</span></code> because iteration initialization is not performed.</p>
<p>Solution:</p>
<p>Clear the value of <code class="docutils literal notranslate"><span class="pre">iter</span></code>.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0215121940606533032-1-1.html">MindSpore Dataset Loading - Unable to fetch data from GeneratorDataset</a></p>
</li>
</ul>
</section>
<section id="iterator">
<h4>Iterator<a class="headerlink" href="#iterator" title="Permalink to this headline"></a></h4>
<ul>
<li><p>Repeated Iterator Creation</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oserror</span><span class="p">:</span> <span class="p">[</span><span class="n">errno</span> <span class="mi">24</span><span class="p">]</span> <span class="n">too</span> <span class="n">many</span> <span class="nb">open</span> <span class="n">files</span>
</pre></div>
</div>
<p>Error description:</p>
<p>If <code class="docutils literal notranslate"><span class="pre">iter()</span></code> is repeatedly called, iterators are repeatedly created. However, because <code class="docutils literal notranslate"><span class="pre">GeneratorDataset</span></code> loads datasets in multi-thread mode by default, the handles opened each time cannot be released before the main process stops. As a result, the number of opened handles keeps increasing.</p>
<p>Solution:</p>
<p>Use the dict iterator <code class="docutils literal notranslate"><span class="pre">create_dict_iterator()</span></code> and tuple iterator <code class="docutils literal notranslate"><span class="pre">create_tuple_iterator()</span></code> provided by MindSpore.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0231107678973789126-1-1.html">MindSpore Data Loading - too many open files</a></p>
</li>
<li><p>Improper Data Acquisition from the Iterator</p>
<p>Error log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;DictIterator&#39;</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;get_next&#39;</span>
</pre></div>
</div>
<p>Solution:</p>
<p>You can obtain the next piece of data from the iterator in either of the following ways:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">item</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ds_test</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">())</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">create_dict_iterator</span><span class="p">():</span>
</pre></div>
</div>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0230107679565465123-1-1.html">MindSpore Dataset Loading - ‘DictIterator’ has no attribute ‘get_next’</a></p>
</li>
</ul>
</section>
</section>
<section id="data-augmentation">
<h3>Data Augmentation<a class="headerlink" href="#data-augmentation" title="Permalink to this headline"></a></h3>
<p>In the data augmentation phase, the read data is processed. Currently, MindSpore supports common data processing operations, such as shuffle, batch, repeat, and concat. You may encounter the following errors in this phase: data type errors, interface parameter type errors, consumption node conflict, data batch errors, and memory resource errors.</p>
<section id="incorrect-data-type-for-invoking-a-third-party-library-api-in-a-user-defined-data-augmentation-operation">
<h4>Incorrect Data Type for Invoking A Third-party Library API in A User-defined Data Augmentation Operation<a class="headerlink" href="#incorrect-data-type-for-invoking-a-third-party-library-api-in-a-user-defined-data-augmentation-operation" title="Permalink to this headline"></a></h4>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TypeError: Invalid object with type&#39;&lt;class &#39;PIL.Image.Image&#39;&gt;&#39; and value&#39;&lt;PIL.Image.Image image mode=RGB size=180x180 at 0xFFFF6132EA58&gt;&#39;.
</pre></div>
</div>
<p>Solution:</p>
<p>Check the data type requirements of the third-party library API used in the user-defined function, and convert the input data type to the data type expected by the API.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0229107679078336149-1-1.html">MindSpore Data Augmentation - TypeError: Invalid with type</a></p>
</section>
<section id="incorrect-parameter-type-in-a-user-defined-data-augmentation-operation">
<h4>Incorrect Parameter Type in A User-defined Data Augmentation Operation<a class="headerlink" href="#incorrect-parameter-type-in-a-user-defined-data-augmentation-operation" title="Permalink to this headline"></a></h4>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Exception thrown from PyFunc. TypeError: args should be Numpy narray. Got &lt;class &#39;tuple&#39;&gt;.
</pre></div>
</div>
<p>Solution:</p>
<p>Change the number of input parameters of <code class="docutils literal notranslate"><span class="pre">call</span></code> (except <code class="docutils literal notranslate"><span class="pre">self</span></code>) to the number of parameters in <code class="docutils literal notranslate"><span class="pre">input_columns</span></code> and their type to numpy.ndarray. If <code class="docutils literal notranslate"><span class="pre">input_columns</span></code> is ignored, the number of all data columns is used by default.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0230107678833189122-1-1.html">MindSpore Data Augmentation - args should be Numpy narray</a></p>
</section>
<section id="consumption-node-conflict-in-the-dataset">
<h4>Consumption Node Conflict in the Dataset<a class="headerlink" href="#consumption-node-conflict-in-the-dataset" title="Permalink to this headline"></a></h4>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ValueError: The data pipeline is not a tree (i.e. one node has 2 consumers)
</pre></div>
</div>
<p>Error description:</p>
<p>A branch occurs in the dataset definition. As a result, the dataset cannot determine the direction.</p>
<p>Solution:</p>
<p>Check the dataset name. Generally, retain the same dataset name.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0230107678474985121-1-1.html">MindSpore Data Augmentation - The data pipeline is not a tree</a></p>
</section>
<section id="improper-batch-operation-due-to-inconsistent-data-shapes">
<h4>Improper Batch Operation Due to Inconsistent Data Shapes<a class="headerlink" href="#improper-batch-operation-due-to-inconsistent-data-shapes" title="Permalink to this headline"></a></h4>
<p>Error log:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RuntimeError: Unexpected error. Inconsistent batch shapes, batch operation expect same shape for each data row, but got inconsistent shape in column 0, expected shape for this column is:, got shape:
</pre></div>
</div>
<p>Solution:</p>
<ol class="arabic simple">
<li><p>Check the shapes of the data that requires the batch operation. If the shapes are inconsistent, cancel the batch operation.</p></li>
<li><p>If you need to perform the batch operation on the data with inconsistent shapes, sort out the dataset and unify the shapes of the input data by padding.</p></li>
</ol>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0254121940499220038-1-1.html">MindSpore Data Augmentation - Unexpected error. Inconsistent batch</a></p>
</section>
<section id="high-memory-usage-due-to-data-augmentation">
<h4>High Memory Usage Due to Data Augmentation<a class="headerlink" href="#high-memory-usage-due-to-data-augmentation" title="Permalink to this headline"></a></h4>
<p>Error description:</p>
<p>If the memory is insufficient when MindSpore performs data augmentation, MindSpore may automatically exit. In MindSpore 1.7 and later versions, an alarm is generated when the memory usage exceeds 80%. When performing large-scale data training, pay attention to the memory usage to prevent direct exit due to high memory usage.</p>
<p>For details, visit the following website:</p>
<p><a class="reference external" href="https://www.hiascend.com/forum/thread-0230107679768460124-1-1.html">MindSpore Data Augmentation - Automatic Exit Due to Insufficient Memory</a></p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="error_scenario_analysis.html" class="btn btn-neutral float-left" title="Error Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mindrt_debug.html" class="btn btn-neutral float-right" title="Network Construction and Training Error Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>