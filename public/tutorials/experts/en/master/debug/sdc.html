<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accuracy-Sensitive Detection &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Fault Recovery" href="fault_recover.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Distributed Parallel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../parallel/overview.html">Distributed Parallelism Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/startup_method.html">Distributed Parallel Startup Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/data_parallel.html">Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/semi_auto_parallel.html">Semi-automatic Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/auto_parallel.html">Automatic Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/manual_parallel.html">Manually Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/parameter_server_training.html">Parameter Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/model_save_load.html">Model Saving and Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/recover.html">Fault Recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/optimize_technique.html">Optimization Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/others.html">Experimental Characteristics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/distributed_case.html">Distributed High-Level Configuration Case</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Custom Operator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom.html">Custom Operators (Custom-based)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/ms_kernel.html">MindSpore Hybrid Syntax Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_adv.html">Custom Operator Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_aot.html">Advanced Usage of aot-type Custom Operators</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Performance Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/en/master/performance_profiling.html">Profiling↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/execution_opt.html">Sinking Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/graph_fusion_engine.html">Enabling Graph Kernel Fusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/mem_reuse.html">Memory Reuse</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithm Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimize/gradient_accumulation.html">Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/thor.html">Second-order Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">High-level Functional Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vmap/vmap.html">Automatic Vectorization (Vmap)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../func_programming/Jacobians_Hessians.html">Computing Jacobian and Hessian Matrices Using Functional Transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../func_programming/per_sample_gradients.html">Per-sample-gradients</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dataset/augment.html">Auto Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/cache.html">Single-Node Data Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/optimize.html">Optimizing the Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infer/inference.html">Inference Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/model_compression.html">Model Compression</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Complex Problem Debugging</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="dump.html">Using Dump in the Graph Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="aoe.html">Ascend Optimization Engine (AOE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="rdr.html">Running Data Recorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="fault_recover.html">Fault Recovery</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Accuracy-Sensitive Detection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solution">Solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-recommendations-and-detection-principles">Usage Recommendations and Detection Principles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-restrictions">Usage Restrictions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#feature-switches-and-configuration">Feature Switches and Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-cases">Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-and-dataset-preparation">Model and Dataset Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#default-detection-process-use-case">Default Detection Process Use Case</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-detection-process-use-case">Custom Detection Process Use Case</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#confirmation-of-feature-value-checkpoints">Confirmation of Feature Value Checkpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-of-asd-detection-operator">Implementation of ASD Detection Operator</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detection-results-and-handling">Detection Results and Handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abnormal-detection-results">Abnormal Detection Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fault-handling">Fault Handling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Accuracy-Sensitive Detection</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/debug/sdc.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section class="tex2jax_ignore mathjax_ignore" id="accuracy-sensitive-detection">
<h1>Accuracy-Sensitive Detection<a class="headerlink" href="#accuracy-sensitive-detection" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/tutorials/experts/source_en/debug/sdc.md"><img alt="View Source File" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source_en.svg" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline"></a></h3>
<p>During model training, processors may encounter accuracy-sensitive anomalies, resulting in computational errors without reporting. Accuracy-sensitive anomalies may seriously affect model training.</p>
</section>
<section id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Permalink to this headline"></a></h3>
<p>The MindSpore framework provides a solution for accuracy-sensitive detection of Transformer structure models.</p>
<p>For default feature value checkpoints, users can enable detection capability using the environment variable <code class="docutils literal notranslate"><span class="pre">NPU_ASD_ENABLE=1</span></code>, and adjust the detection intensity by configuring the environment variables <code class="docutils literal notranslate"><span class="pre">NPU_ASD_UPPER_THRESH</span></code> and <code class="docutils literal notranslate"><span class="pre">NPU_ASD_SIGMA_THRESH</span></code>.</p>
<p>In addition, the MindSpore framework supports users to customize feature value checkpoints according to their needs, further enhancing the detection capability for accuracy-sensitive anomalies.</p>
<p>For information on configuring related environment variables, see <strong>Feature Switches and Configuration</strong>.</p>
<p>For an introduction to default feature value checkpoints, and design guidelines for custom feature value checkpoints, see <strong>Usage Recommendations and Detection Principles</strong>.</p>
</section>
<section id="usage-recommendations-and-detection-principles">
<h3>Usage Recommendations and Detection Principles<a class="headerlink" href="#usage-recommendations-and-detection-principles" title="Permalink to this headline"></a></h3>
<p>When processors encounter accuracy-sensitive anomalies, erroneous results are calculated. Due to the structure of Transformer models, these erroneous calculation results will propagate.</p>
<p>Based on experimental results, the following empirical conclusions are drawn:</p>
<ul class="simple">
<li><p>Not all accuracy-sensitive anomalies necessarily affect model convergence and performance. In fact, most accuracy-sensitive anomalies do not have observable effects on the model. See <a class="reference external" href="https://dl.acm.org/doi/abs/10.1145/3579371.3589105">reference</a>.</p></li>
<li><p>Statistically, accuracy-sensitive anomalies during the backpropagation calculation process have a much greater impact than during the forward calculation process.</p></li>
<li><p>In parallel training scenarios, calculation error results will propagate due to parallel computation.</p></li>
<li><p>Setting too many checkpoints will affect model training performance.</p></li>
<li><p>Based on experiments on the sensitivity of calculation errors, the MindSpore framework defaults to selecting the <code class="docutils literal notranslate"><span class="pre">Norm</span></code> activation value gradient in the backpropagation calculation process as the detection feature value, with performance loss less than 2% based on <strong>Llama 2 - 7B</strong> testing.</p></li>
</ul>
<p>After enabling the detection switch, during the backpropagation phase of training Transformer structure models, abnormality is determined by collecting the activation value gradients of the Norm layer through modified specified network layers, calling the detection operator, and using an algorithm to determine if an anomaly exists. If an anomaly occurs, training is terminated, the NPU status on the device where the anomaly is detected is set to Warning, and a fault event is reported.</p>
<p>The reasons for feature value anomalies can be divided into two categories: hardware errors and software errors, which can be referred to in the <strong>Fault Handling</strong> section for further analysis.</p>
</section>
<section id="usage-restrictions">
<h3>Usage Restrictions<a class="headerlink" href="#usage-restrictions" title="Permalink to this headline"></a></h3>
<p>Currently, this feature only supports Atlas A2 training series products, detects Transformer-like models, and detects accuracy anomalies that occur during training with the bfloat16 data type.</p>
</section>
</section>
<section id="feature-switches-and-configuration">
<h2>Feature Switches and Configuration<a class="headerlink" href="#feature-switches-and-configuration" title="Permalink to this headline"></a></h2>
<p>The environment variable <code class="docutils literal notranslate"><span class="pre">NPU_ASD_ENABLE</span></code> serves as a feature switch, <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">NPU_ASD_ENABLE=1</span></code> to enable this feature; if this environment variable is not configured or <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">NPU_ASD_ENABLE=0</span></code>, this feature is disabled.</p>
<p>The environment variable <code class="docutils literal notranslate"><span class="pre">NPU_ASD_UPPER_THRESH</span></code> controls the absolute numerical threshold of detection, in the format of integer pairs, where the first element controls the first-level threshold of absolute numerical values, and the second element controls the second-level threshold of absolute numerical values; reducing the threshold can detect smaller fluctuations in abnormal data, increase the detection rate, and increasing the threshold is the opposite. In the default case where this environment variable is not configured, <code class="docutils literal notranslate"><span class="pre">NPU_ASD_UPPER_THRESH=1000000,10000</span></code>.</p>
<p>The environment variable <code class="docutils literal notranslate"><span class="pre">NPU_ASD_SIGMA_THRESH</span></code> controls the relative numerical threshold of detection, in the same format as the above, where the first element controls the first-level threshold of numerical changes, and the second element controls the second-level threshold of numerical changes; by default, <code class="docutils literal notranslate"><span class="pre">NPU_ASD_SIGMA_THRESH=100000,5000</span></code>.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline"></a></h2>
<blockquote>
<div><p>This document describes the usage methods and use cases of accuracy-sensitive detection.</p>
</div></blockquote>
<section id="model-and-dataset-preparation">
<h3>Model and Dataset Preparation<a class="headerlink" href="#model-and-dataset-preparation" title="Permalink to this headline"></a></h3>
<p>To provide a complete experience, here we implement the usage case of accuracy-sensitive detection based on the MindSpore Transformers Llama2 network.</p>
<p>For the model and dataset preparation process, see <a class="reference external" href="https://mindformers.readthedocs.io/zh-cn/latest/docs/model_cards/llama2.html">Llama 2</a>.</p>
<p>If already prepared, you can skip this section directly.</p>
</section>
<section id="default-detection-process-use-case">
<h3>Default Detection Process Use Case<a class="headerlink" href="#default-detection-process-use-case" title="Permalink to this headline"></a></h3>
<p>Under the <code class="docutils literal notranslate"><span class="pre">mindspore.ops.silent_check</span></code> module, <code class="docutils literal notranslate"><span class="pre">LayerNormASD</span></code> has been implemented as an operator integrated with ASD detection capabilities.</p>
<p>If the feature switch is enabled, in <code class="docutils literal notranslate"><span class="pre">mindspore.ops.__init__</span></code>, the above operator will automatically replace <code class="docutils literal notranslate"><span class="pre">mindspore.ops.LayerNorm</span></code>, providing default detection capabilities.</p>
</section>
<section id="custom-detection-process-use-case">
<h3>Custom Detection Process Use Case<a class="headerlink" href="#custom-detection-process-use-case" title="Permalink to this headline"></a></h3>
<p>If custom feature value detection is required beyond the default detection scenario, in addition to enabling the feature switch <code class="docutils literal notranslate"><span class="pre">NPU_ASD_ENABLE</span></code>, you also need to implement custom operators that integrate ASD detection capabilities based on <code class="docutils literal notranslate"><span class="pre">ASDBase</span> <span class="pre">Jit</span> <span class="pre">Class</span></code>.</p>
<p>Here we use MindSpore Transformers Llama2 as an example to implement accuracy-sensitive detection of feature values in the Embedding layer.</p>
<section id="confirmation-of-feature-value-checkpoints">
<h4>Confirmation of Feature Value Checkpoints<a class="headerlink" href="#confirmation-of-feature-value-checkpoints" title="Permalink to this headline"></a></h4>
<p>Check the implementation of <code class="docutils literal notranslate"><span class="pre">llama.llama_layer.LlamaEmbedding</span></code>, where we choose to collect the gradient of the <code class="docutils literal notranslate"><span class="pre">Gather</span></code> operator during backpropagation as the detection feature value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LlamaEmbedding</span><span class="p">(</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward of vocab embedding.&quot;&quot;&quot;</span>
        <span class="n">_check_input_dtype</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">input_ids</span><span class="p">),</span> <span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_name</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_weight</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</section>
<section id="implementation-of-asd-detection-operator">
<h4>Implementation of ASD Detection Operator<a class="headerlink" href="#implementation-of-asd-detection-operator" title="Permalink to this headline"></a></h4>
<p>For this use case, it is necessary to implement a custom Gather operator that integrates ASD detection capabilities.</p>
<p>Under <code class="docutils literal notranslate"><span class="pre">llama.llama_layer</span></code>, implement the corresponding operator for the collection point and refer to the following use case and API method comments of <code class="docutils literal notranslate"><span class="pre">ops.silent_check.ASDBase</span></code> for implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GatherASD</span><span class="p">(</span><span class="n">ASDBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">Gather</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_params</span><span class="p">,</span> <span class="n">input_indices</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_check</span><span class="p">:</span>
            <span class="n">input_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_op</span><span class="p">(</span>
                <span class="n">input_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnt</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">input_params</span><span class="p">,</span> <span class="n">input_indices</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<p>And replace the default Gather operator in the Embedding layer with the custom GatherASD operator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LlamaEmbedding</span><span class="p">(</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_table_size</span><span class="p">,</span> <span class="n">embedding_size</span><span class="p">,</span> <span class="n">param_init_type</span><span class="o">=</span><span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">param_init</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                 <span class="n">parallel_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_table_size</span> <span class="o">=</span> <span class="n">vocab_table_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span> <span class="o">=</span> <span class="n">embedding_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">initializer</span><span class="p">(</span><span class="n">param_init</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_table_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">param_init_type</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;embedding_weight&#39;</span><span class="p">,</span> <span class="n">parallel_optimizer</span><span class="o">=</span><span class="n">parallel_optimizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gather</span> <span class="o">=</span> <span class="n">GatherASD</span><span class="p">()</span><span class="c1"># Gather()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="detection-results-and-handling">
<h2>Detection Results and Handling<a class="headerlink" href="#detection-results-and-handling" title="Permalink to this headline"></a></h2>
<section id="abnormal-detection-results">
<h3>Abnormal Detection Results<a class="headerlink" href="#abnormal-detection-results" title="Permalink to this headline"></a></h3>
<p>When no numerical anomalies are detected, the training task runs without impact.</p>
<p>When numerical anomalies are detected, the training task fails and alerts are reported. To locate the faulty device, do one of the following:</p>
<ul class="simple">
<li><p>Search application logs for <strong>ERROR</strong> level error logs with the keyword “accuracy sensitivity feature abnormal”;</p></li>
<li><p>Monitor the NPU health status: if Health Status displays Warning, Error Code displays 80818C00, and Error Information displays node type=SoC, sensor type=Check Sensor, event state=check fail;</p></li>
<li><p>Check the <a class="reference external" href="https://github.com/Ascend/ascend-device-plugin">Ascend Device Plugin</a> events, report error code 80818C00, event type is fault event, and the fault level is minor.</p></li>
</ul>
</section>
<section id="fault-handling">
<h3>Fault Handling<a class="headerlink" href="#fault-handling" title="Permalink to this headline"></a></h3>
<p>Isolate the abnormal device, resume training with checkpoint recovery; meanwhile, on the abnormal device, use the Ascend-DMI tool to perform AICore ERROR stress diagnostics to detect whether there are faulty NPUs on the device. For details, see <a class="reference external" href="https://www.hiascend.com/document/detail/zh/mindx-dl/2046/dluserguide/toolboxug/toolboxug_000002.html">ToolBox User Guide</a> in the “ascend-dmi tool usage &gt; fault diagnosis” section.</p>
<p>If a faulty card is detected on the abnormal device, contact Huawei engineers for maintenance and replacement; if all NPUs on the abnormal device are normal, it is a software-related issue triggering feature value overflow, and it is recommended to check the processes and operators’es causes.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fault_recover.html" class="btn btn-neutral float-left" title="Fault Recovery" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>