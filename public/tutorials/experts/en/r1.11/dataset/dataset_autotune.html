<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dataset AutoTune for Dataset Pipeline &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="augment.html">Auto Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cache.html">Single-Node Data Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize.html">Optimizing the Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Graph Compilation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/control_flow.html">Process Control Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/op_overload.html">Compiling Performance Optimization for Static Graph Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/jit_class.html">Calling the Custom Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/constexpr.html">Construct Constants In the Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dependency_control.html">Dependency Control</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Training Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimize/execution_opt.html">Sinking Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/gradient_accumulation.html">Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/adaptive_summation.html">Adaptive Gradient Summation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/dimention_reduce_training.html">Dimension Reduction Training Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/thor.html">Second-order Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Custom Operator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom.html">Custom Operators (Custom-based)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/ms_kernel.html">MindSpore Hybrid Syntax Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_adv.html">Advanced Usage of Custom Operators</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Automatic Vectorization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vmap/vmap.html">Automatic Vectorization (Vmap)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infer/inference.html">Inference Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/ascend_310_air.html">Inference on the Ascend 310 AI Processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/model_compression.html">Model Compression</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debugging and Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../debug/function_debug.html">Function Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug/performance_optimization.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference external" href="https://mindspore.cn/mindinsight/docs/en/r1.11/accuracy_problem_preliminary_location.html">Precision Optimization↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Distributed Parallel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../parallel/introduction.html">Distributed Parallel Training Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/parallel_training_quickstart.html">Quick Start Distributed Parallel Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/communicate_ops.html">Distributed Set Communication Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/distributed_case.html">Distributed Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/distributed_inference.html">Distributed Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/save_load.html">Saving and Loading Models in Hybrid Parallel Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/fault_recover.html">Distributed Fault Recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/multi_dimensional.html">Multi Dimensional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/resilience_train_and_predict.html">Distributed Resilience Training and Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel/other_features.html">Other Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../env/env_var_list.html">Environment Variables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Dataset AutoTune for Dataset Pipeline</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/dataset/dataset_autotune.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="dataset-autotune-for-dataset-pipeline">
<h1>Dataset AutoTune for Dataset Pipeline<a class="headerlink" href="#dataset-autotune-for-dataset-pipeline" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.11/tutorials/experts/source_en/dataset/dataset_autotune.md"><img alt="View Source On Gitee" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.11/resource/_static/logo_source_en.png" /></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>MindSpore provides a tool named Dataset AutoTune to help optimize the dataset pipeline.
Dataset AutoTune can automatically tune dataset pipelines to improve performance.</p>
<p>This feature can automatically detect a bottleneck operation in the dataset pipeline and respond by automatically adjusting tunable parameters for dataset operations, like increasing the number of parallel workers or updating the prefetch size of dataset operations.</p>
<p><img alt="autotune" src="../_images/autotune.png" /></p>
<p>With Dataset AutoTune enabled, MindSpore will sample dataset statistics at a given interval, which is tuneable by the user.</p>
<p>Once Dataset AutoTune collects enough information, it will analyze whether the performance bottleneck is on the dataset side or not.
If so, it will adjust the parallelism and speedup the dataset pipeline.
If not, Dataset AutoTune will also try to reduce the memory usage of the dataset pipeline to release memory for CPU.</p>
<blockquote>
<div><p>Dataset AutoTune is disabled by default.</p>
</div></blockquote>
</section>
<section id="enabling-dataset-autotune">
<h2>Enabling Dataset AutoTune<a class="headerlink" href="#enabling-dataset-autotune" title="Permalink to this headline"></a></h2>
<p>To enable Dataset AutoTune and not save the more efficient dataset pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_enable_autotune</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To enable Dataset AutoTune plus save the more efficient dataset pipeline in a configuration file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_enable_autotune</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;/path/to/autotune_out&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tuning-interval-for-dataset-autotune">
<h2>Tuning Interval for Dataset AutoTune<a class="headerlink" href="#tuning-interval-for-dataset-autotune" title="Permalink to this headline"></a></h2>
<p>The frequency at which Dataset AutoTune will adjust the dataset pipeline can be customized.
To set the tuning interval in steps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_autotune_interval</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>To set the tuning interval to be after every epoch, set the tuning interval to 0.</p>
</div></blockquote>
<p>To query the tuning interval for dataset pipeline autotuning:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tuning interval:&quot;</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_autotune_interval</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="constraints">
<h2>Constraints<a class="headerlink" href="#constraints" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Both Dataset Profiling and Dataset AutoTune cannot be enabled concurrently, since Profiling’s additional processing interferes with Dataset AutoTune’s optimization processing. If both of them are enabled at the same time, a warning message will prompt the user to check whether there is a mistake. Do ensure Profiling is disabled when using Dataset AutoTune.</p></li>
<li><p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/en/r1.11/dataset/dataset_offload.html">Offload for Dataset</a> and Dataset AutoTune can be enabled simultaneously. If any dataset node has been offloaded for hardware acceleration, the more efficient dataset pipeline configuration file will not be stored and a warning will be logged, because the dataset pipeline that is actually running is not the predefined one.</p></li>
<li><p>If the Dataset pipeline consists of a node that does not support deserialization (e.g. user-defined Python functions, GeneratorDataset), any attempt to deserialize the saved and improved dataset pipeline configuration file will report an error. In this case, it is recommended to manually modify the dataset pipeline script based on the contents of the tuning configuration file to achieve the purpose of a more efficient dataset pipeline.</p></li>
<li><p>In the distributed training scenario, <code class="docutils literal notranslate"><span class="pre">set_enable_autotune()</span></code> must be called after cluster communication has been initialized (mindspore.communication.management.init()), otherwise AutoTune can only detect device with id 0 and create only one tuned file (the number of expected tuned files equal to the number of devices). See the following example:</p>
<p>Code in distributed training scenario must be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.communication.management</span> <span class="kn">import</span> <span class="n">init</span>
<span class="n">init</span><span class="p">()</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">():</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_enable_autotune</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;/path/to/autotune_out&quot;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>
</div>
<p>instead of</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.communication.management</span> <span class="kn">import</span> <span class="n">init</span>

<span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_enable_autotune</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;/path/to/autotune_out&quot;</span><span class="p">)</span>
<span class="n">init</span><span class="p">()</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">():</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h2>
<p>Take ResNet training as example.</p>
<section id="dataset-autotune-config">
<h3>Dataset AutoTune Config<a class="headerlink" href="#dataset-autotune-config" title="Permalink to this headline"></a></h3>
<p>To enable Dataset AutoTune, only one statement is needed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset.py of ResNet in ModelZoo</span>
<span class="c1"># models/official/cv/resnet/src/dataset.py</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create dataset for train or test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># enable Dataset AutoTune</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_enable_autotune</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;/path/to/autotune_out&quot;</span><span class="p">)</span>

    <span class="c1"># define dataset</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Cifar10Dataset</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="starting-training">
<h3>Starting Training<a class="headerlink" href="#starting-training" title="Permalink to this headline"></a></h3>
<p>Start the training process as described in <a class="reference external" href="https://gitee.com/mindspore/models/blob/r1.11/official/cv/ResNet/README.md#">resnet/README.md</a>. Dataset AutoTune will display its analysis result through log messages.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INFO] [auto_tune.cc:73 LaunchThread] Launching Dataset AutoTune thread
[INFO] [auto_tune.cc:35 Main] Dataset AutoTune thread has started.
[INFO] [auto_tune.cc:191 RunIteration] Run Dataset AutoTune at epoch #1
[INFO] [auto_tune.cc:203 RecordPipelineTime] Epoch #1, Average Pipeline time is 21.6624 ms. The avg pipeline time for all epochs is 21.6624ms
[INFO] [auto_tune.cc:231 IsDSaBottleneck] Epoch #1, Device Connector Size: 0.0224, Connector Capacity: 1, Utilization: 2.24%, Empty Freq: 97.76%
epoch: 1 step: 1875, loss is 1.1544309
epoch time: 72110.166 ms, per step time: 38.459 ms

[WARNING] [auto_tune.cc:236 IsDSaBottleneck] Utilization: 2.24% &lt; 75% threshold, dataset pipeline performance needs tuning.
[WARNING] [auto_tune.cc:297 Analyse] Op (MapOp(ID:3)) is slow, input connector utilization=0.975806, output connector utilization=0.298387, diff= 0.677419 &gt; 0.35 threshold.
[WARNING] [auto_tune.cc:253 RequestNumWorkerChange] Added request to change &quot;num_parallel_workers&quot; of Operator: MapOp(ID:3)From old value: [2] to new value: [4].
[WARNING] [auto_tune.cc:309 Analyse] Op (BatchOp(ID:2)) getting low average worker cpu utilization 1.64516% &lt; 35% threshold.
[WARNING] [auto_tune.cc:263 RequestConnectorCapacityChange] Added request to change &quot;prefetch_size&quot; of Operator: BatchOp(ID:2)From old value: [1] to new value: [5].
epoch: 2 step: 1875, loss is 0.64530635
epoch time: 24519.360 ms, per step time: 13.077 ms

[WARNING] [auto_tune.cc:236 IsDSaBottleneck] Utilization: 0.0213516% &lt; 75% threshold, dataset pipeline performance needs tuning.
[WARNING] [auto_tune.cc:297 Analyse] Op (MapOp(ID:3)) is slow, input connector utilization=1, output connector utilization=0, diff= 1 &gt; 0.35 threshold.
[WARNING] [auto_tune.cc:253 RequestNumWorkerChange] Added request to change &quot;num_parallel_workers&quot; of Operator: MapOp(ID:3)From old value: [4] to new value: [6].
[WARNING] [auto_tune.cc:309 Analyse] Op (BatchOp(ID:2)) getting low average worker cpu utilization 4.39062% &lt; 35% threshold.
[WARNING] [auto_tune.cc:263 RequestConnectorCapacityChange] Added request to change &quot;prefetch_size&quot; of Operator: BatchOp(ID:2)From old value: [5] to new value: [9].
epoch: 3 step: 1875, loss is 0.9806979
epoch time: 17116.234 ms, per step time: 9.129 ms

...

[INFO] [profiling.cc:703 Stop] MD Autotune is stopped.
[INFO] [auto_tune.cc:52 Main] Dataset AutoTune thread is finished.
[INFO] [auto_tune.cc:53 Main] Printing final tree configuration
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] CifarOp(ID:5) num_parallel_workers: 2 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] MapOp(ID:4) num_parallel_workers: 1 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] MapOp(ID:3) num_parallel_workers: 10 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] BatchOp(ID:2) num_parallel_workers: 8 prefetch_size: 17
[INFO] [auto_tune.cc:55 Main] Suggest to set proper num_parallel_workers for each Operation or use global setting API: mindspore.dataset.config.set_num_parallel_workers
[INFO] [auto_tune.cc:57 Main] Suggest to choose maximum prefetch_size from tuned result and set by global setting API: mindspore.dataset.config.set_prefetch_size
</pre></div>
</div>
<p>Some analysis to explain the meaning of the log information:</p>
<ul>
<li><p><strong>How to check process of Dataset AutoTune:</strong></p>
<p>Dataset AutoTune displays common status log information at INFO level. However, when AutoTune detects a bottleneck in the dataset pipeline, it will try to modify the parameters of dataset pipeline ops, and display this analysis log information at WARNING level.</p>
</li>
<li><p><strong>How to read log messages:</strong></p>
<p>The initial configuration of the dataset pipeline is suboptimal (Utilization of Device Connector is low).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INFO] [auto_tune.cc:231 IsDSaBottleneck] Epoch #1, Device Connector Size: 0.0224, Connector Capacity: 1, Utilization: 2.24%, Empty Freq: 97.76%
[WARNING] [auto_tune.cc:236 IsDSaBottleneck] Utilization: 2.24% &lt; 75% threshold, dataset pipeline performance needs tuning.
</pre></div>
</div>
<p>Then, Dataset AutoTune increases the number of parallel workers from 2 to 4 for MapOp(ID:3) and increases the prefetch size from 1 to 5 for BatchOp(ID:2).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[WARNING] [auto_tune.cc:297 Analyse] Op (MapOp(ID:3)) is slow, input connector utilization=0.975806, output connector utilization=0.298387, diff= 0.677419 &gt; 0.35 threshold.
[WARNING] [auto_tune.cc:253 RequestNumWorkerChange] Added request to change &quot;num_parallel_workers&quot; of Operator: MapOp(ID:3)From old value: [2] to new value: [4].
[WARNING] [auto_tune.cc:309 Analyse] Op (BatchOp(ID:2)) getting low average worker cpu utilization 1.64516% &lt; 35% threshold.
[WARNING] [auto_tune.cc:263 RequestConnectorCapacityChange] Added request to change &quot;prefetch_size&quot; of Operator: BatchOp(ID:2)From old value: [1] to new value: [5].
</pre></div>
</div>
<p>After tuning the configuration of the dataset pipeline, the step time is reduced.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>epoch: 1 step: 1875, loss is 1.1544309
epoch time: 72110.166 ms, per step time: 38.459 ms
epoch: 2 step: 1875, loss is 0.64530635
epoch time: 24519.360 ms, per step time: 13.077 ms
epoch: 3 step: 1875, loss is 0.9806979
epoch time: 17116.234 ms, per step time: 9.129 ms
</pre></div>
</div>
<p>At the end of training, an improved configuration is created by Dataset AutoTune.
For num_parallel_workers, Dataset AutoTune suggests to set new value for each Operation or using global setting API.
For prefetch_size, Dataset AutoTune suggests to choose the maximum value and set by global setting API.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INFO] [auto_tune.cc:66 PrintTreeConfiguration] CifarOp(ID:5) num_parallel_workers: 2 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] MapOp(ID:4) num_parallel_workers: 1 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] MapOp(ID:3) num_parallel_workers: 10 prefetch_size: 2
[INFO] [auto_tune.cc:66 PrintTreeConfiguration] BatchOp(ID:2) num_parallel_workers: 8 prefetch_size: 17
[INFO] [auto_tune.cc:55 Main] Suggest to set proper num_parallel_workers for each Operation or use global setting API: mindspore.dataset.config.set_num_parallel_workers
[INFO] [auto_tune.cc:57 Main] Suggest to choose maximum prefetch_size from tuned result and set by global setting API: mindspore.dataset.config.set_prefetch_size
</pre></div>
</div>
</li>
</ul>
</section>
<section id="saving-autotune-recommended-configuration">
<h3>Saving AutoTune Recommended Configuration<a class="headerlink" href="#saving-autotune-recommended-configuration" title="Permalink to this headline"></a></h3>
<p>Since Dataset AutoTune was enabled to generate a more efficient dataset pipeline, the improved dataset pipeline can be serialized (by passing in the ‘filepath_prefix’ parameter) and saved to the JSON configuration file.</p>
<p>After passing string to <code class="docutils literal notranslate"><span class="pre">filepath_prefix</span></code>, AutoTune will automatically generate JSON files corresponding to the device number according to the current training mode in a standalone or distributed environment.</p>
<p>For example, let <code class="docutils literal notranslate"><span class="pre">filepath_prefix='autotune_out'</span></code>.</p>
<ul class="simple">
<li><p>In distributed training on 4 devices, AutoTune will generate 4 tuning files: autotune_out_0.json, autotune_out_1.json, autotune_out_2.json, autotune_out_3.json, corresponding to the configuration of the dataset pipeline of the 4 devices.</p></li>
<li><p>In a standalone training on 1 device, AutoTune will generate autotune_out_0.json, which corresponds to the configuration of the dataset pipeline on this device.</p></li>
</ul>
<p>Example of the JSON configuration file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{
    &quot;remark&quot;: &quot;The following file has been auto-generated by the Dataset AutoTune.&quot;,
    &quot;summary&quot;: [
        &quot;CifarOp(ID:5)       (num_parallel_workers: 2, prefetch_size: 2)&quot;,
        &quot;MapOp(ID:4)         (num_parallel_workers: 1, prefetch_size: 2)&quot;,
        &quot;MapOp(ID:3)         (num_parallel_workers: 10, prefetch_size: 2)&quot;,
        &quot;BatchOp(ID:2)       (num_parallel_workers: 8, prefetch_size: 17)&quot;
    ],
    &quot;tree&quot;: {...}
}
</pre></div>
</div>
<p>The file starts with a summary of the configuration and is followed by the actual dataset pipeline (<code class="docutils literal notranslate"><span class="pre">tree</span></code>) information. The file is loadable using the deserialization API <code class="docutils literal notranslate"><span class="pre">mindspore.dataset.deserialize</span></code>.</p>
<p>Notes on the JSON configuration file:</p>
<ul class="simple">
<li><p>Non-parallel dataset operations will show <code class="docutils literal notranslate"><span class="pre">NA</span></code> for <code class="docutils literal notranslate"><span class="pre">num_parallel_workers</span></code>.</p></li>
</ul>
</section>
<section id="loading-autotune-configuration">
<h3>Loading AutoTune Configuration<a class="headerlink" href="#loading-autotune-configuration" title="Permalink to this headline"></a></h3>
<p>If Dataset AutoTune generated an improved pipeline configuration file, use deserialize support to load the dataset pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="n">new_dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="s2">&quot;/path/to/autotune_out_0.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">new_dataset</span></code> is the tuned dataset object containing operations from Cifar to Batch as shown in the JSON content above.</p>
</section>
<section id="before-next-training">
<h3>Before Next Training<a class="headerlink" href="#before-next-training" title="Permalink to this headline"></a></h3>
<p>Before starting the next training process, the user can update the dataset loading code according to recommended improvements from Dataset AutoTune for a more efficient dataset pipeline.</p>
<p>This allows the dataset pipeline to be run at an improved speed from the beginning of the training process.</p>
<p>By the way, MindSpore also provides APIs to set the global value of num_parallel_workers and prefetch_size.</p>
<p>Please refer to <a class="reference external" href="https://mindspore.cn/docs/en/r1.11/api_python/mindspore.dataset.html#config">mindspore.dataset.config</a>:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://mindspore.cn/docs/en/r1.11/api_python/dataset/mindspore.dataset.config.set_num_parallel_workers.html#mindspore.dataset.config.set_num_parallel_workers">mindspore.dataset.config.set_num_parallel_workers</a></p></li>
<li><p><a class="reference external" href="https://mindspore.cn/docs/en/r1.11/api_python/dataset/mindspore.dataset.config.set_prefetch_size.html#mindspore.dataset.config.set_prefetch_size">mindspore.dataset.config.set_prefetch_size</a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>