<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saving and Loading Models in Hybrid Parallel Mode &mdash; MindSpore master documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Distributed Fault Recovery" href="fault_recover.html" />
    <link rel="prev" title="Distributed Inference" href="distributed_inference.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Data Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dataset/augment.html">Auto Augmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/cache.html">Single-Node Data Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/optimize.html">Optimizing the Data Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Graph Compilation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/control_flow.html">Process Control Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/op_overload.html">Compiling Performance Optimization for Static Graph Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/jit_class.html">Calling the Custom Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/constexpr.html">Construct Constants In the Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dependency_control.html">Dependency Control</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Training Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimize/execution_opt.html">Sinking Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/gradient_accumulation.html">Gradient Accumulation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/adaptive_summation.html">Adaptive Gradient Summation Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/dimention_reduce_training.html">Dimension Reduction Training Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/thor.html">Second-order Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Custom Operator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom.html">Custom Operators (Custom-based)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/ms_kernel.html">MindSpore Hybrid Syntax Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_adv.html">Advanced Usage of Custom Operators</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Automatic Vectorization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vmap/vmap.html">Automatic Vectorization (Vmap)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infer/inference.html">Inference Model Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/gpu_mindir.html">Inference on a GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/ascend_910_mindir.html">Inference on the Ascend 910 AI processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/ascend_310_mindir.html">Inference Using the MindIR Model on Ascend 310 AI Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/ascend_310_air.html">Inference on the Ascend 310 AI Processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/model_compression.html">Model Compression</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debugging and Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../debug/function_debug.html">Function Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug/performance_optimization.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference external" href="https://mindspore.cn/mindinsight/docs/en/r2.0.0-alpha/accuracy_problem_preliminary_location.html">Precision Optimization↗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Distributed Parallel</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Distributed Parallel Training Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel_training_quickstart.html">Quick Start Distributed Parallel Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="communicate_ops.html">Distributed Set Communication Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_case.html">Distributed Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_inference.html">Distributed Inference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Saving and Loading Models in Hybrid Parallel Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="fault_recover.html">Distributed Fault Recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_dimensional.html">Multi Dimensional</a></li>
<li class="toctree-l1"><a class="reference internal" href="resilience_train_and_predict.html">Distributed Resilience Training and Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_features.html">Other Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../env/env_var_list.html">Environment Variables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Saving and Loading Models in Hybrid Parallel Mode</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/parallel/save_load.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="saving-and-loading-models-in-hybrid-parallel-mode">
<h1>Saving and Loading Models in Hybrid Parallel Mode<a class="headerlink" href="#saving-and-loading-models-in-hybrid-parallel-mode" title="Permalink to this headline"></a></h1>
<p><a href="https://gitee.com/mindspore/docs/blob/r2.0.0-alpha/tutorials/experts/source_en/parallel/save_load.md" target="_blank"><img src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r2.0.0-alpha/resource/_static/logo_source_en.png"></a></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline"></a></h3>
<p>In the MindSpore model parallel scenario, each instance process stores only the parameter data on the current node. The parameter data of a model parallel Cell on each node is a slice of the complete parameter data. For example, the complete parameter data shape is [8, 8], and the parameter data on each node is a part of the data, for example, shape [2, 8].</p>
<p>In the auto parallel scenario, MindSpore automatically generates the slice strategy. The MindSpore checkpoint module supports automatic integrating, saving, and loading.</p>
<p>In the hybrid parallel scenario, the slice strategy is implemented by users. MindSpore saves the slice strategy of model, which is the same on each node, and the data corresponding to each node is stored respectively. Users need to integrate, save, and load the checkpoint files by themselves. This tutorial describes how to integrate, save, and load checkpoint files in the hybrid parallel scenario.</p>
</section>
<section id="application-scenario">
<h3>Application Scenario<a class="headerlink" href="#application-scenario" title="Permalink to this headline"></a></h3>
<p>If you encounter the following scenarios, refer to this tutorial to integrate, save, and load checkpoint files:</p>
<p>Scenario 1: multi-device training and single-device inference</p>
<p>The following describes the overall process of training on 64 devices and inference on a single device:</p>
<ol class="arabic">
<li><p>Execute the training to automatically generate the checkpoint files and the slice strategy files.</p></li>
<li><p>Integrate the saved checkpoint files.</p>
<p>Integrate the divided model parameters based on the specific slice strategy to generate a new checkpoint file.</p>
</li>
<li><p>Load the new checkpoint file in the single-GPU environment and call the export API to export the model for inference as required.</p></li>
</ol>
<p>If the number of GPUs in a cluster in the checkpoint saving environment is the same as that in the loading environment, for example, if the checkpoint files are saved and loaded in the same training environment or training and inference is performed on a single device, you do not need to perform integration, saving and loading.</p>
<p>Scenario 2: The training is divided into multiple stages, and the cluster size in each stage is different.</p>
<p>For example, in the training stage 1, the training environment with 64 devices is used, and in the training stage 2, the training environment with 56 devices is used. The overall operation process is as follows:</p>
<ol class="arabic">
<li><p>Execute the training in stage 1 to automatically generate the checkpoint files and the slice strategy files.</p></li>
<li><p>Integrate the saved checkpoint files.</p>
<p>Integrate the divided model parameters based on the specific slice strategy to generate a new checkpoint file.</p>
</li>
<li><p>Load the checkpoint file that is integrated and saved in the stage 2 cluster.</p>
<p>During the loading, you need to redivide the parameter data in the checkpoint file based on the new training environment configuration.</p>
</li>
<li><p>Perform stage 2 training.</p></li>
</ol>
</section>
</section>
<section id="integrating-the-saved-checkpoint-files">
<h2>Integrating the Saved Checkpoint Files<a class="headerlink" href="#integrating-the-saved-checkpoint-files" title="Permalink to this headline"></a></h2>
<section id="overall-process">
<h3>Overall Process<a class="headerlink" href="#overall-process" title="Permalink to this headline"></a></h3>
<p>Import the checkpoint files to be integrated to the network in rank id order and obtain the list of all parameters through the API provided by MindSpore, and then obtain the slice strategy of model. See steps 1 and 2 in the following figure.</p>
<p>Then, update the parameter list and integrate the model parallel parameters. See step 3 in the following figure.</p>
<p>Finally, save the updated parameter list to a file through the API provided by MindSpore to generate a new checkpoint file. See step 4 in the following figure.</p>
<p><img alt="img" src="../_images/checkpoint_integration_process.jpg" /></p>
</section>
<section id="preparations">
<h3>Preparations<a class="headerlink" href="#preparations" title="Permalink to this headline"></a></h3>
<section id="importing-the-checkpoint-files-in-rank-id-order">
<h4>Importing the Checkpoint Files in rank id order<a class="headerlink" href="#importing-the-checkpoint-files-in-rank-id-order" title="Permalink to this headline"></a></h4>
<p>Define the network, call the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> and <code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code> APIs to import the checkpoint files to the network in rank id order, and then call <code class="docutils literal notranslate"><span class="pre">parameters_and_names</span></code> API to obtain all parameters in this network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
<span class="n">param_dicts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./node&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;CKP_1-4_32.ckpt&quot;</span><span class="p">)</span>  <span class="c1"># checkpoint file name of current node</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>  
    <span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">():</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">param_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank_size</span></code>: number of nodes in previous distributed training.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>: loads the checkpoint model parameter file and returns a parameter dictionary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code>: loads model parameter data to the network.</p></li>
</ul>
</section>
<section id="obtaining-the-model-parameter-slice-strategy">
<h4>Obtaining the Model Parameter Slice Strategy<a class="headerlink" href="#obtaining-the-model-parameter-slice-strategy" title="Permalink to this headline"></a></h4>
<p>Call the <code class="docutils literal notranslate"><span class="pre">build_searched_strategy</span></code> API to obtain the slice strategy of model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">strategy</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">build_searched_strategy</span><span class="p">(</span><span class="s2">&quot;./strategy_train.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">strategy_train.ckpt</span></code>: name of model parameter slice strategy. The training network is generated by the user calling the <code class="docutils literal notranslate"><span class="pre">set_auto_parallel_context</span></code> interface to customize the <code class="docutils literal notranslate"><span class="pre">strategy_ckpt_save_file</span></code> parameter.</p></li>
</ul>
</section>
</section>
<section id="integrating-the-model-parallel-parameters">
<h3>Integrating the Model Parallel Parameters<a class="headerlink" href="#integrating-the-model-parallel-parameters" title="Permalink to this headline"></a></h3>
<p>The following uses a model parameter as an example to describe a specific integration process.</p>
<p>The parameter name is weight and the slice strategy is to perform slice in a 4-device scenario.</p>
<ol class="arabic">
<li><p>Obtain the data value on all nodes for model parallel parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">sliced_parameters</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
     <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
     <span class="n">sliced_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>To ensure that the parameter update speed remains unchanged, you need to integrate the parameters saved in the optimizer, for example, moments.weight.</p>
</div></blockquote>
</li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">merge_sliced_parameter</span></code> API to merge the sliced parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">merged_parameter</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">merge_sliced_parameter</span><span class="p">(</span><span class="n">sliced_parameters</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>If there are multiple model parallel parameters, repeat steps 1 to 2 to process them one by one.</p>
</div></blockquote>
</section>
<section id="saving-the-data-and-generating-a-new-checkpoint-file">
<h3>Saving the Data and Generating a New Checkpoint File<a class="headerlink" href="#saving-the-data-and-generating-a-new-checkpoint-file" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>Convert <code class="docutils literal notranslate"><span class="pre">param_dict</span></code> to list type data..</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">each_param</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">param_data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_data</span>
    <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_param</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code> API to write the parameter data to a file and generate a new checkpoint file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="s2">&quot;./CKP-Integrated_1-4_32.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>: saves network model parameters to a file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CKP-Integrated_1-4_32.ckpt</span></code>: name of the generated checkpoint model parameter file.</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="loading-the-integrated-and-saved-checkpoint-file">
<h2>Loading the Integrated and Saved Checkpoint File<a class="headerlink" href="#loading-the-integrated-and-saved-checkpoint-file" title="Permalink to this headline"></a></h2>
<section id="overall-process-1">
<h3>Overall Process<a class="headerlink" href="#overall-process-1" title="Permalink to this headline"></a></h3>
<p>If you need to load the integrated and saved checkpoint file to multi-device training or inference, divide the parallel parameter data based on the new strategy before loading the model parameters to the network.</p>
<p>The following steps are implemented in the pre-training script. Steps 1 and 3 are the same as the strategy of checkpoint loading in a single-node system. Step 2 is added to divide model parallel parameters.</p>
<p>In the single-device training/inference scenario, data slice is not involved. In this case, step 2 can be skipped.</p>
</section>
<section id="step-1-loading-the-checkpoint-file">
<h3>Step 1: Loading the Checkpoint File<a class="headerlink" href="#step-1-loading-the-checkpoint-file" title="Permalink to this headline"></a></h3>
<p>Call the <code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code> API to load model parameter data from the checkpoint file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;./CKP-Integrated_1-4_32.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>: loads the checkpoint model parameter file and returns a parameter dictionary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CKP-Integrated_1-4_32.ckpt</span></code>: name of the checkpoint model parameter file to be loaded.</p></li>
</ul>
</section>
<section id="step-2-slicing-the-parallel-parameters-of-the-model">
<h3>Step 2: Slicing the Parallel Parameters of the Model<a class="headerlink" href="#step-2-slicing-the-parallel-parameters-of-the-model" title="Permalink to this headline"></a></h3>
<p>The following uses a specific model parameter as an example. The parameter name is “weight”, and the data value is Tensor [[1, 2, 3, 4], [5, 6, 7, 8]]. The slice strategy is to perform slice in the two-device scenario based on [2, 1].</p>
<p>Data distribution after slicing is as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Device0</p></th>
<th class="head"><p>Device1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value [1, 2, 3, 4]</p></td>
<td><p>Value [5, 6, 7, 8]</p></td>
</tr>
</tbody>
</table>
<ol class="arabic">
<li><p>Divide the model parameter data.</p>
<p>In the following code example, data is divided into two slices in dimension 0.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_param</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
<span class="n">slice_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">new_param_moments</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="s2">&quot;moments.weight&quot;</span><span class="p">]</span>
<span class="n">slice_moments_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param_moments</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Data after slicing:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>slice_list[0]  --- [1, 2, 3, 4]    Corresponding to device0
slice_list[1]  --- [5, 6, 7, 8]    Corresponding to device1
</pre></div>
</div>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">slice\_list</span></code>,<code class="docutils literal notranslate"><span class="pre">slice\_moments\_list</span></code> is divided into two tensors with the shape of [1, 4].</p>
</li>
<li><p>Load the corresponding data slice on each node.</p>
<p>Obtain rank_id of the current node and load data based on rank_id.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
<span class="n">tensor_slice</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">slice_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
<span class="n">tensor_slice_moments</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">slice_moments_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_rank</span></code>: obtains the ID of the current device in the cluster.</p></li>
</ul>
</li>
<li><p>Modify values of model parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_param</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">new_param_moments</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice_moments</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">set_data</span></code>: sets the value of a model parameter. The API parameter type is Tensor or number.</p></li>
</ul>
</li>
</ol>
</section>
<section id="step-3-loading-the-modified-parameter-data-to-the-network">
<h3>Step 3: Loading the Modified Parameter Data to the Network<a class="headerlink" href="#step-3-loading-the-modified-parameter-data-to-the-network" title="Permalink to this headline"></a></h3>
<p>Call the <code class="docutils literal notranslate"><span class="pre">load_param_into_net</span></code> API to load the model parameter data to the network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parallel_net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
<span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h2>
<section id="scenario-description">
<h3>Scenario Description<a class="headerlink" href="#scenario-description" title="Permalink to this headline"></a></h3>
<p>Overall scenario: The training is divided into two stages. The cluster scales in the two stages are different. The MatMul operator at the FC layer is simulated to run in parallel.</p>
<p>User process:</p>
<ol class="arabic simple">
<li><p>Execute stage 1 training. There are four devices in stage 1 training environment. The weight shape of the MatMul operator on each device is [2, 8]. Checkpoint files are automatically exported during the training.</p></li>
<li><p>Execute the script to integrate checkpoint files. Based on the specific slice strategy, integrate the divided model parameters to generate the integrated checkpoint file.</p></li>
<li><p>Execute stage 2 training: There are two devices in stage 2 training environment. The weight shape of the MatMul operator on each device is [4, 8]. Load the initialized model parameter data from the integrated checkpoint file and then perform training.</p></li>
</ol>
<blockquote>
<div><p>For details about the distributed environment configuration and training code, see <a class="reference external" href="https://www.mindspore.cn/tutorials/experts/en/r2.0.0-alpha/parallel/train_ascend.html">Distributed Training</a>.</p>
<p>This document provides the example code for integrating checkpoint files and loading checkpoint files before distributed training. The code is for reference only.</p>
</div></blockquote>
</section>
<section id="example-code">
<h3>Example Code<a class="headerlink" href="#example-code" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>Run the following script to integrate the checkpoint files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w">  </span>./integrate_checkpoint.py<span class="w"> </span><span class="s2">&quot;Name of the checkpoint file to be integrated&quot;</span><span class="w"> </span><span class="s2">&quot;Path and name of the checkpoint file generated after integration&quot;</span><span class="w"> </span><span class="s2">&quot;Path and name of the strategy file&quot;</span><span class="w"> </span><span class="s2">&quot;Number of nodes&quot;</span>
</pre></div>
</div>
<p>integrate_checkpoint.py:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
 <span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
 <span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>

 <span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight_init</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">weight_init</span><span class="p">),</span> <span class="n">layerwise_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MatMul</span><span class="p">(</span><span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
         <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">x</span>

 <span class="k">def</span> <span class="nf">integrate_ckpt_file</span><span class="p">(</span><span class="n">old_ckpt_file</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">,</span> <span class="n">strategy_file</span><span class="p">,</span> <span class="n">rank_size</span><span class="p">):</span>
     <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
     <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
     <span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
     <span class="n">net</span> <span class="o">=</span> <span class="n">TrainOneStepCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

     <span class="c1"># load CheckPoint into net in rank id order</span>
     <span class="n">param_dicts</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
         <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;./node&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">old_ckpt_file</span><span class="p">)</span>
         <span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>  
         <span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
         <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
         <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">parameters_and_names</span><span class="p">():</span>
             <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
             <span class="n">param_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>

     <span class="n">strategy</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">build_searched_strategy</span><span class="p">(</span><span class="n">strategy_file</span><span class="p">)</span>
     <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

     <span class="k">for</span> <span class="n">paramname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;moments.weight&quot;</span><span class="p">]:</span>
         <span class="c1"># get layer wise model parallel parameter</span>
         <span class="n">sliced_parameters</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank_size</span><span class="p">):</span>
             <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_dicts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">paramname</span><span class="p">)</span>
             <span class="n">sliced_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

         <span class="c1"># merge the parallel parameters of the model</span>
         <span class="n">merged_parameter</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">merge_sliced_parameter</span><span class="p">(</span><span class="n">sliced_parameters</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
         <span class="n">param_dict</span><span class="p">[</span><span class="n">paramname</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_parameter</span>

     <span class="c1"># convert param_dict to list type data</span>
     <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
         <span class="n">each_param</span> <span class="o">=</span> <span class="p">{}</span>
         <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
             <span class="n">param_data</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">param_data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
         <span class="n">each_param</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_data</span>
         <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_param</span><span class="p">)</span>

     <span class="c1"># call the API to generate a new CheckPoint file</span>
     <span class="n">ms</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">)</span>

     <span class="k">return</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
     <span class="k">try</span><span class="p">:</span>
         <span class="n">old_ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">new_ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
         <span class="n">strategy_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
         <span class="n">rank_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
         <span class="n">integrate_ckpt_file</span><span class="p">(</span><span class="n">old_ckpt_file</span><span class="p">,</span> <span class="n">new_ckpt_file</span><span class="p">,</span> <span class="n">strategy_file</span><span class="p">,</span> <span class="n">rank_size</span><span class="p">)</span>
     <span class="k">except</span><span class="p">:</span>
         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fail to integrate checkpoint file&quot;</span><span class="p">)</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The command output is as follows.</p>
<p>Before the script is executed, the parameter values in the checkpoint files are as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>device0:
name is weight
value is
[[0.87537426 1.0448935 0.86736983 0.8836905 0.77354026 0.69588304 0.9183654 0.7792076]
 [0.87224025 0.8726848 0.771446 0.81967723 0.88974726 0.7988162 0.72919345 0.7677011]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
 [0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194]]

device1:
name is weight
value is
[[0.9210751 0.9050457 0.9827775 0.920396 0.9240526 0.9750359 1.0275179 1.0819869]
 [0.73605865 0.84631145 0.9746683 0.9386582 0.82902765 0.83565056 0.9702136 1.0514659]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
 [0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102 -0.15327111]]

device2:
name is weight
value is
[[1.0108461 0.8689414  0.91719437 0.8805056 0.7994629 0.8999671 0.7585804 1.0287056 ]
 [0.90653455 0.60146594 0.7206475 0.8306303 0.8364681 0.89625114 0.7354735 0.8447268]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
 [0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738 0.24933104]]

device3:
name is weight
value is
[[0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
 [0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619 0.40430856]
[-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405 -0.12860501]]
</pre></div>
</div>
<p>After the script is executed, the parameter values in the checkpoint files are as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>name is weight
value is
[[1.1138763 1.0962057 1.3516843 1.0812817 1.1579804 1.1078343 1.0906502 1.3207073]
 [0.916671 1.0781671 1.0368758 0.9680898 1.1735439 1.0628364 0.9960786 1.0135143]
 [0.8828271 0.7963984 0.90675324 0.9830291 0.89010954 0.897052 0.7890109 0.89784735]
 [1.0011744 1.0840297 1.0201758 1.0882459 0.94232416 1.0775206 1.0195118 1.0528734]
 [1.0053468 0.98402303 0.99762845 0.97587246 1.0259694 1.0055295 0.99420834 0.9496847]
 [1.0851002 1.0295962 1.0999886 1.0958165 0.9765328 1.146529 1.0970603 1.1388365]
 [0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
 [0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
 [0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194 ]
 [0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
 [0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102 -0.15327111]
 [0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
 [0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738  0.24933104]
 [0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619  0.40430856]
 [-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405
  -0.12860501]]
</pre></div>
</div>
</li>
<li><p>Execute stage 2 training and load the checkpoint file before training. The training code needs to be supplemented based on the site requirements.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span>
<span class="kn">import</span> <span class="nn">mindspore.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span>
<span class="n">devid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEVICE_ID&#39;</span><span class="p">))</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">,</span><span class="n">device_target</span><span class="o">=</span><span class="s1">&#39;Ascend&#39;</span><span class="p">,</span><span class="n">save_graphs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device_id</span><span class="o">=</span><span class="n">devid</span><span class="p">)</span>
<span class="n">init</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight_init</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">weight_init</span><span class="p">),</span> <span class="n">layerwise_parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MatMul</span><span class="p">(</span><span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">train_mindspore_impl_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ckpt_file</span><span class="p">):</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">ckpt_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">paramname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;moments.weight&quot;</span><span class="p">]:</span>
        <span class="c1"># get layer wise model parallel parameter</span>
        <span class="n">new_param</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="n">paramname</span><span class="p">]</span>
        <span class="c1"># split the model parameter data</span>
        <span class="n">slice_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Load the corresponding data slice</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
        <span class="n">tensor_slice</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">slice_list</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
        <span class="c1"># modify model parameter data values</span>
        <span class="n">new_param</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">tensor_slice</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># load the modified parameter data into the network</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">Momentum</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parallel_net</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">())</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="c1"># train code</span>
        <span class="o">...</span>

    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mean = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">ckpt_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">train_mindspore_impl_fc</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ckpt_file</span><span class="p">)</span>
</pre></div>
</div>
<p>In the preceding information:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode=GRAPH_MODE</span></code>: sets the running mode to graph mode for distributed training. (The PyNative mode does not support parallel running.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device_id</span></code>: physical sequence number of a device, that is, the actual sequence number of the device on a computer where the device is located.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">init</span></code>: completes the distributed training initialization.</p></li>
</ul>
<p>Parameter values after loading:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>device0:
name is weight
value is
[[0.87537426 1.0448935 0.86736983 0.8836905 0.77354026 0.69588304 0.9183654 0.7792076]
[0.87224025 0.8726848 0.771446 0.81967723 0.88974726 0.7988162 0.72919345 0.7677011]
[0.8828271 0.7963984 0.90675324 0.9830291 0.89010954 0.897052 0.7890109 0.89784735]
[1.0011744 1.0840297 1.0201758 1.0882459 0.94232416 1.0775206 1.0195118 1.0528734]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.2567724 -0.07485991 0.282002 0.2456022 0.454939 0.619168 0.18964815 0.45714882]
[0.25946522 0.24344791 0.45677605 0.3611395 0.23378398 0.41439137 0.5312468 0.4696194]
[0.2417504 0.28193963 0.06713893 0.21510397 0.23380603 0.11424308 0.0218009 -0.11969765]
[0.45955992 0.22664294 0.01990281 0.0731914 0.27125207 0.27298513 -0.01716102  -0.15327111]]

device1:
name is weight
value is
[[1.0053468 0.98402303 0.99762845 0.97587246 1.0259694 1.0055295 0.99420834 0.9496847]
[1.0851002 1.0295962 1.0999886 1.0958165 0.9765328 1.146529 1.0970603 1.1388365]
[0.7147005 0.9168278 0.80178416 0.6258351 0.8413766 0.5909515 0.696347 0.71359116]
[0.20506378 0.03691584 0.2454556 0.12978578 0.19065076 0.23904312 0.27509746 0.34614682]]
name is learning_rate
value is [0.01]
name is momentum
value is [0.9]
name is moments.weight
value is
[[0.03440702 0.41419312 0.24817684 0.30765256 0.48516113 0.24904746 0.57791173 0.00955463]
[0.13458519 0.6690533 0.49259356 0.28319967 0.25951773 0.16777472 0.45696738  0.24933104]
[0.14152306 0.5040985 0.24455397 0.10907605 0.11319532 0.19538902 0.01208619  0.40430856]
[-0.7773164 -0.47611716 -0.6041424 -0.6144473 -0.2651842 -0.31909415 -0.4510405 -0.12860501]]
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="distributed_inference.html" class="btn btn-neutral float-left" title="Distributed Inference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fault_recover.html" class="btn btn-neutral float-right" title="Distributed Fault Recovery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>