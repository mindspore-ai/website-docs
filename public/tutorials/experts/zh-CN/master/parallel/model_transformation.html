<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>模型转换 &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
        <script src="../_static/js/theme.js"></script><script src="../_static/underscore.js"></script><script src="../_static/doctools.js"></script><script src="../_static/translations.js"></script><script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="故障恢复" href="recover.html" />
    <link rel="prev" title="模型加载" href="model_loading.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">分布式并行</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">分布式并行总览</a></li>
<li class="toctree-l1"><a class="reference internal" href="startup_method.html">分布式并行启动方式</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_parallel.html">数据并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="semi_auto_parallel.html">半自动并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_parallel.html">自动并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="manual_parallel.html">手动并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter_server_training.html">参数服务器</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="model_save_load.html">模型保存与加载</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="model_saving.html">模型保存</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_loading.html">模型加载</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">模型转换</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recover.html">故障恢复</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize_technique.html">优化方法</a></li>
<li class="toctree-l1"><a class="reference internal" href="platform_differences.html">不同平台差异</a></li>
<li class="toctree-l1"><a class="reference internal" href="others.html">实验特性</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_case.html">分布式高阶配置案例</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">自定义算子</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom.html">自定义算子（基于Custom表达）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/ms_kernel.html">MindSpore Hybrid 语法规范</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_adv.html">自定义算子注册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operation/op_custom_aot.html">aot类型自定义算子进阶用法</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">性能优化</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.mindspore.cn/mindinsight/docs/zh-CN/master/performance_profiling.html">Profiling↗</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/execution_opt.html">下沉模式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/op_overload.html">静态图网络编译性能优化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/graph_fusion_engine.html">使能图算融合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/op_compilation.html">算子增量编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/mem_reuse.html">内存复用</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">算法优化</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimize/gradient_accumulation.html">梯度累积</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimize/thor.html">二阶优化</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">高阶函数式编程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vmap/vmap.html">自动向量化Vmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../func_programming/Jacobians_Hessians.html">使用函数变换计算雅可比矩阵和黑塞矩阵</a></li>
<li class="toctree-l1"><a class="reference internal" href="../func_programming/per_sample_gradients.html">Per-sample-gradients</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">数据处理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dataset/augment.html">自动数据增强</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/cache.html">单节点数据缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset/optimize.html">数据处理性能优化</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">模型推理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../infer/inference.html">模型推理总览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infer/model_compression.html">模型压缩</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">复杂问题调试</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../debug/dump.html">Dump功能调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug/aoe.html">AOE调优工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug/rdr.html">Running Data Recorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug/fault_recover.html">故障恢复</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="model_save_load.html">模型保存与加载</a> &raquo;</li>
      <li>模型转换</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/parallel/model_transformation.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="模型转换">
<h1>模型转换<a class="headerlink" href="#模型转换" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/tutorials/experts/source_zh_cn/parallel/model_transformation.md"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/master/resource/_static/logo_source.png" /></a></p>
<section id="概述">
<h2>概述<a class="headerlink" href="#概述" title="Permalink to this headline"></a></h2>
<section id="背景">
<h3>背景<a class="headerlink" href="#背景" title="Permalink to this headline"></a></h3>
<p>在使用MindSpore进行分布式训练时，常常需要对训练得到的分布式Checkpoint进行转换以进行下一步工作，如推理、微调、多阶段训练等。本教程将介绍如何将分布式训练得到的Checkpoint进行转换以开展分布式策略与集群卡数改变的弹性训练与推理。</p>
<blockquote>
<div><p>本功能仅支持SEMI_AUTO_PARALLEL和AUTO_PARALLEL模式。</p>
</div></blockquote>
</section>
<section id="使用场景">
<h3>使用场景<a class="headerlink" href="#使用场景" title="Permalink to this headline"></a></h3>
<p>如果您遇到如下场景，需要参考本教程操作，进行弹性训练与推理：</p>
<p>场景1：M卡训练，N卡微调训练，M与N可以没有倍数关系。
场景2：训练分为多阶段，每个阶段的集群大小不一样。
场景3：M卡训练，N卡推理，M与N可以没有倍数关系。
场景4：需要对网络的切分策略进行变更。</p>
<p>相关接口：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mindspore.transform_checkpoints(src_checkpoints_dir,</span> <span class="pre">dst_checkpoints_dir,</span> <span class="pre">src_strategy_file,</span> <span class="pre">dst_strategy_file)</span></code>：将一个分布式网络的Checkpoint由源切分策略转换到目标切分策略。其中<code class="docutils literal notranslate"><span class="pre">src_checkpoints_dir</span></code>为源Checkpoint文件所在的目录，其子目录要求按照<code class="docutils literal notranslate"><span class="pre">rank_x/checkpoint_x.ckpt</span></code>格式进行存储，x为对应的rank id。<code class="docutils literal notranslate"><span class="pre">dst_checkpoints_dir</span></code>为目标Checkpoint文件存储的目录，<code class="docutils literal notranslate"><span class="pre">src_strategy_file</span></code>为源切分策略文件名，<code class="docutils literal notranslate"><span class="pre">dst_strategy_file</span></code>为目标切分策略文件名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mindspore.rank_list_for_transform(rank_id,</span> <span class="pre">src_strategy_file,</span> <span class="pre">dst_strategy_file)</span></code>：在对分布式Checkpoint转换的过程中，获取目标rank的Checkpoint文件所需的源Checkpoint文件rank列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mindspore.transform_checkpoint_by_rank(rank_id,</span> <span class="pre">checkpoint_files_map,</span> <span class="pre">save_checkpoint_file_name,</span> <span class="pre">src_strategy_file,</span> <span class="pre">dst_strategy_file)</span></code>：将一个分布式网络的Checkpoint由源切分策略转换到目标切分策略，对特定一个rank进行转换。其中<code class="docutils literal notranslate"><span class="pre">rank_id</span></code>为待转换得到的Checkpoint的rank号。<code class="docutils literal notranslate"><span class="pre">checkpoint_files_map</span></code>为源Checkpoint字典，其key为rank号，值为该rank号对应的Checkpoint文件路径。<code class="docutils literal notranslate"><span class="pre">save_checkpoint_file_name</span></code>为当前rank的目标Checkpoint路径以及名字。</p></li>
</ol>
</section>
</section>
<section id="操作实践">
<h2>操作实践<a class="headerlink" href="#操作实践" title="Permalink to this headline"></a></h2>
<p>以在Ascend 8卡上训练，并在4卡上微调为例，整体操作流程如下：</p>
<ol class="arabic simple">
<li><p>执行训练，配置模型参数切分策略文件存储位置，自动生成Checkpoint文件和模型参数切分策略文件。</p></li>
<li><p>编译微调网络，配置分布式策略文件存储位置，自动生成模型参数切分策略文件。</p></li>
<li><p>用户对依据训练与推理涉及到的策略文件对保存的Checkpoint文件进行转换。</p></li>
<li><p>编译微调网络后，加载转换得到的分布式Checkpoint文件。</p></li>
<li><p>执行微调网络。</p></li>
</ol>
<p>需要注意，加载分布式的Checkpoint，要求对网络进行编译后才可以加载。</p>
<section id="样例代码说明">
<h3>样例代码说明<a class="headerlink" href="#样例代码说明" title="Permalink to this headline"></a></h3>
<blockquote>
<div><p>下载完整的样例代码：<a class="reference external" href="https://gitee.com/mindspore/docs/tree/master/docs/sample_code/model_saving_loading">model_saving_loading</a>。</p>
</div></blockquote>
<p>目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└─ sample_code
    ├─ model_saving_loading
       ├── model_transformation_infer.py
       ├── model_transformation_retrain.py
       ├── pipeline_train.py
       ├── pipeline_transformation_retrain.py
       ├── run_infer_convert.sh
       ├── run_infer.sh
       ├── run_retrain_convert.sh
       ├── run_retrain.sh
       ├── run_pipeline_train.sh
       ├── run_retrain_pipeline_convert.sh
       ├── run_retrain_pipeline.sh
       ...
    ...
</pre></div>
</div>
<p>其中每个文件的作用如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model_transformation_infer.py</span></code>：模型转换后进行推理的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model_transformation_retrain.py</span></code>：模型转换后进行二阶段训练的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pipeline_transformation_retrain.py</span></code>：流水线并行模型转换后二阶段训练的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pipeline_train.py</span></code>：流水线并行训练网络的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_infer_convert.sh</span></code>：执行模型转换的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_retrain_convert.sh</span></code>：执行模型转换的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_retrain_pipeline_convert.sh</span></code>：执行流水线并行模型转换的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_infer.sh</span></code>：执行模型推理的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_retrain.sh</span></code>：执行二阶段训练的脚本。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_retrain_pipeline.sh</span></code>：执行二阶段训练流水线并行模型的脚本。</p></li>
</ul>
</section>
<section id="分布式模型保存">
<h3>分布式模型保存<a class="headerlink" href="#分布式模型保存" title="Permalink to this headline"></a></h3>
<p>首先，按照<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_saving.html">模型保存</a>教程执行8卡分布式训练，并行模式为<code class="docutils literal notranslate"><span class="pre">SEMI_AUTO_PARALLEL</span></code>或者<code class="docutils literal notranslate"><span class="pre">AUTO_PARALLEL</span></code>，同时通过调用<code class="docutils literal notranslate"><span class="pre">set_auto_parallel_context</span></code>接口自定义<code class="docutils literal notranslate"><span class="pre">strategy_ckpt_config</span></code>参数配置模型切分策略文件存储路径，训练一段时间后，调用存储Checkpoint的<code class="docutils literal notranslate"><span class="pre">train.ModelCheckpoint</span></code>函数，将分布式的Checkpoint存储下来。</p>
<p>训练结束后，将会在当前路径生成源Checkpoint文件目录以及源切分策略文件：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>src_checkpoints/
src_strategy.ckpt
</pre></div>
</div>
<blockquote>
<div><p>src_checkpoints内的子目录要求按照<code class="docutils literal notranslate"><span class="pre">rank_x/checkpoint_x.ckpt</span></code>格式进行存储。</p>
</div></blockquote>
<p>即src_checkpoints的目录结构改成如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>src_checkpoints
 ├─ rank_0
 |   └─ checkpoint_0.ckpt
 ├─ rank_1
 |   └─ checkpoint_1.ckpt
 ├─ rank_2
 |   └─ checkpoint_2.ckpt
 ├─ rank_3
 |   └─ checkpoint_3.ckpt
 ├─ rank_4
 |   └─ checkpoint_4.ckpt
 ├─ rank_5
 |   └─ checkpoint_5.ckpt
 ├─ rank_6
 |   └─ checkpoint_6.ckpt
 └─ rank_7
     └─ checkpoint_7.ckpt
...
</pre></div>
</div>
</section>
<section id="生成目标策略文件">
<h3>生成目标策略文件<a class="headerlink" href="#生成目标策略文件" title="Permalink to this headline"></a></h3>
<p>然后需要编译新的卡数或者切分策略下的网络，生成目标网络的模型切分策略文件，本示例中，原始策略以8卡进行训练，layer1的<code class="docutils literal notranslate"><span class="pre">ops.MatMul()</span></code>算子并行策略为((2, 1), (1, 2))，不开启优化器并行，策略文件命名为src_strategy.ckpt；目标策略以4卡进行训练，layer1的<code class="docutils literal notranslate"><span class="pre">ops.MatMul()</span></code>算子并行策略为((2, 2), (2, 1))，且开启优化器并行，策略文件命名为dst_stategy.ckpt。</p>
<section id="配置分布式环境">
<h4>配置分布式环境<a class="headerlink" href="#配置分布式环境" title="Permalink to this headline"></a></h4>
<p>通过context接口指定运行模式、并行模式，通过<code class="docutils literal notranslate"><span class="pre">strategy_ckpt_config</span></code>配置需要保存的分布式策略文件路径，开启优化器并行，并通过init初始化HCCL或NCCL通信。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span>

<span class="n">ms</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">parallel_mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">ParallelMode</span><span class="o">.</span><span class="n">SEMI_AUTO_PARALLEL</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">strategy_ckpt_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;save_file&quot;</span><span class="p">:</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_strategy_file</span><span class="p">})</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">enable_parallel_optimizer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">init</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="网络定义以及加载数据集">
<h4>网络定义以及加载数据集<a class="headerlink" href="#网络定义以及加载数据集" title="Permalink to this headline"></a></h4>
<p>网络定义修改了原始网络中layer1的<code class="docutils literal notranslate"><span class="pre">ops.MatMul()</span></code>算子并行策略：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.common.initializer</span> <span class="kn">import</span> <span class="n">initializer</span>

<span class="k">class</span> <span class="nc">Dense</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">initializer</span><span class="p">(</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">],</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">initializer</span><span class="p">(</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">out_channels</span><span class="p">],</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matmul</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">MatMul</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Add</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="k">class</span> <span class="nc">Network</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logits</span>

<span class="n">net</span> <span class="o">=</span> <span class="n">Network</span><span class="p">()</span>
<span class="n">net</span><span class="o">.</span><span class="n">layer1</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">shard</span><span class="p">(((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">net</span><span class="o">.</span><span class="n">layer3</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">shard</span><span class="p">(((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
    <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATA_PATH&quot;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">MnistDataset</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
    <span class="n">image_transforms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">Rescale</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3081</span><span class="p">,)),</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">label_transform</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">TypeCast</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">image_transforms</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">label_transform</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span>

<span class="n">data_set</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="对目标网络执行编译">
<h4>对目标网络执行编译<a class="headerlink" href="#对目标网络执行编译" title="Permalink to this headline"></a></h4>
<p>进行分布式的Checkpoint的转换，依赖于原始的分布式策略文件与目标的分布式策略文件，执行原始的策略下的网络训练时，已经将分布式策略文件存储下来了，因此需要另外获取到目标策略下的分布式策略文件。通过对目标策略的网络执行编译，即可获取到目标策略网络的分布式策略文件。通过<code class="docutils literal notranslate"><span class="pre">model.infer_train_layout</span></code>接口即可以单独对网络执行编译。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">ops</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trainable_params</span><span class="p">(),</span> <span class="mf">1e-2</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">infer_train_layout</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
</pre></div>
</div>
<p>当目标网络是进行推理时，则将<code class="docutils literal notranslate"><span class="pre">model.infer_train_layout</span></code>更换为<code class="docutils literal notranslate"><span class="pre">model.infer_preict_layout</span></code>以执行编译：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="n">predict_data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">infer_predict_layout</span><span class="p">(</span><span class="n">predict_data</span><span class="p">)</span>
</pre></div>
</div>
<p>编译完成后，即可得到目标切分策略文件<code class="docutils literal notranslate"><span class="pre">dst_strategy.ckpt</span></code>。</p>
</section>
</section>
<section id="执行分布式checkpoint转换">
<h3>执行分布式Checkpoint转换<a class="headerlink" href="#执行分布式checkpoint转换" title="Permalink to this headline"></a></h3>
<p>在这一步，需要调用分布式Checkpoint转换的接口进行分布式Checkpoint的转换，分布式Checkpoint提供两个接口对Checkpoint进行转换。第一个接口<code class="docutils literal notranslate"><span class="pre">transform_checkpoints</span></code>，要求用户将所有的Checkpoint放置于一个目录，并且子目录必须以”rank_0、rank_1、rank_2、…“格式进行命名。用户调用该接口直接对整个目录进行转换。该方式使用较为方便，但是转换需要的内存开销会略高一些。第二个接口<code class="docutils literal notranslate"><span class="pre">transform_checkpoint_by_rank</span></code>，用以获取到特定的rank的Checkpoint，有更大的灵活性与更低的内存开销，需要配合<code class="docutils literal notranslate"><span class="pre">rank_list_for_transform</span></code>接口使用，以获取本rank的目标Checkpoint需要哪些原始Checkpoint。</p>
<ol class="arabic">
<li><p>使用接口<code class="docutils literal notranslate"><span class="pre">transform_checkpoints</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="n">ms</span><span class="o">.</span><span class="n">transform_checkpoints</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">src_checkpoints_dir</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoint_&quot;</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_file</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_strategy_file</span><span class="p">)</span>
</pre></div>
</div>
<p>示例代码<a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/sample_code/model_saving_loading/model_transformation_retrain.py"><code class="docutils literal notranslate"><span class="pre">model_transformation_retrain.py</span></code></a>中采用此方法。</p>
</li>
<li><p>调用<code class="docutils literal notranslate"><span class="pre">transform_checkpoint_by_rank</span></code>接口对当前rank对应的原始Checkpoint进行参数合并。</p>
<blockquote>
<div><p>需要保证dst_checkpoints_dir内存在子目录”rank_x”。</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">get_rank</span>

<span class="n">rank_list</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">rank_list_for_transform</span><span class="p">(</span><span class="n">get_rank</span><span class="p">(),</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_file</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_strategy_file</span><span class="p">)</span>
<span class="n">checkpoint_file_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">rank_id</span> <span class="ow">in</span> <span class="n">rank_list</span><span class="p">:</span>
    <span class="n">checkpoint_file_map</span><span class="p">[</span><span class="n">rank_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">src_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank_id</span><span class="p">),</span> <span class="s2">&quot;checkpoint_</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank_id</span><span class="p">))</span>
<span class="n">save_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">dst_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()),</span> <span class="s2">&quot;checkpoint_</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()))</span>
<span class="n">ms</span><span class="o">.</span><span class="n">transform_checkpoint_by_rank</span><span class="p">(</span><span class="n">get_rank</span><span class="p">(),</span> <span class="n">checkpoint_file_map</span><span class="p">,</span> <span class="n">save_checkpoint_path</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_file</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_strategy_file</span><span class="p">)</span>
</pre></div>
</div>
<p>示例代码<a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/sample_code/model_saving_loading/model_transformation_infer.py"><code class="docutils literal notranslate"><span class="pre">model_transformation_infer.py</span></code></a>中采用此方法。</p>
</li>
</ol>
<p>执行完后，将会生成转换后的目标Checkpoint文件目录：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dst_checkpoints/
</pre></div>
</div>
</section>
<section id="加载转换得到的checkpoint文件">
<h3>加载转换得到的Checkpoint文件<a class="headerlink" href="#加载转换得到的checkpoint文件" title="Permalink to this headline"></a></h3>
<p>对目标策略的网络进行编译，调用<code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>接口，从转换后的Checkpoint文件中加载模型参数数据。</p>
<p>使用<code class="docutils literal notranslate"><span class="pre">model.infer_train_layout</span></code>(训练时)或者<code class="docutils literal notranslate"><span class="pre">model.infer_predict_layout</span></code>(推理时)接口对网络进行编译，此时权重Shape在编译流程进行了切分；调用<code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>接口，从Checkpoint文件中加载各卡的模型参数数据。</p>
<p>目标网络是训练场景：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">train</span>

<span class="n">save_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">dst_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()),</span> <span class="s2">&quot;checkpoint_</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()))</span>
<span class="n">loss_cb</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">LossMonitor</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">infer_train_layout</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">save_checkpoint_path</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">data_set</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">loss_cb</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_checkpoint_path</span></code>：需要加载的当前rank对应的Checkpoint模型参数文件名称。</p></li>
</ul>
<p>目标网络是推理场景：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="n">save_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">dst_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()),</span> <span class="s2">&quot;checkpoint_</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()))</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">save_checkpoint_path</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">infer_predict_layout</span><span class="p">(</span><span class="n">predict_data</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">load_param_into_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
<span class="n">predict_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predict_result</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">predict_data</span></code>：用于推理的Tensor数据。</p></li>
</ul>
</section>
<section id="运行单机四卡脚本">
<h3>运行单机四卡脚本<a class="headerlink" href="#运行单机四卡脚本" title="Permalink to this headline"></a></h3>
<p>接下来通过命令调用对应的脚本，以<code class="docutils literal notranslate"><span class="pre">mpirun</span></code>启动方式，4卡的分布式脚本为例，进行模型转换后的二阶段微调训练：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_retrain_convert.sh
bash<span class="w"> </span>run_retrain.sh
</pre></div>
</div>
<p>或者模型转换后的推理：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_infer_convert.sh
bash<span class="w"> </span>run_infer.sh
</pre></div>
</div>
<p>执行完成后，日志文件保存到<code class="docutils literal notranslate"><span class="pre">log_output</span></code>目录下，目标Checkpoint文件保存在<code class="docutils literal notranslate"><span class="pre">dst_checkpoints</span></code>文件夹下，目标策略文件保存在<code class="docutils literal notranslate"><span class="pre">dst_strategy.ckpt</span></code>，文件目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>├─ src_strategy.ckpt
├─ dst_strategy.ckpt
├─ log_output
|   └─ 1
|       ├─ rank.0
|       |   └─ stdout
|       ├─ rank.1
|       |   └─ stdout
|       ...
├─ dst_checkpoints
|   ├─ rank_0
|   |   └─ checkpoint_0.ckpt
|   ├─ rank_1
|   |   └─ checkpoint_1.ckpt
|   |   ...
|   ...
...
</pre></div>
</div>
<p>二阶段微调训练后的Loss部分结果保存在<code class="docutils literal notranslate"><span class="pre">log_output/1/rank.*/stdout</span></code>中，示例如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>epoch: 1, step: 20, loss is 0.10617774
epoch: 1, step: 40, loss is 0.06953259
epoch: 1, step: 60, loss is 0.08409108
epoch: 1, step: 80, loss is 0.08699021
epoch: 1, step: 100, loss is 0.07113413
...
</pre></div>
</div>
<p>如果是推理任务，则结果保存在<code class="docutils literal notranslate"><span class="pre">log_output/1/rank.*/stdout</span></code>中，示例如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[[ 0.05044775 -0.94413316  0.84689134 -0.2881832   0.66444755  1.0564336
  -0.04191193  0.25590348 -0.690101   -0.6532427 ]]
</pre></div>
</div>
</section>
<section id="流水线并行模型转换">
<h3>流水线并行模型转换<a class="headerlink" href="#流水线并行模型转换" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/pipeline_parallel.html">流水线并行</a> 是对线性的网络进行切分，得到多个子网络，子网络之间在多卡间进行流水，因此每个子图存储下来的切分策略文件是不一致的，所有切分策略汇聚在一起才能得到完整的网络的切分信息。
因此针对流水线并行的维度，相比于其它维度的转换，需要事先执行一次汇聚切分策略文件的操作，得到汇聚后的切分策略文件，以这一份文件作为分布式Checkpoint转换依赖的策略文件。此外，与前面的<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_transformation.html#%E6%89%A7%E8%A1%8C%E5%88%86%E5%B8%83%E5%BC%8Fcheckpoint%E8%BD%AC%E6%8D%A2">执行分布式Checkpoint转换</a>没有差异。</p>
<p>相关接口：</p>
<p><code class="docutils literal notranslate"><span class="pre">mindspore.merge_pipeline_strategys(src_strategy_dirs,</span> <span class="pre">dst_strategy_file)</span></code>：流水线并行模式下，汇聚所有流水线并行子图的切分策略文件。<code class="docutils literal notranslate"><span class="pre">src_strategy_dirs</span></code>为包含所有流水线并行的子图的切分策略文件的目录，切分策略文件由<code class="docutils literal notranslate"><span class="pre">mindspore.set_auto_parallel_context(strategy_ckpt_config)</span></code>接口存储得到。<code class="docutils literal notranslate"><span class="pre">dst_strategy_file</span></code>为保存汇聚后的切分策略的文件路径。</p>
<p>首先，执行8卡的流水线并行训练，其中pipeline并行维度为2，且开启优化器并行。</p>
<p>训练代码在<a class="reference external" href="https://gitee.com/mindspore/docs/blob/master/docs/sample_code/model_saving_loading/pipeline_train.py">pipeline_train.py</a>中，网络结构在<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_saving.html">模型保存</a>这一章的基础上增加了流水线并行的配置，并行维度为2。</p>
<p>核心代码为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">train</span>
<span class="kn">from</span> <span class="nn">mindspore.communication</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span> <span class="n">get_rank</span>
<span class="o">...</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">GRAPH_MODE</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">parallel_mode</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">ParallelMode</span><span class="o">.</span><span class="n">SEMI_AUTO_PARALLEL</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">pipeline_stages</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">enable_parallel_optimizer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">init</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_auto_parallel_context</span><span class="p">(</span><span class="n">strategy_ckpt_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;save_file&quot;</span><span class="p">:</span> <span class="s2">&quot;./src_pipeline_strategys/src_strategy_</span><span class="si">{}</span><span class="s2">.ckpt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">())})</span>
<span class="n">ms</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">ckpt_config</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">integrated_save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ckpoint_cb</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">,</span>
                                   <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./src_checkpoints_pipeline/rank_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()),</span>
                                   <span class="n">config</span><span class="o">=</span><span class="n">ckpt_config</span><span class="p">)</span>
<span class="n">net_with_grads</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">PipelineCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">WithLossCell</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">net_with_grads</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_set</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">loss_cb</span><span class="p">,</span> <span class="n">ckpoint_cb</span><span class="p">])</span>
</pre></div>
</div>
<blockquote>
<div><p>每张卡得到的切分策略文件是不一致的，因此需要分别保存，按照”src_pipeline_strategys/src_strategy_x.ckpt”格式进行存储。</p>
</div></blockquote>
<p>执行8卡训练脚本执行命令为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_pipeline_train.sh
</pre></div>
</div>
<p>执行后，将会生成源Checkpoint文件目录以及源切分策略文件，文件目录结构为：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>├─ src_checkpoints_pipeline
|   ├─ rank_0
|   |   ├─ checkpoint-3_1875.ckpt
|   |   └─ checkpoint-graph.meta
|   ├─ rank_1
|   |   ├─ checkpoint-3_1875.ckpt
|   |   ...
|   ...
├─ src_pipeline_strategys
|   ├─ src_strategy_0.ckpt
|   ├─ src_strategy_1.ckpt
|   ├─ src_strategy_2.ckpt
|   ├─ src_strategy_3.ckpt
|   ├─ src_strategy_4.ckpt
|   ├─ src_strategy_5.ckpt
|   ├─ src_strategy_6.ckpt
|   └─ src_strategy_7.ckpt
...
</pre></div>
</div>
<p>参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_transformation.html#%E5%AF%B9%E7%9B%AE%E6%A0%87%E7%BD%91%E7%BB%9C%E6%89%A7%E8%A1%8C%E7%BC%96%E8%AF%91">对目标网络执行编译</a>章节，同样编译目标网络以得到目标网络的切分策略文件。</p>
<p>下一步展开包含pipeline并行维度的分布式Checkpoint维度转换，首先使用接口<code class="docutils literal notranslate"><span class="pre">merge_pipeline_strategys</span></code>对pipline训练得到的切分策略文件进行合并，而后使用接口<code class="docutils literal notranslate"><span class="pre">transform_checkpoints</span></code>或者<code class="docutils literal notranslate"><span class="pre">transform_checkpoint_by_rank</span></code>进行分布式Checkpoint转换。</p>
<p>示例给出使用<code class="docutils literal notranslate"><span class="pre">transform_checkpoints</span></code>的接口，使用<code class="docutils literal notranslate"><span class="pre">transform_checkpoint_by_rank</span></code>接口请参考<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_transformation.html#%E6%89%A7%E8%A1%8C%E5%88%86%E5%B8%83%E5%BC%8Fcheckpoint%E8%BD%AC%E6%8D%A2">执行分布式Checkpoint转换</a> 章节的介绍。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>

<span class="n">ms</span><span class="o">.</span><span class="n">merge_pipeline_strategys</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_dir</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_file</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">transform_checkpoints</span><span class="p">(</span><span class="n">args_opt</span><span class="o">.</span><span class="n">src_checkpoints_dir</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_checkpoints_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoint_&quot;</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">src_strategy_file</span><span class="p">,</span> <span class="n">args_opt</span><span class="o">.</span><span class="n">dst_strategy_file</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>src_checkpoints_dir内的子目录要求按照”rank_x/checkpoint_x.ckpt”格式进行存储。</p>
</div></blockquote>
<p>示例中，对整个Checkpoint目录进行转换的脚本执行命令为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_retrain_pipeline_convert.sh
</pre></div>
</div>
<p>转换完成后，参照<a class="reference external" href="https://www.mindspore.cn/tutorials/experts/zh-CN/master/parallel/model_transformation.html#%E5%8A%A0%E8%BD%BD%E8%BD%AC%E6%8D%A2%E5%BE%97%E5%88%B0%E7%9A%84checkpoint%E6%96%87%E4%BB%B6">加载转换得到的Checkpoint文件</a>章节，执行没有pipeline维度的分布式网络。</p>
<p>示例中，加载转换后的Checkpoint进行二阶段微调训练的脚本执行命令为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>run_retrain_pipeline.sh
</pre></div>
</div>
<p>执行完成后，可以看到loss从0.15开始下降：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>epoch: 1, step: 20, loss is 0.15090162
epoch: 1, step: 40, loss is 0.13296325
epoch: 1, step: 60, loss is 0.14676111
epoch: 1, step: 80, loss is 0.11930083
epoch: 1, step: 100, loss is 0.0784434
epoch: 1, step: 120, loss is 0.10741685
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="model_loading.html" class="btn btn-neutral float-left" title="模型加载" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="recover.html" class="btn btn-neutral float-right" title="故障恢复" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>