

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>模型保存与导出 &mdash; MindSpore master documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/training.css" type="text/css" />
   
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  
  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/js/training.js"></script>
        
        
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="动态图与静态图" href="../pynative_graph.html" />
    <link rel="prev" title="回调机制 Callback" href="callback.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> MindSpore
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">初学教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/introduction.html">基本介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/quick_start.html">快速入门：手写数字识别</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/tensor.html">张量 Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/dataset.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/model.html">创建网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/autograd.html">自动微分</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/train.html">模型训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/save_load.html">保存与加载</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginner/infer.html">推理与部署</a></li>
</ul>
<p class="caption"><span class="caption-text">进阶</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linear_fitting.html">进阶案例：线性拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataset.html">数据处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network.html">网络构建</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../train.html">训练与评估</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="metric.html">评价指标</a></li>
<li class="toctree-l2"><a class="reference internal" href="train_eval.html">训练和评估</a></li>
<li class="toctree-l2"><a class="reference internal" href="model.html">Model基本使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="callback.html">回调机制 Callback</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">模型保存与导出</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#保存模型">保存模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#训练过程保存模型">训练过程保存模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#直接保存模型">直接保存模型</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#迁移学习">迁移学习</a></li>
<li class="toctree-l3"><a class="reference internal" href="#模型导出">模型导出</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#导出mindir格式文件">导出MindIR格式文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#导出onnx格式文件">导出ONNX格式文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#导出air格式文件">导出AIR格式文件</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pynative_graph.html">动态图与静态图</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MindSpore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../train.html">训练与评估</a> &raquo;</li>
        
      <li>模型保存与导出</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/advanced/train/save.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="模型保存与导出">
<h1>模型保存与导出<a class="headerlink" href="#模型保存与导出" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://authoring-modelarts-cnnorth4.huaweicloud.com/console/lab?share-url-b64=aHR0cHM6Ly9vYnMuZHVhbHN0YWNrLmNuLW5vcnRoLTQubXlodWF3ZWljbG91ZC5jb20vbWluZHNwb3JlLXdlYnNpdGUvbm90ZWJvb2svcjEuNy90dXRvcmlhbHMvemhfY24vYWR2YW5jZWQvdHJhaW4vbWluZHNwb3JlX3NhdmUuaXB5bmI=&amp;imageid=9d63f4d1-dc09-4873-b669-3483cea777c0"><img alt="在线运行" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_modelarts.png" /></a> <a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r1.7/tutorials/zh_cn/advanced/train/mindspore_save.ipynb"><img alt="下载Notebook" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_notebook.png" /></a> <a class="reference external" href="https://obs.dualstack.cn-north-4.myhuaweicloud.com/mindspore-website/notebook/r1.7/tutorials/zh_cn/advanced/train/mindspore_save.py"><img alt="下载样例代码" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_download_code.png" /></a> <a class="reference external" href="https://gitee.com/mindspore/docs/blob/r1.7/tutorials/source_zh_cn/advanced/train/save.ipynb"><img alt="查看源文件" src="https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/website-images/r1.7/resource/_static/logo_source.png" /></a></p>
<p>在模型训练过程中，可以添加检查点(CheckPoint)用于保存模型的参数，以便执行推理及再训练使用。如果想继续在不同硬件平台上做推理，可通过网络和CheckPoint格式文件生成对应的MindIR、AIR和ONNX格式文件。</p>
<ul class="simple">
<li><p><strong>CheckPoint</strong>：采用了Protocol Buffers机制，存储了网络中的所有的参数值。一般用于训练任务中断后恢复训练，或训练后的微调（Fine Tune）任务中。</p></li>
<li><p><strong>MindIR</strong>：全称MindSpore IR，是MindSpore的一种基于图表示的函数式IR，定义了可扩展的图结构以及算子的IR表示，同时存储了网络结构和权重参数值。它消除了不同后端的模型差异，一般用于跨硬件平台执行推理任务，比如把在Ascend 910训练好的模型，放在Ascend 310、GPU以及MindSpore Lite端侧上执行推理。</p></li>
<li><p><strong>ONNX</strong>：全称Open Neural Network Exchange，是一种针对机器学习所设计的开放式的文件格式，同时存储了网络结构和权重参数值。一般用于不同框架间的模型迁移或在推理引擎(TensorRT)上使用。</p></li>
<li><p><strong>AIR</strong>：全称Ascend Intermediate Representation，是华为定义的针对机器学习所设计的开放式的文件格式，同时存储了网络结构和权重参数值，能更好地适配Ascend AI处理器。一般用于Ascend 310上执行推理任务。</p></li>
</ul>
<p>本章主要介绍如何保存CheckPoint格式文件和导出MindIR、AIR和ONNX格式文件的方法。</p>
<div class="section" id="保存模型">
<h2>保存模型<a class="headerlink" href="#保存模型" title="Permalink to this headline">¶</a></h2>
<p>初级教程的<a class="reference external" href="https://mindspore.cn/tutorials/zh-CN/r1.7/beginner/save_load.html">保存与加载章节</a>已经介绍了使用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>直接保存模型参数和使用Callback机制在训练过程中保存模型参数方法。本节将进一步介绍在训练过程中保存模型参数和使用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>直接保存模型参数的方法。</p>
<div class="section" id="训练过程保存模型">
<h3>训练过程保存模型<a class="headerlink" href="#训练过程保存模型" title="Permalink to this headline">¶</a></h3>
<p>在训练过程中保存模型参数，MindSpore提供了两种保存策略，迭代策略和时间策略，可以通过创建<code class="docutils literal notranslate"><span class="pre">CheckpointConfig</span></code>对象设置相应策略。迭代策略和时间策略不能同时使用，其中迭代策略优先级高于时间策略，当同时设置时，只有迭代策略可以生效。当参数显示设置为None时，表示放弃该策略。另外，当训练过程中发生异常时，MindSpore也提供了断点续训功能，即在异常发生时系统会自动保存异常发生时的CheckPoint文件。</p>
<ol class="arabic simple">
<li><p>迭代策略</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">CheckpointConfig</span></code>中可根据迭代的次数进行配置，配置迭代策略的参数如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_checkpoint_steps</span></code>：表示每隔多少个step保存一个CheckPoint文件，默认值为1。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keep_checkpoint_max</span></code>：表示最多保存多少个CheckPoint文件，默认值为5。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">CheckpointConfig</span>

<span class="c1"># 每隔32个step保存一个CheckPoint文件，且最多保存10个CheckPoint文件</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>在迭代策略脚本正常结束的情况下，会默认保存最后一个step的CheckPoint文件。</p>
<ol class="arabic simple" start="2">
<li><p>时间策略</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">CheckpointConfig</span></code>中可根据训练的时长进行配置，配置时间策略的参数如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_checkpoint_seconds</span></code>：表示每隔多少秒保存一个CheckPoint文件，默认值为0。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keep_checkpoint_per_n_minutes</span></code>：表示每隔多少分钟保留一个CheckPoint文件，默认值为0。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">CheckpointConfig</span>

<span class="c1"># 每隔30秒保存一个CheckPoint文件，每隔3分钟保留一个CheckPoint文件</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">keep_checkpoint_per_n_minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">save_checkpoint_seconds</span></code>参数不可与<code class="docutils literal notranslate"><span class="pre">save_checkpoint_steps</span></code>参数一起使用。如果同时设置了两个参数，则<code class="docutils literal notranslate"><span class="pre">save_checkpoint_seconds</span></code>参数无效。</p>
<ol class="arabic simple" start="3">
<li><p>断点续训</p></li>
</ol>
<p>MindSpore提供了断点续训的功能，当用户开启该功能时，如果在训练过程中发生了异常，那么MindSpore会自动保存异常发生时的CheckPoint文件(临终CheckPoint)。断点续训的功能通过CheckpointConfig中的<code class="docutils literal notranslate"><span class="pre">exception_save</span></code>参数(bool类型)控制，设置为True时开启该功能，False关闭该功能，默认为False。断点续训功能保存的临终CheckPoint文件与正常流程保存的CheckPoint互不影响，命名机制和保存路径与正常流程设置保持一致，唯一不同之处在于会在临终CheckPoint文件名最后加上’_breakpoint’进行区分。其用法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore.train.callback</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CheckpointConfig</span>

<span class="c1"># 配置断点续训功能开启</span>
<span class="n">config_ck</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">(</span><span class="n">save_checkpoint_steps</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">keep_checkpoint_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">exception_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>如果在训练过程中发生了异常，那么会自动保存临终CheckPoint，假如在训练中的第10个epoch的第10个step中发生异常，保存的临终CheckPoint文件如下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 临终CheckPoint文件名最后会加上&#39;_breakpoint&#39;与正常流程CheckPoint区分开</span>
<span class="n">resnet50</span><span class="o">-</span><span class="mi">10_10</span><span class="n">_breakpoint</span><span class="o">.</span><span class="n">ckpt</span>
</pre></div>
</div>
</div>
<div class="section" id="直接保存模型">
<h3>直接保存模型<a class="headerlink" href="#直接保存模型" title="Permalink to this headline">¶</a></h3>
<p>可以使用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>函数直接把内存中的网络权重参数保存到CheckPoint文件，常用参数如下所示：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_obj</span></code>：Cell对象或者数据列表。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ckpt_file_name</span></code>： checkpoint文件名称。如果文件已存在，将会覆盖原有文件。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">integrated_save</span></code>：在并行场景下是否合并保存拆分的Tensor。默认值为True。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">async_save</span></code>：是否异步执行保存checkpoint文件。默认值为False。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">append_dict</span></code>：需要保存的其他信息。dict的键必须为str类型，dict的值类型必须是float或者bool类型。默认值为None。</p></li>
</ul>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_obj</span></code>参数</p></li>
</ol>
<p>初级教程的<a class="reference external" href="https://mindspore.cn/tutorials/zh-CN/r1.7/beginner/save_load.html#保存与加载">保存与加载章节</a>已经介绍了当<code class="docutils literal notranslate"><span class="pre">save_obj</span></code>为Cell对象时，如何使用<code class="docutils literal notranslate"><span class="pre">save_checkpoint</span></code>直接保存模型参数。下面介绍当传入数据列表时，如何保存模型参数。传入数据列表时，列表的每个元素为字典类型，比如[{“name”: param_name, “data”: param_data},…]， <code class="docutils literal notranslate"><span class="pre">param_name</span></code>的类型必须是str，<code class="docutils literal notranslate"><span class="pre">param_data</span></code>的类型必须是Parameter或者Tensor。示例如下所示：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">save_checkpoint</span><span class="p">,</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">dtype</span> <span class="k">as</span> <span class="n">mstype</span>

<span class="n">save_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;train_epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">mstype</span><span class="o">.</span><span class="n">int32</span><span class="p">)}]</span>
<span class="n">save_checkpoint</span><span class="p">(</span><span class="n">save_list</span><span class="p">,</span> <span class="s2">&quot;hyper_param.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p><code class="docutils literal notranslate"><span class="pre">integrated_save</span></code>参数</p></li>
</ol>
<p>表示参数是否合并保存，默认为True。在模型并行场景下，Tensor会被切分到不同卡所运行的程序中。如果integrated_save设置为True，则这些被切分的Tensor会被合并保存到每个checkpoint文件中，这样checkpoint文件保存的就是完整的训练参数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s2">&quot;resnet50-2_32.ckpt&quot;</span><span class="p">,</span> <span class="n">integrated_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><code class="docutils literal notranslate"><span class="pre">async_save</span></code>参数</p></li>
</ol>
<p>表示是否开启异步保存功能，默认为False。如果设置为True，则会开启多线程执行写checkpoint文件操作，从而可以并行执行训练和保存任务，在训练大规模网络时会节省脚本运行的总时长。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s2">&quot;resnet50-2_32.ckpt&quot;</span><span class="p">,</span> <span class="n">async_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p><code class="docutils literal notranslate"><span class="pre">append_dict</span></code>参数</p></li>
</ol>
<p>需要额外保存的信息，类型为dict类型，目前只支持基础类型的保存，包括int、float、bool等。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">save_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;epoch_num&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
<span class="c1"># 除了net中的参数，save_dict的信息也会保存在ckpt文件中</span>
<span class="n">save_checkpoint</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s2">&quot;resnet50-2_32.ckpt&quot;</span><span class="p">,</span><span class="n">append_dict</span><span class="o">=</span><span class="n">save_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="迁移学习">
<h2>迁移学习<a class="headerlink" href="#迁移学习" title="Permalink to this headline">¶</a></h2>
<p>迁移学习场景中，使用预训练模型进行训练时，CheckPoint文件中的模型参数无法直接使用，需要根据实际情况进行修改才能适用于当前网络模型。本节介绍如何删除Resnet50的预训练模型中的全连接层参数。</p>
<p>首先下载<a class="reference external" href="https://download.mindspore.cn/vision/classification/resnet50_224.ckpt">Resnet50的预训练模型</a>，该模型文件是由<a class="reference external" href="https://mindspore.cn/vision/docs/zh-CN/r0.1/index.html">MindSpore Vision</a>中的<code class="docutils literal notranslate"><span class="pre">resnet50</span></code>模型在ImageNet数据集上训练得到的。</p>
<p>使用<code class="docutils literal notranslate"><span class="pre">load_checkpoint</span></code>接口加载训练模型，该接口返回一个Dict类型，该字典的健值key为网络各层的名称，类型为字符型Str；字典的值value为网络层的参数值，类型为Parameter。</p>
<p>如下示例中由于Resnet50预训练模型的分类类别数为1000，而示例中定义的resnet50网络分类类别数为２，所以需要删除预训练模型中的全连接层参数。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mindvision.classification.models</span> <span class="kn">import</span> <span class="n">resnet50</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">load_checkpoint</span><span class="p">,</span> <span class="n">load_param_into_net</span>
<span class="kn">from</span> <span class="nn">mindvision.dataset</span> <span class="kn">import</span> <span class="n">DownLoad</span>

<span class="c1"># 下载Resnet50的预训练模型</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">DownLoad</span><span class="p">()</span>
<span class="n">dl</span><span class="o">.</span><span class="n">download_url</span><span class="p">(</span><span class="s1">&#39;https://download.mindspore.cn/vision/classification/resnet50_224.ckpt&#39;</span><span class="p">)</span>
<span class="c1"># 定义分类类被为2的resnet50网络</span>
<span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># 模型参数保存到param_dict中</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;resnet50_224.ckpt&quot;</span><span class="p">)</span>

<span class="c1"># 获取全连接层的参数名列表</span>
<span class="n">param_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">resnet</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">filter_ckpt_parameter</span><span class="p">(</span><span class="n">origin_dict</span><span class="p">,</span> <span class="n">param_filter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;删除origin_dict中包含param_filter参数名的元素&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">origin_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="c1"># 获取模型的所有参数名</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_filter</span><span class="p">:</span> <span class="c1"># 遍历模型中待删除的参数名</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delete parameter from checkpoint:&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">origin_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">break</span>

<span class="c1"># 删除全连接层</span>
<span class="n">filter_ckpt_parameter</span><span class="p">(</span><span class="n">param_dict</span><span class="p">,</span> <span class="n">param_filter</span><span class="p">)</span>

<span class="c1"># 打印更新后的模型参数</span>
<span class="n">load_param_into_net</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Delete parameter from checkpoint: head.dense.weight
Delete parameter from checkpoint: head.dense.bias
</pre></div></div>
</div>
</div>
<div class="section" id="模型导出">
<h2>模型导出<a class="headerlink" href="#模型导出" title="Permalink to this headline">¶</a></h2>
<p>MindSpore的<code class="docutils literal notranslate"><span class="pre">export</span></code>可以将网络模型导出为指定格式的文件，用于其他硬件平台的推理。<code class="docutils literal notranslate"><span class="pre">export</span></code>主要参数如下所示：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">net</span></code>：MindSpore网络结构。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code>：网络的输入，支持输入类型为Tensor。当输入有多个时，需要一起传入，如<code class="docutils literal notranslate"><span class="pre">export(network,</span> <span class="pre">Tensor(input1),</span> <span class="pre">Tensor(input2),</span> <span class="pre">file_name='network',</span> <span class="pre">file_format='MINDIR')</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file_name</span></code>：导出模型的文件名称，如果<code class="docutils literal notranslate"><span class="pre">file_name</span></code>没有包含对应的后缀名(如.mindir)，设置<code class="docutils literal notranslate"><span class="pre">file_format</span></code>后系统会为文件名自动添加后缀。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file_format</span></code>：MindSpore目前支持导出”AIR”，”ONNX”和”MINDIR”格式的模型。</p></li>
</ul>
<p>如下介绍使用<code class="docutils literal notranslate"><span class="pre">export</span></code>将resnet50网络和相应的CheckPoint格式文件生成对应的MindIR、AIR和ONNX格式文件。</p>
<div class="section" id="导出mindir格式文件">
<h3>导出MindIR格式文件<a class="headerlink" href="#导出mindir格式文件" title="Permalink to this headline">¶</a></h3>
<p>如果想跨平台或硬件执行推理（如昇腾AI处理器、MindSpore端侧、GPU等），可以通过网络定义和CheckPoint生成MindIR格式模型文件。当前支持基于静态图。如下使用MindSpore Vision中的<code class="docutils literal notranslate"><span class="pre">resnet50</span></code>模型和该模型在ImageNet数据集上训练得到的模型文件resnet50_224.ckpt，导出MindIR格式文件。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">export</span><span class="p">,</span> <span class="n">load_checkpoint</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models</span> <span class="kn">import</span> <span class="n">resnet50</span>

<span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;resnet50_224.ckpt&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">resnet</span><span class="p">)</span>

<span class="n">input_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># 导出文件resnet50_224.mindir到当前文件夹</span>
<span class="n">export</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">input_np</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;resnet50_224&#39;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>若想在MindIR格式文件中保存模型推理时需要的预处理操作信息，可以将数据集对象传入export接口：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset.vision.c_transforms</span> <span class="k">as</span> <span class="nn">C</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">export</span><span class="p">,</span> <span class="n">load_checkpoint</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models</span> <span class="kn">import</span> <span class="n">resnet50</span>
<span class="kn">from</span> <span class="nn">mindvision.dataset</span> <span class="kn">import</span> <span class="n">DownLoad</span>

<span class="k">def</span> <span class="nf">create_dataset_for_renset</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;创建数据集&quot;&quot;&quot;</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ImageFolderDataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.456</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.406</span> <span class="o">*</span> <span class="mi">255</span><span class="p">]</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.224</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.225</span> <span class="o">*</span> <span class="mi">255</span><span class="p">]</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">operations</span><span class="o">=</span><span class="p">[</span><span class="n">C</span><span class="o">.</span><span class="n">Decode</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                                        <span class="n">C</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">HWC2CHW</span><span class="p">()],</span> <span class="n">input_columns</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_set</span>

<span class="n">dataset_url</span> <span class="o">=</span> <span class="s2">&quot;https://mindspore-website.obs.cn-north-4.myhuaweicloud.com/notebook/datasets/beginner/DogCroissants.zip&quot;</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;./datasets&quot;</span>
<span class="c1"># 下载并解压数据集</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">DownLoad</span><span class="p">()</span>
<span class="n">dl</span><span class="o">.</span><span class="n">download_and_extract_archive</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">dataset_url</span><span class="p">,</span> <span class="n">download_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
<span class="c1"># 加载数据集</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;./datasets/DogCroissants/val/&quot;</span>
<span class="n">de_dataset</span> <span class="o">=</span> <span class="n">create_dataset_for_renset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c1"># 定义网络</span>
<span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">()</span>

<span class="c1"># 加载预处理模型参数到网络中</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;resnet50_224.ckpt&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">resnet</span><span class="p">)</span>
<span class="c1"># 导出带预处理信息的MindIR文件</span>
<span class="n">export</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">de_dataset</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;resnet50_224&#39;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;MINDIR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>如果file_name没有包含”.mindir”后缀，系统会为其自动添加”.mindir”后缀。</p>
</div></blockquote>
<p>为了避免Protocol Buffers的硬件限制，当导出的模型参数大小超过1G时，框架默认会把网络结构和参数分开保存。</p>
<ul class="simple">
<li><p>网络结构文件的名称以用户指定前缀加_graph.mindir结尾。</p></li>
<li><p>同级目录下，会生成一个用户指定前缀加_variables的文件夹，里面存放网络的参数。其中参数大小每超过1T会被分开保存成命名为data_1、data_2、data_3等的多个文件。</p></li>
</ul>
<p>以上述代码为例，如果带参数的模型大小超过1G，生成的目录结构如下：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>├── resnet50_224_graph.mindir
└── resnet50_224_variables
    ├── data_1
    ├── data_2
    └── data_3
</pre></div>
</div>
</div>
<div class="section" id="导出onnx格式文件">
<h3>导出ONNX格式文件<a class="headerlink" href="#导出onnx格式文件" title="Permalink to this headline">¶</a></h3>
<p>当有了CheckPoint文件后，如果想继续在昇腾AI处理器、GPU或CPU等多种硬件上做推理，需要通过网络和CheckPoint生成对应的ONNX格式模型文件。如下使用MindSpore Vision中的<code class="docutils literal notranslate"><span class="pre">resnet50</span></code>模型和该模型在ImageNet数据集上训练得到的模型文件resnet50_224.ckpt，导出ONNX格式文件。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">export</span><span class="p">,</span> <span class="n">load_checkpoint</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models</span> <span class="kn">import</span> <span class="n">resnet50</span>

<span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">()</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;resnet50_224.ckpt&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">resnet</span><span class="p">)</span>

<span class="n">input_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># 保存resnet50_224.onnx文件到当前目录下</span>
<span class="n">export</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">input_np</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;resnet50_224&#39;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;ONNX&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>如果file_name没有包含”.onnx”后缀，系统会为其自动添加”.onnx”后缀。</p></li>
<li><p>目前ONNX格式导出仅支持ResNet系列、YOLOV3、YOLOV4、BERT网络。</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="导出air格式文件">
<h3>导出AIR格式文件<a class="headerlink" href="#导出air格式文件" title="Permalink to this headline">¶</a></h3>
<p>AIR格式文件用于在昇腾AI处理器上执行推理，导出AIR格式文件需要在昇腾AI处理器上进行操作，可通过网络定义和CheckPoint生成AIR格式模型文件。如下使用MindSpore Vision中的<code class="docutils literal notranslate"><span class="pre">resnet50</span></code>模型和该模型在ImageNet数据集上训练得到的模型文件resnet50_224.ckpt，在昇腾AI处理器上导出AIR格式文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">export</span><span class="p">,</span> <span class="n">load_checkpoint</span>
<span class="kn">from</span> <span class="nn">mindvision.classification.models</span> <span class="kn">import</span> <span class="n">resnet50</span>

<span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">()</span>
<span class="c1"># 加载参数到网络中</span>
<span class="n">load_checkpoint</span><span class="p">(</span><span class="s2">&quot;resnet50_224.ckpt&quot;</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">resnet</span><span class="p">)</span>
<span class="c1"># 网络输入</span>
<span class="n">input_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># 保存resnet50_224.air文件到当前目录下</span>
<span class="n">export</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">input_np</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;resnet50_224&#39;</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s1">&#39;AIR&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果file_name没有包含“.air”后缀，系统会为其自动添加“.air”后缀。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../pynative_graph.html" class="btn btn-neutral float-right" title="动态图与静态图" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="callback.html" class="btn btn-neutral float-left" title="回调机制 Callback" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, MindSpore.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   
	<script async="async" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>