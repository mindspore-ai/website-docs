<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mindspore_xai.runner.image_classification_runner &mdash; MindSpore master documentation</title><script>;(()=>{const e=localStorage.getItem("ms-theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;(e?"dark"===e:t)&&document.documentElement.setAttribute("data-o-theme","dark")})();</script><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script><script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/js/theme.js"></script><script src="../../../_static/underscore.js"></script><script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MindSpore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mindspore_xai.runner.html">mindspore_xai.runner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindspore_xai.explanation.html">mindspore_xai.explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mindspore_xai.benchmark.html">mindspore_xai.benchmark</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MindSpore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>mindspore_xai.runner.image_classification_runner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mindspore_xai.runner.image_classification_runner</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020-2021 Huawei Technologies Co., Ltd</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="sd">&quot;&quot;&quot;Image Classification Runner.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">mindspore</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">mindspore</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">import</span> <span class="nn">mindspore.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="kn">from</span> <span class="nn">mindspore.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">mindspore.nn</span> <span class="kn">import</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">SequentialCell</span>
<span class="kn">from</span> <span class="nn">mindspore.ops.operations</span> <span class="kn">import</span> <span class="n">ExpandDims</span>
<span class="kn">from</span> <span class="nn">mindspore.train._utils</span> <span class="kn">import</span> <span class="n">check_value_type</span>
<span class="kn">from</span> <span class="nn">mindspore.train.summary._summary_adapter</span> <span class="kn">import</span> <span class="n">_convert_image_format</span>
<span class="kn">from</span> <span class="nn">mindspore.nn.probability.toolbox.uncertainty_evaluation</span> <span class="kn">import</span> <span class="n">UncertaintyEvaluation</span>

<span class="kn">from</span> <span class="nn">mindspore_xai.proto.summary_pb2</span> <span class="kn">import</span> <span class="n">Explain</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.summary.summary_writer</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.benchmark</span> <span class="kn">import</span> <span class="n">Localization</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.benchmark.attribution.metric</span> <span class="kn">import</span> <span class="n">AttributionMetric</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.benchmark.attribution.metric</span> <span class="kn">import</span> <span class="n">LabelSensitiveMetric</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.benchmark.attribution.metric</span> <span class="kn">import</span> <span class="n">LabelAgnosticMetric</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.explanation</span> <span class="kn">import</span> <span class="n">RISE</span><span class="p">,</span> <span class="n">RISEPlus</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.explanation.attribution</span> <span class="kn">import</span> <span class="n">Attribution</span>
<span class="kn">from</span> <span class="nn">mindspore_xai.explanation.counterfactual</span> <span class="kn">import</span> <span class="n">hierarchical_occlusion</span> <span class="k">as</span> <span class="n">hoc</span>


<span class="n">_EXPAND_DIMS</span> <span class="o">=</span> <span class="n">ExpandDims</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_normalize</span><span class="p">(</span><span class="n">img_np</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize the numpy image to the range of [0, 1]. &quot;&quot;&quot;</span>
    <span class="n">max_</span> <span class="o">=</span> <span class="n">img_np</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_</span> <span class="o">=</span> <span class="n">img_np</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">normed</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_np</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_</span> <span class="o">-</span> <span class="n">min_</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normed</span>


<span class="k">def</span> <span class="nf">_np_to_image</span><span class="p">(</span><span class="n">img_np</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert numpy array to PIL image.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">img_np</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Verifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verification of dataset and settings of ImageClassificationRunner.&quot;&quot;&quot;</span>
    <span class="n">ALL</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">REGISTRATION</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DATA_N_NETWORK</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">SALIENCY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">HOC</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify datasets and settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            flags (int): Verification flags, use bitwise or &#39;|&#39; to combine multiple flags.</span>
<span class="sd">                Possible bitwise flags are shown as follow.</span>

<span class="sd">                - ALL: Verify everything.</span>
<span class="sd">                - REGISTRATION: Verify explainer module registration.</span>
<span class="sd">                - DATA_N_NETWORK: Verify dataset and network.</span>
<span class="sd">                - SALIENCY: Verify saliency related settings.</span>
<span class="sd">                - HOC: Verify HOC related settings.</span>
<span class="sd">                - ENVIRONMENT: Verify the runtime environment.</span>

<span class="sd">        Raises:</span>
<span class="sd">                ValueError: Be raised for any data or settings&#39; value problem.</span>
<span class="sd">                TypeError: Be raised for any data or settings&#39; type problem.</span>
<span class="sd">                RuntimeError: Be raised for any runtime problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">:</span>
            <span class="n">device_target</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;device_target&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Ascend&quot;</span><span class="p">,</span> <span class="s2">&quot;GPU&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported device_target: &#39;</span><span class="si">{</span><span class="n">device_target</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;only &#39;Ascend&#39; or &#39;GPU&#39; is supported. &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;Please call context.set_context(device_target=&#39;Ascend&#39;) or &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;context.set_context(device_target=&#39;GPU&#39;).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ENVIRONMENT</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">SALIENCY</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saliency_registered</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">context</span><span class="o">.</span><span class="n">PYNATIVE_MODE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Context mode: GRAPH_MODE is not supported, &quot;</span>
                                       <span class="s2">&quot;please call context.set_context(mode=context.PYNATIVE_MODE).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">REGISTRATION</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_uncertainty_registered</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saliency_registered</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function register_uncertainty() is called but register_saliency() is not.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saliency_registered</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_hoc_registered</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No explanation module was registered, user should at least call register_saliency() &quot;</span>
                    <span class="s2">&quot;or register_hierarchical_occlusion() once with proper arguments.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_N_NETWORK</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">SALIENCY</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOC</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_data</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_N_NETWORK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_network</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SALIENCY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_saliency</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_verify_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify labels.&quot;&quot;&quot;</span>
        <span class="n">label_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The label list provided is empty.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label [</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] is all whitespaces or empty. Please make sure there is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;no empty label.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_set</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicated label:</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">! Please make sure all labels are unique.&quot;</span><span class="p">)</span>
            <span class="n">label_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_ds_inputs_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a dataset sample&#39;s input shape.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Image shape </span><span class="si">{}</span><span class="s2"> is unrecognizable: the dimension of image can only be CHW or NCHW.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Image shape </span><span class="si">{}</span><span class="s2"> is 3-dimensional. All the data will be automatically unsqueezed at the 0-th&quot;</span>
                <span class="s2">&quot; dimension as batch data.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Labels shape </span><span class="si">{}</span><span class="s2"> is unrecognizable: outputs should not have more than two dimensions&quot;</span>
                    <span class="s2">&quot; with length greater than 1.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_hoc_registered</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Hierarchical occlusion is registered, images must be in 3 channels format, but &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> channel(s) is(are) encountered.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">short_side</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">short_side</span> <span class="o">&lt;</span> <span class="n">hoc</span><span class="o">.</span><span class="n">AUTO_IMAGE_SHORT_SIDE_MIN</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Hierarchical occlusion is registered, images&#39; short side must be equals to or greater then &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, but </span><span class="si">{}</span><span class="s2"> is encountered.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hoc</span><span class="o">.</span><span class="n">AUTO_IMAGE_SHORT_SIDE_MIN</span><span class="p">,</span> <span class="n">short_side</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_verify_ds_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a dataset sample.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The dataset should provide [images] or [images, labels], [images, labels, bboxes]&quot;</span>
                             <span class="s2">&quot; as columns.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="k">if</span> <span class="n">bboxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The third element of dataset should be bounding boxes with shape of &quot;</span>
                                 <span class="s2">&quot;[batch_size, num_ground_truth, 4].&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bench</span><span class="p">,</span> <span class="n">Localization</span><span class="p">)</span> <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The dataset must provide bboxes if Localization is to be computed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ds_inputs_shape</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify dataset and labels.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_labels</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The dataset provided is empty.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ds_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify the network.&quot;&quot;&quot;</span>
        <span class="n">next_element</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">create_tuple_iterator</span><span class="p">())</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_next_element</span><span class="p">(</span><span class="n">next_element</span><span class="p">)</span>
        <span class="n">prop_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;output of network in explainer&quot;</span><span class="p">,</span> <span class="n">prop_test</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The dimension of network output does not match the no. of classes. Please &quot;</span>
                             <span class="s2">&quot;check labels or the network in the explainer again.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_saliency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify the saliency settings.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span><span class="p">:</span>
            <span class="n">explainer_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">explainer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">explainer_classes</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repeated </span><span class="si">{</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> explainer! &quot;</span>
                                     <span class="s2">&quot;Please make sure all explainers&#39; class is distinct.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">explainer</span><span class="o">.</span><span class="n">network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The network of </span><span class="si">{</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> explainer is different &quot;</span>
                                     <span class="s2">&quot;instance from network of runner. Please make sure they are the same &quot;</span>
                                     <span class="s2">&quot;instance.&quot;</span><span class="p">)</span>
                <span class="n">explainer_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
            <span class="n">benchmarker_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">benchmarker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">benchmarker</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">benchmarker_classes</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repeated </span><span class="si">{</span><span class="n">benchmarker</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> benchmarker! &quot;</span>
                                     <span class="s2">&quot;Please make sure all benchmarkers&#39; class is distinct.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benchmarker</span><span class="p">,</span> <span class="n">LabelSensitiveMetric</span><span class="p">)</span> <span class="ow">and</span> <span class="n">benchmarker</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The num_labels of </span><span class="si">{</span><span class="n">benchmarker</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> benchmarker is different &quot;</span>
                                     <span class="s2">&quot;from no. of labels of runner. Please make them are the same.&quot;</span><span class="p">)</span>
                <span class="n">benchmarker_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">benchmarker</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>


<div class="viewcode-block" id="ImageClassificationRunner"><a class="viewcode-back" href="../../../mindspore_xai.runner.html#mindspore_xai.runner.ImageClassificationRunner">[docs]</a><span class="k">class</span> <span class="nc">ImageClassificationRunner</span><span class="p">(</span><span class="n">_Verifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A high-level API for users to generate and store results of the explanation methods and the evaluation methods.</span>

<span class="sd">    Update in 2020.11: Adjust the storage structure and format of the data. Summary files generated by previous version</span>
<span class="sd">    will be deprecated and will not be supported in MindInsight of current version.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary_dir (str): The directory path to save the summary files which store the generated results.</span>
<span class="sd">        data (tuple[Dataset, list[str]]): Tuple of dataset and the corresponding class label list. The dataset</span>
<span class="sd">            should provides [images], [images, labels] or [images, labels, bboxes] as columns. The label list must</span>
<span class="sd">            share the exact same length and order of the network outputs.</span>
<span class="sd">        network (Cell): The network(with logit outputs) to be explained.</span>
<span class="sd">        activation_fn (Cell): The activation layer that transforms logits to prediction probabilities. For</span>
<span class="sd">            single label classification tasks, `nn.Softmax` is usually applied. As for multi-label classification</span>
<span class="sd">            tasks, `nn.Sigmoid` is usually be applied. Users can also pass their own customized `activation_fn` as long</span>
<span class="sd">            as when combining this function with network, the final output is the probability of the input.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: Be raised for any argument type problem.</span>

<span class="sd">    Supported Platforms:</span>
<span class="sd">        ``Ascend`` ``GPU``</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from mindspore.nn import Softmax</span>
<span class="sd">        &gt;&gt;&gt; from mindspore import context, load_checkpoint, load_param_into_net</span>
<span class="sd">        &gt;&gt;&gt; from mindspore_xai.runner import ImageClassificationRunner</span>
<span class="sd">        &gt;&gt;&gt; from mindspore_xai.explanation import GuidedBackprop, Gradient</span>
<span class="sd">        &gt;&gt;&gt; from mindspore_xai.benchmark import Faithfulness</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; context.set_context(mode=context.PYNATIVE_MODE)</span>
<span class="sd">        &gt;&gt;&gt; # The detail of AlexNet is shown in model_zoo.official.cv.alexnet.src.alexnet.py</span>
<span class="sd">        &gt;&gt;&gt; net = AlexNet(10)</span>
<span class="sd">        &gt;&gt;&gt; # Load the checkpoint</span>
<span class="sd">        &gt;&gt;&gt; param_dict = load_checkpoint(&quot;/path/to/checkpoint&quot;)</span>
<span class="sd">        &gt;&gt;&gt; load_param_into_net(net, param_dict)</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Prepare the dataset for explaining and evaluation.</span>
<span class="sd">        &gt;&gt;&gt; # The detail of create_dataset_cifar10 method is shown in model_zoo.official.cv.alexnet.src.dataset.py</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; dataset = create_dataset_cifar10(&quot;/path/to/cifar/dataset&quot;, 1)</span>
<span class="sd">        &gt;&gt;&gt; labels = [&#39;airplane&#39;, &#39;automobile&#39;, &#39;bird&#39;, &#39;cat&#39;, &#39;deer&#39;, &#39;dog&#39;, &#39;frog&#39;, &#39;horse&#39;, &#39;ship&#39;, &#39;truck&#39;]</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; activation_fn = Softmax()</span>
<span class="sd">        &gt;&gt;&gt; gbp = GuidedBackprop(net)</span>
<span class="sd">        &gt;&gt;&gt; gradient = Gradient(net)</span>
<span class="sd">        &gt;&gt;&gt; explainers = [gbp, gradient]</span>
<span class="sd">        &gt;&gt;&gt; faithfulness = Faithfulness(len(labels), activation_fn, &quot;NaiveFaithfulness&quot;)</span>
<span class="sd">        &gt;&gt;&gt; benchmarkers = [faithfulness]</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; runner = ImageClassificationRunner(&quot;./summary_dir&quot;, (dataset, labels), net, activation_fn)</span>
<span class="sd">        &gt;&gt;&gt; runner.register_saliency(explainers=explainers, benchmarkers=benchmarkers)</span>
<span class="sd">        &gt;&gt;&gt; runner.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># datafile directory names</span>
    <span class="n">_DATAFILE_DIRNAME_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;_explain_&quot;</span>
    <span class="n">_ORIGINAL_IMAGE_DIRNAME</span> <span class="o">=</span> <span class="s2">&quot;origin_images&quot;</span>
    <span class="n">_HEATMAP_DIRNAME</span> <span class="o">=</span> <span class="s2">&quot;heatmap&quot;</span>
    <span class="c1"># specfial filenames</span>
    <span class="n">_MANIFEST_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;manifest.json&quot;</span>
    <span class="c1"># max. no. of sample per directory</span>
    <span class="n">_SAMPLE_PER_DIR</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="c1"># seed for fixing the iterating order of the dataset</span>
    <span class="n">_DATASET_SEED</span> <span class="o">=</span> <span class="mi">58</span>
    <span class="c1"># printing spacer</span>
    <span class="n">_SPACER</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:120}</span><span class="se">\r</span><span class="s2">&quot;</span>
    <span class="c1"># datafile directory&#39;s permission</span>
    <span class="n">_DIR_MODE</span> <span class="o">=</span> <span class="mo">0o700</span>
    <span class="c1"># datafile&#39;s permission</span>
    <span class="n">_FILE_MODE</span> <span class="o">=</span> <span class="mo">0o400</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">summary_dir</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">,</span>
                 <span class="n">network</span><span class="p">,</span>
                 <span class="n">activation_fn</span><span class="p">):</span>

        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument data is not a tuple with 2 elements&quot;</span><span class="p">)</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;data[0]&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Dataset</span><span class="p">)</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;data[1]&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument data[1] is not list of str.&quot;</span><span class="p">)</span>

        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;summary_dir&quot;</span><span class="p">,</span> <span class="n">summary_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">Cell</span><span class="p">)</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;activation_fn&quot;</span><span class="p">,</span> <span class="n">activation_fn</span><span class="p">,</span> <span class="n">Cell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_dir</span> <span class="o">=</span> <span class="n">summary_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span> <span class="o">=</span> <span class="n">SequentialCell</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">,</span> <span class="n">activation_fn</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">_Verifier</span><span class="o">.</span><span class="n">DATA_N_NETWORK</span> <span class="o">|</span> <span class="n">_Verifier</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">)</span>

<div class="viewcode-block" id="ImageClassificationRunner.register_saliency"><a class="viewcode-back" href="../../../mindspore_xai.runner.html#mindspore_xai.runner.ImageClassificationRunner.register_saliency">[docs]</a>    <span class="k">def</span> <span class="nf">register_saliency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">explainers</span><span class="p">,</span>
                          <span class="n">benchmarkers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register saliency explanation instances.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function can not be invoked more than once on each runner.</span>

<span class="sd">        Args:</span>
<span class="sd">            explainers (list[Attribution]): The explainers to be evaluated,</span>
<span class="sd">                see `mindspore_xai.explanation`. All explainers&#39; class must be distinct and their network</span>
<span class="sd">                must be the exact same instance of the runner&#39;s network.</span>
<span class="sd">            benchmarkers (list[AttributionMetric], optional): The benchmarkers for scoring the explainers,</span>
<span class="sd">                see `mindspore_xai.benchmark`. All benchmarkers&#39; class must be distinct.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Be raised for any data or settings&#39; value problem.</span>
<span class="sd">            TypeError: Be raised for any data or settings&#39; type problem.</span>
<span class="sd">            RuntimeError: Be raised if this function was invoked before.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;explainers&quot;</span><span class="p">,</span> <span class="n">explainers</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">Attribution</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">explainers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument explainers is not list of mindspore_xai.explanation .&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">explainers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument explainers is empty.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">benchmarkers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_value_type</span><span class="p">(</span><span class="s2">&quot;benchmarkers&quot;</span><span class="p">,</span> <span class="n">benchmarkers</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">AttributionMetric</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">benchmarkers</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument benchmarkers is not list of mindspore_xai.benchmark .&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Function register_saliency() was invoked already.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span> <span class="o">=</span> <span class="n">explainers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span> <span class="o">=</span> <span class="n">benchmarkers</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">_Verifier</span><span class="o">.</span><span class="n">SALIENCY</span> <span class="o">|</span> <span class="n">_Verifier</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="ImageClassificationRunner.register_hierarchical_occlusion"><a class="viewcode-back" href="../../../mindspore_xai.runner.html#mindspore_xai.runner.ImageClassificationRunner.register_hierarchical_occlusion">[docs]</a>    <span class="k">def</span> <span class="nf">register_hierarchical_occlusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register hierarchical occlusion instances.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function can not be invoked more than once on each runner.</span>

<span class="sd">        Note:</span>
<span class="sd">            Input images are required to be in 3 channels formats and the length of side short must be equals to or</span>
<span class="sd">            greater than 56 pixels. This function can not be invoked more than once on each runner.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Be raised for any data or settings&#39; value problem.</span>
<span class="sd">            RuntimeError: Be raised if the function was called already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Function register_hierarchical_occlusion() was invoked already.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span> <span class="o">=</span> <span class="n">hoc</span><span class="o">.</span><span class="n">Searcher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">_Verifier</span><span class="o">.</span><span class="n">HOC</span> <span class="o">|</span> <span class="n">_Verifier</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="ImageClassificationRunner.register_uncertainty"><a class="viewcode-back" href="../../../mindspore_xai.runner.html#mindspore_xai.runner.ImageClassificationRunner.register_uncertainty">[docs]</a>    <span class="k">def</span> <span class="nf">register_uncertainty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register uncertainty instance to compute the epistemic uncertainty base on the Bayes&#39; theorem.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This function can not be invoked more than once on each runner.</span>

<span class="sd">        Note:</span>
<span class="sd">            Please refer to the documentation of mindspore.nn.probability.toolbox.uncertainty_evaluation for the</span>
<span class="sd">            details. The actual output is standard deviation of the classification predictions and the corresponding</span>
<span class="sd">            95% confidence intervals. Users have to invoke register_saliency() as well for the uncertainty results are</span>
<span class="sd">            going to be shown on the saliency map page in MindInsight. This function can not be invoked more then once</span>
<span class="sd">            on each runner.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: Be raised if the function was called already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Function register_uncertainty() was invoked already.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span> <span class="o">=</span> <span class="n">UncertaintyEvaluation</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span><span class="p">,</span>
                                                  <span class="n">train_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                  <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span>
                                                  <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageClassificationRunner.run"><a class="viewcode-back" href="../../../mindspore_xai.runner.html#mindspore_xai.runner.ImageClassificationRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the explain job and save the result as a summary in summary_dir.</span>

<span class="sd">        Note:</span>
<span class="sd">            User should call register_saliency() once before running this function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Be raised for any data or settings&#39; value problem.</span>
<span class="sd">            TypeError: Be raised for any data or settings&#39; type problem.</span>
<span class="sd">            RuntimeError: Be raised for any runtime problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">_Verifier</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;saliency_map&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="s2">&quot;benchmark&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="s2">&quot;hierarchical_occlusion&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">summary</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start running and writing......&quot;</span><span class="p">)</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot get timestamp from summary writer!&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_save_metadata</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

            <span class="n">imageid_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_inference</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">sample_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saliency_registered</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_saliency</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">imageid_labels</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s2">&quot;saliency_map&quot;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No saliency map was generated in </span><span class="si">{</span><span class="n">sample_count</span><span class="si">}</span><span class="s2"> samples. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Please make sure the dataset, labels, activation function and network are properly trained &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;and configured.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_hoc_registered</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s2">&quot;hierarchical_occlusion&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No Hierarchical Occlusion result was found in </span><span class="si">{</span><span class="n">sample_count</span><span class="si">}</span><span class="s2"> samples. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please make sure the dataset, labels, activation function and network are properly trained &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and configured.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_save_manifest</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish running and writing. Total time elapsed: </span><span class="si">{:.3f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_hoc_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if HOC module is registered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_saliency_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if saliency module is registered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_uncertainty_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if uncertainty module is registered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save metadata of the explain job to summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start writing metadata......&quot;</span><span class="p">)</span>

        <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
        <span class="n">explain</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_saliency_registered</span><span class="p">:</span>
            <span class="n">exp_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span><span class="p">]</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">explain_method</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">exp_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bench_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">bench</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">]</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">benchmark_method</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bench_names</span><span class="p">)</span>

        <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish writing metadata.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run inference for the dataset and write the inference related data into summary.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary (SummaryWriter): The summary writer.</span>
<span class="sd">            threshold (float): The threshold for prediction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict, The map of sample d to the union of its ground truth and predicted labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_id_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATASET_SEED</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_infer_batch</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span><span class="s2">&quot;Finish running and writing </span><span class="si">{}</span><span class="s2">-th batch inference data.&quot;</span>
                               <span class="s2">&quot; Time elapsed: </span><span class="si">{:.3f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sample_id_labels</span>

    <span class="k">def</span> <span class="nf">_infer_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer a batch.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary (SummaryRecord): The summary object to store the data.</span>
<span class="sd">            batch (tuple): The next dataset sample.</span>
<span class="sd">            sample_id_labels (dict): The sample id to labels dictionary.</span>
<span class="sd">            threshold (float): The threshold for prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_next_element</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_network</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty</span><span class="o">.</span><span class="n">eval_epistemic_uncertainty</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_var</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="n">gt_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">gt_probs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gt_labels</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">prob_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gt_prob_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">prob_var</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gt_labels</span><span class="p">]</span>
                <span class="n">gt_itl_lows</span><span class="p">,</span> <span class="n">gt_itl_his</span><span class="p">,</span> <span class="n">gt_prob_sds</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_calc_beta_intervals</span><span class="p">(</span><span class="n">gt_probs</span><span class="p">,</span> <span class="n">gt_prob_vars</span><span class="p">)</span>

            <span class="n">data_np</span> <span class="o">=</span> <span class="n">_convert_image_format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;NCHW&#39;</span><span class="p">)</span>
            <span class="n">original_image</span> <span class="o">=</span> <span class="n">_np_to_image</span><span class="p">(</span><span class="n">_normalize</span><span class="p">(</span><span class="n">data_np</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
            <span class="n">original_image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_original_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span><span class="p">,</span> <span class="n">original_image</span><span class="p">)</span>

            <span class="n">predicted_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">predicted_probs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">predicted_labels</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">prob_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">predicted_prob_vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">prob_var</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">predicted_labels</span><span class="p">]</span>
                <span class="n">predicted_itl_lows</span><span class="p">,</span> <span class="n">predicted_itl_his</span><span class="p">,</span> <span class="n">predicted_prob_sds</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_calc_beta_intervals</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">,</span> <span class="n">predicted_prob_vars</span><span class="p">)</span>

            <span class="n">union_labs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">gt_labels</span> <span class="o">+</span> <span class="n">predicted_labels</span><span class="p">))</span>
            <span class="n">sample_id_labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">union_labs</span>

            <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">original_image_path</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>

            <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">ground_truth_label</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gt_labels</span><span class="p">)</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">ground_truth_prob</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gt_probs</span><span class="p">)</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">predicted_label</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted_labels</span><span class="p">)</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">predicted_prob</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prob_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">ground_truth_prob_sd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gt_prob_sds</span><span class="p">)</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">ground_truth_prob_itl95_low</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gt_itl_lows</span><span class="p">)</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">ground_truth_prob_itl95_hi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">gt_itl_his</span><span class="p">)</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">predicted_prob_sd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted_prob_sds</span><span class="p">)</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">predicted_prob_itl95_low</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted_itl_lows</span><span class="p">)</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">predicted_prob_itl95_hi</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted_itl_his</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_hoc_registered</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_hoc</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">prob</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_run_explainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">explainer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the explainer.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary (SummaryRecord): The summary object to store the data.</span>
<span class="sd">            sample_id_labels (dict): A dict that maps the sample id and its union labels.</span>
<span class="sd">            explainer (_Attribution): An Attribution object to generate saliency maps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">next_element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span><span class="s2">&quot;Start running </span><span class="si">{}</span><span class="s2">-th explanation data for </span><span class="si">{}</span><span class="s2">......&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">saliency_dict_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_exp_step</span><span class="p">(</span><span class="n">next_element</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span>
                <span class="s2">&quot;Finish writing </span><span class="si">{}</span><span class="s2">-th batch explanation data for </span><span class="si">{}</span><span class="s2">. Time elapsed: </span><span class="si">{:.3f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span>
                    <span class="s2">&quot;Start running </span><span class="si">{}</span><span class="s2">-th batch </span><span class="si">{}</span><span class="s2"> data for </span><span class="si">{}</span><span class="s2">......&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">idx</span><span class="p">,</span> <span class="n">bench</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_exp_benchmark_step</span><span class="p">(</span><span class="n">next_element</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">bench</span><span class="p">,</span> <span class="n">saliency_dict_lst</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span>
                    <span class="s2">&quot;Finish running </span><span class="si">{}</span><span class="s2">-th batch </span><span class="si">{}</span><span class="s2"> data for </span><span class="si">{}</span><span class="s2">. Time elapsed: </span><span class="si">{:.3f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">idx</span><span class="p">,</span> <span class="n">bench</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_run_saliency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the saliency explanations.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">explainer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explainers</span><span class="p">:</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                    <span class="n">bench</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start running and writing explanation for </span><span class="si">{</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">......&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATASET_SEED</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_explainer</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">explainer</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_benchmarkers</span><span class="p">:</span>
                <span class="n">benchmark</span> <span class="o">=</span> <span class="n">explain</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">benchmark</span><span class="o">.</span><span class="n">explain_method</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">benchmark</span><span class="o">.</span><span class="n">benchmark_method</span> <span class="o">=</span> <span class="n">bench</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

                <span class="n">benchmark</span><span class="o">.</span><span class="n">total_score</span> <span class="o">=</span> <span class="n">bench</span><span class="o">.</span><span class="n">performance</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bench</span><span class="p">,</span> <span class="n">LabelSensitiveMetric</span><span class="p">):</span>
                    <span class="n">benchmark</span><span class="o">.</span><span class="n">label_score</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bench</span><span class="o">.</span><span class="n">class_performances</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spaced_print</span><span class="p">(</span><span class="s2">&quot;Finish running and writing explanation and benchmark data for </span><span class="si">{}</span><span class="s2">. &quot;</span>
                               <span class="s2">&quot;Time elapsed: </span><span class="si">{:.3f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_hoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">sample_input</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run HOC search for a sample image, and then save the result to summary.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary (SummaryWriter): The summary writer.</span>
<span class="sd">            sample_id (int): The sample ID.</span>
<span class="sd">            sample_input (Union[Tensor, np.ndarray]): Sample image tensor in CHW or NCWH(N=1).</span>
<span class="sd">            prob (Union[Tensor, np.ndarray]): List of sample&#39;s classification prediction output, HOC will run for</span>
<span class="sd">                labels with prediction output strictly larger then HOC searcher&#39;s threshold(0.5 by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_input</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">sample_input</span> <span class="o">=</span> <span class="n">sample_input</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">sample_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sample_input</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">explain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">str_mask</span> <span class="o">=</span> <span class="n">hoc</span><span class="o">.</span><span class="n">auto_str_mask</span><span class="p">(</span><span class="n">sample_input</span><span class="p">)</span>
        <span class="n">compiled_mask</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">label_idx</span><span class="p">,</span> <span class="n">label_prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prob</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label_prob</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">compiled_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">compiled_mask</span> <span class="o">=</span> <span class="n">hoc</span><span class="o">.</span><span class="n">compile_mask</span><span class="p">(</span><span class="n">str_mask</span><span class="p">,</span> <span class="n">sample_input</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">edit_tree</span><span class="p">,</span> <span class="n">layer_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hoc_searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sample_input</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">,</span> <span class="n">compiled_mask</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">hoc</span><span class="o">.</span><span class="n">NoValidResultError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Hierarchical Occlusion result was found in sample#</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;label:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">, skipped.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">explain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
                <span class="n">explain</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">=</span> <span class="n">sample_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_hoc_result_to_explain</span><span class="p">(</span><span class="n">label_idx</span><span class="p">,</span> <span class="n">str_mask</span><span class="p">,</span> <span class="n">edit_tree</span><span class="p">,</span> <span class="n">layer_outputs</span><span class="p">,</span> <span class="n">explain</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">explain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s1">&#39;hierarchical_occlusion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_hoc_result_to_explain</span><span class="p">(</span><span class="n">label_idx</span><span class="p">,</span> <span class="n">str_mask</span><span class="p">,</span> <span class="n">edit_tree</span><span class="p">,</span> <span class="n">layer_outputs</span><span class="p">,</span> <span class="n">explain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add HOC result to Explain record.</span>

<span class="sd">        Args:</span>
<span class="sd">            label_idx (int): The label index.</span>
<span class="sd">            str_mask (str): The mask string.</span>
<span class="sd">            edit_tree (EditStep): The result HOC edit tree.</span>
<span class="sd">            layer_outputs (list[float]): The network output confident of each layer.</span>
<span class="sd">            explain (Explain): The Explain record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hoc_rec</span> <span class="o">=</span> <span class="n">explain</span><span class="o">.</span><span class="n">hoc</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
        <span class="n">hoc_rec</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label_idx</span>
        <span class="n">hoc_rec</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">str_mask</span>
        <span class="n">layer_count</span> <span class="o">=</span> <span class="n">edit_tree</span><span class="o">.</span><span class="n">max_layer</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">):</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">edit_tree</span><span class="o">.</span><span class="n">get_layer_or_leaf_steps</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">layer_output</span> <span class="o">=</span> <span class="n">layer_outputs</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
            <span class="n">hoc_layer</span> <span class="o">=</span> <span class="n">hoc_rec</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">hoc_layer</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="n">layer_output</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="n">hoc_layer</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">box</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_exp_step_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">sample_label_sets</span><span class="p">,</span> <span class="n">batch_saliency_full</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add explanation results of samples to summary record.</span>

<span class="sd">        Args:</span>
<span class="sd">            explainer (Attribution): The explainer to be run.</span>
<span class="sd">            sample_label_sets (list[list[int]]): The label sets of samples.</span>
<span class="sd">            batch_saliency_full (Tensor): The saliency output from explainer.</span>
<span class="sd">            summary (SummaryWriter): The summary writer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saliency_dict_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">has_saliency_rec</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label_set</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_label_sets</span><span class="p">):</span>
            <span class="n">saliency_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="n">Explain</span><span class="p">()</span>
            <span class="n">explain</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_set</span><span class="p">):</span>
                <span class="n">saliency</span> <span class="o">=</span> <span class="n">batch_saliency_full</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">saliency_dict</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">saliency</span>

                <span class="n">saliency_np</span> <span class="o">=</span> <span class="n">_normalize</span><span class="p">(</span><span class="n">saliency</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
                <span class="n">saliency_image</span> <span class="o">=</span> <span class="n">_np_to_image</span><span class="p">(</span><span class="n">saliency_np</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="n">heatmap_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_heatmap</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span><span class="p">,</span> <span class="n">saliency_image</span><span class="p">)</span>

                <span class="n">explanation</span> <span class="o">=</span> <span class="n">explain</span><span class="o">.</span><span class="n">explanation</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">explanation</span><span class="o">.</span><span class="n">explain_method</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">explanation</span><span class="o">.</span><span class="n">heatmap_path</span> <span class="o">=</span> <span class="n">heatmap_path</span>
                <span class="n">explanation</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">lab</span>

                <span class="n">has_saliency_rec</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">summary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">explain</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">saliency_dict_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">saliency_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">saliency_dict_lst</span><span class="p">,</span> <span class="n">has_saliency_rec</span>

    <span class="k">def</span> <span class="nf">_run_exp_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_element</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">sample_id_labels</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the explanation for each step and write explanation results into summary.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_element (Tuple): Data of one step</span>
<span class="sd">            explainer (_Attribution): An Attribution object to generate saliency maps.</span>
<span class="sd">            sample_id_labels (dict): A dict that maps the sample id and its union labels.</span>
<span class="sd">            summary (SummaryWriter): The summary writer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list, List of dict that maps label to its corresponding saliency map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_next_element</span><span class="p">(</span><span class="n">next_element</span><span class="p">)</span>
        <span class="n">sample_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_index</span>
        <span class="n">sample_label_sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
            <span class="n">sample_label_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_id_labels</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sample_index</span><span class="p">)])</span>
            <span class="n">sample_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">batch_label_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_label_batch</span><span class="p">(</span><span class="n">sample_label_sets</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="p">(</span><span class="n">RISE</span><span class="p">,</span> <span class="n">RISEPlus</span><span class="p">)):</span>
            <span class="n">batch_saliency_full</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">batch_label_sets</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_saliency_full</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_label_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">batch_saliency</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">batch_label_sets</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">batch_saliency_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_saliency</span><span class="p">)</span>
            <span class="n">concat</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">batch_saliency_full</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">batch_saliency_full</span><span class="p">))</span>

        <span class="n">saliency_dict_lst</span><span class="p">,</span> <span class="n">has_saliency_rec</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_exp_step_samples</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">sample_label_sets</span><span class="p">,</span> <span class="n">batch_saliency_full</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_saliency_rec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s1">&#39;saliency_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">saliency_dict_lst</span>

    <span class="k">def</span> <span class="nf">_run_exp_benchmark_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_element</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">benchmarker</span><span class="p">,</span> <span class="n">saliency_dict_lst</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the explanation and evaluation for each step and write explanation results into summary.&quot;&quot;&quot;</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_next_element</span><span class="p">(</span><span class="n">next_element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">_EXPAND_DIMS</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">[</span><span class="s1">&#39;benchmark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benchmarker</span><span class="p">,</span> <span class="n">LabelAgnosticMetric</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">benchmarker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>
                <span class="n">benchmarker</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">saliency_dict</span> <span class="o">=</span> <span class="n">saliency_dict_lst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">saliency</span> <span class="ow">in</span> <span class="n">saliency_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benchmarker</span><span class="p">,</span> <span class="n">Localization</span><span class="p">):</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bboxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_next_element</span><span class="p">(</span><span class="n">next_element</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">benchmarker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">bboxes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">],</span>
                                                   <span class="n">saliency</span><span class="o">=</span><span class="n">saliency</span><span class="p">)</span>
                        <span class="n">benchmarker</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">benchmarker</span><span class="p">,</span> <span class="n">LabelSensitiveMetric</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">benchmarker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">saliency</span><span class="o">=</span><span class="n">saliency</span><span class="p">)</span>
                    <span class="n">benchmarker</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Benchmarker must be one of LabelSensitiveMetric or LabelAgnosticMetric, but&#39;</span>
                                    <span class="s1">&#39;receive </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">benchmarker</span><span class="p">)))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calc_beta_intervals</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence interval of beta distributions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variances</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">coef_a</span> <span class="o">=</span> <span class="p">((</span><span class="n">means</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">means</span><span class="p">)</span> <span class="o">/</span> <span class="n">variances</span><span class="p">)</span> <span class="o">-</span> <span class="n">means</span>
            <span class="n">coef_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">coef_a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">means</span><span class="p">))</span> <span class="o">/</span> <span class="n">means</span>
            <span class="n">itl_lows</span><span class="p">,</span> <span class="n">itl_his</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">coef_a</span><span class="p">,</span> <span class="n">coef_b</span><span class="p">)</span>
            <span class="n">sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">itl_lows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">itl_lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">itl_his</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">itl_lows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">itl_his</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">itl_lows</span><span class="p">,</span> <span class="n">itl_his</span><span class="p">,</span> <span class="n">sds</span>

    <span class="k">def</span> <span class="nf">_transform_bboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">ifbbox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the bounding boxes.</span>
<span class="sd">        Args:</span>
<span class="sd">            inputs (Tensor): the image data</span>
<span class="sd">            labels (Tensor): the labels</span>
<span class="sd">            bboxes (Tensor): the boudnding boxes data</span>
<span class="sd">            ifbbox (bool): whether to preprocess bboxes. If True, a dictionary that indicates bounding boxes w.r.t</span>
<span class="sd">                label id will be returned. If False, the returned bboxes is the the parsed bboxes.</span>

<span class="sd">         Returns:</span>
<span class="sd">            bboxes (Union[list[dict], None, Tensor]): the bounding boxes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bboxes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ifbbox</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bboxes</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">masks_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">input_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">bboxes</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">input_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">label_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
                <span class="n">target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_len</span><span class="p">,</span> <span class="n">y_len</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_min</span> <span class="o">+</span> <span class="n">x_len</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">masks</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">masks_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">masks_lst</span>
        <span class="k">return</span> <span class="n">bboxes</span>

    <span class="k">def</span> <span class="nf">_transform_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">ifbbox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the data from one iteration of dataset to a unifying form for the follow-up operations.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (Tensor): the image data</span>
<span class="sd">            labels (Tensor): the labels</span>
<span class="sd">            bboxes (Tensor): the boudnding boxes data</span>
<span class="sd">            ifbbox (bool): whether to preprocess bboxes. If True, a dictionary that indicates bounding boxes w.r.t</span>
<span class="sd">                label id will be returned. If False, the returned bboxes is the the parsed bboxes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            inputs (Tensor): the image data, unified to a 4D Tensor.</span>
<span class="sd">            labels (list[list[int]]): the ground truth labels.</span>
<span class="sd">            bboxes (Union[list[dict], None, Tensor]): the bounding boxes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">_EXPAND_DIMS</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">_EXPAND_DIMS</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">bboxes</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">bboxes</span> <span class="o">=</span> <span class="n">_EXPAND_DIMS</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bboxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_bboxes</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">ifbbox</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">labels_lst</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">labels_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">))))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels_lst</span>
        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span>

    <span class="k">def</span> <span class="nf">_unpack_next_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_element</span><span class="p">,</span> <span class="n">ifbbox</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack a single iteration of dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            next_element (Tuple): a single element iterated from dataset object.</span>
<span class="sd">            ifbbox (bool): whether to preprocess bboxes in self._transform_data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple, a unified Tuple contains image_data, labels, and bounding boxes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span> <span class="o">=</span> <span class="n">next_element</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">next_element</span>
            <span class="n">bboxes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">next_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
            <span class="n">bboxes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_data</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">ifbbox</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bboxes</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_label_batch</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unify a List of List of labels to be a 2D Tensor with shape (b, m), where b = len(labels) and m is the max</span>
<span class="sd">        length of all the rows in labels.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (List[List]): the union labels of a data batch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            2D Tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
        <span class="n">batch_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">max_len</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_labels</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">batch_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">batch_labels</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save manifest.json underneath datafile directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Manifest not yet be initialized.&quot;</span><span class="p">)</span>
        <span class="n">path_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_dir</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_DATAFILE_DIRNAME_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span><span class="p">)]</span>
        <span class="n">abs_dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_subdir</span><span class="p">(</span><span class="o">*</span><span class="n">path_tokens</span><span class="p">)</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_dir_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MANIFEST_FILENAME</span><span class="p">)</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_FILE_MODE</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manifest</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save manifest as </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FILE_MODE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_original_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save an image to summary directory.&quot;&quot;&quot;</span>
        <span class="n">id_dirname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_dirname</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)</span>
        <span class="n">path_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_dir</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_DATAFILE_DIRNAME_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_ORIGINAL_IMAGE_DIRNAME</span><span class="p">,</span>
                       <span class="n">id_dirname</span><span class="p">]</span>

        <span class="n">abs_dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_subdir</span><span class="p">(</span><span class="o">*</span><span class="n">path_tokens</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">.jpg&quot;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_dir_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FILE_MODE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explain_method</span><span class="p">,</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save heatmap image to summary directory.&quot;&quot;&quot;</span>
        <span class="n">id_dirname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_dirname</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)</span>
        <span class="n">path_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_dir</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_DATAFILE_DIRNAME_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summary_timestamp</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_HEATMAP_DIRNAME</span><span class="p">,</span>
                       <span class="n">explain_method</span><span class="p">,</span>
                       <span class="n">id_dirname</span><span class="p">]</span>

        <span class="n">abs_dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_subdir</span><span class="p">(</span><span class="o">*</span><span class="n">path_tokens</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2">.jpg&quot;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_dir_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FILE_MODE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_subdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively create subdirectories.&quot;&quot;&quot;</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">abs_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="c1"># os.makedirs() don&#39;t set intermediate dir permission properly, we mkdir() one by one</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DIR_MODE</span><span class="p">)</span>
                <span class="c1"># In some platform, mode may be ignored in os.mkdir(), we have to chmod() again to make sure</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DIR_MODE</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">abs_path</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_sample_dirname</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of parent directory of the image id.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_id</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_SAMPLE_PER_DIR</span><span class="p">)</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_SAMPLE_PER_DIR</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_spaced_print</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spaced message printing.&quot;&quot;&quot;</span>
        <span class="c1"># workaround to print logs starting new line in case line width mismatch.</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_SPACER</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, MindSpore.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 
</body>
</html>